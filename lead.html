<!DOCTYPE html>
<html lang="es">
  <script>
    // Función de verificación de autenticación eliminada
  </script>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CRM Agente - Equipo</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <!-- Scripts de la aplicación -->
  <script>
    // Verificación de autenticación deshabilitada
    window.authChecked = true;
  </script>
  <script>
    // Opción para silenciar logs solo si se activa explícitamente
    (function() {
      try {
        const shouldSilence = typeof localStorage !== 'undefined' && localStorage.getItem('silenceLogs') === '1';
        if (shouldSilence && typeof console !== 'undefined') {
          const noop = function(){};
          console.log = noop;
          console.info = noop;
          // console.warn y console.error se mantienen activos
        }
      } catch (e) {
        // Ignorar si localStorage no está disponible
      }
    })();
  </script>
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- Sidebar CSS -->
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/sidebar-inicio.css">
  <!-- Script para cargar la información del usuario en el sidebar -->
  <style>
    /* Estilos para el contenedor de la gráfica */
    .graph-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
      width: 100%;
      height: 460px;
      max-height: 460px;
      position: relative;
    }
    
    .graph-canvas {
      width: 100% !important;
      height: 100% !important;
      min-height: 420px;
    }
    
    /* Estilos para notificaciones */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: flex;
      align-items: center;
      transform: translateX(120%);
      transition: transform 0.3s ease-in-out;
      max-width: 350px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background-color: #10b981;
      border-left: 4px solid #059669;
    }

    .notification.error {
      background-color: #ef4444;
      border-left: 4px solid #dc2626;
    }

    .notification i {
      margin-right: 10px;
      font-size: 20px;
    }

    :root {
      --azul-oscuro: #1e293b;
      --azul-acento: #22b3ec;
      --gris-bg: #f5f7fa;
      --gris-borde: #e3e8ee;
      --gris-titulo: #edf3fa;
      --azul-celda: #f1f5fa;
      --radius: 15px;
      --sombra: 0 4px 24px 0 rgba(30,41,59,0.09);
      --trans: 0.18s;
      --form-width: 420px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Roboto', 'Montserrat', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: var(--gris-bg);
      color: var(--azul-oscuro);
    }
    .layout {
      display: flex;
      min-height: 100vh;
    }
    /* Asegurar capas correctas */
    .main-content { position: relative; z-index: 1; }
    /* Sidebar estilizado de forma unificada en css/sidebar.css */
    /* Estilos para la información del usuario en la barra lateral */
    .user-info {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 10px;
    }
    
    .user-info .avatar {
      width: 60px;
      height: 60px;
      margin: 0 auto 10px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: #4a5568;
    }
    
    .user-info {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 15px;
    }
    
    .user-avatar {
      width: 80px;
      height: 80px;
      margin: 0 auto 15px;
      background: #f0f4f8;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: #4a5568;
    }
    
    .user-details {
      margin-top: 10px;
    }
    
    .user-name {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #2d3748;
      font-size: 1.1em;
    }
    
    .user-role {
      display: inline-block;
      font-size: 0.8em;
      color: white;
      background: #4a5568;
      padding: 3px 12px;
      border-radius: 12px;
      margin-top: 5px;
      font-weight: 500;
    }
    /* Los estilos del menú de navegación ahora están en css/sidebar.css */
    .sidebar-nav button:hover {
      background: var(--sidebar-accent);
      color: var(--sidebar-text);
    }
    .sidebar-lema {
      color: var(--sidebar-accent);
      font-style: italic;
      font-size: 0.99em;
      opacity: 0.6;
      margin-top: auto;
      padding: 12px 10px 18px 10px;
      text-align: center;
      font-weight: 600;
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      padding: 20px 30px 20px 30px;
      overflow-y: auto;
      display: flex;
      justify-content: flex-start;
      gap: 40px;
      width: calc(100% - 260px); /* Restar el ancho del sidebar-inicio */
      margin-left: 260px; /* Igual al ancho del sidebar-inicio */
      height: calc(100vh - 40px);
      box-sizing: border-box;
    }
    /* LEAD FORM */
    .lead-content-row {
      display: flex;
      flex-direction: row;
      gap: 40px;
      width: 100%;
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px 20px 20px;
      align-items: flex-start;
      box-sizing: border-box;
    }
    .graphs-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 30px;
      min-width: 0;
      width: 100%;
      max-width: 100%;
      height: 100%;
      min-height: 100%;
      box-sizing: border-box;
      padding: 20px 10px;
      overflow-y: auto;
    }
    
    .graph-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      overflow: visible;
      box-sizing: border-box;
      width: 100%;
      min-height: 0;  /* Permite que se encoja si es necesario */
    }
    .form-section {
      background: white;
      border-radius: 12px;
      padding: 30px 35px 90px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
      margin: 0;
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      position: relative;
      height: calc(100vh - 100px);
      max-height: 900px;
    }
    
    .form-section h2 {
      color: var(--azul-oscuro);
      margin-bottom: 20px;
      font-size: 1.5rem;
      text-align: center;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -10px 15px;
    }
    
    .form-group {
      flex: 1 1 50%;
      padding: 0 10px;
      margin-bottom: 15px;
      min-width: 200px;
    }
    
    /* Contenedor del formulario con scroll */
    #crmForm {
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden; /* Ocultar el scroll por defecto */
    }
    
    /* Contenedor de los campos del formulario con scroll */
    .form-fields-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px; /* Espacio para la barra de desplazamiento */
      margin-right: -8px; /* Compensar el padding para mantener el ancho */
    }
    
    /* Estilo para la barra de desplazamiento */
    .form-fields-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .form-fields-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .form-fields-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    
    .form-fields-container::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Contenedor del botón fijo */
    .form-button-container {
      position: absolute;
      bottom: 25px;
      left: 35px;
      right: 35px;
      background: white;
      padding: 15px 0 5px;
      border-top: 1px solid #e2e8f0;
      text-align: center;
      z-index: 10;
    }
    
    .btn-submit {
      background: #25a9dd;
      color: #fff;
      border-radius: 9px;
      border: none;
      font-weight: 700;
      font-size: 1.18em;
      padding: 12px 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      display: block;
    }
    
    .btn-submit:hover {
      background: #183153;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn-submit:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--azul-oscuro);
    }
    
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--gris-borde);
      border-radius: 4px;
      font-size: 0.9rem;
      transition: border-color 0.2s;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--azul-acento);
      box-shadow: 0 0 0 2px rgba(34, 179, 236, 0.2);
    }
    
    .radio-group {
      display: flex;
      gap: 15px;
      margin-top: 5px;
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }
    
    .radio-label input[type="radio"] {
      margin: 0;
    }
    
    textarea.form-control {
      min-height: 80px;
      resize: vertical;
    }
    
    @media (max-width: 600px) {
      .form-group {
        flex: 1 1 100%;
      }
    }
    .form-section h2 {
      font-weight: 700;
      font-size: 2em;
      color: #183153;
      margin-bottom: 28px;
      margin-top: 0;
    }
    .form-group { margin-bottom: 18px;}
    .form-section label {
      color: #25a9dd;
      font-weight: 700;
      margin-bottom: 7px;
      display: block;
    }
    .form-section label[for="fecha-lead"] {
      color: #183153;
    }
    .form-section input, .form-section select {
      background: #f8fcff;
      border-radius: 7px;
      border: 1.5px solid #e4e6f1;
      padding: 13px 15px;
      font-size: 1.12em;
      width: 100%;
      margin-top: 2px;
    }
    .form-section button[type="submit"] {
      background: #25a9dd;
      color: #fff;
      border-radius: 9px;
      border: none;
      font-weight: 700;
      font-size: 1.18em;
      padding: 16px 0;
      width: 100%;
      margin-top: 9px;
      transition: background 0.2s;
    }
    .form-section button[type="submit"]:hover {
      background: #183153;
    }
    .graph-container {
      min-height: 420px;
      height: 460px;
      max-height: 460px;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--sombra);
      padding: 20px;
      overflow: visible;
      box-sizing: border-box;
      width: 100%;
      margin-bottom: 20px;
    }
    
    .graph-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .graph-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--azul-oscuro);
    }
    
    .week-navigation {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .week-nav-button {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #64748b;
      transition: all 0.2s ease;
    }
    
    .week-nav-button:hover:not(:disabled) {
      background: #f1f5f9;
      color: var(--azul-acento);
      border-color: #cbd5e1;
    }
    
    .week-nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #semana-actual {
      font-size: 0.9rem;
      color: #64748b;
      min-width: 100px;
      text-align: center;
    }
    
    .graph-scroll-container {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none; /* Firefox */
      margin-bottom: 10px;
    }
    
    .graph-scroll-container::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    .graph-wrapper {
      min-width: 100%;
      width: max-content;
      height: 300px;
    }
    
    .graph-scroll-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .scroll-button {
      background: #f0f4f8;
      border: 1px solid #d9e2ec;
      border-radius: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #486581;
      transition: all 0.2s ease;
    }
    
    .scroll-button:hover {
      background: #e0e7ff;
      color: #3b82f6;
    }
    
    .scroll-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .scroll-track {
      flex: 1;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }
    
    .scroll-thumb {
      position: absolute;
      height: 100%;
      background: #3b82f6;
      border-radius: 3px;
      width: 100px;
      left: 0;
      top: 0;
    }
    
    @media (max-width: 1100px) {
      .lead-content-row { 
        flex-direction: column; 
        gap: 20px; 
        max-height: none;
      }
      .main-content { 
        padding: 15px; 
        height: auto;
      }
      .form-section {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        position: relative;
      }
    }
    @media (max-width: 700px) {
      .layout { flex-direction: column;}
      .sidebar { flex-direction: row; width: 100vw; min-height: 0; height: 70px; align-items: center; padding: 7px 0; }
      .sidebar-logo { margin: 0 12px 0 0; }
      .sidebar-title { font-size: 1em; margin-bottom: 0;}
      .sidebar-nav { flex-direction: row; gap: 0; }
      .sidebar-nav button { font-size: 1em; padding: 11px 6px; width: auto; border-radius: 7px; margin:0 3px; }
      .sidebar-lema { display: none;}
      /* Asegurar que el contenido principal quede DEBAJO de la barra superior */
      .main-content { 
        padding: 12px 2px; 
        flex-direction: column;
        margin-left: 0 !important; /* Anula margen del sidebar fijo en desktop */
        margin-top: 70px; /* Altura de la barra superior */
      }
      .lead-content-row { 
        flex-direction: column; 
        gap: 16px; 
        width: 100%;
        max-width: 100%;
      }
      .form-section, .graphs-section { 
        width: 100%;
        max-width: 100%;
        padding: 13px 7px;
      }
      .graphs-section {
        grid-template-columns: 1fr !important;
      }
    }
    /* Estilos para el filtro de fecha */
    .date-filter-container {
      width: 100%;
      margin-bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .date-filter {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .date-filter label {
      color: #15344a;
      font-weight: 600;
      margin-right: 5px;
    }
    
    .date-select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background-color: #f9fafb;
      font-size: 14px;
      min-width: 120px;
    }
    
    .filter-button {
      padding: 8px 16px;
      background-color: #15344a;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    
    .filter-button:hover {
      background-color: #1e4b6e;
    }
    
    #reset-filter {
      background-color: #6b7280;
    }
    
    #reset-filter:hover {
      background-color: #4b5563;
    }
    /* Usuario en sidebar: igual que en otras páginas */
    .sidebar .user-info {
      text-align: center;
      margin-bottom: 30px;
      width: 100%;
      padding: 0 20px;
    }
    .sidebar .user-info .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #f0f4f8;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 40px;
      color: #4a5568;
    }
    .sidebar .user-info .user-details { margin-top: 10px; }
    .sidebar .user-info .user-name {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #2d3748;
      font-size: 1.1em;
    }
    .sidebar .user-info .user-role {
      display: inline-block;
      font-size: 0.8em;
      color: white;
      background: #4a5568;
      padding: 3px 12px;
      border-radius: 12px;
      margin-top: 5px;
      font-weight: 500;
      text-transform: capitalize;
    }
  </style>
</head>
<body>
<div class="layout">
  <!-- SIDEBAR -->
  <nav class="sidebar sidebar-inicio">
    <!-- Información del Usuario -->
    <div class="user-info">
      <div class="user-avatar">
        <i class="fas fa-user-circle"></i>
      </div>
      <div class="user-details">
        <span id="user-name" class="user-name">Usuario</span>
        <span id="user-role" class="user-role">Rol</span>
      </div>
    </div>
    
    <h3>Menú</h3>
    <ul class="menu">
      <li><a href="inicio.html" class="btn btn-sidebar"><i class="fas fa-home"></i> <span>Inicio</span></a></li>
      <li><a href="lead.html" class="btn btn-sidebar is-active"><i class="fas fa-user-plus"></i> <span>Nuevo Lead</span></a></li>
      <li><a href="Costumer.html" class="btn btn-sidebar"><i class="fas fa-users"></i> <span>Clientes</span></a></li>
      <li>
        <a href="#" id="logoutBtn" data-logout-button class="btn btn-sidebar btn-logout">
          <i class="fas fa-sign-out-alt"></i> <span>Cerrar sesión</span>
        </a>
      </li>
    </ul>
  </nav>
  <main class="main-content">
    <div class="lead-content-row">
      <!-- FORMULARIO -->
      <section class="form-section" id="form-panel">
        <h2>Formulario de Registro</h2>
        <form id="crmForm">
          <!-- Contenedor de campos con scroll -->
          <div class="form-fields-container">
            <!-- Nombre Cliente -->
            <div class="form-group">
            <label for="nombre-cliente">Nombre Cliente</label>
            <input type="text" id="nombre-cliente" class="form-control" required>
          </div>
          
          <!-- Teléfono Principal -->
          <div class="form-group">
            <label for="telefono-principal">Teléfono Principal</label>
            <input type="tel" id="telefono-principal" class="form-control" required>
          </div>
          
          <!-- Teléfono Alterno -->
          <div class="form-group">
            <label for="telefono-alterno">Teléfono Alterno</label>
            <input type="tel" id="telefono-alterno" class="form-control">
          </div>
          
          <!-- Número de cuenta -->
          <div class="form-group">
            <label for="numero-cuenta">Número de cuenta</label>
            <input type="text" id="numero-cuenta" class="form-control">
          </div>
          
          <!-- Dirección -->
          <div class="form-group">
            <label for="direccion">Dirección *</label>
            <input type="text" id="direccion" class="form-control" required>
          </div>
          
          <!-- Autopago -->
          <div class="form-group">
            <label for="autopago">Autopago</label>
            <select id="autopago" class="form-control" required>
              <option value="">Elige</option>
              <option value="si">SI</option>
              <option value="no">NO</option>
            </select>
          </div>
          
          <!-- Tipo de servicios -->
          <div class="form-group">
            <label for="tipo-servicio">Tipo de servicios</label>
            <select id="tipo-servicio" class="form-control" required>
              <option value="">Elige</option>
              <option value="video">VIDEO</option>
              <option value="internet">INTERNET</option>
              <option value="att-air">AT&T AIR</option>
              <option value="wireless">WIRELESS</option>
              <option value="single-internet">SINGLE INTERNET</option>
              <option value="frontier">FRONTIER</option>
              <option value="windstream">WINDSTREAM</option>
              <option value="optimum">OPTIMUM</option>
              <option value="wow">WOW</option>
              <option value="altafiber">ALTAFIBER</option>
              <option value="consolidate">CONSOLIDATE</option>
              <option value="hughesnet">HUGHESNET</option>
              <option value="viasat">VIASAT</option>
              <option value="centurylink">CENTURYLINK</option>
              <option value="metronet">METRONET</option>
              <option value="ziply-fiber">ZIPLY FIBER</option>
              <option value="hawaiian">HAWAIIAN</option>
              <option value="double-play">DOUBLE PLAY</option>
              <option value="vivint">VIVINT</option>
              <option value="brightspeed">BRIGHTSPEED</option>
              <option value="mobility">MOBILITY</option>
              <option value="sim-mobility">SIM MOBILITY</option>
              <option value="earthlink">EARTHLINK</option>
              <option value="earthlink">XFINITY</option>
            </select>
          </div>
          
          <!-- Sistema -->
          <div class="form-group">
            <label for="sistema">Sistema</label>
            <select id="sistema" class="form-control" required>
              <option value="">Elige</option>
              <option value="sara">SARA</option>
              <option value="bo">B.O</option>
              <option value="na">N/A</option>
              <option value="chuzo">CHUZO</option>
            </select>
          </div>
          
          <!-- Riesgo -->
          <div class="form-group">
            <label for="riesgo">Riesgo</label>
            <select id="riesgo" class="form-control" required>
              <option value="">Elige</option>
              <option value="low">LOW</option>
              <option value="medium">MEDIUM</option>
              <option value="high">HIGH</option>
              <option value="na">N/A</option>
            </select>
          </div>
          
          <!-- Día de venta -->
          <div class="form-group">
            <label for="dia-venta">Día de venta</label>
            <input type="date" id="dia-venta" class="form-control" required>
          </div>
          
          <!-- Día de instalación -->
          <div class="form-group">
            <label for="dia-instalacion">Día de instalación</label>
            <input type="date" id="dia-instalacion" class="form-control">
          </div>
          
          <!-- Status -->
          <div class="form-group">
            <label>Status</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="status" value="PENDING" required />
                <span>PENDING</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="status" value="REPRO" />
                <span>REPRO</span>
              </label>
            </div>
          </div>
          
          <!-- Servicios -->
          <div class="form-group">
            <label for="servicios">Servicios</label>
            <select id="servicios" class="form-control" required>
              <option value="">Elige</option>
              <option value="video-directv-internet">VIDEO DIRECTV VIA INTERNET</option>
              <option value="video-directv-satelite">VIDEO DIRECTV VIA SATELITE</option>
              <option value="att-air">ATT AIR</option>
              <option value="att-18-25-mb">ATT 18 - 25 MB</option>
              <option value="att-50-100-mb">ATT 50 - 100 MB</option>
              <option value="att-300-500-mb">ATT 300 - 500 MB</option>
              <option value="att-1g-plus">ATT 1G+</option>
              <option value="mobility-spectrum">MOBILITY SPECTRUM</option>
              <option value="sim-spectrum">SIM SPECTRUM</option>
              <option value="frontier-200-mb">FRONTIER 200 MB</option>
              <option value="frontier-500-mb">FRONTIER 500 MB</option>
              <option value="frontier-1g">FRONTIER 1G</option>
              <option value="frontier-2g-plus">FRONTIER 2G+</option>
              <option value="spectrum-500">SPECTRUM 500</option>
              <option value="spectrum-1g">SPECTRUM 1G</option>
              <option value="spectrum-2g">SPECTRUM 2G</option>
              <option value="internet-wow">INTERNET WOW</option>
              <option value="internet-altafiber">INTERNET ALTA FIBER</option>
              <option value="internet-windstream">INTERNET WINDSTREAM</option>
              <option value="internet-hughesnet">INTERNET HUGHESNET</option>
              <option value="internet-viasat">INTERNET VIASAT</option>
              <option value="internet-consolidate">INTERNET CONSOLIDATE</option>
              <option value="internet-centurylink">INTERNET CENTURYLINK</option>
              <option value="internet-metronet">INTERNET METRONET</option>
              <option value="internet-ziply-fiber">INTERNET ZIPLY FIBER</option>
              <option value="internet-hawaiian">INTERNET HAWAIIAN</option>
              <option value="video-select-spectrum">VIDEO SELECT SPECTRUM</option>
              <option value="double-play-spectrum">DOUBLE PLAY SPECTRUM</option>
              <option value="brightspeed-10-100">BRIGHTSPEED 10-100MBPS</option>
              <option value="brightspeed-100-900">BRIGHTSPEED 100-900MBPS</option>
              <option value="internet-optimum">INTERNET OPTIMUM</option>
              <option value="internet-earthlink">INTERNET EARTHLINK</option>
              <option value="xfinity-double-play">XFINITY DOUBLE PLAY</option>
              <option value="xfinity-100-299">XFINITY 100 - 299 MBPS</option>
              <option value="xfinity-300">XFINITY 300MBPS</option>
              <option value="xfinity-500-plus">XFINITY 500MBPS+</option>
              <option value="xfinity-ultimate-tv">XFINITY ULTIMATE TV</option>
              <option value="xfinity-unlimited-voip">XFINITY UNLIMITED VOIP</option>
            </select>
          </div>
          
          <!-- Mercado -->
          <div class="form-group">
            <label for="mercado">Mercado</label>
            <select id="mercado" class="form-control" required>
              <option value="">Seleccione</option>
              <option value="residencial">ICON</option>
              <option value="empresarial">BAMO</option>
            </select>
          </div>
          
          <!-- Supervisor -->
          <div class="form-group">
            <label for="supervisor">Supervisor</label>
            <select id="supervisor" class="form-control" required>
              <option value="">Seleccione</option>
              <option value="TEAM IRANIA">TEAM IRANIA</option>
              <option value="TEAM PLEITEZ">TEAM PLEITEZ</option>
              <option value="TEAM MARISOL">TEAM MARISOL</option>
              <option value="TEAM ROBERTO">TEAM ROBERTO</option>
              <option value="TEAM LINEAS (JONATHAN)">TEAM LINEAS (JONATHAN)</option>
              <option value="TEAM RANDAL">TEAM RANDAL</option>
            </select>
          </div>
          
          <!-- Comentario -->
          <div class="form-group">
            <label for="comentario">Comentario *</label>
            <select id="comentario" class="form-control" required>
              <option value="">Elige</option>
              <option value="ADQUIRIR SERVICIOS">ADQUIRIR SERVICIOS</option>
              <option value="CANCELAR SERVICIO ANTERIOR">CANCELAR SERVICIO ANTERIOR</option>
              <option value="QUITAR FEE $99.00">QUITAR FEE $99.00</option>
              <option value="CREAR ORDEN DE INTERNET">CREAR ORDEN DE INTERNET</option>
            </select>
          </div>
          
          <!-- Motivo de la llamada -->
          <div class="form-group">
            <label>¿Por qué llamó el cliente? *</label>
            <div class="radio-group" style="display: flex; flex-direction: column; gap: 10px;">
              <label class="radio-label">
                <input type="radio" name="motivo-llamada" value="BILL ALTO" required />
                <span>BILL ALTO</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="motivo-llamada" value="PROBLEMAS DE INTERNET" required />
                <span>PROBLEMAS DE INTERNET</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="motivo-llamada" value="ADQUIRIR SERVICIOS" required />
                <span>ADQUIRIR SERVICIOS</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="motivo-llamada" value="MUDANZA" required />
                <span>MUDANZA</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="motivo-llamada" value="CANCELAR SERVICIOS" required />
                <span>CANCELAR SERVICIOS</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="motivo-llamada" value="PAGAR BILL" required />
                <span>PAGAR BILL</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="motivo-llamada" value="ATENCION AL CLIENTE" required />
                <span>ATENCION AL CLIENTE</span>
              </label>
            </div>
          </div>
          
          <!-- ZIP CODE -->
          <div class="form-group">
            <label for="zip-code">ZIP CODE</label>
            <input type="text" id="zip-code" class="form-control">
          </div>
          
          <!-- Puntaje -->
          <div class="form-group">
            <label for="puntaje">Puntaje</label>
            <select id="puntaje" class="form-control" required>
              <option value="">Seleccione un puntaje</option>
              <option value="0.25">0.25</option>
              <option value="0.35">0.35</option>
              <option value="1.00">1.00</option>
              <option value="1.25">1.25</option>
              <option value="1.50">1.50</option>
              <option value="0.20">0.20</option>
              <option value="0.75">0.75</option>
              <option value="0.50">0.50</option>
              <option value="0.15">0.15</option>
            </select>
          </div>
          
          </div> <!-- Cierre del form-fields-container -->
          
          <!-- Contenedor fijo para el botón -->
          <div class="form-button-container">
            <button type="submit" class="btn-submit">Guardar Lead</button>
          </div>
        </form>
      </section>

      <!-- SECCIÓN DE GRÁFICAS -->
      <section class="graphs-section">
        <!-- Filtro de Fecha -->
        <div class="date-filter-container">
          <div class="date-filter">
            <label for="month-select">Mes:</label>
            <select id="month-select" class="date-select">
              <option value="0">Enero</option>
              <option value="1">Febrero</option>
              <option value="2">Marzo</option>
              <option value="3">Abril</option>
              <option value="4">Mayo</option>
              <option value="5">Junio</option>
              <option value="6">Julio</option>
              <option value="7">Agosto</option>
              <option value="8">Septiembre</option>
              <option value="9">Octubre</option>
              <option value="10">Noviembre</option>
              <option value="11">Diciembre</option>
            </select>
            
            <label for="day-select">Día:</label>
            <select id="day-select" class="date-select">
              <!-- Los días se llenarán dinámicamente -->
            </select>
            
            <label for="year-select">Año:</label>
            <select id="year-select" class="date-select">
              <option value="2023">2023</option>
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
            
            <button id="apply-filter" class="filter-button">Aplicar Filtro</button>
            <button id="reset-filter" class="filter-button">Hoy</button>
          </div>
        </div>
        <!-- Gráfica de Ventas y Puntaje -->
        <div class="graph-container">
          <h3>Ventas y Puntaje</h3>
          <canvas id="ventasPuntajeChart" class="graph-canvas"></canvas>
        </div>
        

      </section>
    </div>
  </main>
</div>
<script>
  // Forzar recarga de la info del usuario cuando la página termina de cargar
  window.addEventListener('load', function() {
    if (window.cargarInfoUsuario) {
      try { window.cargarInfoUsuario(); } catch (e) { console.warn('cargarInfoUsuario falló:', e); }
    }
  });
</script>
<!-- Chart.js ya está cargado en <head>; se elimina la inclusión duplicada -->
<script>
  // Variables globales para las gráficas
  let ventasPuntajeChart = null;
  let ventasProductoChart = null;
  
  // Registrar plugin de DataLabels si está disponible
  if (window.Chart && window.ChartDataLabels) {
    try { Chart.register(window.ChartDataLabels); } catch (_) {}
  }
  
  

  // Función unificada para generar datos de prueba
  function generarDatosPrueba() {
    // Generar etiquetas para los últimos 7 días
    const hoy = new Date();
    const labels = [];
    const ventas = [];
    const puntajes = [];
    const productos = [
      'Internet Fibra Óptica', 'Televisión por Cable', 'Línea Telefónica', 
      'Paquete Triple', 'Internet Móvil', 'Servicio Técnico'
    ];
    
    // Generar datos realistas para los últimos 7 días
    for (let i = 6; i >= 0; i--) {
      const fecha = new Date(hoy);
      fecha.setDate(hoy.getDate() - i);
      const diaSemana = fecha.toLocaleDateString('es-ES', { weekday: 'short' });
      labels.push(diaSemana);
      
      // Generar datos aleatorios para ventas (entre 5 y 20)
      ventas.push(Math.floor(Math.random() * 16) + 5);
      
      // Generar puntajes aleatorios (entre 6.5 y 10)
      puntajes.push(parseFloat((Math.random() * 3.5 + 6.5).toFixed(1)));
    }
    
    console.log('Datos de ejemplo generados:', { labels, ventas, puntajes });
    return { labels, ventas, puntajes };
  }

  // Función para procesar los datos de leads y agruparlos por fecha
  function procesarDatosLeads(leads) {
    try {
      console.log('Procesando', leads.length, 'leads...');
      
      // Crear un objeto para agrupar por fecha
      const datosPorFecha = {};
      
      // Procesar cada lead
      leads.forEach(lead => {
        // Obtener la fecha del lead (usar fecha_creacion o creadoEn o la fecha actual)
        const fechaLead = lead.fecha_creacion || lead.creadoEn || new Date().toISOString();
        
        // Crear fecha en UTC para evitar problemas de zona horaria
        const fecha = new Date(fechaLead);
        // Ajustar a mediodía UTC para evitar problemas de cambio de día
        fecha.setUTCHours(12, 0, 0, 0);
        
        // Formatear la fecha como YYYY-MM-DD en UTC
        const fechaStr = fecha.toISOString().split('T')[0];
        
        // Inicializar el objeto para esta fecha si no existe
        if (!datosPorFecha[fechaStr]) {
          datosPorFecha[fechaStr] = {
            fecha: fechaStr,
            ventas: 0,
            puntaje: 0,
            count: 0,
            fechaObj: fecha // Guardar el objeto Date para ordenamiento
          };
        }
        
        // Sumar venta y puntaje (asumiendo que cada lead es una venta)
        datosPorFecha[fechaStr].ventas += 1;
        
        // Sumar el puntaje si está disponible
        if (lead.puntuacion !== undefined) {
          const puntuacion = parseFloat(lead.puntuacion) || 0;
          datosPorFecha[fechaStr].puntaje += puntuacion;
          datosPorFecha[fechaStr].count += 1;
        }
      });
      
      // Calcular el puntaje promedio por día
      const resultado = Object.values(datosPorFecha).map(dia => ({
        fecha: dia.fecha,
        ventas: dia.ventas,
        puntaje: dia.count > 0 ? dia.puntaje / dia.count : 0
      }));
      
      console.log('Datos procesados por fecha:', resultado);
      return resultado;
      
    } catch (error) {
      console.error('Error al procesar datos de leads:', error);
      return [];
    }
  }

  

  // Función para mostrar mensajes de error
  function mostrarMensajeError(mensaje) {
    console.error(mensaje);
    // Mostrar mensaje en la interfaz si es necesario
    const contenedor = document.getElementById('error-message');
    if (contenedor) {
      contenedor.textContent = mensaje;
      contenedor.style.display = 'block';
      setTimeout(() => {
        contenedor.style.display = 'none';
      }, 5000);
    }
  }

  // Datos de prueba para la gráfica
  const datosPrueba = [
    { fecha: '2025-08-06', ventas: 5, puntaje: 25 },
    { fecha: '2025-08-07', ventas: 8, puntaje: 40 },
    { fecha: '2025-08-08', ventas: 12, puntaje: 60 },
    { fecha: '2025-08-09', ventas: 7, puntaje: 35 },
    { fecha: '2025-08-10', ventas: 15, puntaje: 75 },
    { fecha: '2025-08-11', ventas: 10, puntaje: 50 },
    { fecha: '2025-08-12', ventas: 18, puntaje: 90 }
  ];
  
  // Nota: Se mantiene una única implementación de actualizarGraficaVentasPuntaje() más abajo.

  // Función para actualizar la gráfica de ventas y puntaje con datos de la colección costumer
  async function actualizarGraficaVentasPuntaje(datos = null) {
    try {
      console.log('=== INICIANDO ACTUALIZACIÓN DE GRÁFICA DE VENTAS ===');
      
      // Si se proporcionan datos directamente, úsalos y omite la llamada al backend
      if (Array.isArray(datos) && datos.length) {
        console.log('Usando datos proporcionados para la gráfica');
        return await procesarDatosGrafica(datos);
      }
      
      // Obtener el nombre del agente del localStorage o del DOM
      const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const nombreAgente = userData.name || 'Usuario';
      
      // Obtener la fecha actual y la fecha de hace 6 días (últimos 7 días incluyendo hoy)
      const hoy = new Date();
      const fechaInicio = new Date();
      fechaInicio.setDate(hoy.getDate() - 6);
      
      // Función para formatear fechas como YYYY-MM-DD
      const formatoFecha = (fecha) => {
        return `${fecha.getFullYear()}-${String(fecha.getMonth() + 1).padStart(2, '0')}-${String(fecha.getDate()).padStart(2, '0')}`;
      };
      
      // Construir la URL del endpoint de leads con filtro por agente (backend lo soporta vía query "agente")
      // Filtramos últimos 7 días en frontend; el backend devuelve los leads del agente solicitado
      let url = '/api/leads';
      try {
        const userStr = localStorage.getItem('user') || sessionStorage.getItem('user') || '{}';
        const user = JSON.parse(userStr);
        const agenteNombreQuery = (user && (user.username || user.name)) || nombreAgente || '';
        const u = new URL(url, location.origin);
        const params = new URLSearchParams(u.search);
        if (agenteNombreQuery) {
          params.set('agente', agenteNombreQuery);
        }
        url = `${u.pathname}?${params.toString()}`;
        console.info('[Filtro agente] Enviado en query a /api/leads:', agenteNombreQuery);
      } catch (e) {
        console.warn('No se pudo construir la URL con filtro por agente:', e?.message);
      }
      console.log('Solicitando datos a:', url);
      
      // Realizar la petición a la API (incluyendo Authorization si hay token)
      console.log('Realizando petición a:', url);
      const tokenForGet = localStorage.getItem('token') || sessionStorage.getItem('token');
      const baseHeaders = {
        'Accept': 'application/json',
        'Cache-Control': 'no-cache'
      };
      if (tokenForGet) baseHeaders['Authorization'] = `Bearer ${tokenForGet}`;
      const response = await fetch(url, {
        method: 'GET',
        headers: baseHeaders,
        credentials: 'same-origin'
      });
      
      // Verificar si la respuesta es exitosa; si no, usar datos de prueba
      if (!response.ok) {
        let bodyText = '';
        try { bodyText = await response.text(); } catch (_) {}
        console.warn(`Respuesta no OK (${response.status}). Cuerpo:`, bodyText);
        return await procesarDatosGrafica(datosPrueba);
      }
      
      // Obtener los datos de la respuesta
      const responseData = await response.json();
      console.log('Datos recibidos de la API:', responseData);
      
      // Extraer el array de clientes de la respuesta de forma robusta
      const safeData = responseData || {};
      let costumers = Array.isArray(safeData)
        ? safeData
        : (Array.isArray(safeData.leads) ? safeData.leads
          : (Array.isArray(safeData.customers) ? safeData.customers
            : (Array.isArray(safeData.data) ? safeData.data : [])));

      // Paginación: si la respuesta indica más páginas, traerlas y combinarlas
      try {
        const totalPages = Number(safeData.pages || 1);
        const currentPage = Number(safeData.page || 1);
        const limit = Number(safeData.limit || 50);
        if (totalPages > currentPage) {
          console.log(`[PAGINACIÓN] Se detectaron ${totalPages} páginas (actual: ${currentPage}). Descargando páginas restantes...`);
          // Reconstruir query params para preservar filtros
          const u = new URL(url, location.origin);
          const baseParams = new URLSearchParams(u.search);
          baseParams.set('limit', String(limit || 50));
          for (let p = currentPage + 1; p <= totalPages; p++) {
            baseParams.set('page', String(p));
            const pageUrl = `${u.pathname}?${baseParams.toString()}`;
            console.log(`[PAGINACIÓN] Solicitando página ${p}:`, pageUrl);
            const r = await fetch(pageUrl, {
              method: 'GET',
              headers: baseHeaders,
              credentials: 'same-origin'
            });
            if (!r.ok) {
              let errTxt = '';
              try { errTxt = await r.text(); } catch (_) {}
              console.warn(`[PAGINACIÓN] Respuesta no OK en página ${p}:`, r.status, errTxt);
              continue;
            }
            const d = await r.json();
            const arr = Array.isArray(d)
              ? d
              : (Array.isArray(d.leads) ? d.leads
                : (Array.isArray(d.customers) ? d.customers
                  : (Array.isArray(d.data) ? d.data : [])));
            console.log(`[PAGINACIÓN] Página ${p} retornó ${arr.length} registros`);
            costumers = costumers.concat(arr);
          }
          console.log(`[PAGINACIÓN] Total acumulado tras paginación: ${costumers.length}`);
        }
      } catch (e) {
        console.warn('[PAGINACIÓN] Error durante la descarga de páginas adicionales:', e?.message);
      }
      
      // Inicializar un objeto para almacenar las ventas por día (claves en día de negocio UTC-6)
      const ventasPorDia = {};
      
      // Helper local para esta función: convertir Date a YYYY-MM-DD en TZ negocio
      const BUSINESS_TZ_OFFSET_MIN = -6 * 60; // UTC-6 fijo
      const toISOInTZ_local = (date, tzOffsetMinutes) => {
        const target = new Date(date.getTime() + tzOffsetMinutes * 60000);
        const y = target.getUTCFullYear();
        const m = String(target.getUTCMonth() + 1).padStart(2, '0');
        const d = String(target.getUTCDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };
      
      // Helper: obtener valor por ruta anidada (e.g., "_raw.createdAt")
      const getByPath = (obj, path) => {
        try {
          return path.split('.').reduce((acc, key) => (acc && acc[key] !== undefined ? acc[key] : undefined), obj);
        } catch (_) {
          return undefined;
        }
      };
      
      // Helper: retorna el primer valor definido no vacío entre múltiples rutas
      const findFirst = (obj, paths) => {
        for (const p of paths) {
          const v = getByPath(obj, p);
          if (v !== undefined && v !== null && v !== '') return v;
        }
        return undefined;
      };
      
      // Inicializar los últimos 7 días "rodantes" en la zona de negocio
      const fechasUltimos7Dias = new Set();
      const hoyISO = toISOInTZ_local(new Date(), BUSINESS_TZ_OFFSET_MIN);
      const [hy, hm, hd] = hoyISO.split('-').map(Number);
      const baseUTCNoon = new Date(Date.UTC(hy, hm - 1, hd, 12, 0, 0));
      for (let i = 6; i >= 0; i--) {
        const fechaUTC = new Date(baseUTCNoon);
        fechaUTC.setUTCDate(baseUTCNoon.getUTCDate() - i);
        const clave = toISOInTZ_local(fechaUTC, BUSINESS_TZ_OFFSET_MIN);
        fechasUltimos7Dias.add(clave);
        ventasPorDia[clave] = { ventas: 0, puntaje: 0 };
      }
      console.log('Rango últimos 7 días (UTC-6):', Array.from(fechasUltimos7Dias));
      
      console.log('Clientes a procesar:', costumers);
      // Exponer variables y helpers para depuración en consola
      try {
        const g = (typeof window !== 'undefined' ? window : (typeof globalThis !== 'undefined' ? globalThis : this));
        g.__lastResponse = responseData;
        g.__lastCostumers = costumers;
        g.__fechasUltimos7Dias = Array.from(fechasUltimos7Dias);
        g.__hoyISO = hoyISO;
        g.__getByPath = getByPath;
        g.debugDates = function(index = 0) {
          const c = (g.__lastCostumers || [])[index];
          if (!c) { console.warn('debugDates: índice fuera de rango'); return null; }
          const paths = [
            // Raíz
            'dia_venta','diaVenta','dia','fecha','fecha_lead',
            'fecha_creacion','fechaCreacion','createdAt','created_at','createdon','createdOn',
            'created','insertedAt','inserted_at','createdDate','created_date','created_datetime',
            // _raw
            '_raw.dia_venta','_raw.diaVenta','_raw.dia','_raw.fecha','_raw.fecha_lead',
            '_raw.fecha_creacion','_raw.fechaCreacion','_raw.createdAt','_raw.created_at','_raw.createdon','_raw.createdOn',
            '_raw.created','_raw.insertedAt','_raw.inserted_at','_raw.createdDate','_raw.created_date','_raw.created_datetime',
            // metadata
            'metadata.createdAt','metadata.created_at','metadata.createdon','metadata.createdOn',
            // audit/timestamps
            'audit.createdAt','audit.created_at','audit.createdon','audit.createdOn',
            'timestamps.createdAt','timestamps.created_at','timestamps.createdon','timestamps.createdOn'
          ];
          const byPath = (p)=>{
            try { return g.__getByPath(c, p); } catch { return undefined; }
          };
          const found = paths.map(p => ({ path: p, value: byPath(p) }))
                            .filter(x => x.value !== undefined && x.value !== null && x.value !== '');
          console.table(found);
          return { index, hoyISO: g.__hoyISO, found };
        };
      } catch (_) {}
      
      // Procesar los datos de los clientes
      if (Array.isArray(costumers)) {
        if (costumers.length > 0) {
          costumers.forEach(costumer => {
          console.log('Procesando cliente:', costumer);
          
          // Elegir día de negocio priorizando dia_venta; si no, usar fechas de creación
          let fechaStr = '';
          const createdPaths = [
            'creadoEn','fecha_creacion','fechaCreacion','createdAt','created_at','createdon','createdOn','fecha',
            '_raw.creadoEn','_raw.fecha_creacion','_raw.fechaCreacion','_raw.createdAt','_raw.created_at','_raw.fecha',
            'metadata.createdAt','audit.createdAt','timestamps.createdAt'
          ];
          const diaVentaPaths = ['dia_venta','diaVenta'];

          const tryDateFrom = (val) => {
            if (!val) return null;
            if (typeof val === 'string') {
              const s = val.trim();
              // YYYY-MM-DD
              if (/^\d{4}-\d{2}-\d{2}$/.test(s)) {
                const [y,m,d] = s.split('-').map(Number);
                return new Date(Date.UTC(y, m-1, d, 12, 0, 0));
              }
              // DD/MM/YYYY o DD-MM-YYYY (asumimos day-first)
              if (/^\d{2}[\/\-]\d{2}[\/\-]\d{4}$/.test(s)) {
                const parts = s.split(/[\/\-]/).map(Number);
                const [d, m, y] = parts;
                if (d >= 1 && d <= 31 && m >= 1 && m <= 12 && y >= 1900) {
                  return new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
                }
              }
            }
            if (typeof val === 'number') return new Date(val < 1e12 ? val*1000 : val);
            const dt = new Date(val); return isNaN(dt) ? null : dt;
          };

          // 1) Intentar con dia_venta primero
          let fecha = null;
          const diaVentaVal = findFirst(costumer, diaVentaPaths);
          fecha = tryDateFrom(typeof diaVentaVal === 'string' ? diaVentaVal.trim() : diaVentaVal);
          
          // 2) Si dia_venta no es válido, intentar con fechas de creación
          if (!fecha) {
            const fechaCreacionVal = findFirst(costumer, createdPaths);
            fecha = tryDateFrom(fechaCreacionVal);
          }

          if (fecha && !isNaN(fecha.getTime())) {
            fechaStr = toISOInTZ_local(fecha, BUSINESS_TZ_OFFSET_MIN);
            console.log('Fecha elegida (prior DIA_VENTA, fallback CREACION):', fechaStr);
          } else {
            // Fallback a hoy si nada es válido
            fechaStr = toISOInTZ_local(new Date(), BUSINESS_TZ_OFFSET_MIN);
          }
          
          // Si no hay fecha válida, usar la fecha actual
          if (!fechaStr) {
            fechaStr = toISOInTZ_local(new Date(), BUSINESS_TZ_OFFSET_MIN);
            console.log('Usando fecha actual:', fechaStr);
          }
          
          // Contar solo si la fecha pertenece a los últimos 7 días inicializados
          if (!fechasUltimos7Dias.has(fechaStr)) {
            return; // omitir registros fuera del rango
          }
          
          // Obtener el puntaje (puede estar en diferentes campos o ser un número)
          let puntaje = 0;
          if (typeof costumer.puntaje === 'number') {
            puntaje = costumer.puntaje;
          } else if (typeof costumer.puntaje === 'string') {
            puntaje = parseFloat(costumer.puntaje) || 0;
          } else if (costumer.score) {
            puntaje = parseFloat(costumer.score) || 0;
          }
          
          console.log(`Registrando venta para ${fechaStr}: +1 venta, +${puntaje} puntos`);
          
          // Contar la venta y sumar el puntaje (total diario)
          ventasPorDia[fechaStr].ventas += 1;
          ventasPorDia[fechaStr].puntaje += puntaje;
          });
        } else {
          console.info('No hay clientes para procesar (array vacío). Se mostrará la gráfica con ceros.');
        }
      } else {
        console.warn('La respuesta no es un array:', costumers);
      }
      
      // Convertir el objeto a un array y ordenar por fecha
      const datosFinales = Object.entries(ventasPorDia)
        .map(([fecha, datos]) => ({
          fecha,
          ventas: datos.ventas,
          puntaje: datos.puntaje
        }))
        .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      
      console.log('Ventas por día procesadas:', ventasPorDia);
      
      // Si no hay datos válidos, intentar con datos de prueba
      if (datosFinales.length === 0) {
        console.warn('No hay datos válidos para mostrar en la gráfica. Usando datos de prueba.');
        return await procesarDatosGrafica(datosPrueba);
      }
      
      console.log('Datos procesados para la gráfica:', datosFinales);
      
      // Procesar los datos y actualizar la gráfica
      try {
        const resultado = await procesarDatosGrafica(datosFinales);
        console.log('Gráfica de ventas y puntaje actualizada correctamente');
        return resultado;
      } catch (error) {
        console.error('Error al procesar datos para la gráfica:', error);
        mostrarMensajeError('Error al procesar los datos de la gráfica');
        return false;
      }
      
    } catch (error) {
      console.error('Error al actualizar la gráfica de ventas y puntaje:', error);
      // Fallback: mostrar gráfica con datos de prueba para no dejar la UI vacía
      try {
        return await procesarDatosGrafica(datosPrueba);
      } catch (e) {
        mostrarMensajeError('Error al actualizar la gráfica de ventas');
        return false;
      }
    }
  }
  
  // Función auxiliar para procesar los datos y actualizar la gráfica
  async function procesarDatosGrafica(datos) {
    try {
      console.log('=== INICIANDO PROCESAMIENTO DE DATOS PARA GRÁFICA ===');
      
      // Validar datos
      if (!Array.isArray(datos) || datos.length === 0) {
        console.warn('No hay datos disponibles para mostrar en la gráfica');
        mostrarMensajeError('No hay datos de ventas para mostrar');
        return false;
      }
      
      console.log('Datos recibidos para procesar:', datos);
      
      // Helper: convertir Date (instante absoluto) a YYYY-MM-DD en zona fija (UTC-6)
      const toISOInTZ = (date, tzOffsetMinutes) => {
        // Tomar el instante UTC y desplazarlo por el offset de la TZ objetivo
        const target = new Date(date.getTime() + tzOffsetMinutes * 60000);
        const y = target.getUTCFullYear();
        const m = String(target.getUTCMonth() + 1).padStart(2, '0');
        const d = String(target.getUTCDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };

    const BUSINESS_TZ_OFFSET_MIN = -6 * 60; // UTC-6 fijo

    // Función para normalizar fechas al día de negocio (UTC-6)
    // Devuelve un objeto con: { dateObj: Date (a las 12:00 UTC), isoDay: 'YYYY-MM-DD' en TZ negocio }
    const normalizarFecha = (fechaInput) => {
      if (!fechaInput) return null;
      try {
        let fecha;
        // Si ya viene como Date
        if (fechaInput instanceof Date) {
          fecha = fechaInput;
        } else if (/^\d{4}-\d{2}-\d{2}$/.test(fechaInput)) {
          // Cadena YYYY-MM-DD: interpretarla como día de negocio directamente
          // Creamos un Date a mediodía UTC para evitar cambios por horario de verano
          const [y, m, d] = fechaInput.split('-').map(Number);
          fecha = new Date(Date.UTC(y, m - 1, d, 12, 0, 0));
        } else {
          // Timestamp o ISO
          fecha = new Date(fechaInput);
          if (isNaN(fecha.getTime())) return null;
        }
        // Obtener YYYY-MM-DD en la zona del negocio
        const isoDay = toISOInTZ(fecha, BUSINESS_TZ_OFFSET_MIN);
        // Representar este día a las 12:00 UTC para consistencia
        const [yy, mm, dd] = isoDay.split('-').map(Number);
        const dateObj = new Date(Date.UTC(yy, mm - 1, dd, 12, 0, 0));
        return { dateObj, isoDay };
      } catch (error) {
        console.error('Error al normalizar fecha (UTC-6):', fechaInput, error);
        return null;
      }
    };
    
    // Ordenar datos por fecha (día de negocio en UTC-6)
    const datosOrdenados = [...datos].sort((a, b) => {
      const nA = a.fechaObj ? { dateObj: a.fechaObj, isoDay: toISOInTZ(a.fechaObj, BUSINESS_TZ_OFFSET_MIN) } : normalizarFecha(a.fecha);
      const nB = b.fechaObj ? { dateObj: b.fechaObj, isoDay: toISOInTZ(b.fechaObj, BUSINESS_TZ_OFFSET_MIN) } : normalizarFecha(b.fecha);
      const fechaA = nA?.dateObj || new Date(0);
      const fechaB = nB?.dateObj || new Date(0);
      return fechaA - fechaB;
    });
    
    // Generar etiquetas y datasets para los últimos 7 días en la TZ de negocio (UTC-6)
    const labels = [];
    const ventasData = [];
    const puntajesData = [];
    const datosPorFecha = {};
    
    // Mapear datos por clave de día (YYYY-MM-DD en TZ negocio)
    for (const item of datosOrdenados) {
      try {
        let isoDay;
        if (item.fechaObj instanceof Date) {
          isoDay = toISOInTZ(item.fechaObj, BUSINESS_TZ_OFFSET_MIN);
        } else {
          const n = normalizarFecha(item.fecha);
          if (!n) continue;
          isoDay = n.isoDay;
        }
        if (!datosPorFecha[isoDay]) {
          datosPorFecha[isoDay] = { ventas: 0, puntaje: 0, count: 0, fecha: isoDay };
        }
        datosPorFecha[isoDay].ventas += Number(item.ventas) || 0;
        const puntaje = Number(item.puntaje) || 0;
        if (puntaje > 0) {
          datosPorFecha[isoDay].puntaje += puntaje;
          datosPorFecha[isoDay].count += 1;
        }
      } catch (e) {
        console.error('Error procesando item:', item, e);
      }
    }
    
    // Base: hoy en TZ negocio
    const hoyLocal = new Date();
    const hoyISO = toISOInTZ(hoyLocal, BUSINESS_TZ_OFFSET_MIN);
    const [hy, hm, hd] = hoyISO.split('-').map(Number);
    const baseUTCNoon = new Date(Date.UTC(hy, hm - 1, hd, 12, 0, 0));
    for (let i = 6; i >= 0; i--) {
      const fechaUTC = new Date(baseUTCNoon);
      fechaUTC.setUTCDate(baseUTCNoon.getUTCDate() - i);
      const etiquetaISO = toISOInTZ(fechaUTC, BUSINESS_TZ_OFFSET_MIN);
      const [ey, em, ed] = etiquetaISO.split('-').map(Number);
      const etiquetaRef = new Date(Date.UTC(ey, em - 1, ed, 12, 0, 0));
      const diaSemanaNum = etiquetaRef.getUTCDay();
      const diasSemana = ['dom', 'lun', 'mar', 'mié', 'jue', 'vie', 'sáb'];
      const diaSemana = diasSemana[diaSemanaNum];
      const diaDelMes = ed;
      const etiqueta = `${diaSemana} ${diaDelMes}`.toLowerCase();
      labels.push(etiqueta);
      const claveDia = etiquetaISO; // usar día de negocio (UTC-6) como clave
      if (!datosPorFecha[claveDia]) {
        datosPorFecha[claveDia] = { ventas: 0, puntaje: 0, count: 0 };
      }
      const datosDia = datosPorFecha[claveDia];
      ventasData.push(Number(datosDia.ventas) || 0);
      // Usar promedio de puntaje por día (0-100) para evitar inflar valores
      const promedioPuntaje = (Number(datosDia.count) > 0)
        ? (Number(datosDia.puntaje) / Number(datosDia.count))
        : 0;
      puntajesData.push(promedioPuntaje);
      console.log(`Datos para ${claveDia} (${etiqueta}):`, {
        ventas: datosDia.ventas,
        puntaje_sum: datosDia.puntaje,
        puntaje_avg: promedioPuntaje,
        registros: datosDia.count
      });
    }

    // Exponer variables de depuración para comparar con los conteos reales
    try {
      const g = (typeof window !== 'undefined' ? window : (typeof globalThis !== 'undefined' ? globalThis : this));
      g.__labelsGraf = labels.slice();
      g.__ventasGraf = ventasData.slice();
      g.__puntajeGraf = puntajesData.slice();
      g.__datosPorFechaGraf = { ...datosPorFecha };
      // Tabla combinada día->ventas/puntaje para ver rápidamente desalineaciones
      console.table(labels.map((lbl, i) => ({
        idx: i,
        dia_label: lbl,
        dia_iso: Object.keys(datosPorFecha)[i] || '(map)\n',
        ventas: ventasData[i],
        puntaje: puntajesData[i]
      })));
    } catch (_) {}
    
    // Configuración de la gráfica
      const config = {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ventas',
              data: ventasData,
              backgroundColor: 'rgba(54, 162, 235, 0.7)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
              borderRadius: 4,
              yAxisID: 'y',
              datalabels: {
                anchor: 'end',
                align: 'end',
                offset: 4,
                color: '#2c3e50',
                font: { weight: 'bold' },
                formatter: (v) => (v != null && !isNaN(v) && Number(v) !== 0 ? Math.round(v) : '')
              }
            },
            {
              label: 'Puntaje',
              data: puntajesData,
              type: 'bar',
              backgroundColor: 'rgba(255, 99, 132, 0.7)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1,
              borderRadius: 4,
              yAxisID: 'y1',
              datalabels: {
                anchor: 'end',
                align: 'end',
                offset: 4,
                color: '#7f1d1d',
                font: { weight: 'bold' },
                formatter: (v) => {
                  if (v == null || isNaN(v) || Number(v) === 0) return '';
                  const n = Number(v);
                  return Number.isInteger(n) ? String(n) : n.toFixed(2);
                }
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: {
            padding: { bottom: 40 }
          },
          scales: {
            x: {
              display: true,
              grid: { display: false },
              ticks: {
                display: true,
                color: '#4a4a4a',
                autoSkip: false,
                maxRotation: 0,
                minRotation: 0,
                padding: 8,
                font: { size: 12 }
              },
              title: { display: true, text: 'Días' }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: false, text: 'N° de Ventas' },
              beginAtZero: true,
              grid: { display: false },
              border: { display: false },
              ticks: { display: false }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: { display: false, drawOnChartArea: false },
              border: { display: false },
              title: { display: false, text: 'Puntaje' },
              beginAtZero: true,
              ticks: { display: false }
            }
          },
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) { label += ': '; }
                  if (context.parsed.y !== null) { label += context.parsed.y; }
                  return label;
                }
              }
            },
            legend: {
              position: 'top',
              labels: { usePointStyle: true, pointStyle: 'circle', padding: 20 }
            },
            datalabels: {
              display: true,
              clamp: true,
              clip: false
            }
          }
        }
      };

      // Si la gráfica ya existe, actualizar solo los datos
      if (ventasPuntajeChart) {
        ventasPuntajeChart.data = config.data;
        ventasPuntajeChart.options = config.options;
      } else {
        // Si no existe, crear una nueva
        const ctx = document.getElementById('ventasPuntajeChart').getContext('2d');
        ventasPuntajeChart = new Chart(ctx, config);
      }
      
      console.log('Configuración de la gráfica actualizada:', config);
      
      // Actualizar la gráfica con manejo de errores
      console.log('Actualizando gráfica...');
      
      try {
        await ventasPuntajeChart.update('resize');
        console.log('Gráfica actualizada exitosamente');
        return true;
      } catch (updateError) {
        console.error('Error al actualizar con animación:', updateError);
        
        try {
          await ventasPuntajeChart.update();
          console.log('Gráfica actualizada sin animación');
          return true;
        } catch (simpleError) {
          console.error('Error al actualizar sin animación:', simpleError);
          
          try {
            await ventasPuntajeChart.update('none');
            console.log('Gráfica actualizada en modo forzado');
            return true;
          } catch (e) {
            console.error('Error al forzar actualización:', e);
            throw new Error('No se pudo actualizar la gráfica');
          }
        }
      }
    } catch (error) {
      console.error('Error al procesar datos de la gráfica:', error);
      mostrarMensajeError('Error al procesar los datos de la gráfica');
      return false;
    }
  }

  // Función para actualizar la gráfica de ventas por producto con datos de prueba
  function actualizarGraficaVentasProducto() {
    console.log('Usando datos de prueba para la gráfica de productos...');
    
    // Datos de prueba para la gráfica de productos
    const datosPrueba = {
      labels: ['Internet', 'Televisión', 'Telefonía', 'Paquete Completo', 'Internet + TV'],
      datos: [35, 25, 20, 15, 5]
    };
    
    // Inicializar la gráfica si no existe
    if (!ventasProductoChart) {
      console.log('Inicializando gráfica de productos...');
      ventasProductoChart = inicializarGraficaVentasProducto();
      if (!ventasProductoChart) {
        console.error('No se pudo inicializar la gráfica de productos');
        return;
      }
    }

    // Actualizar los datos de la gráfica con los datos de prueba
    ventasProductoChart.data.labels = datosPrueba.labels;
    
    // Actualizar datos de ventas
    if (ventasProductoChart.data.datasets[0]) {
      ventasProductoChart.data.datasets[0].data = datosPrueba.datos;
      
      // Colores para la gráfica
      const backgroundColors = [
        'rgba(54, 162, 235, 0.7)',  // Azul
        'rgba(255, 99, 132, 0.7)',  // Rojo
        'rgba(75, 192, 192, 0.7)',  // Verde
        'rgba(255, 205, 86, 0.7)',  // Amarillo
        'rgba(153, 102, 255, 0.7)'  // Morado
      ];
      
      const borderColors = [
        'rgba(54, 162, 235, 1)',
        'rgba(255, 99, 132, 1)',
        'rgba(75, 192, 192, 1)',
        'rgba(255, 205, 86, 1)',
        'rgba(153, 102, 255, 1)'
      ];
      
      // Aplicar colores a los datos
      ventasProductoChart.data.datasets[0].backgroundColor = backgroundColors;
      ventasProductoChart.data.datasets[0].borderColor = borderColors;
    }
    
    // Actualizar la gráfica con animación
    ventasProductoChart.update({
      duration: 800,
      easing: 'easeOutQuart'
    });
  }

  // Función para obtener los nombres de los días de la semana
  function obtenerNombresDias(fechaInicio) {
    const dias = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
    const fecha = new Date(fechaInicio);
    const resultado = [];
    
    for (let i = 0; i < 7; i++) {
      const fechaActual = new Date(fecha);
      fechaActual.setDate(fecha.getDate() + i);
      const nombreDia = dias[fechaActual.getDay()];
      const diaMes = fechaActual.getDate();
      const mes = fechaActual.getMonth() + 1;
      resultado.push(`${nombreDia} ${diaMes}/${mes}`);
    }
    
    return resultado;
  }

  // Función para actualizar las gráficas con datos de prueba
  async function actualizarGraficas(fecha = null) {
    console.log('Iniciando actualización de gráfica de ventas...');
    
    try {
      // Verificar si el elemento del gráfico existe
      const ventasPuntajeCanvas = document.getElementById('ventasPuntajeChart');
      
      if (!ventasPuntajeCanvas) {
        const errorMsg = 'No se encontró el elemento canvas para la gráfica de ventas y puntaje';
        console.error(errorMsg);
        mostrarMensajeError(errorMsg);
        return;
      }
      
      // Actualizar gráfica de ventas y puntaje
      try {
        console.log('Actualizando gráfica de ventas y puntaje...');
        await actualizarGraficaVentasPuntaje();
        console.log('Gráfica de ventas y puntaje actualizada exitosamente');
      } catch (error) {
        console.error('Error al actualizar gráfica de ventas y puntaje:', error);
        mostrarMensajeError('Error al actualizar gráfica de ventas y puntaje: ' + error.message);
      }
      
    } catch (error) {
      console.error('Error crítico al actualizar las gráficas:', error);
      mostrarMensajeError('Error crítico al actualizar las gráficas: ' + error.message);
    }  }

  

  // Función para obtener los días en un mes específico
  function getDaysInMonth(month, year) {
    // Nota: En JavaScript, los meses van de 0 a 11
    return new Date(year, month + 1, 0).getDate();
  }

  // Función para actualizar los días disponibles según el mes y año seleccionados
  function updateDaysDropdown() {
    const daySelect = document.getElementById('day-select');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    
    const selectedMonth = parseInt(monthSelect.value);
    const selectedYear = parseInt(yearSelect.value);
    const daysInMonth = getDaysInMonth(selectedMonth, selectedYear);
    
    // Guardar el día seleccionado actualmente
    const selectedDay = parseInt(daySelect.value) || 1;
    
    // Limpiar opciones actuales
    daySelect.innerHTML = '';
    
    // Agregar opciones de días
    for (let day = 1; day <= daysInMonth; day++) {
      const option = document.createElement('option');
      option.value = day;
      option.textContent = day;
      daySelect.appendChild(option);
    }
    
    // Establecer el día seleccionado (si es válido para el nuevo mes)
    if (selectedDay <= daysInMonth) {
      daySelect.value = selectedDay;
    } else {
      daySelect.value = daysInMonth; // Último día del mes si el día seleccionado es inválido
    }
  }
  
  // Función para establecer la fecha actual en los selectores
  function setCurrentDate() {
    const now = new Date();
    document.getElementById('month-select').value = now.getMonth();
    document.getElementById('year-select').value = now.getFullYear();
    updateDaysDropdown();
    document.getElementById('day-select').value = now.getDate();
  }
  
  // Función para obtener la fecha seleccionada en formato YYYY-MM-DD
  function getSelectedDate() {
    const day = document.getElementById('day-select').value.padStart(2, '0');
    const month = (parseInt(document.getElementById('month-select').value) + 1).toString().padStart(2, '0');
    const year = document.getElementById('year-select').value;
    return `${year}-${month}-${day}`;
  }
  
  // Función para cargar datos con filtro de fecha
  async function cargarDatosConFiltro() {
    const fechaSeleccionada = getSelectedDate();
    try {
      // Aquí iría la llamada a tu API para obtener los datos filtrados por fecha
      // Por ahora, usamos la función actualizarGraficas existente
      // En una implementación real, deberías modificar actualizarGraficas para aceptar una fecha
      console.log('Cargando datos para la fecha:', fechaSeleccionada);
      await actualizarGraficas(fechaSeleccionada);
    } catch (error) {
      console.error('Error al cargar datos con filtro:', error);
    }
  }

  // Función para inicializar la gráfica de ventas y puntaje
  function inicializarGraficaVentasPuntaje() {
    try {
      // Verificar que el contenedor del gráfico exista
      const canvas = document.getElementById('ventasPuntajeChart');
      if (!canvas) {
        console.error('No se encontró el elemento canvas para la gráfica de ventas y puntaje');
        return null;
      }
      
      // Destruir la instancia anterior del gráfico si existe
      if (ventasPuntajeChart) {
        console.log('Destruyendo instancia anterior del gráfico...');
        ventasPuntajeChart.destroy();
        ventasPuntajeChart = null;
      }
      
      // Obtener el contexto 2D después de asegurarnos de que el canvas existe
      const ctx = canvas.getContext('2d');
      
      // Asegurarse de que el contenedor tenga un tamaño adecuado
      const container = canvas.parentElement;
      container.style.width = '100%';
      container.style.height = '400px';
      
      // Crear y retornar la instancia del gráfico
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Ventas',
              type: 'bar',
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1,
              yAxisID: 'y',
              datalabels: {
                anchor: 'end',
                align: 'end',
                offset: 4,
                color: '#2c3e50',
                font: { weight: 'bold' },
                formatter: (v) => (v != null && !isNaN(v) && Number(v) !== 0 ? Math.round(v) : '')
              }
            },
            {
              label: 'Puntaje',
              type: 'bar',
              backgroundColor: 'rgba(255, 99, 132, 0.7)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1,
              borderRadius: 4,
              yAxisID: 'y1',
              datalabels: {
                anchor: 'end',
                align: 'end',
                offset: 4,
                color: '#7f1d1d',
                font: { weight: 'bold' },
                formatter: (v) => {
                  if (v == null || isNaN(v) || Number(v) === 0) return '';
                  const n = Number(v);
                  return Number.isInteger(n) ? String(n) : n.toFixed(2);
                }
              }
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { bottom: 40 } },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            datalabels: {
              display: false,
              formatter: () => '',
              clamp: true,
              clip: false
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: false,
                text: 'Ventas'
              },
              grid: { display: false, drawTicks: false },
              border: { display: false },
              ticks: { display: false, callback: () => '' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: { display: false, drawOnChartArea: false, drawTicks: false },
              border: { display: false },
              title: {
                display: false,
                text: 'Puntaje'
              },
              ticks: { display: false, callback: () => '' },
              min: 0,
              max: 100
            },
            x: {
              display: true,
              grid: { display: false },
              ticks: {
                display: false,
                callback: () => ''
              },
              title: { display: false, text: '' }
            }
          },
          elements: {
            point: {
              radius: 0,
              hoverRadius: 0
            }
          }
        }
      });
    } catch (error) {
      console.error('Error al inicializar la gráfica de ventas y puntaje:', error);
      return null;
    }
  }

  // Función para inicializar la gráfica de ventas por producto
  function inicializarGraficaVentasProducto() {
    try {
      const ctx = document.getElementById('ventasProductoChart');
      if (!ctx) {
        console.log('No se encontró el elemento canvas para la gráfica de ventas por producto');
        return null;
      }
      
      // Asegurarse de que el contenedor tenga un tamaño adecuado
      const container = ctx.parentElement;
      container.style.width = '100%';
      container.style.height = '400px';
      
      // Retornar null ya que no vamos a inicializar esta gráfica por ahora
      console.log('Gráfica de ventas por producto no inicializada (comentada)');
      return null;
    } catch (error) {
      console.error('Error al inicializar la gráfica de ventas por producto:', error);
      return null;
    }
  }

  // La función initializeApp ha sido movida más abajo en el archivo

  // LÓGICA PRINCIPAL - Se ejecuta cuando el DOM está completamente cargado
  document.addEventListener("DOMContentLoaded", async function() {
    console.log('DOM cargado, inicializando...');
    
    try {
      // Inicializar la aplicación
      initializeApp();
      
    } catch (error) {
      console.error('Error durante la inicialización de la página:', error);
    }
    
    // --- INICIALIZACIÓN DE ELEMENTOS ---
    const selects = {};
    const selectIds = ["team", "agent", "producto", "cuenta", "puntaje"];
    
    // Inicializar solo los selects que existen en el DOM (opcionales en esta página)
    selectIds.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        selects[id] = element;
      } else {
        // Son elementos opcionales; reducir severidad del log para no llenar la consola
        console.info(`Elemento opcional con ID '${id}' no encontrado en el DOM`);
      }
    });
    
    // Obtener referencias a los elementos del DOM
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const applyFilter = document.getElementById('apply-filter');
    const resetFilter = document.getElementById('reset-filter');

    // --- DATOS PARA LOS SELECTS ---
    const data = {
      teams: {
        "Team Irania": ["Irania", "Michael", "Giselle"],
        "Team Pleitez": ["Pleitez", "Kevin", "Nelson"],
        "Team Roberto": ["Roberto", "Santos", "Erick"],
        "Team Lineas": ["Dania", "Genesis", "Ofelia"],
        "Team Randal": ["Randal", "Josue", "Elian"],
        "Team Marisol": ["Marisol", "Isabella", "Naidelyn"],
      },
      productos: [], // Se llenará dinámicamente con fetch
      cuentas: ["Nueva", "Winback", "Agregado"]
    };
    
    // Hacer que los datos estén disponibles globalmente
    window.data = data;

    // Inicializar los selectores de fecha
    setCurrentDate();
    
    // Configurar event listeners para los filtros
    if (monthSelect) monthSelect.addEventListener('change', updateDaysDropdown);
    if (yearSelect) yearSelect.addEventListener('change', updateDaysDropdown);
    if (applyFilter) applyFilter.addEventListener('click', cargarDatosConFiltro);
    if (resetFilter) {
      resetFilter.addEventListener('click', () => {
        setCurrentDate();
        cargarDatosConFiltro();
      });
    }
    
    // --- LLENADO DE SELECTS DEL FORMULARIO ---
    async function llenarProductosDinamicamente() {
      try {
        // Usar la misma lista de productos que está definida en el backend
        const PRODUCTOS_FIJOS = [
          "ATT AIR",
          "FRONTIER 5 GIG",
          "INTERNET + TELEFONO + TV",
          "FRONTIER",
          "FRONTIER INTERNET SERVICIOS"
        ];
        
        // Actualizar el select de productos
        if (selects.producto) {
          selects.producto.innerHTML = '<option value="">Seleccione Producto</option>' + 
            PRODUCTOS_FIJOS.map(p => `<option value="${p}">${p}</option>`).join('');
          window.LISTA_PRODUCTOS = PRODUCTOS_FIJOS;
        }
      } catch (e) {
        console.error('Error al cargar productos:', e);
        if (selects.producto) {
          selects.producto.innerHTML = '<option value="">(Error cargando productos)</option>';
        }
        window.LISTA_PRODUCTOS = [];
      }
    }

    // Función para llenar los selects
    async function llenarSelects() {
      try {
        // Verificar que window.data existe
        if (!window.data) {
          console.warn('No se encontró el objeto window.data');
          return;
        }

        // Llenar select de equipos si existe
        if (selects.team) {
          // Limpiar el select
          selects.team.innerHTML = '<option value="">Seleccione Equipo</option>';
          
          // Verificar que data.teams existe y tiene datos
          if (window.data.teams && typeof window.data.teams === 'object') {
            // Llenar el select de equipos
            Object.keys(window.data.teams).forEach(team => {
              selects.team.add(new Option(team, team));
            });
            
            // Agregar event listener para el cambio de equipo
            selects.team.addEventListener("change", function () {
              if (this.value && window.data.teams[this.value] && selects.agent) {
                // Actualizar el select de agentes cuando cambia el equipo
                selects.agent.innerHTML = '<option value="">Seleccione Agente</option>';
                window.data.teams[this.value].forEach(agent => {
                  selects.agent.add(new Option(agent, agent));
                });
              }
            });
          } else {
            console.warn('No se encontraron datos de equipos');
          }
        }
        
        // Llenar select de cuentas si existe
        if (selects.cuenta) {
          // Limpiar el select
          selects.cuenta.innerHTML = '<option value="">Seleccione Cuenta</option>';
          
          // Verificar que data.cuentas existe y es un array
          if (Array.isArray(window.data.cuentas) && window.data.cuentas.length > 0) {
            // Llenar el select de cuentas
            window.data.cuentas.forEach(cuenta => {
              selects.cuenta.add(new Option(cuenta, cuenta));
            });
          } else {
            console.warn('No se encontraron datos de cuentas');
          }
        }
        
        // Inicializar el select de agentes si existe
        if (selects.agent) {
          selects.agent.innerHTML = '<option value="">Seleccione Agente</option>';
        }
      } catch (error) {
        console.error('Error al llenar los selects:', error);
      }
    }
    
    // Llenar los selects
    llenarSelects();
    
    // Llenar productos dinámicamente
    llenarProductosDinamicamente();

    // Establecer fecha actual en el campo de fecha
    const fechaLead = document.getElementById('fecha-lead');
    if (fechaLead) {
      fechaLead.value = new Date().toISOString().slice(0, 10);
    }
    
    // Inicializar las gráficas
    try {
      console.log('Inicializando gráficas...');
      
      // Asegurarse de que los contenedores de las gráficas estén visibles
      const graphContainers = document.querySelectorAll('.graph-container');
      graphContainers.forEach(container => {
        container.style.display = 'block';
      });
      
      // Inicializar gráfica principal
      ventasPuntajeChart = inicializarGraficaVentasPuntaje();
      
      // Cargar datos iniciales después de un pequeño retraso para asegurar que el DOM esté listo
      setTimeout(async () => {
        console.log('Cargando datos iniciales...');
        try {
          await actualizarGraficaVentasPuntaje();
        } catch (e) {
          console.error('Error al actualizar la gráfica inicialmente:', e);
        }
      }, 100);
    } catch (error) {
      console.error('Error al inicializar gráficas:', error);
    }
    
    // Actualizar gráficas cada 5 minutos (300000 ms)
    setInterval(async () => {
      try {
        await actualizarGraficaVentasPuntaje();
      } catch (e) {
        console.error('Error al actualizar la gráfica periódicamente:', e);
      }
    }, 300000);
    
    // --- LÓGICA DE FORMULARIO ---
    const crmForm = document.getElementById('crmForm');
    if (crmForm) {
      // Función para mostrar notificación
      function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Desaparecer después de 5 segundos
        setTimeout(() => {
          notification.remove();
        }, 5000);
      }

      // Función auxiliar para obtener el valor de un campo con manejo de errores
      function getFieldValue(id, required = false) {
        const element = document.getElementById(id);
        if (!element && required) {
          throw new Error(`Campo requerido no encontrado: ${id}`);
        }
        return element ? element.value : '';
      }

      // Función para obtener el valor de un radio button
      function getRadioValue(name, required = false) {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        if (!selected && required) {
          throw new Error(`Debe seleccionar una opción en: ${name}`);
        }
        return selected ? selected.value : '';
      }

      // Función para manejar el envío del formulario
      async function handleFormSubmit(e) {
        e.preventDefault();
        console.log('=== INICIANDO ENVÍO DE FORMULARIO ===');
        
        // Obtener el botón de envío
        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalButtonText = submitButton ? submitButton.innerHTML : 'Enviar';
        
        // Deshabilitar el botón y mostrar indicador de carga
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
        }
        
        try {
          console.log('=== VALIDANDO CAMPOS DEL FORMULARIO ===');
          
          // Validar campos requeridos
          const requiredFields = [
            { id: 'nombre-cliente', name: 'Nombre del Cliente' },
            { id: 'telefono-principal', name: 'Teléfono Principal' },
            { id: 'tipo-servicio', name: 'Tipo de Servicio' },
            { id: 'dia-venta', name: 'Día de Venta' },
            { id: 'sistema', name: 'Sistema' },
            { id: 'supervisor', name: 'Supervisor' },
            { id: 'direccion', name: 'Dirección' },
            { id: 'mercado', name: 'Mercado' },
            { id: 'riesgo', name: 'Riesgo' },
            { id: 'puntaje', name: 'Puntaje' },
            { id: 'servicios', name: 'Servicios' },
            { id: 'motivo-llamada', name: 'Motivo de la Llamada' }
          ];
          
          // Validar campos requeridos
          const missingFields = [];
          for (const field of requiredFields) {
            const value = field.id === 'motivo-llamada' 
              ? getRadioValue('motivo-llamada')
              : getFieldValue(field.id);
              
            console.log(`Campo ${field.id}:`, value || 'Vacío');
            
            if (!value) {
              missingFields.push(field.name);
            }
          }
          
          if (missingFields.length > 0) {
            throw new Error(`Los siguientes campos son requeridos: ${missingFields.join(', ')}`);
          }
          
          const puntajeVal = getFieldValue('puntaje') || '0';
          
          // Obtener valores una sola vez para evitar múltiples llamadas al DOM
          const nombreCliente = getFieldValue('nombre-cliente');
          const telefonoPrincipal = getFieldValue('telefono-principal');
          const telefonoAlterno = getFieldValue('telefono-alterno') || getFieldValue('telefono-secundario');
          const email = getFieldValue('email');
          const diaVenta = getFieldValue('dia-venta');
          const fechaInstalacionElement = document.getElementById('dia-instalacion');
          console.log('Elemento del campo dia-instalacion:', fechaInstalacionElement);
          console.log('Valor del campo dia-instalacion (directo):', fechaInstalacionElement ? fechaInstalacionElement.value : 'No encontrado');
          
          const fechaInstalacion = getFieldValue('dia-instalacion');
          console.log('Valor del campo dia-instalacion (via getFieldValue):', fechaInstalacion);
          const tipoServicio = getFieldValue('tipo-servicio');
          const producto = getFieldValue('producto');
          // Texto visible en mayúsculas para tipo-servicio
          const tipoServicioSelect = document.getElementById('tipo-servicio');
          const tipoServicioText = tipoServicioSelect && tipoServicioSelect.selectedIndex >= 0
            ? (tipoServicioSelect.options[tipoServicioSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Texto visible en mayúsculas para producto
          const productoSelect = document.getElementById('producto');
          const productoText = productoSelect && productoSelect.selectedIndex >= 0
            ? (productoSelect.options[productoSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Capturar SERVICIOS: valor y texto visible
          const serviciosVal = getFieldValue('servicios');
          const serviciosSelect = document.getElementById('servicios');
          const serviciosText = serviciosSelect && serviciosSelect.selectedIndex >= 0
            ? (serviciosSelect.options[serviciosSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Obtener y validar el campo sistema (usar el TEXTO visible para evitar códigos internos)
          const sistemaElement = document.getElementById('sistema');
          console.log('Elemento del campo sistema:', sistemaElement);
          console.log('Opciones del select sistema:', sistemaElement ? Array.from(sistemaElement.options).map(o => o.value) : 'No encontrado');
          console.log('Valor seleccionado en sistema:', sistemaElement ? sistemaElement.value : 'No encontrado');
          // Texto visible seleccionado (SARA, OPUS, B.O, N/A, CHUZO)
          const sistemaText = (function() {
            if (!sistemaElement) return '';
            const idx = sistemaElement.selectedIndex;
            const txt = idx >= 0 ? (sistemaElement.options[idx]?.text || '') : '';
            return (txt || '').trim().toUpperCase();
          })();
          console.log('Texto visible en sistema (normalizado):', sistemaText);
          
          const supervisor = getFieldValue('supervisor');
          // Obtener el TEXTO visible del select de supervisor
          const supervisorSelect = document.getElementById('supervisor');
          const supervisorText = supervisorSelect && supervisorSelect.selectedIndex >= 0
            ? (supervisorSelect.options[supervisorSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          const direccion = getFieldValue('direccion');
          const ciudad = getFieldValue('ciudad');
          const estado = getFieldValue('estado');
          const zipCode = getFieldValue('zip-code');
          const mercado = getFieldValue('mercado');
          // Obtener el TEXTO visible del select de mercado
          const mercadoSelect = document.getElementById('mercado');
          const mercadoText = mercadoSelect && mercadoSelect.selectedIndex >= 0
            ? (mercadoSelect.options[mercadoSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Riesgo: obtener texto visible en mayúsculas
          const riesgoSelect = document.getElementById('riesgo');
          const riesgoText = riesgoSelect && riesgoSelect.selectedIndex >= 0
            ? (riesgoSelect.options[riesgoSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          // Autopago: obtener valor, texto visible y mapear a boolean
          const autopagoVal = getFieldValue('autopago');
          const autopagoSelect = document.getElementById('autopago');
          const autopagoText = autopagoSelect && autopagoSelect.selectedIndex >= 0
            ? (autopagoSelect.options[autopagoSelect.selectedIndex]?.text || '').trim().toUpperCase()
            : '';
          const autopagoBool = (autopagoVal || '').toString().toLowerCase() === 'si' || (autopagoText === 'SI');
          const numeroCuenta = getFieldValue('numero-cuenta');
          const comentario = getFieldValue('comentario');
          const motivoLlamada = getRadioValue('motivo-llamada');
          const status = document.querySelector('input[name="status"]:checked')?.value || 'PENDING';
          
          // Validar y formatear el puntaje
          let puntajeFinal = 0;
          if (puntajeVal && puntajeVal !== "Sin Puntaje" && puntajeVal !== "Seleccione Puntaje") {
            puntajeFinal = parseFloat(puntajeVal) || 0;
          }
          
          // Datos para la colección crm_agente
          // Asegurarse de que los nombres de los campos coincidan exactamente con los esperados por el servidor
          const leadData = {
            // Información básica del cliente
            nombre_cliente: nombreCliente,
            telefono_principal: telefonoPrincipal,
            telefono_alterno: telefonoAlterno || '',
            telefono: telefonoPrincipal, // Mantener compatibilidad con campos antiguos
            email: email || '',
            
            // Información de la venta
            dia_venta: diaVenta || new Date().toISOString().split('T')[0],
            dia_instalacion: fechaInstalacion || '',
            // Mantener compatibilidad con campos antiguos
            fecha_instalacion: fechaInstalacion || '',
            tipo_servicio: tipoServicioText || 'INTERNET',
            tipo_servicios: tipoServicioText || 'INTERNET', // Mantener compatibilidad
            producto: productoText || producto || '',
            sistema: sistemaText,
            supervisor: supervisorText || supervisor || '',
            agente: 'Agente', // Se debe obtener del usuario autenticado
            
            // Dirección y ubicación
            direccion: direccion || '',
            ciudad: ciudad || '',
            estado: estado || '',
            zip_code: zipCode || '',
            
            // Detalles adicionales
            mercado: mercadoText,
            puntaje: puntajeFinal,
            numero_cuenta: numeroCuenta || '',
            
            // Estado y seguimiento
            status: status,
            comentario: comentario || '',
            motivo_llamada: motivoLlamada || '',
            
            // Metadatos
            creadoEn: new Date().toISOString(),
            actualizadoEn: new Date().toISOString(),
            
            // Campos adicionales para compatibilidad
            servicios: serviciosVal || tipoServicio || 'INTERNET',
            servicios_texto: serviciosText || '',
            riesgo: riesgoText,
            autopago: autopagoText // Guardar texto visible en leadData
          };
          
          // Asegurar que los campos requeridos tengan valores por defecto
          if (!leadData.telefono_principal && leadData.telefono) {
            leadData.telefono_principal = leadData.telefono;
          }

          // Datos para la colección customers (solo los campos solicitados)
          const customerData = {
            // Información del cliente (campos requeridos)
            nombre_cliente: nombreCliente,
            telefono: telefonoPrincipal,
            telefono_alterno: telefonoAlterno || '',
            direccion: direccion,
            tipo_servicio: tipoServicioText || 'INTERNET',
            producto: productoText || producto || '',
            // Incluir servicios (valor y texto visible)
            servicios: serviciosVal || '',
            servicios_texto: serviciosText || '',
            // Incluir el sistema seleccionado (texto visible en mayúsculas)
            sistema: sistemaText,
            // Incluir el mercado seleccionado (texto visible en mayúsculas)
            mercado: mercadoText,
            // Incluir riesgo (texto visible en mayúsculas)
            riesgo: riesgoText,
            // Autopago booleano para backend
            autopago: autopagoBool,
            
            // Información de la venta
            dia_venta: diaVenta || new Date().toISOString().split('T')[0],
            team: supervisorText || 'TEAM IRANIA',
            supervisor: supervisorText || 'TEAM IRANIA',
            agente: 'Agente', // Debería obtenerse del usuario logueado
            dia_instalacion: fechaInstalacion || '',
            puntaje: puntajeFinal || 0,
            zip: zipCode || '',
            
            // Metadatos adicionales
            creadoEn: new Date().toISOString(),
            actualizadoEn: new Date().toISOString(),
            producto_contratado: serviciosText || tipoServicioText || tipoServicio || 'INTERNET',
            fecha_contratacion: diaVenta || new Date().toISOString().split('T')[0],
            equipo: supervisorText || supervisor || 'TEAM IRANIA',
            fecha_creacion: new Date().toISOString(),
            status: status === 'PENDING' ? 'pendiente' : 'activo',
            comentario: comentario || '',
            motivo_llamada: motivoLlamada || '',
            numero_cuenta: numeroCuenta || ''
          };
          
          console.log('Datos del formulario validados correctamente');
          console.log('Datos a enviar:', customerData);
          
          // Continuar con el envío...
          const headers = { 
            "Content-Type": "application/json"
          };

          try {
            console.log('Enviando datos a las bases de datos...');
            
            // Usar la URL base actual (para soportar tanto desarrollo como producción)
            const baseUrl = window.location.origin;
            // Función auxiliar para hacer peticiones con manejo de errores
            const makeRequest = async (endpoint, data) => {
              try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const headers = { 
                  "Content-Type": "application/json"
                };
                
                if (token) {
                  headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`${baseUrl}${endpoint}`, { 
                  method: "POST", 
                  headers: headers,
                  body: JSON.stringify(data)
                });
                
                const responseData = await response.json().catch(() => ({}));
                
                // Considerar exitosas las respuestas 200 y 201
                if (response.ok || response.status === 200 || response.status === 201) {
                  return responseData;
                }
                
                // Para cualquier otro código de error, lanzar un error
                throw new Error(responseData.message || `Error en la petición: ${response.status}`);
              } catch (error) {
                console.error(`Error en makeRequest (${endpoint}):`, error);
                throw error; // Relanzar el error para manejarlo en el catch externo
              }
            };
            
            // Depuración: Mostrar datos que se enviarán
          console.log('=== DATOS A ENVIAR ===');
          console.log('Lead Data:', JSON.stringify(leadData, null, 2));
          console.log('Customer Data:', JSON.stringify(customerData, null, 2));
          console.log('=== DATOS A ENVIAR ===');
          console.log('Lead Data:', JSON.stringify(leadData, null, 2));
          console.log('Customer Data:', JSON.stringify(customerData, null, 2));
            
            // Solo enviar a una base de datos (customers)
            console.log('Enviando datos al endpoint de customers...');
            
            // Asegurarse de que los datos tengan el formato correcto
            const customerDataToSend = { ...customerData };
            
            // Asegurar que el teléfono esté en el formato correcto
            if (customerDataToSend.telefono && !customerDataToSend.telefono_principal) {
              customerDataToSend.telefono_principal = customerDataToSend.telefono;
            }
            
            // Solo enviar una petición a /api/customers
            const customerResponse = await makeRequest("/api/customers", customerDataToSend);
            const leadResponse = { success: true }; // Respuesta simulada para mantener compatibilidad
          
          console.log('=== RESPUESTAS DEL SERVIDOR ===');
          console.log('Lead Response:', leadResponse);
          console.log('Customer Response:', customerResponse);
            
            console.log('Respuesta de leads:', leadResponse);
            console.log('Respuesta de customers:', customerResponse);
            
            // Verificar que la respuesta sea exitosa
            if (customerResponse && customerResponse.success) {
              showNotification("Datos guardados exitosamente", 'success');
              crmForm.reset();
              
              // Forzar una actualización de la gráfica con los datos más recientes
              try {
                console.log('Actualizando gráficas después de enviar lead...');
                await actualizarGraficas();
                console.log('Gráficas actualizadas exitosamente');
              } catch (error) {
                console.error('Error al actualizar las gráficas:', error);
              }
              
              // Opcional: Redirigir o actualizar la tabla de clientes
              if (window.location.pathname.includes('Costumer.html')) {
                try {
                  const leads = await fetchLeadsAgente();
                  renderCostumerTable(leans);
                  updateSummaryCards(leads);
                } catch (error) {
                  console.error('Error al actualizar la tabla de clientes:', error);
                }
              }
            } else {
              throw new Error('Error al guardar los datos del cliente');
            }
          } catch (error) {
            console.error('Error al enviar los datos:', error);
            showNotification(`Error: ${error.message}`, 'error');
          } finally {
            // Restaurar el botón en cualquier caso
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.innerHTML = originalButtonText;
            }
          }
        } catch (error) {
          console.error('Error inesperado:', error);
          showNotification('Ocurrió un error inesperado', 'error');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
          }
        }
      }

      // Agregar el manejador de eventos al formulario
      function initializeForm() {
        const crmForm = document.getElementById('crmForm');
        if (crmForm) {
          crmForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
              await handleFormSubmit(e);
            } catch (error) {
              console.error('Error inesperado en el manejador del formulario:', error);
              showNotification('Ocurrió un error inesperado al procesar el formulario', 'error');
              const submitButton = e.target.querySelector('button[type="submit"]');
              if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = 'Enviar';
              }
            }
          });
        }
      }
      
      // Inicializar el formulario cuando el DOM esté listo
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeForm);
      } else {
        initializeForm();
      }
    } // Cierre de la función principal
    
    // Inicializar la aplicación
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  
  // Contenedor para notificaciones
  const notificationContainer = document.createElement('div');
  notificationContainer.id = 'notification-container';
  document.body.appendChild(notificationContainer);
  
  // Crear y agregar estilos dinámicamente
  const style = document.createElement('style');
  style.textContent = `
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 4px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
    }
    
    .success {
      background-color: #4CAF50;
    }
    
    .error {
      background-color: #F44336;
    }
    
    .warning {
      background-color: #FF9800;
    }
    
    .info {
      background-color: #2196F3;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  `;
  document.head.appendChild(style);
  
  // Función para inicializar la aplicación
  function initializeApp() {
      console.log('Inicializando aplicación...');
      
      // Inicializar datepickers u otros componentes si es necesario
      const fechaLead = document.getElementById('fecha-lead');
      if (fechaLead) {
        fechaLead.value = new Date().toISOString().slice(0, 10);
      }
      
      // Inicializar las gráficas
      try {
        console.log('Inicializando gráficas...');
        
        // Asegurarse de que los contenedores de las gráficas estén visibles
        const graphContainers = document.querySelectorAll('.graph-container');
        graphContainers.forEach(container => {
          container.style.display = 'block';
          // Asegurar que el contenedor tenga un tamaño adecuado
          container.style.width = '100%';
          container.style.height = '400px';
        });
        
        // Inicializar la gráfica de ventas y puntaje
        const chartCanvas = document.getElementById('ventasPuntajeChart');
        if (chartCanvas) {
          console.log('Inicializando gráfica de ventas y puntaje...');
          
          // Asegurarse de que el canvas tenga un tamaño adecuado
          chartCanvas.style.width = '100%';
          chartCanvas.style.height = '400px';
          
          // Inicializar la gráfica
          ventasPuntajeChart = inicializarGraficaVentasPuntaje();
          
          if (ventasPuntajeChart) {
            console.log('Gráfica inicializada correctamente');
            
            // Cargar datos iniciales
            console.log('Cargando datos iniciales...');
            actualizarGraficaVentasPuntaje().catch(error => {
              console.error('Error al actualizar la gráfica:', error);
              // Usar datos de prueba como respaldo
              console.log('Usando datos de prueba...');
              actualizarGraficaVentasPuntaje(datosPrueba);
            });
          } else {
            console.error('No se pudo inicializar la gráfica');
          }
        } else {
          console.error('No se encontró el elemento canvas para la gráfica');
        }
      } catch (error) {
        console.error('Error al inicializar gráficas:', error);
        // Intentar con datos de prueba en caso de error
        if (document.getElementById('ventasPuntajeChart')) {
          actualizarGraficaVentasPuntaje(datosPrueba);
        }
      }
      
      // Actualizar gráficas cada 5 minutos (300000 ms)
      setInterval(() => {
        console.log('Actualizando gráficas...');
        if (typeof actualizarGraficaVentasPuntaje === 'function') {
          actualizarGraficaVentasPuntaje().catch(error => {
            console.error('Error al actualizar la gráfica:', error);
            // Usar datos de prueba como respaldo
            actualizarGraficaVentasPuntaje(datosPrueba);
          });
        }
      }, 300000);
    }
    
  // Inicializar la aplicación cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    initializeApp();
  }
}); // Cierre del event listener principal
</script>
</body>
</html>