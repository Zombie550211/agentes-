<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llamadas y Ventas por Team</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/sidebar-shared.css?v=20251124f">
    <script src="js/fetch-interceptor.js" defer></script>
    <script src="js/sidebar-loader.js" defer></script>
    <style>
        .editable-cell {
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 700;
            color: #000;
        }
        th {
            font-weight: 800 !important;
            color: #000 !important;
        }
        td {
            font-weight: 600 !important;
            color: #000 !important;
        }

        .topbar-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
        }

        .toggle-wrap {
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-label {
            font-weight: 800;
            color: var(--text-color);
            white-space: nowrap;
        }

        .toggle-btn {
            appearance: none;
            -webkit-appearance: none;
            width: 52px;
            height: 30px;
            border-radius: 999px;
            background: #cbd5e1;
            position: relative;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.12);
            transition: background 160ms ease;
        }

        .toggle-btn::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            border-radius: 999px;
            background: #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.25);
            transition: transform 160ms ease;
        }

        .toggle-btn:checked {
            background: #22c55e;
        }

        .toggle-btn:checked::after {
            transform: translateX(22px);
        }

        #excelView { display: none; }

        .excel-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 260px;
            gap: 14px;
            align-items: start;
        }

        .excel-slot {
            min-width: 0;
        }

        .excel-card {
            border: 1px solid #000;
            background: #fff;
        }

        .excel-card table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .excel-card th, .excel-card td {
            border: 1px solid #000;
            padding: 6px 8px;
            font-size: 12px;
            text-align: center;
        }

        .excel-card th {
            background: #000;
            color: #fff !important;
            font-weight: 900 !important;
        }

        .excel-name {
            background: #ffeb3b;
            text-align: left !important;
            font-weight: 900 !important;
        }

        .excel-total-row td {
            background: #000;
            color: #fff !important;
            font-weight: 900 !important;
        }

        .excel-footer {
            background: #22d3ee;
            border-top: 0;
            padding: 6px 8px;
            font-size: 12px;
            font-weight: 900;
        }

        .excel-side {
            display: grid;
            gap: 12px;
        }

        .excel-mini {
            border: 1px solid #000;
            background: #fff;
            padding: 10px;
        }

        .excel-mini input {
            width: 100%;
            border: 1px solid #000;
            padding: 6px 8px;
            font-weight: 900;
            text-transform: uppercase;
        }

        .excel-mini table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .excel-mini td {
            border: 1px solid #000;
            padding: 6px 8px;
            font-size: 12px;
            font-weight: 900;
            text-align: right;
        }

        .excel-mini td:first-child { text-align: left; }

        .excel-editable {
            background: #fff;
            font-weight: 900;
        }
    </style>
<script src="js/logout-handler.js" defer></script>
</head>
<body>
    <div class="layout">
        <nav class="sidebar sidebar-inicio" data-active="llamadas-team"></nav>
        <main class="main-content">
            <div style="padding: 20px;">
                <div class="topbar-row">
                    <h1 style="margin: 0;">Llamadas y Ventas por Team</h1>
                    <div class="toggle-wrap">
                        <span class="toggle-label">Vista Excel</span>
                        <input id="excelToggle" class="toggle-btn" type="checkbox" />
                    </div>
                </div>

                <div id="monthlyView" style="background: var(--card-background); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; min-width: 1200px;">
                        <thead>
                            <tr>
                                <!-- TEAM IRANIA -->
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color); font-weight: 600; background: #f8fbff;" colspan="4">TEAM IRANIA</th>
                                <!-- TEAM BRYAN -->
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color); font-weight: 600; background: #faf5ff;" colspan="3">TEAM BRYAN</th>
                                <!-- TEAM ROBERTO -->
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color); font-weight: 600; background: #f1f8f1;" colspan="3">TEAM ROBERTO</th>
                                <!-- TEAM MARISOL -->
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color); font-weight: 600; background: #fff8f1;" colspan="3">TEAM MARISOL</th>
                                <!-- TEAM SANTANA -->
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color); font-weight: 600; background: #fff0f5;" colspan="3">TEAM SANTANA</th>
                                <!-- TOTALES -->
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--border-color); font-weight: 600; background: #e8eaf6;" colspan="2">TOTALES</th>
                            </tr>
                            <tr style="background: var(--background-light);">
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 12px;">Fecha</th>
                                <!-- TEAM IRANIA - Columnas -->
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #f8fbff;">LLAMADAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #f8fbff;">VENTAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #f8fbff;">TOTALES</th>
                                <!-- TEAM BRYAN - Columnas -->
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #faf5ff;">LLAMADAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #faf5ff;">VENTAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #faf5ff;">TOTALES</th>
                                <!-- TEAM ROBERTO - Columnas -->
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #f1f8f1;">LLAMADAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #f1f8f1;">VENTAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #f1f8f1;">TOTALES</th>
                                <!-- TEAM MARISOL - Columnas -->
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #fff8f1;">LLAMADAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #fff8f1;">VENTAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #fff8f1;">TOTALES</th>
                                <!-- TEAM SANTANA - Columnas -->
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #fff0f5;">LLAMADAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #fff0f5;">VENTAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #fff0f5;">TOTALES</th>
                                <!-- TOTALES - Columnas -->
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #e8eaf6;">TOTAL DE LLAMADAS</th>
                                <th style="padding: 8px; text-align: center; border-bottom: 1px solid var(--border-color); font-size: 12px; background: #e8eaf6;">TOTAL DE VENTAS</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td style="padding: 12px; text-align: left;">-</td>
                                <!-- TEAM IRANIA - Datos -->
                                <td style="padding: 12px; text-align: center; background: #f8fbff;">-</td>
                                <td style="padding: 12px; text-align: center; background: #f8fbff;">-</td>
                                <td style="padding: 12px; text-align: center; background: #f8fbff;">-</td>
                                <!-- TEAM BRYAN - Datos -->
                                <td style="padding: 12px; text-align: center; background: #faf5ff;">-</td>
                                <td style="padding: 12px; text-align: center; background: #faf5ff;">-</td>
                                <td style="padding: 12px; text-align: center; background: #faf5ff;">-</td>
                                <!-- TEAM ROBERTO - Datos -->
                                <td style="padding: 12px; text-align: center; background: #f1f8f1;">-</td>
                                <td style="padding: 12px; text-align: center; background: #f1f8f1;">-</td>
                                <td style="padding: 12px; text-align: center; background: #f1f8f1;">-</td>
                                <!-- TEAM MARISOL - Datos -->
                                <td style="padding: 12px; text-align: center; background: #fff8f1;">-</td>
                                <td style="padding: 12px; text-align: center; background: #fff8f1;">-</td>
                                <td style="padding: 12px; text-align: center; background: #fff8f1;">-</td>
                                <!-- TEAM SANTANA - Datos -->
                                <td style="padding: 12px; text-align: center; background: #fff0f5;">-</td>
                                <td style="padding: 12px; text-align: center; background: #fff0f5;">-</td>
                                <td style="padding: 12px; text-align: center; background: #fff0f5;">-</td>
                                <!-- TOTALES - Datos -->
                                <td style="padding: 12px; text-align: center; background: #e8eaf6;">-</td>
                                <td style="padding: 12px; text-align: center; background: #e8eaf6;">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div id="excelView" style="background: var(--card-background); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); overflow-x: auto;">
                    <div id="excelRoot" class="excel-grid"></div>
                </div>
            </div>
        </main>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const rawUser = localStorage.getItem('user') || sessionStorage.getItem('user');
                const parsedUser = rawUser ? JSON.parse(rawUser) : null;
                const role = String(parsedUser?.role || '').toLowerCase();
                const isAllowed = role.includes('admin') || role.includes('administrador') || role.includes('administrator') || role.includes('backoffice') || role === 'bo';
                if (!isAllowed) {
                    window.location.href = '/inicio.html';
                    return;
                }
            } catch (_) {
                window.location.href = '/inicio.html';
                return;
            }
            if (window.loadSidebar) {
                window.loadSidebar();
            }
            initExcelToggle();
            generateDailyRows();
        });

        function initExcelToggle() {
            const toggle = document.getElementById('excelToggle');
            const monthlyView = document.getElementById('monthlyView');
            const excelView = document.getElementById('excelView');
            const excelRoot = document.getElementById('excelRoot');
            if (!toggle || !monthlyView || !excelView || !excelRoot) return;

            const renderExcel = () => {
                try {
                    // Generar estructura tipo Excel por teams (editable)
                    const teams = [
                        { name: 'TEAM IRANIA', cols: ['LLAMADAS','CALIS','VENTAS'], people: ['IRANIA S','MIGUEL NÚÑEZ','JOSUE RENDEROS','ROXANA MARTINEZ','GISELLE DIAZ','EMELY AYALA','NICOLE CRUZ','JORGE SEGOVIA','WLADIMIR VENTURA'] },
                        { name: 'TEAM ROBERTO', cols: ['LLAMADAS','CALIS','VENTAS'], people: ['FRANCISCO AGUILAR','LUCIA FERMAN','LISBETH CORTEZ','NELSON CEREN','CINDY FLORES','MICHELLE LEIVA','LEVI MARTINEZ','BRYAN PEREZ','JONATHAN LOZANO'] },
                        { name: 'TEAM SANTANA', cols: ['LLAMADAS','CALIS','VENTAS'], people: ['GUADALUPE SANTANA','ANDERSON GUZMAN','JULIO MEJIA','PRISCILA HERNANDEZ','RIQUELMI TORRES','ABIGAIL BERNAL'] },
                        { name: 'TEAM BRYAN', cols: ['LLAMADAS','CALIS','VENTAS'], people: ['BRYAN PLEITEZ','DIEGO MEJIA','ALEXANDER RIVERA','LUIS CHAVARRIA','STEVEN VALERA','RENE GUTIERREZ','EMANUEL VELASQUEZ','JAIRO FLORES','JORGE ESCOBAR'] },
                        { name: 'TEAM MARISOL', cols: ['LLAMADAS','CALIS','VENTAS'], people: ['MARISOL BELTRAN','KATERINE GOMEZ','FERNANDA CASTILLO','KIMBERLY IGLESIAS','EDUARDO ESPAÑA','STEFANI MARTINEZ','JONATHAN MORALES','INGRID GARCIA'] },
                        { name: 'TEAM LINEAS', cols: ['CALIS','VENTAS'], people: ['LUIS GUTIERREZ','KARLA RODRIGUEZ','FERNANDO BELTRAN','TATIANA GIRON','DANIEL DEL CID','JONATHAN FIGUEROA','OSCAR RIVERA','MIGUEL HERRERA','CRISTIAN RIVERA','EDWARD RAMIREZ','JOCELYN REYES','NANCY LOPEZ','VICTOR HURTADO','MANUEL FLORES','MELANY HURTADO','ALEXIS RODRIGUEZ'] }
                    ];

                    const cardHtml = (t) => {
                        const hasLineas = t.name === 'TEAM LINEAS';
                        const nameWidth = hasLineas ? '64%' : '52%';
                        const thead = `
                            <thead>
                                <tr>
                                    <th style="width:${nameWidth};">${t.name}</th>
                                    ${t.cols.map(() => '<th style="width:16%;">&nbsp;</th>').join('')}
                                </tr>
                                <tr>
                                    <th style="width:${nameWidth};">&nbsp;</th>
                                    ${t.cols.map(c => `<th>${c}</th>`).join('')}
                                </tr>
                            </thead>
                        `;

                        const rows = t.people.map(p => {
                            const cells = t.cols
                                .map((c) => `<td class="excel-editable" contenteditable="true" data-team="${t.name}" data-person="${p}" data-col="${c}"></td>`)
                                .join('');
                            return `<tr><td class="excel-name">${p}</td>${cells}</tr>`;
                        }).join('');

                        const totalCells = t.cols
                            .map((c) => `<td class="excel-editable" contenteditable="true" data-team="${t.name}" data-person="TOTAL" data-col="${c}"></td>`)
                            .join('');

                        const tbody = `
                            <tbody>
                                ${rows}
                                <tr class="excel-total-row"><td>TOTAL</td>${totalCells}</tr>
                            </tbody>
                        `;

                        return `
                            <div class="excel-card">
                                <table>${thead}${tbody}</table>
                                <div class="excel-footer" contenteditable="true" data-team="${t.name}" data-metric="score">0</div>
                            </div>
                        `;
                    };

                    const side = `
                        <div class="excel-side" style="grid-column: 4; grid-row: 1 / span 2;">
                            <div class="excel-mini">
                                <input value="MARKETING" />
                            </div>
                            <div class="excel-mini">
                                <table>
                                    <tbody>
                                        <tr><td>LLAMADAS</td><td contenteditable="true" class="excel-editable" data-metric="LLAMADAS"></td></tr>
                                        <tr><td>CALIS</td><td contenteditable="true" class="excel-editable" data-metric="CALIS"></td></tr>
                                        <tr><td>VENTAS</td><td contenteditable="true" class="excel-editable" data-metric="VENTAS"></td></tr>
                                        <tr><td>PERDIDAS</td><td contenteditable="true" class="excel-editable" data-metric="PERDIDAS"></td></tr>
                                        <tr><td>RECICLADAS</td><td contenteditable="true" class="excel-editable" data-metric="RECICLADAS"></td></tr>
                                        <tr><td>TOTAL</td><td contenteditable="true" class="excel-editable" data-metric="TOTAL"></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

                    const topA = `<div class="excel-slot" style="grid-column: 1; grid-row: 1;">${cardHtml(teams[0])}</div>`;
                    const topB = `<div class="excel-slot" style="grid-column: 2; grid-row: 1;">${cardHtml(teams[1])}</div>`;
                    const topC = `<div class="excel-slot" style="grid-column: 3; grid-row: 1;">${cardHtml(teams[2])}</div>`;
                    const botA = `<div class="excel-slot" style="grid-column: 1; grid-row: 2;">${cardHtml(teams[3])}</div>`;
                    const botB = `<div class="excel-slot" style="grid-column: 2; grid-row: 2;">${cardHtml(teams[4])}</div>`;
                    const botC = `<div class="excel-slot" style="grid-column: 3; grid-row: 2;">${cardHtml(teams[5])}</div>`;

                    excelRoot.innerHTML = topA + topB + topC + side + botA + botB + botC;
                } catch (e) {
                    console.error('[Vista Excel] Error renderizando:', e);
                    excelRoot.innerHTML = `<div style="grid-column: 1 / -1; padding: 12px; border: 1px solid #ef4444; background: #fee2e2; color: #7f1d1d; font-weight: 800;">Error renderizando Vista Excel: ${String(e && e.message ? e.message : e)}</div>`;
                }
            };

            const apply = () => {
                const on = !!toggle.checked;
                monthlyView.style.display = on ? 'none' : '';
                excelView.style.display = on ? '' : 'none';
                if (on) {
                    renderExcel();
                }
            };

            toggle.addEventListener('change', apply);
            apply();
        }

        function generateDailyRows() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const teams = [
                { name: 'TEAM IRANIA', color: '#f8fbff' },
                { name: 'TEAM BRYAN', color: '#faf5ff' },
                { name: 'TEAM ROBERTO', color: '#f1f8f1' },
                { name: 'TEAM MARISOL', color: '#fff8f1' },
                { name: 'TEAM SANTANA', color: '#fff0f5' }
            ];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const row = document.createElement('tr');
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
                
                let rowHTML = `<td style="padding: 12px; text-align: left; font-weight: 800;">${dateStr}</td>`;
                
                // Generar celdas para los 5 teams
                teams.forEach((team, teamIndex) => {
                    const cellIndex = teamIndex * 3;
                    rowHTML += `
                        <td class="editable-cell" 
                            style="padding: 12px; text-align: center; background: ${team.color};" 
                            contenteditable="true" 
                            data-day="${day}" 
                            data-team="${team.name}" 
                            data-type="LLAMADAS"
                            onfocus="rememberCellValue(this)"
                            onblur="saveCell(this)"
                            onkeydown="handleKeydown(event, this)">-</td>
                        <td class="editable-cell" 
                            style="padding: 12px; text-align: center; background: ${team.color};" 
                            contenteditable="true" 
                            data-day="${day}" 
                            data-team="${team.name}" 
                            data-type="VENTAS"
                            onfocus="rememberCellValue(this)"
                            onblur="saveCell(this)"
                            onkeydown="handleKeydown(event, this)">-</td>
                        <td 
                            style="padding: 12px; text-align: center; background: ${team.color};" 
                            data-day="${day}" 
                            data-team="${team.name}" 
                            data-type="TOTALES">-</td>
                    `;
                });
                
                // Agregar columna TOTALES al final
                rowHTML += `
                    <td style="padding: 12px; text-align: center; background: #e8eaf6;" 
                        data-day="${day}" 
                        data-team="TOTALES" 
                        data-type="TOTAL DE LLAMADAS">-</td>
                    <td style="padding: 12px; text-align: center; background: #e8eaf6;" 
                        data-day="${day}" 
                        data-team="TOTALES" 
                        data-type="TOTAL DE VENTAS">-</td>
                `;
                
                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            }
            
            // Cargar datos desde la base de datos DESPUÉS de generar las filas
            loadDataFromDatabase();
        }

        async function loadDataFromDatabase() {
            try {
                const today = new Date();
                const response = await fetch(`/api/llamadas-ventas?month=${today.getMonth() + 1}&year=${today.getFullYear()}`);
                const raw = await response.text();
                let result;
                try { result = JSON.parse(raw); } catch (e) { result = { success: false, message: raw }; }
                
                if (result.success) {
                    await populateTableWithData(result.data);
                    console.log('Datos cargados desde la base de datos:', result.data.length, 'registros');
                } else {
                    console.error('Error al cargar datos:', result.message, { status: response.status, result });
                }
            } catch (error) {
                console.error('Error de conexión:', error);
            }
        }

        async function populateTableWithData(data) {
            console.log('Datos recibidos:', data);
            
            for (const record of data) {
                const fecha = new Date(record.fecha);
                const dayLocal = fecha.getDate();
                const dayUtc = fecha.getUTCDate();
                const team = (record.team || '').trim();
                const type = (record.tipo || '').trim();
                const value = (record.valor ?? 0);
                
                console.log(`Cargando: Día ${dayUtc}, Team ${team}, Tipo ${type}, Valor ${value}`);
                
                // Buscar la celda correspondiente
                let cell = document.querySelector(`[data-day="${dayUtc}"][data-team="${team}"][data-type="${type}"]`);
                if (!cell && dayLocal !== dayUtc) {
                    cell = document.querySelector(`[data-day="${dayLocal}"][data-team="${team}"][data-type="${type}"]`);
                }

                if (cell) {
                    const displayValue = (String(value).trim() === '' || Number(value) === 0) ? '-' : value;
                    cell.textContent = displayValue;
                    console.log(`Celda actualizada: ${cell.dataset.day}-${team}-${type} = ${value}`);
                } else {
                    console.warn(`Celda no encontrada: ${dayLocal}/${dayUtc}-${team}-${type}`, record);
                }
            }
            
            // Ahora que el DOM está actualizado, calcular todos los totales.
            await calculateAllTotalsAfterPopulate();
        }

        async function calculateAllTotalsAfterPopulate() {
            console.log('Calculando totales para todos los días del mes después de la carga inicial...');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const teams = ['TEAM IRANIA', 'TEAM BRYAN', 'TEAM ROBERTO', 'TEAM MARISOL', 'TEAM SANTANA'];
                teams.forEach(team => {
                    calculateTotals_InitialLoad(day, team);
                });
                calculateGeneralTotals_InitialLoad(day);
            }
            console.log('Cálculo de todos los totales completado.');
        }

        async function saveCell(cell) {
            const value = (cell.textContent || '').trim();
            const day = cell.dataset.day;
            const team = cell.dataset.team;
            const type = cell.dataset.type;

            const originalValue = (cell.dataset.originalValue ?? '').trim();
            const originalNormalized = (originalValue === '' || originalValue === '-') ? '0' : originalValue;
            const normalizedValue = (value === '' || value === '-') ? '0' : value;

            if (normalizedValue === originalNormalized) {
                return;
            }

            // Si el usuario borra, interpretarlo como 0 y permitir guardar.
            // Visualmente mostramos '-' para 0 para mantener la tabla limpia.
            const shouldShowDash = normalizedValue === '0';
            if (shouldShowDash) {
                cell.textContent = '-';
            } else {
                cell.textContent = normalizedValue;
            }
            
            // Guardar valor temporal para evitar que se borre
            cell.dataset.tempValue = normalizedValue;
            
            try {
                const response = await fetch('/api/llamadas-ventas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        day: parseInt(day),
                        team: team,
                        type: type,
                        value: normalizedValue
                    })
                });

                const raw = await response.text();
                let result;
                try { result = JSON.parse(raw); } catch (e) { result = { success: false, message: raw }; }
                
                if (result.success) {
                    console.log('Guardado en base de datos:', { day, team, type, value: normalizedValue });

                    cell.dataset.originalValue = normalizedValue;
                    
                    // Después de guardar, recalcular los totales para el día afectado
                    if (type === 'LLAMADAS' || type === 'VENTAS') {
                        calculateTotals(day, team); // Recalcula el total del team
                        calculateGeneralTotals(day); // Recalcula el total general del día
                    }
                } else {
                    console.error('Error al guardar:', result.message, { status: response.status, result });
                    // NO revertir el cambio, mantener el valor escrito
                    cell.textContent = (cell.dataset.tempValue === '0') ? '-' : (cell.dataset.tempValue || normalizedValue);
                }
            } catch (error) {
                console.error('Error de conexión al guardar:', error);
                // NO revertir el cambio, mantener el valor escrito
                cell.textContent = (cell.dataset.tempValue === '0') ? '-' : (cell.dataset.tempValue || normalizedValue);
            }
        }

        async function saveCellWithoutRecalculation(cell) {
            const value = cell.textContent.trim();
            const day = cell.dataset.day;
            const team = cell.dataset.team;
            const type = cell.dataset.type;
            
            // Guardar valor temporal para evitar que se borre
            cell.dataset.tempValue = value;
            
            try {
                const response = await fetch('/api/llamadas-ventas', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        day: parseInt(day),
                        team: team,
                        type: type,
                        value: value
                    })
                });

                const raw = await response.text();
                let result;
                try { result = JSON.parse(raw); } catch (e) { result = { success: false, message: raw }; }
                
                if (result.success) {
                    console.log('Guardado en base de datos:', { day, team, type, value });
                } else {
                    console.error('Error al guardar:', result.message, { status: response.status, result });
                    // NO revertir el cambio, mantener el valor escrito
                    cell.textContent = cell.dataset.tempValue || value;
                }
            } catch (error) {
                console.error('Error de conexión al guardar:', error);
                // NO revertir el cambio, mantener el valor escrito
                cell.textContent = cell.dataset.tempValue || value;
            }
        }

        function calculateTotals_InitialLoad(day, team) {
            // Versión de calculateTotals que NO guarda en la base de datos.
            // Se usa solo para la carga inicial de la página.
            const llamadasCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="LLAMADAS"]`);
            const ventasCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="VENTAS"]`);
            const totalesCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="TOTALES"]`);

            if (!llamadasCell || !ventasCell || !totalesCell) return;

            const llamadas = parseFloat(llamadasCell.textContent) || 0;
            const ventas = parseFloat(ventasCell.textContent) || 0;

            totalesCell.textContent = `${llamadas}/${ventas}`;
        }

        function calculateTotals(day, team) {
            console.log(`[DEBUG] calculateTotals llamado con day=${day}, team=${team}`);

            const llamadasCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="LLAMADAS"]`);
            const ventasCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="VENTAS"]`);
            const totalesCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="TOTALES"]`);

            if (!llamadasCell || !ventasCell || !totalesCell) {
                console.log(`[DEBUG] No se encontraron celdas para day=${day}, team=${team}`);
                return;
            }
            
            console.log(`[DEBUG] Celdas encontradas:`, {
                llamadasCell: llamadasCell ? llamadasCell.textContent : 'null',
                ventasCell: ventasCell ? ventasCell.textContent : 'null',
                totalesCell: totalesCell ? totalesCell.textContent : 'null'
            });
            
            const llamadas = parseFloat(llamadasCell.textContent) || 0;
            const ventas = parseFloat(ventasCell.textContent) || 0;

            totalesCell.textContent = `${llamadas}/${ventas}`;
            
            console.log(`[DEBUG] Total actualizado a: ${totalesCell.textContent}`);
            
            // Guardar el total también (pero sin recalcular para evitar bucle)
            saveCellWithoutRecalculation(totalesCell);
        }

        function calculateGeneralTotals_InitialLoad(day) {
            // Versión de calculateGeneralTotals que NO guarda en la base de datos.
            let totalLlamadas = 0;
            let totalVentas = 0;
            const teams = ['TEAM IRANIA', 'TEAM BRYAN', 'TEAM ROBERTO', 'TEAM MARISOL', 'TEAM SANTANA'];

            teams.forEach((team, index) => {
                const llamadasCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="LLAMADAS"]`);
                const ventasCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="VENTAS"]`);
                const llamadas = parseFloat(llamadasCell?.textContent) || 0;
                const ventas = parseFloat(ventasCell?.textContent) || 0;
                totalLlamadas += llamadas;
                totalVentas += ventas;
            });

            const totalLlamadasCell = document.querySelector(`[data-day="${day}"][data-team="TOTALES"][data-type="TOTAL DE LLAMADAS"]`);
            const totalVentasCell = document.querySelector(`[data-day="${day}"][data-team="TOTALES"][data-type="TOTAL DE VENTAS"]`);

            if (!totalLlamadasCell || !totalVentasCell) return;

            totalLlamadasCell.textContent = totalLlamadas;
            totalVentasCell.textContent = totalVentas;
        }

        function calculateGeneralTotals(day) {
            console.log(`[DEBUG] calculateGeneralTotals llamado con day=${day}`);

            const totalLlamadasCell = document.querySelector(`[data-day="${day}"][data-team="TOTALES"][data-type="TOTAL DE LLAMADAS"]`);
            const totalVentasCell = document.querySelector(`[data-day="${day}"][data-team="TOTALES"][data-type="TOTAL DE VENTAS"]`);

            if (!totalLlamadasCell || !totalVentasCell) {
                console.log(`[DEBUG] No se encontraron celdas de totales generales para day=${day}`);
                return;
            }
            
            // Calcular total de llamadas de todos los teams
            let totalLlamadas = 0;
            let totalVentas = 0;
            
            // Teams y sus posiciones base
            const teams = ['TEAM IRANIA', 'TEAM BRYAN', 'TEAM ROBERTO', 'TEAM MARISOL', 'TEAM SANTANA'];
            
            teams.forEach((team, index) => {
                const llamadasCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="LLAMADAS"]`);
                const ventasCell = document.querySelector(`[data-day="${day}"][data-team="${team}"][data-type="VENTAS"]`);
                const llamadas = parseFloat(llamadasCell?.textContent) || 0;
                const ventas = parseFloat(ventasCell?.textContent) || 0;
                
                console.log(`[DEBUG] ${team}: llamadas=${llamadas}, ventas=${ventas}`);
                
                totalLlamadas += llamadas;
                totalVentas += ventas;
            });
            
            console.log(`[DEBUG] Totales generales: llamadas=${totalLlamadas}, ventas=${totalVentas}`);
            
            console.log(`[DEBUG] Celdas generales antes de actualizar:`, {
                totalLlamadasCell: totalLlamadasCell ? totalLlamadasCell.textContent : 'null',
                totalVentasCell: totalVentasCell ? totalVentasCell.textContent : 'null'
            });
            
            totalLlamadasCell.textContent = totalLlamadas;
            totalVentasCell.textContent = totalVentas;
            
            console.log(`[DEBUG] Celdas generales actualizadas a:`, {
                totalLlamadas: totalLlamadasCell.textContent,
                totalVentas: totalVentasCell.textContent
            });
            
            // Guardar los totales generales también (sin recalcular para evitar bucle)
            saveCellWithoutRecalculation(totalLlamadasCell);
            saveCellWithoutRecalculation(totalVentasCell);
        }

        function handleKeydown(event, cell) {
            // Guardar valor original antes de editar
            if (!cell.dataset.originalValue) {
                cell.dataset.originalValue = cell.textContent;
            }
            
            if (event.key === 'Enter') {
                event.preventDefault();
                cell.blur();
            } else if (event.key === 'Tab') {
                // Para Tab, no hacer nada, solo permitir el comportamiento normal
                // El valor actual se mantendrá
                return;
            } else if (event.key === 'Escape') {
                event.preventDefault();
                // Restaurar valor original solo con Escape
                cell.textContent = cell.dataset.originalValue || '-';
                cell.blur();
            }
        }

        function rememberCellValue(cell) {
            cell.dataset.originalValue = (cell.textContent || '').trim();
            if (cell.dataset.originalValue === '-') {
                cell.textContent = '';
            }
        }

        // Función de debugging para forzar recálculo
        function forceRecalculateDay1() {
            console.log('[DEBUG] Forzando recálculo del día 1...');
            
            // Recalcular totales de cada team para el día 1
            const teams = ['TEAM IRANIA', 'TEAM BRYAN', 'TEAM ROBERTO', 'TEAM MARISOL', 'TEAM SANTANA'];
            teams.forEach(team => {
                calculateTotals(1, team);
            });
            
            // Recalcular totales generales
            calculateGeneralTotals(1);
            
            console.log('[DEBUG] Recálculo del día 1 completado');
        }

        // Agregar botón de debugging para forzar recálculo del día 1
        const debugButton = document.createElement('button');
        debugButton.textContent = 'Forzar recálculo del día 1';
        debugButton.onclick = forceRecalculateDay1;
        document.body.appendChild(debugButton);
    </script>
</body>
</html>