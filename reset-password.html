<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restablecer contraseña - CRM Agente</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/sidebar-inicio.css">
  <script>
    // Proteger: solo ADMIN (decodificación JWT base64url-safe)
    (function() {
      function b64urlDecode(seg){
        try {
          if (!seg) return '';
          seg = seg.replace(/-/g, '+').replace(/_/g, '/');
          const pad = seg.length % 4;
          if (pad) seg += '='.repeat(4 - pad);
          return atob(seg);
        } catch { return ''; }
      }
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token || token.split('.').length !== 3) { location.href = 'login.html'; return; }
        const payloadStr = b64urlDecode(token.split('.')[1]);
        const payload = JSON.parse(payloadStr || '{}');
        // Validar expiración si existe 'exp' (en segundos)
        if (typeof payload.exp === 'number') {
          const nowSec = Math.floor(Date.now() / 1000);
          if (payload.exp <= nowSec) { location.href = 'login.html'; return; }
        }
        const role = (payload.role || payload.rol || payload.userRole || '').toLowerCase();
        if (role !== 'admin') { location.href = 'inicio.html'; }
      } catch (e) { location.href = 'login.html'; }
    })();
  </script>
  <script src="agentes/js/auth-check.js"></script>
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="js/sidebar-loader.js"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; }
    .container { margin-left: 260px; padding: 24px; }
    .card { max-width: 560px; background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); padding:24px; }
    .card h1 { font-size:22px; margin:0 0 8px; }
    .card p.help { color:#6b7280; margin:0 0 18px; font-size:14px; }
    .form-group { margin: 12px 0 16px; }
    .form-group label { display:block; font-weight:600; margin-bottom:6px; }
    .form-control { width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:12px 14px; font-size:15px; background:#f9fafb; }
    .row { display:flex; gap:12px; }
    .row > .col { flex:1; }
    .btn { display:inline-flex; align-items:center; gap:8px; border:none; border-radius:10px; padding:12px 16px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#22b3ec; color:#0f172a; }
    .btn-primary:disabled { opacity:.6; cursor:not-allowed; }
    .msg { display:none; margin-top:10px; padding:10px 12px; border-radius:10px; font-size:14px; }
    .msg.success { display:block; background:#ecfdf5; color:#065f46; border:1px solid #34d399; }
    .msg.error { display:block; background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
    .toggle { position:relative; }
    .toggle .eye { position:absolute; right:12px; top:50%; transform:translateY(-50%); color:#6b7280; cursor:pointer; }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar sidebar-inicio" data-active=""></nav>
    <main class="container">
      <div class="card">
        <h1><i class="fas fa-key"></i> Restablecer contraseña</h1>
        <p class="help">Solo administradores. Ingresa el usuario (username) y la nueva contraseña.</p>
        <form id="resetForm">
          <div class="form-group">
            <label for="username">Usuario (username)</label>
            <input type="text" id="username" class="form-control" placeholder="Ej. jdoe" required />
          </div>
          <div class="row">
            <div class="form-group col toggle">
              <label for="newPassword">Nueva contraseña</label>
              <input type="password" id="newPassword" class="form-control" minlength="8" placeholder="Mínimo 8 caracteres" required />
              <span class="eye" data-eye="newPassword"><i class="fas fa-eye"></i></span>
            </div>
            <div class="form-group col toggle">
              <label for="confirmPassword">Confirmar contraseña</label>
              <input type="password" id="confirmPassword" class="form-control" minlength="8" required />
              <span class="eye" data-eye="confirmPassword"><i class="fas fa-eye"></i></span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="submitBtn"><i class="fas fa-save"></i> Guardar</button>
          <div id="message" class="msg"></div>
        </form>
      </div>
    </main>
  </div>
  <script>
    function setMsg(type, text) {
      const el = document.getElementById('message');
      el.className = `msg ${type}`;
      el.textContent = text;
      el.style.display = 'block';
    }

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.eye');
      if (!btn) return;
      const id = btn.getAttribute('data-eye');
      const input = document.getElementById(id);
      if (!input) return;
      if (input.type === 'password') { input.type = 'text'; btn.firstElementChild.className = 'fas fa-eye-slash'; }
      else { input.type = 'password'; btn.firstElementChild.className = 'fas fa-eye'; }
    });

    document.getElementById('resetForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const btn = document.getElementById('submitBtn');
      document.getElementById('message').style.display = 'none';

      if (newPassword.length < 8) { setMsg('error', 'La contraseña debe tener al menos 8 caracteres'); return; }
      if (newPassword !== confirmPassword) { setMsg('error', 'Las contraseñas no coinciden'); return; }

      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const resp = await fetch('/api/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ username, newPassword })
        });
        const data = await resp.json().catch(()=>({}));
        if (!resp.ok) throw new Error(data.message || 'No se pudo restablecer la contraseña');
        setMsg('success', 'Contraseña restablecida correctamente');
        e.target.reset();
      } catch (err) {
        setMsg('error', err.message || 'Error inesperado');
      } finally {
        btn.disabled = false; btn.innerHTML = '<i class="fas fa-save"></i> Guardar';
      }
    });
  </script>
</body>
</html>
