<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸš¦ El SemÃ¡foro - El semaforo</title>
    <link rel="stylesheet" href="css/theme.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="css/sidebar-shared.css?v=20251124f">
    <script src="js/fetch-interceptor.js" defer></script>
    <script src="js/sidebar-loader.js" defer></script>
    <script src="js/logout-handler.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('images/semaforo/vialacteassss.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
        }

        .bg-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            object-position: center;
            z-index: -9999;
            pointer-events: none;
            transform: translateZ(0);
            backface-visibility: hidden;
            will-change: transform;
        }

        .layout {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .main-content {
            margin-left: 260px;
            width: calc(100% - 260px);
            padding: 0;
            position: relative;
            z-index: 1;
            background: transparent;
        }

        @media (max-width: 1024px) {
            .main-content {
                padding: 30px 40px;
            }

            .ranking-row { 
                grid-template-columns: 60px 1fr 150px 120px; 
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }

            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 14px;
            }

            .ranking-container {
                padding: 22px;
            }

            .ranking-row {
                grid-template-columns: 1fr;
                gap: 15px;
                text-align: center;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .legend {
                flex-direction: column;
                gap: 14px;
                align-items: flex-start;
            }
        }

        @media (max-width: 600px) {
            .main-content {
                margin-left: 0;
                width: 100%;
            }
        }

        .page-wrap {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            margin-bottom: 40px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 32px;
            color: #1e293b;
            font-weight: 700;
            text-shadow: none;
            margin: 0;
        }

        .header p {
            font-size: 16px;
            color: #64748b;
            margin-top: 8px;
            font-weight: 600;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        .month-nav {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.65);
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 999px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
            backdrop-filter: blur(6px);
        }

        .month-nav-btn {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            border: 0;
            cursor: pointer;
            font-weight: 800;
            color: #0f172a;
            background: rgba(59, 130, 246, 0.16);
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .month-nav-btn:hover {
            transform: translateY(-1px);
            background: rgba(59, 130, 246, 0.24);
        }

        .month-nav-label {
            min-width: 140px;
            text-align: center;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: 0.3px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            margin-top: -70px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-left: 4px solid transparent;
        }

        .metric-card.success { border-color: #22c55e; }
        .metric-card.warning { border-color: #f59e0b; }
        .metric-card.danger { border-color: #ef4444; }

        .metric-label {
            font-size: 13px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
        }

        .ranking-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: visible;
            margin-top: 120px;
        }

        .ranking-container .bg-meteor-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
        }

        .ranking-container .bg-meteor-layer .meteor {
            position: absolute;
            width: 320px;
            height: auto;
            filter: drop-shadow(0 18px 40px rgba(0,0,0,0.40));
            opacity: 0.95;
        }

        .ranking-container .bg-meteor-layer .meteor.m2 { left: 28%; top: 8%; transform: translateX(-50%) scale(1.8); filter: brightness(1.5) contrast(1.08) drop-shadow(0 18px 40px rgba(0,0,0,0.40)); opacity: 1; }
        .ranking-container .bg-meteor-layer .meteor.m3 { left: 76%; top: 12%; transform: translateX(-50%) scale(1.8); filter: brightness(1.25) contrast(1.05) drop-shadow(0 18px 40px rgba(0,0,0,0.40)); opacity: 1; }

        .ranking-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: transparent;
            z-index: 0;
        }

        .ranking-container video.bg-video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }

        .ranking-container::after {
            content: '';
            position: absolute;
            inset: 0;
            background: transparent;
            z-index: 0;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.35);
            position: relative;
            z-index: 2;
        }

        .ranking-header h2 {
            font-size: 24px;
            color: #ffffff;
            font-weight: 700;
        }

        .ranking-table {
            width: 100%;
            position: relative;
            z-index: 2;
            padding-top: 24px;
        }

        .ranking-row {
            display: grid;
            grid-template-columns: 80px 1fr 200px 150px;
            align-items: center;
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .ranking-row:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .ranking-row.top {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border-color: #22c55e;
        }

        .ranking-row.warning {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border-color: #f59e0b;
        }

        .ranking-row.danger {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            border-color: #ef4444;
        }

        .ranking-position {
            font-size: 28px;
            font-weight: 800;
            color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .position-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: none !important;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 20px;
            background: linear-gradient(135deg, #0f172a, #334155);
        }

        .top .position-badge {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .warning .position-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .danger .position-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .ranking-name h3 {
            font-size: 18px;
            color: #1e293b;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .ranking-name p {
            font-size: 13px;
            color: #64748b;
            font-weight: 600;
        }

        .ranking-sales { text-align: center; }

        .sales-number {
            font-size: 32px;
            font-weight: 800;
            color: #1e293b;
            line-height: 1;
        }

        .sales-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
            font-weight: 700;
        }

        .ranking-status { text-align: center; }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.top { 
            background: linear-gradient(135deg, #FFD700, #FFA500); 
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            border: 2px solid #FFD700;
        }
        .status-badge.warning { background: #f59e0b; color: white; }
        .status-badge.danger { background: #ef4444; color: white; }

        .legend {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f1f5f9;
            background: transparent;
            border-radius: 0;
            padding-left: 0;
            padding-right: 0;
            box-shadow: none;
            position: relative;
            z-index: 2;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .legend-dot.top { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .legend-dot.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .legend-dot.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }

        .legend-text {
            font-size: 14px;
            color: #64748b;
            font-weight: 600;
        }

        .view-stack {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .view-panel {
            width: 100%;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            transition: opacity .28s ease, transform .28s ease;
            will-change: opacity, transform;
        }

        .view-panel.is-hidden {
            position: absolute;
            left: 50%;
            top: 0;
            opacity: 0;
            transform: translate(-50%, 10px) scale(0.98);
            pointer-events: none;
        }

        .view-panel.is-visible {
            position: relative;
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        .agents-panel {
            width: min(1220px, 98vw);
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.22);
            padding: 18px 18px 14px;
        }

        .agents-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 12px;
            padding: 6px 8px 14px;
            border-bottom: 1px solid rgba(15, 23, 42, 0.08);
            margin-bottom: 12px;
        }

        .agents-title {
            font-size: 1.15rem;
            font-weight: 900;
            color: #0f172a;
        }

        .agents-count {
            font-size: 0.85rem;
            font-weight: 800;
            color: rgba(15, 23, 42, 0.72);
        }

        .agents-list {
            max-height: min(82vh, 900px);
            overflow: auto;
            padding: 4px 6px 10px;
        }

        .agent-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            background: #ffffff;
            border: 1px solid rgba(2, 6, 23, 0.08);
            border-radius: 14px;
            padding: 10px 12px;
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.06);
            margin: 10px 0;
            transition: transform .18s ease, box-shadow .18s ease;
        }

        .agent-item.status-green {
            border-left: 8px solid #16a34a;
            background: rgba(34, 197, 94, 0.08);
        }

        .agent-item.status-greenlight {
            border-left: 8px solid #86efac;
            background: rgba(134, 239, 172, 0.12);
        }

        .agent-item.status-yellow {
            border-left: 8px solid #eab308;
            background: rgba(234, 179, 8, 0.12);
        }

        .agent-item.status-red {
            border-left: 8px solid #ef4444;
            background: rgba(239, 68, 68, 0.12);
        }

        .agent-item.status-black {
            border-left: 8px solid #000000;
            background: rgba(2, 6, 23, 0.92);
            border-color: rgba(255, 255, 255, 0.08);
        }

        .agent-item.status-black .agent-name,
        .agent-item.status-black .agent-sub {
            color: rgba(255, 255, 255, 0.90);
        }

        .agent-item.status-black .agent-rank {
            background: rgba(255, 255, 255, 0.10);
            color: #fff;
        }

        .agent-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(2, 6, 23, 0.10);
        }

        .agent-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
            flex: 1;
        }

        .agent-rank {
            width: 34px;
            height: 34px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.92);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 0.95rem;
            flex: 0 0 auto;
        }

        .agent-avatar {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2563eb, #06b6d4);
            color: #fff;
            font-weight: 900;
            font-size: 0.9rem;
            flex: 0 0 auto;
            box-shadow: 0 8px 20px rgba(2, 6, 23, 0.18);
            overflow: hidden;
        }

        .agent-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .agent-meta {
            min-width: 0;
        }

        .agent-name {
            font-weight: 900;
            color: #0f172a;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .agent-sub {
            margin-top: 2px;
            font-size: 0.78rem;
            font-weight: 800;
            color: rgba(15, 23, 42, 0.62);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .agent-right {
            text-align: right;
            flex: 0 0 auto;
        }

        .agent-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
            min-width: 160px;
        }

        .agent-stats-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
            flex-wrap: wrap;
        }

        .agent-pill {
            display: inline-flex;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 900;
            font-size: 0.78rem;
            line-height: 1;
            white-space: nowrap;
        }

        .agent-pill.pill-points {
            background: rgba(37, 99, 235, 0.12);
            color: #1d4ed8;
        }

        .agent-pill.pill-sales {
            background: rgba(2, 132, 199, 0.12);
            color: #0369a1;
        }

        .agent-pill.pill-days {
            background: rgba(15, 23, 42, 0.08);
            color: rgba(15, 23, 42, 0.72);
        }

        .agent-item.status-black .agent-pill.pill-days {
            background: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.92);
        }

        .agent-item.status-black .agent-pill.pill-sales {
            background: rgba(56, 189, 248, 0.16);
            color: #e0f2fe;
        }

        .agent-item.status-black .agent-pill.pill-points {
            background: rgba(96, 165, 250, 0.18);
            color: #dbeafe;
        }

        .agents-divider {
            margin: 16px 0 10px;
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(2, 6, 23, 0.06);
            border: 1px solid rgba(2, 6, 23, 0.08);
            font-weight: 900;
            color: rgba(15, 23, 42, 0.88);
        }

        .poste-superior {
            width: 25px;
            height: 80px;
            background: linear-gradient(90deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            border-radius: 5px 5px 0 0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .poste-superior::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 2px;
            width: 3px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .semaforo-body {
            width: 280px;
            background: linear-gradient(90deg, #1a1a1a 0%, #333 50%, #1a1a1a 100%);
            border-radius: 40px;
            padding: 30px 35px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8), inset 0 2px 5px rgba(255, 255, 255, 0.1);
            border: 8px solid #0a0a0a;
            position: relative;
        }

        .semaforo-body::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 15px;
            width: 8px;
            height: calc(100% - 40px);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .tornillo {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, #555 30%, #2a2a2a 100%);
            border-radius: 50%;
            box-shadow: inset 0 2px 3px rgba(0, 0, 0, 0.5);
        }

        .tornillo::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 2px;
            background: #1a1a1a;
        }

        .tornillo.tl { top: 15px; left: 15px; }
        .tornillo.tr { top: 15px; right: 15px; }
        .tornillo.bl { bottom: 15px; left: 15px; }
        .tornillo.br { bottom: 15px; right: 15px; }

        .luz-circulo {
            width: 210px;
            height: 210px;
            border-radius: 50%;
            margin: 0 auto 35px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 40px rgba(0, 0, 0, 0.5);
        }

        .luz-circulo:last-child {
            margin-bottom: 0;
        }

        .luz-circulo::before {
            content: '';
            position: absolute;
            inset: -15px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 50%, #2a2a2a 100%);
            z-index: -1;
            box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.8);
        }

        .luz-circulo::after {
            content: '';
            position: absolute;
            top: 15%;
            left: 15%;
            width: 35%;
            height: 35%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.6), transparent 60%);
            border-radius: 50%;
            pointer-events: none;
        }

        .luz-verde {
            background: radial-gradient(circle at 35% 35%, #7ef07e, #22c55e 40%, #15803d 80%, #0d5025);
            animation: pulso-verde 3s infinite;
        }

        .luz-amarilla {
            background: radial-gradient(circle at 35% 35%, #fef08a, #eab308 40%, #ca8a04 80%, #854d0e);
            animation: pulso-amarillo 3s infinite;
        }

.luz-roja {
    background: radial-gradient(circle at 35% 35%, #fca5a5, #ef4444 40%, #dc2626 80%, #991b1b);
    animation: pulso-rojo 3s infinite;
}

@keyframes pulso-verde {
    0%, 100% { box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 40px rgba(34, 197, 94, 0.4); }
    50% { box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 60px rgba(34, 197, 94, 0.8); }
}

@keyframes pulso-amarillo {
    0%, 100% { box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 40px rgba(234, 179, 8, 0.4); }
    50% { box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 60px rgba(234, 179, 8, 0.8); }
}

@keyframes pulso-rojo {
    0%, 100% { box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 40px rgba(239, 68, 68, 0.4); }
    50% { box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.7), 0 0 60px rgba(239, 68, 68, 0.8); }
}

        @keyframes astroFloat {
            0%, 100% { transform: translate3d(0, 0, 0); }
            50% { transform: translate3d(0, -10px, 0); }
        }

        @keyframes meteorDrift {
            0%, 100% { transform: translate3d(-50%, 0, 0) scale(2.65) rotate(0deg); }
            50% { transform: translate3d(-50%, -8px, 0) scale(2.65) rotate(1.6deg); }
        }

        .team-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 10px 12px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .team-card:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .position-badge {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: none !important;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .trophy {
            font-size: 1.2rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .team-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: #1f2937;
        }

        .team-metrics {
            margin-top: 2px;
            font-size: 0.8rem;
            color: #111827;
            opacity: 0.95;
        }

        .poste-inferior {
            width: 25px;
            height: 120px;
            background: linear-gradient(90deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            border-radius: 0 0 5px 5px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .poste-inferior::before {
            content: '';
            position: absolute;
            top: 0;
            left: 2px;
            width: 3px;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .base-semaforo {
            width: 120px;
            height: 20px;
            background: linear-gradient(90deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
            margin-top: -5px;
        }

        .legend {
            margin-top: 40px;
            background: transparent;
            border-radius: 20px;
            padding: 20px 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            gap: 30px;
            justify-content: center;
            position: relative;
            z-index: 2;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        .legend-circle.verde {
            background: radial-gradient(circle at 35% 35%, #7ef07e, #22c55e);
        }

        .legend-circle.amarilla {
            background: radial-gradient(circle at 35% 35%, #fef08a, #eab308);
        }

        .legend-circle.roja {
            background: radial-gradient(circle at 35% 35%, #fca5a5, #ef4444);
        }

        .legend-text {
            font-weight: bold;
            color: rgba(226, 232, 240, 0.86);
            font-size: 0.9rem;
        }

        .ranking-podium-final {
            position: relative;
            width: 100%;
            max-width: 820px;
            margin: 10px auto -70px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3;
            min-height: 380px;
        }

        .ranking-podium-final .meteor-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
        }

        .ranking-podium-final .meteor {
            position: absolute;
            width: 320px;
            height: auto;
            filter: drop-shadow(0 18px 40px rgba(0,0,0,0.40));
            opacity: 0.95;
        }

        .ranking-podium-final .meteor.m1 { left: 50%; top: -15%; transform: translateX(-50%) scale(2.65); z-index: 1; animation: meteorDrift 6.5s ease-in-out infinite; transform-origin: 50% 55%; }

        .ranking-podium-final .ranking-base-image {
            width: 100%;
            height: auto;
            display: block;
            filter: drop-shadow(0 18px 40px rgba(2, 6, 23, 0.18));
            user-select: none;
            pointer-events: none;
        }

        .ranking-podium-final .astronauts-overlay {
            position: absolute;
            inset: 0;
            z-index: 5;
        }

        .ranking-podium-final .astronaut-position {
            position: absolute;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        .ranking-podium-final .second-pos { left: 8%; top: -22%; }
        .ranking-podium-final .first-pos { left: 50%; top: -48%; z-index: 10; }
        .ranking-podium-final .third-pos { left: 96%; top: 3%; }

        .ranking-podium-final .astronaut-wrapper {
            width: 340px;
            height: 340px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: visible;
        }

        .ranking-podium-final .astronaut-wrapper.winner {
            width: 400px;
            height: 400px;
            overflow: visible;
        }

        .ranking-podium-final .astronaut-image {
            width: 92%;
            height: 92%;
            object-fit: contain;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.25));
            animation: astroFloat 3.8s ease-in-out infinite;
        }

        .ranking-podium-final .astronaut-wrapper.winner .astronaut-image {
            width: 96%;
            height: 96%;
            filter: drop-shadow(0 12px 24px rgba(0,0,0,0.28)) drop-shadow(0 0 18px rgba(34,197,94,0.35));
            animation-duration: 3.4s;
        }

        .ranking-podium-final .second-pos .astronaut-image { animation-duration: 4.1s; animation-delay: -0.6s; }
        .ranking-podium-final .third-pos .astronaut-image { animation-duration: 4.4s; animation-delay: -1.1s; }

        .ranking-podium-final .position-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 26px rgba(2,6,23,0.18);
            z-index: 20;
        }

        .ranking-podium-final .position-badge.gold {
            background: linear-gradient(135deg, #fde68a, #f59e0b);
            color: #1f2937;
            border-color: rgba(245, 158, 11, 0.35);
        }

        .ranking-podium-final .astronaut-info {
            width: 190px;
            text-align: center;
            background: rgba(2, 6, 23, 0.66);
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 14px;
            padding: 10px 12px;
            box-shadow: 0 16px 40px rgba(2,6,23,0.28);
            backdrop-filter: blur(6px);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -120px;
            z-index: 4;
            display: none;
        }

        .ranking-podium-final .first-pos .astronaut-info { bottom: -170px; }
        .ranking-podium-final .second-pos .astronaut-info { bottom: -95px; }
        .ranking-podium-final .third-pos .astronaut-info { bottom: -80px; }

        .ranking-podium-final .astronaut-name {
            font-weight: 900;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.2;
        }

        .ranking-podium-final .astronaut-score {
            font-weight: 900;
            color: #fde68a;
            font-size: 26px;
            line-height: 1.1;
            margin-top: 2px;
        }

        .ranking-podium-final .astronaut-score.winner {
            color: #fff;
        }

        @media (max-width: 980px) {
            .ranking-podium-final { max-width: 720px; }
            .ranking-podium-final .astronaut-wrapper { width: 250px; height: 250px; }
            .ranking-podium-final .astronaut-wrapper.winner { width: 300px; height: 300px; }
            .ranking-podium-final .astronaut-info { width: 170px; }
        }

        @media (max-width: 720px) {
            .ranking-podium-final { max-width: 520px; }
            .ranking-podium-final .astronaut-wrapper { width: 180px; height: 180px; }
            .ranking-podium-final .astronaut-wrapper.winner { width: 220px; height: 220px; }
            .ranking-podium-final .astronaut-info { width: 140px; padding: 8px 10px; }
            .ranking-podium-final .astronaut-score { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="layout">
        <nav class="sidebar sidebar-inicio" data-active="semaforo"></nav>
        <main class="main-content">
            <div class="page-wrap">
                <div class="header">
                    <div class="header-top">
                        <div>
                            <h1>El semaforo </h1>
                            <p>DesempeÃ±o mensual del equipo de ventas</p>
                            <div class="month-nav" id="month-nav">
                                <button type="button" class="month-nav-btn" id="btn-month-prev" aria-label="Mes anterior">â—€</button>
                                <div class="month-nav-label" id="month-nav-label">â€”</div>
                                <button type="button" class="month-nav-btn" id="btn-month-next" aria-label="Mes siguiente">â–¶</button>
                            </div>
                            <h2 style="margin-top: 15px; font-size: 24px; color: #1e293b; font-weight: 600;">ClasificaciÃ³n del Mes</h2>
                        </div>
                        <button id="btn-toggle-view" type="button" class="btn-primary">
                            <i class="fa-solid fa-users"></i>
                            <span id="btn-toggle-view-text">Ver todos los agentes</span>
                        </button>
                    </div>
                </div>
                <div class="view-stack" id="view-stack">
                    <div id="semaforo-view" class="view-panel is-visible">
                        <div class="metrics-grid">
                            <div class="metric-card success">
                                <div class="metric-label">Equipos en TOP</div>
                                <div class="metric-value" id="metric-top3">0</div>
                            </div>
                            <div class="metric-card warning">
                                <div class="metric-label">Equipos en Alerta</div>
                                <div class="metric-value" id="metric-warning">0</div>
                            </div>
                            <div class="metric-card danger">
                                <div class="metric-label">Equipos en Peligro</div>
                                <div class="metric-value" id="metric-danger">0</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Total de Ventas</div>
                                <div class="metric-value" id="metric-total">0</div>
                            </div>
                        </div>

                        <div class="ranking-container" style="background: transparent; box-shadow: none; border-radius: 0; padding: 20px 40px;">
                            <div class="bg-meteor-layer" aria-hidden="true">
                                <img src="images/semaforo/meteorito-1.png" class="meteor m2" alt="">
                                <img src="images/semaforo/meteorito-1.png" class="meteor m3" alt="">
                            </div>

                            <div class="ranking-podium-final" id="teams-top3-podium">
                                <div class="meteor-layer" aria-hidden="true">
                                    <img src="images/semaforo/meteorito-1.png" class="meteor m1" alt="">
                                </div>
                                <div class="astronauts-overlay">
                                    <div class="astronaut-position first-pos">
                                        <div class="astronaut-wrapper winner">
                                            <img src="images/semaforo/astronauta-1.png" class="astronaut-image" alt="Primer lugar">
                                            <div class="position-badge gold">1</div>
                                        </div>
                                        <div class="astronaut-info">
                                            <div class="astronaut-name">â€”</div>
                                            <div class="astronaut-score winner">$500</div>
                                        </div>
                                    </div>
                                    <div class="astronaut-position second-pos">
                                        <div class="astronaut-wrapper">
                                            <img src="images/semaforo/astronauta-2.png" class="astronaut-image" alt="Segundo lugar">
                                            <div class="position-badge silver">2</div>
                                        </div>
                                        <div class="astronaut-info">
                                            <div class="astronaut-name">â€”</div>
                                            <div class="astronaut-score">$200</div>
                                        </div>
                                    </div>
                                    <div class="astronaut-position third-pos">
                                        <div class="astronaut-wrapper">
                                            <img src="images/semaforo/astronauta-3.jpg" class="astronaut-image" alt="Tercer lugar">
                                            <div class="position-badge bronze">3</div>
                                        </div>
                                        <div class="astronaut-info">
                                            <div class="astronaut-name">â€”</div>
                                            <div class="astronaut-score">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="ranking-table" class="ranking-table"></div>

                            <div class="legend">
                                <div class="legend-item">
                                    <div class="legend-dot top"></div>
                                    <span class="legend-text">TOP - Excelente desempeÃ±o</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot warning"></div>
                                    <span class="legend-text">ALERTA - Debe mejorar</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-dot danger"></div>
                                    <span class="legend-text">PELIGRO - Requiere atenciÃ³n</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="agents-view" class="view-panel is-hidden">
                        <div class="agents-panel">
                            <div class="agents-header">
                                <div class="agents-title">Lista de agentes</div>
                                <div id="agents-count" class="agents-count">0 agentes</div>
                            </div>
                            <div id="agents-list" class="agents-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let equipos = [
            { id: 1, nombre: 'Pleitez', posicion: 1, ventas: 0 },
            { id: 2, nombre: 'Roberto', posicion: 2, ventas: 0 },
            { id: 3, nombre: 'Marisol', posicion: 3, ventas: 0 },
            { id: 4, nombre: 'Johana', posicion: 4, ventas: 0 },
            { id: 5, nombre: 'Irania', posicion: 5, ventas: 0 }
        ];

        function getColor(posicion) {
            if (posicion <= 3) return 'verde';
            if (posicion === 4) return 'amarillo';
            return 'rojo';
        }

        function renderEquipos() {
            const table = document.getElementById('ranking-table');
            if (!table) return;

            const metricTop3 = document.getElementById('metric-top3');
            const metricWarning = document.getElementById('metric-warning');
            const metricDanger = document.getElementById('metric-danger');
            const metricTotal = document.getElementById('metric-total');

            table.innerHTML = '';

            let top3 = 0;
            let warning = 0;
            let danger = 0;
            let totalVentas = 0;

            const getRowStatus = (pos) => {
                if (pos <= 3) return 'top';
                if (pos === 4) return 'warning';
                return 'danger';
            };

            const getRowSub = (status) => {
                if (status === 'top') return 'Equipo de ventas â€¢ Excelente desempeÃ±o';
                if (status === 'warning') return 'Equipo de ventas â€¢ Necesita mejorar';
                return 'Equipo de ventas â€¢ Requiere atenciÃ³n';
            };

            const getRowBadge = (status, pos) => {
                if (status === 'top') {
                    const p = Number(pos || 0);
                    if (p === 1) return '$500';
                    if (p === 2) return '$200';
                    return 'TOP';
                }
                if (status === 'warning') return 'âš ï¸ ALERTA';
                return 'ðŸš¨ PELIGRO';
            };

            const stripDiacritics = (str) => String(str || '')
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');

            const supervisorSlug = (name) => {
                const base = stripDiacritics(String(name || '').trim()).toLowerCase();
                return base
                    .replace(/[^a-z0-9\s._-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^[-.]+|[-.]+$/g, '');
            };

            const setSupervisorPhoto = (imgEl, supervisorName) => {
                if (!imgEl) return;

                const original = imgEl.dataset.originalSrc || imgEl.getAttribute('src') || '';
                if (!imgEl.dataset.originalSrc) imgEl.dataset.originalSrc = original;

                const slug = supervisorSlug(supervisorName);
                if (!slug) {
                    if (original) imgEl.src = original;
                    return;
                }

                const candidates = [
                    `images/supervisores/${slug}.png`,
                    `images/supervisores/${slug}.jpg`,
                    `images/supervisores/${slug}.jpeg`,
                    `images/supervisores/${slug}.webp`,
                ];

                let idx = 0;
                const tryNext = () => {
                    if (idx >= candidates.length) {
                        if (original) imgEl.src = original;
                        return;
                    }
                    const nextSrc = candidates[idx++];
                    imgEl.onerror = tryNext;
                    imgEl.src = nextSrc;
                };

                imgEl.onerror = null;
                tryNext();
            };

            const updateTeamTop3Podium = () => {
                const podium = document.getElementById('teams-top3-podium');
                if (!podium) return;
                const list = Array.isArray(equipos) ? equipos.slice() : [];
                list.sort((a, b) => (Number(b?.ventas || 0) - Number(a?.ventas || 0)));
                const top = list.slice(0, 3);
                const top1 = top[0] || null;
                const top2 = top[1] || null;
                const top3 = top[2] || null;

                const setSlot = (selectorBase, item) => {
                    const nameEl = podium.querySelector(`${selectorBase} .astronaut-name`);
                    const scoreEl = podium.querySelector(`${selectorBase} .astronaut-score`);
                    const score = Number(item?.ventas || 0);
                    const name = formatTeamDisplayName(item?.nombre || '');
                    if (nameEl) nameEl.textContent = name || 'â€”';
                    if (scoreEl) scoreEl.textContent = String(score);
                };

                setSlot('.first-pos', top1);
                setSlot('.second-pos', top2);
                setSlot('.third-pos', top3);
            };

            (equipos || []).forEach((equipo) => {
                const pos = Number(equipo?.posicion || 0);
                const ventas = Number(equipo?.ventas || 0);
                const status = getRowStatus(pos);

                if (status === 'top') top3 += 1;
                else if (status === 'warning') warning += 1;
                else danger += 1;
                totalVentas += ventas;

                const row = document.createElement('div');
                row.className = `ranking-row ${status}`;
                row.innerHTML = `
                    <div class="ranking-position">
                        <div class="position-badge">${pos}</div>
                    </div>
                    <div class="ranking-name">
                        <h3>${equipo?.nombre || 'â€”'}</h3>
                        <p>${getRowSub(status)}</p>
                    </div>
                    <div class="ranking-sales">
                        <div class="sales-number">${ventas}</div>
                        <div class="sales-label">Ventas</div>
                    </div>
                    <div class="ranking-status">
                        <span class="status-badge ${status}">${getRowBadge(status, pos)}</span>
                    </div>
                `;
                table.appendChild(row);
            });

            if (metricTop3) metricTop3.textContent = String(top3);
            if (metricWarning) metricWarning.textContent = String(warning);
            if (metricDanger) metricDanger.textContent = String(danger);
            if (metricTotal) metricTotal.textContent = String(totalVentas);

            updateTeamTop3Podium();
        }

        function getMonthRange(date) {
            const safe = (date instanceof Date && !Number.isNaN(date.getTime())) ? new Date(date) : new Date();
            safe.setHours(12, 0, 0, 0);

            const year = safe.getFullYear();
            const monthIdx = safe.getMonth();
            const month = String(monthIdx + 1).padStart(2, '0');
            const lastDayNum = new Date(year, monthIdx + 1, 0).getDate();
            const firstDay = `${year}-${month}-01`;
            const lastDay = `${year}-${month}-${String(lastDayNum).padStart(2, '0')}`;
            return { firstDay, lastDay, year, monthIdx };
        }

        function normalizeTeamName(name) {
            const raw = String(name || '').trim();
            return raw || 'Sin equipo';
        }

        function formatTeamDisplayName(name) {
            try {
                let v = String(name || '').trim();
                if (!v) return 'Sin equipo';
                if (/^TEAM\s+/i.test(v)) v = v.replace(/^TEAM\s+/i, '').trim();
                const first = v.split(/\s+/)[0] || v;
                const lower = first.toLowerCase();
                return lower.charAt(0).toUpperCase() + lower.slice(1);
            } catch (_) {
                return 'Sin equipo';
            }
        }

        function getAuthToken() {
            try {
                return sessionStorage.getItem('token') || localStorage.getItem('token') || '';
            } catch (_) {
                return '';
            }
        }

        const escapeAttr = (value) => String(value == null ? '' : value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/`/g, '&#96;');

        function sanitizeAvatarUrl(rawUrl) {
            try {
                const url = (rawUrl == null ? '' : String(rawUrl)).trim();
                if (!url) return '';
                if (/^data:image\//i.test(url)) return url;
                if (/^https?:\/\//i.test(url)) return url;
                if (/^\/\//.test(url)) {
                    try { return `${window.location.protocol}${url}`; } catch (_) { return `https:${url}`; }
                }
                if (url.startsWith('/')) return url;
                if (/^uploads\//i.test(url)) return `/${url}`;
                return '';
            } catch (_) {
                return '';
            }
        }

        function toTimestamp(value) {
            try {
                if (!value && value !== 0) return null;
                if (typeof value === 'number' && Number.isFinite(value)) return value;
                if (typeof value === 'object' && value !== null) {
                    if (value.$date) {
                        const parsed = Date.parse(value.$date);
                        return Number.isNaN(parsed) ? null : parsed;
                    }
                    if (value instanceof Date && Number.isFinite(value.getTime())) return value.getTime();
                }
                const parsed = Date.parse(value);
                return Number.isNaN(parsed) ? null : parsed;
            } catch (_) {
                return null;
            }
        }

        function objectIdToHex(value) {
            try {
                if (!value) return '';
                if (typeof value === 'string') return value;
                if (typeof value === 'object') {
                    if (value.$oid && typeof value.$oid === 'string') return value.$oid;
                    if (typeof value.toHexString === 'function') return value.toHexString();
                    if (value.buffer && typeof value.buffer === 'object') {
                        const b = value.buffer;
                        const bytes = [];
                        for (let i = 0; i < 12; i++) {
                            const v = b[i] ?? (Array.isArray(b.data) ? b.data[i] : undefined);
                            if (typeof v !== 'number') return '';
                            bytes.push(v);
                        }
                        return bytes.map(n => n.toString(16).padStart(2, '0')).join('');
                    }
                }
                return String(value);
            } catch (_) {
                return '';
            }
        }

        function buildAgentAvatarUrl(agent) {
            try {
                if (!agent) return '';
                const candidates = [];
                const avatarHex = objectIdToHex(agent.avatarFileId);
                if (avatarHex) candidates.push(`/api/user-avatars/${avatarHex}`);
                candidates.push(agent.avatarUrl, agent.photoUrl, agent.photo, agent.imageUrl, agent.picture, agent.profilePhoto, agent.avatar);
                let selected = '';
                for (const c of candidates) {
                    const s = sanitizeAvatarUrl(c);
                    if (s) { selected = s; break; }
                }
                if (!selected) return '';
                if (selected.includes('v=')) return selected;
                const ts = toTimestamp(agent.avatarUpdatedAt || agent.avatarUpdatedAtMs);
                if (ts) {
                    const sep = selected.includes('?') ? '&' : '?';
                    return `${selected}${sep}v=${ts}`;
                }
                return selected;
            } catch (_) {
                return '';
            }
        }

        function renderAgentAvatarHtml(agent, initials, name) {
            const url = buildAgentAvatarUrl(agent);
            if (!url) return escapeAttr(initials);
            const safeAlt = escapeAttr(name || 'Avatar');
            const safeUrl = escapeAttr(url);
            const fallbackText = escapeAttr(initials);
            return `<img src="${safeUrl}" alt="${safeAlt}" loading="lazy" onerror="this.onerror=null;this.remove();this.parentNode.textContent='${fallbackText}'">`;
        }

        async function fetchWithAuth(url, config) {
            const cfg = config && typeof config === 'object' ? { ...config } : {};
            cfg.headers = cfg.headers && typeof cfg.headers === 'object' ? { ...cfg.headers } : {};
            const token = getAuthToken();
            if (token && !cfg.headers.Authorization) {
                cfg.headers.Authorization = `Bearer ${token}`;
            }
            if (!cfg.credentials) {
                cfg.credentials = 'include';
            }
            return fetch(url, cfg);
        }

        function normalizeVentasValue(row) {
            try {
                const raw = (row && (row.Total ?? row.TOTAL ?? row.total ?? row.cantidad ?? 0)) ?? 0;
                const n = Number(raw);
                return Number.isFinite(n) ? n : 0;
            } catch (_) {
                return 0;
            }
        }

        function shouldExcludeFromSemaforo(name) {
            try {
                const cleaned = String(name || '')
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .trim()
                    .toUpperCase();
                const base = cleaned.replace(/^TEAM\s+/, '').trim();
                const first = (base.split(/\s+/)[0] || base).trim();
                return first === 'JONATHAN' || first === 'LUIS';
            } catch (_) {
                return false;
            }
        }

        function formatScore(value) {
            const num = Number(value);
            if (!Number.isFinite(num)) return '0';
            const rounded = Math.round((num + Number.EPSILON) * 100) / 100;
            if (rounded === Math.floor(rounded)) return String(rounded);
            return rounded.toFixed(2).replace(/\.?0+$/, '');
        }

        function parseNumberFlexible(value) {
            try {
                if (value == null) return null;
                if (typeof value === 'number') return Number.isFinite(value) ? value : null;
                if (typeof value === 'object') {
                    const v = value.$numberInt ?? value.$numberDouble ?? value.$numberDecimal ?? value.value;
                    if (v != null) return parseNumberFlexible(v);
                    return null;
                }
                const s = String(value).trim();
                if (!s) return null;
                // Permitir strings tipo "12", "12.5", "12,5", "12 ventas"
                const cleaned = s.replace(/[^0-9.,-]/g, '').replace(/,/g, '.');
                if (!cleaned) return null;
                const n = Number(cleaned);
                return Number.isFinite(n) ? n : null;
            } catch (_) {
                return null;
            }
        }

        function getScoreFromItem(item) {
            try {
                if (!item) return 0;
                const candidates = [item.sumPuntaje, item.puntos, item.promedio, item.Puntaje, item.puntaje];
                for (const c of candidates) {
                    const n = parseNumberFlexible(c);
                    if (n != null) return n;
                }
                return 0;
            } catch (_) {
                return 0;
            }
        }

        function getVentasFromItem(item) {
            try {
                if (!item) return 0;
                const candidates = [
                    item.ventas,
                    item.Ventas,
                    item.totalVentas,
                    item.total_ventas,
                    item.total,
                    item.Total
                ];
                for (const c of candidates) {
                    const n = parseNumberFlexible(c);
                    if (n != null) return n;
                }
                return 0;
            } catch (_) {
                return 0;
            }
        }

        const DISPLAY_NAME_OVERRIDES = new Map([
            ['alejandramelara', 'Alejandra Melara'],
            ['danmamontes', 'Danma Montes'],
            ['dayanachicas', 'Dayana Chicas'],
            ['eduardorivas', 'Eduardo Rivas'],
            ['elizabethsanchez', 'Elizabeth Sanchez'],
        ]);

        function titleCaseWords(input) {
            const text = String(input || '').trim();
            if (!text) return '';
            const parts = text.split(/\s+/).filter(Boolean);
            return parts.map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
        }

        function pickBestNameSource(agent) {
            const candidates = [
                agent?.name,
                agent?.nombre,
                agent?.fullName,
                agent?.displayName,
                agent?.username
            ].filter(v => typeof v === 'string' && v.trim());

            if (!candidates.length) return '';

            const score = (s) => {
                const v = String(s || '').trim();
                if (!v) return -1;
                const lower = v.toLowerCase();
                let pts = 0;
                if (lower === 'agente' || lower === 'agent') pts -= 5;
                if (/\s/.test(v)) pts += 5;
                if (/[_\.-]/.test(v)) pts += 3;
                if (/[a-z][A-Z]/.test(v)) pts += 3;
                if (v.length >= 8) pts += 1;
                return pts;
            };

            let best = candidates[0];
            let bestScore = score(best);
            for (const c of candidates.slice(1)) {
                const s = score(c);
                if (s > bestScore) {
                    best = c;
                    bestScore = s;
                }
            }
            return String(best || '').trim();
        }

        function resolveAgentDisplayName(agent) {
            try {
                const raw = pickBestNameSource(agent);
                let cleaned = String(raw || '').trim();
                if (!cleaned) return 'â€”';
                const overrideKey = normalizeKey(cleaned);
                const override = DISPLAY_NAME_OVERRIDES.get(overrideKey);
                if (override) return override;

                cleaned = cleaned
                    .replace(/([a-z])([A-Z])/g, '$1 $2')
                    .replace(/([A-Z])([A-Z][a-z])/g, '$1 $2')
                    .replace(/([a-zA-Z])(\d)/g, '$1 $2')
                    .replace(/(\d)([a-zA-Z])/g, '$1 $2')
                    .replace(/[._-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                const parts = titleCaseWords(cleaned).split(' ').filter(Boolean);
                if (parts.length > 2) return `${parts[0]} ${parts[parts.length - 1]}`;
                return parts.join(' ');
            } catch (_) {
                return 'â€”';
            }
        }

        function resolveAgentTeamLabel(agent) {
            try {
                const teamRaw = String(agent?.team || '').trim();
                if (teamRaw) return teamRaw;
                const supervisorTeam = String(agent?.supervisorName || agent?.supervisor || agent?.manager || '').trim();
                if (supervisorTeam) return supervisorTeam;
                return 'Sin equipo';
            } catch (_) {
                return 'Sin equipo';
            }
        }

        function normalizeKey(value) {
            try {
                let raw = value;
                if (raw && typeof raw === 'object') {
                    if (raw.$oid) raw = raw.$oid;
                    else if (raw.oid) raw = raw.oid;
                    else if (raw._id && typeof raw._id === 'string') raw = raw._id;
                    else if (raw.id && typeof raw.id === 'string') raw = raw.id;
                    else if (typeof raw.toHexString === 'function') raw = raw.toHexString();
                    else if (typeof raw.toString === 'function' && raw.toString !== Object.prototype.toString) raw = raw.toString();
                    else raw = '';
                }
                return String(raw || '')
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/[^a-zA-Z0-9]/g, '')
                    .toLowerCase();
            } catch (_) {
                return '';
            }
        }

        function initialsFromName(name) {
            try {
                const v = String(name || '').trim();
                if (!v) return 'A';
                const parts = v.split(/\s+/).filter(Boolean);
                const first = parts[0] || '';
                const last = parts.length > 1 ? parts[parts.length - 1] : '';
                const a = first.charAt(0).toUpperCase();
                const b = last ? last.charAt(0).toUpperCase() : '';
                return (a + b) || 'A';
            } catch (_) {
                return 'A';
            }
        }

        function monthBoundsNow() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            return { fechaInicio: `${y}-${m}-01`, fechaFin: `${y}-${m}-${d}` };
        }

        async function fetchRankingStats() {
            try {
                const { fechaInicio, fechaFin } = monthBoundsNow();
                const url = `/api/ranking?all=1&fechaInicio=${fechaInicio}&fechaFin=${fechaFin}&limit=500`;
                const resp = await fetchWithAuth(url);
                if (!resp || !resp.ok) {
                    const raw = resp ? await resp.text() : '';
                    console.warn('[SEMAFORO] /api/ranking no OK', { status: resp?.status, raw });
                    return [];
                }
                const json = await resp.json();
                const list = Array.isArray(json?.ranking) ? json.ranking : [];
                try {
                    const sample = list.slice(0, 5).map(r => ({
                        nombre: r?.nombre,
                        username: r?.username,
                        userId: r?.userId,
                        ventasRaw: r?.ventas,
                        ventasParsed: getVentasFromItem(r),
                        puntos: r?.puntos,
                        sumPuntaje: r?.sumPuntaje
                    }));
                    console.log('[SEMAFORO] rankingStats sample', sample);
                    console.log('[SEMAFORO] rankingStats sample json', JSON.stringify(sample));
                } catch (_) {}
                return list;
            } catch (err) {
                console.warn('[SEMAFORO] Error cargando ranking de agentes:', err);
                return [];
            }
        }

        async function fetchAgentsDirectory() {
            try {
                const resp = await fetchWithAuth('/api/users/agents');
                if (!resp || !resp.ok) {
                    const raw = resp ? await resp.text() : '';
                    console.warn('[SEMAFORO] /api/users/agents no OK', { status: resp?.status, raw });
                    return [];
                }
                const json = await resp.json();
                const list = Array.isArray(json?.agents) ? json.agents : [];
                // El endpoint devuelve users; filtramos agentes en frontend
                return list.filter(u => {
                    const roleRaw = String(u?.role || '').trim();
                    const role = roleRaw.toLowerCase();
                    if (!role) return false;
                    const roleCompact = role.replace(/[\s._:]/g, '');
                    const teamRaw = String(u?.team || '').trim();
                    const team = teamRaw.toLowerCase();
                    const usernameRaw = String(u?.username || '').trim();
                    const username = usernameRaw.toLowerCase();

                    // Excluir placeholders sin identidad real
                    const nameKey = normalizeKey(u?.name || u?.nombre || u?.fullName || u?.displayName || '');
                    const userKey = normalizeKey(usernameRaw);
                    const isPlaceholder = (nameKey === 'agente' || nameKey === 'agent' || userKey === 'agente' || userKey === 'agent');
                    if (isPlaceholder && !team) return false;

                    // Excluir Team LÃ­neas
                    if (team.includes('lineas') || username.startsWith('lineas-') || role.includes('lineas')) return false;
                    // Excluir roles no deseados explÃ­citamente
                    const deny = ['admin', 'administrador', 'supervisor', 'backoffice', 'back office', 'back_office', 'manager', 'gerente'];
                    if (deny.some(k => role.includes(k))) return false;
                    if (roleCompact === 'bo') return false;
                    // Permitir Ãºnicamente agente/vendedor
                    const allow = ['agente', 'agent', 'vendedor', 'seller'];
                    return allow.some(k => role === k || role.includes(k));
                });
            } catch (err) {
                console.warn('[SEMAFORO] Error cargando directorio de agentes:', err);
                return [];
            }
        }

        async function fetchSemaforoLogic() {
            try {
                const resp = await fetchWithAuth('/api/semaforo');
                if (!resp || !resp.ok) {
                    const raw = resp ? await resp.text() : '';
                    console.warn('[SEMAFORO] /api/semaforo no OK', { status: resp?.status, raw });
                    return { data: [], meta: null };
                }
                const json = await resp.json();
                const list = Array.isArray(json?.data) ? json.data : [];
                return { data: list, meta: json?.meta || null };
            } catch (err) {
                console.warn('[SEMAFORO] Error cargando lÃ³gica semÃ¡foro:', err);
                return { data: [], meta: null };
            }
        }

        function statusRank(status) {
            if (status === 'green') return 0;
            if (status === 'greenlight') return 1;
            if (status === 'yellow') return 2;
            if (status === 'red') return 3;
            if (status === 'black') return 4;
            return 9;
        }

        function computeStatusFromDays(daysWithout) {
            const d = Number(daysWithout || 0);
            if (d >= 4) return 'black';
            if (d === 3) return 'red';
            if (d === 2) return 'yellow';
            if (d === 1) return 'greenlight';
            return 'green';
        }

        function mergeAgentsWithSemaforo(directory, semaforoPayload) {
            const dir = Array.isArray(directory) ? directory : [];
            const semData = Array.isArray(semaforoPayload?.data) ? semaforoPayload.data : [];
            const meta = semaforoPayload?.meta || null;

            const byUserId = new Map();
            const byUsername = new Map();
            const byName = new Map();

            semData.forEach((row) => {
                const uidKey = normalizeKey(row?.userId);
                const unameKey = normalizeKey(row?.username);
                const nameKey = normalizeKey(row?.name || row?.nombre);
                const payload = {
                    ventas: parseNumberFlexible(row?.ventas) ?? 0,
                    puntos: parseNumberFlexible(row?.puntos) ?? 0,
                    daysWithout: parseNumberFlexible(row?.daysWithout) ?? 0,
                    status: String(row?.status || '').trim() || computeStatusFromDays(row?.daysWithout)
                };
                if (uidKey) byUserId.set(uidKey, payload);
                if (unameKey) byUsername.set(unameKey, payload);
                if (nameKey) byName.set(nameKey, payload);
            });

            const safeNoonFromYMD = (ymd) => {
                const parts = String(ymd || '').split('-').map(Number);
                const y = parts[0];
                const m = parts[1];
                const d = parts[2];
                if (!y || !m || !d) return null;
                const dt = new Date(y, m - 1, d);
                dt.setHours(12, 0, 0, 0);
                return dt;
            };

            const todayNoon = safeNoonFromYMD(meta?.today) || (() => {
                const t = new Date();
                t.setHours(12, 0, 0, 0);
                return t;
            })();

            const startNoon = safeNoonFromYMD(meta?.startDate) || (() => {
                const t = new Date(todayNoon);
                t.setDate(1);
                return t;
            })();

            const fallbackDaysWithout = () => {
                const diff = Math.floor((todayNoon.getTime() - startNoon.getTime()) / (24 * 60 * 60 * 1000));
                return Math.max(0, diff) + 1;
            };

            const merged = dir.map((u) => {
                const idKey = normalizeKey(u?._id?.$oid || u?._id || u?.id);
                const unameKey = normalizeKey(u?.username);
                const nameKey = normalizeKey(u?.name || resolveAgentDisplayName(u));
                const sem = (idKey && byUserId.get(idKey)) || (unameKey && byUsername.get(unameKey)) || (nameKey && byName.get(nameKey)) || null;
                const daysWithout = sem ? (parseNumberFlexible(sem.daysWithout) ?? 0) : fallbackDaysWithout();
                const status = sem ? (String(sem.status || '').trim() || computeStatusFromDays(daysWithout)) : computeStatusFromDays(daysWithout);
                return {
                    ...u,
                    ventas: sem ? (parseNumberFlexible(sem.ventas) ?? 0) : 0,
                    puntos: sem ? (parseNumberFlexible(sem.puntos) ?? 0) : 0,
                    daysWithout,
                    status
                };
            });

            merged.sort((a, b) => {
                const ra = statusRank(a?.status);
                const rb = statusRank(b?.status);
                if (ra !== rb) return ra - rb;
                const da = Number(a?.daysWithout || 0);
                const db = Number(b?.daysWithout || 0);
                if (da !== db) return da - db;
                const va = Number(b?.ventas || 0) - Number(a?.ventas || 0);
                if (va !== 0) return va;
                const na = resolveAgentDisplayName(a);
                const nb = resolveAgentDisplayName(b);
                return na.localeCompare(nb, 'es');
            });

            return merged;
        }

        function mergeAgentsWithStats(agents, rankingStats) {
            const dir = Array.isArray(agents) ? agents : [];
            const stats = Array.isArray(rankingStats) ? rankingStats : [];

            const statsByUserId = new Map();
            const statsByUsername = new Map();
            const statsByName = new Map();

            stats.forEach((row) => {
                const userIdKey = normalizeKey(row?.userId?.$oid || row?.userId || row?._id?.$oid || row?._id || row?.id);
                const unameKey = normalizeKey(row?.username);
                const nameKey = normalizeKey(row?.nombreNormalizado || row?.nombre || row?.nombreOriginal || row?.name || row?.agenteNombre || row?.agente);
                const payload = {
                    puntos: getScoreFromItem(row),
                    ventas: getVentasFromItem(row)
                };
                if (userIdKey) statsByUserId.set(userIdKey, payload);
                if (unameKey) statsByUsername.set(unameKey, payload);
                if (nameKey) statsByName.set(nameKey, payload);
            });

            let matched = 0;
            const merged = dir.map((u) => {
                const uidKey = normalizeKey(u?._id?.$oid || u?._id || u?.id);
                const unameKey = normalizeKey(u?.username);
                const nameKey = normalizeKey(u?.name || resolveAgentDisplayName(u));
                const byId = uidKey ? statsByUserId.get(uidKey) : null;
                const byU = unameKey ? statsByUsername.get(unameKey) : null;
                const byN = nameKey ? statsByName.get(nameKey) : null;
                const statsRow = byId || byU || byN || null;
                if (statsRow) matched++;
                return {
                    ...u,
                    puntos: statsRow ? (parseNumberFlexible(statsRow.puntos) ?? 0) : 0,
                    ventas: statsRow ? (parseNumberFlexible(statsRow.ventas) ?? 0) : 0
                };
            });

            try {
                const top = merged.slice(0, 10).map((x) => ({
                    name: x?.name,
                    username: x?.username,
                    id: x?._id,
                    puntos: x?.puntos,
                    ventas: x?.ventas
                }));
                console.log('[SEMAFORO] mergeAgentsWithStats', { agents: dir.length, stats: stats.length, matched, top });
                console.log('[SEMAFORO] mergeAgentsWithStats json', JSON.stringify({ agents: dir.length, stats: stats.length, matched, top }));
            } catch (_) {}

            merged.sort((a, b) => {
                const pa = Number(a?.puntos || 0);
                const pb = Number(b?.puntos || 0);
                if (pb !== pa) return pb - pa;
                const va = Number(a?.ventas || 0);
                const vb = Number(b?.ventas || 0);
                if (vb !== va) return vb - va;
                const na = resolveAgentDisplayName(a);
                const nb = resolveAgentDisplayName(b);
                return na.localeCompare(nb, 'es');
            });

            return merged;
        }

        function renderAgentsList(users) {
            const listEl = document.getElementById('agents-list');
            const countEl = document.getElementById('agents-count');
            if (!listEl) return;
            const arr = Array.isArray(users) ? users.slice() : [];
            listEl.innerHTML = '';
            if (countEl) {
                countEl.textContent = `${arr.length} agentes`;
            }

            const normal = arr.filter(a => String(a?.status || '') !== 'black');
            const blacks = arr.filter(a => String(a?.status || '') === 'black');
            const ordered = [...normal, ...blacks];

            ordered.forEach((agent, idx) => {
                if (idx === normal.length && blacks.length) {
                    const div = document.createElement('div');
                    div.className = 'agents-divider';
                    div.textContent = `Sin ventas 4+ dÃ­as (${blacks.length})`;
                    listEl.appendChild(div);
                }
                const item = document.createElement('div');
                const status = String(agent?.status || 'green');
                item.className = `agent-item status-${status}`;
                const name = resolveAgentDisplayName(agent);
                const initials = initialsFromName(name);
                const team = resolveAgentTeamLabel(agent);
                const username = String(agent?.username || '').trim();
                const ventas = parseNumberFlexible(agent?.ventas) ?? 0;
                const puntos = parseNumberFlexible(agent?.puntos ?? agent?.sumPuntaje) ?? 0;
                const daysWithout = parseNumberFlexible(agent?.daysWithout) ?? 0;
                const subtitle = (username && username.toLowerCase() !== name.toLowerCase())
                    ? `${team} â€¢ ${username}`
                    : `${team}`;

                item.innerHTML = `
                    <div class="agent-left">
                        <div class="agent-rank">${idx + 1}</div>
                        <div class="agent-avatar">${renderAgentAvatarHtml(agent, initials, name)}</div>
                        <div class="agent-meta">
                            <div class="agent-name">${name}</div>
                            <div class="agent-sub">${subtitle}</div>
                        </div>
                    </div>
                    <div class="agent-right">
                        <div class="agent-stats">
                            <div class="agent-stats-row">
                                <span class="agent-pill pill-sales">${ventas} ventas</span>
                                <span class="agent-pill pill-points">${formatScore(puntos)} pts</span>
                                <span class="agent-pill pill-days">${daysWithout}d sin venta</span>
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(item);
            });
        }

        function setupViewToggle() {
            const btn = document.getElementById('btn-toggle-view');
            const btnText = document.getElementById('btn-toggle-view-text');
            const semView = document.getElementById('semaforo-view');
            const agView = document.getElementById('agents-view');
            if (!btn || !btnText || !semView || !agView) return;

            let showingAgents = false;
            const agentsCache = { ts: 0, data: [] };

            const setBtnIcon = (mode) => {
                const icon = btn.querySelector('i');
                if (!icon) return;
                if (mode === 'agents') {
                    icon.className = 'fa-solid fa-traffic-light';
                } else {
                    icon.className = 'fa-solid fa-users';
                }
            };

            const setViews = async (mode) => {
                const nextAgents = mode === 'agents';
                showingAgents = nextAgents;
                if (showingAgents) {
                    semView.classList.remove('is-visible');
                    semView.classList.add('is-hidden');
                    agView.classList.remove('is-hidden');
                    agView.classList.add('is-visible');
                    btnText.textContent = 'Ver semÃ¡foro';
                    setBtnIcon('agents');
                    const now = Date.now();
                    const shouldRefresh = !agentsCache.ts || (now - agentsCache.ts) > 15000; // 15s
                    if (shouldRefresh) {
                        const [directory, semaforoPayload] = await Promise.all([
                            fetchAgentsDirectory(),
                            fetchSemaforoLogic()
                        ]);
                        const merged = mergeAgentsWithSemaforo(directory, semaforoPayload);
                        agentsCache.ts = now;
                        agentsCache.data = merged;
                    }
                    renderAgentsList(agentsCache.data);
                } else {
                    agView.classList.remove('is-visible');
                    agView.classList.add('is-hidden');
                    semView.classList.remove('is-hidden');
                    semView.classList.add('is-visible');
                    btnText.textContent = 'Ver agentes';
                    setBtnIcon('semaforo');
                }
            };

            btn.addEventListener('click', async () => {
                await setViews(showingAgents ? 'semaforo' : 'agents');
            });
        }

        async function fetchMonthSalesByTeam(date) {
            const { firstDay, lastDay } = getMonthRange(date);
            let teamRows = [];

            try {
                let url = `/api/equipos/estadisticas?fechaInicio=${firstDay}&fechaFin=${lastDay}`;
                try {
                    const u = JSON.parse(sessionStorage.getItem('user') || localStorage.getItem('user') || 'null');
                    const role = (u?.role || '').toString().trim().toLowerCase();
                    if (role === 'agent' || role === 'agente') {
                        url += '&forceAll=1';
                    }
                } catch (_) {}

                const resp = await fetchWithAuth(url);
                if (resp && resp.ok) {
                    const json = await resp.json();
                    const mainData = Array.isArray(json?.data) ? json.data : [];
                    const lineasData = Array.isArray(json?.lineas) ? json.lineas : [];
                    const payloadOk = (json && typeof json === 'object') ? (json.success !== false) : true;
                    if (payloadOk) {
                        teamRows = [...mainData, ...lineasData];
                        if (!teamRows.length && Array.isArray(json)) {
                            teamRows = json;
                        }
                    }
                } else {
                    const raw = resp ? await resp.text() : '';
                    console.warn('[SEMAFORO] /api/equipos/estadisticas no OK', { status: resp?.status, raw });
                }
            } catch (err) {
                console.warn('[SEMAFORO] Error solicitando estadÃ­sticas mensuales:', err);
            }

            const map = new Map();
            for (const row of (teamRows || [])) {
                const name = normalizeTeamName(row?.TEAM || row?.name || row?.team || row?.equipo);
                if (shouldExcludeFromSemaforo(name)) {
                    continue;
                }
                const ventas = normalizeVentasValue(row);
                map.set(name, (map.get(name) || 0) + ventas);
            }

            const teams = Array.from(map.entries()).map(([nombre, ventas]) => ({ nombre: formatTeamDisplayName(nombre), ventas }));
            teams.sort((a, b) => {
                const diff = Number(b.ventas || 0) - Number(a.ventas || 0);
                if (diff !== 0) return diff;
                return String(a.nombre || '').localeCompare(String(b.nombre || ''), 'es');
            });
            return teams;
        }

        async function loadSemaforoMensual() {
            try {
                const now = new Date();
                const teams = await fetchMonthSalesByTeam(now);
                if (!Array.isArray(teams) || teams.length === 0) {
                    console.warn('[SEMAFORO] Dataset mensual vacÃ­o; manteniendo lista local.');
                    return;
                }

                equipos = teams.slice(0, 5).map((t, idx) => ({
                    id: idx + 1,
                    nombre: t.nombre,
                    posicion: idx + 1,
                    ventas: Number(t.ventas || 0)
                }));
                renderEquipos();
            } catch (err) {
                console.warn('[SEMAFORO] No se pudo cargar semÃ¡foro mensual:', err);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (window.loadSidebar) {
                window.loadSidebar();
            }
            renderEquipos();
            loadSemaforoMensual();
            setupViewToggle();
        });
    </script>
</body>
</html>
