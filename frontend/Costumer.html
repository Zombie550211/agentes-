
<!DOCTYPE html>
<html lang="es">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>CRM Agente - Costumer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="/vendor/fontawesome/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/costumer-table-clean.css?v=20251124">
  <link rel="stylesheet" href="css/costumer-table-actions.css">
  <link rel="stylesheet" href="css/costumer-table-comments.css">
  <link rel="stylesheet" href="css/costumer-calendar.css">
  <link rel="stylesheet" href="css/sidebar-shared.css?v=20251124f">
  <script src="scripts/measure_fetch_times.js"></script>
  <!-- Guard temporal ANTES de cargar scripts: bloquear redirecciones a inicio -->
    <script>
      // Delegated handler: asegurar que los botones .date-filter-btn siempre abran el popup
      document.addEventListener('click', function(e){
        try {
          const btn = e.target.closest && e.target.closest('.date-filter-btn');
          if (!btn) return;
          e.preventDefault(); e.stopPropagation();
          const field = btn.getAttribute('data-field');
          const lsKey = btn.getAttribute('data-lskey');
          if (typeof window.openDateFilterPopup === 'function') {
            window.openDateFilterPopup({ field: field, lsKey: lsKey, trigger: btn, label: btn.title || '' });
          } else {
            console.warn('openDateFilterPopup no está disponible todavía');
          }
        } catch(err) { console.error('date-filter delegated click error', err); }
      });
    </script>
  <script>
            function rebuildStickyHead(){ 
              // Función deshabilitada temporalmente para evitar errores de DOM
              // El sticky head no es crÃ­tico para la funcionalidad del filtro
              return;
        }
        // expose globally to re-run after rendering
        window.rebuildStickyHead = rebuildStickyHead;

    // Edición por clave local cuando el lead no tiene _id/id (por ejemplo, datos inyectados temporalmente)
    window.editarLeadKey = function(key) {
      try {
        if (!key) { alert('Error: No se proporcionó clave local'); return null; }
        const map = (window.__leadKeyMap instanceof Map) ? window.__leadKeyMap : null;
        if (!map) { console.warn('editarLeadKey: no hay mapa de leads locales'); return null; }
        const lead = map.get(key);
        if (!lead) { alert('Error: No se encontró el registro local'); return null; }
        try {
          const lid = (typeof extractLeadId === 'function') ? String(extractLeadId(lead) || '').trim() : '';
          if (!(/^[a-fA-F0-9]{24}$/).test(lid)) {
            alert('âŒ Este registro no tiene un ID vÃ¡lido. Para evitar sobrescrituras/duplicados, no se permite editarlo.');
            return null;
          }
        } catch (_) {}
        // Intentar abrir modal de ediciÃ³n si la funciÃ³n existe
        if (typeof abrirModalEdicion === 'function') {
          try { abrirModalEdicion(lead); } catch (e) { console.warn('abrirModalEdicion error', e); }
        } else {
          console.log('editarLeadKey: abrirModalEdicion no disponible, mostrando en consola:', lead);
        }
        return lead;
      } catch (e) {
        console.warn('editarLeadKey error:', e);
        return null;
      }
    };

    window.eliminarLeadKey = async function(key) {
      try {
        if (!key) { alert('Error: No se proporcionó clave local'); return false; }
        const map = (window.__leadKeyMap instanceof Map) ? window.__leadKeyMap : null;
        if (!map) { console.warn('eliminarLeadKey: no hay mapa de leads locales'); return false; }
        const lead = map.get(key);
        if (!lead) { alert('Error: No se encontró el registro local'); return false; }
        const id = (typeof getLeadId === 'function') ? getLeadId(lead) : (lead?._id?.$oid || lead?._id || lead?.id || '');
        const cleanId = String(id || '').trim();
        if (!cleanId) {
          try {
            const keys = Object.keys(lead || {});
            const rawKeys = Object.keys((lead && lead._raw) || {});
            let preview = '';
            try {
              preview = JSON.stringify(lead && lead._raw ? lead._raw : lead);
              if (preview && preview.length > 500) preview = preview.slice(0, 500) + '...';
            } catch (_) { preview = '[no-json]'; }
            const diag = {
              key,
              leadKeys: keys,
              rawKeys,
              candidateRawId: lead?._raw?._id,
              candidateId: lead?._id,
              preview
            };
            try { window.__lastDeleteDiag = diag; } catch (_) {}
            console.error('[eliminarLeadKey] No se pudo resolver ID', diag);
          } catch (_) {}
          alert('Error: ID de registro no vÃ¡lido. Abre consola (F12) y ejecuta: copy(window.__lastDeleteDiag) y pÃ©gamelo aquÃ­.');
          return false;
        }
        if (typeof window.eliminarLead !== 'function') { alert('Error: funciÃ³n eliminarLead no disponible'); return false; }
        await window.eliminarLead(cleanId);
        return true;
      } catch (e) {
        console.warn('eliminarLeadKey error:', e);
        alert('No se pudo eliminar el registro: ' + (e?.message || e));
        return false;
      }
    };
      (function initSidebarAutoHide(){
        const doInit = () => {
          try {
            if (document.body) document.body.classList.add('auto-hide-sidebar');

            // Insertar zona de hover si no existe
            if (!document.querySelector('.sidebar-hover-zone')) {
              const zoneEl = document.createElement('div');
              zoneEl.className = 'sidebar-hover-zone';
              if (document.body) document.body.appendChild(zoneEl);
            }

            const zone = document.querySelector('.sidebar-hover-zone');
            const sidebar = document.querySelector('.sidebar');
            let hideTO = null;

            const show = () => {
              clearTimeout(hideTO);
              if (document.body) document.body.classList.add('show-sidebar');
            };
            const scheduleHide = () => {
              clearTimeout(hideTO);
              hideTO = setTimeout(() => {
                if (document.body) document.body.classList.remove('show-sidebar');
              }, 200); // pequeño delay para evitar parpadeos
            };

            zone?.addEventListener('mouseenter', show);
            zone?.addEventListener('mouseleave', scheduleHide);
            sidebar?.addEventListener('mouseenter', show);
            sidebar?.addEventListener('mouseleave', scheduleHide);
          } catch (e) {
            console.warn('initSidebarAutoHide error', e);
          }
        };
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', doInit);
        } else {
          doInit();
        }
      })();
    </script>
    <script>
      function maskPin(v){
        const s = String(v || '');
        return s ? 'â€¢'.repeat(Math.min(4, s.length)) : '';
      }
      function serviciosResumen(l){
        const arr = Array.isArray(l.telefonos) ? l.telefonos : [];
        if (arr.length) {
          const m = new Map();
          arr.forEach(t => {
            const k = (t?.servicio || t?.tipo || '').toString().trim() || 'SERVICIO';
            m.set(k, (m.get(k) || 0) + 1);
          });
          return [...m.entries()]
            .map(([k, v]) => (v > 1 ? `${k} x${v}` : k))
            .join('; ');
        }
        return l.servicios_texto || l.tipo_servicios || l.servicios || l.producto || '';
      }
    // normDate ahora se carga desde js/date-formatter.js
    function teamHeader(){ return ['NOMBRE CLIENTE','TELÉFONO PRINCIPAL','NÚMERO DE CUENTA','AUTOPAGO','PIN DE SEGURIDAD','DIRECCIÃ“N','DÃA DE VENTA','DÃA DE INSTALACIÃ“N','STATUS','CANTIDAD DE LÃNEAS','TELÉFONOS DE LAS LÃNEAS','ID','SUPERVISOR','MERCADO']; }
    // NormalizaciónÃ³n de nombres de agente (alias -> canónico)
    function __normStrAgent(s){
      try {
        return String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().replace(/\s+/g,'').replace(/\./g,'');
      } catch { return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/\./g,''); }
    }
    function agentCanonicalName(name){
      const n = __normStrAgent(name);
      const map = {
        'eduardor': 'Eduardo Rivas',
        'eduardorivas': 'Eduardo Rivas',
        'eduardorrivas': 'Eduardo Rivas',
        'alexanderhernandez': 'Riquelmi Torres',
        'julioMejia': 'Julio Chavez',
        'juliomejia': 'Julio Chavez'
      };
      return map[n] || (name || '');
    }
    function agentName(l){
      const raw = l.agenteNombre||l.nombreAgente||l.agente||l.agent||l.ownerName||l.vendedor||l.seller||'';
      return agentCanonicalName(raw);
    }
    function applyHeader(){ const thead=document.querySelector('.costumer-table thead'); if(!thead) return; const hs=teamHeader(); thead.innerHTML=`<tr>${hs.map(h=>`<th>${h}</th>`).join('')}</tr>`; }
    // Efficient renderer: uses batched rendering with DocumentFragment to avoid
    // repeated reflows when inserting many rows. Renders in micro-batches so
    // the main thread is not blocked for long periods.
    function renderRows(list){
      const tbody = document.getElementById('costumer-tbody'); if(!tbody) { console.error('[renderRows] tbody no encontrado'); return; }
      console.log('[renderRows] Renderizando', Array.isArray(list) ? list.length : 0, 'items');
      // Clear existing rows quickly
      tbody.innerHTML = '';

      const rows = Array.isArray(list) ? list : (Array.isArray(list?.leads) ? list.leads : []);
      console.log('[renderRows] rows después de extracción:', rows.length);
      if (rows.length === 0) { console.warn('[renderRows] No hay filas para renderizar'); return; }

      const batchSize = 200; // tuneable: number of rows rendered per tick
      let idx = 0;

      function makeTrFromLead(l) {
        const autop = (l.autopay ?? l.autopago);
        const autopTxt = typeof autop === 'boolean' ? (autop ? 'Sí' : 'No') : (String(autop || '').toUpperCase() === 'SI' ? 'Sí' : (String(autop || '').toUpperCase() === 'NO' ? 'No' : String(autop || '')));
        const cant = (l.cantidad_lineas != null) ? l.cantidad_lineas : (Array.isArray(l.telefonos) ? l.telefonos.length : '');
        const statusRaw = (l.status || '').toString();
        const statusNorm = statusRaw.trim().toLowerCase();
        const idVal = (l.id_cliente || l._id || l.id || '');

        const values = [
          l.nombre_cliente || '',
          l.telefono_principal || '',
          l.numero_cuenta || '',
          autopTxt || '',
          maskPin(l.pin_seguridad) || '',
          l.direccion || '',
          normDate(l.dia_venta || l.fecha_contratacion || l.fecha || ''),
          normDate(l.dia_instalacion || ''),
          statusRaw.toUpperCase(),
          cant || '',
          serviciosResumen(l) || '',
          idVal,
          l.supervisor || '',
          l.mercado || ''
        ];

        const tr = document.createElement('tr');
        if (idVal) tr.setAttribute('data-lead-id', String(idVal));
        if (statusNorm) {
          let cls = 'row-status-';
          if (/cancel/.test(statusNorm)) cls += 'canceled';
          else if (/hold/.test(statusNorm)) cls += 'hold';
          else if (/repro|resched/.test(statusNorm)) cls += 'rescheduled';
          else if (/complete|active/.test(statusNorm)) cls += 'complete';
          else cls += 'pending';
          tr.classList.add(cls);
        }

        // Create TDs with textContent (safer and faster than innerHTML parsing)
        for (let i = 0; i < values.length; i++) {
          const td = document.createElement('td');
          const v = values[i];
          try { td.textContent = (v == null ? '' : v); } catch { td.textContent = '' + (v || ''); }
          tr.appendChild(td);
        }

        // store status normalized for CSS and later coloring
        try {
          const tdStatus = tr.querySelector('td.status-col') || (tr.querySelector('select.status-select') ? tr.querySelector('select.status-select').closest('td') : null) || tr.children[8];
          if (tdStatus) tdStatus.dataset.status = statusNorm;
        } catch {}
        return tr;
      }

      function renderBatch() {
        const fragment = document.createDocumentFragment();
        const end = Math.min(idx + batchSize, rows.length);
        for (; idx < end; idx++) {
          try { fragment.appendChild(makeTrFromLead(rows[idx])); } catch (e) { /* ignore single-row errors */ }
        }
        tbody.appendChild(fragment);

        if (idx < rows.length) {
          // yield to the event loop to keep UI responsive
          setTimeout(renderBatch, 0);
        } else {
          // finalization: ensure row IDs and coloring applied
          try {
            ensureRowIds();
            syncStatusDatasets();
            applyRowStatusColors();
            if (typeof window.rebuildStickyHead === 'function') window.rebuildStickyHead();
          } catch (e) { /* ignore */ }
          try {
            document.dispatchEvent(new CustomEvent('leads:rendered', { detail: { count: rows.length } }));
          } catch (e) { /* ignore */ }
        }
      }

      // Start rendering asynchronously
      renderBatch();
    }
    // Guardar referencia al renderizador anterior
    const originalRenderer = window.renderCostumerTable;
    
    // Sobrescribir con nuestro renderizador Team LÃ­neas
    // Aplicador global para el renderizado no-Team: colorea filas segÃºn texto del status en la col 9
    function ensureRowIds(){
      try{
        const tbody=document.getElementById('costumer-tbody'); if(!tbody) return;
        const rows=[...tbody.querySelectorAll('tr')].filter(tr=>!tr.classList.contains('costumer-month-separator'));
        rows.forEach(tr=>{
          if (tr.hasAttribute('data-lead-id')) return;
          // Intentar obtener ID desde el botÃ³n Editar
          const btn = tr.querySelector('button[onclick^="editarLead("]');
          if (btn){
            const m = btn.getAttribute('onclick')?.match(/editarLead\('([^']+)'\)/);
            if (m && m[1]) { tr.setAttribute('data-lead-id', m[1]); return; }
          }
          // Intentar obtener ID desde el select de status (onchange="updateLeadStatus('ID', this.value)")
          const sel = tr.querySelector('select.status-select[onchange]');
          if (sel){
            const oc = sel.getAttribute('onchange')||'';
            const m2 = oc.match(/updateLeadStatus\('([^']+)'/);
            if (m2 && m2[1]) { tr.setAttribute('data-lead-id', m2[1]); return; }
          }
        });
      }catch{}
    }

    window.syncStatusDatasets = function(){
      try{
        const tbody=document.getElementById('costumer-tbody'); if(!tbody) return;
        ensureRowIds();
        const rows=[...tbody.querySelectorAll('tr')]
          .filter(tr=>!tr.classList.contains('costumer-month-separator'));

        // Construir mapa id->status desde memoria si existe
        let map = null;
        try{
          const list = Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : [];
          if (list.length && typeof getLeadId==='function') {
            map = new Map(list.map(l=>[ String(getLeadId(l)), String(l?.status||'').trim().toLowerCase() ]));
          }
        }catch{}
        rows.forEach(tr=>{
          const td = tr.querySelector('td.status-col') || (tr.querySelector('select.status-select') ? tr.querySelector('select.status-select').closest('td') : null) || tr.children[8];
          if (!td) return;
          const id = tr.getAttribute('data-lead-id') || '';
          // 0) status desde memoria por id
          let val = '';
          if (map && id && map.has(String(id))) val = map.get(String(id));

          // 1) select interno
          if (!val) {
            const sel = td.querySelector('select');
            if (sel && sel.value) val = String(sel.value).trim().toLowerCase();
          }
          // 2) badge con data-value
          if (!val) {
            const badge = td.querySelector('[data-value], .badge, .badge-status, .status-badge');
            if (badge && badge.getAttribute) {
              const dv = String(badge.getAttribute('data-value')||'').trim().toLowerCase();
              if (dv) val = dv;
            }
          }
          // 3) clases comunes en badges
          if (!val) {
            const b = td.querySelector('.badge, .badge-status, .status-badge');
            const cls = b ? (' '+b.className+' ') : (' '+td.className+' ');
            if (/cancel/.test(cls)) val = 'cancelled';
            else if (/hold/.test(cls)) val = 'hold';
            else if (/resched|repro/.test(cls)) val = 'rescheduled';
            else if (/active/.test(cls)) val = 'active';
            else if (/complete/.test(cls)) val = 'completed';
            else if (/pend/i.test(cls)) val = 'pending';
          }

          // 4) texto visible de la celda
          if (!val) {
            const txt = (td.textContent||'').trim().toLowerCase();
            if (txt) val = txt;
          }
          if (val) td.dataset.status = val;
        });
      }catch{}
    }

    window.applyRowStatusColors = function(){
      try{
        const tbody=document.getElementById('costumer-tbody'); if(!tbody) return;
        ensureRowIds();
        const rows=[...tbody.querySelectorAll('tr')]
          .filter(tr=>!tr.classList.contains('costumer-month-separator'));

        rcLog('applyRowStatusColors start', {rows: rows.length});
        // asegurar que cada celda STATUS tenga data-status actualizado antes de colorear
        syncStatusDatasets();
        rows.forEach(tr=>{
          const td = tr.querySelector('td.status-col') || (tr.querySelector('select.status-select') ? tr.querySelector('select.status-select').closest('td') : null) || tr.children[8];
          let txt='';
          if (td){
            // Priorizar select interno si existe
            const sel = td.querySelector('select');
            const ds = (td.dataset && td.dataset.status) ? String(td.dataset.status).trim().toLowerCase() : '';

            if (ds) txt = ds;
            else if (sel && sel.value) txt = String(sel.value).trim().toLowerCase();
            else txt = (td.textContent||'').trim().toLowerCase();
          }
          tr.classList.remove('row-status-pending','row-status-hold','row-status-rescheduled','row-status-canceled','row-status-cancelled','row-status-complete','row-status-active');
          let cls='row-status-';
          if(/cancel/.test(txt)) cls+='canceled';
          else if(/hold/.test(txt)) cls+='hold';
          else if(/repro|resched/.test(txt)) cls+='rescheduled';
          else if(/complete|active/.test(txt)) cls+='complete';
          else cls+='pending';
          tr.classList.add(cls);
          // Inline color para persistencia visual
          const color = statusToColor(txt);
          const tds = tr ? Array.from(tr.children) : [];
          try{ tr.dataset.rowStatus = cls.replace('row-status-',''); }catch{}
          try{ tr.style.setProperty('background', 'none', 'important'); }catch{}
          try{ tr.style.setProperty('background-color', color, 'important'); }catch{}
          tds.forEach(td=>{ try{ td.style.setProperty('background', 'none', 'important'); }catch{} });
          tds.forEach(td=>{ try{ td.style.setProperty('background-color', color, 'important'); }catch{} });
          if (rcEnabled()) {
            const id = tr?.getAttribute('data-lead-id') || '(sin-id)';
            rcLog('row colored', {id, txt, cls, color, rowStatus: tr?.dataset?.rowStatus});
          }
        });
        rcLog('applyRowStatusColors end');
      }catch(e){ /* noop */ }
    };

    window.__suspendRender = false; // habilitado por defecto para que funcione el filtro
    window.__suspendRenderTO = null;
    window.disableGlobalRender = function(){
      try{ window.__suspendRender = true; console.log('[Render] Global render DESHABILITADO'); }catch{}
    };
    window.enableGlobalRender = function(){
      try{ window.__suspendRender = false; console.log('[Render] Global render HABILITADO'); }catch{}
    };

    // Monkey-patch robusto: impedir re-renders incluso si otro script reasigna la funciÃ³n
    (function(){
      try {
        let _renderFn = typeof originalRenderer==='function' ? originalRenderer.bind(window) : (typeof window.renderCostumerTable==='function' ? window.renderCostumerTable.bind(window) : null);
        Object.defineProperty(window, 'renderCostumerTable', {
          configurable: true,
          enumerable: true,
          get: function() {
            return function(leads) {
              try {
                if (window.__suspendRender) {
                  if (!window.__initialPaintDone) {
                    try {
                      const arr = Array.isArray(leads) ? leads : (Array.isArray(leads?.leads) ? leads.leads : []);
                      const tbody = document.getElementById('costumer-tbody');
                      if (tbody) tbody.innerHTML = '';
                      if (typeof _renderFn === 'function') _renderFn(arr);
                      else if (typeof renderWithMonthlySeparators === 'function') renderWithMonthlySeparators(arr);
                      window.__initialPaintDone = true;
                    } catch (e) { console.warn('[Render] fallo en pintado inicial', e); }
                  }
                  return;
                }

                let arr = Array.isArray(leads) ? leads : (Array.isArray(leads?.leads) ? leads.leads : []);
                window.ultimaListaLeadsFull = [...arr];

                const currentUser = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
                const userRole = (currentUser.role || currentUser?.usuario?.role || '').toString().trim().toLowerCase();

                if (userRole.includes('supervisor')) {
                  // Para supervisor, el backend (/api/leads) ya filtra por sus agentes.
                  // Evitar re-filtrar en frontend por nombre de supervisor, porque en costumers_unified
                  // lead.team/lead.supervisor suele ser el nombre corto del team (ej. "JOHANA").
                }

                window.ultimaListaLeads = arr;

                if (typeof _renderFn === 'function') {
                  _renderFn(arr);
                } else {
                  renderRows(arr);
                }

                setTimeout(() => {
                  try {
                    syncStatusDatasets();
                    window.applyRowStatusColors();
                    document.dispatchEvent(new CustomEvent('leads:rendered', { detail: { count: arr.length } }));
                  } catch(e) {}
                }, 150);

              } catch (e) {
                console.warn('[Render wrapper] error', e);
              }
            };
          },
          set: function(fn) {
            try {
              _renderFn = (typeof fn === 'function') ? fn.bind(window) : null;
            } catch (e) { console.warn('[Render] setter error', e); }
          }
        });
      } catch(e) { 
        console.error('Monkey-patch renderCostumerTable error', e); 
      }
    })();

    // Helpers globales para colorear filas por STATUS inmediatamente
    (function(){
      // Logger controlado por bandera: activar con localStorage.setItem('rowColorDebug','1')
      function rcEnabled(){ try{ return localStorage.getItem('rowColorDebug')==='1' || window.__ROW_COLOR_DEBUG===true; }catch{ return false; } }
      function rcLog(){ try{ if (rcEnabled()) console.log('[RowColor]', ...arguments); }catch{} }
      function statusToClass(val){
        try{
          const t=String(val||'').trim().toLowerCase();
          if((/active|activo/.test(t)) && /oficina/.test(t)) return 'row-status-active-oficina';
          if(/cancel/.test(t)) return 'row-status-canceled';
          if(/hold/.test(t)) return 'row-status-hold';
          if(/repro|resched/.test(t)) return 'row-status-rescheduled';
          if(/complete|active/.test(t)) return 'row-status-complete';
          return 'row-status-pending';
        }catch{ return 'row-status-pending'; }
      }
      function statusToColor(val){
        try{
          const t=String(val||'').trim().toLowerCase();
          const isDarkTheme = document.body.classList.contains('dark-theme');
          
          if (isDarkTheme) {
            // Colores para tema oscuro
            if((/active|activo/.test(t)) && /oficina/.test(t)) return '#0b2a4a';
            if(/cancel/.test(t)) return '#5b2121';
            if(/hold/.test(t)) return '#5a3a1a';
            if(/repro|resched/.test(t)) return '#4c1d95';
            if(/complete|active/.test(t)) return '#164e3b';
            return '#2c3a51'; // pending color for dark theme
          } else {
            // Colores para tema claro (originales)
            if((/active|activo/.test(t)) && /oficina/.test(t)) return '#eff6ff';
            if(/cancel/.test(t)) return '#ffe7e7';
            if(/hold/.test(t)) return '#fff8db';
            if(/repro|resched/.test(t)) return '#f2e9ff';
            if(/complete|active/.test(t)) return '#e9f9ee';
            return '#f8fafc';
          }
        }catch{ 
          const isDarkTheme = document.body.classList.contains('dark-theme');
          return isDarkTheme ? '#2c3a51' : '#f8fafc'; 
        }
      }
      function applyRowClass(tr, statusVal){
        try{
          const cls=statusToClass(statusVal);
          const id = tr?.getAttribute('data-lead-id') || '(sin-id)';
          rcLog('applyRowClass ->', {id, statusVal, cls});
          tr.classList.remove('row-status-pending','row-status-hold','row-status-rescheduled','row-status-canceled','row-status-cancelled','row-status-complete','row-status-active','row-status-active-oficina');
          tr.classList.add(cls);
          // Aplicar color inline para vencer cualquier re-pintado externo
          const color = statusToColor(statusVal);
          const tds = tr ? Array.from(tr.children) : [];
          try{ tr.dataset.rowStatus = cls.replace('row-status-',''); }catch {}
          try{ tr.style.setProperty('background', 'none', 'important'); }catch {}
          try{ tr.style.setProperty('background-color', color, 'important'); }catch {}
          tds.forEach(td=>{ try{ td.style.setProperty('background', 'none', 'important'); }catch {} });
          tds.forEach(td=>{ try{ td.style.setProperty('background-color', color, 'important'); }catch {} });
          rcLog('inline color aplicado', {id, color, rowStatus: tr?.dataset?.rowStatus});
        }catch {}
      }
      // Re-aplicar colores cuando cambie el DOM de la tabla (con guardas anti bucle)
      let _statusObserver = null;
      let _statusDebounceTO = null;
      let _statusPainting = false;
      function debouncedApply(){
        clearTimeout(_statusDebounceTO);
        _statusDebounceTO = setTimeout(()=>{ try{ _statusPainting = true; rcLog('debouncedApply run'); window.applyRowStatusColors && window.applyRowStatusColors(); }finally{ _statusPainting = false; } }, 60);
      }
      function installStatusObserver(){
        try{
          const tbody = document.getElementById('costumer-tbody');
          if (!tbody){
            // reintentar pronto si aÃºn no existe
            setTimeout(installStatusObserver, 200);
            return;
          }
          if (_statusObserver) { try{ _statusObserver.disconnect(); }catch {} _statusObserver = null; }
          _statusObserver = new MutationObserver((muts)=>{
            if (_statusPainting) return; // ignorar mutaciones causadas por nuestro repintado
            // Solo re-aplicar una vez tras lote de cambios
            rcLog('observer batch', {mutations: muts?.length||0});
            debouncedApply();
          });
          try { window._statusObserver = _statusObserver; } catch(_) {}
          // Observar solo cambios estructurales para evitar bucles por cambios de estilo
          _statusObserver.observe(tbody, { childList: true, subtree: true });
          // aplicar una vez al instalar
          rcLog('observer installed');
          debouncedApply();
        }catch {}
      }

      // Función para forzar recoloreo completo (Ãºtil despuÃ©s de cambios de tema)
      window.forceRecolorAllRows = function() {
        try {
          const tbody = document.getElementById('costumer-tbody');
          if (!tbody) return;
          
          const rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => 
            !tr.classList.contains('costumer-month-separator')
          );
          
          rcLog('forceRecolorAllRows: processing', rows.length, 'rows');
          
          rows.forEach(tr => {
            const statusTd = tr.querySelector('td.status-col') || (tr.querySelector('select.status-select') ? tr.querySelector('select.status-select').closest('td') : null) || tr.children[8];
            if (!statusTd) return;
            
            let statusValue = '';
            
            // Obtener valor del status desde diferentes fuentes
            const select = statusTd.querySelector('select');
            if (select && select.value) {
              statusValue = select.value;
            } else if (statusTd.dataset.status) {
              statusValue = statusTd.dataset.status;
            } else {
              statusValue = (statusTd.textContent || '').trim();
            }
            
            if (statusValue) {
              _statusPainting = true;
              try {
                applyRowClass(tr, statusValue);
              } finally {
                _statusPainting = false;
              }
            }
          });
          
          rcLog('forceRecolorAllRows: completed');
        } catch (e) {
          console.warn('forceRecolorAllRows error:', e);
        }
      };

      // Exponer para uso externo si se requiere
      window._statusRowHelpers = { statusToClass, applyRowClass, installStatusObserver, forceRecolorAllRows: window.forceRecolorAllRows };

      // Delegado: cuando cambie un select de STATUS dentro de la tabla, aplicar color inmediato
      document.addEventListener('change', function(ev){
        try{
          const el = ev.target;
          if (!el || el.tagName !== 'SELECT') return;
          const name = (el.name||'').toLowerCase();
          const id = (el.id||'').toLowerCase();
          const isStatus = el.classList.contains('status-select') || name.includes('status') || id.includes('status');
          if (!isStatus) return;
          const tr = el.closest('tr');
          if (!tr) return;
          // Guardar el valor en la celda como dataset para persistencia
          const td = tr.querySelector('td.status-col') || el.closest('td') || tr.children[8];
          if (td) { try { td.dataset.status = String(el.value||''); } catch {} }
          rcLog('change(status) ->', {value: el.value, rowId: tr?.getAttribute('data-lead-id')});

          // Suspender re-render global temporalmente para evitar que destruya el color/estado
          try{
            window.__suspendRender = true;
            if (window.__suspendRenderTO) { try{ clearTimeout(window.__suspendRenderTO); }catch {} }
            window.__suspendRenderTO = setTimeout(()=>{
              window.__suspendRender = false;
              try { if (typeof syncStatusDatasets==='function') syncStatusDatasets(); } catch {}
              try { if (typeof window.applyRowStatusColors==='function') window.applyRowStatusColors(); } catch {}
            }, 800);
          }catch {}

          _statusPainting = true;
          try{ applyRowClass(tr, el.value); } finally { _statusPainting = false; }
          // asegurar persistencia incluso si otra lÃ³gica re-renderiza luego
          debouncedApply();
          // keep-alive: durante 3s re-aplicar por si otro cÃ³digo repinta
          let count=0; const iv = setInterval(()=>{ try{
            if (++count>4) { clearInterval(iv); return; }
            if (td && td.dataset && td.dataset.status) {
              _statusPainting = true; try{ applyRowClass(tr, td.dataset.status); } finally { _statusPainting = false; }
            } else {
              _statusPainting = true; try{ applyRowClass(tr, el.value); } finally { _statusPainting = false; }
            }
          }catch {} }, 500);
        }catch(e){
          console.error('Error en evento change:', e);
        }
      }, true);

      // Instalar observer cuando el DOM estÃ© listo
      function startKeepAliveInitial(){
        try{
          let n=0; const iv=setInterval(()=>{ try{
            window.applyRowStatusColors && window.applyRowStatusColors();
            if (++n>6) clearInterval(iv);
          }catch{ clearInterval(iv); } }, 500);
        }catch(e){
          console.error('Error en startKeepAliveInitial:', e);
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ()=>{ 
          try{
            rcLog('DOMContentLoaded'); 
            installStatusObserver(); 
            startKeepAliveInitial();
          }catch(e){
            console.error('Error en evento DOMContentLoaded:', e);
          }
        });
      } else {
        try{
          rcLog('init immediate');
          installStatusObserver();
          startKeepAliveInitial();
        }catch(e){
          console.error('Error en init immediate:', e);
        }
      }

      // Observer para cambios de tema - recolorear filas cuando cambie el tema
      try {
        const themeObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              const target = mutation.target;
              if (target === document.body || target === document.documentElement) {
                // El tema cambiÃ³, recolorear todas las filas
                rcLog('Theme change detected, recoloring rows');
                setTimeout(() => {
                  try {
                    // Usar la funciÃ³n especÃ­fica para recoloreo completo
                    if (typeof window.forceRecolorAllRows === 'function') {
                      window.forceRecolorAllRows();
                    } else if (typeof window.applyRowStatusColors === 'function') {
                      window.applyRowStatusColors();
                    }
                  } catch (e) {
                    console.error('Error recoloring rows on theme change:', e);
                  }
                }, 50);
              }
            }
          });
        });

        const startThemeObserve = () => {
          try {
            const targets = [document.documentElement, document.body].filter(n => n && n.nodeType === 1);
            if (!targets.length) return;
            targets.forEach(t => {
              try { themeObserver.observe(t, { attributes: true, attributeFilter: ['class'] }); } catch (_) {}
            });
          } catch (e) {
            console.error('Theme observer setup failed:', e);
          }
        };

        if (document.documentElement || document.body) {
          startThemeObserve();
        } else {
          document.addEventListener('DOMContentLoaded', startThemeObserve, { once: true });
        }
      } catch (e) {
        console.error('Theme observer setup failed:', e);
      }

      // Función de debug para verificar colores
      window.debugThemeColors = function() {
        try {
          console.log('=== DEBUG THEME COLORS ===');
          const darkActive = (document.body && typeof document.body.classList !== 'undefined') ? document.body.classList.contains('dark-theme') : false;
          console.log('Dark theme active:', darkActive);
          console.log('statusToColor test (pending):', statusToColor('pending'));
          console.log('statusToColor test (completed):', statusToColor('completed'));
          console.log('statusToColor test (canceled):', statusToColor('canceled'));
          
          const tbody = document.getElementById('costumer-tbody');
          if (tbody) {
            const rows = tbody.querySelectorAll('tr');
            console.log('Total rows found:', rows.length);
            
            Array.from(rows).slice(0, 3).forEach((row, i) => {
              const statusTd = row.children[8];
              if (statusTd) {
                console.log(`Row ${i}:`, {
                  status: statusTd.textContent?.trim(),
                  backgroundColor: row.style.backgroundColor,
                  classes: Array.from(row.classList)
                });
              }
            });
          }
          console.log('=== END DEBUG ===');
        } catch (e) {
          console.error('debugThemeColors error:', e);
        }
      };

      // Auto-ejecutar debug despuÃ©s de cargar
      setTimeout(() => {
        if (window.debugThemeColors) {
          window.debugThemeColors();
        }
      }, 2000);

      // Debug para verificar elemento activo del sidebar
      setTimeout(() => {
        try {
          const sidebar = document.querySelector('.sidebar');
          const activeAttr = sidebar ? sidebar.getAttribute('data-active') : null;
          const activeElements = document.querySelectorAll('.sidebar .btn-sidebar.is-active, .sidebar a.active');
          
          console.log(' [SIDEBAR DEBUG] data-active:', activeAttr);
          console.log(' [SIDEBAR DEBUG] Elementos activos encontrados:', activeElements.length);
          
          activeElements.forEach((el, i) => {
            console.log(` [SIDEBAR DEBUG] Elemento activo ${i}:`, {
              text: el.textContent?.trim(),
              classes: Array.from(el.classList),
              styles: {
                background: el.style.backgroundColor || getComputedStyle(el).backgroundColor,
                color: el.style.color || getComputedStyle(el).color
              }
            });
          });
          
          if (activeElements.length === 0) {
            console.warn('âš ï¸ [SIDEBAR DEBUG] No se encontraron elementos activos. Verificar data-active y sidebar-loader.js');
          }
        } catch (e) {
          console.error('[SIDEBAR DEBUG] Error:', e);
        }
      }, 3000);

      // Función para forzar normalizaciÃ³n de multimedia
      window.normalizeMultimediaElement = function() {
        try {
          const multimediaElements = document.querySelectorAll(
            '.sidebar a[href*="multimedia"], .sidebar .btn-sidebar[href*="multimedia"]'
          );
          
          console.log('ðŸŽ¬ [MULTIMEDIA DEBUG] Elementos multimedia encontrados:', multimediaElements.length);
          
          multimediaElements.forEach((element, i) => {
            console.log(`ðŸŽ¬ [MULTIMEDIA DEBUG] Normalizando elemento ${i}:`, element);
            
            // Remover cualquier estilo inline que pueda estar causando diferencias
            element.style.cssText = '';
            
            // Normalizar el Ã­cono
            const icon = element.querySelector('i');
            if (icon) {
              icon.style.cssText = '';
              icon.style.setProperty('font-weight', '900', 'important');
              icon.style.setProperty('font-size', '1.1rem', 'important');
              icon.style.setProperty('color', 'inherit', 'important');
              icon.style.setProperty('text-shadow', 'none', 'important');
              icon.style.setProperty('opacity', '1', 'important');
              icon.style.setProperty('background', 'none', 'important');
              icon.style.setProperty('border', 'none', 'important');
              icon.style.setProperty('box-shadow', 'none', 'important');
              icon.style.setProperty('filter', 'none', 'important');
              
              console.log(`ðŸŽ¬ [MULTIMEDIA DEBUG] Ãcono ${i} normalizado:`, {
                fontWeight: icon.style.fontWeight,
                fontSize: icon.style.fontSize,
                color: icon.style.color
              });
            }
          });
        } catch (e) {
          console.error('[MULTIMEDIA DEBUG] Error:', e);
        }
      };

      // Ejecutar normalizaciÃ³n despuÃ©s de que se cargue el sidebar
      setTimeout(() => {
        if (window.normalizeMultimediaElement) {
          window.normalizeMultimediaElement();
        }
      }, 4000);

      // Re-ejecutar normalizaciÃ³n cada vez que se recargue el sidebar
      const sidebarObserver = new MutationObserver(() => {
        setTimeout(() => {
          if (window.normalizeMultimediaElement) {
            window.normalizeMultimediaElement();
          }
        }, 100);
      });

      // Observar cambios en el sidebar
      setTimeout(() => {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
          sidebarObserver.observe(sidebar, {
            childList: true,
            subtree: true
          });
        }
      }, 1000);
    })();
  </script>
  <script>
    (function(){
      try {
        const blockMs = 12000; // ventana de protecciÃ³n ampliada
        const isInicio = (u) => {
          try {
            const s = (u||'').toString().toLowerCase();
            return s.includes('/inicio.html') || s.endsWith('inicio.html');
          } catch { return false; }
        };
        const origAssign = window.location.assign ? window.location.assign.bind(window.location) : null;
        const origReplace = window.location.replace ? window.location.replace.bind(window.location) : null;
        const origHrefDesc = Object.getOwnPropertyDescriptor(Location.prototype, 'href');
        if (origAssign) window.location.assign = function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirecciÃ³n a inicio'); return; } return origAssign(u); };
        if (origReplace) window.location.replace = function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirecciÃ³n a inicio'); return; } return origReplace(u); };
        if (origHrefDesc && origHrefDesc.set) {
          Object.defineProperty(window.location, 'href', {
            configurable: true,
            get: origHrefDesc.get ? origHrefDesc.get.bind(window.location) : function(){ return document.URL; },
            set: function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirecciÃ³n a inicio (href)'); return; } return origHrefDesc.set.call(window.location, u); }
          });
        }
        // Interceptar document.location y parent/top
        try { Object.defineProperty(document, 'location', { configurable: true, get: () => window.location, set: v => { if (!isInicio(v)) window.location.href = v; else console.warn('[Costumer] Bloqueada redirecciÃ³n via document.location'); } }); } catch {}
        try { if (window.top && window.top.location) { const t = window.top.location; const oa = t.assign?.bind(t); if (oa) t.assign = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] top.assign bloqueado'); oa(u); }; const orp = t.replace?.bind(t); if (orp) t.replace = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] top.replace bloqueado'); orp(u); }; } } catch {}
        try { if (window.parent && window.parent.location) { const p = window.parent.location; const pa = p.assign?.bind(p); if (pa) p.assign = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] parent.assign bloqueado'); pa(u); }; const pr = p.replace?.bind(p); if (pr) p.replace = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] parent.replace bloqueado'); pr(u); }; } } catch {}
        // Interceptar history
        try {
          const hps = history.pushState.bind(history);
          history.pushState = function(state, title, url){ if (isInicio(url)) { console.warn('[Costumer] pushState a inicio bloqueado'); return; } return hps(state, title, url); };
          const hrs = history.replaceState.bind(history);
          history.replaceState = function(state, title, url){ if (isInicio(url)) { console.warn('[Costumer] replaceState a inicio bloqueado'); return; } return hrs(state, title, url); };
        } catch {}
        // Eliminar meta refresh a inicio si existiera
        try { document.querySelectorAll('meta[http-equiv="refresh"]').forEach(m=>{ const c=(m.getAttribute('content')||'').toLowerCase(); if (c.includes('inicio.html')) { m.parentNode.removeChild(m); console.warn('[Costumer] meta refresh eliminado'); } }); } catch{}
        setTimeout(function(){
          try { if (origAssign) window.location.assign = origAssign; } catch{}
          try { if (origReplace) window.location.replace = origReplace; } catch{}
          try { if (origHrefDesc) Object.defineProperty(window.location, 'href', origHrefDesc); } catch{}
        }, blockMs);
      } catch(e){ console.warn('[Costumer] Guard no pudo instalarse:', e); }
    })();
  </script>
  <!-- ProtecciÃ³n de autenticaciÃ³n en frontend -->

  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="js/sidebar-loader.js"></script>
  
  <!-- Script inmediato para normalizar multimedia -->
  <script>
    // Función global para normalizar multimedia
    window.forceNormalizeMultimedia = function() {
      console.log('ðŸŽ¬ [IMMEDIATE] Ejecutando normalizaciÃ³n inmediata de multimedia...');
      
      const multimediaElements = document.querySelectorAll(
        '.sidebar a[href*="multimedia"], .sidebar .btn-sidebar[href*="multimedia"], a[title*="Multimedia"]'
      );
      
      console.log('ðŸŽ¬ [IMMEDIATE] Elementos multimedia encontrados:', multimediaElements.length);
      
      if (multimediaElements.length === 0) {
        // Intentar con selectores mÃ¡s amplios
        const allSidebarLinks = document.querySelectorAll('.sidebar a, .sidebar .btn-sidebar');
        console.log('ðŸŽ¬ [IMMEDIATE] Total elementos sidebar:', allSidebarLinks.length);
        
        allSidebarLinks.forEach((el, i) => {
          const text = el.textContent?.trim().toLowerCase();
          const href = el.href || '';
          if (text.includes('multimedia') || href.includes('multimedia')) {
            console.log(`ðŸŽ¬ [IMMEDIATE] Encontrado multimedia por texto/href ${i}:`, el);
            window.normalizeElement(el);
          }
        });
      } else {
        multimediaElements.forEach((el, i) => {
          console.log(`ðŸŽ¬ [IMMEDIATE] Normalizando elemento ${i}:`, el);
          window.normalizeElement(el);
        });
      }
    };
    
    window.normalizeElement = function(element) {
      // Remover estilos inline
      element.style.cssText = '';
      
      // Normalizar el Ã­cono
      const icon = element.querySelector('i');
      if (icon) {
        icon.style.cssText = '';
        icon.style.setProperty('font-weight', '900', 'important');
        icon.style.setProperty('font-size', '1.1rem', 'important');
        icon.style.setProperty('color', 'inherit', 'important');
        icon.style.setProperty('text-shadow', 'none', 'important');
        icon.style.setProperty('opacity', '1', 'important');
        icon.style.setProperty('background', 'none', 'important');
        icon.style.setProperty('border', 'none', 'important');
        icon.style.setProperty('box-shadow', 'none', 'important');
        icon.style.setProperty('filter', 'none', 'important');
        
        console.log('ðŸŽ¬ [IMMEDIATE] Ãcono normalizado:', {
          element: icon,
          fontWeight: icon.style.fontWeight,
          fontSize: icon.style.fontSize
        });
      }
    };
    
    // Ejecutar inmediatamente y luego cada segundo hasta que funcione
    let attempts = 0;
    const maxAttempts = 10;
    
    const intervalId = setInterval(() => {
      attempts++;
      console.log(`ðŸŽ¬ [IMMEDIATE] Intento ${attempts}/${maxAttempts}`);
      
      window.forceNormalizeMultimedia();
      
      if (attempts >= maxAttempts) {
        clearInterval(intervalId);
        console.log('ðŸŽ¬ [IMMEDIATE] MÃ¡ximo de intentos alcanzado');
      }
    }, 1000);
    
    // TambiÃ©n ejecutar cuando se dispare el evento de sidebar cargado
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(window.forceNormalizeMultimedia, 2000);
      setTimeout(window.forceNormalizeMultimedia, 5000);
    });
  </script>
  <!-- <script src="js/monthly-cutoff.js"></script> -->
  <!-- Date Formatter - DEBE CARGARSE ANTES DE TEAMS.JS -->
  <!-- <script src="js/date-formatter.js?v=20251024"></script> -->
  <!-- Teams API: definiciÃ³n de equipos, supervisores y agentes -->
  <script src="utils/teams.js?v=20251024b"></script>
  <style>
    /* Estilos del sidebar unificados en css/sidebar-shared.css */
    /* Nota: Estilos del bloque de usuario del sidebar se definen en css/sidebar-inicio.css
       (clases: .sidebar.sidebar-inicio .user-info, .avatar, .user-name, .user-role). */

    /* Estilos generales */
    :root {
      --primary: #1976d2;
      --primary-dark: #1565c0;
      --accent: #ff9800;
      --text: #333;
      --text-light: #666;
      --border: #e0e0e0;
      --background: #f5f7fa;
      --card-bg: #ffffff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Ocultar scrollbar vertical principal por defecto y mostrar solo al pasar por la barra lateral */
    body.hide-main-scroll { overflow-y: hidden; }
    body.hide-main-scroll::-webkit-scrollbar { width: 0; height: 0; }
    body.show-main-scroll { overflow-y: auto; }

    .container {
      display: flex;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      position: relative;
      top: 0;
    }

    /* ===== AUTO-HIDE SIDEBAR ===== */
    :root { --sidebar-width: 240px; --sidebar-peek: 12px; }
    .sidebar {
      transition: transform 0.25s ease-in-out;
      will-change: transform;
      z-index: 100;
    }
    /* Estado colapsado por defecto */
    body.auto-hide-sidebar .sidebar {
      transform: translateX(calc(var(--sidebar-width) * -1 + var(--sidebar-peek)));
    }
    /* Mostrar al activar (hover en zona izquierda) */
    body.auto-hide-sidebar.show-sidebar .sidebar {
      transform: translateX(0);
    }
    /* Zona sutil para detectar hover y mostrar el sidebar */
    .sidebar-hover-zone {
      position: fixed;
      left: 0;
      top: 0;
      width: var(--sidebar-peek);   /* ancho mÃ­nimo para activar */
      height: 100vh;
      z-index: 150;
      cursor: ew-resize;
    }
    /* Evitar que el contenido principal quede tapado por la zona */
    .sidebar-hover-zone { pointer-events: auto; }
    /* Desactivar auto-hide en pantallas pequeÃ±as */
    @media (max-width: 900px) {
      body.auto-hide-sidebar .sidebar { transform: translateX(0); }
      .sidebar-hover-zone { display: none; }
    }

    /* Estilos para el contenido principal */
    .main-content {
      padding: 30px;
      min-height: 100vh;
      background-color: transparent; /* Dejar que el tema del body se vea */
      position: relative;
      transition: margin-left 0.25s ease-in-out;
    }

    /* Expandir contenido cuando el sidebar estÃ© oculto */
    body.auto-hide-sidebar .main-content {
      margin-left: calc(var(--sidebar-peek) + 8px) !important;
    }
    /* Restaurar margen cuando el sidebar estÃ© mostrado */
    body.auto-hide-sidebar.show-sidebar .main-content {
      margin-left: var(--sidebar-width) !important;
    }
    
    /* Estilos para el menÂ¨Â² desplegable */
    .has-submenu {
      position: relative;
    }
    
    .submenu {
      display: none;
      padding-left: 20px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      margin-top: 5px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-in-out;
    }
    
    .submenu.active {
      display: block;
      max-height: 200px;
    }
    
    .submenu li {
      margin: 0;
    }
    
    .submenu a {
      padding: 10px 15px 10px 30px !important;
      font-size: 0.9em !important;
      opacity: 0.9;
    }
    
    .submenu a:hover {
      background: rgba(34, 179, 236, 0.2) !important;
      transform: none !important;
      padding-left: 35px !important;
    }
    
    .submenu-toggle {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
    }
    
    .submenu-icon {
      transition: transform 0.3s ease;
      font-size: 0.8em;
      margin-left: 5px;
    }
    
    .has-submenu.active .submenu-icon {
      transform: rotate(180deg);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 20px;
      background-color: transparent; /* Dejar que el tema del body se vea */
      min-height: 100vh;
      position: relative;
    }

    /* Estilos para las tarjetas de resumen */
    .summary-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin: 0;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .summary-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }
    
    .summary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .card-content {
      padding: 20px;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      color: white;
      font-size: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #4a5568;
      margin: 0;
    }
    
    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 12px;
    }
    
    .card-footer {
      display: flex;
      align-items: center;
      font-size: 13px;
      color: #718096;
    }
    
    .card-footer i {
      margin-right: 6px;
    }
    
    /* Estilos especÂ¨Âªficos para cada tarjeta */
    .sales-today .card-icon {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
    }
    
    .sales-month .card-icon {
      background: linear-gradient(135deg, #2196f3, #42a5f5);
    }
    
    .pending .card-icon {
      background: linear-gradient(135deg, #ff9800, #ffa726);
    }
    
    .cancelled .card-icon {
      background: linear-gradient(135deg, #f44336, #ef5350);
    }

    /* Nuevas tarjetas KPI */
    .points-monthly .card-icon {
      background: linear-gradient(135deg, #43e97b, #38f9d7);
    }

    .icon-market .card-icon {
      background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .bamo-market .card-icon {
      background: linear-gradient(135deg, #f093fb, #f5576c);
    }
    
    /* Estilos para la tabla de clientes */
    .costumer-table-container {
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(2, 8, 20, 0.06);
      /* No ocultar overflow para no cortar la barra de scroll horizontal del contenedor interno */
      overflow: visible;
      margin-top: 24px;
      border: 1px solid #e6eef5;
      max-width: 100%;
      /* Fijar el Â¨Â¢rea de tabla para que solo el listado haga scroll */
      display: flex;
      flex-direction: column;
      /* Ajusta el valor segÂ¨Â²n tu layout (altura visible menos tarjetas/mÂ¨Â¢rgenes) */
      height: calc(100vh - 280px);
    }
    
    .table-responsive {
      width: 100%;
      /* Scroll horizontal y vertical dentro del contenedor de tabla */
      overflow-x: scroll; /* fuerza a mostrar barra horizontal */
      -webkit-overflow-scrolling: touch;
      /* Permitir scroll vertical SOLO dentro del listado */
      overflow-y: auto;
      flex: 1 1 auto;
      position: relative;
      /* Reservar espacio para que la barra sea visible en Windows/macOS */
      padding-bottom: 10px;
      scrollbar-gutter: stable both-edges;
      /* Forzar que el scrollbar sea visible (Firefox/Edge/Chromium) */
      scrollbar-width: auto; /* Firefox */
    }

    /* Estilos de scrollbar (WebKit/Blink) */
    .table-responsive::-webkit-scrollbar { height: 10px; }
    .table-responsive::-webkit-scrollbar-track { background: #eef2f7; }
    .table-responsive::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
    .table-responsive::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Barra espejo dentro del contenedor de la tabla */
    .scrollbar-mirror {
      height: 18px;
      overflow-x: scroll;
      overflow-y: hidden;
      background: #e5e7eb;
      border-top: 1px solid #cbd5e1;
      position: sticky; /* pegada al borde inferior del card */
      bottom: 0;
      z-index: 11;
      margin-top: 6px;
    }
    .scrollbar-mirror::-webkit-scrollbar { height: 12px; }
    .scrollbar-mirror::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
    .scrollbar-mirror::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    /* Sticky header wrapper (deshabilitado) */
    .sticky-head-wrapper { display: none; }
    .sticky-head-wrapper table { border-collapse: separate; border-spacing: 0; width: max-content; background: #fff; }
    
    .costumer-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .costumer-table-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin: 0;
    }
    
    .costumer-table-actions {
      display: flex;
      gap: 12px;
    }
    
    .costumer-filter-input {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      width: 250px;
    }
    
    .costumer-filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .costumer-table {
      /* Forzar overflow horizontal en todos los casos */
      width: 6000px !important;
      min-width: 6000px !important;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed; /* respetar anchos y min-width de columnas */
      background: #fff;
    }
    
    .costumer-table th,
    .costumer-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eef2f7;
      white-space: nowrap; /* no permitir salto de lÃ­nea, asÃ­ se conserva el ancho */
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 240px; /* ampliar base por columna para provocar overflow */
      max-width: 360px;
      vertical-align: middle;
      font-size: 14px;
      color: #334155;
    }

    /* ===== Columnas compactas especÃ­ficas ===== */
    /* DirecciÃ³n = columna 6 */
    .costumer-table th:nth-child(6),
    .costumer-table td:nth-child(6) {
      max-width: 180px;
      min-width: 120px;
      padding: 4px 6px;
      font-size: 12.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Status = columna 9 */
    .costumer-table th:nth-child(9),
    .costumer-table td:nth-child(9) {
      width: 1% !important;           /* que tome solo el espacio del contenido */
      min-width: 70px !important;
      padding: 2px 4px !important;
      text-align: left !important;
      white-space: nowrap !important;
    }
    /* Si existe badge de status, hacerlo compacto */
    .costumer-table td:nth-child(9) .status-badge,
    .costumer-table td:nth-child(9) .badge-status {
      display: inline-block;
      padding: 2px 6px !important;
      font-size: 11.5px !important;
      line-height: 1.1;
      border-radius: 9px;
      font-weight: 700;
      width: auto; /* que se ajuste al texto */
      max-width: 100%;
    }

    /* Select de STATUS: pequeño y ajustado al texto */
    .costumer-table td:nth-child(9) select {
      width: auto !important;
      min-width: 84px;
      max-width: 160px;
      padding: 2px 6px !important;
      font-size: 12px !important;
      line-height: 1.2 !important;
      display: inline-block;
    }

    /* ===== Colores suaves por STATUS (aplicados a toda la fila) ===== */
    /* Pintar las celdas para garantizar visibilidad incluso si la tabla tiene fondo propio */
    .costumer-table tbody tr.row-status-pending td { background-color: #f8fafc !important; }
    .costumer-table tbody tr.row-status-hold td { background-color: #fff8db !important; }
    .costumer-table tbody tr.row-status-rescheduled td { background-color: #f2e9ff !important; }
    .costumer-table tbody tr.row-status-canceled td,
    .costumer-table tbody tr.row-status-cancelled td { background-color: #ffe7e7 !important; }
    .costumer-table tbody tr.row-status-complete td,
    .costumer-table tbody tr.row-status-active td { background-color: #e9f9ee !important; }
    .costumer-table tbody tr.row-status-active-oficina td { background-color: #eff6ff !important; }
    /* Mejorar legibilidad de separadores */
    .costumer-table tbody tr[class^="row-status-"] td { border-bottom-color: #e6edf5; }
    /* Reglas por data-row-status (mÃ¡s robusto contra re-pintados) */
    .costumer-table tbody tr[data-row-status="pending"] td { background-color: #f8fafc !important; }
    .costumer-table tbody tr[data-row-status="hold"] td { background-color: #fff8db !important; }
    .costumer-table tbody tr[data-row-status="rescheduled"] td { background-color: #f2e9ff !important; }
    .costumer-table tbody tr[data-row-status="canceled"] td,
    .costumer-table tbody tr[data-row-status="cancelled"] td { background-color: #ffe7e7 !important; }
    .costumer-table tbody tr[data-row-status="complete"] td,
    .costumer-table tbody tr[data-row-status="active"] td { background-color: #e9f9ee !important; }

    /* Reglas declarativas usando :has() en la 9na columna (STATUS) */
    .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="cancel"]) td { background-color: #ffe7e7 !important; }
    .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="hold"]) td { background-color: #fff8db !important; }
    .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="resched"]) td { background-color: #f2e9ff !important; }
    .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="complete"]) td,
    .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="active"]) td { background-color: #e9f9ee !important; }
    .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="oficina"]) td { background-color: #eff6ff !important; }
    .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="pending"]) td { background-color: #f8fafc !important; }

    /* Forzar estilo por clase (mÃ¡s especÃ­fico y robusto) */
    .costumer-table .status-col { padding: 2px 4px !important; text-align: left; width: 1% !important; white-space: nowrap !important; }
    .costumer-table .status-select {
      width: -moz-fit-content !important;
      width: fit-content !important;
      display: inline-flex !important;
      padding: 2px 6px !important;
      font-size: 12px !important;
      line-height: 1.2 !important;
      min-width: 72px;
      max-width: 140px;
    }

    /* VersiÃ³n aÃºn mÃ¡s compacta cuando el contenedor está en modo compacto */
    .costumer-table-container.compact .costumer-table th:nth-child(6),
    .costumer-table-container.compact .costumer-table td:nth-child(6) {
      max-width: 160px;
      min-width: 100px;
      font-size: 12px;
      padding: 4px 5px;
    }
    .costumer-table-container.compact .costumer-table th:nth-child(9),
    .costumer-table-container.compact .costumer-table td:nth-child(9) {
      width: auto !important;
      min-width: 70px !important;
      padding: 3px 5px !important;
    }
    .costumer-table-container.compact .costumer-table td:nth-child(9) .status-badge,
    .costumer-table-container.compact .costumer-table td:nth-child(9) .badge-status {
      padding: 2px 6px;
      font-size: 11.5px;
      border-radius: 9px;
    }

    .costumer-table-container.compact .costumer-table td:nth-child(9) select {
      min-width: 72px;
      max-width: 120px;
      padding: 2px 5px !important;
      font-size: 11.5px !important;
    }

    /* ===== MODO COMPACTO (sin scroll horizontal) ===== */
    .costumer-table-container.compact .table-responsive {
      overflow-x: hidden; /* ocultar barra horizontal */
    }
    .costumer-table-container.compact .costumer-table {
      width: 100% !important;
      min-width: 0 !important;
      table-layout: auto; /* que se ajuste al contenido */
    }
    .costumer-table-container.compact .costumer-table th,
    .costumer-table-container.compact .costumer-table td {
      white-space: normal;  /* permitir saltos de lÃ­nea */
      word-break: break-word;
      text-overflow: clip;
      min-width: auto;
      max-width: none;
      padding: 8px 10px;    /* reducir padding */
      font-size: 13px;      /* mÃ¡s compacto */
    }
    
    /* Encabezado: sticky solo en las celdas th */
    .costumer-table thead { position: static; }
    .costumer-table thead tr { position: static; }
    .costumer-table th {
      background: linear-gradient(180deg, #f9fbff 0%, #f3f6fb 100%);
      font-weight: 600;
      color: #1f2937;
      position: sticky !important;
      top: 0;
      z-index: 50; /* por encima de separadores y filas */
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.04em;
      border-bottom: 1px solid #e6eef5;
      background-clip: padding-box;
      background: #f7fafc;
    }
    /* Evitar que separadores tapen el header */
    .costumer-table tr.costumer-month-separator td { position: relative; z-index: 1; }

    /* removed sticky-head-wrapper override: se usa solo thead sticky nativo */

    /* Acomodar Ãºltimas columnas para evitar cortes de palabra en encabezados */
    /* Orden final esperado: ... | ZIP CODE | PUNTAJE | COMENTARIOS | ACCIÃ“N */
    .costumer-table th:nth-last-child(4) { min-width: 110px; white-space: nowrap; }
    .costumer-table th:nth-last-child(3) { min-width: 100px; white-space: nowrap; }
    .costumer-table th:last-child      { min-width: 110px; white-space: nowrap; text-align: center; }
    /* Celdas correspondientes */
    .costumer-table td:nth-last-child(4) { min-width: 110px; white-space: nowrap; }
    .costumer-table td:nth-last-child(3) { min-width: 100px; white-space: nowrap; text-align: center; }
    .costumer-table td:last-child       { min-width: 110px; white-space: nowrap; text-align: center; }
    
    .costumer-table tbody tr:hover {
      background-color: #f8fafc;
    }
    /* Separador mensual */
    .costumer-table tr.costumer-month-separator td {
      background-color: #e2e8f0 !important;
      color: #0f172a !important;
      font-weight: 700;
      padding: 12px 18px;
      border-top: 2px solid #cbd5e1;
      border-bottom: 1px solid #cbd5e1;
      border-left: 4px solid #1976d2;
      text-transform: none;
    }

    .dark .costumer-table tbody tr.costumer-month-separator td {
      background-color: #1e293b !important; /* slate-800 */
      color: #3b3b3b !important; /* slate-300 */
      border-top-color: #334155; /* slate-700 */
      border-bottom-color: #334155;
      border-left-color: #38bdf8; /* sky-400 */
    }
    
    .costumer-table th {
      text-align: left;
      padding: 14px 18px;
      white-space: nowrap;
    }
    
    .costumer-table td {
      padding: 14px 18px;
      border-bottom: 1px solid #eef2f7;
      color: #334155;
      background-color: #fff;
      /* Evita que el contenido se parta en varias lÃ­neas y fuerza overflow horizontal */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Zebra striping */
    .costumer-table tbody tr:nth-child(even) td {
      background-color: #fbfdff;
    }

    /* Hover sin lÂ¨Âªneas laterales */
    .costumer-table tbody tr:hover td {
      background-color: #f6fafe;
      box-shadow: none;
    }
    
    .costumer-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .costumer-table tbody tr:hover {
      background-color: #f8fafc;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Loading overlay for long fetches/parsing */
    .leads-loading-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.75);
      z-index: 99999;
      font-size: 16px;
      color: #0f172a;
      gap: 12px;
    }
    .leads-loading-overlay .spinner {
      width: 34px; height: 34px; border-radius: 50%; border: 4px solid #e2e8f0; border-top-color: #2563eb; animation: spin 1s linear infinite;
    }
    @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
    
    
    .badge-success {
      background-color: #e6f7ed;
      color: #10b981;
    }
    
    .badge-warning {
      background-color: #fffbeb;
      color: #f59e0b;
    }
    
    .badge-danger {
      background-color: #fdecea;
      color: #e53935;
    }

    .badge-active-oficina {
      background-color: #eff6ff;
      color: #2563eb;
      border: 1px solid #bfdbfe;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: #718096;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      background-color: #f1f5f9;
      color: var(--primary);
    }
    
    .action-btn i {
      font-size: 16px;
    }

    /* Toggle para modo compacto */
    .action-btn.toggle {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 6px 10px;
      color: #475569;
      background: #fff; 
    }
    .action-btn.toggle.active {
      background-color: #eff6ff;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    /* Modo compacto: reduce paddings y tama?o de fuente */
    body.compact .costumer-table th,
    body.compact .costumer-table td {
      padding: 8px 10px;
      font-size: 12px;
    }
    body.compact .costumer-filter-input {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .summary-cards-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      /* Reglas del sidebar unificadas en css/sidebar.css */
      
      .summary-cards-container {
        grid-template-columns: 1fr;
      }
    }
    /* Composer (comentarios) */
    .comment-composer { display:flex; gap:10px; align-items:flex-end; }
    .composer-avatar { width:40px; height:40px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; color:#6c757d; }
    .composer-input-wrap { position:relative; flex:1; display:flex; align-items:center; }
    .composer-textarea { width:100%; border:1px solid #ced4da; border-radius:22px; padding:10px 96px 10px 14px; min-height:40px; max-height:140px; resize:vertical; outline:none; transition:border-color .2s, box-shadow .2s; background:#fff; }
    .composer-textarea:focus { border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    .composer-actions { position:absolute; right:8px; bottom:8px; display:flex; gap:6px; align-items:center; }
    .emoji-btn { width:28px; height:28px; border-radius:14px; border:1px solid #e2e8f0; background:#fff; color:#111827; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 2px rgba(0,0,0,.05); font-size:16px; }
    .emoji-btn:hover { background:#f8fafc; }
    .composer-send { border:none; background:transparent; color:#0d6efd; font-weight:600; cursor:pointer; padding:4px 8px; border-radius:8px; }
    .composer-send:hover { color:#0b5ed7; text-decoration: underline; }
    .emoji-picker { position:absolute; right:10px; bottom:48px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,.08); padding:8px; width:260px; z-index:10; }
    .emoji-picker .title { font-size:12px; color:#6b7280; margin:2px 4px 6px; }
    .emoji-grid { display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; font-size:18px; }
    .emoji-item { border:none; background:none; cursor:pointer; line-height:1; padding:4px; border-radius:6px; }
    .emoji-item:hover { background:#f3f4f6; }

    /* Edit Modal Enhancements */
    #editarModal .edit-modal-card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    #editarModal .edit-grid { display:grid; grid-template-columns: repeat(3, minmax(220px, 1fr)); gap:12px 16px; align-items:start; }
    #editarModal .edit-section-title { font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:.06em; margin:0 0 10px; }
    #editarModal label { display:block; margin:6px 0 4px; color:#111; font-weight:600; }
    #editarModal input, #editarModal select, #editarModal textarea { width:100% !important; padding:6px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px; background:#f9fafb; }
    #editarModal input:focus, #editarModal select:focus, #editarModal textarea:focus { outline:none; border-color:#93c5fd; box-shadow:0 0 0 2px rgba(59,130,246,.15); background:#fff; }
    #editarModal .edit-actions { display:flex; justify-content:flex-end; gap:10px; margin-top: 12px; }
    #editarModal .btn-primary { background:#0ea5e9; color:#fff; border:none; padding:8px 14px; border-radius:8px; font-weight:600; cursor:pointer; }
    #editarModal .btn-primary:disabled { opacity:.6; cursor:not-allowed; }
    #editarModal .tv-grid { display:grid; grid-template-columns: repeat(2, minmax(120px, 1fr)); gap:8px 10px; }
    #editarModal .tv-field label { margin:0 0 6px; font-weight:600; }
    /* Agemni-like theme tokens */
    :root {
      --agemni-primary: #0ea5e9;
      --agemni-primary-600: #0284c7;
      --agemni-bg: #f8fafc;
      --agemni-surface: #ffffff;
      --agemni-border: #e5e7eb;
      --agemni-text: #0f172a;
      --agemni-muted: #64748b;
      --agemni-radius: 12px;
    }
    /* Apply tokens */
    .costumer-table-container { border-color: var(--agemni-border); border-radius: var(--agemni-radius); }
    .costumer-table th { background: #f7fafc; color: var(--agemni-text); }
    .costumer-table th + th { box-shadow: inset 1px 0 0 var(--agemni-border); }
    .costumer-table td { color: #334155; }
    .action-btn.toggle, .action-btn { border-color: var(--agemni-border); }
    #editarModal .btn-primary { background: var(--agemni-primary); }
    #editarModal .btn-primary:hover { background: var(--agemni-primary-600); }
    #editarModal input[disabled], #editarModal select[disabled], #editarModal textarea[disabled] { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: #e2e8f0; }
    /* Notes (comentarios) cards */
    #editarModal .note-card { background: var(--agemni-surface); border:1px solid var(--agemni-border); border-radius: 12px; padding: 10px 12px; box-shadow: 0 1px 2px rgba(2,8,20,.06); }
    #editarModal .note-card + .note-card { margin-top: 10px; }
    #editarModal .note-card:hover { box-shadow: 0 2px 8px rgba(2,8,20,.08); border-color: #dbe2ea; }
    #editarModal .note-header { display:flex; align-items:center; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    #editarModal .note-meta { font-size: 13px; font-weight: 700; color: var(--agemni-text); }
    #editarModal .note-actions { display:flex; gap:8px; }
    #editarModal .note-btn { width: 32px; height: 32px; border: none; border-radius: 16px; color:#fff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: 0 1px 2px rgba(0,0,0,.12); transition: transform .12s ease, box-shadow .12s ease, background-color .12s ease; }
    #editarModal .note-btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(14,165,233,.25); }
    #editarModal .note-btn.edit { background: var(--agemni-primary); }
    #editarModal .note-btn.edit:hover { background: var(--agemni-primary-600); transform: translateY(-1px); }
    #editarModal .note-btn.delete { background: #ef4444; }
    #editarModal .note-btn.delete:hover { background: #dc2626; transform: translateY(-1px); }
    #editarModal .note-content { background:#f9fafb; border:1px solid var(--agemni-border); border-radius: 10px; padding: 12px; font-size: 12px; color:#374151; line-height: 1.6; white-space: pre-wrap; }
  </style>
  <style>
    /* Bulk Excel Modal styles (scoped) */
    #bulkExcelModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 2200; align-items: center; justify-content: center; }
    #bulkExcelModal.show { display: flex; }
    #bulkExcelModal .bulk-dialog { width: 920px; max-width: calc(100% - 48px); background: #fff; border-radius: 10px; padding: 18px; box-shadow: 0 18px 40px rgba(2,8,20,0.25); }
    #bulkExcelModal .bulk-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    #bulkExcelModal .bulk-header h3 { margin:0; font-size:18px; color:#0f172a; }
    #bulkExcelModal .bulk-body { display:flex; gap:16px; margin-top:12px; flex-wrap:wrap; }
    #bulkExcelModal .bulk-left { flex:1 1 300px; min-width:260px; }
    #bulkExcelModal .bulk-right { flex:1 1 460px; min-width:300px; max-height:420px; overflow:auto; background:#fbfdff; padding:12px; border-radius:8px; border:1px solid #eef2f7; }
    #bulkExcelModal label strong { font-size:14px; color:#0f172a; }
    #bulkExcelModal input[type=file] { display:block; margin-top:8px; }
    #bulkExcelModal .hint { font-size:13px; color:#6b7280; margin-top:8px; }
    #bulkExcelModal .checks { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    #bulkExcelModal .bulk-actions { margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #bulkExcelModal .bulk-actions .btn-primary { background:#16a34a; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
    #bulkExcelModal .bulk-actions .btn-secondary { background:#fff; border:1px solid #e2e8f0; color:#0f172a; padding:8px 12px; border-radius:8px; cursor:pointer; }
    #bulkExcelModal .bulk-actions .action-btn { background: none; border: none; color: #475569; padding: 8px; border-radius:8px; }
    #bulkExcelModal .bulk-footer { margin-top:14px; display:flex; justify-content:flex-end; gap:8px; }
    #bulkExcelModal table#bulkPreviewTable { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
    #bulkExcelModal table#bulkPreviewTable thead th { padding:8px; text-align:left; border-bottom:1px solid #e6eef5; color:#475569; font-weight:700; }
    #bulkExcelModal table#bulkPreviewTable tbody td { padding:8px; border-bottom:1px solid #f1f5f9; color:#111827; }
    #bulkExcelModal .small-muted { font-size:12px; color:#6b7280; }
    /* Responsive tweaks */
    @media (max-width: 880px) { #bulkExcelModal .bulk-body { flex-direction:column-reverse; } #bulkExcelModal .bulk-dialog { padding:12px; } }
  </style>
  <style>
    /* Dark Theme Overrides for Costumer Table */
    body.dark-theme .costumer-table-container {
      background: var(--card-background);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
    }

    body.dark-theme .costumer-table-header {
      border-bottom: 1px solid var(--border-color);
    }

    body.dark-theme .costumer-table-title {
      color: var(--text-primary);
    }

    body.dark-theme .costumer-table,
    body.dark-theme .sticky-head-wrapper table {
      background: var(--card-background);
    }

    body.dark-theme .costumer-table th,
    body.dark-theme .costumer-table td {
      border-bottom: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    body.dark-theme .costumer-table th {
      color: var(--text-primary);
    }

    /* Row status colors for dark theme */
    body.dark-theme .costumer-table tbody tr.row-status-pending td,
    body.dark-theme .costumer-table tbody tr[data-row-status="pending"] td,
    body.dark-theme .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="pending"]) td {
      background-color: #2c3a51 !important;
    }

    body.dark-theme .costumer-table tbody tr.row-status-hold td,
    body.dark-theme .costumer-table tbody tr[data-row-status="hold"] td,
    body.dark-theme .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="hold"]) td {
      background-color: #5a3a1a !important;
    }

    body.dark-theme .costumer-table tbody tr.row-status-rescheduled td,
    body.dark-theme .costumer-table tbody tr[data-row-status="rescheduled"] td,
    body.dark-theme .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="resched"]) td {
      background-color: #4c1d95 !important;
    }

    body.dark-theme .costumer-table tbody tr.row-status-canceled td,
    body.dark-theme .costumer-table tbody tr.row-status-cancelled td,
    body.dark-theme .costumer-table tbody tr[data-row-status="canceled"] td,
    body.dark-theme .costumer-table tbody tr[data-row-status="cancelled"] td,
    body.dark-theme .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="cancel"]) td {
      background-color: #5b2121 !important;
    }

    body.dark-theme .costumer-table tbody tr.row-status-complete td,
    body.dark-theme .costumer-table tbody tr.row-status-active td,
    body.dark-theme .costumer-table tbody tr[data-row-status="complete"] td,
    body.dark-theme .costumer-table tbody tr[data-row-status="active"] td,
    body.dark-theme .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="complete"]) td,
    body.dark-theme .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="active"]) td {
      background-color: #164e3b !important;
    }
    body.dark-theme .costumer-table tbody tr.row-status-active-oficina td,
    body.dark-theme .costumer-table tbody tr:has(> td:nth-child(9)[data-status*="oficina"]) td {
      background-color: #0b2a4a !important;
    }

    body.dark-theme .costumer-table tbody tr[class^="row-status-"] td {
        border-bottom-color: #3e4c62;
    }

    /* Fix zebra-striping and hover for dark theme */
    body.dark-theme .costumer-table tbody tr:nth-child(even) td {
      background-color: #1a2436;
    }

    body.dark-theme .costumer-table tbody tr:hover td {
      background-color: #253147;
    }

    /* Fix badges for dark theme */
    body.dark-theme .badge-success { background-color: var(--success-light); color: var(--success-dark); }
    body.dark-theme .badge-warning { background-color: var(--warning-light); color: var(--warning-dark); }
    body.dark-theme .badge-danger { background-color: var(--danger-light); color: var(--danger-dark); }

    /* Fix action buttons for dark theme */
    body.dark-theme .action-btn {
      color: var(--text-secondary);
    }

    body.dark-theme .action-btn:hover {
      background-color: #2c3a51;
      color: var(--primary-color);
    }

    body.dark-theme .action-btn.toggle {
      border-color: var(--border-color);
      background: var(--card-background);
      color: var(--text-primary);
    }

    body.dark-theme .action-btn.toggle.active {
      background-color: #1e3a8a;
      color: #dbeafe;
      border-color: #3b82f6;
    }

    /* Fix Agemni overrides */
    body.dark-theme .costumer-table th {
      background: #1a2436;
      color: var(--text-primary);
      box-shadow: inset 1px 0 0 var(--border-color);
    }

    /* Dark theme for summary cards and table header */
    body.dark-theme .summary-card {
        background: var(--card-background);
        border-color: var(--border-color);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    body.dark-theme .summary-card:hover {
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
    }

    body.dark-theme .card-title,
    body.dark-theme .card-value {
        color: var(--text-primary);
    }

    body.dark-theme .card-footer {
        color: var(--text-secondary);
    }

    body.dark-theme .costumer-table-header {
        background: var(--card-background);
        border-bottom-color: var(--border-color);
    }

    body.dark-theme .costumer-table-title {
        color: var(--text-primary);
    }

    body.dark-theme .costumer-filter-input {
        background-color: var(--background-dark);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    /* Dark theme for table group headers and filter bars */
    body.dark-theme .group-header td {
        background-color: #1e293b !important;
        color: var(--text-primary);
        font-weight: bold;
    }

    body.dark-theme .costumer-table tr.costumer-month-separator td {
        background-color: #1e293b !important;
        color: #cbd5e1 !important;
        border-top-color: #334155;
        border-bottom-color: #334155;
        border-left-color: #38bdf8;
    }

    body.dark-theme #active-filters-bar {
        background-color: var(--card-background);
        border-bottom: 1px solid var(--border-color);
    }

    /* Dark theme for filter bars */
    body.dark-theme #teams-filter-bar,
    body.dark-theme #month-filter-bar {
        background-color: var(--card-background) !important;
        border-bottom: 1px solid var(--border-color);
    }

    /* Keep status selects white in dark theme */
    body.dark-theme .costumer-table td select,
    body.dark-theme .costumer-table td:nth-child(9) select,
    body.dark-theme .costumer-table .status-select {
        background-color: #ffffff !important;
        color: #1f2937 !important;
        border: 1px solid #d1d5db;
    }

  </style>
<body>
  <div class="layout">
    <!-- SIDEBAR (cargado dinámicamente) -->
    <nav class="sidebar sidebar-inicio" data-active="costumer"></nav>
    <script>
      // InyecciÃ³n de Teams y Usuarios en el Sidebar
      document.addEventListener('sidebar:loaded', function() {
        // Evitar duplicados
        if (document.querySelector('.submenu-injected-teams')) return;

        const TEAMS = [
            { name: "Oficina", supervisor: "Oficina", agents: [] },
            { name: "TEAM IRANIA", supervisor: "Irania Serrano", agents: ["NICOLE.CRUZ", "Melissa Escobar", "Roxana Martinez", "Josue Renderos", "Miguel Nunez", "Tatiana Ayala", "Giselle Diaz", "Jorge Segovia", "Jairo Flores", "Mauricio Martinez"] },
            { name: "TEAM JOHANA", supervisor: "Guadalupe Santana", agents: ["Carlos Grande", "abigail.bernal", "Anderson Guzman", "Riquelmi Torres", "Priscila Hernandez", "Julio Chavez", "Abigail Bernal", "Guadalupe Santana"] },
            { name: "TEAM MARISOL", supervisor: "Marisol Beltran", agents: ["Fernanda Castillo", "Jonathan Morales", "Stefani Martinez", "Eduardo R", "Francisco Aguilar", "Katerine Gomez", "Kimberly Iglesias", "INGRID.GARCIA"] },
            { name: "TEAM PLEITEZ", supervisor: "Bryan Pleitez", agents: ["Luis Chavarria", "Evelin Garcia", "Diego Mejia", "Alexander Rivera", "Steven Varela", "Julio Chavez", "Bryan Pleitez"] },
            { name: "TEAM ROBERTO", supervisor: "Roberto Velasquez", agents: ["Lucia Ferman", "Nelson Ceren", "Daniela Bonilla", "Lisbeth Cortez", "Francisco Aguilar", "Michelle Leiva", "Cindy Flores", "Alejandra Melara", "alejandraMelara"] }
        ];

        // FILTRADO DE TEAMS SEGÃšN ROL
        let visibleTeams = TEAMS;
        try {
            const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
            const role = (user.role || user?.usuario?.role || '').toString().toLowerCase().trim();
            // Nombres posibles del usuario
            const username = (user.username || user?.usuario?.username || '').toString().toLowerCase().trim();
            const nombre = (user.nombre || user?.usuario?.nombre || '').toString().toLowerCase().trim();
            // Normalizar team: reemplazar guiones bajos por espacios para comparaciÃ³n (ej: team_bryan -> team bryan)
            const userTeam = (user.team || user?.usuario?.team || '').toString().toLowerCase().trim().replace(/_/g, ' ');
            
            // Si NO es admin ni backoffice, filtrar
            const isAdmin = role === 'admin' || role === 'administrador';
            const isBackoffice = role.includes('backoffice') || role === 'bo' || role === 'b.o';
            
            if (!isAdmin && !isBackoffice) {
                visibleTeams = TEAMS.filter(t => {
                    const tName = t.name.toLowerCase();
                    const tSup = t.supervisor.toLowerCase();
                    
                    // Verificar si es su team (por nombre de team asignado)
                    // Buscamos coincidencia flexible: team_bryan -> team bryan en "team bryan pleitez"
                    // O viceversa: "bryan" en "team_bryan"
                    const matchTeam = userTeam && (tName.includes(userTeam) || userTeam.includes(tName.replace('team ', '')));
                    
                    // Verificar si es el supervisor
                    const matchSup = (nombre && tSup.includes(nombre)) || (username && tSup.includes(username));
                    // Verificar si es un agente del team
                    const matchAgent = t.agents.some(a => {
                        const aLow = a.toLowerCase();
                        return (nombre && aLow.includes(nombre)) || (username && aLow.includes(username));
                    });
                    
                    return matchTeam || matchSup || matchAgent;
                });
                console.log('[Sidebar] Filtrando teams para rol:', role, 'Usuario:', nombre || username, 'Team:', userTeam, 'Resultados:', visibleTeams.length);
            }
        } catch(e) { console.error('Error filtrando sidebar teams:', e); }

        const sidebar = document.querySelector('.sidebar');
        if (!sidebar) return;

        // Buscar el enlace activo para insertar debajo
        const links = Array.from(sidebar.querySelectorAll('a.btn-sidebar'));
        // Buscar por texto o por clase activa
        const activeLink = links.find(a => a.classList.contains('is-active')) || 
                           links.find(a => a.textContent && a.textContent.includes('Lista de Clientes'));

        if (activeLink) {
            const parentLi = activeLink.closest('li');
            if (parentLi) {
                const container = document.createElement('li');
                container.className = 'submenu-wrapper submenu-injected-teams';
                // Usamos clases de sidebar-shared.css y minimizamos inline styles
                container.innerHTML = `
                    <div class="submenu-title" style="border-top:1px solid #e5e7eb; padding-top:8px; margin-top:8px;">Teams y Usuarios</div>
                    <ul class="submenu-block">
                        ${visibleTeams.map((team, idx) => `
                            <li>
                                <button class="btn btn-sidebar team-toggle" data-idx="${idx}" data-team-name="${team.name}" style="display:flex; justify-content:space-between; align-items:center; width:100%; text-align:left; cursor:pointer; border:none; color:inherit;">
                                    <span><span class="nav-icon" style="width:14px; margin-right:8px; display:inline-block; text-align:center;">ðŸ‘¥</span>${team.name}</span>
                                    <span class="chevron" style="font-size:0.8em; color:#94a3b8;">â–¶</span>
                                </button>
                                <ul id="team-list-${idx}" style="display:none; list-style:none; padding-left:14px; margin-top:2px;">
                                    ${team.agents.map(agent => `
                                        <li>
                                            <a href="#" class="btn btn-sidebar agent-link" data-team="${team.name}" data-supervisor="${team.supervisor}" data-name="${agent}" style="display:block; text-decoration:none;">
                                                <span class="nav-icon" style="color:#10b981; margin-right:6px;">â—</span>${agent}
                                            </a>
                                        </li>
                                    `).join('')}
                                </ul>
                            </li>
                        `).join('')}
                    </ul>
                `;

                parentLi.after(container);

                // Helper to update filters
                const applyFilters = (teamName, supervisorName, agentName) => {
                    try {
                        console.log('[Sidebar] applyFilters triggered:', { teamName, supervisorName, agentName });
                        
                        // Mapeo especial para Jorge Segovia - buscar todas las variaciones
                        let searchNames = [agentName];
                        if (agentName === "Jorge Segovia") {
                            searchNames = [
                                "JORGE LUIS SEGOVIA RIVERA",
                                "JORGE.SERGOVIA", 
                                "Jorge Segovia",
                                "jorge segovia",
                                "JORGE SEGOVIA",
                                "Jorge Luis Segovia Rivera"
                            ];
                        }
                        // Mapeo especial para Jairo Flores - buscar todas las variaciones
                        else if (agentName === "Jairo Flores") {
                            searchNames = [
                                "Jairo Flores",
                                "JAIRO IVAN FLORES PINO",
                                "Jairo.Flores",
                                "jairo flores",
                                "JAIRO FLORES",
                                "Jairo Ivan Flores Pino"
                            ];
                        }
                        // Mapeo especial para Mauricio Martinez - buscar todas las variaciones
                        else if (agentName === "Mauricio Martinez") {
                            searchNames = [
                                "Mauricio Martinez",
                                "Mauricio.Martinez",
                                "mauricio martinez",
                                "MAURICIO MARTINEZ",
                                "Mauricio Martínez",
                                "MAURICIO MARTÍNEZ"
                            ];
                        }
                        
                        // 1. Establecer OVERRIDE para filtrado robusto
                        window.SIDEBAR_FILTER_OVERRIDE = {
                            team: teamName,
                            supervisor: supervisorName,
                            agent: agentName,
                            searchNames: searchNames // Agregar variaciones para búsqueda
                        };
                        
                        // Flag para indicar que estamos actualizando desde el sidebar
                        window.__IS_SIDEBAR_UPDATING = true;

                        const teamSelect = document.getElementById('teamFilter');
                        const agentSelect = document.getElementById('agentFilter');
                        const searchInput = document.getElementById('costumer-search');
                        
                        // 2. Limpiar bÃºsqueda de texto para evitar conflictos
                        if (searchInput) {
                            searchInput.value = '';
                            // No disparamos evento input aquÃ­ para no borrar el override con el listener del search
                        }

                        // 3. Intentar actualizar visualmente los dropdowns (Mejor esfuerzo)
                        if (teamSelect && agentSelect) {
                            const normalize = (str) => (str || '').toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
                            
                            // Buscar Team
                            let targetTeamValue = '';
                            const options = Array.from(teamSelect.options);
                            
                            // LÃ³gica de bÃºsqueda de equipo (similar a la anterior pero solo visual)
                            if (window.__teamAgentsMap) {
                                // Reverse lookup visual
                                const findTeam = (p) => {
                                    const pn = normalize(p);
                                    for (const [t, ags] of window.__teamAgentsMap.entries()) {
                                        if (ags.has(normalize(p))) return t;
                                        for (const a of ags) if (normalize(a).includes(pn) && pn.length > 3) return t; 
                                        if (normalize(t).includes(pn)) return t;
                                    }
                                    return null;
                                };
                                targetTeamValue = findTeam(agentName) || findTeam(supervisorName) || '';
                            }
                            window.renderCostumerTable(window.ultimaListaLeads);
                        }

                    } catch (err) {
                        console.error('[Sidebar] Error in applyFilters:', err);
                    } finally {
                        // Asegurar que el flag se resetee siempre
                        window.__IS_SIDEBAR_UPDATING = false;
                    }
                };

                // Event Listeners
                container.querySelectorAll('.team-toggle').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const idx = btn.dataset.idx;
                        const ul = document.getElementById(`team-list-${idx}`);
                        const chev = btn.querySelector('.chevron');
                        
                        // Toggle collapse
                        if (ul.style.display === 'none') {
                            // Close others
                            container.querySelectorAll('.submenu-block > li > ul').forEach(otherUl => {
                                if (otherUl !== ul) {
                                    otherUl.style.display = 'none';
                                    const otherBtn = container.querySelector(`.team-toggle[data-idx="${otherUl.id.replace('team-list-','')}"]`);
                                    if(otherBtn) otherBtn.querySelector('.chevron').textContent = 'â–¶';
                                }
                            });
                            
                            ul.style.display = 'block';
                            chev.textContent = 'â–¼';
                        } else {
                            ul.style.display = 'none';
                            chev.textContent = 'â–¶';
                        }
                    });
                });

                // Agent Link Click
                container.querySelectorAll('.agent-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const name = link.dataset.name;
                        const team = link.dataset.team;
                        const supervisor = link.dataset.supervisor;
                        
                        // Visual feedback
                        container.querySelectorAll('.btn-sidebar').forEach(l => l.style.backgroundColor = '');
                        container.querySelectorAll('.agent-link').forEach(l => l.style.backgroundColor = '');
                        
                        link.style.backgroundColor = 'rgba(59, 130, 246, 0.1)'; // Blue tint for agent

                        console.log('[Sidebar] Agent clicked:', name, 'Team:', team);
                        applyFilters(team, supervisor, name); // Set team AND agent
                    });
                });
            }
        }
      });
    </script>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Tarjetas de Resumen -->
      <div class="summary-cards-container">
        <!-- Ventas Hoy -->
        <div class="summary-card sales-today">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <h3 class="card-title">Ventas Hoy</h3>
            </div>
            <div class="card-value" id="costumer-ventas-hoy">0</div>
            <div class="card-footer">
              <i class="fas fa-calendar-day"></i> Actualizado ahora
            </div>
          </div>
        </div>

        <!-- Ventas del Mes -->
        <div class="summary-card sales-month">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <h3 class="card-title">Ventas del Mes</h3>
            </div>
            <div class="card-value" id="costumer-ventas-mes">0</div>
            <div class="card-footer">
              <i class="fas fa-calendar-alt"></i> Mes actual
            </div>
          </div>
        </div>
        <div class="summary-card sales-month">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-bolt"></i>
              </div>
              <h3 class="card-title">Ventas Activas</h3>
            </div>
            <div class="card-value" id="costumer-ventas-activas">0</div>
            <div class="card-footer">
              <i class="fas fa-check-circle"></i> Mes seleccionado
            </div>
          </div>
        </div>        <!-- Pendientes -->
        <div class="summary-card pending">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-clock"></i>
              </div>
              <h3 class="card-title">Pendientes</h3>
            </div>
            <div class="card-value" id="costumer-pendientes">0</div>
            <div class="card-footer">
              <i class="fas fa-info-circle"></i> Por atender
            </div>
          </div>
        </div>

        <!-- Cancelados -->
        <div class="summary-card cancelled">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-times-circle"></i>
              </div>
              <h3 class="card-title">Cancelados</h3>
            </div>
            <div class="card-value" id="costumer-cancelados">0</div>
            <div class="card-footer">
              <i class="fas fa-exclamation-triangle"></i> Este mes
            </div>
          </div>
        </div>

        <!-- Puntaje Mensual (NUEVO) -->
        <div class="summary-card points-monthly">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-star"></i>
              </div>
              <h3 class="card-title">Puntaje Mensual</h3>
            </div>
            <div class="card-value" id="costumer-puntaje-mensual">0</div>
            <div class="card-footer">
              <i class="fas fa-check"></i> Vendidas
            </div>
          </div>
        </div>

        <!-- VENTAS ICON (NUEVO) -->
        <div class="summary-card icon-market">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-map-marker-alt"></i>
              </div>
              <h3 class="card-title">VENTAS ICON</h3>
            </div>
            <div class="card-value" id="costumer-icon-ventas">0</div>
            <div class="card-footer">
              <i class="fas fa-percentage"></i> <span id="costumer-icon-percent">0%</span>
            </div>
          </div>
        </div>

        <!-- VENTAS BAMO (NUEVO) -->
        <div class="summary-card bamo-market">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-bullseye"></i>
              </div>
              <h3 class="card-title">VENTAS BAMO</h3>
            </div>
            <div class="card-value" id="costumer-bamo-ventas">0</div>
            <div class="card-footer">
              <i class="fas fa-percentage"></i> <span id="costumer-bamo-percent">0%</span>
            </div>
          </div>
        </div>

        <!-- ACTIVAS ICON (NUEVO) -->
        <div class="summary-card icon-market">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3 class="card-title">ACTIVAS ICON</h3>
            </div>
            <div class="card-value" id="costumer-activas-icon">0</div>
            <div class="card-footer">
              <i class="fas fa-chart-line"></i> Ventas activas
            </div>
          </div>
        </div>

        <!-- ACTIVAS BAMO (NUEVO) -->
        <div class="summary-card bamo-market">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3 class="card-title">ACTIVAS BAMO</h3>
            </div>
            <div class="card-value" id="costumer-activas-bamo">0</div>
            <div class="card-footer">
              <i class="fas fa-chart-line"></i> Ventas activas
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Clientes -->
      <div class="costumer-table-container compact">
        <div class="costumer-table-header">
          <h2 class="costumer-table-title">Lista de Clientes</h2>
          <div class="costumer-table-actions">
            <input type="text" class="costumer-filter-input" id="costumer-search" placeholder="Buscar cliente...">
            <select id="serviceFilter" class="costumer-filter-input" style="min-width: 140px;">
              <option value="">Todos los servicios</option>
              <option value="ATT">ATT (Todos)</option>
              <option value="DIRECTV">DIRECTV (Todos)</option>
              <option value="SPECTRUM">SPECTRUM (Todos)</option>
              <option value="FRONTIER">FRONTIER (Todos)</option>
              <option value="XFINITY">XFINITY (Todos)</option>
              <option value="BRIGHTSPEED">BRIGHTSPEED (Todos)</option>
              <option value="CONSOLIDATE">CONSOLIDATE (Todos)</option>
              <option value="EARTHLINK">EARTHLINK</option>
              <option value="OPTIMUM">OPTIMUM</option>
              <option value="WOW">WOW</option>
              <option value="ALTAFIBER">ALTAFIBER</option>
              <option value="WINDSTREAM">WINDSTREAM</option>
              <option value="HUGHESNET">HUGHESNET</option>
              <option value="VIASAT">VIASAT</option>
              <option value="CENTURYLINK">CENTURYLINK</option>
              <option value="METRONET">METRONET</option>
              <option value="ZIPLY">ZIPLY FIBER</option>
              <option value="HAWAIIAN">HAWAIIAN</option>
              <option value="VIVINT">VIVINT</option>
              <option value="MOBILITY">MOBILITY</option>
            </select>
            <label for="monthFilter">Mes</label>
            <select id="monthFilter">
              <option value="" selected>Todos los meses</option>
              <option value="2025-12">Diciembre 2025</option>
              <option value="2025-11">Noviembre 2025</option>
              <option value="2025-10">Octubre 2025</option>
              <option value="2025-09">Septiembre 2025</option>
              <option value="2025-08">Agosto 2025</option>
              <option value="2025-07">Julio 2025</option>
              <option value="2025-06">Junio 2025</option>
              <option value="2025-05">Mayo 2025</option>
            </select>
            <label for="teamFilter">Team</label>
            <select id="teamFilter" style="min-width: 120px;">
              <option value="">Todos los teams</option>
              <option value="Oficina" selected>Oficina</option>
            </select>
            <label for="agentFilter">Agente</label>
            <select id="agentFilter" style="min-width: 140px;">
              <option value="">Todos los agentes</option>
            </select>
            <label for="mercadoFilter">Mercado</label>
            <select id="mercadoFilter" style="min-width: 120px;">
              <option value="">Todos los mercados</option>
              <option value="ICON">ICON</option>
              <option value="BAMO">BAMO</option>
            </select>
            <!-- Botones 'Limpiar' y 'Recargar' removidos por solicitud -->
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
              <option value="all">Todos</option>
              <option value="completed">Completed / Active</option>
              <option value="active">Active</option>
              <option value="active_oficina">Active Oficina</option>
              <option value="pending">Pending</option>
              <option value="cancelled">Cancelled</option>
              <option value="hold">Hold</option>
              <option value="rescheduled">Rescheduled</option>
            </select>
            <label for="dateFrom">Desde</label>
            <input id="dateFrom" type="date" class="costumer-filter-input" style="min-width:150px;" />
            <label for="dateTo">Hasta</label>
            <input id="dateTo" type="date" class="costumer-filter-input" style="min-width:150px;" />
            <button id="btnClearDates" class="action-btn" title="Limpiar fechas" style="background:#64748b;">
              <i class="fas fa-times"></i>
            </button>
            <label for="recuentoCount">Recuento</label>
            <input id="recuentoCount" class="costumer-filter-input" type="text" value="0" readonly style="width: 90px; text-align: center; font-weight: 700;" />
            <button id="scroll-left" class="action-btn" title="Desplazar a la izquierda">
              <i class="fas fa-angle-double-left"></i>
            </button>
            <button id="scroll-right" class="action-btn" title="Desplazar a la derecha">
              <i class="fas fa-angle-double-right"></i>
            </button>

            <button id="refresh-table" class="action-btn" title="Refrescar">
              <i class="fas fa-sync-alt"></i>
            </button>
            <!-- BotÂ¨Â®n para alternar ver todos/mis clientes (solo visible para admin/supervisor/backoffice) -->
            <button id="toggle-forceall" class="action-btn" title="Ver todos" style="display:none">
              <i class="fas fa-users"></i>
            </button>
            <!-- BotÃ³n para actualizaciÃ³n masiva desde Excel (solo Admin/Backoffice) -->
            <button id="bulk-excel-btn" class="action-btn" title="Actualizar status desde Excel" style="display:none; margin-left:6px;">
              <i class="fas fa-file-excel" style="color:#1f8a22;"></i>
            </button>
            <!-- BotÃ³n temporal para debug de colores -->
            <!-- BotÃ³n de debug removido -->
            <!-- BotÃ³n para activar notificaciones -->
            <button id="enable-notifications-btn" class="action-btn" title="Activar Notificaciones" style="margin-left:6px; background:#6366f1; color:white;">
              <i class="fas fa-bell"></i>
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="costumer-table">
            <thead>
              <tr>
                <th>Nombre cliente</th>
                <th>Tel&eacute;fono principal</th>
                <th>Tel&eacute;fono alterno</th>
                <th>N&uacute;mero de cuenta</th>
                <th>Autopago</th>
                <th>Direcci&oacute;n</th>
                <th>Tipo de servicios</th>
                <th>Sistema</th>
                <th>Riesgo</th>
                <th style="white-space:nowrap;">D&iacute;a de venta <button id="filterDiaVenta" class="date-filter-btn" data-field="dia_venta" data-lskey="costumer_datefilter_dia_venta" title="Filtrar por DÃ­a de venta" style="border:none;background:transparent;padding:2px 6px;margin-left:6px;cursor:pointer;">â–¾</button></th>
                <th style="white-space:nowrap;">D&iacute;a de instalaci&oacute;n <button id="filterDiaInstalacion" class="date-filter-btn" data-field="dia_instalacion" data-lskey="costumer_datefilter_dia_instalacion" title="Filtrar por DÃ­a de instalaciÃ³n" style="border:none;background:transparent;padding:2px 6px;margin-left:6px;cursor:pointer;">â–¾</button></th>
                <th>Status</th>
                <th>Servicios</th>
                <th>Mercado</th>
                <th>Supervisor</th>
                <th>Comentario</th>
                <th>Motivo llamada</th>
                <th>ZIP CODE</th>
                <th>Puntaje</th>
                <th>Acci&oacute;n</th>
              </tr>
            </thead>
            <tbody id="costumer-tbody">
              <!-- Las filas se llenarÂ¨Â¢n dinÂ¨Â¢micamente con JavaScript -->
            </tbody>
          </table>
        </div>
        <div id="scrollbarMirror" class="scrollbar-mirror"><div id="scrollbarMirrorInner" style="width:1px;height:1px;"></div></div>
        <!-- Controles de paginaciÃ³n -->
        <div id="paginationControls">
          <div>
            <label for="pageSizeSelect">Por pÃ¡gina</label>
            <select id="pageSizeSelect">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
              <option value="99999">Todos</option>
            </select>
          </div>
          <button id="toggleMonthsBtn" class="action-btn" title="Ver todo / Solo 2 meses" style="min-width:140px;">Solo 2 meses</button>
          <button id="pagePrev" class="action-btn" title="PÃ¡gina anterior"><i class="fas fa-chevron-left"></i></button>
          <span id="pageInfo">PÃ¡gina 1</span>
          <button id="pageNext" class="action-btn" title="PÃ¡gina siguiente"><i class="fas fa-chevron-right"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Comentarios -->

  <!-- Modal: Bulk Excel -> Status Update -->
  <div id="bulkExcelModal" class="modal" aria-hidden="true">
    <div class="bulk-dialog" role="dialog" aria-modal="true" aria-labelledby="bulkExcelTitle">
      <div class="bulk-header">
        <h3 id="bulkExcelTitle">Actualizar status desde Excel</h3>
        <button id="bulkExcelClose" class="action-btn" title="Cerrar" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="bulk-body">
        <div class="bulk-left">
          <label><strong>Archivo (.xlsx / .xls / .csv)</strong></label>
          <input id="bulkExcelFile" type="file" accept=".xlsx,.xls,.csv" />
          <p class="hint">El parser se ejecuta en el navegador. Acepta encabezados comunes (por ejemplo: <em>AGENTE</em>, <em>Nombre cliente</em>, <em>TelÃ©fono principal</em>, <em>TelÃ©fono Alterno</em>, <em>Status</em>). Se intentarÃ¡ emparejar por <strong>telefono_principal</strong> (normalizado) y si no hay match por <strong>nombre_cliente</strong> (case-insensitive). AdemÃ¡s, el valor <strong>ACTIVE</strong> se normaliza y se tratarÃ¡ como <strong>COMPLETED</strong>.</p>
          <div class="checks">
            <label><input type="checkbox" id="bulkDryRun" checked /> Hacer dry-run (previsualizaciÃ³n) antes de aplicar</label>
            <label><input type="checkbox" id="bulkSaveSnapshot" checked /> Guardar snapshot/auditorÃ­a en servidor</label>
          </div>
          <div class="bulk-actions">
            <button id="bulkParseBtn" class="btn-secondary">Cargar y previsualizar</button>
            <button id="bulkApplyBtn" class="btn-primary" disabled>Aplicar cambios</button>
            <button id="bulkReconcilePhonesBtn" class="btn-secondary" disabled>Cuadrar teléfonos</button>
            <button id="bulkDownloadPreview" class="action-btn" disabled title="Descargar preview CSV">Descargar preview</button>
          </div>
        </div>
        <div class="bulk-right">
          <div id="bulkPreviewInfo" class="small-muted">Ningún archivo cargado.</div>
          <table id="bulkPreviewTable" style="display:none;">
            <thead><tr><th>#</th><th>Nombre</th><th>Teléfono</th><th>Status (archivo)</th><th>Match</th></tr></thead>
            <tbody id="bulkPreviewTbody"></tbody>
          </table>
        </div>
      </div>
      <div class="bulk-footer">
        <button id="bulkModalCancel" class="action-btn">Cerrar</button>
      </div>
    </div>
  </div>
  <div id="bulkReconcileModal" class="modal" aria-hidden="true" style="display:none; position:fixed; inset:0; background: rgba(0,0,0,0.45); z-index: 2250; align-items:center; justify-content:center;">
    <div class="bulk-dialog" role="dialog" aria-modal="true" aria-labelledby="bulkReconcileTitle" style="width: 980px; max-width: calc(100% - 48px);">
      <div class="bulk-header">
        <h3 id="bulkReconcileTitle">Cuadrar teléfonos (Excel vs CRM)</h3>
        <button id="bulkReconcileClose" class="action-btn" title="Cerrar" aria-label="Cerrar">✕</button>
      </div>
      <div class="bulk-body" style="gap:12px;">
        <div class="bulk-left" style="flex:1 1 420px; min-width:300px;">
          <div id="bulkReconcileSummary" class="small-muted">Sin resultados.</div>
          <div style="margin-top:10px;">
            <strong>En CRM pero NO en Excel</strong>
            <div style="max-height:320px; overflow:auto; border:1px solid #eef2f7; border-radius:8px; background:#fbfdff;">
              <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <thead>
                  <tr>
                    <th style="padding:8px; text-align:left; border-bottom:1px solid #e6eef5; color:#475569; font-weight:700;">Nombre</th>
                    <th style="padding:8px; text-align:left; border-bottom:1px solid #e6eef5; color:#475569; font-weight:700;">Teléfono</th>
                    <th style="padding:8px; text-align:left; border-bottom:1px solid #e6eef5; color:#475569; font-weight:700;">Cuenta</th>
                    <th style="padding:8px; text-align:left; border-bottom:1px solid #e6eef5; color:#475569; font-weight:700;">Producto</th>
                  </tr>
                </thead>
                <tbody id="bulkReconcileCrmMissingTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="bulk-right" style="flex:1 1 420px; min-width:300px; max-height:none;">
          <strong>En Excel pero NO en CRM</strong>
          <div style="max-height:380px; overflow:auto; border:1px solid #eef2f7; border-radius:8px; background:#fbfdff;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <thead>
                <tr>
                  <th style="padding:8px; text-align:left; border-bottom:1px solid #e6eef5; color:#475569; font-weight:700;">Teléfono</th>
                  <th style="padding:8px; text-align:left; border-bottom:1px solid #e6eef5; color:#475569; font-weight:700;">Nombre (Excel)</th>
                </tr>
              </thead>
              <tbody id="bulkReconcileExcelMissingTbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="bulk-footer">
        <button id="bulkReconcileClose2" class="action-btn">Cerrar</button>
      </div>
    </div>
  </div>
  <div id="comentariosModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
    <div style="position: absolute; right: 0; top: 0; width: 500px; height: 100%; background-color: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column;">
      <!-- Encabezado del modal -->
      <div style="padding: 20px; border-bottom: 1px solid #eaeaea; display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa;">
        <div>
          <h3 style="margin: 0; color: #333; font-size: 18px;">Comentarios</h3>
          <p style="margin: 5px 0 0; color: #666; font-size: 14px;">Agrega comentarios sobre el cliente</p>
        </div>
        <button onclick="cerrarComentarios()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
      </div>
      
      <!-- Lista de comentarios -->
      <div id="comentariosContainer" style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- Los comentarios se cargarÂ¨Â¢n aquÂ¨Âª dinÂ¨Â¢micamente -->
      </div>
      
      <!-- ?rea para nuevo comentario -->
      <div style="padding: 15px; border-top: 1px solid #eaeaea; background-color: #f8f9fa;">
        <div class="comment-composer" style="margin-bottom:10px;">
          <div class="composer-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="composer-input-wrap">
            <textarea id="nuevoComentario" class="composer-textarea" placeholder="Escribe un comentario..."></textarea>
            <div class="composer-actions">
              <button id="emojiToggleBtn" class="emoji-btn" onclick="toggleEmojiPicker(event)" title="Emojis">?</button>
              <button class="composer-send" onclick="agregarComentario()">Enviar</button>
            </div>
            <!-- Picker compacto -->
            <div id="emojiPicker" class="emoji-picker" style="display:none;">
              <div class="title">Emojis</div>
              <div class="emoji-grid">
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('??')">??</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Lead -->
  <style>
    #editarModal input[type="text"],
    #editarModal input[type="tel"],
    #editarModal input[type="email"],
    #editarModal input[type="date"],
    #editarModal select,
    #editarModal textarea {
      background: #e5e7eb !important;
      border: none !important;
      border-radius: 22px !important;
      padding: 12px 18px !important;
      font-size: 13px !important;
      color: #374151 !important;
      width: 100% !important;
      max-width: 260px !important;
      height: 44px !important;
      box-sizing: border-box !important;
      transition: all 0.2s ease !important;
      display: block !important;
      margin: 0 auto !important;
    }
    #editarModal label {
      text-align: center !important;
    }
    #editarModal .edit-grid > div {
      text-align: center !important;
    }
    #editarModal .edit-grid > div:first-child {
      text-align: left !important;
    }
    #editarModal .edit-grid > div:first-child label {
      text-align: left !important;
    }
    #editarModal .edit-grid > div:first-child input,
    #editarModal .edit-grid > div:first-child select {
      margin: 0 !important;
    }
    #editarModal .edit-section-title {
      text-align: center !important;
    }
    #editarModal .edit-grid > div:first-child .edit-section-title {
      text-align: left !important;
    }
    #editarModal .note-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-left: 3px solid #10b981;
      border-radius: 8px;
      padding: 12px 15px;
      padding-right: 70px;
      margin-bottom: 10px;
      font-size: 13px;
      color: #374151;
      word-wrap: break-word;
      white-space: pre-wrap;
      overflow-wrap: break-word;
      max-width: 100%;
      line-height: 1.5;
      position: relative;
    }
    #editarModal .note-card .note-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
    }
    #editarModal .note-card .note-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s;
    }
    #editarModal .note-card .note-btn-edit {
      background: #3b82f6;
      color: white;
    }
    #editarModal .note-card .note-btn-edit:hover {
      background: #2563eb;
      transform: scale(1.1);
    }
    #editarModal .note-card .note-btn-delete {
      background: #ef4444;
      color: white;
    }
    #editarModal .note-card .note-btn-delete:hover {
      background: #dc2626;
      transform: scale(1.1);
    }
    #editarModal input[type="text"]:focus,
    #editarModal input[type="tel"]:focus,
    #editarModal input[type="email"]:focus,
    #editarModal input[type="date"]:focus,
    #editarModal select:focus,
    #editarModal textarea:focus {
      background: #c4c9d1 !important;
      outline: none !important;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3) !important;
    }
    #editarModal textarea {
      border-radius: 14px !important;
      min-height: 60px !important;
      height: auto !important;
      resize: vertical !important;
    }
    #editarModal #edit-nueva-nota {
      width: 100% !important;
      max-width: 100% !important;
      min-height: 150px !important;
      height: auto !important;
      padding: 15px !important;
      font-size: 14px !important;
      line-height: 1.6 !important;
      border-radius: 12px !important;
      margin: 0 !important;
      resize: vertical !important;
      overflow: auto !important;
    }
    #editarModal select {
      cursor: pointer !important;
      appearance: none !important;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E") !important;
      background-repeat: no-repeat !important;
      background-position: right 10px center !important;
      background-size: 16px !important;
      padding-right: 32px !important;
    }
  </style>
  <div id="editarModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(30, 64, 175, 0.85) 0%, rgba(59, 130, 246, 0.75) 50%, rgba(14, 165, 233, 0.7) 100%); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); overflow: auto; padding: 40px;">
    <div style="position: relative; margin: 0 auto; width: calc(100% - 80px); max-width: none; height: calc(100vh - 80px); background: linear-gradient(145deg, #e0f2fe 0%, #bae6fd 30%, #7dd3fc 100%); border-radius: 24px; padding: 24px; box-shadow: 0 25px 80px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.2), inset 0 1px 0 rgba(255,255,255,0.4); display: flex; flex-direction: column; overflow: hidden;">
      <!-- Contenedor blanco interno con formulario -->
      <div class="edit-modal-card" style="background: white; border-radius: 18px; padding: 30px; flex: 1; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);">
        <!-- Header con ID del lead -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
              <i class="fas fa-user-edit" style="color: white; font-size: 20px;"></i>
            </div>
            <div>
              <h3 id="edit-lead-title" style="margin: 0; font-size: 22px; font-weight: 800; color: #1e293b;">
                Editar Lead <span id="edit-lead-id-display" style="color: #3b82f6; font-weight: 600;">#00000</span>
              </h3>
              <p style="margin: 4px 0 0; font-size: 13px; color: #64748b;">Modifica los datos del cliente</p>
            </div>
          </div>
          <button onclick="cerrarModalEdicion()" style="background: #f1f5f9; border: 1px solid #e2e8f0; width: 40px; height: 40px; border-radius: 10px; font-size: 22px; cursor: pointer; color: #64748b; transition: all 0.2s; display: flex; align-items: center; justify-content: center;" onmouseover="this.style.background='#e2e8f0'; this.style.color='#ef4444'" onmouseout="this.style.background='#f1f5f9'; this.style.color='#64748b'">&times;</button>
        </div>
        
        <input type="hidden" id="edit-id">
        
        <!-- Grid compacto 3 columnas -->  
        <div class="edit-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 40px; font-size: 13px; align-items: stretch;">
          <div style="background: #fff; border: 1px solid #e2e8f0; border-left: 4px solid #3b82f6; border-radius: 8px; padding: 20px;">
            <div class="edit-section-title" style="margin-bottom: 15px;">Datos del cliente</div>
            <label style="display: block; margin-bottom: 6px; color: #111; font-weight: 600;">Teléfono</label>
            <input type="tel" id="edit-telefono" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Teléfono Alterno</label>
            <input type="tel" id="edit-telefono-alt" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Nombres</label>
            <input type="text" id="edit-nombres" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Apellidos</label>
            <input type="text" id="edit-apellidos" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Dirección</label>
            <input type="text" id="edit-direccion" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">ZIP</label>
            <input type="text" id="edit-zip-code" style="width: 100%; max-width: 120px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
          </div>
          <div style="background: #fff; border: 1px solid #e2e8f0; border-left: 4px solid #3b82f6; border-radius: 8px; padding: 20px;">
            <div class="edit-section-title" style="margin-bottom: 15px;">Servicios</div>
            <label for="edit-tipo-servicios" style="display: block; margin-bottom: 6px; color: #111; font-weight: 600;">Tipo de Servicios</label>
            <select id="edit-tipo-servicios" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff; display:block; margin: 0 0 8px;">
              <option value="">Elige</option>
              <option value="att">ATT</option>
              <option value="directv">DIRECTV</option>
              <option value="frontier">FRONTIER</option>
              <option value="spectrum">SPECTRUM</option>
              <option value="wow">WOW</option>
              <option value="altafiber">ALTAFIBER</option>
              <option value="windstream">WINDSTREAM</option>
              <option value="hughesnet">HUGHESNET</option>
              <option value="viasat">VIASAT</option>
              <option value="consolidate">CONSOLIDATE</option>
              <option value="centurylink">CENTURYLINK</option>
              <option value="metronet">METRONET</option>
              <option value="ziply">ZIPLY FIBER</option>
              <option value="hawaiian">HAWAIIAN</option>
              <option value="double-play">DOUBLE PLAY</option>
              <option value="vivint">VIVINT</option>
              <option value="brightspeed">BRIGHTSPEED</option>
              <option value="mobility">MOBILITY</option>
              <option value="sim-mobility">SIM MOBILITY</option>
              <option value="earthlink">EARTHLINK</option>
              <option value="xfinity">XFINITY</option>
              <option value="optimum">OPTIMUM</option>
            </select>
            <label for="edit-servicios" style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Servicios</label>
            <select id="edit-servicios" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff; display:block; margin: 0 0 8px;">
              <option value="">Elige</option>
              <option value="video-directv-internet">VIDEO DIRECTV VIA INTERNET</option>
              <option value="video-directv-satelite">VIDEO DIRECTV VIA SATELITE</option>
              <option value="att-air">ATT AIR</option>
              <option value="att-18-25-mb">ATT 18 - 25 MB</option>
              <option value="att-50-100-mb">ATT 50 - 100 MB</option>
              <option value="att-100-fibra">ATT 100 FIBRA</option>
              <option value="att-300-500-mb">ATT 300 - 500 MB</option>
              <option value="att-1g-plus">ATT 1G+</option>
              <option value="mobility-spectrum">MOBILITY SPECTRUM</option>
              <option value="sim-spectrum">SIM SPECTRUM</option>
              <option value="frontier-200-mb">FRONTIER 200 MB</option>
              <option value="frontier-500-mb">FRONTIER 500 MB</option>
              <option value="frontier-1g">FRONTIER 1G</option>
              <option value="frontier-2g-plus">FRONTIER 2G+</option>
              <option value="spectrum-500">SPECTRUM 500</option>
              <option value="spectrum-1g">SPECTRUM 1G</option>
              <option value="spectrum-2g">SPECTRUM 2G</option>
              <option value="internet-wow">INTERNET WOW</option>
              <option value="internet-altafiber">INTERNET ALTA FIBER</option>
              <option value="internet-windstream">INTERNET WINDSTREAM</option>
              <option value="internet-hughesnet">INTERNET HUGHESNET</option>
              <option value="internet-viasat">INTERNET VIASAT</option>
              <option value="internet-consolidate">INTERNET CONSOLIDATE</option>
              <option value="internet-consolidate-2g">INTERNET CONSOLIDATE 2G</option>
              <option value="internet-consolidate-1g">INTERNET CONSOLIDATE 1G</option>
              <option value="internet-consolidate-300m">INTERNET CONSOLIDATE 300M</option>
              <option value="internet-consolidate-100m">INTERNET CONSOLIDATE 100M</option>
              <option value="internet-centurylink">INTERNET CENTURYLINK</option>
              <option value="internet-metronet">INTERNET METRONET</option>
              <option value="internet-ziply-fiber">INTERNET ZIPLY FIBER</option>
              <option value="internet-hawaiian">INTERNET HAWAIIAN</option>
              <option value="video-select-spectrum">VIDEO SELECT SPECTRUM</option>
              <option value="double-play-spectrum">DOUBLE PLAY SPECTRUM</option>
              <option value="brightspeed-10-100">BRIGHTSPEED 10-100MBPS</option>
              <option value="brightspeed-100-900">BRIGHTSPEED 100-900MBPS</option>
              <option value="internet-optimum">INTERNET OPTIMUM</option>
              <option value="internet-earthlink">INTERNET EARTHLINK</option>
              <option value="xfinity-double-play">XFINITY DOUBLE PLAY</option>
              <option value="xfinity-100-299">XFINITY 100 - 299 MBPS</option>
              <option value="xfinity-300">XFINITY 300MBPS</option>
              <option value="xfinity-500-plus">XFINITY 500MBPS+</option>
              <option value="xfinity-ultimate-tv">XFINITY ULTIMATE TV</option>
              <option value="xfinity-unlimited-voip">XFINITY UNLIMITED VOIP</option>
            </select>
            
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Autopago</label>
            <select id="edit-autopago" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
              <option value="">Seleccionar...</option>
              <option value="SI">Sí</option>
              <option value="NO">No</option>
            </select>
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Riesgo</label>
            <select id="edit-riesgo" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff; display:block;">
              <option value="">Elige</option>
              <option value="low">LOW</option>
              <option value="medium">MEDIUM</option>
              <option value="high">HIGH</option>
              <option value="na">N/A</option>
            </select>
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Status</label>
            <select id="edit-status" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff; display:block;">
              <option value="">Seleccionar...</option>
              <option value="PENDING">PENDING</option>
              <option value="ACTIVE">ACTIVE</option>
              <option value="ACTIVE OFICINA">Active Oficina</option>
              <option value="CANCELED">CANCELED</option>
            </select>
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Sistema</label>
            <select id="edit-sistema" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff; display:block;">
              <option value="">Seleccionar...</option>
              <option value="SARA">SARA</option>
              <option value="N/A">N/A</option>
            </select>
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Puntaje</label>
            <select id="edit-puntaje" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
              <option value="">Elige puntaje</option>
              <option value="1.5">1.5</option>
              <option value="1.25">1.25</option>
              <option value="1.0">1.0</option>
              <option value="0.95">0.95</option>
              <option value="0.75">0.75</option>
              <option value="0.70">0.70</option>
              <option value="0.50">0.50</option>
              <option value="0.35">0.35</option>
              <option value="0.25">0.25</option>
            </select>
          </div>
          <div style="background: #fff; border: 1px solid #e2e8f0; border-left: 4px solid #3b82f6; border-radius: 8px; padding: 20px;">
            <div class="edit-section-title" style="margin-bottom: 15px;">Administrativo</div>
            <label style="display: block; margin-bottom: 6px; color: #111; font-weight: 600;">Mercado</label>
            <input type="text" id="edit-mercado" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Representante</label>
            <input type="text" id="edit-representante" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Sup</label>
            <input type="text" id="edit-supervisor" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Fecha de Venta</label>
            <input type="date" id="edit-dia-venta" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Fecha de Instalación</label>
            <input type="date" id="edit-dia-instalacion" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">ACCOUNT</label>
            <input type="text" id="edit-numero-cuenta" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Motivo de llamada</label>
            <input type="text" id="edit-motivo-llamada" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;">
            <label style="display: block; margin: 14px 0 6px; color: #111; font-weight: 600;">Comentario</label>
            <textarea id="edit-comentario" style="width: 100%; min-height: 70px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; background: #fff;"></textarea>
          </div>
        </div>
        <div class="edit-actions" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
          <button onclick="cerrarModalEdicion()" style="background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; padding: 10px 24px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">Cancelar</button>
          <button onclick="guardarCambiosLead()" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; padding: 10px 28px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(59, 130, 246, 0.4)'">
            <i class="fas fa-save" style="margin-right: 8px;"></i>Guardar cambios
          </button>
        </div>
        <!-- SecciÃ³n de Notas / Historial (dentro del contenedor principal) -->
        <div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
          <h4 style="margin: 0 0 15px; font-size: 14px; font-weight: 700; color: #374151; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; justify-content: space-between;">
            <span><i class="fas fa-sticky-note" style="margin-right: 8px; color: #10b981;"></i>Notas e Historial</span>
            <button onclick="refrescarNotasLead()" style="background: #3b82f6; color: white; border: none; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 500;" title="Recargar notas del servidor">
              <i class="fas fa-sync-alt"></i> Refrescar
            </button>
          </h4>
          <!-- Input para nueva nota -->
          <div style="position: relative; margin-bottom: 15px;">
            <textarea id="edit-nueva-nota" placeholder="Agregar nueva nota..." style="width: 100%; padding: 15px; padding-right: 130px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; min-height: 150px; resize: vertical; background: #f9fafb; font-family: inherit; line-height: 1.5; box-sizing: border-box;"></textarea>
            <button onclick="agregarNotaCliente()" style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(16, 185, 129, 0.3)'">
              <i class="fas fa-plus"></i> Agregar Nota
            </button>
            <!-- Botones para adjuntar archivos -->
            <div style="position: absolute; bottom: 10px; left: 10px; display: flex; gap: 8px;">
              <input type="file" id="note-image-input" accept="image/*" style="display: none;" onchange="previewNoteAttachment(this, 'image')" />
              <input type="file" id="note-audio-input" accept="audio/*" style="display: none;" onchange="previewNoteAttachment(this, 'audio')" />
              <button type="button" onclick="document.getElementById('note-image-input').click()" style="background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'; this.style.color='#3b82f6'" onmouseout="this.style.background='#f1f5f9'; this.style.color='#64748b'" title="Adjuntar imagen">
                <i class="fas fa-image"></i> Imagen
              </button>
              <button type="button" onclick="document.getElementById('note-audio-input').click()" style="background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s;" onmouseover="this.style.background='#e2e8f0'; this.style.color='#8b5cf6'" onmouseout="this.style.background='#f1f5f9'; this.style.color='#64748b'" title="Adjuntar audio">
                <i class="fas fa-microphone"></i> Audio
              </button>
            </div>
          </div>
          <!-- Vista previa de archivos adjuntos -->
          <div id="note-attachments-preview" style="display: none; margin-bottom: 15px; padding: 10px; background: #f1f5f9; border-radius: 8px; border: 1px dashed #cbd5e1;">
            <div style="font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 600;">
              <i class="fas fa-paperclip"></i> Archivos adjuntos:
            </div>
            <div id="note-attachments-list" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
          </div>
          <!-- Contenedor de notas dinÃ¡mico -->
          <div id="edit-notes-list" style="max-height: none; overflow-y: visible; border: 1px solid #e5e7eb; border-radius: 8px; padding: 15px; background: #f9fafb;">
            <!-- Las notas se cargarÃ¡n aquÃ­ dinámicamente -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Helper: obtener leads por agentId desde backend (fallback para vista Supervisor)
    // Cache global de leads por agente para evitar reconsultas
    if (!window.__agentLeadsCache) window.__agentLeadsCache = new Map();
    let __currentFetchController = null;
    async function fetchLeadsByAgentId(agentId) {
      try {
        if (!agentId) return [];
        // Cache inmediato
        if (window.__agentLeadsCache.has(agentId)) {
          const cached = window.__agentLeadsCache.get(agentId);
          console.debug('[fetchLeadsByAgentId] usando cache para', agentId, 'items=', cached.length);
          return cached.slice();
        }
        const fetchOpts = { method: 'GET', credentials: 'include', headers: { 'Content-Type': 'application/json' } };
        // Solo las claves robustas que el backend soporta de forma directa
        const qParams = [
          ['agenteId', agentId],
          ['agentId', agentId]
        ];
        const normalizeId = (v) => {
          if (!v) return '';
          if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
          const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
        };
        // Abort de fetches previos si el usuario cambia de chip rÂ¨Â¢pidamente
        if (__currentFetchController) { try { __currentFetchController.abort(); } catch(_) {} }
        __currentFetchController = new AbortController();
        const { signal } = __currentFetchController;
        // Intentar primero agenteId, si no hay datos probar agentId inmediatamente despuÂ¨Â¦s
        const tryOnce = async ([key, val]) => {
          const url = `/api/leads?page=1&limit=200&${key}=${encodeURIComponent(val)}`;
          const res = await fetch(url, { ...fetchOpts, signal });
          if (!res.ok) { console.warn('[fetchLeadsByAgentId] HTTP', res.status, 'para', key); return []; }
          const data = await res.json();
          const leads = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
          console.log(`[fetchLeadsByAgentId] ${key} -> recibidos=${leads.length}`);
          return leads;
        };
        let acc = await tryOnce(qParams[0]);
        if (!acc.length) acc = await tryOnce(qParams[1]);
        // Cachear
        window.__agentLeadsCache.set(agentId, acc.slice());
        console.log('[fetchLeadsByAgentId] total =', acc.length);
        return acc;
      } catch (e) {
        console.warn('fetchLeadsByAgentId error:', e);
        return [];
      }
    }
    // Helper: obtener leads por nombre de agente desde backend (varias claves)
    async function fetchLeadsByAgentName(agentName) {
      try {
        if (!agentName) return [];
        const fetchOpts = { method: 'GET', credentials: 'include', headers: { 'Content-Type': 'application/json' } };
        const strip = (s) => s.normalize('NFD').replace(/\p{Diacritic}/gu,'');
        const collapsed = strip(agentName).replace(/\s+/g,'');
        // Insertar un espacio entre nombre y apellido si viene colapsado tipo "EduardoRivas"
        const spaced = (/^[A-Za-z]+[A-Z][a-z]+$/.test(agentName))
          ? agentName.replace(/([a-z])([A-Z])/g, '$1 $2')
          : agentName;
        const nameVariants = Array.from(new Set([
          agentName,
          spaced,
          collapsed
        ].map(v => String(v).trim()).filter(Boolean)));
        const keys = ['agenteNombre','nombreAgente','agente','salesAgent','vendedor','atendioPor','asignadoA','asignadoPor'];
        const normalizeId = (v) => {
          if (!v) return '';
          if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
          const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
        };
        const seen = new Set();
        const acc = [];
        for (const key of keys) {
          for (const val of nameVariants) {
            try {
              const url = `/api/leads?page=1&limit=200&${key}=${encodeURIComponent(val)}`;
              const res = await fetch(url, fetchOpts);
              if (!res.ok) { console.warn('[fetchLeadsByAgentName] HTTP', res.status, 'para', key, 'val', val); continue; }
              const data = await res.json();
              const leads = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
              for (const l of leads) {
                const id = normalizeId(l._id) || normalizeId(l.id) || normalizeId(l.leadId) || JSON.stringify(l).length;
                if (!seen.has(id)) { seen.add(id); acc.push(l); }
              }
              console.log(`[fetchLeadsByAgentName] ${key}=${val} -> recibidos=${leads.length} | acumulados=${acc.length}`);
            } catch (e) {
              console.warn('[fetchLeadsByAgentName] error con', key, 'val', val, e);
            }
          }
        }
        console.log('[fetchLeadsByAgentName] total combinados =', acc.length);
        return acc;
      } catch(e) {
        console.warn('fetchLeadsByAgentName error:', e);
        return [];
      }
    }
    // Manejador de errores global
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Error global detectado:', {
        message: message,
        source: source,
        lineno: lineno,
        colno: colno,
        error: error
      });
      return true; // Previene el manejador de errores por defecto
    };
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Cargar Chart.js desde assets locales para evitar bloqueos por tracking prevention -->
  <script src="/vendor/chartjs/chart.umd.min.js"></script>
  <script src="/vendor/chartjs-plugin/chartjs-plugin-datalabels.min.js"></script>
  <script>
    // Registrar ChartDataLabels de forma idempotente y defensiva para evitar registros dobles
    (function(){
      try{
        if (typeof Chart === 'undefined') { console.warn('Chart no está definido al registrar plugins (Costumer.html)'); return; }
        if (typeof ChartDataLabels === 'undefined') { console.warn('ChartDataLabels no está definido al intentar registrar (Costumer.html)'); return; }
        // Intentar limpiar registros previos del plugin por id si la estructura lo permite
        try {
          if (Chart && Chart.registry && Chart.registry.plugins && Array.isArray(Chart.registry.plugins.items)) {
            Chart.registry.plugins.items = Chart.registry.plugins.items.filter(p => !(p && p.id === 'datalabels'));
          }
          if (typeof Chart.unregister === 'function') {
            try { Chart.unregister({ id: 'datalabels' }); } catch(_){ }
          }
        } catch(_){ /* no crÃ­tico */ }
        // Registrar de forma segura
        try {
          if (typeof Chart.register === 'function') {
            Chart.register(ChartDataLabels);
            try { ChartDataLabels.__registeredWithChart = true; } catch(_){ }
            console.log('ChartDataLabels registrado (idempotente) en Costumer.html');
          } else {
            console.warn('No se encontró mÃ©todo Chart.register para registrar plugins (Costumer.html)');
          }
        } catch(e){ console.warn('Error registrando ChartDataLabels (Costumer.html):', e); }
      }catch(e){ console.warn('Registro ChartDataLabels fallo (Costumer.html):', e); }
    })();
  </script>
  <script src="utils/teams.js"></script>
  <script>
    // Función para crear toolbar de supervisor
    window.createSupervisorToolbar = function(leads) {
      // Deshabilitado temporalmente: no renderizar barra de filtros por agente para supervisores
      return;
    };
  </script>
  <script>
    // Bulk Excel -> Status update (client-side parsing + send to server)
    (function(){
      // Utils
      function safeParseUser(){ try{ return JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}'); }catch{return {}; } }
      function isAdminOrBackofficeLocal(){
        try{
          const u = safeParseUser();
          const r0 = (u.role || u?.usuario?.role || '').toString().toLowerCase().trim();
          const r = r0.replace(/\s+/g,'_').replace(/-+/g,'_');
          if (!r) return false;
          if (['admin','administrador','administrator'].includes(r)) return true;
          if (['backoffice','back office','back_office','bo','b.o','b-o','b:o','rol_icon','rol_bamo'].includes(r)) return true;
          return false;
        }catch{return false;}
      }

      const btn = document.getElementById('bulk-excel-btn');
      const modal = document.getElementById('bulkExcelModal');
      const fileInput = document.getElementById('bulkExcelFile');
      const parseBtn = document.getElementById('bulkParseBtn');
      const applyBtn = document.getElementById('bulkApplyBtn');
      const reconcileBtn = document.getElementById('bulkReconcilePhonesBtn');
      const closeBtn = document.getElementById('bulkExcelClose');
      const cancelBtn = document.getElementById('bulkModalCancel');
      const previewInfo = document.getElementById('bulkPreviewInfo');
      const previewTable = document.getElementById('bulkPreviewTable');
      const previewTbody = document.getElementById('bulkPreviewTbody');
      const dryRunEl = document.getElementById('bulkDryRun');
      const saveSnapshotEl = document.getElementById('bulkSaveSnapshot');
      const downloadPreviewBtn = document.getElementById('bulkDownloadPreview');


      const reconcileModal = document.getElementById('bulkReconcileModal');
      const reconcileClose = document.getElementById('bulkReconcileClose');
      const reconcileClose2 = document.getElementById('bulkReconcileClose2');
      const reconcileSummary = document.getElementById('bulkReconcileSummary');
      const crmMissingTbody = document.getElementById('bulkReconcileCrmMissingTbody');
      const excelMissingTbody = document.getElementById('bulkReconcileExcelMissingTbody');

      // show button only for admin/backoffice
      try{ if (btn) { if (isAdminOrBackofficeLocal()) btn.style.display='inline-block'; else btn.style.display='none'; } }catch(e){console.warn(e);} 

      function loadSheetJS(){
        return new Promise((resolve,reject)=>{
          if (window.XLSX) return resolve(window.XLSX);
          const local = '/vendor/xlsx/xlsx.full.min.js';
          const cdns = [
            'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
            'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
            'https://unpkg.com/xlsx/dist/xlsx.full.min.js'
          ];
          const appendScript = (src, onload, onerror) => {
            const s = document.createElement('script'); s.async = false; s.src = src;
            s.onload = onload; s.onerror = onerror; document.head.appendChild(s);
          };

          const tryCdns = (i) => {
            if (window.XLSX) return resolve(window.XLSX);
            if (i >= cdns.length) {
              try { if (previewInfo) previewInfo.textContent = 'No se pudo cargar SheetJS desde CDN ni localmente. Descarga el bundle y colÃ³calo en /public/vendor/xlsx/xlsx.full.min.js (ver instrucciones en consola).'; } catch(_){}
              console.error('[SheetJS] No se pudo cargar desde CDNs. Intenta descargar el archivo y colocarlo en public/vendor/xlsx/xlsx.full.min.js');
              console.error('PowerShell example:');
              console.error('Invoke-WebRequest -Uri "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" -OutFile "./public/vendor/xlsx/xlsx.full.min.js"');
              return reject(new Error('No se pudo cargar SheetJS'));
            }
            appendScript(cdns[i], ()=>{ if (window.XLSX) return resolve(window.XLSX); tryCdns(i+1); }, ()=>{ tryCdns(i+1); });
          };

          // Try local first (HEAD). If HEAD ok and looks like JS, load local, otherwise cycle CDNs
          fetch(local, { method: 'HEAD' }).then(headRes => {
            try {
              const ct = (headRes.headers.get('content-type')||'').toLowerCase();
              const useLocal = headRes.ok && ct.includes('javascript');
              if (useLocal) {
                appendScript(local, ()=>{ if (window.XLSX) return resolve(window.XLSX); tryCdns(0); }, ()=>{ tryCdns(0); });
                return;
              }
            } catch(_) {}
            tryCdns(0);
          }).catch(()=>{
            // HEAD failed (might be blocked); try CDNs
            tryCdns(0);
          });
        });
      }

      function normalizePhone(v){ if(!v) return ''; return String(v).replace(/[^0-9]+/g,'').replace(/^0+/,''); }
      function normalizeName(v){ if(!v) return ''; return String(v).normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase(); }

      function escapeHtml(s){
        return String(s == null ? '' : s)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      function getLeadProduct(lead){
        try{
          const l = lead || {};
          return (
            l.producto || l._raw?.producto ||
            l.servicios_texto || l._raw?.servicios_texto ||
            l.tipo_servicios || l._raw?.tipo_servicios ||
            l.servicios || l._raw?.servicios ||
            l.sistema || l._raw?.sistema ||
            ''
          );
        }catch{ return ''; }
      }

      function openReconcileModal(){
        if (!reconcileModal) return;
        reconcileModal.style.display = 'flex';
        reconcileModal.classList.add('show');
        reconcileModal.setAttribute('aria-hidden','false');
      }
      function closeReconcileModal(){
        if (!reconcileModal) return;
        reconcileModal.style.display = 'none';
        reconcileModal.classList.remove('show');
        reconcileModal.setAttribute('aria-hidden','true');
      }

      async function handleReconcilePhones(){
        const parsed = window.__bulkExcelParsed;
        if (!parsed) { alert('Primero carga y previsualiza el archivo.'); return; }
        const { rows, idxName, idxPhone, startRow } = parsed;
        const leads = Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : [];
        if (!rows || rows.length < 2) { alert('El archivo no contiene filas.'); return; }

        const excelPhones = new Map();
        const start = (typeof startRow === 'number' && startRow >= 0) ? startRow : 1;
        for (let i=start; i<rows.length; i++){
          const r = rows[i];
          if (!r) continue;
          const phoneRaw = (typeof idxPhone === 'number' && idxPhone >= 0) ? (r[idxPhone] || '') : '';
          const phoneNorm = normalizePhone(phoneRaw);
          if (!phoneNorm) continue;
          if (!excelPhones.has(phoneNorm)) {
            const nm = (typeof idxName === 'number' && idxName >= 0) ? (r[idxName] || '') : '';
            excelPhones.set(phoneNorm, String(nm || ''));
          }
        }

        const crmPhones = new Map();
        leads.forEach(l => {
          try{
            const phoneRaw = l?.telefono_principal || l?._raw?.telefono_principal || l?.telefono || l?.phone || '';
            const phoneNorm = normalizePhone(phoneRaw);
            if (!phoneNorm) return;
            if (!crmPhones.has(phoneNorm)) crmPhones.set(phoneNorm, l);
          }catch(_){ }
        });

        const crmNotInExcel = [];
        for (const [phoneNorm, lead] of crmPhones.entries()){
          if (!excelPhones.has(phoneNorm)) crmNotInExcel.push({ phone: phoneNorm, lead });
        }

        const excelNotInCrm = [];
        for (const [phoneNorm, name] of excelPhones.entries()){
          if (!crmPhones.has(phoneNorm)) excelNotInCrm.push({ phone: phoneNorm, name });
        }

        try{ if (crmMissingTbody) crmMissingTbody.innerHTML = ''; }catch(_){ }
        try{ if (excelMissingTbody) excelMissingTbody.innerHTML = ''; }catch(_){ }

        const maxShow = 3000;
        const crmShow = crmNotInExcel.slice(0, maxShow);
        const excelShow = excelNotInCrm.slice(0, maxShow);

        if (crmMissingTbody) {
          crmShow.forEach(({phone, lead}) => {
            const name = lead?.nombre_cliente || lead?._raw?.nombre_cliente || '';
            const cuenta = lead?.numero_cuenta || lead?._raw?.numero_cuenta || '';
            const producto = getLeadProduct(lead);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f5f9;">${escapeHtml(name)}</td>`+
                           `<td style="padding:8px;border-bottom:1px solid #f1f5f9;">${escapeHtml(phone)}</td>`+
                           `<td style="padding:8px;border-bottom:1px solid #f1f5f9;">${escapeHtml(cuenta)}</td>`+
                           `<td style="padding:8px;border-bottom:1px solid #f1f5f9;">${escapeHtml(producto)}</td>`;
            crmMissingTbody.appendChild(tr);
          });
        }

        if (excelMissingTbody) {
          excelShow.forEach(({phone, name}) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="padding:8px;border-bottom:1px solid #f1f5f9;">${escapeHtml(phone)}</td>`+
                           `<td style="padding:8px;border-bottom:1px solid #f1f5f9;">${escapeHtml(name)}</td>`;
            excelMissingTbody.appendChild(tr);
          });
        }

        if (reconcileSummary) {
          reconcileSummary.textContent = `Excel teléfonos únicos: ${excelPhones.size} | CRM teléfonos únicos: ${crmPhones.size} | CRM no en Excel: ${crmNotInExcel.length} | Excel no en CRM: ${excelNotInCrm.length}`;
        }
        openReconcileModal();
      }

      async function parseFile(file){
        await loadSheetJS();
        return new Promise((resolve,reject)=>{
            const reader = new FileReader();
            
            reader.onload = (e)=>{
                try{
                    const data = e.target.result;
                    // CAMBIO AQUÍ: Usar type: 'array' en lugar de 'binary'
                    const wb = window.XLSX.read(data, {type: 'array'}); 
                    const first = wb.SheetNames[0];
                    const ws = wb.Sheets[first];
                    const rows = window.XLSX.utils.sheet_to_json(ws, {header:1, defval: ''});
                    resolve(rows);
                }catch(err){ reject(err); }
            };
            
            reader.onerror = (err)=>reject(err);
            
            // CAMBIO AQUÍ: Leer siempre como ArrayBuffer (es más seguro para tildes y ñ)
            reader.readAsArrayBuffer(file); 
        });
      }

      function findHeaderIndex(headers, candidates){
        // Normalize header text: remove diacritics, lowercase and strip non-alphanumeric
        const norm = h=>{
          try{
            return String(h||'')
              .normalize('NFD')
              .replace(/\p{Diacritic}+/gu,'')
              .toLowerCase()
              .replace(/[^a-z0-9]+/g,'');
          }catch(e){
            return String(h||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
          }
        };
        const map = headers.map(h=>norm(h));
        for(const c of candidates){
          const nc = norm(c);
          const idx = map.indexOf(nc);
          if(idx>=0) return idx;
        }
        return -1;
      }

      function normalizeStatus(v){
        if(!v) return '';
        const s = String(v).trim().toLowerCase();
        if (['active','activo','activa','activated','activado'].includes(s)) return 'COMPLETED';
        if (['completed','complete','completado','completa','finalizado','finalizada'].includes(s)) return 'COMPLETED';
        if (['pending','pendiente','pend'].includes(s)) return 'PENDING';
        if (['canceled','cancelled','cancelado','cancelada','cancel'].includes(s)) return 'CANCELED';
        if (['hold','on hold','en espera','suspendido'].includes(s)) return 'HOLD';
        return String(v).trim().toUpperCase();
      }

      function buildPreview(rows, idxName, idxPhone, idxStatus, idxAgent, startRow){
        previewTbody.innerHTML='';
        const start = (typeof startRow === 'number' && startRow >= 0) ? startRow : 1;
        const max = Math.min(rows.length - start, 2000);
        for(let j=0;j<max;j++){
          const i = start + j;
          const r = rows[i];
          const name = r[idxName]||'';
          const phone = r[idxPhone]||'';
          const status = (typeof idxStatus === 'number' && idxStatus >= 0) ? (r[idxStatus]||'') : '';
          const agent = (typeof idxAgent === 'number' && idxAgent>=0) ? (r[idxAgent]||'') : '';
          const norm = normalizeStatus(status);
          const statusDisplay = norm && String(status||'').trim().toUpperCase() !== norm ? `${String(status||'')} â†’ ${norm}` : String(status||'');
          const tr = document.createElement('tr');
          tr.innerHTML = `<td style="padding:6px;border-bottom:1px solid #e6e9ef">${i}</td><td style="padding:6px;border-bottom:1px solid #e6e9ef">${String(name||'')}</td><td style="padding:6px;border-bottom:1px solid #e6e9ef">${String(phone||'')}</td><td style="padding:6px;border-bottom:1px solid #e6e9ef">${statusDisplay}</td><td style="padding:6px;border-bottom:1px solid #e6e9ef">${agent?String(agent):'-'}</td>`;
          previewTbody.appendChild(tr);
        }
        previewTable.style.display='table';
        previewInfo.textContent = `Filas detectadas: ${Math.max(0, rows.length - start)}. Mostrando primeras ${Math.min(2000, Math.max(0, rows.length - start))} filas para preview.`;
      }

      async function handleParse(){
        const f = fileInput.files && fileInput.files[0];
        if(!f){ alert('Selecciona un archivo .xlsx o .csv'); return; }
        previewInfo.textContent = 'Parseando archivo...';
        try{
          const rows = await parseFile(f);
          if(!rows || rows.length<2){ previewInfo.textContent='El archivo no contiene filas.'; return; }
          const rawHeaderRow = rows[0].map(h=>String(h||''));
          const headerLooksLikeData = (() => {
            try {
              const joined = rawHeaderRow.join(' ').trim();
              if (!joined) return false;
              const hasLetters = /[a-zA-Z]/.test(joined);
              const numeric = joined.replace(/[^0-9]+/g,'');
              return (!hasLetters && numeric.length >= 8);
            } catch { return false; }
          })();

          let headers = rawHeaderRow;
          let startRow = 1;
          let idxStatus = -1;
          let idxName = -1;
          let idxPhone = -1;
          let idxAgent = -1;

          if (headerLooksLikeData) {
            headers = ['telefono_principal'];
            startRow = 0;
            idxPhone = 0;
          } else {
            idxStatus = findHeaderIndex(headers, ['status','estado','estatus','stato']);
            idxName = findHeaderIndex(headers, ['nombre_cliente','nombre','clientename','name','cliente','customername']);
            idxPhone = findHeaderIndex(headers, ['telefono_principal','telefono','telefono1','phone','phone_main','telefono_pri']);
            idxAgent = findHeaderIndex(headers, ['agente','agent','agente_nombre','agente nombre','agenteNombre','vendedor','salesagent']);
          }

          buildPreview(rows, idxName>=0?idxName:0, idxPhone>=0?idxPhone:0, idxStatus, idxAgent>=0?idxAgent:-1, startRow);
          window.__bulkExcelParsed = { rows, headers, idxStatus, idxName, idxPhone, idxAgent: idxAgent>=0?idxAgent:-1, fileName: f.name, startRow };

          if (idxStatus >= 0) {
            applyBtn.disabled = false;
          } else {
            applyBtn.disabled = true;
          }
          if (reconcileBtn) reconcileBtn.disabled = false;
          downloadPreviewBtn.disabled = false;

          if (idxStatus < 0 && !headerLooksLikeData) {
            try {
              previewInfo.textContent = 'No se encontró columna STATUS en el archivo. Puedes usar "Cuadrar teléfonos" o cargar un archivo con STATUS para aplicar cambios.';
            } catch(_) {}
          }
        }catch(e){ console.error(e); previewInfo.textContent='Error parseando archivo: '+(e.message||e); }
      }

      function downloadCSVPreview(){
        const parsed = window.__bulkExcelParsed; if(!parsed) return; const {rows, idxStatus, idxName, idxPhone, idxAgent} = parsed; const lines=['row,nombre,telefono,agente,status,status_normalized'];
        for(let i=1;i<rows.length;i++){ const r=rows[i]; const name=r[idxName]||''; const phone=r[idxPhone]||''; const agent = (typeof idxAgent==='number' && idxAgent>=0)?(r[idxAgent]||'') : '' ; const status=r[idxStatus]||''; const norm = (typeof normalizeStatus==='function')?normalizeStatus(status):String(status).toUpperCase(); lines.push(`${i},"${String(name).replace(/"/g,'""')}","${String(phone).replace(/"/g,'""')}","${String(agent).replace(/"/g,'""')}","${String(status).replace(/"/g,'""')}","${String(norm).replace(/"/g,'""')}"`); if(i>5000) break; }
        const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='bulk_preview.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      async function handleApply(){
        const parsed = window.__bulkExcelParsed; if(!parsed){ alert('No hay datos parseados.'); return; }
        const {rows, idxStatus, idxName, idxPhone, idxAgent, fileName} = parsed;
        const dry = !!dryRunEl.checked;
        const saveSnapshot = !!saveSnapshotEl.checked;
        // build normalized rows (limit to configured maximum, e.g., 10000)
        const maxRows = 10000; const allRows = [];
        for(let i=1;i<rows.length && allRows.length<maxRows;i++){
          const r = rows[i];
          const name = r[idxName]||'';
          const phone = r[idxPhone]||'';
          const agent = (typeof idxAgent==='number' && idxAgent>=0)?(r[idxAgent]||'') : '';
          const statusRaw = r[idxStatus]||'';
          const statusNorm = normalizeStatus(statusRaw);
          // Enviar telefono ya normalizado para mejorar matching en servidor
          allRows.push({row:i, nombre_cliente: String(name), telefono_principal: normalizePhone(phone), original_telefono: String(phone), agente: String(agent), status_archivo: String(statusNorm)});
        }

        if (allRows.length === 0) { alert('No hay filas para procesar.'); return; }

        // chunk settings
        const chunkSize = 1000; // filas por peticiÃ³n (ajustable)
        const chunks = [];
        for (let i=0;i<allRows.length;i+=chunkSize) chunks.push(allRows.slice(i, i+chunkSize));

        applyBtn.disabled = true; applyBtn.textContent='Aplicando...';
        let aggregated = { updated:0, unmatched:0, errors:[], auditIds: [] };
        const token = localStorage.getItem('token')||sessionStorage.getItem('token')||'';

        for (let ci=0; ci<chunks.length; ci++){
          const chunk = chunks[ci];
          previewInfo.textContent = `Enviando chunk ${ci+1}/${chunks.length} (${chunk.length} filas)...`;
          try{
            const body = { fileName, dryRun: !!dry, saveSnapshot: !!saveSnapshot && (ci===chunks.length-1), rows: chunk, chunkIndex: ci, chunkTotal: chunks.length };
            const resp = await fetch('/api/customers/bulk-status-update', {
              method: 'POST', headers: Object.assign({'Content-Type':'application/json'}, token?{'Authorization':'Bearer '+token}:{}), body: JSON.stringify(body)
            });

            const ct = (resp.headers.get('content-type') || '').toLowerCase();
            let j = null;
            if (ct.includes('application/json')) {
              try{ j = await resp.json(); } catch(err){ j = null; }
            } else {
              const txt = await resp.text();
              if (!resp.ok) {
                if (resp.status === 413) throw new Error('Payload demasiado grande en el servidor al procesar este chunk. Reduce chunkSize o contacta a tu administrador.');
                throw new Error(`Error del servidor ${resp.status}: ${txt.slice(0,400)}`);
              }
              try{ j = JSON.parse(txt); } catch(e){ j = null; }
            }

            if (!resp.ok) {
              const msg = j && j.message ? j.message : `Error del servidor: ${resp.status}`;
              aggregated.errors.push({ chunk: ci, message: msg });
              console.error('Bulk chunk error:', resp.status, j || msg);
              // decide: continuar con siguientes chunks o abortar? Continuamos para intentar aplicar lo que sÃ­ pueda
            } else {
              if (j) {
                aggregated.updated += (j.updated||0);
                aggregated.unmatched += (j.unmatched||0);
                if (Array.isArray(j.errors)) aggregated.errors.push(...j.errors);
                if (j.auditId) aggregated.auditIds.push(j.auditId);
              }
            }
          }catch(err){
            console.error('[BULK CHUNK] Error en chunk', ci, err);
            aggregated.errors.push({ chunk: ci, message: err.message||String(err) });
          }
        }

        // resultado final
        applyBtn.disabled = false; applyBtn.textContent='Aplicar cambios';
        previewInfo.textContent = `Proceso finalizado. Procesados: ${allRows.length}. Chunks: ${chunks.length}.`;
        const errCount = aggregated.errors.length;
        alert(`Resultado: actualizados=${aggregated.updated||0}, sin_match=${aggregated.unmatched||0}, errores=${errCount}`);
        if (errCount) console.warn('Errores durante bulk:', aggregated.errors);
        if (aggregated.auditIds.length) console.log('Audit IDs:', aggregated.auditIds);
      }

      // Event wiring
  if(btn) btn.addEventListener('click', ()=>{ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); });
  if(closeBtn) closeBtn.addEventListener('click', ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); });
  if(cancelBtn) cancelBtn.addEventListener('click', ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); });
      if(parseBtn) parseBtn.addEventListener('click', handleParse);
      if(downloadPreviewBtn) downloadPreviewBtn.addEventListener('click', downloadCSVPreview);
      if(applyBtn) applyBtn.addEventListener('click', handleApply);
      if(reconcileBtn) reconcileBtn.addEventListener('click', handleReconcilePhones);
      if(reconcileModal) reconcileModal.addEventListener('click', (e)=>{ if (e && e.target === reconcileModal) closeReconcileModal(); });
      if(reconcileClose) reconcileClose.addEventListener('click', closeReconcileModal);
      if(reconcileClose2) reconcileClose2.addEventListener('click', closeReconcileModal);

      // close modal on outside click
  modal.addEventListener('click', (e)=>{ if(e.target===modal) { modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); } });
    })();
  </script>
  <script>
    // FunciÂ¨Â®n para verificar el rol del usuario y mostrar/ocultar elementos segÂ¨Â²n corresponda
    function checkUserRole() {
      try {
        const teamMenuItem = document.getElementById('teamMenuItem');
        if (teamMenuItem) {
          teamMenuItem.style.display = 'none';
        }

    // Helper GLOBAL: matcher para agente seleccionado (canÂ¨Â®nico y heurÂ¨Âªsticas)
    if (!window.matchSelectedAgent) {
      window.matchSelectedAgent = function(l, selectedCanon) {
        try {
          if (!selectedCanon) return true;
          const teamsApi = (window && window.Teams) ? window.Teams : null;
          const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const collapse = s => norm(s).replace(/[^a-z0-9]/g, '');
          const canonFrom = name => {
            try { return teamsApi && typeof teamsApi.canonicalFromName==='function' ? teamsApi.canonicalFromName(name) : norm(name); } catch { return norm(name); }
          };
          const selectedDisplay = (teamsApi && typeof teamsApi.getDisplayName==='function') ? teamsApi.getDisplayName(selectedCanon) : selectedCanon;
          const selCanonCollapsed = collapse(selectedCanon);
          const selDisplayCollapsed = collapse(selectedDisplay);
          // Intentar poblar __agentCanon usando el helper universal (usa mapa de IDs)
          try { if (typeof getAgentCanonUniversal === 'function') { const c0 = getAgentCanonUniversal(l); if (c0) l.__agentCanon = c0; } } catch(_) {}
          const c1 = (l && l.__agentCanon) ? l.__agentCanon : '';
          if (c1 && (c1 === selectedCanon || collapse(c1) === selCanonCollapsed)) return true;
          const candidates = [
            l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
            l?.vendedor, l?.seller, l?.usuario, l?.owner, l?.createdBy, l?.registeredBy,
            l?.asignadoA, l?.asignado_a, l?.assignedTo, l?.assigned_to,
            l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente,
            l?._raw?.agent, l?._raw?.Agent, l?._raw?.vendedor, l?._raw?.seller,
            l?._raw?.usuario, l?._raw?.owner, l?._raw?.createdBy, l?._raw?.registeredBy,
            l?._raw?.asignadoA, l?._raw?.asignado_a, l?._raw?.assignedTo, l?._raw?.assigned_to
          ];
          for (const v of candidates) {
            if (!v) continue;
            const c = canonFrom(v);
            if (c && (c === selectedCanon || collapse(c) === selCanonCollapsed)) return true;
            const col = collapse(v);
            if (col && (col === selDisplayCollapsed || col === selCanonCollapsed)) return true;
          }
          const toks = selectedCanon.split(' ').filter(Boolean);
          const txt = norm(JSON.stringify(l||{}));
          if (toks.every(t => txt.includes(t))) return true;
          return false;
        } catch { return false; }
      };
    }

        // Obtener y normalizar rol
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString();
        const role = roleRaw.toLowerCase().trim();

        // Roles permitidos para ver Team: admin, supervisor, backoffice (y variantes)
        const allowed = new Set(['admin','supervisor','backoffice','b:o','b.o','b-o','bo']);

        if (teamMenuItem && allowed.has(role)) {
          // li por defecto es list-item; usar block para asegurar visibilidad
          teamMenuItem.style.display = 'block';
        }
      } catch (error) {
        console.error('Error al verificar el rol del usuario:', error);
      }
    }
    
    // Inicializar cuando el DOM estÂ¨Â¦ listo
    document.addEventListener('DOMContentLoaded', function() {
      checkUserRole();
    });
  </script>
  <!-- Override DESPUÃ‰S de script.js para Team LÃ­neas -->
  <script>
    // Overfride para Team LÃ­neas despuÃ©s de cargar script.js
    (function() {
      const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
      const role = (user.role||user?.usuario?.role||'').toString().trim().toLowerCase();
      const username = (user.username||user?.usuario?.username||'').toString().trim().toLowerCase();
      const isTeamLineas = role==='teamlineas' || username.startsWith('lineas-') || username.includes('lineas');
      
      if (isTeamLineas) {
        console.log('[Team LÃ­neas OVERRIDE] Usuario Team LÃ­neas detectado, sobrescribiendo renderCostumerTable');
        
        // Sobrescribir renderCostumerTable DESPUÃ‰S de que script.js lo defina
        window.renderCostumerTable = function(leads) {
          console.log('[Team LÃ­neas INTERCEPTOR] Renderizando con interceptor');
          
          // Aplicar encabezado Team LÃ­neas
          const thead = document.querySelector('.costumer-table thead');
          if (thead) {
            const headers = ['NOMBRE CLIENTE','TELÉFONO PRINCIPAL','NÚMERO DE CUENTA','AUTOPAGO','PIN DE SEGURIDAD','DIRECCIÃ“N','DÃA DE VENTA','DÃA DE INSTALACIÃ“N','STATUS','CANTIDAD DE LÃNEAS','TELÉFONOS DE LAS LÃNEAS','ID','SUPERVISOR','MERCADO'];
            thead.innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
          }
          
          // Renderizar filas Team LÃ­neas
          const tbody = document.getElementById('costumer-tbody');
          if (tbody) {
            tbody.innerHTML = '';
            const arr = Array.isArray(leads) ? leads : (Array.isArray(leads?.leads) ? leads.leads : []);
            
            arr.forEach(l => {
              const autop = (l.autopay ?? l.autopago);
              const autopTxt = typeof autop === 'boolean' ? (autop ? 'Sí' : 'No') : 
                              (String(autop||'').toUpperCase() === 'SI' ? 'Sí' : 
                              (String(autop||'').toUpperCase() === 'NO' ? 'No' : String(autop||'')));
              
              const cant = (l.cantidad_lineas != null) ? l.cantidad_lineas : 
                          (Array.isArray(l.telefonos) ? l.telefonos.length : '');
              
              // Servicios resumen
              let servicios = '';
              const arr = Array.isArray(l.telefonos) ? l.telefonos : [];
              if (arr.length) {
                const m = new Map();
                arr.forEach(t => {
                  const k = (t?.servicio || t?.tipo || '').toString().trim() || 'SERVICIO';
                  m.set(k, (m.get(k) || 0) + 1);
                });
                servicios = [...m.entries()].map(([k,v]) => v > 1 ? `${k} x${v}` : k).join('; ');
              } else {
                servicios = l.servicios_texto || l.tipo_servicios || l.servicios || l.producto || '';
              }
              
              // PIN enmascarado
              const pin = l.pin_seguridad ? 'â€¢'.repeat(Math.min(4, String(l.pin_seguridad).length)) : '';
              
              // Fecha normalizada (parseo local para evitar desfase UTC)
              function normDate(v) {
                try {
                  if (!v) return '';
                  const s = String(v);
                  // Si ya es YYYY-MM-DD, devolverlo tal cual
                  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
                  // Si es otro formato, intentar parsear como local
                  const match = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
                  if (match) {
                    const [_, y, m, d] = match;
                    return `${y}-${m}-${d}`;
                  }
                  const d = new Date(s);
                  if (isNaN(d)) return s;
                  const y = d.getFullYear();
                  const m = String(d.getMonth()+1).padStart(2,'0');
                  const day = String(d.getDate()).padStart(2,'0');
                  return `${y}-${m}-${day}`;
                } catch {
                  return String(v||'');
                }
              }
              
              const cells = [
                l.nombre_cliente || '',
                l.telefono_principal || '',
                l.numero_cuenta || '',
                autopTxt || '',
                pin || '',
                l.direccion || '',
                normDate(l.dia_venta || l.fecha_contratacion || l.fecha || ''),
                normDate(l.dia_instalacion || ''),
                (l.status || '').toString().toUpperCase(),
                cant || '',
                servicios || '',
                (l.id_cliente || l._id || l.id || ''),
                l.supervisor || '',
                l.mercado || ''
              ];
              
              const tr = document.createElement('tr');
              tr.innerHTML = cells.map(v => `<td>${v == null ? '' : v}</td>`).join('');
              tbody.appendChild(tr);
            });
          }
        };
      }
    })();
  </script>
  <!-- Eliminada la referencia a costumer-comments.js que no existe -->
  <script>
    // InicializaciÂ¨Â®n de UI: toggle compacto y refrescar tabla
    document.addEventListener('DOMContentLoaded', function() {
      const toggleBtn = document.getElementById('toggle-compact');
      const refreshBtn = document.getElementById('refresh-table');
      const forceAllBtn = document.getElementById('toggle-forceall');
      const debugColorsBtn = document.getElementById('debug-colors-btn');

      if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          document.body.classList.toggle('compact');
          toggleBtn.classList.toggle('active');
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
          const icon = refreshBtn.querySelector('i');
          const prev = icon.className;
          icon.className = 'fas fa-spinner fa-spin';
          try {
            if (typeof cargarDatosDesdeServidor === 'function') {
              await cargarDatosDesdeServidor();
            } else if (typeof fetchLeadsAgente === 'function') {
              await fetchLeadsAgente();
            }
          }
          finally { icon.className = prev; }
        });
      }

      // BotÃ³n de debug para colores
      if (debugColorsBtn) {
        debugColorsBtn.addEventListener('click', function() {
          console.log('ðŸŽ¨ === MANUAL DEBUG COLORS ===');
          
          // Mostrar estado actual
          const isDark = document.body.classList.contains('dark-theme');
          console.log('ðŸŒ™ Tema oscuro activo:', isDark);
          
          // Contar filas
          const tbody = document.getElementById('costumer-tbody');
          const rows = tbody ? tbody.querySelectorAll('tr:not(.costumer-month-separator)') : [];
          console.log('ðŸ“Š Filas encontradas:', rows.length);
          
          // Ejecutar funciÃ³n de debug
          if (typeof window.debugThemeColors === 'function') {
            window.debugThemeColors();
          }
          
          // Forzar recoloreo INMEDIATO
          if (typeof window.forceRecolorAllRows === 'function') {
            console.log('ðŸ”„ Ejecutando forceRecolorAllRows...');
            window.forceRecolorAllRows();
          }
          
          // Mostrar muestra de colores aplicados
          setTimeout(() => {
            const sampleRows = Array.from(rows).slice(0, 3);
            sampleRows.forEach((row, i) => {
              const statusTd = row.children[8];
              if (statusTd) {
                console.log(`ðŸŽ¯ Fila ${i}:`, {
                  status: statusTd.textContent?.trim(),
                  backgroundColor: row.style.backgroundColor,
                  classes: Array.from(row.classList)
                });
              }
            });
            
            // Cambiar el color del botÃ³n para indicar que se ejecutÃ³
            debugColorsBtn.style.background = isDark ? '#4ade80' : '#ef4444';
            setTimeout(() => {
              debugColorsBtn.style.background = '#ff6b35';
            }, 1000);
          }, 150);
        });
      }

      // Conmutador Ver todos / Mis clientes
      function getRole() {
        try {
          const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          return (userData.role || userData?.usuario?.role || '').toString().toLowerCase().trim();
        } catch { return ''; }
      }
      

      
      function getForceAll() {
        const usp = new URLSearchParams(window.location.search);
        const v = (usp.get('forceAll') || '').toString().toLowerCase();
        return v === '1' || v === 'true' || v === 'yes';
      }
      function setForceAll(enabled) {
        const url = new URL(window.location.href);
        if (enabled) url.searchParams.set('forceAll', '1');
        else url.searchParams.delete('forceAll');
        window.location.href = url.toString();
      }
      // Mostrar botÂ¨Â®n solo para admin/supervisor/backoffice (no para agent)
      const role = getRole();
      // admin/backoffice/supervisor pueden ver el botÂ¨Â®n
      const allowed = new Set(['admin', 'supervisor', 'backoffice', 'b:o', 'b.o', 'b-o', 'bo', 'back office', 'back_office']);
      if (forceAllBtn) {
        if (allowed.has(role)) {
          forceAllBtn.style.display = 'inline-flex';
          const isForceAll = getForceAll();
          forceAllBtn.title = isForceAll ? 'Mis clientes' : 'Ver todos';
          if (isForceAll) forceAllBtn.classList.add('active');
          forceAllBtn.addEventListener('click', function() {
            setForceAll(!getForceAll());
          });
        } else {
          // Agente: oculto y aseguramos que no quede activo por URL
          forceAllBtn.style.display = 'none';
        }
      }

      // Resetear filtros residuales antes de cargar datos (evita listas reducidas por estados previos)
      try { window.supervisorAgentFilter = null; } catch(_) {}
      try { window.adminTeamFilter = null; } catch(_) {}

      // Por defecto: cargar SOLO el mes actual en la primera carga
      // (el usuario puede seleccionar "Todos los meses" manualmente)
      try {
        const monthFilterEl = document.getElementById('monthFilter');
        if (monthFilterEl) {
          const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
          const makeYm = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          const makeLabel = (d) => `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
          const baseOpt = monthFilterEl.options && monthFilterEl.options.length ? monthFilterEl.options[0] : null;
          monthFilterEl.innerHTML = '';
          if (baseOpt) monthFilterEl.appendChild(baseOpt);

          const now = new Date();
          const start = new Date(now.getFullYear(), now.getMonth(), 1);
          for (let i = 0; i < 18; i++) {
            const d = new Date(start.getTime());
            d.setMonth(start.getMonth() - i);
            const opt = document.createElement('option');
            opt.value = makeYm(d);
            opt.textContent = makeLabel(d);
            monthFilterEl.appendChild(opt);
          }
        }
        if (monthFilterEl && (!monthFilterEl.value || String(monthFilterEl.value).trim() === '')) {
          const now = new Date();
          const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

          // Si el mes actual no existe en el select (porque las opciones están hardcodeadas), agregarlo.
          const hasOption = Array.from(monthFilterEl.options || []).some(o => String(o.value) === currentMonth);
          if (!hasOption) {
            const opt = document.createElement('option');
            opt.value = currentMonth;
            try {
              const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
              const mm = Number(String(currentMonth).slice(5, 7));
              const yy = Number(String(currentMonth).slice(0, 4));
              opt.textContent = `${monthNames[Math.max(0, mm - 1)]} ${yy}`;
            } catch (_) {
              opt.textContent = currentMonth;
            }

            // Insertar despuÃ©s de "Todos los meses" si existe.
            if (monthFilterEl.options && monthFilterEl.options.length > 0) {
              monthFilterEl.insertBefore(opt, monthFilterEl.options[1] || null);
            } else {
              monthFilterEl.appendChild(opt);
            }
          }

          monthFilterEl.value = currentMonth;
          console.log('[INIT] monthFilter por defecto (mes actual):', currentMonth);
          
          // Para AGENTES: NO filtrar por mes por defecto (mostrar todos los clientes)
          try {
            const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
            const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
            const isAgente = ['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(roleRaw);
            
            if (isAgente) {
              // Para agentes: dejar filtro de mes vacío (sin filtro)
              monthFilterEl.value = '';
              console.log('[INIT] AGENTE: Sin filtro de mes - mostrando TODOS los clientes');
            }
          } catch (_) {}
        }
      } catch (e) {
        console.warn('[INIT] No se pudo inicializar monthFilter al mes actual:', e);
      }

      // Cargar datos iniciales
      console.log('[INIT] Cargando datos desde el servidor...');
      if (typeof fetchLeadsAgente === 'function') {
        fetchLeadsAgente().catch(err => {
          console.error('[INIT] Error cargando datos:', err);
        });
      } else {
        console.warn('[INIT] fetchLeadsAgente no está definido');
      }

      try {
        const pageInfoEl = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('pagePrev');
        const nextBtn = document.getElementById('pageNext');
        const pageSizeEl = document.getElementById('pageSizeSelect');

        const updatePageInfo = () => {
          const p = Number(window.__apiPage || window.__page || 1) || 1;
          const totalPages = Number(window.__totalPages || 1) || 1;
          if (pageInfoEl) pageInfoEl.textContent = `PÃ¡gina ${p} de ${totalPages}`;
          if (prevBtn) prevBtn.disabled = p <= 1;
          if (nextBtn) nextBtn.disabled = p >= totalPages;
        };

        if (prevBtn && !prevBtn.__bound) {
          prevBtn.__bound = true;
          prevBtn.addEventListener('click', async () => {
            const p = Number(window.__apiPage || window.__page || 1) || 1;
            const target = Math.max(1, p - 1);
            window.__page = target;
            await fetchLeadsAgente(target);
            updatePageInfo();
          });
        }
        if (nextBtn && !nextBtn.__bound) {
          nextBtn.__bound = true;
          nextBtn.addEventListener('click', async () => {
            const p = Number(window.__apiPage || window.__page || 1) || 1;
            const totalPages = Number(window.__totalPages || 1) || 1;
            const target = Math.min(totalPages, p + 1);
            window.__page = target;
            await fetchLeadsAgente(target);
            updatePageInfo();
          });
        }
        if (pageSizeEl && !pageSizeEl.__bound) {
          pageSizeEl.__bound = true;
          pageSizeEl.addEventListener('change', async () => {
            window.__page = 1;
            await fetchLeadsAgente(1);
            updatePageInfo();
          });
        }

        const originalFetchLeads = fetchLeadsAgente;
        if (!window.__paginationWrapped && typeof originalFetchLeads === 'function') {
          window.__paginationWrapped = true;
          window.fetchLeadsAgente = async function wrappedFetchLeadsAgente(page) {
            const r = await originalFetchLeads(page);
            try { updatePageInfo(); } catch (_) {}
            return r;
          };
        }
        updatePageInfo();
      } catch (e) {
        console.warn('[PAGINATION] Error inicializando paginaciÃ³n:', e?.message || e);
      }
    });
  </script>

  <script>
    // InicializaciÂ¨Â®n de UI: toggle compacto y refrescar tabla
    document.addEventListener('DOMContentLoaded', function() {
      // ...
    });

    let leadActual = null;

    function abrirComentarios(leadId) {
      try {
        leadActual = leadId;
        const modal = document.getElementById('comentariosModal');
        if (modal) modal.style.display = 'block';
        cargarComentarios(leadId);
      } catch (e) {
        console.error('abrirComentarios error:', e);
      }
    }

    function cerrarComentarios() {
      document.getElementById('comentariosModal').style.display = 'none';
      document.getElementById('nuevoComentario').value = '';
      const picker = document.getElementById('emojiPicker');
      if (picker) picker.style.display = 'none';
      leadActual = null;
    }

    async function cargarComentarios(leadId) {
      const container = document.getElementById('comentariosContainer');
      container.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
          <div style="text-align: center;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p style="margin-top: 10px; color: #666;">Cargando comentarios...</p>
          </div>
        </div>
      `;
      
      try {
        console.log('Solicitando comentarios para leadId:', leadId);
        
        let comments = [];
        
        // 1) Intentar obtener del backend si existe endpoint
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          const resp = await fetch(`/api/comments?leadId=${encodeURIComponent(leadId)}`, {
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            }
          });
          if (resp.ok) {
            const data = await resp.json();
            if (data && Array.isArray(data.comments)) {
              comments = data.comments;
            }
          }
        } catch (e) {
          console.warn('Fallo al obtener comentarios del backend, se usarÂ¨Â¢ cache/local:', e);
        }

        // 2) Mezclar con comentarios locales en cache (optimista)
        const cacheKey = `comments_cache_${leadId}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        if (Array.isArray(cached) && cached.length) {
          comments = [...comments, ...cached];
        }

        // 3) Si vacÂ¨Âªo, intentar inferir Â¨Â²ltimo comentario textual del lead para mostrar algo
        if ((!comments || comments.length === 0) && Array.isArray(window.ultimaListaLeads)) {
          const lead = window.ultimaListaLeads.find(l => (l._id || '') === leadId);
          if (lead && lead.comentarios_venta) {
            comments = [{
              autor: 'Sistema',
              fecha: new Date().toISOString(),
              texto: String(lead.comentarios_venta)
            }];
          }
        }

        // NormalizaciónÂ¨Â®n y render tipo chat
        const usuario = obtenerUsuarioActual();
        const mensajes = (comments || []).map(c => ({
          autor: c.autor || c.user || 'Desconocido',
          fecha: c.fecha || c.createdAt || new Date().toISOString(),
          texto: (c.texto ?? c.comment ?? '').toString()
        }));

        // ...
        let html = '';
        
        // Ordenar comentarios por fecha (mÂ¨Â¢s antiguos primero para chat natural)
        const comentariosOrdenados = [...mensajes].sort((a, b) => 
          new Date(a.fecha) - new Date(b.fecha)
        );
        
        // Render de cada burbuja estilo chat
        comentariosOrdenados.forEach(comentario => {
          const fecha = new Date(comentario.fecha);
          const fechaFormateada = fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          const esAgente = normalizarTexto(comentario.autor) === normalizarTexto(usuario);
          const lado = esAgente ? 'me' : 'other';
          const iniciales = obtenerIniciales(comentario.autor);
          html += `
            <div class="chat-message ${lado}" style="display:flex; gap:10px; margin-bottom:12px; align-items:flex-end; ${lado==='me' ? 'justify-content:flex-end;' : ''}">
              ${lado==='other' ? `
                <div class="chat-avatar" title="${escapeHtml(comentario.autor)}" style="width:28px; height:28px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; font-size:12px; color:#6c757d; flex-shrink:0;">${escapeHtml(iniciales)}</div>
              ` : ''}
              <div class="chat-bubble ${lado}" style="max-width:70%; padding:10px 12px; border-radius:14px; ${lado==='me' ? 'background:#e3f2fd; color:#0d47a1; border-top-right-radius:4px;' : 'background:#f1f3f5; color:#333; border-top-left-radius:4px;'}">
                <div class="chat-author-time" style="font-size:11px; color:${lado==='me' ? '#1565c0' : '#6c757d'}; margin-bottom:4px;">
                  ${escapeHtml(comentario.autor)} ? ${fechaFormateada}
                </div>
                <div class="chat-text" style="white-space:pre-wrap; word-wrap:break-word;">${escapeHtml(comentario.texto)}</div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html || `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">
            <div>
              <i class="fas fa-comments" style="font-size:28px; opacity:0.6;"></i>
              <p style="margin-top:8px;">Sin comentarios aÂ¨Â²n. ?SÂ¨Â¦ el primero en comentar!</p>
            </div>
          </div>
        `;

        // Hacer scroll al final (Â¨Â²ltimo mensaje visible)
        setTimeout(() => {
          try { container.scrollTop = container.scrollHeight; } catch(_e) {}
        }, 50);
  
      } catch (error) {
        console.error('Error al cargar comentarios:', error);
        const comentariosContainer = document.getElementById('comentariosContainer');
      }
    }

    async function agregarComentario() {
      const comentario = document.getElementById('nuevoComentario').value.trim();
      if (!comentario) return;
      
      const btnEnviar = document.querySelector('#comentariosModal button[onclick="agregarComentario()"]');
      const btnOriginalText = btnEnviar.innerHTML;
      const comentarioInput = document.getElementById('nuevoComentario');
      
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      
      try {
        console.log('Enviando comentario para leadId:', leadActual);
        const usuario = obtenerUsuarioActual();
        const nuevo = {
          autor: usuario || 'Yo',
          fecha: new Date().toISOString(),
          texto: comentario
        };

        // Optimista: agregar a cache local
        const cacheKey = `comments_cache_${leadActual}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        cached.push(nuevo);
        localStorage.setItem(cacheKey, JSON.stringify(cached));

        // Intentar enviar al backend si existe endpoint REST
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          const resp = await fetch(`/api/leads/${encodeURIComponent(leadActual)}/comentarios`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify(nuevo)
          });
          if (!resp.ok) {
            console.warn('POST /api/leads/:id/comentarios no disponible. Se mantiene en cache local.');
          }
        } catch (e) {
          console.warn('Fallo al enviar comentario al backend, se mantiene en cache local:', e);
        }

        // Limpiar input y recargar lista
        comentarioInput.value = '';
        await cargarComentarios(leadActual);

        // Actualizar columna de "Comentarios sobre la Venta" en la tabla
        if (typeof actualizarUltimoComentarioEnTabla === 'function') {
          actualizarUltimoComentarioEnTabla(leadActual, nuevo.texto);
        }
      } catch(error) {
        console.error('Error al agregar comentario:', error);
        const comentariosContainer = document.getElementById('comentariosContainer');
      } finally {
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = btnOriginalText;
      }
    }

    // Soporte de Emoji Picker
    function toggleEmojiPicker(event) {
      try {
        event?.stopPropagation?.();
        const picker = document.getElementById('emojiPicker');
        if (!picker) return;
        const isOpen = picker.style.display === 'block';
        picker.style.display = isOpen ? 'none' : 'block';
      } catch (e) {
        console.warn('toggleEmojiPicker error:', e);
      }
    }

    function insertAtCursor(textarea, text) {
      try {
        const start = textarea.selectionStart ?? textarea.value.length;
        const end = textarea.selectionEnd ?? textarea.value.length;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        textarea.value = before + text + after;
        const newPos = start + text.length;
        textarea.selectionStart = textarea.selectionEnd = newPos;
      } catch (e) {
        // Fallback: append
        textarea.value = (textarea.value || '') + text;
      }
    }

    function insertEmoji(emoji) {
      const ta = document.getElementById('nuevoComentario');
      if (!ta) return;
      ta.focus();
      insertAtCursor(ta, emoji);
      // cerrar picker tras insertar
      const picker = document.getElementById('emojiPicker');
      if (picker) picker.style.display = 'none';
    }

    // Cerrar picker al hacer click fuera
    document.addEventListener('click', function(e) {
      const picker = document.getElementById('emojiPicker');
      const toggleBtn = document.getElementById('emojiToggleBtn');
      if (!picker || picker.style.display !== 'block') return;
      const clickedInsidePicker = picker.contains(e.target);
      const clickedToggle = toggleBtn && (e.target === toggleBtn || toggleBtn.contains(e.target));
      if (!clickedInsidePicker && !clickedToggle) {
        picker.style.display = 'none';
      }
    });

    // FunciÂ¨Â®n para actualizar el Â¨Â²ltimo comentario en la tabla
    function actualizarUltimoComentarioEnTabla(leadId, comentario) {
      // Encontrar la fila del lead
      const filas = document.querySelectorAll('#costumer-tbody tr');
      
      filas.forEach(fila => {
        const botonEditar = fila.querySelector('button[onclick^="editarLead"]');
        if (botonEditar) {
          const idEnFila = botonEditar.getAttribute('onclick').match(/'([^']+)'/)[1];
          if (idEnFila === leadId) {
            // Actualizar la celda de comentarios
            const celdaComentarios = fila.querySelector('td:nth-last-child(2)');
            if (celdaComentarios) {
              // Mostrar solo los primeros 50 caracteres del comentario
              const textoCorto = comentario.length > 50 ? comentario.substring(0, 50) + '...' : comentario;
              celdaComentarios.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <span class="new-comment-dot" style="display: inline-block; width: 8px; height: 8px; background-color: #3498db; border-radius: 50%;"></span>
                    <span>${textoCorto}</span>
                  </div>
                  <button onclick="event.stopPropagation(); abrirComentarios('${leadId}')" class="action-btn" style="margin-top: 5px; padding: 2px 6px; font-size: 11px;">
                    <i class="fas fa-comment"></i> Ver todo
                  </button>
                </div>
              `;
            }
          }
        }
      });
    }

    // Cerrar el modal al hacer clic fuera del contenido
    window.onclick = function(event) {
      const modal = document.getElementById('comentariosModal');
      if (event.target == modal) {
        cerrarComentarios();
      }
    }

    // Variable global para almacenar los leads
    window.ultimaListaLeads = [];
    
    // NormalizaciónÂ¨Â®n de leads desde el backend a la estructura usada en frontend
    function escapeAttr(s) {
      try {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      } catch { return ''; }
    }
    function toISODateString(d) {
      try {
        if (!d) return '';
        // Date object
        if (d instanceof Date) return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0)).toISOString().split('T')[0];
        // NÃºmero timestamp (ms)
        if (typeof d === 'number') {
          const dt = new Date(d);
          if (!isNaN(dt.getTime())) return dt.toISOString().split('T')[0];
        }
        // Objetos que contienen fechas en campos comunes (Mongo { $date: ... }, createdAt, fecha)
        if (typeof d === 'object') {
          try {
            const cand = d.$date || d.date || d.createdAt || d.created_at || d.fecha || d.value;
            if (cand) {
              const dt = (typeof cand === 'number') ? new Date(cand) : new Date(cand);
              if (!isNaN(dt.getTime())) return dt.toISOString().split('T')[0];
            }
          } catch (_) {}
        }
        if (typeof d === 'string') {
          // Intentar YYYY-MM-DD
          if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
          const dt = new Date(d);
          if (!isNaN(dt.getTime())) return dt.toISOString().split('T')[0];
        }
      } catch (e) {
        console.warn('toISODateString error:', e, d);
      }
      return '';
    }

    // Helpers de identificadores
    function extractLeadId(raw) {
      if (!raw) return '';
      const oidBufferToHex = (bufObj) => {
        try {
          const b = bufObj && (bufObj.buffer || bufObj);
          if (!b || typeof b !== 'object') return '';
          const bytes = [];
          for (let i = 0; i < 12; i++) {
            if (b[i] === undefined) return '';
            const n = Number(b[i]);
            if (!Number.isFinite(n)) return '';
            bytes.push(n & 0xff);
          }
          return bytes.map(x => x.toString(16).padStart(2, '0')).join('');
        } catch { return ''; }
      };
      const pickHex24 = (v) => {
        try {
          if (v === null || v === undefined) return '';
          const s = String(v).trim();
          if (!s || s === '[object Object]') return '';
          const m = s.match(/[a-fA-F0-9]{24}/);
          return (m && m[0]) ? m[0] : '';
        } catch { return ''; }
      };
      const normalizeAnyId = (v) => {
        try {
          if (!v) return '';
          if (typeof v === 'string') {
            const s = v.trim();
            const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/);
            return m ? m[1] : pickHex24(s);
          }
          if (typeof v === 'number') return String(v);
          if (typeof v === 'object') {
            // BSON ObjectId serializado como {buffer:{0..11}}
            try {
              const hx = oidBufferToHex(v);
              if (hx && (/^[a-fA-F0-9]{24}$/).test(hx)) return hx;
            } catch (_) {}
            const inner = v.$oid || v.oid || v.id || v._id || v.value || v.Id;
            if (inner && inner !== v) return normalizeAnyId(inner);
            // casos raros: {_id:{'$oid':'...'}} ya cubiertos arriba; si aÃºn es objeto, intentar toString
            const s = (v && typeof v.toString === 'function') ? String(v.toString()) : '';
            const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/);
            return m ? m[1] : pickHex24(s);
          }
          return '';
        } catch { return ''; }
      };
      // Casos: {_id: '...'} | {_id: {$oid: '...'}} | {id: '...'}
      const _id = raw._id;
      if (typeof _id === 'string') return pickHex24(_id);
      if (_id && typeof _id === 'object') {
        if (typeof _id.$oid === 'string') return pickHex24(_id.$oid);
        if (typeof _id.oid === 'string') return pickHex24(_id.oid);
        const nid = normalizeAnyId(_id);
        if (nid) return nid;
      }
      if (typeof raw.id === 'string') return pickHex24(raw.id);
      if (typeof raw.leadId === 'string') return pickHex24(raw.leadId);
      if (typeof raw.lead_id === 'string') return pickHex24(raw.lead_id);
      if (typeof raw.leadID === 'string') return pickHex24(raw.leadID);
      try {
        // BÃºsqueda profunda (por si el backend devuelve {_id:{...}} en otros niveles)
        if (typeof deepFindByKey === 'function') {
          const deep = deepFindByKey(raw, ['_id', 'id', 'leadId', 'lead_id', '$oid', 'oid']);
          const nid = normalizeAnyId(deep);
          if (nid) return nid;
        }
      } catch (_) {}
      try {
        // Fallback final: buscar el _id en JSON por patrones comunes
        const json = JSON.stringify(raw);
        let m = json.match(/"_id"\s*:\s*\{\s*"\$oid"\s*:\s*"([a-fA-F0-9]{24})"/);
        if (m && m[1]) return m[1];
        m = json.match(/"_id"\s*:\s*"([a-fA-F0-9]{24})"/);
        if (m && m[1]) return m[1];
        // Ãšltimo recurso: cualquier $oid
        m = json.match(/"\$oid"\s*:\s*"([a-fA-F0-9]{24})"/);
        if (m && m[1]) return m[1];
      } catch (_) {}
      return '';
    }

    // Helper global utilizado por atributos inline
    function getLeadId(lead) {
      try {
        if (!lead) return '';
        const id = extractLeadId(lead);
        return typeof id === 'string' ? id : '';
      } catch {
        return '';
      }
    }

    // Helper: obtener propiedad por nombre (case-insensitive) desde obj y su _raw
    function getPropCI(obj, propName) {
      try {
        if (!obj || !propName) return undefined;
        const p = String(propName);
        if (p in obj) return obj[p];
        const lower = p.toLowerCase();
        const keys = Object.keys(obj || {});
        const hit = keys.find(k => k.toLowerCase() === lower);
        if (hit) return obj[hit];
        return undefined;
      } catch { return undefined; }
    }
    // Helper: bÂ¨Â²squeda profunda por clave (case-insensitive). Escanea objetos/arrays.
    function deepFindByKey(obj, candidates, opts = {}) {
      const MAX_DEPTH = typeof opts.maxDepth === 'number' ? opts.maxDepth : 4;
      const seen = new WeakSet();
      const candSet = new Set((candidates || []).map(c => String(c).toLowerCase()));
      function matchKey(k) {
        const kl = String(k).toLowerCase();
        if (candSet.has(kl)) return true;
        // TambiÂ¨Â¦n coincide si la variante upper/lower/cap es igual
        for (const c of candSet) {
          if (kl === c || kl === c.toUpperCase() || kl === c.toLowerCase()) return true;
        }
        return false;
      }
      function dfs(node, depth) {
        if (!node || depth > MAX_DEPTH) return undefined;
        if (typeof node !== 'object') return undefined;
        if (seen.has(node)) return undefined;
        seen.add(node);
        if (Array.isArray(node)) {
          for (const it of node) {
            const r = dfs(it, depth + 1);
            if (r != null && String(r).trim() !== '') return r;
          }
          return undefined;
        }
        // node es objeto
        for (const [k, v] of Object.entries(node)) {
          if (matchKey(k)) {
            if (v != null && String(v).trim() !== '') return v;
          }
        }
        for (const [, v] of Object.entries(node)) {
          const r = dfs(v, depth + 1);
          if (r != null && String(r).trim() !== '') return r;
        }
        return undefined;
      }
      return dfs(obj, 0);
    }
    function pickField(obj, candidates) {
      try {
        const tryList = [];
        (candidates || []).forEach(n => {
          tryList.push(n, String(n).toUpperCase(), String(n).toLowerCase(), n && (String(n).charAt(0).toUpperCase() + String(n).slice(1).toLowerCase()));
        });
        // Explorar objeto directo y su _raw si existe
        for (const name of tryList) {
          const v = getPropCI(obj, name);
          if (v != null && String(v).trim() !== '') return v;
        }
        if (obj && obj._raw) {
          for (const name of tryList) {
            const v = getPropCI(obj._raw, name);
            if (v != null && String(v).trim() !== '') return v;
          }
        }
        // BÂ¨Â²squeda profunda como Â¨Â²ltimo recurso (obj y _raw)
        const deep1 = deepFindByKey(obj, candidates);
        if (deep1 != null && String(deep1).trim() !== '') return deep1;
        if (obj && obj._raw) {
          const deep2 = deepFindByKey(obj._raw, candidates);
          if (deep2 != null && String(deep2).trim() !== '') return deep2;
        }
        return '';
      } catch { return ''; }
    }

    function normalizeLead(raw) {
      const lead = raw || {};
      // Mapear campos comunes provenientes del backend en MAY?SCULAS u otras variantes
      const fechaVenta = pickField(lead, ['dia_venta','FECHA','fecha_venta','fecha']);
      const fechaInst = pickField(lead, ['dia_instalacion','FECHA_INSTALACION','fecha_instalacion']);
      const puntaje = pickField(lead, ['puntaje','PUNTAJE','score']) || 0;
      const supervisor = pickField(lead, ['supervisor','SUPERVISOR','team','Team']);
      const tipoServicio = pickField(lead, ['tipo_servicios','tipo_servicio','SERVICIO','producto']);
      const serviciosTexto = pickField(lead, ['servicios_texto','SERVICIOS_TEXTO','servicio_texto','SERVICIO_TEXTO']);
      const id = extractLeadId(lead);
      // Intentar derivar "agente" desde varios posibles campos del backend
      const agente = (
        lead.agente ?? lead.AGENTE ?? lead.agent ?? lead.AGENT ??
        lead.vendedor ?? lead.VENDEDOR ?? lead.asesor ?? lead.ASESOR ??
        lead.owner ?? lead.OWNER ??
        ((lead.createdBy && (lead.createdBy.name || lead.createdBy.username)) ?? '')
      );

      return {
        // Campos de tabla esperados
        _id: id,
        nombre_cliente: lead.nombre_cliente || lead.NOMBRE || lead.cliente || lead.nombre || 'N/A',
        telefono_principal: lead.telefono_principal || lead.TELEFONO || lead.celular || lead.telefono || 'N/A',
        telefono_alterno: lead.telefono_alterno || lead.TELEFONO_ALTERNO || lead.telefono2 || '',
        numero_cuenta: lead.numero_cuenta || lead.CUENTA || lead.account || '',
        autopago: lead.autopago ?? lead.AUTOPAGO ?? '',
        direccion: lead.direccion || lead.DIRECCION || lead.address || '',
        tipo_servicios: (tipoServicio || ''),
        sistema: (pickField(lead, ['sistema','Sistema','SISTEMA','system','System']) || ''),
        riesgo: (pickField(lead, ['riesgo','Riesgo','RIESGO','risk','RISK']) || ''),
        dia_venta: fechaVenta ? toISODateString(fechaVenta) : '',
        dia_instalacion: fechaInst ? toISODateString(fechaInst) : '',
        status: lead.status || lead.STATUS || lead.estado || 'N/A',
        servicios_texto: (serviciosTexto || ''),
        servicios: (serviciosTexto || lead.servicios || lead.SERVICIOS || ''),
        mercado: (pickField(lead, ['mercado','Mercado','MERCADO','market','MARKET']) || ''),
        supervisor: supervisor || '',
        agente: agente || '',
        comentario: lead.comentario || lead.COMENTARIO || '',
        motivo_llamada: lead.motivo_llamada || lead.MOTIVO || '',
        zip_code: lead.zip_code || lead.zip || lead.ZIP || lead.cp || lead.codigo_postal || lead.postalCode || '',
        puntaje: Number(puntaje) || 0,
        comentarios_venta: lead.comentarios_venta || lead.COMENTARIOS || lead.comentarios || '',
        // Identificadores
        _id: id,
        id: id,
        // Preservar crudo para diagnÂ¨Â®stico/agrupaciÂ¨Â®n posterior
        _raw: lead,
        // Pasar posibles campos de IDs de agente y variantes (sin transformar) para facilitar detecciÂ¨Â®n aguas abajo
        agenteId: lead.agenteId || lead.AGENTEID || lead.agente_id || lead.AGENTE_ID || lead.idAgente || lead.IDAGENTE || lead.agentId || lead.AGENTID || lead.creadoPor || lead.CREADO_POR || lead.creado_por || lead.createdBy || lead.ownerId || lead.assignedId || '',
        agente_id: lead.agente_id || lead.AGENTE_ID || '',
        idAgente: lead.idAgente || lead.IDAGENTE || '',
        agentId: lead.agentId || lead.AGENTID || '',
        creadoPor: lead.creadoPor || lead.CREADO_POR || lead.creado_por || '',
        createdBy: lead.createdBy || '',
        ownerId: lead.ownerId || '',
        assignedId: lead.assignedId || '',
        // Pasar posibles campos de nombre de agente y variantes
        agenteNombre: lead.agenteNombre || lead.AGENTE_NOMBRE || lead.nombreAgente || lead.NOMBRE_AGENTE || lead.agente || lead.Agente || lead.agent || lead.Agent || lead.vendedor || lead.seller || lead.nombre_agente || lead.agente_nombre || lead.agentName || lead.salesAgent || lead.asignadoA || lead.asignado_a || lead.assignedTo || lead.assigned_to || lead.usuario || lead.owner || lead.registeredBy || '',
      };
    }

    function normalizeLeads(arr) {
      if (!Array.isArray(arr)) return [];
      return arr.map(normalizeLead);
    }

    // Zona horaria de negocio (America/Mexico_City = UTC-6)
    const BUSINESS_TIMEZONE = 'America/Mexico_City';

    // Helper: YYYY-MM-DD en TZ de negocio usando Intl.DateTimeFormat (mÃ¡s confiable)
    function toISOInTZ(date, tzOffsetMinutes) {
      try {
        const d = date instanceof Date ? date : new Date(date);
        if (isNaN(d)) return '';
        // Usar Intl.DateTimeFormat para obtener la fecha en la zona horaria correcta
        const formatter = new Intl.DateTimeFormat('en-CA', {
          timeZone: BUSINESS_TIMEZONE,
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        return formatter.format(d); // Retorna 'YYYY-MM-DD'
      } catch (e) {
        console.warn('[toISOInTZ] Error:', e);
        return '';
      }
    }

    // Para compatibilidad con cÃ³digo existente
    const BUSINESS_TZ_OFFSET_MIN = -6 * 60;

    // Wrapper: ISO YYYY-MM-DD usando la TZ de negocio
    function toLocalISO(date) {
      try {
        if (!date) return '';
        const d = date instanceof Date ? date : new Date(date);
        if (isNaN(d)) return '';
        return toISOInTZ(d, BUSINESS_TZ_OFFSET_MIN);
      } catch (_) {
        return '';
      }
    }

    // Helper: obtener fecha YYYY-MM-DD desde mÃºltiples campos (fallbacks)
    function getDateFromLead(lead) {
      try {
        if (!lead) return '';
        // Candidatos de fecha (en orden de prioridad)
        const candidates = [
          lead.dia_venta,
          lead.diaVenta,
          lead.dia_de_venta,
          lead.FECHA,
          lead.fecha_venta,
          lead.fechaVenta,
          lead.fecha_contratacion,
          lead.fechaContratacion,
          lead.fecha,
          lead.dia_instalacion,
          lead.diaInstalacion,
          lead.fecha_instalacion,
          lead.fechaInstalacion,
          lead.createdAt,
          lead.created_at,
          lead.creadoEn,
          lead.creado_en,
          lead.fecha_creacion,
          lead.fechaCreacion,
          lead.updatedAt,
          // Anidados en _raw
          lead._raw && (
            lead._raw.dia_venta || lead._raw.diaVenta || lead._raw.dia_de_venta ||
            lead._raw.FECHA || lead._raw.fecha_venta || lead._raw.fechaVenta ||
            lead._raw.fecha_contratacion || lead._raw.fechaContratacion || lead._raw.fecha ||
            lead._raw.dia_instalacion || lead._raw.diaInstalacion || lead._raw.fecha_instalacion || lead._raw.fechaInstalacion ||
            lead._raw.createdAt || lead._raw.creadoEn || lead._raw.fecha_creacion
          )
        ].filter(Boolean);
        const raw = candidates.length ? candidates[0] : null;
        if (!raw) return '';
        
        // Validar que el aÃ±o estÃ© en rango razonable (2024-2030)
        const isValidYear = (y) => y >= 2024 && y <= 2030;
        
        const toYMD = (d) => {
          const y = d.getFullYear();
          // Solo aceptar fechas entre 2024 y 2030
          if (!isValidYear(y)) return '';
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${y}-${m}-${day}`;
        };
        // Timestamps numÃ©ricos
        if (typeof raw === 'number') {
          const dt = new Date(raw);
          return isNaN(dt) ? '' : toYMD(dt);
        }
        // Cadenas
        if (typeof raw === 'string') {
          // ISO puro YYYY-MM-DD
          if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
            const year = parseInt(raw.slice(0,4), 10);
            return isValidYear(year) ? raw : '';
          }
          // 'YYYY-MM-DD HH:mm:ss' o similar (tomar solo prefijo YYYY-MM-DD)
          if (/^\d{4}-\d{2}-\d{2}\s+/.test(raw)) {
            const prefix = raw.slice(0, 10);
            const year = parseInt(prefix.slice(0,4), 10);
            return (/^\d{4}-\d{2}-\d{2}$/.test(prefix) && isValidYear(year)) ? prefix : '';
          }
          // 'YYYY/MM/DD'
          if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(raw)) {
            const [y, m, d] = raw.split('/').map(n => parseInt(n, 10));
            if (!isValidYear(y)) return '';
            const dt = new Date(y, m - 1, d);
            return isNaN(dt) ? '' : toYMD(dt);
          }
          // ISO con hora
          if (/^\d{4}-\d{2}-\d{2}T/.test(raw)) {
            const dt = new Date(raw);
            return isNaN(dt) ? '' : toYMD(dt);
          }
          // Formato D/M/YYYY o DD/MM/YYYY
          if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(raw)) {
            const [d, m, y] = raw.split('/').map(n => parseInt(n, 10));
            if (!isValidYear(y)) return '';
            const dt = new Date(y, m - 1, d);
            return isNaN(dt) ? '' : toYMD(dt);
          }
          // Formato en inglÃ©s tipo "Fri Nov 08 2025 ..." (toString/toDateString)
          if (/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s+[A-Za-z]{3}\s+\d{1,2}\s+\d{4}/.test(raw)) {
            const dt = new Date(raw);
            return isNaN(dt) ? '' : toYMD(dt);
          }
          // NO parsear otros strings arbitrarios - causa fechas incorrectas
          // Solo aceptar formatos reconocidos arriba
          return '';
        }
        // Objetos Date
        if (raw instanceof Date) {
          return toYMD(raw);
        }
        // Objetos con $date
        if (raw && typeof raw === 'object' && ('$date' in raw)) {
          const dt = new Date(raw.$date);
          return isNaN(dt) ? '' : toYMD(dt);
        }
        return '';
      } catch { return ''; }
    }

    function getSaleDateFromLead(lead) {
      try {
        if (!lead) return '';
        const candidates = [
          lead.dia_venta,
          lead.diaVenta,
          lead.dia_de_venta,
          lead.fecha_contratacion,
          lead.fechaContratacion,
          lead.fechaVenta,
          lead.fecha_venta,
          lead.saleDate,
          lead.sale_date,
          lead.fecha,
          lead.FECHA,
          lead.createdAt,
          lead.creadoEn,
          lead.updatedAt,
          lead._raw && (
            lead._raw.dia_venta || lead._raw.diaVenta || lead._raw.dia_de_venta ||
            lead._raw.FECHA || lead._raw.fecha_venta || lead._raw.fechaVenta ||
            lead._raw.fecha_contratacion || lead._raw.fechaContratacion || lead._raw.fecha ||
            lead._raw.createdAt || lead._raw.creadoEn || lead._raw.fecha_creacion
          )
        ].filter(Boolean);
        const raw = candidates.length ? candidates[0] : null;
        if (!raw) return '';
        return toLocalISO(raw);
      } catch { return ''; }
    }

    function getInstallDateFromLead(lead) {
      try {
        if (!lead) return '';
        const candidates = [
          lead.dia_instalacion,
          lead.diaInstalacion,
          lead.fecha_instalacion,
          lead.fechaInstalacion,
          lead._raw && (
            lead._raw.dia_instalacion || lead._raw.diaInstalacion || lead._raw.fecha_instalacion || lead._raw.fechaInstalacion
          )
        ].filter(Boolean);
        const raw = candidates.length ? candidates[0] : null;
        if (!raw) return '';
        return toLocalISO(raw);
      } catch { return ''; }
    }

    // Helpers globales para normalizar nombres de agente (disponibles fuera de IIFE)
    if (typeof window.__normStrAgent !== 'function') {
      window.__normStrAgent = function __normStrAgent(s){
        try { return String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase().replace(/\s+/g,'').replace(/\./g,''); }
        catch { return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/\./g,''); }
      };
    }
    if (typeof window.agentCanonicalName !== 'function') {
      window.agentCanonicalName = function agentCanonicalName(name){
        const n = window.__normStrAgent(name);
        const map = {
          'eduardor': 'Eduardo Rivas',
          'eduardorivas': 'Eduardo Rivas',
          'eduardorrivas': 'Eduardo Rivas',
          'alexanderhernandez': 'Riquelmi Torres',
          'juliomejia': 'Julio Chavez',
          'juliom': 'Julio Chavez'
        };
        return map[n] || (name || '');
      };
    }

    // Cargar leads del agente desde backend y actualizar UI
    let __page = 1;
    // __limit se define en window.__limit para que el selector lo pueda modificar
    let __hasMore = true;
    
    // Loading overlay helpers (non-blocking UI indicator) - GLOBAL para uso en fetchLeadsAgente
    function showLoadingOverlay(msg) {
      try {
        let el = document.getElementById('leadsLoadingOverlay');
        if (!el) {
          el = document.createElement('div');
          el.id = 'leadsLoadingOverlay';
          el.className = 'leads-loading-overlay';
          el.innerHTML = '<div class="spinner" aria-hidden="true"></div><div class="leads-loading-msg"></div>';
          document.body.appendChild(el);
        }
        const m = el.querySelector('.leads-loading-msg');
        if (m) m.textContent = msg || 'Cargando...';
        el.style.display = 'flex';
      } catch (e) { /* noop */ }
    }
    function updateLoadingOverlay(msg) {
      try { const el = document.getElementById('leadsLoadingOverlay'); if (el) { const m = el.querySelector('.leads-loading-msg'); if (m) m.textContent = msg || m.textContent; } } catch(e){}
    }
    function hideLoadingOverlay() {
      try { const el = document.getElementById('leadsLoadingOverlay'); if (el) el.style.display = 'none'; } catch(e){}
    }

    // Helper para intentar cargar datos pre-calentados del login
    async function tryLoadFromPrecachedData() {
      try {
        const cached = sessionStorage.getItem('allPagesData');
        const cachedTime = sessionStorage.getItem('allPagesTimestamp');
        const cachedUserId = sessionStorage.getItem('allPagesUserId');
        
        if (!cached || !cachedTime) {
          console.log('[COSTUMER-CACHE] No hay datos precacheados disponibles');
          return null;
        }

        // Validar que el usuario no haya cambiado
        try {
          const currentUserRes = await fetch('/api/auth/verify', { credentials: 'include' });
          if (currentUserRes.ok) {
            const currentUserData = await currentUserRes.json();
            const currentUserId = currentUserData.user?._id || currentUserData.user?.id || 'unknown';
            if (cachedUserId && cachedUserId !== String(currentUserId)) {
              console.log('[COSTUMER-CACHE] âš ï¸ Usuario cambiÃ³, limpiando cache', { antes: cachedUserId, ahora: currentUserId });
              sessionStorage.removeItem('allPagesData');
              sessionStorage.removeItem('allPagesTimestamp');
              sessionStorage.removeItem('allPagesUserId');
              return null;
            }
          }
        } catch (e) {
          console.warn('[COSTUMER-CACHE] Error validando usuario:', e?.message);
          // En caso de error, permitir usar el cache de todas formas
        }

        const now = new Date();
        const cachedDate = new Date(cachedTime);
        const ttl = 5 * 60 * 1000; // 5 minutos
        
        if ((now - cachedDate) > ttl) {
          console.log('[COSTUMER-CACHE] Cache expirado, ignorando');
          return null;
        }

        const data = JSON.parse(cached);
        if (!data.customers || !Array.isArray(data.customers)) {
          console.log('[COSTUMER-CACHE] Datos precacheados invÃ¡lidos');
          return null;
        }

        console.log('[COSTUMER-CACHE] âœ… Usando datos precacheados:', {
          customers: data.customers.length,
          timestamp: cachedTime,
          age: Math.round((now - cachedDate) / 1000) + 's'
        });

        return data.customers;
      } catch (e) {
        console.warn('[COSTUMER-CACHE] Error leyendo cache:', e?.message);
        return null;
      }
    }

    async function fetchLeadsAgente(page = __page) {
      console.log('[fetchLeadsAgente] Iniciando carga de datos...');
      console.log('[fetchLeadsAgente] User role:', JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}').role);
      console.log('[fetchLeadsAgente] Month filter:', document.getElementById('monthFilter')?.value);
      
      // âš ï¸ VALIDACIÃ“N CRÃTICA: Limpiar cache si el usuario cambiÃ³
      try {
        const currentUser = (JSON.parse(localStorage.getItem('user') || '{}') || {}).nombre || 
                           (JSON.parse(sessionStorage.getItem('user') || '{}') || {}).nombre || 'unknown';
        const cachedUser = sessionStorage.getItem('__cachedUser');
        if (cachedUser && cachedUser !== currentUser) {
          console.warn('[fetchLeadsAgente] âš ï¸ USUARIO CAMBIÃ“ de', cachedUser, 'a', currentUser);
          console.log('[fetchLeadsAgente] ðŸ—‘ï¸ Limpiando cache completo...');
          sessionStorage.removeItem('allPagesData');
          sessionStorage.removeItem('__cachedUser');
          localStorage.removeItem('allPagesData');
        } else if (!cachedUser && currentUser !== 'unknown') {
          sessionStorage.setItem('__cachedUser', currentUser);
        }
      } catch (e) {
        console.warn('[fetchLeadsAgente] Error validando usuario:', e);
      }
      
      try {
        // Si hay un mes seleccionado, NO usar cache precalentado (normalmente solo contiene el mes actual)
        const __monthFilterEl = document.getElementById('monthFilter');
        const uiMonthRaw = (__monthFilterEl && __monthFilterEl.value) ? String(__monthFilterEl.value).trim() : '';
        const uiMonthLc = uiMonthRaw.toLowerCase();
        const uiMonth = (uiMonthLc === '' || uiMonthLc.includes('todos')) ? '' : uiMonthRaw;
        const stateMonth = (() => {
          try {
            const m = (window && window.__selectedMonth) ? String(window.__selectedMonth || '').trim() : '';
            return /^\d{4}-\d{2}$/.test(m) ? m : '';
          } catch { return ''; }
        })();
        const effectiveSelectedMonth = uiMonth || stateMonth;
        try { window.__selectedMonth = effectiveSelectedMonth || ''; } catch (_) {}
        const __bypassPrecache = !!effectiveSelectedMonth;

        // FAST PATH: Intentar cargar desde cache precalentado en login
        const cachedCustomers = null;
        if (cachedCustomers && cachedCustomers.length > 0) {
          console.log('[fetchLeadsAgente] ðŸš€ Renderizando desde cache precalentado');
          // Usar los datos precacheados directamente
          let leadsRaw = cachedCustomers;
          let normalizedLeads = normalizeLeads(leadsRaw);
          console.log('[fetchLeadsAgente] normalizedLeads.length =', (normalizedLeads && normalizedLeads.length) || 0);
          
          // Renderizar inmediatamente
          if (typeof renderCostumerTable === 'function') {
            renderCostumerTable(normalizedLeads);
          }
          
          // Actualizar los KPIs con los datos del cache
          updateSummaryCards((window.__kpiLeadsLast && window.__kpiLeadsLast.length) ? window.__kpiLeadsLast : normalizedLeads);
          
          // Cargar columnas adicionales si están disponibles
          try {
            if (typeof initializeSpecialColumns === 'function') initializeSpecialColumns();
          } catch (e) { /* no-op */ }

          console.log('[fetchLeadsAgente] âœ… Datos renderizados desde cache');
          return; // âœ… NO hacer request al servidor
        }

        // FALLBACK: Si no hay cache, hacer request normal al servidor
        console.log('[fetchLeadsAgente] Cache no disponible, fetching desde servidor...');
        
        // Usar cookies para autenticaciÃ³n (mÃ©todo actual del sistema)
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const fetchOptions = {
          method: 'GET',
          credentials: 'include',
          headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': `Bearer ${token}` } : {})
        };

        // Detectar si es usuario Team LÃ­neas
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        const role = (function normalizeRole(r){
          if (!r) return 'agente';
          if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
          if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
          if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
          if (['backoffice','back office','back_office','bo','b.o','b:o','b-o'].includes(r)) return 'backoffice';
          return r;
        })(roleRaw);
        const username = (userData.username || userData?.usuario?.username || '').toString().trim().toLowerCase();
        const isTeamLineasUser = role === 'teamlineas' || username.startsWith('lineas-') || username.includes('lineas');
        const isSupervisorUser = role === 'supervisor';

        // Definir variables para el fetch
        const fetchTimeoutMs = 60000;
        const forceAll = new URLSearchParams(window.location.search).get('forceAll') === '1';
        const alreadyFilteredByAgent = false;

        // PaginaciÃ³n server-side: por rendimiento se capea a 100 por pÃ¡gina
        const pageSizeEl = document.getElementById('pageSizeSelect');
        const pageSizeRaw = pageSizeEl ? parseInt(pageSizeEl.value, 10) : 100;
        const pageSize = Math.max(1, Math.min(5000, Number.isFinite(pageSizeRaw) ? pageSizeRaw : 100));
        
        // Para AGENTES sin filtro de mes: forzar carga de TODOS (limit=10000)
        let actualPageSize = pageSize;
        if (role === 'agente' && !effectiveSelectedMonth) {
          actualPageSize = 10000;
          console.log('[fetchLeadsAgente] AGENTE sin mes: forzando limit=10000 para cargar todos los clientes');
        }
        
        window.__limit = actualPageSize;
        __page = Math.max(1, parseInt(page, 10) || 1);
        window.__page = __page;

        let url = isTeamLineasUser ? '/api/lineas' : `/api/leads?page=${encodeURIComponent(__page)}&limit=${encodeURIComponent(actualPageSize)}`;

        try {
          if (!isTeamLineasUser && effectiveSelectedMonth) {
            url += `&month=${encodeURIComponent(effectiveSelectedMonth)}`;
          } else if (!isTeamLineasUser && !effectiveSelectedMonth && !role === 'agente') {
            url += `&noAutoMonth=1`;
          } else if (!isTeamLineasUser && !effectiveSelectedMonth && role === 'agente') {
            // Para AGENTES sin filtro de mes: cargar TODOS sus clientes
            const agentName = (userData.nombre || userData.name || userData.username || userData?.usuario?.nombre || userData?.usuario?.name || userData?.usuario?.username || '').toString().trim();
            if (agentName) {
              url += `&agentName=${encodeURIComponent(agentName)}`;
              console.log('[fetchLeadsAgente] AGENTE sin mes: cargando todos los clientes del agente', agentName);
            }
          }

          // Para supervisor: filtrar por agenteNombre usando lista del equipo o un agente seleccionado
          if (!isTeamLineasUser && isSupervisorUser) {
            const agentDropdown = document.getElementById('agentFilter');
            const selectedAgent = agentDropdown ? String(agentDropdown.value || '').trim() : '';
            if (selectedAgent) {
              url += `&agentName=${encodeURIComponent(selectedAgent)}`;
            } else {
              try {
                const supName = (userData.username || userData.name || userData.nombre || '').toString().trim();
                const teamsApi = window && window.Teams;
                const agents = (teamsApi && typeof teamsApi.getAgentsBySupervisor === 'function') ? (teamsApi.getAgentsBySupervisor(supName) || []) : [];
                if (Array.isArray(agents) && agents.length) {
                  url += `&agents=${encodeURIComponent(agents.join(','))}`;
                }
              } catch (_) {}
            }
          }
        } catch(_) {}

        if (forceAll) console.warn('[fetchLeadsAgente] forceAll=1 activo: NO se aplica filtrado por agente (backend ni frontend)');
        console.log('[fetchLeadsAgente] URL solicitada:', url, 'alreadyFilteredByAgent=', alreadyFilteredByAgent, 'forceAll=', forceAll);
        // Mostrar overlay de carga
        try { showLoadingOverlay('Cargando clientes...'); } catch(_){ }

        // AbortController para timeout
        const controller = new AbortController();
        fetchOptions.signal = controller.signal;
        const to = setTimeout(()=>{ try{ controller.abort(); }catch(_){ } }, fetchTimeoutMs);
        let response = null;
        try {
          response = await fetch(url, fetchOptions);
        } catch (err) {
          if (err.name === 'AbortError') {
            console.warn('[fetchLeadsAgente] Fetch aborted due to timeout');
            try { hideLoadingOverlay(); } catch(_){}
            return;
          }
          throw err;
        } finally {
          clearTimeout(to);
        }
        if (response.status === 429) { await new Promise(r=>setTimeout(r, 600)); response = await fetch(url, fetchOptions); }
        console.log(`[fetchLeadsAgente] Response status: ${response.status}, headers:`, response.headers);
        
        if (!response.ok) {
          console.warn('[fetchLeadsAgente] Respuesta no OK del backend:', response.status);
          const errorText = await response.text();
          console.warn('[fetchLeadsAgente] Error response body:', errorText.substring(0, 200));
        }
        
        let data = null;
        let metaFromWorker = null;
        // Medir tiempo de parseo (response.json()/JSON.parse)
        let parseStart = null, parseEnd = null;
        try {
          try { updateLoadingOverlay('Parseando respuesta...'); } catch(_){ }
          const ct = (response.headers.get('content-type')||'').toLowerCase();
          parseStart = (performance && performance.now) ? performance.now() : Date.now();
          // Usar Web Worker para parsear JSON y evitar bloquear el hilo principal
          let responseText = null;
          try {
            responseText = await response.text();
          } catch (e) {
            console.warn('[fetchLeadsAgente] No se pudo leer response.text():', e?.message);
          }

          try { updateLoadingOverlay('Parseando respuesta (worker)...'); } catch(_){ }

          try {
            // Intentar parseo en worker
            let parsedFromWorker = null;
            let workerError = null;
            if (typeof Worker !== 'undefined') {
              const worker = new Worker('/js/parseWorker.js');
              const parsedAccum = [];
              await new Promise((resolve) => {
                const onMsg = (ev) => {
                  const d = ev.data || {};
                  if (d.type === 'chunk' && Array.isArray(d.chunk)) {
                    parsedAccum.push(...d.chunk);
                    try { updateLoadingOverlay(`Parseado ${parsedAccum.length} items...`); } catch(_){ }
                  } else if (d.type === 'meta') {
                    metaFromWorker = d.meta || null;
                  } else if (d.type === 'done') {
                    worker.removeEventListener('message', onMsg);
                    try { worker.terminate(); } catch(_){ }
                    parsedFromWorker = parsedAccum;
                    resolve();
                  } else if (d.type === 'error') {
                    worker.removeEventListener('message', onMsg);
                    try { worker.terminate(); } catch(_){ }
                    workerError = d.message || 'worker error';
                    resolve();
                  }
                };
                worker.addEventListener('message', onMsg);
                worker.postMessage({ text: responseText });
              });
            }

            if (workerError) {
              console.warn('[fetchLeadsAgente] Worker parse error:', workerError);
              try { data = JSON.parse(responseText); } catch (e) { data = parsedFromWorker || null; }
            } else if (parsedFromWorker !== null) {
              data = parsedFromWorker;
            } else {
              try { data = JSON.parse(responseText); } catch (e) { data = null; }
            }

            // Si la respuesta del backend es un objeto JSON (p.ej. /api/leads -> {success,data,total,page,pages}),
            // preferir parseo normal para NO perder metadata de paginaciÃ³n.
            try {
              const trimmed = String(responseText || '').trim();
              if (trimmed && trimmed[0] === '{') {
                const parsedObj = JSON.parse(trimmed);
                if (parsedObj && typeof parsedObj === 'object' && !Array.isArray(parsedObj)) {
                  data = parsedObj;
                }
              }
            } catch (_) {}
          } catch (e) {
            console.warn('[fetchLeadsAgente] Error usando Web Worker para parseo:', e?.message);
            try { data = responseText ? JSON.parse(responseText) : null; } catch (pe) { data = null; }
          }

          parseEnd = (performance && performance.now) ? performance.now() : Date.now();
          try { hideLoadingOverlay(); } catch(_){ }
        } catch (e) {
          console.warn('[fetchLeadsAgente] No se pudo parsear JSON de respuesta:', e?.message);
          parseEnd = (performance && performance.now) ? performance.now() : Date.now();
          try { hideLoadingOverlay(); } catch(_){}
        }
        // Normalizar respuesta: el worker puede haber devuelto un array y meta en `metaFromWorker`
        let apiArray = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : (Array.isArray(data?.leads) ? data.leads : []));
        let apiMeta = null;
        if (Array.isArray(data)) {
          apiMeta = (typeof metaFromWorker !== 'undefined' && metaFromWorker) ? metaFromWorker : null;
        } else if (data && typeof data === 'object') {
          apiMeta = { page: data.page || data.pagination?.page || 1, pages: data.pages || data.pagination?.totalPages || 1, total: data.total || data.pagination?.total || (Array.isArray(data.data) ? data.data.length : 0) };
        }

        console.log('[fetchLeadsAgente] Datos recibidos (resumen):', { tipo: Array.isArray(apiArray) ? 'array' : typeof data, len: apiArray.length, meta: apiMeta });

        // Exponer metadatos de paginaciÃ³n en window para que la UI pueda usar paginaciÃ³n del servidor
        try {
          const meta = apiMeta || {};
          window.__apiPage = Number(meta.page) || Number(data?.page) || __page || 1;
          window.__totalPages = Number(meta.pages) || Number(data?.pages) || 1;
          window.__totalCount = Number(meta.total) || Number(data?.total) || (Array.isArray(apiArray) ? apiArray.length : 0);
        } catch(_) {
          window.__apiPage = __page || 1;
          window.__totalPages = 1;
          window.__totalCount = Array.isArray(apiArray) ? apiArray.length : 0;
        }

        // Refrescar UI de paginaciÃ³n (evita quedar en "PÃ¡gina 1 de 1" si el callback externo no se ejecuta)
        try {
          const pageInfoEl = document.getElementById('pageInfo');
          const prevBtn = document.getElementById('pagePrev');
          const nextBtn = document.getElementById('pageNext');
          const p = Number(window.__apiPage || window.__page || 1) || 1;
          const totalPages = Number(window.__totalPages || 1) || 1;
          if (pageInfoEl) pageInfoEl.textContent = `PÃ¡gina ${p} de ${totalPages}`;
          if (prevBtn) prevBtn.disabled = p <= 1;
          if (nextBtn) nextBtn.disabled = p >= totalPages;
        } catch (_) {}

          // Debug especÃ­fico: conteo por mes (para diagnÃ³stico) â€” usar campo precomputado si existe
          if (Array.isArray(apiArray)) {
            const datesByMonth = {};
            apiArray.forEach(item => {
              const iso = item && item.__isoDate ? item.__isoDate : getDateFromLead(item);
              const ym = iso ? iso.slice(0,7) : 'sin-fecha';
              datesByMonth[ym] = (datesByMonth[ym] || 0) + 1;
            });
            console.log('[fetchLeadsAgente] DATOS DE API - Conteo por mes:', datesByMonth);
          }

        // Extraer datos segÃºn el endpoint (usaremos apiArray)
        let leadsRaw = [];
        const extractArray = (d) => Array.isArray(d)
            ? d
            : (Array.isArray(d?.data) ? d.data : (Array.isArray(d?.leads) ? d.leads : []));
        if (isTeamLineasUser) {
          // /api/lineas suele responder en data.data
          leadsRaw = apiArray.slice();
        } else {
          // /api/customers o /api/leads pueden responder en data, leads o array directo
          leadsRaw = apiArray.slice();
        }

        try {
          const monthFilterEl = document.getElementById('monthFilter');
          const selectedMonthUi = monthFilterEl ? String(monthFilterEl.value || '').trim() : '';
          const selectedMonthFromState = (() => {
            try {
              const m1 = (typeof __selectedMonth !== 'undefined') ? String(__selectedMonth || '').trim() : '';
              if (m1 && /^\d{4}-\d{2}$/.test(m1)) return m1;
            } catch (_) {}
            try {
              const m2 = (window && window.__selectedMonth) ? String(window.__selectedMonth || '').trim() : '';
              if (m2 && /^\d{4}-\d{2}$/.test(m2)) return m2;
            } catch (_) {}
            return '';
          })();
          const effectiveSelectedMonth = (selectedMonthUi && /^\d{4}-\d{2}$/.test(selectedMonthUi)) ? selectedMonthUi : selectedMonthFromState;
          const shouldFetchCushion = (!isTeamLineasUser && effectiveSelectedMonth && /^\d{4}-\d{2}$/.test(effectiveSelectedMonth));
          if (shouldFetchCushion) {
            const [yy, mm] = effectiveSelectedMonth.split('-').map(Number);
            let prevY = yy;
            let prevM = mm - 1;
            if (prevM < 1) { prevM = 12; prevY = yy - 1; }
            const prevMonthUi = `${String(prevY).padStart(4,'0')}-${String(prevM).padStart(2,'0')}`;

            const replaceMonthParam = (u, newMonth) => {
              try {
                const encoded = encodeURIComponent(newMonth);
                if (/[?&]month=/.test(u)) {
                  return u.replace(/([?&]month=)[^&]*/i, `$1${encoded}`);
                }
                return u + `&month=${encoded}`;
              } catch {
                return u;
              }
            };

            const prevUrl = replaceMonthParam(url, prevMonthUi);
            console.log('[fetchLeadsAgente] Colchón: mesActual=', effectiveSelectedMonth, 'mesAnterior=', prevMonthUi, 'url=', prevUrl);
            const prevRes = await fetch(prevUrl, fetchOptions);
            let prevData = null;
            try { prevData = await prevRes.json(); } catch { prevData = null; }
            const prevArr = Array.isArray(prevData) ? prevData : (Array.isArray(prevData?.data) ? prevData.data : (Array.isArray(prevData?.leads) ? prevData.leads : []));

            if (Array.isArray(prevArr) && prevArr.length) {
              const keyOf = (it) => {
                try {
                  const id = (it && (it._id || it.id || it.leadId || it.customerId)) ? String(it._id || it.id || it.leadId || it.customerId) : '';
                  if (id) return `id:${id}`;
                  const cuenta = (it?.numero_cuenta ?? it?._raw?.numero_cuenta ?? '') ? String(it?.numero_cuenta ?? it?._raw?.numero_cuenta ?? '').trim() : '';
                  const tel = (it?.telefono_principal ?? it?._raw?.telefono_principal ?? '') ? String(it?.telefono_principal ?? it?._raw?.telefono_principal ?? '').trim() : '';
                  const nom = (it?.nombre_cliente ?? it?._raw?.nombre_cliente ?? '') ? String(it?.nombre_cliente ?? it?._raw?.nombre_cliente ?? '').trim() : '';
                  const dv = (it?.dia_venta ?? it?._raw?.dia_venta ?? it?.fecha ?? it?._raw?.fecha ?? '') ? String(it?.dia_venta ?? it?._raw?.dia_venta ?? it?.fecha ?? it?._raw?.fecha ?? '').trim() : '';
                  return `f:${cuenta}|${tel}|${nom}|${dv}`;
                } catch {
                  return '';
                }
              };
              const seen = new Set();
              const merged = [];
              const pushUnique = (it) => {
                const k = keyOf(it);
                if (!k) return;
                if (seen.has(k)) return;
                seen.add(k);
                merged.push(it);
              };
              (leadsRaw || []).forEach(pushUnique);
              prevArr.forEach(pushUnique);
              leadsRaw = merged;
              console.log('[fetchLeadsAgente] Colchón: merge completado. mesActual=', (apiArray||[]).length, 'mesAnterior=', prevArr.length, 'merge=', leadsRaw.length);
            }
          }
        } catch (e) {
          console.warn('[fetchLeadsAgente] Colchón: error al cargar/merge mes anterior:', e?.message || e);
        }

        // PaginaciÃ³n server-side: no auto-cargar pÃ¡ginas adicionales (evita sobrecarga)

        // Debug adicional: si no hay leads, volcar un resumen de la respuesta para diagnÃ³stico
        try {
          const maybeCount = Array.isArray(leadsRaw) ? leadsRaw.length : (Array.isArray(data?.data)?data.data.length:(Array.isArray(data?.leads)?data.leads.length:0));
          if (!maybeCount) {
            try { console.warn('[fetchLeadsAgente][DEBUG] respuesta vacÃ­a. url=', url, 'responseStatus=', response && response.status); } catch(_){}
            try { console.warn('[fetchLeadsAgente][DEBUG] data sample:', JSON.stringify(data).slice(0,500)); } catch(_){}
          }
        } catch(_){}

        // Preparar mediciÃ³n de render: escuchamos evento 'leads:rendered' disparado por renderRows
        const renderStart = (performance && performance.now) ? performance.now() : Date.now();
        const onRendered = () => {
          const renderEnd = (performance && performance.now) ? performance.now() : Date.now();
          try{
            window.__fetchTimings = window.__fetchTimings || [];
            window.__fetchTimings.push({
              url,
              type: 'detailed',
              parseMs: (parseStart != null && parseEnd != null) ? Math.round((parseEnd-parseStart)*100)/100 : null,
              renderMs: Math.round((renderEnd-renderStart)*100)/100,
              count: Array.isArray(leadsRaw) ? leadsRaw.length : (Array.isArray(data?.data)?data.data.length:(Array.isArray(data?.leads)?data.leads.length:0)),
              time: (new Date()).toISOString()
            });
          }catch(_){}
          try{ document.removeEventListener('leads:rendered', onRendered); }catch(_){}
        };
        document.addEventListener('leads:rendered', onRendered);

        // OPTIMIZACIÃ“N: /api/leads ya retorna los clientes, no necesita segundo request
        console.log('[fetchLeadsAgente] Usando datos de /api/leads Ãºnicamente (sin /api/customers duplicado)');

        // OPTIMIZACIÃ“N: Si /api/leads?limit=50000 no retorna datos, es un problema real
        // No recurrir a fallbacks con limits menores (si no hay datos con 50k, no habrÃ¡ con 1k)
        if (!isTeamLineasUser && (!Array.isArray(leadsRaw) || leadsRaw.length === 0)) {
          console.log('[fetchLeadsAgente] âš ï¸ No hay datos en /api/leads. Fallback final: intento por user ID/name Ãºnicamente');
          try {
            const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
            const ids = [userData._id, userData.id, userData.userId, userData.uid, userData?.usuario?._id, userData?.usuario?.id]
              .map(v => (v && String(v).trim()) || '')
              .filter(Boolean);
            const names = [userData.username, userData.name, userData.nombre, userData?.usuario?.username, userData?.usuario?.name, userData?.usuario?.nombre]
              .map(v => (v && String(v).trim()) || '')
              .filter(Boolean);
            let acc = [];
            
            // Fallback ÃšNICO: intentar por ID primero (mÃ¡s confiable)
            if (ids.length > 0) {
              for (const id of ids) {
                const byId = await fetchLeadsByAgentId(id);
                if (Array.isArray(byId) && byId.length) { acc = byId; break; }
              }
            }
            
            // Si no encontró por ID, intentar por nombre (Ãºltimo resort)
            if (!acc.length && names.length > 0) {
              for (const nm of names) {
                const byName = await fetchLeadsByAgentName(nm);
                if (Array.isArray(byName) && byName.length) { acc = byName; break; }
              }
            }
            
            if (acc.length) {
              console.warn('[fetchLeadsAgente] Fallback ID/nombre aplicado. Leads recuperados:', acc.length);
              normalizedLeads = normalizeLeads(acc);
            }
          } catch (e) {
            console.warn('[fetchLeadsAgente] Error en fallback ID/nombre:', e?.message);
          }
        }

        // OPTIMIZACIÃ“N: Con limit=50000, el backend retorna TODO en una sola pÃ¡gina
        // Si totalPages > 1, algo está mal en el backend (exceso de datos)
        // No hacer paginaciÃ³n manual: es un anti-patrÃ³n
        try {
          const totalPages = Number(data?.pages || data?.pagination?.totalPages || 1);
          const currentPage = Number(data?.page || data?.pagination?.page || 1);
          if (totalPages > 1) {
            console.warn(`[fetchLeadsAgente] API retorna ${totalPages} pÃ¡ginas. Backend debe aumentar limit. Usando pÃ¡gina 1 solamente.`);
          }
        } catch (e) { /* no-op */ }

        // FALLBACK DESHABILITADO: Ya no se usan datos de prueba
        // Solo se muestran datos reales de la base de datos
        if (!Array.isArray(leadsRaw) || leadsRaw.length === 0) {
          console.log('[fetchLeadsAgente] No se encontraron datos reales en la API');
          leadsRaw = [];
        }

        console.log('[fetchLeadsAgente] leadsRaw.length =', (leadsRaw && leadsRaw.length) || 0);
        let normalizedLeads = normalizeLeads(leadsRaw);
        console.log('[fetchLeadsAgente] normalizedLeads.length =', (normalizedLeads && normalizedLeads.length) || 0);

        // Fallback urgente: si no llegan datos y es Stefani, inyectar sus 6 ventas para visualizaciÃ³n inmediata
        try {
          const u = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const myId = String(u.id || u._id || u?.usuario?._id || '').trim();
          const myName = String(u.username || u.name || u.nombre || '').trim().toLowerCase();
          const isStefani = myId === '68af41d0c61c405e2bb7b0c8' || myName === 'stefani martinez';
          if (isStefani && (!Array.isArray(normalizedLeads) || normalizedLeads.length === 0)) {
            const agenteId = '68af41d0c61c405e2bb7b0c8';
            const agenteNombre = 'Stefani Martinez';
            const seed = [
              { nombre_cliente:'YESSICA SOLANO', telefono_principal:'6158945285', telefono_alterno:'341292657', numero_cuenta:'', autopago:'SI', direccion:'916 Strand Fleet Dr Antioch TN 37013', tipo_servicios:'INTERNET', sistema:'SARA', riesgo:'HIGH', dia_venta:'2025-10-05', dia_instalacion:'2025-10-09', status:'ACTIVE', servicios_texto:'ATT 300 - 500 MB', mercado:'ICON', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'37013', puntaje:1.25 },
              { nombre_cliente:'ALMA PELCASTRE', telefono_principal:'6303799455', telefono_alterno:'', numero_cuenta:'251013487881718', autopago:'SI', direccion:'5916 W Montrose Ave Chicago IL 60634 APT 2', tipo_servicios:'XFINTY', sistema:'N/A', riesgo:'N/A', dia_venta:'2025-10-13', dia_instalacion:'2025-10-17', status:'ACTIVE', servicios_texto:'XFINTY 500MBPS+', mercado:'ICON', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'60634', puntaje:0.75 },
              { nombre_cliente:'ANDRES VEGA', telefono_principal:'2542527389', telefono_alterno:'553864003665', numero_cuenta:'', autopago:'SI', direccion:'207 S 4th St Rosebud TX 76570', tipo_servicios:'AT&T AIR', sistema:'SARA', riesgo:'HIGH', dia_venta:'2025-10-15', dia_instalacion:'2025-10-17', status:'ACTIVE', servicios_texto:'ATT AIR', mercado:'BAMO', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'76570', puntaje:0.35 },
              { nombre_cliente:'JOSE TAVAREZ', telefono_principal:'4848388586', telefono_alterno:'4848388586', numero_cuenta:'2510204166879109', autopago:'SI', direccion:'1030 Perry St Reading PA 19604 REAR', tipo_servicios:'XFINITY', sistema:'N/A', riesgo:'N/A', dia_venta:'2025-10-20', dia_instalacion:'2025-10-23', status:'PENDING', servicios_texto:'XFINTY 500MBPS+', mercado:'ICON', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'19604', puntaje:0.75 },
              { nombre_cliente:'YOANDRIS SOL', telefono_principal:'5054486788', telefono_alterno:'5052218593', numero_cuenta:'2510214168598489', autopago:'SI', direccion:'304 Rhode Island St NE Albuquerque NM 87108 APT A', tipo_servicios:'XFINITY', sistema:'N/A', riesgo:'N/A', dia_venta:'2025-10-21', dia_instalacion:'2025-10-23', status:'PENDING', servicios_texto:'XFINTY 500MBPS+', mercado:'ICON', supervisor:'MARISOL', comentario:'QUITAR FEE $99.00', motivo_llamada:'MUDANZA', zip_code:'87108', puntaje:0.75 },
              { nombre_cliente:'OLGA TRIGUEROS', telefono_principal:'2818653227', telefono_alterno:'4099969306', numero_cuenta:'1646522530', autopago:'SI', direccion:'6914 Highway 6 APT 1 Hitchcock TX 77563', tipo_servicios:'EARTHLINK', sistema:'SARA', riesgo:'N/A', dia_venta:'2025-10-23', dia_instalacion:'2025-11-04', status:'PENDING', servicios_texto:'INTERNET EARTHLINK 300 MB', mercado:'ICON', supervisor:'MARISOL', comentario:'ADQUIRIR SERVICIOS', motivo_llamada:'ADQUIRIR SERVICIOS', zip_code:'77563', puntaje:1.0 }
            ].map(l => ({
              ...l,
              agenteId: agenteId,
              agenteNombre: agenteNombre,
              agente: agenteNombre,
              nombreAgente: agenteNombre,
              createdAt: l.dia_venta
            }));
            normalizedLeads = normalizeLeads(seed);
            console.warn('[fallback stefani] Inyectados 6 registros locales para visualizaciÃ³n');
          }
        } catch (e) { console.warn('[fallback stefani] error', e?.message); }

        // Si no hay datos detectados para el mes actual: NO ejecutar mÃºltiples fallbacks
        // Mostrar al usuario un botÃ³n explÃ­cito para "Cargar todos" (forceAll)
        if ((!Array.isArray(normalizedLeads) || normalizedLeads.length === 0) && !forceAll) {
          try {
            const actions = document.querySelector('.costumer-table-actions');
            if (actions) {
              // eliminar controles previos si existen
              const prevBtn = document.getElementById('btnLoadAllLeads');
              const prevNote = document.getElementById('noteLoadAllLeads');
              if (prevBtn) prevBtn.remove();
              if (prevNote) prevNote.remove();

              const note = document.createElement('div');
              note.id = 'noteLoadAllLeads';
              note.className = 'load-all-notice';
              note.style.marginLeft = '12px';
              note.style.display = 'inline-flex';
              note.style.alignItems = 'center';
              note.innerHTML = '<span style="color:#b00;margin-right:8px">No hay registros en el mes seleccionado.</span>';

              const btn = document.createElement('button');
              btn.id = 'btnLoadAllLeads';
              btn.className = 'btn btn-sm btn-outline-primary';
              btn.style.marginLeft = '6px';
              btn.textContent = 'Cargar todos';
              btn.addEventListener('click', () => {
                try {
                  window.__forceAllOverride = true;
                  // limpiar mensaje y botÃ³n
                  const n = document.getElementById('noteLoadAllLeads'); if (n) n.remove();
                  const b = document.getElementById('btnLoadAllLeads'); if (b) b.remove();
                  // reintentar carga con forceAll
                  fetchLeadsAgente(1);
                } catch (e) { console.error('Error al activar Cargar todos:', e); }
              });

              actions.appendChild(note);
              actions.appendChild(btn);
            }

            // AdemÃ¡s, insertar banner visible en el header para asegurar visibilidad
            try {
              const header = document.querySelector('.costumer-table-header');
              if (header) {
                const prevBanner = document.getElementById('loadAllBanner');
                if (prevBanner) prevBanner.remove();
                const banner = document.createElement('div');
                banner.id = 'loadAllBanner';
                banner.style.marginTop = '8px';
                banner.style.padding = '8px 12px';
                banner.style.background = '#fff3f3';
                banner.style.border = '1px solid #f1c0c0';
                banner.style.borderRadius = '6px';
                banner.style.display = 'flex';
                banner.style.alignItems = 'center';
                banner.innerHTML = `<div style="flex:1;color:#8b0000">No hay registros en el mes seleccionado.</div>`;
                const b2 = document.createElement('button');
                b2.textContent = 'Cargar todos';
                b2.className = 'btn btn-sm btn-primary';
                b2.style.marginLeft = '8px';
                b2.addEventListener('click', () => {
                  try {
                    window.__forceAllOverride = true;
                    const nb = document.getElementById('loadAllBanner'); if (nb) nb.remove();
                    const n = document.getElementById('noteLoadAllLeads'); if (n) n.remove();
                    const b = document.getElementById('btnLoadAllLeads'); if (b) b.remove();
                    fetchLeadsAgente(1);
                  } catch (e) { console.error(e); }
                });
                banner.appendChild(b2);
                header.appendChild(banner);
              }
            } catch (e) { /* no-op */ }
          } catch (e) { console.warn('[fetchLeadsAgente] Error mostrando botÃ³n Cargar todos:', e?.message); }
        }

        // Filtro por mes en frontend desactivado (el backend ya aplica filtro robusto)
        try { console.log('[Filtro mes actual frontend] desactivado; manteniendo', normalizedLeads.length, 'registros'); } catch(_){ }

    // IMPORTANTE: Verificar si hay filtro de mes activo antes de aplicar filtro por agente
    const monthFilter = document.getElementById('monthFilter');
    const hasMonthFilter = monthFilter && monthFilter.value && monthFilter.value !== '';
    console.log('[Filtro Debug] Filtro de mes activo:', hasMonthFilter, 'Valor:', monthFilter?.value);

    // Filtrar por agente si el usuario es role 'agent' SOLO si no se filtrÂ¨Â® ya en el backend Y no hay filtro de mes
    if (!alreadyFilteredByAgent && !forceAll && !hasMonthFilter) {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        const role = (function normalizeRole(r){
          if (!r) return 'agente';
          if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
          if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
          if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
          if (['backoffice','back office','back_office','bo','b.o','b:o','b-o'].includes(r)) return 'backoffice';
          return r;
        })(roleRaw);
        console.log('[Filtro Debug] Rol detectado en fetchLeadsAgente:', role, 'desde roleRaw:', roleRaw);
        if (role === 'agente') {
          const norm = (s) => {
            try {
              const x = String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
              return x.replace(/[^a-z0-9]+/g,''); // quitar espacios y no alfanumÃ©ricos
            } catch {
              return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
            }
          };
          const str = (v) => (v == null ? '' : String(v));
          // Candidatos de ID del usuario actual
          const myIds = [
            userData.id, userData._id, userData.userId, userData.uid,
            userData?.usuario?._id, userData?.usuario?.id,
            userData?.user?._id, userData?.user?.id,
            userData?.profile?._id, userData?.profile?.id
          ].map(str).filter(x => x.trim().length);

          // Candidatos de nombre del usuario actual
          const myNames = [
            userData.name, userData.nombre, userData.username, userData.email,
            userData?.usuario?.name, userData?.usuario?.nombre, userData?.usuario?.username
          ].map(str).filter(x => x.trim().length);

          const getId = (l) => {
            if (typeof getAgentId === 'function') return getAgentId(l);
            const raw = (
              l?.agenteId || l?._raw?.agenteId || l?.agente_id || l?._raw?.agente_id ||
              l?.idAgente || l?._raw?.idAgente || l?.agentId || l?._raw?.agentId ||
              l?.creadoPor || l?._raw?.creadoPor ||
              l?.creado_por || l?._raw?.creado_por ||
              l?.createdBy || l?._raw?.createdBy ||
              l?.ownerId || l?._raw?.ownerId ||
              l?.assignedId || l?._raw?.assignedId || ''
            );
            try {
              if (raw && typeof raw === 'object') {
                const maybe = raw.$oid || raw.id || raw._id || raw.value || (raw.toString ? raw.toString() : '');
                return String(maybe || '').trim();
              }
              return String(raw || '').trim();
            } catch(_) {
              return String(raw || '').trim();
            }
          };
          const getName = (l) => {
            if (typeof getAgentName === 'function') return getAgentName(l);
            const cand = [
              l?.agenteNombre, l?.nombreAgente, l?.agente, l?.agent,
              l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.agent
            ];
            const v = cand.find(x => x && String(x).trim().length);
            const raw = v ? String(v).trim() : '';
            return agentCanonicalName(raw);
          };

          const myIdsNorm = new Set(myIds.map(x => norm(x)));
          // Incluir variantes canÃ³nicas del usuario en el conjunto de comparaciÃ³n
          const myNamesCanon = myNames.map(n => agentCanonicalName(n));
          const myNamesNorm = new Set([...myNames, ...myNamesCanon].map(x => norm(x)));

          const beforeCount = normalizedLeads.length;
          normalizedLeads = normalizedLeads.filter(l => {
            const idMatch = (() => {
              const lid = norm(getId(l));
              if (!lid) return false;
              return myIdsNorm.has(lid);
            })();
            if (idMatch) return true;
            const nameMatch = (() => {
              const lname = norm(getName(l));
              if (!lname) return false;
              return myNamesNorm.has(lname);
            })();
            return nameMatch;
          });
          console.log(`[Filtro rol=agent] ${beforeCount} -> ${normalizedLeads.length} leads para el usuario actual (frontend)`);
        }
      } catch (e) {
        console.warn('No se pudo aplicar filtro por agente:', e?.message);
      }
    } else if (hasMonthFilter) {
      console.log('[Filtro rol=agent] OMITIDO porque hay filtro de mes activo - mostrando todos los datos');
    }

    // Filtrar por equipo si el usuario es 'supervisor' y NO estÂ¨Â¢ activo forceAll
    if (!forceAll) {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const role = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        if (role === 'supervisor' && window.Teams) {
          // Si el backend ya viene filtrando por agentes (agents/agentName), no volver a filtrar aquÃ­
          try {
            const u = (typeof url === 'string') ? url : '';
            if (u.includes('agents=') || u.includes('agentName=')) {
              console.log('[Filtro rol=supervisor] Omitido: backend ya aplicÃ³ filtrado por agentes (agents/agentName).');
              throw new Error('__SKIP_SUPERVISOR_FILTER__');
            }
          } catch (e) {
            if (String(e?.message || '') === '__SKIP_SUPERVISOR_FILTER__') throw e;
          }
          const supName = (userData.name || userData.nombre || userData.username || userData?.usuario?.name || userData?.usuario?.nombre || '').toString();
          // Intentar obtener agentes desde la API local (fuente autoritativa) primero, y caer
          // en el wrapper `window.Teams` si la API no está disponible o no devuelve agentes.
          let agents = [];
          const norm = (window.Teams && window.Teams.norm) || ((s)=>String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim());
          const canonicalFromName = (window.Teams && window.Teams.canonicalFromName) || ((name)=> norm(name));

          try {
            // 1) Intentar desde backend protegido /api/teams/agents (requiere token o cookie)
            try {
              const token = localStorage.getItem('token') || sessionStorage.getItem('token');
              const fetchOptions = { method: 'GET', credentials: 'include', headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': `Bearer ${token}` } : {}) };
              const url = `/api/teams/agents?supervisor=${encodeURIComponent(supName)}`;
              const resp = await fetch(url, fetchOptions);
              if (resp && resp.ok) {
                const json = await resp.json();
                if (json && Array.isArray(json.data) && json.data.length) {
                  agents = json.data.map(a => (a.username || a.name || a.id || '').toString()).filter(Boolean);
                  console.log('[Filtro rol=supervisor] Agentes obtenidos desde backend /api/teams/agents:', agents.length);
                }
              }
            } catch (e) {
              console.warn('[Filtro rol=supervisor] Error llamando /api/teams/agents:', e?.message);
            }

            // 2) Si backend no devolviÃ³ agentes, intentar wrapper local `window.Teams`
            if ((!Array.isArray(agents) || agents.length === 0) && window.Teams && typeof window.Teams.getAgentsBySupervisor === 'function') {
              try {
                const fromTeams = window.Teams.getAgentsBySupervisor(supName) || [];
                if (Array.isArray(fromTeams) && fromTeams.length) {
                  agents = fromTeams.slice();
                  console.log('[Filtro rol=supervisor] Agentes obtenidos desde window.Teams:', agents.length);
                }
              } catch (e) {
                console.warn('[Filtro rol=supervisor] Error obteniendo agentes desde window.Teams:', e?.message);
              }
            }
          } catch (e) { console.warn('[Filtro rol=supervisor] Error al resolver agentes:', e?.message); }
          try {
            // Diagnostic: sample supervisor fields from the first 30 leads to inspect matching
            const getSupervisorField = (l) => {
              const cand = [
                l?.supervisor, l?.supervisorName, l?.supervisor_nombre, l?.supervisorNombre,
                l?._raw?.supervisor, l?._raw?.supervisorName, l?.team
              ];
              return cand.find(x => x && String(x).trim().length) || '';
            };
            const sample = (normalizedLeads||[]).slice(0,30).map(l => String(getSupervisorField(l)||'').trim()).filter(Boolean).slice(0,15);
            console.log('[Filtro rol=supervisor][diagnostico] supName=', supName, 'agents=', Array.isArray(agents)?agents.length:agents, 'agentsSample=', (Array.isArray(agents)?agents.slice(0,10):agents), 'leadSupervisorSample=', sample.slice(0,10));
          } catch(_) {}
            if (Array.isArray(agents) && agents.length) {
            // Conjunto de agentes canónicos del supervisor
            const teamAgentsCanon = new Set((agents || []).map(a => canonicalFromName(a)));
            const getName = (l) => {
              if (typeof getAgentName === 'function') return getAgentName(l);
              const cand = [
                l?.agenteNombre, l?.nombreAgente, l?.agente, l?.agent,
                l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.agent
              ];
              const v = cand.find(x => x && String(x).trim().length);
              return v ? String(v).trim() : '';
            };
            const before = normalizedLeads.length;
            const filtered = normalizedLeads.filter(l => teamAgentsCanon.has(canonicalFromName(getName(l))));
            if (!filtered.length) {
              console.warn('[Filtro rol=supervisor] Resultado 0 al filtrar por agents (posible mismatch de nombres). Se omitirÃ¡ el filtro.', { supName, agentsCount: agents.length });
            } else {
              normalizedLeads = filtered;
              console.log(`[Filtro rol=supervisor] ${before} -> ${normalizedLeads.length} leads del equipo de`, supName);
            }
          } else {
            // Fallback: si no hay lista de agentes en Teams, intentar filtrar por campo 'supervisor' en los leads
            try {
              const supCanon = canonicalFromName(supName);

              const getSupervisorField = (l) => {
                const cand = [
                  l?.supervisor, l?.supervisorName, l?.supervisor_nombre, l?.supervisorNombre,
                  l?.supervisor?.name, l?._raw?.supervisor, l?._raw?.supervisorName
                ];
                const v = cand.find(x => x && String(x).trim().length);
                return v ? String(v).trim() : '';
              };
              const before = normalizedLeads.length;

              // Mejora de coincidencia: aceptar igualdad canÃ³nica, inclusiÃ³n parcial y comparaciÃ³n por apellido
              const filteredBySupervisorField = normalizedLeads.filter(l => {
                const s = getSupervisorField(l);
                if (!s) return false;
                const sCanon = canonicalFromName(s);
                // Coincidencia exacta canÃ³nica
                if (sCanon === supCanon) return true;
                // Coincidencia por inclusiÃ³n (p. ej. lead supervisor = 'pleitez', supName = 'bryanpleitez')
                if (supCanon.includes(sCanon) || sCanon.includes(supCanon)) return true;
                // Coincidencia por Ãºltimo apellido
                const lastToken = (str) => {
                  try { return String(str||'').split(/\s+/).filter(Boolean).pop().toLowerCase(); } catch { return String(str||'').toLowerCase(); }
                };
                const sLast = lastToken(s);
                const supLast = lastToken(supName);
                if (sLast && supLast && sLast === supLast) return true;
                return false;
              });

              // AÃ±adir logs diagnÃ³sticos mostrando un muestreo breve
              try {
                const sampleSupervisors = (normalizedLeads.slice(0,20).map(l => getSupervisorField(l)).filter(Boolean).slice(0,10));
                console.log('[Filtro rol=supervisor][fallback] supName=', supName, 'supCanon=', supCanon, 'sample supervisor fields=', sampleSupervisors);
              } catch(_) {}

              if (filteredBySupervisorField.length > 0) {
                normalizedLeads = filteredBySupervisorField;
                console.log(`[Filtro rol=supervisor][fallback supervisor field] ${before} -> ${normalizedLeads.length} leads del supervisor`, supName);
              } else {
                // Si tampoco hay resultados por campo supervisor, no aplicar filtro (mostrar todo)
                console.warn('[Filtro rol=supervisor] No se encontraron agentes ni leads con campo supervisor coincidente para:', supName, '. Se omitirÃ¡ el filtro.');
              }
            } catch (e) {
              console.warn('[Filtro rol=supervisor] Error en fallback por campo supervisor:', e?.message);
            }
          }
        }
      } catch (e) {
        if (String(e?.message || '') !== '__SKIP_SUPERVISOR_FILTER__') {
          console.warn('[Filtro rol=supervisor] No se pudo aplicar filtro por equipo:', e?.message);
        }
      }
    }

    window.ultimaListaLeads = normalizedLeads;
    try {
      const sample = (normalizedLeads || []).slice(0, 3).map(l => ({
        _id: l._id || l.id,
        agenteId: l.agenteId || l.agente_id || l.idAgente || l.agentId,
        agente: l.agente || l.agent || l.agenteNombre || l.nombreAgente,
        dia_venta: l.dia_venta || l.FECHA || l.fecha || l.fecha_venta
      }));
      console.log('[fetchLeadsAgente] Muestra post-filtrado:', sample);
    } catch {}

        // Poblar filtros de Team y Agente con los datos cargados
        if (typeof window.populateTeamAndAgentFilters === 'function') {
            window.populateTeamAndAgentFilters(normalizedLeads);
        }

        // Actualizar la interfaz
        if (typeof window.renderCostumerTable === 'function') {
            console.log('[fetchLeadsAgente] Llamando a renderCostumerTable con', normalizedLeads.length, 'items');
            console.log('[fetchLeadsAgente] Datos:', normalizedLeads.slice(0,3));
            window.renderCostumerTable(normalizedLeads);
        } else {
            console.error('La funciÂ¨Â®n renderCostumerTable no estÂ¨Â¢ disponible');
        }
        
        // Crear toolbar de supervisor DESPUÃ‰S de renderizar la tabla
        if (typeof window.createSupervisorToolbar === 'function') {
            console.log('ðŸ”§ [fetchLeadsAgente] Llamando a createSupervisorToolbar...');
            console.log('ðŸ”§ [fetchLeadsAgente] Datos disponibles:', !!normalizedLeads, 'Cantidad:', normalizedLeads?.length || 0);
            window.createSupervisorToolbar(normalizedLeads);
            console.log('ðŸ”§ [fetchLeadsAgente] createSupervisorToolbar ejecutada');
        } else {
            console.error('âŒ [fetchLeadsAgente] createSupervisorToolbar NO está disponible');
            console.log('ðŸ”§ [fetchLeadsAgente] Verificando funciones disponibles:', Object.keys(window).filter(k => k.includes('create')));
        }
        
        // Logs de diagnÂ¨Â®stico de asignaciÂ¨Â®n (por TEAM y agente)
        try { if (typeof logDiagnosticoAsignacion === 'function') logDiagnosticoAsignacion(normalizedLeads); } catch(_) {}

        // Para AGENTES: Cargar TODOS los datos del mes (no solo primera página) para KPI exacto
        try {
          // Para AGENTES: SIEMPRE cargar mes actual para KPI (aunque la tabla muestre todos los clientes)
          const currentDate = new Date();
          const currentMonth = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
          const monthForKpi = (role === 'agente' && !effectiveSelectedMonth) ? currentMonth : effectiveSelectedMonth;
          
          if (role === 'agente' && userData && monthForKpi) {
            console.log('[fetchLeadsAgente] AGENTE: cargando datos COMPLETOS del mes para KPI...');
            // Usar el nombre completo del agente, no username
            const agentNameRaw = (userData.nombre || userData.name || userData.username || userData?.usuario?.nombre || userData?.usuario?.name || userData?.usuario?.username || '').toString().trim();
            const agentName = agentNameRaw.replace(/[._-]+/g, ' ').replace(/\s+/g, ' ').trim();
            if (agentName) {
              const fullMonthUrl = `/api/leads?month=${encodeURIComponent(monthForKpi)}&limit=10000&agentName=${encodeURIComponent(agentName)}`;
              try {
                const fullRes = await fetch(fullMonthUrl, fetchOptions);
                if (fullRes && fullRes.ok) {
                  const fullData = await fullRes.json();
                  const fullLeads = Array.isArray(fullData.leads) ? fullData.leads : (Array.isArray(fullData.data) ? fullData.data : []);
                  if (fullLeads.length > 0) {
                    const normalizedFullLeads = normalizeLeads(fullLeads);
                    window.__agentFullLeadsForKpi = normalizedFullLeads;
                    console.log('[fetchLeadsAgente] AGENTE: datos completos cargados -', normalizedFullLeads.length, 'leads del mes', monthForKpi, 'para', agentName);
                  } else {
                    window.__agentFullLeadsForKpi = null;
                    console.log('[fetchLeadsAgente] AGENTE: sin datos para el mes -', agentName);
                  }
                } else {
                  window.__agentFullLeadsForKpi = null;
                  console.log('[fetchLeadsAgente] AGENTE: error cargando datos completos (status:', fullRes?.status, ')');
                }
              } catch (e) {
                console.error('[fetchLeadsAgente] AGENTE: error en fetch completo -', e);
                window.__agentFullLeadsForKpi = null;
              }
            } else {
              console.warn('[fetchLeadsAgente] AGENTE: no se pudo determinar el nombre del agente');
              window.__agentFullLeadsForKpi = null;
            }
          } else {
            // NO es agente: limpiar datos completos
            console.log('[fetchLeadsAgente] NO AGENTE: limpiando window.__agentFullLeadsForKpi');
            window.__agentFullLeadsForKpi = null;
          }
        } catch (_) {
          window.__agentFullLeadsForKpi = null;
        }

        try {
          if (!isTeamLineasUser) {
            let kpiUrl = '/api/leads/kpis';
            const kpiParams = [];
            if (effectiveSelectedMonth) {
              kpiParams.push(`month=${encodeURIComponent(effectiveSelectedMonth)}`);
            }

            // Para AGENTES: NO llamar a /api/leads/kpis (backend no filtra por agente correctamente)
            // Los KPIs se calculan localmente desde los leads filtrados
            // Solo hacer la llamada para ADMIN y SUPERVISOR
            const shouldFetchKpi = role !== 'agente';
            
            if (shouldFetchKpi) {
              // Para supervisor: mandar los mismos filtros que /api/leads para que el KPI sea consistente
              try {
                if (isSupervisorUser) {
                  const agentDropdown = document.getElementById('agentFilter');
                  const selectedAgent = agentDropdown ? String(agentDropdown.value || '').trim() : '';
                  if (selectedAgent) {
                    kpiParams.push(`agentName=${encodeURIComponent(selectedAgent)}`);
                  } else {
                    try {
                      const supName = (userData.username || userData.name || userData.nombre || '').toString().trim();
                      const teamsApi = window && window.Teams;
                      const agents = (teamsApi && typeof teamsApi.getAgentsBySupervisor === 'function') ? (teamsApi.getAgentsBySupervisor(supName) || []) : [];
                      if (Array.isArray(agents) && agents.length) {
                        kpiParams.push(`agents=${encodeURIComponent(agents.join(','))}`);
                      }
                    } catch (_) {}
                  }
                }
              } catch (_) {}

              if (kpiParams.length) {
                kpiUrl += `?${kpiParams.join('&')}`;
              }
              console.log('[fetchLeadsAgente] KPI URL (ADMIN/SUPER):', kpiUrl);
              const kpiRes = await fetch(kpiUrl, fetchOptions);
              if (kpiRes && kpiRes.ok) {
                const kpiJson = await kpiRes.json();
                window.__kpisTotals = (kpiJson && (kpiJson.kpis || kpiJson.data)) ? (kpiJson.kpis || kpiJson.data) : null;
              } else {
                window.__kpisTotals = null;
              }
            } else {
              // Para AGENTES: no usar /api/leads/kpis, los KPIs se calculan localmente
              console.log('[fetchLeadsAgente] AGENTE: omitiendo /api/leads/kpis, calculando localmente');
              window.__kpisTotals = null;
            }
          } else {
            window.__kpisTotals = null;
          }
        } catch (_) {
          window.__kpisTotals = null;
        }

        updateSummaryCards((window.__kpiLeadsLast && window.__kpiLeadsLast.length) ? window.__kpiLeadsLast : normalizedLeads);

        return normalizedLeads;
      } catch (error) {
        console.error('Error en fetchLeadsAgente:', error);
        mostrarMensajeSinDatos();
        return [];
      }
    }

    // Para AGENTES: establecer filtro "Por página" en "Todos" por defecto
    try {
      const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
      const isAgente = ['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(roleRaw);
      
      if (isAgente) {
        setTimeout(() => {
          const pageSizeSelect = document.getElementById('pageSizeSelect');
          if (pageSizeSelect) {
            pageSizeSelect.value = '99999'; // "Todos"
            console.log('[AGENTE CONFIG] Filtro "Por página" establecido a "Todos"');
          }
        }, 500);
      }
    } catch (_) {}

    // FunciÂ¨Â®n para manejar la ausencia de datos
    function mostrarMensajeSinDatos() {
      const tableBody = document.querySelector('#costumer-tbody');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="13" style="text-align: center; padding: 20px;">
              <p>No se encontraron datos disponibles.</p>
              <p>Por favor, verifica tu conexiÂ¨Â®n o contacta al administrador.</p>
            </td>
          </tr>
        `;
      }
      
      // Actualizar las tarjetas de resumen con valores en cero
      updateSummaryCards([]);
    }

    // FunciÂ¨Â®n para cargar los datos iniciales
    async function cargarDatosIniciales() {
      console.log('[DEBUG] Iniciando cargarDatosIniciales...');
      
      // âœ… VALIDACIÃ“N CRÃTICA: Limpiar cache si el usuario cambiÃ³
      try {
        const currentUser = await getCurrentUser();
        const currentUserId = currentUser?.id || currentUser?._id || 'unknown';
        const cachedUserId = sessionStorage.getItem('costumerCacheUserId');
        
        if (cachedUserId && cachedUserId !== currentUserId) {
          console.log('[DEBUG] âš ï¸ Usuario cambiÃ³:', { anterior: cachedUserId, actual: currentUserId });
          console.log('[DEBUG] ðŸ§¹ Limpiando cache de sesiÃ³n anterior...');
          sessionStorage.removeItem('allPagesData');
          sessionStorage.removeItem('costumerCacheUserId');
        } else if (!cachedUserId) {
          sessionStorage.setItem('costumerCacheUserId', currentUserId);
        }
      } catch(e) {
        console.warn('[DEBUG] Error validando usuario en cache:', e);
      }
      
      // Mostrar indicador de carga si existe
      const loadingIndicator = document.getElementById('loading-indicator');
      
      try {
        console.log('[DEBUG] Iniciando carga de datos...');
        
        if (loadingIndicator) {
          console.log('[DEBUG] Mostrando indicador de carga');
          loadingIndicator.style.display = 'block';
        }
        // Cargar datos del servidor usando la funciÂ¨Â®n unificada
        console.log('[DEBUG] Llamando a cargarDatosDesdeServidor...');
        if (typeof cargarDatosDesdeServidor === 'function') {
          await cargarDatosDesdeServidor();
          const arr = Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : [];
          if (arr.length > 0) {
            console.log('[DEBUG] Datos de clientes cargados correctamente:', arr.length, 'registros');
            try { console.log('[DEBUG] Primer lead de ejemplo:', JSON.stringify(arr[0], null, 2)); } catch(_) {}
          } else {
            console.warn('[DEBUG] No se encontraron leads o el arreglo estÂ¨Â¢ vacÂ¨Âªo tras cargarDatosDesdeServidor');
            mostrarMensajeSinDatos();
          }
        } else if (typeof fetchLeadsAgente === 'function') {
          // Fallback por compatibilidad, pero preferimos la ruta unificada
          console.log('[DEBUG] cargarDatosDesdeServidor no disponible, usando fallback fetchLeadsAgente');
          const leads = await fetchLeadsAgente();
          if (!leads || leads.length === 0) mostrarMensajeSinDatos();
        } else {
          console.warn('[DEBUG] No hay funciÂ¨Â®n de carga disponible');
          mostrarMensajeSinDatos();
        }
      } catch (error) {
        console.error('Error al cargar datos iniciales:', error);
        mostrarMensajeSinDatos();
      } finally {
        // Ocultar indicador de carga si existe
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }
      }
    }
    


    // Manejar bÃºsqueda con debounce para rendimiento
    let searchTimeout;
    const searchInputEl = document.getElementById('costumer-search');
    if (searchInputEl) {
        searchInputEl.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Forzar re-renderizado usando la lÃ³gica centralizada
                if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
                    console.log('[Search] Triggering re-render with term:', e.target.value);
                    const prevSuspend = window.__suspendRender;
                    try {
                        window.__suspendRender = false;
                        window.renderCostumerTable(window.ultimaListaLeads);
                    } finally {
                        window.__suspendRender = prevSuspend;
                    }
                }
            }, 300);
        });
    }

    const serviceInputEl = document.getElementById('serviceFilter');
    if (serviceInputEl) {
        serviceInputEl.addEventListener('change', function(e) {
            if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
                console.log('[ServiceFilter] Triggering re-render with term:', e.target.value);
                const prevSuspend = window.__suspendRender;
                try {
                    window.__suspendRender = false;
                    window.renderCostumerTable(window.ultimaListaLeads);
                } finally {
                    window.__suspendRender = prevSuspend;
                }
            }
        });
    }

    // Función para formatear fechas con el formato 'dÃ­a_de_la_semana nÃºmero_del_dÃ­a' (ej: 'miÃ© 13')
    function formatearFechaSinDesfase(fechaStr) {
      try {
        // Usar utilidad centralizada si está disponible
        if (window.DateUtils && window.DateUtils.formatShortDate) {
          return window.DateUtils.formatShortDate(fechaStr);
        }
        
        // Fallback: implementaciÃ³n manual
        if (typeof fechaStr !== 'string') {
          console.warn('Tipo de fecha no soportado:', typeof fechaStr, fechaStr);
          return 'N/A';
        }

        const fechaLimpia = fechaStr.trim();
        let day, month, year;
        
        // Intentar con formato YYYY-MM-DD
        let match = fechaLimpia.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
          [_, year, month, day] = match;
        } 
        // Si no coincide, intentar con formato DD/MM/YYYY
        else if ((match = fechaLimpia.match(/^(\d{2})\/(\d{2})\/(\d{4})/))) {
          [_, day, month, year] = match;
        }
        else {
          console.warn('Formato de fecha no reconocido:', fechaLimpia);
          return 'N/A';
        }
        
        // Convertir a nÃºmeros y crear fecha LOCAL
        year = parseInt(year, 10);
        month = parseInt(month, 10) - 1;
        day = parseInt(day, 10);
        
        const fecha = new Date(year, month, day);
        
        if (isNaN(fecha.getTime())) {
          console.warn('Fecha invÃ¡lida:', fechaLimpia);
          return 'N/A';
        }
        
        const diasSemana = ['dom', 'lun', 'mar', 'miÃ©', 'jue', 'vie', 'sÃ¡b'];
        const diaSemana = diasSemana[fecha.getDay()];
        const diaMes = fecha.getDate();
        
        return `${diaSemana} ${diaMes}`;
        
      } catch (error) {
        console.error('Error al formatear fecha:', error, 'Valor:', fechaStr);
        return 'Fecha invÃ¡lida';
      }
    }
    
    // Helper (local): obtener rol actual normalizado
    // NOTA: Renombrado a getUserRole_local para no sobreescribir la versiÂ¨Â®n global de script.js
    function getUserRole_local() {
      try {
        const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
        return (user.role || '').toString().trim().toLowerCase();
      } catch { return ''; }
    }

    // Helper (local): verificar si el usuario puede editar status (Administrador / B.O)
    // NOTA: Renombrado a canEditStatus_local para no sobreescribir la versiÂ¨Â®n global de script.js
    function canEditStatus_local() {
      const r = getUserRole_local();
      // Aceptar variantes comunes desde frontend (referencial, no usada por la tabla)
      const r2 = String(r || '').toLowerCase().trim().replace(/\s+/g,'_').replace(/-+/g,'_');
      return ['admin','administrador','backoffice','b:o','b.o','b-o','bo','rol_icon','rol_bamo'].includes(r2);
    }

    // Helper: normalizar status hacia las 5 opciones y devolver etiqueta capitalizada
    function normalizeStatusLabel(s) {
      const allowed = ['pending','hold','cancelled','rescheduled','completed','active'];
      const v = (s || '').toString().trim();
      const lower = v.toLowerCase();
      // Caso especial: Active Oficina (debe mantenerse como etiqueta separada)
      if ((lower.includes('active') || lower.includes('activo')) && lower.includes('oficina')) {
        return 'Active Oficina';
      }
      const pick = allowed.includes(lower)
        ? lower
        : (v.toLowerCase().includes('active') || v.toLowerCase().includes('activo') ? 'active' : null) ||
          (v.toLowerCase().includes('pend') ? 'pending' : null) ||
          (v.toLowerCase().includes('hold') ? 'hold' : null) ||
          (v.toLowerCase().includes('cancel') ? 'cancelled' : null) ||
          (v.toLowerCase().includes('reprogram') || v.toLowerCase().includes('reagend') || v.toLowerCase().includes('resched') ? 'rescheduled' : null) ||
          (v.toLowerCase().includes('compl') || v.toLowerCase().includes('termin') ? 'completed' : null) ||
          'pending';
      return pick.charAt(0).toUpperCase() + pick.slice(1);
    }

    // Helper: clase de badge segÂ¨Â²n nuevo set de estados
    function statusToBadgeClass(label) {
      const lower = (label||'').toString().toLowerCase();
      if (lower === 'pending') return 'badge-warning';
      if (lower === 'hold') return 'badge-info';
      if (lower === 'cancelled') return 'badge-danger';
      if (lower === 'rescheduled') return 'badge-primary';
      if (lower === 'completed') return 'badge-success';
      if (lower === 'active') return 'badge-success';
      if (lower === 'active oficina' || lower === 'active_oficina') return 'badge-active-oficina';
      return 'badge-info';
    }

    // Llamada al backend para actualizar el status (local)
    // NOTA: Renombrado a updateLeadStatusLocal para no sobreescribir la versiÂ¨Â®n global de script.js
    async function updateLeadStatusLocal(selectEl, leadId) {
      try {
        // Validar ID antes de continuar
        if (!leadId) {
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
          alert('No se pudo determinar el ID del lead. Recarga la pÂ¨Â¢gina e intÂ¨Â¦ntalo nuevamente.');
          return;
        }
        // Solicitar motivo ANTES de cualquier await para no perder el gesto del usuario
        try {
          const newStatusLower = String(selectEl.value || '').toLowerCase();
          const triggerStatuses = ['cancel', 'hold', 'resched', 'repro', 'anulad', 'no instalado'];
          if (triggerStatuses.some(s => newStatusLower.includes(s))) {
            const oldPrev = String(selectEl.getAttribute('data-prev') || '').trim();
            const clientName = ((selectEl.closest('tr')?.querySelector('td')?.textContent || '')).trim();
            const title = 'Motivo del Cambio de Status';
            const text = `Â¿CuÃ¡l es el motivo del cambio de status${clientName ? ` de <b>${clientName}</b>` : ''} a <b>${selectEl.value}</b>?`;
            const reason = await askForReason(title, text);

            if (!reason || !reason.trim()) {
              if (oldPrev) {
                const revert = oldPrev.toLowerCase();
                selectEl.value = revert;
                selectEl.setAttribute('data-prev', oldPrev);
              }
              return; // Abortar si no hay motivo
            }

            const commentText = `Status cambiado a ${selectEl.value}: ${reason}`;
            try {
              if (typeof addSystemComment === 'function') await addSystemComment(String(leadId).trim(), commentText);
              if (typeof sendDesktopNotification === 'function') sendDesktopNotification(`Status actualizado${clientName ? `: ${clientName}` : ''}`, commentText);
            } catch (e) {
              console.warn('No se pudo registrar el motivo/notificaciÃ³n:', e);
            }
          }
        } catch (e) {
          console.warn('Error solicitando motivo (local):', e);
        }
        // Sanitizar y normalizar ID
        const cleanId = String(leadId).trim();
        if (!cleanId) {
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
          alert('ID de lead vacÂ¨Âªo o invÂ¨Â¢lido.');
          return;
        }
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          alert('No hay token de autenticaciÂ¨Â®n. Inicia sesiÂ¨Â®n nuevamente.');
          return;
        }
        const newVal = selectEl.value; // Etiqueta capitalizada
        // Deshabilitar durante la peticiÂ¨Â®n
        const prevDisabled = selectEl.disabled; selectEl.disabled = true;
        try {
          const url = `/api/leads/${encodeURIComponent(cleanId)}/status`;
          console.debug('[updateLeadStatus] PUT', { id: cleanId, url, status: newVal });
          const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ status: newVal })
          });
          let data = {};
          try { data = await res.json(); } catch { data = {}; }
          if (!res.ok || !data?.success) {
            // Manejo especÂ¨Âªfico por cÂ¨Â®digos comunes
            if (res.status === 401) throw new Error('No autorizado (401). Verifica el token de sesiÂ¨Â®n.');
            if (res.status === 403) throw new Error('Permisos insuficientes (403). Solo admin/supervisor pueden actualizar.');
            if (res.status === 404) throw new Error(data?.message || 'Lead no encontrado (404). Verifica que el ID exista en la base de datos.');
            throw new Error(data?.message || `Error ${res.status || ''}: No se pudo actualizar el estado`);
          }
          // Actualizar badge visual si existe al lado del select
          const badge = selectEl.closest('td')?.querySelector('span.badge');
          if (badge) {
            badge.textContent = newVal;
            badge.className = `badge ${statusToBadgeClass(newVal)}`;
          }
        } catch(err) {
          console.error('Error al actualizar status:', err);
          alert(`Error: ${err.message}`);
          // Revertir valor si falla
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
        } finally {
          // Guardar nuevo previo
          selectEl.setAttribute('data-prev', selectEl.value);
          selectEl.disabled = prevDisabled;
        }
      } catch(e) {
        console.error(e);
      }
    }

    // Render principal de la tabla de clientes
    window.renderCostumerTable = function(leadsArray) {
      console.log('[renderCostumerTable MAIN] ✅ LLAMADO', {
        typeof: typeof leadsArray,
        esArray: Array.isArray(leadsArray),
        length: Array.isArray(leadsArray) ? leadsArray.length : 'N/A',
        primerItem: (Array.isArray(leadsArray) && leadsArray[0]) ? { nombre: leadsArray[0]?.nombre_cliente, id: leadsArray[0]?.id || leadsArray[0]?._id } : null
      });
      console.log('[renderCostumerTable MAIN] Data completa:', leadsArray);

      try {
        const normalizeToken = (value) => {
          try {
            return String(value || '')
              .normalize('NFD')
              .replace(/\p{Diacritic}+/gu,'')
              .replace(/\s+/g, ' ')
              .trim();
          } catch {
            return String(value || '').trim();
          }
        };
        const splitTokens = (raw) => {
          const s = normalizeToken(raw);
          if (!s) return [];
          return s
            .split(/\s*[|,;\/]+\s*|\s{2,}/g)
            .map(t => normalizeToken(t))
            .filter(Boolean);
        };
        const extractServiceTokens = (item) => {
          const parts = [];
          const pushTokens = (v) => { splitTokens(v).forEach(t => parts.push(t)); };
          pushTokens(item?.servicios_texto);
          pushTokens(item?.tipo_servicios);
          pushTokens(item?.servicios);
          pushTokens(item?.producto);
          pushTokens(item?.sistema);
          pushTokens(item?._raw?.servicios_texto);
          pushTokens(item?._raw?.tipo_servicios);
          pushTokens(item?._raw?.servicios);
          pushTokens(item?._raw?.producto);
          pushTokens(item?._raw?.sistema);
          const tels = Array.isArray(item?.telefonos) ? item.telefonos : (Array.isArray(item?._raw?.telefonos) ? item._raw.telefonos : []);
          if (Array.isArray(tels) && tels.length) {
            tels.forEach(t => {
              pushTokens(t?.servicio);
              pushTokens(t?.tipo);
              pushTokens(t?.servicios);
              pushTokens(t?.tipo_servicios);
            });
          }
          return parts;
        };
        // El filtro de servicios ahora usa un select estático con opciones agrupadas por proveedor
      } catch (_) {}
      
      // MigraciÂ¨Â®n de compatibilidad: renombrar filtro legado a nombre neutral
      try {
        if (window.iraniaAgentFilter != null && window.supervisorAgentFilter == null) {
          window.supervisorAgentFilter = window.iraniaAgentFilter;
        }
      } catch(_) {}
      // Construir/actualizar mapas GLOBAL: id -> canÂ¨Â®nico y canÂ¨Â®nico -> ids
      try {
        const teamsApi = (window && window.Teams) ? window.Teams : null;
        const canonical = (name) => {
          try { return teamsApi && typeof teamsApi.canonicalFromName==='function' ? teamsApi.canonicalFromName(name) : String(name||'').toLowerCase().trim(); } catch { return String(name||'').toLowerCase().trim(); }
        };
        const norm = s => (s||'')
          .toString()
          .normalize('NFD')
          .replace(/\p{Diacritic}+/gu,'')
          .trim()
          .toLowerCase()
          .replace(/\s+/g,' ');
        const extractIds = (l) => {
          const ids = [];
          const candidates = [
            l?.agenteId, l?._raw?.agenteId,
            l?.agente_id, l?._raw?.agente_id,
            l?.idAgente, l?._raw?.idAgente,
            l?.agentId, l?._raw?.agentId,
            l?.creadoPor, l?._raw?.creadoPor,
            l?.creado_por, l?._raw?.creado_por,
            l?.createdBy, l?._raw?.createdBy,
            l?.ownerId, l?._raw?.ownerId,
            l?.assignedId, l?._raw?.assignedId
          ];
          for (const v of candidates) {
            if (!v) continue;
            if (typeof v === 'object') {
              const oid = v.$oid || v.id || v._id || v.value || (v.toString ? v.toString() : '');
              if (oid) ids.push(String(oid));
            } else {
              let s = String(v);
              // Normalizar formato "ObjectId('...')"
              const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/);
              if (m) s = m[1];
              ids.push(s);
            }
          }
          return ids.map(x => x && x.trim()).filter(Boolean);
        };
        const idMap = window.__idToCanonGlobal instanceof Map ? window.__idToCanonGlobal : new Map();
        (leadsArray||[]).forEach(l => {
          const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
          const canon = canonical(norm(cand));
          if (!canon) return;
          const ids = extractIds(l);
          ids.forEach(id => { try { idMap.set(id, canon); } catch(_) {} });
          try { l.__agentCanon = l.__agentCanon || canon; } catch(_) {}
        });
        // Override explÂ¨Âªcito conocido: Eduardo Rivas (ID actualizado)
    try { idMap.set('68bb1ddd0d4d7cdcb6eb3605', 'eduardo rivas'); } catch(_) {}
    window.__idToCanonGlobal = idMap;
        console.log('[ID->Canon] Tama?o del mapa:', idMap.size);
      } catch(e) { console.warn('[ID->Canon] Error al construir mapa:', e); }
      // Flag de depuraciÂ¨Â®n: si la URL contiene debugNoFilters=1, no aplicar filtros especiales ni vistas por TEAM
      let __debugNoFilters = false;
      try {
        const usp = new URLSearchParams(window.location.search || '');
        __debugNoFilters = (usp.get('debugNoFilters') === '1' || usp.get('debugNoFilters') === 'true');
      } catch(_) { __debugNoFilters = false; }

      // Construir mapa global id->agenteCanÂ¨Â®nico para mejorar detecciÂ¨Â®n por agenteId
      try {
        const teamsApiG = (window && window.Teams) ? window.Teams : null;
        const normG = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
        const canonicalFromNameG = (name) => {
          try { return teamsApiG && typeof teamsApiG.canonicalFromName==='function' ? teamsApiG.canonicalFromName(name) : normG(name); } catch { return normG(name); }
        };
        const getAgentIdGlobal = (l) => {
          const raw = (
            l?.agenteId || l?._raw?.agenteId ||
            l?.agente_id || l?._raw?.agente_id ||
            l?.idAgente || l?._raw?.idAgente ||
            l?.agentId || l?._raw?.agentId ||
            l?.creadoPor || l?._raw?.creadoPor ||
            l?.creado_por || l?._raw?.creado_por ||
            l?.createdBy || l?._raw?.createdBy ||
            l?.ownerId || l?._raw?.ownerId ||
            l?.assignedId || l?._raw?.assignedId || ''
          );
          try {
            if (raw && typeof raw === 'object') {
              const maybe = raw.$oid || raw.id || raw._id || raw.value || (raw.toString ? raw.toString() : '');
              return String(maybe || '').trim();
            }
            return String(raw || '').trim();
          } catch(_) { return String(raw || '').trim(); }
        };
        const idToCanonGlobal = new Map();
        (leadsArray||[]).forEach(l => {
          const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
          const canon = canonicalFromNameG(cand);
          const aid = getAgentIdGlobal(l);
          if (canon && aid) idToCanonGlobal.set(aid, canon);
        });
        try { window.__idToCanonGlobal = idToCanonGlobal; } catch(_) {}
      } catch(_) {}
      
      // Filtro especial: si el usuario es Irania Serrano, mostrar solo leads de su TEAM
      try {
        if (__debugNoFilters) throw new Error('DEBUG: filtros desactivados');
        const isIraniaUser = (typeof esIrania === 'function') && esIrania();
        // No aplicar el filtro de TEAM IRANIA para roles admin o supervisor
        const __role = (typeof getUserRole_local === 'function') ? (getUserRole_local() || '') : '';
        if (isIraniaUser && !['admin','supervisor'].includes((__role || '').toLowerCase())) {
          const norm = s => (s || '')
            .toString()
            .normalize('NFD')
            .replace(/\p{Diacritic}+/gu, '')
            .trim()
            .toLowerCase()
            .replace(/\s+/g, ' ');
          const teamAgents = new Set([
            'irania serrano',
            'giselle diaz',
            'josue renderos',
            'miguel nunez',
            'roxana martinez',
            'tatiana ayala'
          ]);
          const surnameToFull = new Map([
            ['serrano', 'irania serrano'],
            ['diaz', 'giselle diaz'],
            ['renderos', 'josue renderos'],
            ['nunez', 'miguel nunez'],
            ['martinez', 'roxana martinez'],
            ['ayala', 'tatiana ayala'],
          ]);
          const fullNames = Array.from(teamAgents);
          const surnames = Array.from(surnameToFull.keys());
          const teamCanon = [
            'josue renderos',
            'tatiana ayala',
            'giselle diaz',
            'miguel nunez',
            'roxana martinez',
            'irania serrano'
          ];
          const canonicalFromName = (name) => {
            const n = norm(name);
            if (!n) return '';
            if (teamCanon.includes(n)) return n;
            for (const c of teamCanon) {
              const toks = c.split(' ');
              if (toks.every(t => n.includes(t))) return c;
            }
            return '';
          };
          // CanonizaciÂ¨Â®n por primer nombre (fallback) para TEAM IRANIA
          const canonicalFromFirstName = (name) => {
            const n = norm(name);
            if (!n) return '';
            const first = n.split(' ')[0];
            const dict = new Map([
              ['josue', 'josue renderos'],
              ['tatiana', 'tatiana ayala'],
              ['giselle', 'giselle diaz'],
              ['miguel', 'miguel nunez'],
              ['roxana', 'roxana martinez'],
              ['irania', 'irania serrano'],
            ]);
            return dict.get(first) || '';
          };
          
          const getAgentName = (l) => {
            // 1) Campos comunes (priorizar 'agenteNombre') e incluir _raw.* del backend
            const candidates = [
              l?.agenteNombre,
              l?.nombreAgente,
              l?.agente, l?.Agente, l?.agent, l?.Agent, l?.vendedor, l?.seller,
              l?._raw?.agenteNombre,
              l?._raw?.nombreAgente,
              l?._raw?.agente, l?._raw?.Agente, l?._raw?.agent, l?._raw?.Agent, l?._raw?.vendedor, l?._raw?.seller,
              l?.nombre_agente, l?.agente_nombre, l?.agentName, l?.salesAgent,
              l?._raw?.nombre_agente, l?._raw?.agente_nombre, l?._raw?.agentName, l?._raw?.salesAgent,
              l?.asignadoA, l?.asignado_a, l?.assignedTo, l?.assigned_to,
              l?._raw?.asignadoA, l?._raw?.asignado_a, l?._raw?.assignedTo, l?._raw?.assigned_to,
              l?.usuario, l?.owner, l?.createdBy, l?.registeredBy,
              l?._raw?.usuario, l?._raw?.owner, l?._raw?.createdBy, l?._raw?.registeredBy
            ];
            const foundDirect = candidates.find(v => v && v.toString().trim().length);
            if (foundDirect) {
              const n = norm(foundDirect);
              // match por nombre completo primero
              if (teamAgents.has(n)) return n;
              // si no, intenta emparejar por apellido
              const hit = surnames.find(sn => n.includes(sn));
              if (hit) return surnameToFull.get(hit);
            }
            // 1a) Fallback por primer nombre si Team/supervisor indica TEAM IRANIA
            try {
              const eq = norm(l?.equipo || l?._raw?.equipo || l?.Team || l?.team || l?._raw?.Team || l?._raw?.team || '');
              const sup = norm(l?.supervisor || l?._raw?.supervisor || '');
              if (eq.includes('team irania') || sup.includes('team irania')) {
                const nombreAg = l?.nombreAgente || l?._raw?.nombreAgente || '';
                const byFirst = canonicalFromFirstName(nombreAg);
                if (byFirst) {
                  console.log('[Filtro TEAM IRANIA] Agente detectado por primer nombre:', byFirst);
                  return byFirst;
                }
              }
            } catch(_) {}
            // 2) Escaneo amplio: buscar cualquier string que contenga nombres/apellidos
            try {
              const scan = (obj) => {
                for (const [k, v] of Object.entries(obj || {})) {
                  if (v && typeof v === 'string') {
                    const n = norm(v);
                    const hitFull = fullNames.find(fn => n.includes(fn));
                    if (hitFull) return hitFull;
                    const hitSn = surnames.find(sn => n.includes(sn));
                    if (hitSn) return surnameToFull.get(hitSn);
                  }
                }
                return '';
              };
              const fromTop = scan(l || {});
              if (fromTop) return fromTop;
              const fromRaw = scan(l?._raw || {});
              if (fromRaw) return fromRaw;
            } catch(_) {}
            return '';
          };
          // ordenAgentes ya fue declarado arriba

          // Preservar lista original para fallback si el filtro quedara vacÂ¨Âªo
          const __originalLeads = Array.isArray(leadsArray) ? leadsArray.slice() : [];

          // Log de agentes detectados antes del filtro
          try {
            const agentesDetectados = Array.from(new Set((leadsArray||[]).map(getAgentName))).filter(Boolean);
            console.log('[TEAM IRANIA] Agentes detectados (normalizados):', agentesDetectados);
          } catch(_) {}
          
          // Construir mapa agenteId -> agente canÂ¨Â®nico (aceptar mÂ¨Â²ltiples variantes de campo)
          const getAgentId = (l) => {
            const raw = (
              l?.agenteId || l?._raw?.agenteId ||
              l?.agente_id || l?._raw?.agente_id ||
              l?.idAgente || l?._raw?.idAgente ||
              l?.agentId || l?._raw?.agentId ||
              l?.creadoPor || l?._raw?.creadoPor ||
              l?.creado_por || l?._raw?.creado_por ||
              l?.createdBy || l?._raw?.createdBy ||
              l?.ownerId || l?._raw?.ownerId ||
              l?.assignedId || l?._raw?.assignedId || ''
            );
            try {
              if (raw && typeof raw === 'object') {
                const maybe = raw.$oid || raw.id || raw._id || raw.value || (raw.toString ? raw.toString() : '');
                return String(maybe || '').trim();
              }
              return String(raw || '').trim();
            } catch(_) {
              return String(raw || '').trim();
            }
          };
          // 1) Mapa estÂ¨Â¢tico proporcionado (TEAM IRANIA)
          const idToCanon = new Map([
            ['68af44c3c61c405e2bb7b0cb', 'giselle diaz'],   // Giselle Diaz
            ['68af457bc61c405e2bb7b0ce', 'roxana martinez'], // Roxana Martinez
            ['68af453bc61c405e2bb7b0cd', 'miguel nunez'],    // Miguel Nunez
            ['68af44efc61c405e2bb7b0cc', 'josue renderos'],  // Josue Renderos
            ['68af4597c61c405e2bb7b0cf', 'tatiana ayala'],   // Tatiana Ayala
          ]);
          // 2) Enriquecer con un mapa dinÂ¨Â¢mico usando los leads con nombre detectable
          try {
            (leadsArray||[]).forEach(l => {
              const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
              const canon = canonicalFromName(getAgentName(l));
              const aid = getAgentId(l);
              if (canon && aid) idToCanon.set(aid, canon);
            });
            console.debug('[TEAM IRANIA] idToCanon generado:', Array.from(idToCanon.entries()));
          } catch(_) {}
          
          // Filtro ESTRICTO con canonizaciÂ¨Â®n: solo los agentes del TEAM IRANIA.
          // Si no se detecta agente pero el lead pertenece al equipo TEAM IRANIA por campo `equipo`, NO lo descartamos para no perderlo.
          const filteredStrict = leadsArray.filter(l => {
            const agente = getAgentName(l);
            const canon = canonicalFromName(agente);
            if (canon) {
              try { l.__agentCanon = canon; } catch(_) {}
              console.log('[Filtro TEAM IRANIA] Agente detectado:', canon);
              return true;
            }
            // intentar por agenteId con el mapa dinamico
            try {
              const aid = getAgentId(l);
              if (aid && idToCanon.has(aid)) {
                const mcanon = idToCanon.get(aid);
                try { l.__agentCanon = mcanon; } catch(_) {}
                console.log('[Filtro TEAM IRANIA] Agente detectado por ID:', mcanon);
                return true;
              }
            } catch(_) {}
            // fallback por equipo/supervisor
            try {
              const eq = norm(l?.equipo || l?._raw?.equipo || '');
              const sup = norm(l?.supervisor || l?._raw?.supervisor || '');
              if (eq.includes('team irania') || sup.includes('team irania')) {
                console.debug('[Filtro TEAM IRANIA] Manteniendo lead sin agente detectado por pertenecer al equipo/supervisor.', { eq, sup, leadId: (typeof getLeadId==='function')?getLeadId(l):undefined });
                return true;
              }
            } catch(_) {}
            return false;
          });
          // Si el filtro deja la lista vacÂ¨Âªa, mantener la lista original para no ocultar datos
          if (!filteredStrict || filteredStrict.length === 0) {
            console.warn('[Filtro TEAM IRANIA] Resultado vacÂ¨Âªo; se mantiene lista original para no ocultar datos.');
            leadsArray = __originalLeads;
          } else {
            leadsArray = filteredStrict;
          }
          console.log('[Filtro TEAM IRANIA - estricto] Leads tras filtro:', leadsArray.length);
        }
      } catch (e) {
        console.warn('No se pudo aplicar el filtro de TEAM IRANIA:', e);
      }
          
      console.log('Datos a renderizar (array):', leadsArray);
      
      const tbody = document.getElementById('costumer-tbody');
      console.log('Elemento tbody encontrado:', tbody);
      if (!tbody) {
        console.error('No se encontrÂ¨Â® el elemento con ID costumer-tbody');
        return;
      }
      
      tbody.innerHTML = '';
      // Permitir que el rol supervisor vea la tabla (se removiÂ¨Â® el aviso de permisos)
      
      // FunciÂ¨Â®n interna para a?adir una fila de lead manteniendo el orden y estilos 
      function appendLeadRow(lead) {
        const tr = document.createElement('tr');
        
        // Normalizar estado al conjunto requerido y su clase
        const statusLabel = normalizeStatusLabel(lead.status);
        const statusClass = statusToBadgeClass(statusLabel);
        const editable = canEditStatus();
        
        const fullComment = typeof lead.comentarios_venta === 'string' ? lead.comentarios_venta : '';
        const displayComment = fullComment ? (fullComment.length > 40 ? fullComment.substring(0, 40) + '...' : fullComment) : 'Ver comentarios';
        const titleAttr = fullComment ? escapeAttr(fullComment) : 'Ver comentarios';

        const __id = getLeadId(lead);
        try {
          if (__id) tr.setAttribute('data-lead-id', String(__id));
          tr.setAttribute('data-status', String(lead?.status || '').trim().toLowerCase());
        } catch(_) {
        }
        const __key = (() => {
          if (__id) return __id;
          try {
            window.__leadLocalCounter = (window.__leadLocalCounter || 0) + 1;
            const k = 'local_' + window.__leadLocalCounter;
            if (!window.__leadKeyMap) window.__leadKeyMap = new Map();
            window.__leadKeyMap.set(k, lead);
            return k;
          } catch(_) {
            return 'local_tmp';
          }
        })();

        const __delOnClick = __id ? `eliminarLead('${__id}')` : `eliminarLeadKey('${__key}')`;

        tr.innerHTML = `
          <td>${lead.nombre_cliente || 'N/A'}</td>
          <td>${lead.telefono_principal || 'N/A'}</td>
          <td>${lead.telefono_alterno || 'N/A'}</td>
          <td>${lead.numero_cuenta || 'N/A'}</td>
          <td>${(() => {
            const autop = lead.autopay ?? lead.autopago;
            return typeof autop === 'boolean' ? (autop ? 'Sí' : 'No') : 
                   (String(autop || '').toUpperCase() === 'SI' ? 'Sí' : 
                   (String(autop || '').toUpperCase() === 'NO' ? 'No' : (autop || 'N/A')));
          })()}</td>
          <td>${lead.direccion || 'N/A'}</td>
          <td>${lead.tipo_servicios || 'N/A'}</td>
          <td>${lead.sistema || 'N/A'}</td>
          <td>${lead.riesgo || 'N/A'}</td>
          <td>${(() => {
              console.log('Datos de lead:', {
                dia_venta: lead.dia_venta,
                dia_instalacion: lead.dia_instalacion,
                fecha_contratacion: lead.fecha_contratacion
              });
              return lead.dia_venta ? String(lead.dia_venta).slice(0,10) : 'N/A';
            })()}</td>
          <td>${lead.dia_instalacion ? String(lead.dia_instalacion).slice(0,10) : 'N/A'}</td>
          <td class="status-col">
            ${editable ? `
              <select class="status-select compact" data-prev="${statusLabel}" onchange="updateLeadStatus(this, '${__id}')">
                ${['Pending','Hold','Cancelled','Rescheduled','Completed','Active','Active Oficina'].map(opt => `
                  <option value="${opt.toLowerCase()}" ${opt===statusLabel?'selected':''}>${opt}</option>
                `).join('')}
              </select>
            ` : `
              <span class="badge ${statusClass}">${statusLabel}</span>
            `}
          </td>
          <td>${lead.servicios_texto || lead.servicios || 'N/A'}</td>
          <td>${lead.mercado || 'N/A'}</td>
          <td>${lead.supervisor || 'N/A'}</td>
          <td>${lead.comentario || 'N/A'}</td>
          <td>${lead.motivo_llamada || 'N/A'}</td>
          <td>${lead.zip_code || lead.zip || lead.ZIP || lead.cp || lead.codigo_postal || lead.postalCode || 'N/A'}</td>
          <td>${lead.puntaje || 'N/A'}</td>
          <td>
            <div style="display:flex; align-items:center; gap:10px;">
              <button class="action-btn" title="Editar" onclick="${__id ? `editarLead('${__id}')` : `editarLeadKey('${__key}')`}">
                <i class="fas fa-edit"></i>
              </button>
              ${(() => {
                try {
                  return (typeof canDeleteLead === 'function' && canDeleteLead())
                    ? `<button class="action-btn" title="Eliminar" onclick="${__delOnClick}"><i class="fas fa-trash"></i></button>`
                    : '';
                } catch (_) {
                  return '';
                }
              })()}
            </div>
          </td>
        `;
        // Obtener tbody localmente (evitar ReferenceError si no existe en el scope)
        const tbody = document.getElementById('costumer-tbody');
        if (!tbody) {
          console.warn('[appendLeadRow] No se encontrÂ¨Â® #costumer-tbody en el DOM');
          return;
        }
        tbody.appendChild(tr);
        try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}
      }

      // Guardar STATUS del lead (usado por el <select class="status-select">)
      function canEditStatus(){
        try{
          const u = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
          const r0 = String(u.role||u?.usuario?.role||'').toLowerCase().trim();
          const r = r0.replace(/\s+/g,'_').replace(/-+/g,'_');
          return r==='admin' || r==='administrador' || r==='administrator' || r==='backoffice' || r==='rol_icon' || r==='rol_bamo';
        }catch{ return false; }
      }
      function canDeleteLead(){
        try{
          const u = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
          const r = String(u.role||u?.usuario?.role||'').toLowerCase().trim().replace(/\s+/g,'_').replace(/-+/g,'_');
          if (!r) return false;
          if (r==='admin' || r==='administrador' || r==='administrator') return true;
          if (r==='backoffice' || r==='back office' || r==='back_office' || r==='bo' || r==='b.o' || r==='b-o' || r==='b:o' || r==='rol_icon' || r==='rol_bamo') return true;
          return false;
        } catch { return false; }
      }

      window.canFullEdit = function canFullEdit(){
        try{
          const u = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
          const roleRaw = String(u.role||u?.usuario?.role||'').toLowerCase().trim();
          const role = roleRaw.replace(/\s+/g,'_').replace(/-+/g,'_');
          const team = String(u.team||u?.usuario?.team||'').toLowerCase().trim().replace(/\s+/g,' ').replace(/_+/g,' ');

          const isAdmin = role==='admin' || role==='administrador' || role==='administrator';
          const isBackoffice = role==='backoffice' || role==='back_office' || role==='backoffice' || role==='bo' || role==='b.o' || role==='b-o' || role==='b:o' || role==='rol_icon' || role==='rol_bamo';

          const isSupervisorTeamLineas = role==='supervisor_team_lineas' || role==='supervisor_team_linea' || role==='supervisor_team_lineas';
          const isSupervisorLineas = (role==='supervisor' && team.includes('lineas'));

          return isAdmin || isBackoffice || isSupervisorTeamLineas || isSupervisorLineas;
        } catch {
          return false;
        }
      };

      window.canDeleteLead = canDeleteLead;
      window.updateLeadStatus = async function(selectEl, id){
        try{
          if (!canEditStatus()) { alert('No tienes permisos para cambiar el STATUS'); return; }
          if (!id) { alert('ID invÃ¡lido'); return; }
          const newStatus = String(selectEl && selectEl.value || '').trim();
          if (!newStatus) { alert('STATUS invÃ¡lido'); return; }
          // Solicitar motivo ANTES de cualquier await para no perder el gesto del usuario
          try {
            const newStatusLower = String(newStatus || '').toLowerCase();
            const triggerStatuses = ['cancel', 'hold', 'resched', 'repro', 'anulad', 'no instalado'];
            if (triggerStatuses.some(s => newStatusLower.includes(s))) {
              const sel = selectEl;
              const prev = String(sel?.getAttribute('data-prev') || '').trim();
              const clientName = ((sel?.closest('tr')?.querySelector('td')?.textContent || '')).trim();
              const title = 'Motivo del Cambio de Status';
              const text = `Â¿CuÃ¡l es el motivo del cambio de status${clientName ? ` de <b>${clientName}</b>` : ''} a <b>${newStatus}</b>?`;
              const reason = await askForReason(title, text);

              if (!reason || !reason.trim()) {
                if (sel && prev) {
                  sel.value = prev.toLowerCase();
                  sel.setAttribute('data-prev', prev);
                  sel.disabled = false;
                }
                return; // Abortar si no hay motivo
              }

              const commentText = `Status cambiado a ${newStatus}: ${reason}`;
              try {
                if (typeof addSystemComment === 'function') await addSystemComment(String(id).trim(), commentText);
                if (typeof sendDesktopNotification === 'function') sendDesktopNotification(`Status actualizado${clientName ? `: ${clientName}` : ''}`, commentText);
              } catch (e) {
                console.warn('No se pudo registrar el motivo/notificaciÃ³n:', e);
              }
            }
          } catch (e) {
            console.warn('Error solicitando motivo (global):', e);
          }
          // Mantener idioma tal como viene del select
          const payload = { status: newStatus };
          const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
          // Añadir Authorization si existe token en storage (compatibilidad con endpoints que usan Bearer token)
          try {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token') || '';
            if (token) headers['Authorization'] = 'Bearer ' + token;
          } catch(_) {}
          const opts = (method, body) => ({ method, credentials: 'include', headers, body: JSON.stringify(body) });
          // Endpoint real en backend - sin encodeURIComponent para ObjectIds de MongoDB
          const cleanId = String(id).trim();
          const target = { url: `/api/leads/${cleanId}/status`, method: 'PUT', body: payload };
          let ok = false, lastErr;
          console.log('[STATUS] Guardando', { id: cleanId, newStatus, endpoint: target.url });
          // feedback visual: desactivar todos los selects de esa fila
          try{
            const sel = selectEl;
            if (sel) sel.disabled = true;
          }catch{}
          try{
            const res = await fetch(target.url, opts(target.method, target.body));
            console.log('[STATUS] Respuesta', target.method, target.url, res.status);
            if (res.ok) ok = true;
            else {
              // Mejor diagnÃ³stico de 401 (no autorizado)
              if (res.status === 401) {
                lastErr = new Error(`HTTP 401 Unauthorized @ ${target.url}`);
                try { console.warn('[STATUS] 401 recibido. Posible token invÃ¡lido/expirado o cookie ausente.'); } catch(_){}
              } else {
                lastErr = new Error(`HTTP ${res.status} @ ${target.url}`);
              }
            }
          }catch(e){ lastErr = e; }
          if (!ok) { throw lastErr || new Error('No se pudo actualizar el STATUS'); }
          // Actualizar SOLO la fila afectada y recolorear
          try {
            // PASO 0: Deshabilitar temporalmente el observer para evitar que se dispare durante nuestra actualizaciÃ³n
            // Usar referencias seguras porque el observer puede estar declarado en un IIFE
            const globalObserver = (typeof window._statusObserver !== 'undefined') ? window._statusObserver : (typeof _statusObserver !== 'undefined' ? _statusObserver : (window.__rowColorObserver || null));
            const wasObservingBefore = !!globalObserver;
            if (globalObserver && typeof globalObserver.disconnect === 'function') {
              try { globalObserver.disconnect(); } catch {}
              console.log('[STATUS] Observer deshabilitado temporalmente');
            }
            
            // PASO 1: actualizar en memoria PRIMERO
            const lead = (window.ultimaListaLeads||[]).find(l=>String((typeof getLeadId==='function')?getLeadId(l):l.id)===String(id));
            if (lead) { try { lead.status = newStatus; console.log('[STATUS] Memoria actualizada:', { id, status: newStatus }); } catch(_) {} }
            
            // PASO 2: localizar fila
            const tr = document.querySelector(`tr[data-lead-id="${id}"]`) || (function(){
              try{
                const sel = selectEl;
                return sel ? sel.closest('tr') : null;
              }catch{ return null; }
            })();
            
            if (tr) {
              try {
                console.log('[STATUS] Actualizando fila DOM para ID:', id);

                // Forzar actualizaciÃ³n del atributo en la fila principal tambiÃ©n
                tr.setAttribute('data-status', String(newStatus||'').trim().toLowerCase());

                // Aplicar clase/estilos INLINE
                if (typeof applyRowClass === 'function') {
                  applyRowClass(tr, newStatus);
                }
                console.log('[STATUS] Clase y color aplicados:', newStatus);

                // Actualizar selects y reactivarlos
                const sels = tr.querySelectorAll('select.status-select');
                sels.forEach(sel => { 
                  sel.value = String(newStatus||'').trim();
                  sel.disabled = false;
                  sel.removeAttribute('disabled');
                  try { sel.setAttribute('data-prev', String(newStatus||'').trim()); } catch(_) {}
                });
                console.log('[STATUS] Selects actualizados y reactivados:', sels.length);
              } catch(e) { 
                console.warn('[STATUS] Error actualizando DOM de la fila:', e); 
              } finally {
                // RebuildStickyHead
                try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}
              }
            }
            
            // PASO 4: actualizar TODOS los selects en la celda (puede haber mÃºltiples)
          } catch(e) { console.warn('[STATUS] Error en actualizaciÃ³n POST-servidor:', e); }
        }catch(e){
          console.warn('[STATUS] FallÃ³ actualizaciÃ³n:', e);
          alert('No se pudo actualizar el STATUS: ' + (e?.message||e));
        } finally {
          // Rehabilitar por si hubo error temprano
          try{
            const sel = selectEl;
            if (sel) { sel.disabled = false; sel.removeAttribute('disabled'); }
          }catch{}
        }
      }

      // Helper: render con separadores mensuales usando getDateFromLead
      function renderWithMonthlySeparators(list) {
        console.log('[renderWithMonthlySeparators] INICIANDO con', list?.length || 0, 'items');
        const tbodyLoc = document.getElementById('costumer-tbody');
        if (!tbodyLoc) return;
        
        // Limpiar tbody antes de renderizar
        tbodyLoc.innerHTML = '';

        // PASO 0.5: ocultar Active Oficina en vista general para admin/backoffice
        try {
          const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
          const roleNorm = (function normalizeRole(r){
            if (!r) return 'agente';
            if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
            if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
            if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
            if (['backoffice','back office','back_office','bo','b.o','b:o','b-o'].includes(r)) return 'backoffice';
            return r;
          })(roleRaw);
          const teamDropdown0 = document.getElementById('teamFilter');
          const selectedTeam0 = teamDropdown0 ? String(teamDropdown0.value || '').trim().toLowerCase() : '';
          const isAdminLike = (roleNorm === 'admin' || roleNorm === 'backoffice');
          const isTeamOficina = (selectedTeam0 === 'oficina');
          if (isAdminLike && !isTeamOficina && Array.isArray(list) && list.length > 0) {
            list = list.filter(item => {
              const s = normalizarTexto(item?.status || item?._raw?.status || '');
              const isActiveOficina = ((s.includes('active') || s.includes('activo')) && s.includes('oficina'));
              return !isActiveOficina;
            });
          }
        } catch(e) {
          console.warn('[ActiveOficina] Error en filtro de visibilidad:', e);
        }
        
        // PASO 1: SIEMPRE aplicar filtro de Team si hay un valor en el dropdown
        try {
          const teamDropdown = document.getElementById('teamFilter');
          const selectedTeam = teamDropdown ? teamDropdown.value : '';
          
          if (selectedTeam && Array.isArray(list) && list.length > 0) {
            const beforeFilter = list.length;
            const selectedTeamNorm = selectedTeam.toLowerCase().trim();
            
            // Verificar si la lista ya está filtrada por este supervisor
            const supervisorsInList = [...new Set(list.map(l => (l?.supervisor || '').toLowerCase().trim()))];
            const alreadyFiltered = supervisorsInList.length === 1 && supervisorsInList[0] === selectedTeamNorm;
            
            if (!alreadyFiltered) {
              list = list.filter(item => {
                const itemSup = (item?.supervisor || item?.team || '').toLowerCase().trim();
                if (itemSup === selectedTeamNorm) return true;

                // Caso especial: Team = Oficina
                // En algunos registros, Oficina no viene en supervisor/team, sino en status o en el campo oficina.
                if (selectedTeamNorm === 'oficina') {
                  try {
                    const s = normalizarTexto(item?.status || item?._raw?.status || '');
                    const isActiveOficina = ((s.includes('active') || s.includes('activo')) && s.includes('oficina'));
                    if (isActiveOficina) return true;
                  } catch (_) {}

                  try {
                    const of = (item?.oficina ?? item?._raw?.oficina ?? item?.OFICINA ?? '').toString().toLowerCase().trim();
                    if (of === 'oficina' || of === 'si' || of === 'sí' || of === 'true' || of === '1') return true;
                  } catch (_) {}
                }

                return false;
              });
              console.log('[TEAM FILTER] Aplicado:', selectedTeam, '| Antes:', beforeFilter, '| DespuÃ©s:', list.length);
            } else {
              console.log('[TEAM FILTER] Lista ya filtrada por:', selectedTeam);
            }
          }
        } catch(e) {
          console.warn('[TEAM FILTER] Error:', e);
        }

        // PASO 1.5: SIEMPRE aplicar filtro de Agente si hay un valor en el dropdown O en el override
        try {
          const agentDropdown = document.getElementById('agentFilter');
          let selectedAgent = agentDropdown ? agentDropdown.value : '';
          
          // Priorizar Override si existe (para clics del sidebar donde el dropdown se actualiza con delay)
          if (window.SIDEBAR_FILTER_OVERRIDE && window.SIDEBAR_FILTER_OVERRIDE.agent) {
            selectedAgent = window.SIDEBAR_FILTER_OVERRIDE.agent;
            console.log('[AGENT FILTER] Usando SIDEBAR_FILTER_OVERRIDE:', selectedAgent);
          }
          
          if (selectedAgent && Array.isArray(list) && list.length > 0) {
            const beforeFilter = list.length;
            const selectedAgentNorm = selectedAgent.toLowerCase().trim();
            
            // Obtener variaciones de búsqueda si existen (para Jorge Segovia)
            let searchNames = [selectedAgent];
            if (window.SIDEBAR_FILTER_OVERRIDE && window.SIDEBAR_FILTER_OVERRIDE.searchNames) {
              searchNames = window.SIDEBAR_FILTER_OVERRIDE.searchNames;
            }

            const normalizeNameForMatch = (s) => {
              try {
                return String(s || '')
                  .toLowerCase()
                  .trim()
                  .normalize('NFD')
                  .replace(/[\u0300-\u036f]/g, '')
                  .replace(/[^a-z0-9]+/g, ' ')
                  .trim()
                  .replace(/\s+/g, ' ');
              } catch (_) {
                return String(s || '').toLowerCase().trim();
              }
            };
            
            list = list.filter(item => {
              const itemAgent = (item?.agente || item?.agenteNombre || item?.nombreAgente || item?.agent || item?.usuario || '').toLowerCase().trim();
              const itemAgentNorm2 = normalizeNameForMatch(itemAgent);
              
              // Buscar coincidencia con cualquiera de las variaciones
              return searchNames.some(searchName => {
                const searchNormRaw = searchName.toLowerCase().trim();
                const searchNorm2 = normalizeNameForMatch(searchNormRaw);

                if (!itemAgentNorm2 || !searchNorm2) return false;
                if (itemAgentNorm2 === searchNorm2) return true;
                if (itemAgentNorm2.includes(searchNorm2) || searchNorm2.includes(itemAgentNorm2)) return true;

                const tokens = searchNorm2.split(' ').filter(Boolean);
                const keyTokens = tokens.length >= 2 ? [tokens[0], tokens[tokens.length - 1]] : tokens;
                return keyTokens.length ? keyTokens.every(t => itemAgentNorm2.includes(t)) : false;
              });
            });
            console.log('[AGENT FILTER] Aplicado:', selectedAgent, '| Variaciones:', searchNames.length, '| Antes:', beforeFilter, '| Después:', list.length);
          }
        } catch(e) {
          console.warn('[AGENT FILTER] Error:', e);
        }
        // PASO 1.75: aplicar filtro de Mercado
        try {
          const mercadoDropdown = document.getElementById('mercadoFilter');
          const selectedMercado = mercadoDropdown ? String(mercadoDropdown.value || '').trim().toUpperCase() : '';
          if (selectedMercado && Array.isArray(list) && list.length > 0) {
            const beforeFilter = list.length;
            list = list.filter(item => {
              const m = String(item?.mercado || item?._raw?.mercado || '').trim().toUpperCase();
              return m === selectedMercado;
            });
            console.log('[MERCADO FILTER] Aplicado:', selectedMercado, '| Antes:', beforeFilter, '| DespuÃ©s:', list.length);
          }
        } catch(e) {
          console.warn('[MERCADO FILTER] Error:', e);
        }

        // PASO 1.8: aplicar filtro de Status
        try {
          const statusDropdown = document.getElementById('statusFilter');
          const selectedStatus = statusDropdown ? String(statusDropdown.value || '').trim().toLowerCase() : 'all';
          
          // Obtener mes objetivo para filtrar por instalación (misma lógica que KPIs)
          const monthSelectKpi = document.getElementById('monthFilter');
          const monthUi = monthSelectKpi ? String(monthSelectKpi.value || '').trim() : '';
          const monthFromState = (() => {
            try {
              const m1 = (typeof __selectedMonth !== 'undefined') ? String(__selectedMonth || '').trim() : '';
              if (m1 && /^\d{4}-\d{2}$/.test(m1)) return m1;
            } catch (_) {}
            try {
              const m2 = (window && window.__selectedMonth) ? String(window.__selectedMonth || '').trim() : '';
              if (m2 && /^\d{4}-\d{2}$/.test(m2)) return m2;
            } catch (_) {}
            return '';
          })();
          const effectiveMonth = (monthUi && /^\d{4}-\d{2}$/.test(monthUi)) ? monthUi : monthFromState;
          const __hasExplicitMonthFilter = !!(effectiveMonth && /^\d{4}-\d{2}$/.test(effectiveMonth));
          const targetMonthStr = __hasExplicitMonthFilter
            ? String(effectiveMonth).trim()
            : (() => {
              const now = new Date();
              return `${String(now.getFullYear()).padStart(4,'0')}-${String(now.getMonth() + 1).padStart(2,'0')}`;
            })();
          const [yTarget, mTarget] = targetMonthStr.split('-').map(Number);
          
          if (selectedStatus && selectedStatus !== 'all' && Array.isArray(list) && list.length > 0) {
            const beforeFilter = list.length;
            const matchSelectedStatus = (statusNorm) => {
              const s = String(statusNorm || '');
              if (selectedStatus === 'pending') return (s.includes('pendient') || s.includes('pending'));
              if (selectedStatus === 'cancelled') return (s.includes('cancel') || s.includes('anulad') || s.includes('no instalado'));
              if (selectedStatus === 'completed') return (s.includes('complet') || s.includes('complete') || s.includes('active') || s.includes('activo'));
              if (selectedStatus === 'active') return (s.includes('active') || s.includes('activo'));
              if (selectedStatus === 'active_oficina') return ((s.includes('active') || s.includes('activo')) && s.includes('oficina'));
              if (selectedStatus === 'hold') return (s.includes('hold') || s.includes('espera'));
              if (selectedStatus === 'rescheduled') return (s.includes('resched') || s.includes('reprogram'));
              return true;
            };
            
            list = list.filter(item => {
              const s = normalizarTexto(item?.status || item?._raw?.status || '');
              const statusMatch = matchSelectedStatus(s);

              return statusMatch;
            });
            console.log('[STATUS FILTER] Aplicado:', selectedStatus, '| Mes:', targetMonthStr, '| Antes:', beforeFilter, '| Después:', list.length);
          }
        } catch(e) {
          console.warn('[STATUS FILTER] Error:', e);
        }

        // PASO 1.825: aplicar filtro de Servicios
        try {
          const serviceEl = document.getElementById('serviceFilter');
          const termRaw = serviceEl ? String(serviceEl.value || '') : '';
          const term = termRaw.trim();
          if (term && Array.isArray(list) && list.length > 0) {
            const beforeFilter = list.length;
            const norm = (s) => {
              try {
                return String(s || '')
                  .normalize('NFD')
                  .replace(/\p{Diacritic}+/gu,'')
                  .toLowerCase()
                  .trim();
              } catch {
                return String(s || '').toLowerCase().trim();
              }
            };
            const extractServices = (item) => {
              try {
                const parts = [];
                const push = (v) => { if (!v) return; parts.push(String(v)); };
                push(item?.servicios_texto);
                push(item?.tipo_servicios);
                push(item?.servicios);
                push(item?.producto);
                push(item?.sistema);
                push(item?._raw?.servicios_texto);
                push(item?._raw?.tipo_servicios);
                push(item?._raw?.servicios);
                push(item?._raw?.producto);
                push(item?._raw?.sistema);
                const tels = Array.isArray(item?.telefonos) ? item.telefonos : (Array.isArray(item?._raw?.telefonos) ? item._raw.telefonos : []);
                if (Array.isArray(tels) && tels.length) {
                  tels.forEach(t => {
                    push(t?.servicio);
                    push(t?.tipo);
                    push(t?.servicios);
                    push(t?.tipo_servicios);
                  });
                }
                return parts.join(' | ');
              } catch (_) {
                return '';
              }
            };
            const t = norm(term);
            list = list.filter(item => norm(extractServices(item)).includes(t));
            console.log('[SERVICE FILTER] Aplicado:', term, '| Antes:', beforeFilter, '| DespuÃ©s:', list.length);
          }
        } catch(e) {
          console.warn('[SERVICE FILTER] Error:', e);
        }

        // PASO 1.85: aplicar bÃºsqueda de texto (sobre los datos ya cargados/paginados)
        try {
          const searchEl = document.getElementById('costumer-search');
          const termRaw = searchEl ? String(searchEl.value || '') : '';
          const term = termRaw.trim();
          if (term && Array.isArray(list) && list.length > 0) {
            const beforeFilter = list.length;
            const norm = (s) => {
              try {
                return String(s || '')
                  .normalize('NFD')
                  .replace(/\p{Diacritic}+/gu,'')
                  .toLowerCase()
                  .trim();
              } catch {
                return String(s || '').toLowerCase().trim();
              }
            };
            const t = norm(term);
            list = list.filter(item => {
              const fields = [
                item?.nombre_cliente,
                item?.telefono_principal,
                item?.telefono_alterno,
                item?.numero_cuenta,
                item?.direccion,
                item?.zip_code,
                item?.zip,
                item?.mercado,
                item?.supervisor,
                item?.servicios,
                item?.tipo_servicios,
                item?.comentario,
                item?.motivo_llamada,
                item?._raw?.nombre_cliente,
                item?._raw?.telefono_principal,
                item?._raw?.numero_cuenta,
                item?._raw?.direccion
              ];
              return fields.some(v => norm(v).includes(t));
            });
            console.log('[SEARCH FILTER] Aplicado:', term, '| Antes:', beforeFilter, '| DespuÃ©s:', list.length);
          }
        } catch(e) {
          console.warn('[SEARCH FILTER] Error:', e);
        }
        // PASO 2: Aplicar filtro de mes seleccionado
        try {
          const monthFilter = document.getElementById('monthFilter');
          const monthUi = monthFilter ? String(monthFilter.value || '').trim() : '';
          const selectedMonth = (monthUi && /^\d{4}-\d{2}$/.test(monthUi))
            ? monthUi
            : (() => {
              try {
                const m1 = (typeof __selectedMonth !== 'undefined') ? String(__selectedMonth || '').trim() : '';
                if (m1 && /^\d{4}-\d{2}$/.test(m1)) return m1;
              } catch (_) {}
              try {
                const m2 = (window && window.__selectedMonth) ? String(window.__selectedMonth || '').trim() : '';
                if (m2 && /^\d{4}-\d{2}$/.test(m2)) return m2;
              } catch (_) {}
              return '';
            })();
          
          if (selectedMonth && Array.isArray(list)) {
            console.log('[FilterOrder] PASO 2 - Filtrando por mes:', selectedMonth, 'Items despuÃ©s de Team/Agent:', list.length);

            // Regla de mes para tabla: "mes" (por fecha de venta) + "colchón" (venta mes anterior instalada en el mes seleccionado)
            const [yT, mT] = selectedMonth.split('-').map(Number);
            let yP = yT;
            let mP = mT - 1;
            if (mP < 1) { mP = 12; yP = yT - 1; }
            const prevMonth = `${String(yP).padStart(4,'0')}-${String(mP).padStart(2,'0')}`;
            
            // Debug: SIEMPRE mostrar conteo por mes para diagnosticar
            const datesByMonth = {};
            const sample = [];
            list.forEach((item, idx) => {
              const iso = getSaleDateFromLead(item);
              const ym = iso ? iso.slice(0,7) : 'sin-fecha';
              datesByMonth[ym] = (datesByMonth[ym] || 0) + 1;
              if (idx < 3 || !iso) {
                sample.push({ 
                  idx, 
                  dia_venta: item?.dia_venta, 
                  raw_field: item?._raw?.dia_venta,
                  iso_result: iso,
                  campos: { 
                    nombre: item?.nombre_cliente?.slice?.(0,20),
                    dia_venta: item?.dia_venta?.toString?.(),
                    fecha: item?.fecha?.toString?.()
                  }
                });
              }
            });
            console.log('[DEBUG MESES] Conteo por mes disponible:', datesByMonth);
            console.log('[DEBUG MESES] Sample de items (primeros 3 + items sin fecha):', sample);
            
            list = list.filter(item => {
              const leadISO = getSaleDateFromLead(item);
              if (!leadISO || !/^\d{4}-\d{2}-\d{2}$/.test(leadISO)) return false;
              const leadYM = leadISO.slice(0,7);
              if (leadYM === selectedMonth) return true;

              // Colchón: venta mes anterior + instalación en mes seleccionado
              if (leadYM === prevMonth) {
                const installISO = getInstallDateFromLead(item);
                if (installISO && /^\d{4}-\d{2}-\d{2}$/.test(installISO)) {
                  const installYM = installISO.slice(0,7);
                  return installYM === selectedMonth;
                }
              }

              const matches = false;
              if (!matches && window.__debugMonthFilter) {
                console.log('[FILTER DEBUG]', { leadYM, selectedMonth, leadISO, cliente: item?.nombre_cliente?.slice?.(0,20) });
              }
              return false;
            });
            console.log('[FilterOrder] PASO 2 - Filtrado por mes:', selectedMonth, 'Resultados finales:', list.length);
            
            // IMPORTANTE: Aplicar filtro por agente DESPUÃ‰S del filtro de mes si es necesario (seguridad por rol)
            try {
              const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
              const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
              const role = (function normalizeRole(r){
                if (!r) return 'agente';
                if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
                if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
                if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
                if (['backoffice','back office','back_office','bo','b.o','b:o','b-o'].includes(r)) return 'backoffice';
                return r;
              })(roleRaw);
              
              if (role === 'agente') {
                // Aplicar filtro de seguridad para agentes
                const norm = (s) => String(s || '').toLowerCase().replace(/[^a-z0-9]+/g,'');
                const str = (v) => (v == null ? '' : String(v));
                const myIds = [
                  userData.id, userData._id, userData.userId, userData.uid,
                  userData?.usuario?._id, userData?.usuario?.id
                ].map(str).filter(x => x.trim().length);
                const myNames = [
                  userData.name, userData.nombre, userData.username, userData.email
                ].map(str).filter(x => x.trim().length);
                
                const myIdsNorm = new Set(myIds.map(x => norm(x)));
                const myNamesNorm = new Set(myNames.map(x => norm(x)));
                
                console.log('[FilterOrder AGENTE] User IDs:', myIds, 'Names:', myNames);
                const listBeforeFilter = list.length;
                
                list = list.filter(l => {
                  const leadId = norm(String(l?.agenteId || l?.idAgente || l?.agentId || ''));
                  if (leadId && myIdsNorm.has(leadId)) return true;
                  const leadName = norm(String(l?.agenteNombre || l?.nombreAgente || l?.agente || ''));
                  if (leadName && myNamesNorm.has(leadName)) return true;
                  return false;
                });
                
                console.log('[FilterOrder AGENTE] Filtrado de', listBeforeFilter, 'a', list.length, 'items del agente');
              }
            } catch (e) { console.warn('[MonthFilter] Error filtro seguridad agente:', e); }
          }
        } catch(e) { 
          console.warn('[MonthFilter] Error aplicando filtro:', e);
        }

        try {
          const recuentoEl = document.getElementById('recuentoCount');
          if (recuentoEl) {
            const n = Array.isArray(list) ? list.length : 0;
            recuentoEl.value = String(n);
            try { window.__recuentoLast = n; } catch(_) {}
          }
        } catch (e) {
          console.warn('[RECUENTO] Error actualizando recuento:', e);
        }

        try {
          try { window.__kpiLeadsLast = Array.isArray(list) ? list.slice() : []; } catch(_) {}
          if (typeof updateSummaryCards === 'function') {
            updateSummaryCards(list);
          }
        } catch (e) {
          console.warn('[renderWithMonthlySeparators] Error actualizando cards:', e);
        }
        
        // MOVIDO: Los filtros de Team y Agente ahora se aplican ANTES del filtro de mes
        const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        
        // Debug: Ver quÃ© datos llegan antes del ordenamiento
        if (window.__debugMonthFilter && Array.isArray(list)) {
          const sampleDates = list.slice(0, 10).map(item => ({
            fecha: getDateFromLead(item),
            agente: item?.agente || item?.agenteNombre || 'sin agente'
          }));
          console.log('[RENDER DEBUG] Primeras 10 fechas antes de ordenar:', sampleDates);
        }
        
        // Ordenar por fecha descendente usando getDateFromLead (YYYY-MM-DD)
        const sorted = (Array.isArray(list) ? list.slice() : []).sort((a,b) => {
          const da = (a && a.__isoDate) ? a.__isoDate : getDateFromLead(a); // 'YYYY-MM-DD' o ''
          const db = (b && b.__isoDate) ? b.__isoDate : getDateFromLead(b);
          const ta = da ? Date.parse(da) : 0;
          const tb = db ? Date.parse(db) : 0;
          return tb - ta; // descendente
        });
        
        // Debug: Ver quÃ© datos quedan despuÃ©s del ordenamiento
        if (window.__debugMonthFilter && Array.isArray(sorted)) {
          const sampleDatesSorted = sorted.slice(0, 10).map(item => ({
            fecha: getDateFromLead(item),
            agente: item?.agente || item?.agenteNombre || 'sin agente'
          }));
          console.log('[RENDER DEBUG] Primeras 10 fechas despuÃ©s de ordenar:', sampleDatesSorted);
        }
        let lastKey = '';
        console.log('[RENDER FINAL] A punto de renderizar', sorted.length, 'items. Supervisores:', 
          [...new Set(sorted.map(x => x?.supervisor || x?._raw?.supervisor || '(vacÃ­o)'))].join(', '));
        sorted.forEach(item => {
          const iso = getDateFromLead(item);
          let key = 'Sin fecha';
          let title = 'Sin fecha â€” Clientes';
          if (iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)) {
            const [y, m] = iso.split('-').map(Number);
            key = `${y}-${('0'+m).slice(-2)}`;
            title = `${monthNames[(m||1)-1]} ${y} â€” Clientes`;
          }
          if (key !== lastKey) {
            lastKey = key;
            const sep = document.createElement('tr');
            sep.className = 'costumer-month-separator';
            sep.innerHTML = `<td colspan="21" style="background:#e2e8f0;font-weight:700;border-left:4px solid #1976d2;padding:12px 18px;color:#0f172a;">${title}</td>`;
            tbodyLoc.appendChild(sep);
          }
          appendLeadRow(item);
        });
        try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}

        // Debug visual: comprobar que se aÃ±adieron filas y mostrar propiedades del primer registro
        setTimeout(() => {
          try {
            const totalRows = tbodyLoc.querySelectorAll('tr').length;
            console.log('[RENDER DEBUG] total TRs en tbody:', totalRows);
            const firstRow = tbodyLoc.querySelector('tr:not(.costumer-month-separator)');
            if (firstRow) {
              try {
                console.log('[RENDER DEBUG] firstRow innerHTML (slice):', firstRow.innerHTML.slice(0,300));
                const cs = window.getComputedStyle(firstRow);
                console.log('[RENDER DEBUG] firstRow styles:', { display: cs.display, visibility: cs.visibility, color: cs.color, background: cs.backgroundColor, offsetHeight: firstRow.offsetHeight });
              } catch(e){ console.warn('[RENDER DEBUG] error leyendo estilos firstRow', e); }
            } else {
              console.warn('[RENDER DEBUG] No se encontró primera fila no-separador');
            }
          } catch(e) { console.warn('[RENDER DEBUG] error conteo filas:', e); }
        }, 250);
        
        // Aplicar colores automÃ¡ticamente despuÃ©s del renderizado
        setTimeout(() => {
          try {
            if (typeof window.forceRecolorAllRows === 'function') {
              console.log('[renderWithMonthlySeparators] Aplicando colores automÃ¡ticamente...');
              window.forceRecolorAllRows();
            } else if (typeof window.applyRowStatusColors === 'function') {
              console.log('[renderWithMonthlySeparators] Aplicando colores (fallback)...');
              window.applyRowStatusColors();
            }
          } catch (e) {
            console.warn('[renderWithMonthlySeparators] Error aplicando colores:', e);
          }
        }, 100);
      }

      // Helper: obtener agente canÂ¨Â®nico desde mÂ¨Â²ltiples campos y escaneo amplio
      function getAgentCanonUniversal(l) {
        try {
          const teamsApi = (window && window.Teams) ? window.Teams : null;
          const canonical = (name) => {
            try {
              return teamsApi && typeof teamsApi.canonicalFromName === 'function'
                ? teamsApi.canonicalFromName(name)
                : (name||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
            } catch { return (name||'').toString().trim().toLowerCase(); }
          };
          if (l && l.__agentCanon) return l.__agentCanon;
          const candidates = [
            l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
            l?.vendedor, l?.seller, l?.usuario, l?.owner, l?.createdBy, l?.registeredBy,
            l?.asignadoA, l?.asignado_a, l?.assignedTo, l?.assigned_to,
            l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente,
            l?._raw?.agent, l?._raw?.Agent, l?._raw?.vendedor, l?._raw?.seller,
            l?._raw?.usuario, l?._raw?.owner, l?._raw?.createdBy, l?._raw?.registeredBy,
            l?._raw?.asignadoA, l?._raw?.asignado_a, l?._raw?.assignedTo, l?._raw?.assigned_to
          ];
          const first = candidates.find(v => v && String(v).trim().length);
          if (first) { const c = canonical(first); try { if (c) l.__agentCanon = c; } catch(_) {} return c; }
          // Fallback por agenteId usando mapa global precalculado
          try {
            const idMap = window.__idToCanonGlobal;
            if (idMap && typeof idMap.get === 'function') {
              const raw = (
                l?.agenteId || l?._raw?.agenteId || l?.agente_id || l?._raw?.agente_id ||
                l?.idAgente || l?._raw?.idAgente || l?.agentId || l?._raw?.agentId ||
                l?.creadoPor || l?._raw?.creadoPor || l?.creado_por || l?._raw?.creado_por ||
                l?.createdBy || l?._raw?.createdBy || l?.ownerId || l?._raw?.ownerId ||
                l?.registeredById || l?._raw?.registeredById ||
                l?.assignedId || l?._raw?.assignedId || ''
              );
              const aid = (function(x){ try{ if (x && typeof x==='object') return String(x.$oid||x.id||x._id||x.value||'').trim(); let s=String(x||'').trim(); const m=s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); if(m) s=m[1]; return s; } catch{ return String(raw||'').trim(); } })(raw);
              if (aid) { const viaId = idMap.get(aid); if (viaId) { try { l.__agentCanon = viaId; } catch(_) {} return viaId; } }
            }
          } catch(_) {}
          // Escaneo amplio por strings en objetos anidados
          const scan = (obj) => {
            try {
              for (const [k,v] of Object.entries(obj||{})) {
                if (typeof v === 'string' && v) {
                  const c = canonical(v);
                  if (c) {
                    if (teamsApi && typeof teamsApi.getTeamByAgent === 'function') {
                      const t = teamsApi.getTeamByAgent(c);
                      if (t) { try { l.__agentCanon = c; } catch(_) {} return c; }
                    } else {
                      try { l.__agentCanon = c; } catch(_) {}
                      return c;
                    }
                  }
                }
              }
            } catch(_) {}
            return '';
          };
          const fromTop = scan(l);
          if (fromTop) return fromTop;
          const fromRaw = scan(l?._raw);
          if (fromRaw) return fromRaw;
          return '';
        } catch { return ''; }
      }

      // Forzar toolbar por TEAM vÂ¨Âªa query param: ?forceTeam=team%20marisol%20beltran
      try {
        const uspFT = new URLSearchParams(window.location.search || '');
        const forceTeamRaw = (uspFT.get('forceTeam') || uspFT.get('team') || '').toString();
        if (forceTeamRaw) {
          const teamsApiFT = (window && window.Teams) ? window.Teams : null;
          const normFT = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const teamKeyFT = teamsApiFT && typeof teamsApiFT.getTeamDef==='function' ? normFT(forceTeamRaw) : normFT(forceTeamRaw);
          let teamAgentsFT = [];
          if (teamsApiFT && typeof teamsApiFT.getAgentsByTeam==='function') {
            teamAgentsFT = teamsApiFT.getAgentsByTeam(teamKeyFT) || [];
          }
          // Fallback: derivar agentes desde leads si la lista viene vacÂ¨Âªa
          if ((!teamAgentsFT || teamAgentsFT.length===0) && Array.isArray(leadsArray)) {
            const setFT = new Set();
            leadsArray.forEach(l => {
              const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
              const c = teamsApiFT && typeof teamsApiFT.canonicalFromName==='function' ? teamsApiFT.canonicalFromName(cand) : normFT(cand);
              if (c) setFT.add(c);
            });
            teamAgentsFT = Array.from(setFT);
            console.log('[Toolbar ForceTeam] Agentes derivados =', teamAgentsFT);
          }
          try {
            console.log('[Toolbar ForceTeam] teamKey =', teamKeyFT);
            console.log('[Toolbar ForceTeam] agentes (canÂ¨Â®nicos) =', teamAgentsFT);
            if (teamsApiFT && typeof teamsApiFT.getDisplayName==='function') {
              console.log('[Toolbar ForceTeam] etiquetas =', teamAgentsFT.map(a=>teamsApiFT.getDisplayName(a)));
            }
          } catch(_) {}
          // Construir barra
          const tbodyElFT = document.getElementById('costumer-tbody');
          if (tbodyElFT) {
            const tableElFT = tbodyElFT.closest('table');
            const hostFT = tableElFT ? tableElFT : tbodyElFT;
            let barFT = document.getElementById('irania-agent-filter');
            if (!barFT) {
              barFT = document.createElement('div');
              barFT.id = 'irania-agent-filter';
              barFT.style.margin = '10px 0';
              barFT.style.display = 'flex';
              barFT.style.flexWrap = 'wrap';
              barFT.style.gap = '8px';
              (hostFT.parentElement || hostFT).insertBefore(barFT, hostFT);
              barFT.style.position = 'sticky';
              barFT.style.top = '0';
              barFT.style.zIndex = '10';
              barFT.style.background = '#ffffff';
              barFT.style.padding = '8px 8px';
            }
            const mkBtnFT = (label, value) => {
              const b = document.createElement('button');
              b.textContent = label;
              b.type = 'button';
              b.style.padding = '6px 10px';
              b.style.border = '1px solid #e2e8f0';
              b.style.borderRadius = '999px';
              b.style.background = '#ffffff';
              b.style.cursor = 'pointer';
              b.style.fontSize = '12px';
              const active = (window.supervisorAgentFilter || null) === value;
              if (active) { b.style.background = '#1d4ed8'; b.style.color = '#ffffff'; b.style.borderColor = '#1d4ed8'; }
              b.addEventListener('click', () => {
                window.supervisorAgentFilter = value; // null = Todos
                try { 
                    if (typeof window.renderCostumerTable === 'function') {
                        window.renderCostumerTable(window.ultimaListaLeads || []);
                    } else {
                        console.error('La funciÂ¨Â®n renderCostumerTable no estÂ¨Â¢ disponible');
                    }
                } catch(e) { console.error('Error al renderizar tabla:', e); }
              });
              return b;
            };
            barFT.innerHTML = '';
            barFT.appendChild(mkBtnFT('Todos', null));
            teamAgentsFT.forEach(a => {
              const label = (teamsApiFT && typeof teamsApiFT.getDisplayName==='function') ? teamsApiFT.getDisplayName(a) : a.replace(/\b\w/g, c=>c.toUpperCase());
              barFT.appendChild(mkBtnFT(label, a));
            });
          }
          // Aplicar filtro activo y render
          const teamsApi2FT = (window && window.Teams) ? window.Teams : null;
          const norm2FT = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const canonicalFromNameFT = (name) => {
            if (teamsApi2FT && typeof teamsApi2FT.canonicalFromName==='function') return teamsApi2FT.canonicalFromName(name);
            const n = norm2FT(name); if (!n) return ''; if (teamAgentsFT.includes(n)) return n; for (const c of teamAgentsFT){ const toks=c.split(' '); if (toks.every(t=>n.includes(t))) return c; } return '';
          };
          const getAgentCanonFT = (l) => getAgentCanonUniversal(l);
          try { console.debug('[ForceTeam] teamAgentsFT =', teamAgentsFT); } catch(_) {}
          const tryCanonNameFT = (l) => {
            const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
            return (teamsApi2FT && typeof teamsApi2FT.canonicalFromName==='function') ? teamsApi2FT.canonicalFromName(cand) : norm2FT(cand);
          };
          let listFT = [];
          // IMPORTANTE: Usar TODOS los datos, no solo los paginados
          const allLeadsFT = Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : leadsArray;
          console.log('[ForceTeam] Filtrando sobre TODOS los datos:', allLeadsFT.length, '(no paginados)');
          if (Array.isArray(allLeadsFT)) {
            if (window.supervisorAgentFilter) {
              // Si hay agente seleccionado, filtrar directo por agente sobre todos los leads
              try { console.debug('[ForceTeam] Filtrado estricto por agente seleccionado'); } catch(_) {}
              // Usar comparaciÃ³n flexible para incluir variantes del nombre
              const sel = window.supervisorAgentFilter;
              const selNorm = (sel||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,'');
              const selTokens = (sel||'').toLowerCase().split(/\s+/).filter(Boolean);
              listFT = allLeadsFT.filter(l => {
                try {
                  const c = typeof getAgentCanonUniversal === 'function' ? getAgentCanonUniversal(l) : '';
                  if (c === sel) return true;
                  // ComparaciÃ³n flexible: sin espacios ni tildes
                  const cNorm = (c||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,'');
                  if (cNorm === selNorm) return true;
                  // ComparaciÃ³n por tokens (nombre y apellido)
                  if (selTokens.length > 1 && selTokens.every(t => c.toLowerCase().includes(t))) return true;
                  // ComparaciÃ³n directa en campos del registro
                  const campos = [l?.agenteNombre, l?.agente, l?.createdBy, l?._raw?.agenteNombre, l?._raw?.agente].filter(Boolean);
                  for (const campo of campos) {
                    const campoNorm = (campo||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,'');
                    if (campoNorm === selNorm) return true;
                    if (selTokens.every(t => campo.toLowerCase().includes(t))) return true;
                  }
                  return false;
                } catch { return false; }
              });
              console.log('[ForceTeam] Filtrado flexible por agente:', sel, '-> Resultados:', listFT.length);
            } else {
              // Sin agente seleccionado, limitar por miembros del team
              listFT = allLeadsFT.filter(l => {
                const c1 = getAgentCanonFT(l);
                const c2 = tryCanonNameFT(l);
                return teamAgentsFT.includes(c1) || teamAgentsFT.includes(c2);
              });
            }
          }
          const selectedFT = window.supervisorAgentFilter || null;
          try { console.debug('[ForceTeam] selectedFT =', selectedFT); } catch(_) {}
          if (selectedFT) { /* ya aplicado cuando se arma listFT arriba */ }
          try {
            const sample = (listFT||[]).slice(0,5).map(l=>({id:(typeof getLeadId==='function')?getLeadId(l):undefined, canon:getAgentCanonFT(l)}));
            console.debug('[ForceTeam] sample after filter =', sample);
          } catch(_) {}
          renderWithMonthlySeparators(listFT);
          try { console.log('[Toolbar ForceTeam] Render aplicado. leads =', listFT.length); } catch(_) {}
          return;
        }
      } catch(e) { /* ignorar */ }

      // Vista especial para SUPERVISORES: mostrar lista PLANA del propio TEAM con toolbar por agente
      try {
        if (__debugNoFilters) throw new Error('DEBUG: filtros desactivados');
        // Detectar supervisor actual via Teams
        const teamsApiRoot = (window && window.Teams) ? window.Teams : null;
        const currentUserName = (typeof obtenerUsuarioActual === 'function') ? obtenerUsuarioActual() : '';
        const currentCanon = teamsApiRoot && typeof teamsApiRoot.canonicalFromName === 'function'
          ? teamsApiRoot.canonicalFromName(currentUserName)
          : (currentUserName || '').toString().trim().toLowerCase();
        // Leer usuario/rol desde storage para mejorar la detecciÂ¨Â®n de supervisor
        let userObj = {};
        try { userObj = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}'); } catch { userObj = {}; }
        const rawRole = (userObj.role || userObj?.usuario?.role || '').toString().toLowerCase();
        const roleIsSupervisor = rawRole === 'supervisor';
        const teamForUser = (teamsApiRoot && typeof teamsApiRoot.getTeamForUser === 'function') ? teamsApiRoot.getTeamForUser(userObj) : '';
        const isSupervisorUser = !!(
          (teamsApiRoot && typeof teamsApiRoot.isSupervisor === 'function' && teamsApiRoot.isSupervisor(currentCanon))
          || roleIsSupervisor
          || teamForUser
        );
        try {
          console.log('===========================================');
          console.log('ðŸ” [DETECCIÃ“N SUPERVISOR] Iniciando...');
          console.log('[Toolbar Supervisor] usuarioActual =', currentUserName);
          console.log('[Toolbar Supervisor] usuarioCanon =', currentCanon);
          console.log('[Toolbar Supervisor] userObj =', userObj);
          console.log('[Toolbar Supervisor] rawRole =', rawRole);
          console.log('[Toolbar Supervisor] roleIsSupervisor =', roleIsSupervisor, '| teamForUser =', teamForUser);
          console.log('[Toolbar Supervisor] isSupervisorUser =', isSupervisorUser);
          console.log('[Toolbar Supervisor] Teams API lista =', !!teamsApiRoot);
          console.log('===========================================');
        } catch(_) {}
        
        if (!isSupervisorUser) {
          console.warn('âš ï¸ [Toolbar Supervisor] Usuario NO detectado como supervisor. Toolbar NO se crearÃ¡.');
          console.log('[Toolbar Supervisor] Razones posibles:');
          console.log('  - roleIsSupervisor:', roleIsSupervisor);
          console.log('  - teamForUser:', teamForUser);
          console.log('  - Teams API disponible:', !!teamsApiRoot);
        }
        
        if (isSupervisorUser) {
          console.log('âœ… [Toolbar Supervisor] Usuario ES supervisor. Creando toolbar...');
          // --- Toolbar de filtro por agente (TEAM SUPERVISOR) ---
          (function ensureSupervisorAgentFilterToolbar(){
            try {
              const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
              // Obtener agentes del supervisor actual usando Teams
              const teamsApi = (window && window.Teams) ? window.Teams : null;
              const supervisorCanon = currentCanon;
              let teamAgents = [];
              if (teamsApi) {
                if (teamForUser) {
                  // Si logramos deducir el team por el usuario, usarlo directamente
                  teamAgents = (typeof teamsApi.getAgentsByTeam === 'function') ? (teamsApi.getAgentsByTeam(teamForUser) || []) : [];
                }
                if (!teamAgents || teamAgents.length === 0) {
                  // Fallback por supervisor canÂ¨Â®nico
                  teamAgents = teamsApi.getAgentsBySupervisor(supervisorCanon) || [];
                }
              }
              // Fallback FINAL: si seguimos sin agentes, derivarlos de los leads actuales en memoria
              try {
                if ((!teamAgents || teamAgents.length === 0) && Array.isArray(window.ultimaListaLeads)) {
                  const set = new Set();
                  const titleCase = s => String(s||'').split(' ').map(w => w? (w[0].toUpperCase()+w.slice(1).toLowerCase()):'').join(' ');
                  const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
                  const canonFrom = name => {
                    try { return teamsApi && typeof teamsApi.canonicalFromName==='function' ? teamsApi.canonicalFromName(name) : norm(name); } catch { return norm(name); }
                  };
                  window.ultimaListaLeads.forEach(l => {
                    const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
                    const c = canonFrom(cand);
                    if (c) set.add(c);
                  });
                  teamAgents = Array.from(set);
                  console.log('[Toolbar Supervisor][fallback leads] Agentes derivados =', teamAgents);
                }
              } catch(_) {}
              try {
                console.log('[Toolbar Supervisor] Supervisor canÂ¨Â®nico =', supervisorCanon);
                console.log('[Toolbar Supervisor] Team deducido para usuario =', teamForUser);
                console.log('[Toolbar Supervisor] Agentes del equipo (canÂ¨Â®nicos) =', teamAgents);
                if (teamsApi && typeof teamsApi.getDisplayName === 'function') {
                  const labels = teamAgents.map(a => teamsApi.getDisplayName(a));
                  console.log('[Toolbar Supervisor] Etiquetas UI (getDisplayName) =', labels);
                }
              } catch(_) {}
              // Compartir lista con el bloque de render para evitar inconsistencias
              try { window.__teamAgentsCanon = Array.isArray(teamAgents) ? teamAgents.slice() : []; } catch(_) {}
              console.log('[Toolbar Supervisor] Intentando crear toolbar de filtros...');
              console.log('[Toolbar Supervisor] teamAgents =', teamAgents);
              const tbodyEl = document.getElementById('costumer-tbody');
              console.log('[Toolbar Supervisor] tbodyEl encontrado:', !!tbodyEl);
              if (!tbodyEl) {
                console.warn('[Toolbar Supervisor] No se encontró el elemento costumer-tbody, abortando creaciÃ³n de toolbar');
                return;
              }
              const tableEl = tbodyEl.closest('table');
              const tableResponsive = tableEl ? tableEl.closest('.table-responsive') : null;
              const host = tableResponsive || tableEl || tbodyEl;
              console.log('[Toolbar Supervisor] host para insertar toolbar:', host?.className || host?.tagName);
              
              // Crear/asegurar toolbar para filtro por agente del supervisor
              let bar = document.getElementById('supervisor-agent-filter');
              if (!bar) {
                bar = document.createElement('div');
                bar.id = 'supervisor-agent-filter';
                bar.style.margin = '10px 0';
                bar.style.display = 'flex';
                bar.style.flexWrap = 'wrap';
                bar.style.gap = '8px';
                // Insertar la barra antes del host (tabla contenedora)
                host.parentElement.insertBefore(bar, host);
                // sticky respecto al viewport principal
                bar.style.position = 'sticky';
                bar.style.top = '0';
                bar.style.zIndex = '10';
                bar.style.background = '#ffffff';
                bar.style.padding = '8px 0';
              } else {
                // Limpiar contenido antes de reconstruir
                try { bar.innerHTML = ''; } catch(_) {}
              }
              
              const mkBtn = (label, value) => {
                const b = document.createElement('button');
                b.textContent = label;
                b.type = 'button';
                b.style.padding = '6px 10px';
                b.style.border = '1px solid #e5e7eb';
                b.style.borderRadius = '9999px';
                b.style.background = (window.supervisorAgentFilter === value) ? '#1d4ed8' : '#f9fafb';
                b.style.color = (window.supervisorAgentFilter === value) ? '#fff' : '#111827';
                b.style.cursor = 'pointer';
                b.style.fontSize = '12px';
                b.addEventListener('click', () => {
                  window.supervisorAgentFilter = value; // null = Todos
                  try { 
                    if (typeof window.renderCostumerTable === 'function') {
                        window.renderCostumerTable(window.ultimaListaLeads || []);
                    } else {
                        console.error('La funciÂ¨Â®n renderCostumerTable no estÂ¨Â¢ disponible');
                    }
                } catch(e) { console.error('Error al renderizar tabla:', e); }
                });
                return b;
              };
              console.log('[Toolbar Supervisor] Creando botÃ³n "Todos"...');
              try {
                const normTxt = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                const isCancel = (st) => {
                  const t = normTxt(st||'');
                  return t.includes('cancel') || t.includes('anulad') || t.includes('no instalado');
                };
                // Filtrar por mes actual
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const isCurrentMonth = (l) => {
                  const dv = l?.dia_venta || l?._raw?.dia_venta || '';
                  if (!dv) return false;
                  if (dv.match(/^\d{4}-\d{2}/)) {
                    const [y, m] = dv.split('-').map(Number);
                    return y === currentYear && m === currentMonth;
                  }
                  if (dv.match(/^\d{2}\/\d{2}\/\d{4}/)) {
                    const [d, m, y] = dv.split('/').map(Number);
                    return y === currentYear && m === currentMonth;
                  }
                  return false;
                };
                // Conteo total efectivo dentro del team (solo mes actual)
                const totalEfectivasTeam = (Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : []).reduce((acc,l)=>{
                  try {
                    if (!isCurrentMonth(l)) return acc;
                    const c = getAgentCanonUniversal(l);
                    const inTeam = teamAgents.includes(c) || teamAgents.includes(normTxt(l?.agenteNombre||l?.nombreAgente||l?.agente||l?._raw?.agenteNombre||l?._raw?.nombreAgente||l?._raw?.agente||''));
                    if (!inTeam) return acc;
                    const st = l?.status || l?._raw?.status || '';
                    return acc + (isCancel(st) ? 0 : 1);
                  } catch { return acc; }
                }, 0);
                bar.appendChild(mkBtn(`Todos (${totalEfectivasTeam})`, null));
              } catch(_) {
                bar.appendChild(mkBtn('Todos', null));
              }
              console.log('[Toolbar Supervisor] Creando botones para', teamAgents.length, 'agentes...');
              teamAgents.forEach(a => {
                const teamsApi = (window && window.Teams) ? window.Teams : null;
                const display = (teamsApi && typeof teamsApi.getDisplayName === 'function')
                  ? teamsApi.getDisplayName(a)
                  : a.replace(/\b\w/g, c => c.toUpperCase());
                // Calcular conteo de ventas efectivas por agente (solo mes actual)
                let count = 0;
                try {
                  const normTxt = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                  const isCancel = (st) => {
                    const t = normTxt(st||'');
                    return t.includes('cancel') || t.includes('anulad') || t.includes('no instalado');
                  };
                  // Filtrar por mes actual
                  const now = new Date();
                  const currentYear = now.getFullYear();
                  const currentMonth = now.getMonth() + 1;
                  const isCurrentMonth = (l) => {
                    const dv = l?.dia_venta || l?._raw?.dia_venta || '';
                    if (!dv) return false;
                    // Formato YYYY-MM-DD
                    if (dv.match(/^\d{4}-\d{2}/)) {
                      const [y, m] = dv.split('-').map(Number);
                      return y === currentYear && m === currentMonth;
                    }
                    // Formato DD/MM/YYYY
                    if (dv.match(/^\d{2}\/\d{2}\/\d{4}/)) {
                      const [d, m, y] = dv.split('/').map(Number);
                      return y === currentYear && m === currentMonth;
                    }
                    return false;
                  };
                  count = (Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : []).reduce((acc,l)=>{
                    try {
                      if (!isCurrentMonth(l)) return acc;
                      const c = getAgentCanonUniversal(l);
                      if (c !== a) return acc;
                      const st = l?.status || l?._raw?.status || '';
                      return acc + (isCancel(st) ? 0 : 1);
                    } catch { return acc; }
                  }, 0);
                } catch(_) { count = 0; }
                const label = `${display} (${count})`;
                console.log('[Toolbar Supervisor] Creando botÃ³n para agente:', label);
                bar.appendChild(mkBtn(label, a));
              });
              console.log('[Toolbar Supervisor] âœ… Toolbar creada exitosamente con', 1 + teamAgents.length, 'botones');
              console.log('[Toolbar Supervisor] Toolbar visible:', bar.style.display !== 'none');
              // Encabezado de columnas: sin comportamiento sticky (restaurado al estado original)
            } catch(e) { console.warn('Toolbar TEAM IRANIA:', e); }
          })();
          // --- Aplicar filtro activo (si existe) y render plano  
          const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const teamsApi2 = (window && window.Teams) ? window.Teams : null;
          // Usar la misma lista de agentes que la toolbar calculÂ¨Â® (con fallbacks)
          let teamCanon = Array.isArray(window.__teamAgentsCanon) ? window.__teamAgentsCanon.slice() : [];
          if (!teamCanon || teamCanon.length === 0) {
            // Fallback de seguridad si no quedÂ¨Â® poblado
            teamCanon = teamsApi2 ? (teamsApi2.getAgentsBySupervisor(currentCanon) || []) : [];
            if ((!teamCanon || teamCanon.length===0) && Array.isArray(window.ultimaListaLeads)) {
              const set = new Set();
              const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
              const canonFrom = name => {
                try { return teamsApi2 && typeof teamsApi2.canonicalFromName==='function' ? teamsApi2.canonicalFromName(name) : norm(name); } catch { return norm(name); }
              };
              window.ultimaListaLeads.forEach(l => {
                const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
                const c = canonFrom(cand);
                if (c) set.add(c);
              });
              teamCanon = Array.from(set);
              try { console.log('[Toolbar Supervisor][render fallback] teamCanon derivado de leads =', teamCanon); } catch(_) {}
            }
          }
          // Valor seleccionado (chip actual del supervisor)
          const selected = window.supervisorAgentFilter || null;
          const canonicalFromName = (name) => {
            if (teamsApi2 && typeof teamsApi2.canonicalFromName === 'function') return teamsApi2.canonicalFromName(name);
            const n = norm(name);
            if (!n) return '';
            if (teamCanon.includes(n)) return n;
            for (const c of teamCanon) { const toks = c.split(' '); if (toks.every(t => n.includes(t))) return c; }
            return '';
          };
          const getAgentCanon = (l) => getAgentCanonUniversal(l);
          // Helper: aplicar filtro por Mes/AÃ±o seleccionado (si existe)
          const applyMonthFilter = (arr) => {
            try {
              const sel = window.supervisorMonthFilter;
              if (!sel || !sel.month || !sel.year) return arr;
              const M = Number(sel.month), Y = Number(sel.year);
              return (arr||[]).filter(l => {
                try {
                  const iso = (typeof getDateFromLead==='function') ? getDateFromLead(l) : null;
                  if (!iso || typeof iso !== 'string') return false;
                  const [y,m] = iso.split('-').map(Number);
                  return y===Y && m===M;
                } catch { return false; }
              });
            } catch { return arr; }
          };
          // Limitar a leads del TEAM del supervisor actual
          try { console.debug('[Supervisor] teamCanon =', teamCanon); } catch(_) {}
          const tryCanonName = (l) => {
            const cand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
            return (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(cand) : norm(cand);
          };
          // Asegurar que el mapa ID->Canon exista y estÂ¨Â¦ poblado antes de filtrar
          try {
            if (!(window.__idToCanonGlobal instanceof Map)) window.__idToCanonGlobal = new Map();
            const idMap = window.__idToCanonGlobal;
            const canonical = (name) => {
              try { return teamsApi2 && typeof teamsApi2.canonicalFromName==='function' ? teamsApi2.canonicalFromName(name) : norm(name); } catch { return norm(name); }
            };
            (leadsArray||[]).forEach(l => {
              const nameCand = l?.agenteNombre || l?.nombreAgente || l?.agente || l?._raw?.agenteNombre || l?._raw?.nombreAgente || l?._raw?.agente || '';
              const canon = canonical(nameCand);
              const ids = (function extractIdsLocal(x){
                const ids=[]; const cands=[x?.agenteId,x?._raw?.agenteId,x?.agente_id,x?._raw?.agente_id,x?.idAgente,x?._raw?.idAgente,x?.agentId,x?._raw?.agentId,x?.creadoPor,x?._raw?.creadoPor,x?.creado_por,x?._raw?.creado_por,x?.createdBy,x?._raw?.createdBy,x?.ownerId,x?._raw?.ownerId,x?.registeredById,x?._raw?.registeredById,x?.assignedId,x?._raw?.assignedId];
                for (const v of cands){ if(!v) continue; if(typeof v==='object'){ const oid=v.$oid||v.id||v._id||v.value; if(oid) ids.push(String(oid)); } else { let s=String(v); const m=s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); if(m) s=m[1]; ids.push(s);} }
                return ids.map(s=>s&&s.trim()).filter(Boolean);
              })(l);
              if (canon) ids.forEach(id=>{ try { idMap.set(id, canon); } catch(_) {} });
            });
            // Override explÂ¨Âªcito Eduardo Rivas (id conocido, actualizado)
            try { idMap.set('68bb1ddd0d4d7cdcb6eb3605','eduardo rivas'); } catch(_) {}
            console.log('[Supervisor][ID->Canon] Mapa listo. size=', idMap.size);
          } catch(e) { console.warn('[Supervisor] No se pudo preparar ID->Canon:', e); }
          // Construir la lista filtrada para la vista Supervisor
          let list = [];
          // IMPORTANTE: Usar TODOS los datos, no solo los paginados
          const allLeads = Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : leadsArray;
          console.log('[Supervisor] Filtrando sobre TODOS los datos:', allLeads.length, '(no paginados)');
          if (Array.isArray(allLeads)) {
            if (window.supervisorAgentFilter) {
              // Si hay agente seleccionado, filtrar directo por agente sobre todos los leads
              try { console.debug('[Supervisor] Filtrado estricto por agente seleccionado'); } catch(_) {}
              // DiagnÂ¨Â®stico: conteo por ID de Eduardo antes del filtro (incluye campos en espa?ol)
              try {
                const normId = (v) => { if(!v) return ''; if (typeof v==='object') return String(v.$oid||v.id||v._id||v.value||''); const s=String(v); const m=s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s; };
                const getAnyAgentId = (l) => normId(l?.ownerId) || normId(l?.agentId) || normId(l?.registeredById) || normId(l?.createdBy) || normId(l?.agenteId) || normId(l?.creadoPor) || normId(l?._raw?.ownerId) || normId(l?._raw?.agentId) || normId(l?._raw?.registeredById) || normId(l?._raw?.createdBy) || normId(l?._raw?.agenteId) || normId(l?._raw?.creadoPor);
                const targetId = '68bb1ddd0d4d7cdcb6eb3605';
                const countById = (allLeads||[]).filter(l => getAnyAgentId(l) === targetId).length;
                console.log('[Supervisor][Diag eduardo rivas] leads con ID de Eduardo (antes de filtrar):', countById);
              } catch(_) {}
              // Usar comparaciÃ³n flexible para consistencia con el conteo de botones
              const sel = window.supervisorAgentFilter;
              const selNorm = (sel||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,'');
              const selTokens = (sel||'').toLowerCase().split(/\s+/).filter(Boolean);
              list = allLeads.filter(l => {
                try {
                  const c = typeof getAgentCanonUniversal === 'function' ? getAgentCanonUniversal(l) : '';
                  if (c === sel) return true;
                  // ComparaciÃ³n flexible: sin espacios ni tildes
                  const cNorm = (c||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,'');
                  if (cNorm === selNorm) return true;
                  // ComparaciÃ³n por tokens (nombre y apellido)
                  if (selTokens.length > 1 && selTokens.every(t => c.toLowerCase().includes(t))) return true;
                  // ComparaciÃ³n directa en campos del registro
                  const campos = [l?.agenteNombre, l?.agente, l?.createdBy, l?._raw?.agenteNombre, l?._raw?.agente].filter(Boolean);
                  for (const campo of campos) {
                    const campoNorm = (campo||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,'');
                    if (campoNorm === selNorm) return true;
                    if (selTokens.every(t => campo.toLowerCase().includes(t))) return true;
                  }
                  return false;
                } catch { return false; }
              });
              console.log('[Supervisor] Filtrado flexible por agente:', sel, '-> Resultados:', list.length);
              // Preferir consultar al servidor antes que buscar por tokens locales
              const PREFER_SERVER_FALLBACK = true;
              // Fallback: si quedÂ¨Â® vacÂ¨Âªo y NO preferimos servidor, intentar heurÂ¨Âªstica dentro del TEAM
              if (!list.length && !PREFER_SERVER_FALLBACK) {
                try {
                  const display = (teamsApi2 && typeof teamsApi2.getDisplayName==='function') ? teamsApi2.getDisplayName(window.supervisorAgentFilter) : window.supervisorAgentFilter;
                  const _norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                  const toks = _norm(display).split(/\s+/).filter(Boolean); // ej: ['eduardo','rivas']
                  const teamScoped = leadsArray.filter(l => {
                    const c1 = getAgentCanon(l); const c2 = tryCanonName(l);
                    return teamCanon.includes(c1) || teamCanon.includes(c2);
                  });
                  list = teamScoped.filter(l => {
                    const hay = _norm(JSON.stringify(l||{}));
                    return toks.every(t => hay.includes(t));
                  });
                  console.info('[Supervisor][Fallback] Estricto=0. Fallback por tokens dentro del TEAM. Resultado:', list.length);
                } catch(e) { console.warn('[Supervisor][Fallback] Error en fallback:', e); }
              }
              // Fallback de servidor: si sigue vacÂ¨Âªo, pedir al backend por agentId
              if (!list.length) {
                try {
                  const selCanon = (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(window.supervisorAgentFilter) : window.supervisorAgentFilter;
                  // Buscar agentId por canÂ¨Â®nico
                  let agentId = null;
                  try {
                    const map = window.__canonToIdsGlobal;
                    if (map && typeof map.get === 'function') {
                      const set = map.get(selCanon);
                      if (set && set.size) agentId = [...set][0];
                    }
                  } catch(_) {}
                  // Fallback duro para Eduardo Rivas
                  if (!agentId && selCanon === 'eduardo rivas') agentId = '68bb1ddd0d4d7cdcb6eb3605';
                  if (agentId) {
                    fetchLeadsByAgentId(agentId).then(serverLeads => {
                      if (Array.isArray(serverLeads) && serverLeads.length) {
                        const normalizeId = (v) => {
                          if (!v) return '';
                          if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
                          const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
                        };
                        const normFree = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                        const getNameCanonFromLead = (l) => {
                          try {
                            const candidates = [
                              l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
                              l?.vendedor, l?.seller, l?.salesAgent, l?.atendioPor, l?.asignadoA, l?.asignadoPor,
                              l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente, l?._raw?.agent, l?._raw?.Agent,
                              l?._raw?.vendedor, l?._raw?.seller, l?._raw?.salesAgent, l?._raw?.atendioPor, l?._raw?.asignadoA, l?._raw?.asignadoPor
                            ];
                            const nameCand = candidates.find(x => !!x) || '';
                            return (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(nameCand) : normFree(nameCand);
                          } catch { return ''; }
                        };
                        // DiagnÂ¨Â®stico: mostrar cÂ¨Â®mo vienen los campos de ID y el nombre canÂ¨Â®nico
                        try {
                          const diag = (serverLeads||[]).slice(0,10).map(l=>({
                            ownerId: normalizeId(l?.ownerId), agentId: normalizeId(l?.agentId),
                            registeredById: normalizeId(l?.registeredById), createdBy: normalizeId(l?.createdBy),
                            agenteId: normalizeId(l?.agenteId), creadoPor: normalizeId(l?.creadoPor),
                            _raw_ownerId: normalizeId(l?._raw?.ownerId), _raw_agentId: normalizeId(l?._raw?.agentId),
                            _raw_registeredById: normalizeId(l?._raw?.registeredById), _raw_createdBy: normalizeId(l?._raw?.createdBy),
                            _raw_agenteId: normalizeId(l?._raw?.agenteId), _raw_creadoPor: normalizeId(l?._raw?.creadoPor),
                            nameCanon: getNameCanonFromLead(l)
                          }));
                          console.log('[Supervisor][Fallback servidor][Diag primeros 10]', diag);
                        } catch(_) {}
                        // Fase 1: por ID exacto
                        const getAnyAgentId = (l) => normalizeId(l?.ownerId) || normalizeId(l?.agentId) || normalizeId(l?.registeredById) || normalizeId(l?.createdBy) || normalizeId(l?.agenteId) || normalizeId(l?.creadoPor) || normalizeId(l?._raw?.ownerId) || normalizeId(l?._raw?.agentId) || normalizeId(l?._raw?.registeredById) || normalizeId(l?._raw?.createdBy) || normalizeId(l?._raw?.agenteId) || normalizeId(l?._raw?.creadoPor);
                        let out = serverLeads.filter(l => getAnyAgentId(l) === agentId);
                        if (out.length === 0) {
                          // Fase 2: por nombre canÂ¨Â®nico
                          out = serverLeads.filter(l => getNameCanonFromLead(l) === selCanon);
                          if (out.length) console.info('[Supervisor][Fallback servidor] match por nombre canÂ¨Â®nico:', out.length);
                        } else {
                          console.info('[Supervisor][Fallback servidor] match por ID:', out.length);
                        }
                        // Si aÂ¨Â²n no hay resultados, intentar por nombre desde backend
                        if (out.length === 0) {
                          const displayName = (teamsApi2 && typeof teamsApi2.getDisplayName==='function') ? teamsApi2.getDisplayName(selCanon) : selCanon;
                          fetchLeadsByAgentName(displayName).then(byName => {
                            let out2 = [];
                            try {
                              const normFree = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase();
                              const nSel = selCanon;
                              const getNameCanonFromLead = (l) => {
                                try {
                                  const candidates = [
                                    l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
                                    l?.vendedor, l?.seller, l?.salesAgent, l?.atendioPor, l?.asignadoA, l?.asignadoPor,
                                    l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente, l?._raw?.agent, l?._raw?.Agent,
                                    l?._raw?.vendedor, l?._raw?.seller, l?._raw?.salesAgent, l?._raw?.atendioPor, l?._raw?.asignadoA, l?._raw?.asignadoPor
                                  ];
                                  const nameCand = candidates.find(x => !!x) || '';
                                  return (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(nameCand) : normFree(nameCand);
                                } catch { return ''; }
                              };
                              out2 = (byName||[]).filter(l => getNameCanonFromLead(l) === nSel);
                            } catch(_) { out2 = []; }
                            console.warn('[Supervisor][Fallback servidor][byName] resultados =', out2.length);
                            if (out2.length) {
                              try { out2.forEach(l => { try { l.__agentCanon = selCanon; } catch(_) {} }); } catch(_) {}
                              try { window.ultimaListaLeads = byName.slice(); } catch(_) {}
                              renderWithMonthlySeparators(out2);
                            } else {
                              renderWithMonthlySeparators([]);
                            }
                          }).catch(err => { console.warn('[Supervisor][Fallback servidor][byName] error:', err); renderWithMonthlySeparators([]); });
                          return;
                        }
                        if (out.length === 0) {
                          // Fase 3: por tokens dentro del objeto
                          const toks = selCanon.split(' ').filter(Boolean); // ej: ['eduardo','rivas']
                          out = serverLeads.filter(l => {
                            const hay = normFree(JSON.stringify(l||{}));
                            return toks.every(t => hay.includes(t));
                          });
                          if (out.length) console.info('[Supervisor][Fallback servidor] match por tokens JSON:', out.length);
                        }
                        // Etiquetar y actualizar mapas globales para futuras coincidencias
                        try {
                          if (!(window.__idToCanonGlobal instanceof Map)) window.__idToCanonGlobal = new Map();
                          if (!(window.__canonToIdsGlobal instanceof Map)) window.__canonToIdsGlobal = new Map();
                          const idMap = window.__idToCanonGlobal; const c2i = window.__canonToIdsGlobal;
                          out.forEach(l => {
                            const ids = [normalizeId(l.ownerId), normalizeId(l.agentId), normalizeId(l.registeredById), normalizeId(l.createdBy), normalizeId(l.agenteId), normalizeId(l.creadoPor), normalizeId(l?._raw?.ownerId), normalizeId(l?._raw?.agentId), normalizeId(l?._raw?.registeredById), normalizeId(l?._raw?.createdBy), normalizeId(l?._raw?.agenteId), normalizeId(l?._raw?.creadoPor)].filter(Boolean);
                            try { l.__agentCanon = selCanon; } catch(_) {}
                            ids.forEach(id => { try { idMap.set(id, selCanon); } catch(_) {} });
                            if (ids.length) {
                              const set = c2i.get(selCanon) || new Set();
                              ids.forEach(id => set.add(id));
                              c2i.set(selCanon, set);
                            }
                          });
                        } catch(_) {}
                        console.info('[Supervisor][Fallback servidor] leads finales =', out.length);
                        try { window.ultimaListaLeads = serverLeads.slice(); } catch(_) {}
                        const filteredOut = applyMonthFilter(out);
                        renderWithMonthlySeparators(filteredOut);
                      } else {
                        console.warn('[Supervisor][Fallback servidor] sin resultados para agentId', agentId);
                        renderWithMonthlySeparators([]);
                      }
                    }).catch(err => {
                      console.warn('[Supervisor][Fallback servidor] error:', err);
                      renderWithMonthlySeparators([]);
                    });
                    return; // no continuar, ya haremos render en el then
                  }
                } catch(e) { console.warn('[Supervisor][Fallback servidor] error preparando fetch:', e); }
              }
            } else {
              // Sin agente seleccionado, limitar por miembros del team del supervisor
              list = leadsArray.filter(l => {
                const c1 = getAgentCanon(l);
                const c2 = tryCanonName(l);
                return teamCanon.includes(c1) || teamCanon.includes(c2);
              });
            }
          }
          try {
            const selCanon = (teamsApi2 && typeof teamsApi2.canonicalFromName==='function') ? teamsApi2.canonicalFromName(selected||'') : (selected||'');
            if (selCanon === 'eduardo rivas') {
              const sampleDiag = (leadsArray||[]).slice(0,10).map(l=>({
                id: (function(x){ try{ const cand=x?.ownerId||x?.agentId||x?.registeredById||x?.createdBy; if(!cand) return ''; if(typeof cand==='object'){ return cand.$oid||cand.id||cand._id||cand.value||'';} const s=String(cand); const m=s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s; } catch{ return ''; } })(l),
                canon: getAgentCanon(l)
              }));
              console.log('[Supervisor][Diag eduardo rivas] sample ids/canon =', sampleDiag);
            }
          } catch(_) {}
          try {
            const sample = (list||[]).slice(0,5).map(l=>({id:(typeof getLeadId==='function')?getLeadId(l):undefined, canon:getAgentCanon(l)}));
            console.debug('[Supervisor] sample after filter =', sample);
          } catch(_) {}
          list = applyMonthFilter(list);
          renderWithMonthlySeparators(list);
          try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}
          return; // retorno temprano para no pasar por otras agrupaciones
        }
      } catch (e) {
        console.warn('No se pudo aplicar la vista plana para Supervisor:', e);
      }

      // Vista ADMIN/BACKOFFICE: toolbar por TEAM y render plano filtrado por team
      if (!(__debugNoFilters) && typeof esAdminOBackoffice === 'function' && esAdminOBackoffice()) {
        try {
          const teamsApi = (window && window.Teams) ? window.Teams : null;
          // getAllTeams() devuelve objetos completos, no keys
          const teamsArray = teamsApi && typeof teamsApi.getAllTeams === 'function' ? teamsApi.getAllTeams() : [];
          const tbodyEl = document.getElementById('costumer-tbody');
          if (!tbodyEl) return;
          const tableEl = tbodyEl.closest('table');
          const host = tableEl ? tableEl : tbodyEl;
          const container = host.parentElement || host;

          // Helper para normalizar supervisor (definir antes de usar)
          const normSup = (s) => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'').trim();

          // Crear/asegurar toolbar de TEAM
          let bar = document.getElementById('teams-filter-bar');
          if (!bar) {
            bar = document.createElement('div');
            bar.id = 'teams-filter-bar';
            bar.style.margin = '10px 0';
            bar.style.display = 'flex';
            bar.style.flexWrap = 'wrap';
            bar.style.gap = '8px';
            container.insertBefore(bar, host);
            bar.style.position = 'sticky';
            bar.style.top = '0';
            bar.style.zIndex = '10';
            bar.style.background = '#ffffff';
            bar.style.padding = '8px 0';
          }

          const mkBtn = (label, value) => {
            const b = document.createElement('button');
            b.textContent = label;
            b.dataset.value = value || '';
            b.style.padding = '6px 10px';
            b.style.border = '1px solid #e5e7eb';
            b.style.borderRadius = '9999px';
            b.style.background = (window.adminTeamFilter === value) ? '#1d4ed8' : '#f9fafb';
            b.style.color = (window.adminTeamFilter === value) ? '#fff' : '#111827';
            b.style.cursor = 'pointer';
            b.style.fontSize = '12px';
            b.addEventListener('click', () => {
              window.adminTeamFilter = value || null;
              try { 
                if (typeof window.renderCostumerTable === 'function') {
                  window.renderCostumerTable(window.ultimaListaLeads || []);
                } else {
                  console.error('La funciÂ¨Â®n renderCostumerTable no estÂ¨Â¢ disponible');
                }
              } catch(e) { console.error('Error al renderizar tabla:', e); }
            });
            return b;
          };

          // Render botones
          bar.innerHTML = '';
          try {
            const totalClientes = Array.isArray(leadsArray) ? leadsArray.length : 0;
            bar.appendChild(mkBtn(`Todos (${totalClientes})`, null));
          } catch(_) {
            bar.appendChild(mkBtn('Todos', null));
          }
          
          // teamsArray contiene objetos con {name, supervisor, supervisorName, ...}
          // Los leads tienen supervisor como "ROBERTO", "IRANIA", "JOHANA", "MARISOL", "BRYAN"
          // Crear mapa de nombre corto a nombre completo
          const supervisorShortNames = {
            'roberto': 'Roberto VelÃ¡squez',
            'irania': 'Irania Serrano',
            'johana': 'Johana',
            'marisol': 'Marisol BeltrÃ¡n',
            'bryan': 'Bryan Pleitez',
            'jonathan': 'Jonathan Figueroa'
          };
          
          teamsArray.forEach(teamObj => {
            const teamName = teamObj.name || '';
            const supervisorName = teamObj.supervisorName || teamObj.supervisor || teamName;
            // Extraer primer nombre del supervisor para comparar con datos de leads
            const firstName = supervisorName.split(' ')[0].toLowerCase();
            
            // Calcular conteo por campo supervisor del lead (comparar con primer nombre)
            let count = 0;
            try {
              count = (Array.isArray(leadsArray) ? leadsArray : []).reduce((acc, l) => {
                const leadSup = l?.supervisor || l?._raw?.supervisor || l?.team || l?._raw?.team || '';
                const leadSupLower = leadSup.toLowerCase().trim();
                // Comparar primer nombre
                const isMatch = leadSupLower === firstName || 
                               leadSupLower.includes(firstName) ||
                               firstName.includes(leadSupLower);
                return acc + (isMatch ? 1 : 0);
              }, 0);
            } catch(_) { count = 0; }
            // Usar firstName como valor del filtro (coincide con datos de leads)
            bar.appendChild(mkBtn(`${supervisorName} (${count})`, firstName));
          });

          // Filtrar por supervisor seleccionado (desde dropdown O desde botones)
          // PRIORIZAR DROPDOWN: usar su valor directamente (ya que coincide con campo supervisor del lead)
          const teamDropdown = document.getElementById('teamFilter');
          const dropdownValue = teamDropdown ? teamDropdown.value : '';
          const selectedSupervisor = dropdownValue || window.adminTeamFilter || null;
          
          console.log('[ADMIN FILTER] dropdownValue:', dropdownValue, '| adminTeamFilter:', window.adminTeamFilter, '| usando:', selectedSupervisor);
          
          let list = Array.isArray(leadsArray) ? leadsArray.slice() : [];
          if (selectedSupervisor) {
            const filterName = selectedSupervisor.toLowerCase().trim();
            
            console.log('[ADMIN FILTER] Filtrando por:', filterName, '| Total leads:', list.length);
            
            // Filtrar por campo supervisor del lead (comparaciÃ³n directa ya que dropdown tiene mismo valor)
            list = list.filter(l => {
              const leadSup = l?.supervisor || l?._raw?.supervisor || l?.team || l?._raw?.team || '';
              const leadSupLower = leadSup.toLowerCase().trim();
              return leadSupLower === filterName;
            });
            
            console.log('[ADMIN FILTER] Leads despuÃ©s de filtro:', list.length);
          }

          // Render con separadores mensuales
          console.log('[ADMIN RENDER] Llamando a renderWithMonthlySeparators con', list.length, 'leads');
          console.log('[ADMIN RENDER] Valor actual de #teamFilter:', document.getElementById('teamFilter')?.value || '(vacÃ­o)');
          renderWithMonthlySeparators(list);
          try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){}

        } catch (e) { console.warn('Error en vista admin por TEAM:', e); }
      } else {
        // Render por defecto con separadores mensuales
        console.log('[RENDER ROUTE] Usando renderWithMonthlySeparators con', leadsArray.length, 'leads');
        renderWithMonthlySeparators(leadsArray);
        try { if (window.rebuildStickyHead) window.rebuildStickyHead(); } catch(_){ }
      }

      // Asegurar que los KPIs siempre se actualicen con los datos renderizados
      try {
        window.__kpiLeadsLast = Array.isArray(leadsArray) ? leadsArray.slice() : [];
        if (typeof updateSummaryCards === 'function') {
          updateSummaryCards(leadsArray);
        }
      } catch (e) {
        console.warn('[renderCostumerTable] Error actualizando KPIs al final:', e);
      }
    };

    // Función para actualizar las tarjetas de resumen
    function updateSummaryCards(leads) {
      // Obtener referencias a los elementos del DOM primero
      const ventasHoyElement = document.getElementById('costumer-ventas-hoy');
      const ventasMesElement = document.getElementById('costumer-ventas-mes');
      const ventasActivasElement = document.getElementById('costumer-ventas-activas');
      const pendientesElement = document.getElementById('costumer-pendientes');
      const canceladosElement = document.getElementById('costumer-cancelados');

      // Para AGENTES: usar datos COMPLETOS del mes si están disponibles
      const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
      const isAgente = ['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(roleRaw);

      const __hasHardFilters = (() => {
        try {
          const v = (id) => {
            const el = document.getElementById(id);
            return el ? String(el.value || '').trim() : '';
          };
          const search = v('costumer-search');
          const team = v('teamFilter');
          const agent = v('agentFilter');
          const mercado = v('mercadoFilter');
          const service = v('serviceFilter');

          const expectedMercadoByRole = (() => {
            try {
              const r = String(roleRaw || '')
                .trim()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
              if (r === 'rol_icon' || r === 'icon' || r.includes('rol icon')) return 'ICON';
              if (r === 'rol_bamo' || r === 'bamo' || r.includes('rol bamo')) return 'BAMO';
              return '';
            } catch { return ''; }
          })();

          const isMercadoHardFilter = (() => {
            const m = String(mercado || '').trim().toUpperCase();
            if (!m) return false;
            if (m.toLowerCase() === 'todos' || m.toLowerCase().includes('todo')) return false;
            if (expectedMercadoByRole && m === expectedMercadoByRole) return false;
            return true;
          })();

          if (search) return true;
          if (team) return true;
          if (agent) return true;
          if (isMercadoHardFilter) return true;
          if (service) return true;
          return false;
        } catch (_) {
          return false;
        }
      })();

      // Permitir usar KPIs del backend aunque exista filtro de MES/STATUS, porque el endpoint /api/leads/kpis
      // ya calcula totales del mes sin paginación. Solo bloquear si hay filtros "duros" (search/team/agent/etc.)
      const canUseBackendKpis = (!__hasHardFilters && window.__kpisTotals && typeof window.__kpisTotals === 'object');
      
      if (isAgente && window.__agentFullLeadsForKpi && Array.isArray(window.__agentFullLeadsForKpi) && window.__agentFullLeadsForKpi.length > 0) {
        console.log('[updateSummaryCards] AGENTE: filtrando datos para ver SOLO los suyos propios del MES ACTUAL...');
        
        // Obtener el nombre del agente actual
        const agentNameRaw = (userData.nombre || userData.name || userData.username || userData.email || userData?.usuario?.nombre || userData?.usuario?.name || userData?.usuario?.username || userData?.usuario?.email || '').toString().trim();
        const agentName = agentNameRaw.replace(/[._-]+/g, ' ').replace(/\s+/g, ' ').trim();
        console.log('[updateSummaryCards] AGENTE: buscando leads donde agente =', agentName);
        
        // Función auxiliar para normalizar nombres (igual que en la tabla)
        const agentCanonicalName = (s) => {
          try {
            const norm = String(s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
            return norm.replace(/[^a-z0-9]+/g, '');
          } catch {
            return String(s || '').toLowerCase().replace(/[^a-z0-9]+/g, '');
          }
        };
        
        const currentAgentCanon = agentCanonicalName(agentName);

        const getLeadAgentNameCandidates = (lead) => {
          try {
            const l = lead || {};
            const cand = [
              l.agenteNombre, l.nombreAgente, l.agente, l.agent, l.salesAgent, l.agentName, l.vendedor, l.seller,
              l.usuario, l.owner, l.createdBy, l.registeredBy,
              l.asignadoA, l.asignado_a, l.assignedTo, l.assigned_to,
              l._raw?.agenteNombre, l._raw?.nombreAgente, l._raw?.agente, l._raw?.agent,
              l._raw?.agentName, l._raw?.salesAgent, l._raw?.vendedor, l._raw?.seller,
              l._raw?.usuario, l._raw?.owner, l._raw?.createdBy, l._raw?.registeredBy,
              l._raw?.asignadoA, l._raw?.asignado_a, l._raw?.assignedTo, l._raw?.assigned_to
            ];
            return cand.map(x => (x == null ? '' : String(x))).map(s => s.trim()).filter(Boolean);
          } catch {
            return [];
          }
        };
        
        // Filtrar SOLO los leads del agente actual
        const filteredLeads = window.__agentFullLeadsForKpi.filter(lead => {
          const candidates = getLeadAgentNameCandidates(lead);
          if (!candidates.length) return false;
          return candidates.some(nm => agentCanonicalName(nm) === currentAgentCanon);
        });
        
        console.log('[updateSummaryCards] AGENTE: de', window.__agentFullLeadsForKpi.length, 'leads totales, filtrando a', filteredLeads.length, 'propios del mes');
        // Guardrail: si el filtro por nombre falla (ej. backend retornó ya filtrado por agenteId o datos sin nombre),
        // no reemplacemos `leads` con una lista muy pequeña que haría caer los KPIs a 0.
        if (filteredLeads.length >= 5) {
          leads = filteredLeads;
        } else {
          console.warn('[updateSummaryCards] AGENTE: filtro por agente devolvió muy pocos leads; se mantiene el arreglo actual para KPIs. filtered=', filteredLeads.length);
        }
      }

      // Roles para los que Active Oficina NO suma puntaje (pero sí se muestra)
      const __excludeActiveOficinaFromPoints = (() => {
        try {
          const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
          const role = (function normalizeRole(r){
            if (!r) return 'agente';
            if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
            if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
            if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
            if (['backoffice','back office','back_office','bo','b.o','b:o','b-o'].includes(r)) return 'backoffice';
            return r;
          })(roleRaw);
          return role === 'agente' || role === 'supervisor';
        } catch { return false; }
      })();
      
      // Establecer valores por defecto
      let ventasHoy = 0;
      let ventasMes = 0;
      let ventasActivas = 0;
      let pendientes = 0;
      let cancelados = 0;
      let __useBackendStatusKpis = false;
      // Contadores para debugging
      let totalActivasSinCancel = 0;
      let totalActivasConInstalacionEnMes = 0;
      let totalPendientes = 0;
      let totalPendientesConInstalacionEnMes = 0;
      // Fecha de referencia para KPIs (siempre disponible aunque no haya leads)
      const todayISO = toISOInTZ(new Date(), BUSINESS_TZ_OFFSET_MIN); // YYYY-MM-DD
      const [yNow, mNow] = todayISO.split('-').map(Number);

      // Mes objetivo para KPIs (si hay filtro de mes, usarlo; si no, usar mes actual)
      const monthSelectKpi = document.getElementById('monthFilter');
      const __hasExplicitMonthFilter = !!(monthSelectKpi && monthSelectKpi.value && /^\d{4}-\d{2}$/.test(String(monthSelectKpi.value).trim()));
      const targetMonthStr = __hasExplicitMonthFilter
        ? String(monthSelectKpi.value).trim()
        : `${String(yNow).padStart(4,'0')}-${String(mNow).padStart(2,'0')}`;
      const [yTarget, mTarget] = targetMonthStr.split('-').map(Number);

      // Mes anterior (para lógica de "colchón")
      let yPrev = yTarget;
      let mPrev = mTarget - 1;
      if (mPrev < 1) { mPrev = 12; yPrev = yTarget - 1; }

      // Preferir KPIs del agente (backend) cuando esten disponibles
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        const isAgente = ['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(roleRaw);
        
        if (!isAgente && canUseBackendKpis) {
          const kt = window.__kpisTotals;
          console.log('[updateSummaryCards] ADMIN/SUPER: KPIs del backend disponibles:', kt);

          // Ventas del mes (efectivas) del backend
          if (typeof kt.ventasEfectivasMes === 'number') {
            ventasMes = kt.ventasEfectivasMes;
          } else if (typeof kt.totalMes === 'number' && typeof kt.canceladas === 'number') {
            ventasMes = Math.max(0, kt.totalMes - kt.canceladas);
          }

          // KPIs de status desde backend (sin paginación)
          if (typeof kt.activasEfectivas === 'number') ventasActivas = kt.activasEfectivas;
          else if (typeof kt.activas === 'number') ventasActivas = kt.activas;
          if (typeof kt.pendientes === 'number') pendientes = kt.pendientes;
          if (typeof kt.canceladas === 'number') cancelados = kt.canceladas;
          __useBackendStatusKpis = true;
        
        } else if (isAgente) {
          console.log('[updateSummaryCards] AGENTE: Ignorando KPIs del backend - calculando desde leads locales');
          // No usar window.__kpisTotals para agentes - calcular desde leads locales
        }
      } catch (_) { /* ignore */ }

      // DiagnÃ³stico: conteo por status y fechas invÃ¡lidas
      const __kpiStatusCounts = {};
      let __kpiMissingDate = 0;

      // Verificar si hay datos para procesar
      if (!leads || !Array.isArray(leads) || leads.length === 0) {
        console.log('No hay datos para mostrar en los grÂ¨Â¢ficos');
      } else {
        console.log('Procesando estadÂ¨Âªsticas con', leads.length, 'leads');
        
        const hoy = new Date();
        const diaActual = hoy.getDate();
        const mesActual = hoy.getMonth();
        const anioActual = hoy.getFullYear();
        
        console.log('Fecha actual:', hoy.toLocaleDateString());
        
        // Normalizar fechas con la misma lÂ¨Â®gica de las grÂ¨Â¢ficas (zona horaria de negocio)
        // (las variables todayISO, yNow y mNow ya están definidas arriba)

        // Procesar cada lead
        leads.forEach(lead => {
          try {
            // Verificar si el lead tiene status (normalizado)
            const status = normalizarTexto(lead.status);
            const isCancel = (
              status.includes('cancel') ||
              status.includes('anulad') ||
              status.includes('no instalado')
            );
            const isPending = /pendient/.test(status) || /pending/.test(status);
            const isActive = /\bcompleted\b|\bcompletad[ao]\b|\bterminad[ao]\b|\bactive\b|\bactivo\b/.test(status);


            // Para KPIs de status: usar fecha de INSTALACIÃ“N del mes objetivo
            // (pero NO cortar el procesamiento del lead; otros KPIs siguen usando la fecha principal)
            const installISO = getInstallDateFromLead(lead);
            const hasValidInstallISO = !!(installISO && /^\d{4}-\d{2}-\d{2}$/.test(installISO));
            let inTargetMonthInstall = false;
            if (!hasValidInstallISO) {
              __kpiMissingDate++;
            } else {
              const [yI, mI] = installISO.split('-').map(Number);
              inTargetMonthInstall = (yI === yTarget && mI === mTarget);
            }

            // Fecha principal (venta/contratación)
            const leadISO = getSaleDateFromLead(lead);
            const hasValidLeadISO = !!(leadISO && /^\d{4}-\d{2}-\d{2}$/.test(leadISO));
            let inTargetMonthLead = false;
            let inPrevMonthLead = false;
            if (hasValidLeadISO) {
              const [yL, mL] = leadISO.split('-').map(Number);
              inTargetMonthLead = (yL === yTarget && mL === mTarget);
              inPrevMonthLead = (yL === yPrev && mL === mPrev);
            }

            // Conteo de status para diagnÃ³stico (solo cuando pertenece al mes objetivo por instalaciÃ³n)
            if (inTargetMonthInstall) {
              __kpiStatusCounts[status || '(vacio)'] = (__kpiStatusCounts[status || '(vacio)'] || 0) + 1;
            }

            // KPIs por status (Activas / Pendientes / Cancelados):
            // Regla solicitada (para cuadrar con "mes por instalación"):
            // - Solo cuenta si la INSTALACIÓN cae en el mes seleccionado.
            // - Dentro de esas instalaciones del mes: cuenta si la venta fue del mes seleccionado (mes)
            //   o si la venta fue del mes anterior (colchón).
            // Nota: pendientes excluye cancelados.
            const isCushion = inPrevMonthLead && inTargetMonthInstall;
            const shouldCountStatusKpi = inTargetMonthLead || isCushion;
            if (!__useBackendStatusKpis) {
              if (shouldCountStatusKpi) {
                if (isCancel) {
                  cancelados++;
                } else {
                  if (isPending) pendientes++;
                  if (isActive) ventasActivas++;
                }
              }
            }
            // DEBUG: mostrar en consola cÃ³mo se están filtrando estos KPIs
            if (isPending || isCancel || isActive) {
              console.log('[KPI-DEBUG]', {
                status,
                isPending,
                isCancel,
                isActive,
                installISO,
                inTargetMonthInstall,
                leadISO,
                inTargetMonthLead,
                yTarget,
                mTarget,
                nombre: lead?.nombre_cliente || lead?.name || 'sin nombre'
              });
            }

            // DEBUG ESPECÍFICO para ventas activas y pendientes
            if (isActive || isPending) {
              if (isActive && !isCancel) totalActivasSinCancel++;
              if (isPending) totalPendientes++;
              
              if (inTargetMonthInstall) {
                if (isActive && !isCancel) totalActivasConInstalacionEnMes++;
                if (isPending) totalPendientesConInstalacionEnMes++;
              }
              
              const debugInfo = {
                nombre: lead?.nombre_cliente || lead?.name || 'sin nombre',
                status,
                isActive,
                isPending,
                isCancel,
                installISO,
                inTargetMonthInstall,
                seCuenta: inTargetMonthInstall && !isCancel && (isActive || isPending)
              };
              console.log('[STATUS DEBUG]', JSON.stringify(debugInfo, null, 2));
            }

            // Ventas hoy / Ventas del mes se mantienen por fecha principal (venta/contrataciÃ³n)
            if (leadISO && leadISO === todayISO && !isCancel) ventasHoy++;

            // Ventas del mes: se mantiene por fecha principal (venta/contratación)
            // (no depende de instalación).
            // Si se usan KPIs del backend para ventasMes, este bloque no se ejecuta porque canUseBackendKpis será true y no queremos sobreescribir.
            if (!canUseBackendKpis) {
              if (inTargetMonthLead && !isCancel) ventasMes++;
            }

            // Logs de conteo (solo cuando realmente se cuenta)
            if (shouldCountStatusKpi && !isCancel && isActive) {
              console.log('[VENTA ACTIVA CONTADA]', {
                nombre: lead?.nombre_cliente || lead?.name || 'sin nombre',
                status,
                installISO,
                inTargetMonthInstall,
                leadISO,
                inTargetMonthLead,
                isCushion,
                totalAcumulado: ventasActivas
              });
            }
            if (shouldCountStatusKpi && !isCancel && isPending) {
              console.log('[PENDIENTE CONTADO]', {
                nombre: lead?.nombre_cliente || lead?.name || 'sin nombre',
                status,
                installISO,
                inTargetMonthInstall,
                leadISO,
                inTargetMonthLead,
                isCushion,
                totalAcumulado: pendientes
              });
            }
          } catch (e) {
            console.error('Error procesando lead:', lead, e);
          }
        });
        
        console.log('[updateSummaryCards] FINAL KPIs:', {
          ventasHoy,
          ventasMes,
          ventasActivas,
          pendientes,
          cancelados,
          targetMonthStr,
          yTarget,
          mTarget,
          // Debug de ventas activas y pendientes
          debugActivas: {
            totalActivasSinCancel,
            totalActivasConInstalacionEnMes,
            ventasActivasContadas: ventasActivas,
            diferenciaActivas: totalActivasSinCancel - ventasActivas
          },
          debugPendientes: {
            totalPendientes,
            totalPendientesConInstalacionEnMes,
            pendientesContados: pendientes,
            diferenciaPendientes: totalPendientes - pendientes
          }
        });

        try {
          const otros = Math.max(0, (ventasMes - pendientes - cancelados));
          window.__lastKpiDebug = {
            targetMonth: targetMonthStr,
            totalMes: ventasMes,
            pendientes,
            cancelados,
            otros,
            statusCounts: __kpiStatusCounts,
            missingDateCount: __kpiMissingDate,
            totalInputLeads: Array.isArray(leads) ? leads.length : 0
          };
          console.log('[KPI DEBUG] Mes:', targetMonthStr, {
            totalMes: ventasMes,
            pendientes,
            cancelados,
            otros,
            missingDateCount: __kpiMissingDate,
            statusCounts: __kpiStatusCounts
          });
        } catch (_) {}
      }
      
      // Actualizar el DOM con los valores calculados
      if (ventasHoyElement) {
        ventasHoyElement.textContent = ventasHoy.toString();
        console.log('Actualizado ventas hoy:', ventasHoy);
      }

      if (ventasMesElement) {
        ventasMesElement.textContent = ventasMes.toString();
        console.log('Actualizado ventas mes:', ventasMes);
      }

      if (ventasActivasElement) {
        ventasActivasElement.textContent = ventasActivas.toString();
        console.log('Actualizado ventas activas:', ventasActivas);
      }
      
      if (pendientesElement) {
        pendientesElement.textContent = pendientes.toString();
        console.log('Actualizado pendientes:', pendientes);
      }
      
      if (canceladosElement) {
        canceladosElement.textContent = cancelados.toString();
        console.log('Actualizado cancelados:', cancelados);
      }
      
      // Las variables de los elementos del DOM ya estÂ¨Â¢n declaradas al inicio de la funciÂ¨Â®n
      
      if (ventasHoyElement) {
        ventasHoyElement.textContent = ventasHoy.toString();
        console.log('Actualizado ventas hoy en el DOM');
      }

      if (ventasMesElement) {
        ventasMesElement.textContent = ventasMes.toString();
        console.log('Actualizado ventas mes en el DOM');
      }

      if (ventasActivasElement) {
        ventasActivasElement.textContent = ventasActivas.toString();
        console.log('Actualizado ventas activas en el DOM');
      }
      
      if (pendientesElement) {
        pendientesElement.textContent = pendientes.toString();
        console.log('Actualizado pendientes en el DOM');
      }
      
      if (canceladosElement) {
        canceladosElement.textContent = cancelados.toString();
        console.log('Actualizado cancelados en el DOM');
      }

      // --- Calcular nuevos KPIs (Puntaje Mensual, ICON, BAMO) ---
      try {
        // Puntaje mensual: suma acumulada de puntaje hasta el dÃ­a de hoy
        // Si hay un mes seleccionado en el selector, usar ese mes;
        // en caso contrario usar el mes actual.
        const monthSelect = document.getElementById('monthFilter');
        const selectedMonth = monthSelect && monthSelect.value ? monthSelect.value : `${String(yNow).padStart(4,'0')}-${String(mNow).padStart(2,'0')}`;
        const todayISOcmp = todayISO; // YYYY-MM-DD
        let puntajeMensual = null;
        try {
          const kt = window.__kpisTotals;
          if (canUseBackendKpis && kt && typeof kt === 'object' && typeof kt.puntajeMensual === 'number') {
            puntajeMensual = kt.puntajeMensual;
          }
        } catch (_) { puntajeMensual = null; }

        if (puntajeMensual === null) {
          puntajeMensual = 0;
          leads.forEach(l => {
            try {
              const status = normalizarTexto(l.status || '');
              const isCancel = status.includes('cancel') || status.includes('anulad');
              if (isCancel) return;
              // Active Oficina: para roles agente/vendedor/supervisor NO suma puntaje
              const isActiveOficina = ((status.includes('active') || status.includes('activo')) && status.includes('oficina'));
              if (__excludeActiveOficinaFromPoints && isActiveOficina) return;
              const leadISO = getDateFromLead(l);
              if (!leadISO) return;
              const leadMonth = leadISO.slice(0,7); // YYYY-MM
              if (leadMonth !== selectedMonth) return;
              // Si el mes seleccionado es el mes actual, solo sumar hasta hoy
              if (selectedMonth === `${String(yNow).padStart(4,'0')}-${String(mNow).padStart(2,'0')}`) {
                if (leadISO > todayISOcmp) return;
              }
              const p = parseFloat(l.puntaje || l.puntaje_calculado || 0) || 0;
              puntajeMensual += p;
            } catch (e) { /* noop */ }
          });
          // Redondear a entero si es prÃ¡cticamente entero
          puntajeMensual = Math.round(puntajeMensual * 100) / 100;
        } else {
          puntajeMensual = Math.round(puntajeMensual * 100) / 100;
        }

        const selectedMonthSafe = (selectedMonth && /^\d{4}-\d{2}$/.test(String(selectedMonth).trim()))
          ? String(selectedMonth).trim()
          : `${String(yNow).padStart(4,'0')}-${String(mNow).padStart(2,'0')}`;
        const [ySel, mSel] = selectedMonthSafe.split('-').map(Number);

        const iconVentas = leads.filter(l => {
          const mercado = String(l.mercado || '').trim().toUpperCase();
          const status = normalizarTexto(l.status || '');
          const isCancel = status.includes('cancel') || status.includes('anulad');
          const leadISO = getDateFromLead(l);
          if (!leadISO) return false;
          const [yL, mL] = leadISO.split('-').map(Number);
          return mercado === 'ICON' && yL === ySel && mL === mSel && !isCancel;
        }).length;

        const bamoVentas = leads.filter(l => {
          const mercado = String(l.mercado || '').trim().toUpperCase();
          const status = normalizarTexto(l.status || '');
          const isCancel = status.includes('cancel') || status.includes('anulad');
          const leadISO = getDateFromLead(l);
          if (!leadISO) return false;
          const [yL, mL] = leadISO.split('-').map(Number);
          return mercado === 'BAMO' && yL === ySel && mL === mSel && !isCancel;
        }).length;

        const totalMercados = iconVentas + bamoVentas;
        const iconPercent = totalMercados > 0 ? ((iconVentas / totalMercados) * 100).toFixed(1) : 0;
        const bamoPercent = totalMercados > 0 ? ((bamoVentas / totalMercados) * 100).toFixed(1) : 0;

        // ACTIVAS por mercado: para ADMIN/SUPERVISOR usar KPIs del backend (mismo origen que "Ventas Activas")
        let activasIcon = null;
        let activasBamo = null;
        try {
          const u3 = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const r3 = (u3.role || u3?.usuario?.role || '').toString().trim().toLowerCase();
          const isAgente3 = ['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r3);
          if (!isAgente3 && canUseBackendKpis) {
            const kt = window.__kpisTotals;
            if (typeof kt.activasIcon === 'number') activasIcon = kt.activasIcon;
            if (typeof kt.activasBamo === 'number') activasBamo = kt.activasBamo;
          }
        } catch (_) {}

        // Fallback: si no hay KPIs del backend (o es agente), calcular localmente desde `leads`
        if (activasIcon === null || activasBamo === null) {
          activasIcon = 0;
          activasBamo = 0;

          // Reutilizar la misma lógica del bucle principal de KPIs
          const userData3 = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const roleRaw3 = (userData3.role || userData3?.usuario?.role || '').toString().trim().toLowerCase();
          const isAgente3 = ['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(roleRaw3);
          
          leads.forEach(l => {
            try {
              const mercado = String(l.mercado || '').trim().toUpperCase();
              const status = normalizarTexto(l.status || '');
              const isCancel = status.includes('cancel') || status.includes('anulad') || status.includes('no instalado');
              const isActive = /\bcompleted\b|\bcompletad[ao]\b|\bterminad[ao]\b|\bactive\b|\bactivo\b/.test(status);

              const leadISO = getDateFromLead(l);
              let inTargetMonth = false;
              if (!leadISO) {
                if (!__hasExplicitMonthFilter) return;
                inTargetMonth = true;
              } else {
                const [yL, mL] = leadISO.split('-').map(Number);
                inTargetMonth = (yL === ySel && mL === mSel);
                if (!inTargetMonth) return;
              }

              const shouldCount = (isAgente3 || !canUseBackendKpis);
              if (isActive && !isCancel && shouldCount && inTargetMonth) {
                if (mercado === 'ICON') activasIcon++;
                if (mercado === 'BAMO') activasBamo++;
              }
            } catch (e) { /* noop */ }
          });
        }

        // Actualizar DOM
        const puntajeMensualEl = document.getElementById('costumer-puntaje-mensual');
        const iconVentasEl = document.getElementById('costumer-icon-ventas');
        const bamoVentasEl = document.getElementById('costumer-bamo-ventas');
        const iconPercentEl = document.getElementById('costumer-icon-percent');
        const bamoPercentEl = document.getElementById('costumer-bamo-percent');
        const activasIconEl = document.getElementById('costumer-activas-icon');
        const activasBamoEl = document.getElementById('costumer-activas-bamo');

        if (puntajeMensualEl) puntajeMensualEl.textContent = puntajeMensual.toString();
        if (iconVentasEl) iconVentasEl.textContent = iconVentas.toString();
        if (bamoVentasEl) bamoVentasEl.textContent = bamoVentas.toString();
        if (iconPercentEl) iconPercentEl.textContent = iconPercent + '%';
        if (bamoPercentEl) bamoPercentEl.textContent = bamoPercent + '%';
        if (activasIconEl) activasIconEl.textContent = activasIcon.toString();
        if (activasBamoEl) activasBamoEl.textContent = activasBamo.toString();

        console.log('[KPI] Metricas calculadas:', { puntajeMensual, iconVentas, bamoVentas, iconPercent, bamoPercent, activasIcon, activasBamo });
        console.log('[KPI] Total leads procesados:', leads.length);
        console.log('[KPI] Verificación:', {
          totalActivasIconBamo: activasIcon + activasBamo,
          ventasActivasEsperado: ventasActivas,
          diferencia: (activasIcon + activasBamo) - ventasActivas
        });
      } catch (err) {
        console.error('[KPI] Error calculando KPIs:', err);
      }
      
      try {
        // Datos para el grÂ¨Â¢fico de ventas por semana (fechas locales)
        const ultimos7Dias = Array.from({ length: 7 }, (_, i) => {
          const fecha = new Date();
          fecha.setHours(0,0,0,0);
          fecha.setDate(fecha.getDate() - (6 - i));
          return toLocalISO(fecha);
        });

        // Etiquetas: dÂ¨Âªas de la semana
        const diasSemanaEtiquetas = ['dom', 'lun', 'mar', 'miÂ¨Â¦', 'jue', 'vie', 'sÂ¨Â¢b'];
        const labelsDias = ultimos7Dias.map(f => {
          const [y, m, d] = f.split('-').map(Number);
          const loc = new Date(y, m - 1, d);
          return diasSemanaEtiquetas[loc.getDay()];
        });

        const ventasPorDia = ultimos7Dias.map(fechaISO => {
          return leads.filter(lead => getDateFromLead(lead) === fechaISO).length;
        });

        // Puntaje total por dÂ¨Âªa (no promedio)
        const puntajesPorDia = ultimos7Dias.map(fechaISO => {
          return leads.reduce((sum, lead) => {
            const status = normalizarTexto(lead.status || '');
            const isCancel = /cancel/.test(status);
            const isActiveOficina = ((status.includes('active') || status.includes('activo')) && status.includes('oficina'));
            if (!isCancel && getDateFromLead(lead) === fechaISO) {
              if (__excludeActiveOficinaFromPoints && isActiveOficina) return sum;
              return sum + (parseFloat(lead.puntaje) || 0);
            }
            return sum;
          }, 0);
        });
        
        // Datos para el grÂ¨Â¢fico de distribuciÂ¨Â®n por producto
        const productos = {};
        leads.forEach(lead => {
          const producto = lead.tipo_servicios || 'Sin especificar';
          productos[producto] = (productos[producto] || 0) + 1;
        });

        const etiquetasProductos = Object.keys(productos);
        const datosProductos = Object.values(productos);

        // Colores para los productos
        const coloresProductos = [
          '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
          '#858796', '#5a5c69', '#3a3b45', '#1a1a1a', '#000000'
        ].slice(0, etiquetasProductos.length);

        // Renderizar o actualizar los grÂ¨Â¢ficos
        if (typeof renderizarGraficoVentas === 'function' && typeof renderizarGraficoProductos === 'function') {
          renderizarGraficoVentas(labelsDias, ventasPorDia, puntajesPorDia);
          renderizarGraficoProductos(etiquetasProductos, datosProductos, coloresProductos);
        }
      } catch (e) {
        console.error('[Charts] Error renderizando grÃ¡ficas:', e);
      }
    }

    function formatLeadIdShort(id) {
      const s = String(id || '');
      const letters = (s.match(/[a-z]/gi) || []).map(c => c.toUpperCase());
      const numbers = (s.match(/\d/g) || []);
      const l1 = letters[0] || 'X';
      const n1 = numbers[0] || '0';
      const l2 = letters[1] || 'Y';
      const n2 = numbers[1] || '0';
      return `${l1}${n1}${l2}${n2}`;
    }

    window.editarLead = async function(id) {
      console.log('Editar lead:', id);
      if (!id) {
        alert('Error: No se proporcionó un ID vÃ¡lido');
        return;
      }
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const res = await fetch(`/api/leads/${encodeURIComponent(id)}`, { method: 'GET', credentials: 'include', headers });
        if (!res.ok) throw new Error('No se pudo obtener el registro del servidor');
        const data = await res.json();
        // Desempaquetar respuestas anidadas (algunos handlers retornan {success,data:{success,data:lead}})
        let lead = data && (data.lead || data.data || data);
        for (let i = 0; i < 3; i++) {
          if (lead && typeof lead === 'object' && lead.success && (lead.lead || lead.data)) {
            lead = lead.lead || lead.data;
            continue;
          }
          break;
        }
        if (!lead) throw new Error('Registro no encontrado');
        // Forzar el ID del registro en ediciÃ³n (evita que el modal quede sin edit-id)
        abrirModalEdicion(lead, String(id));
      } catch (error) {
        console.error('Error al cargar lead para ediciÃ³n:', error);
        alert('Error al cargar los datos del registro: ' + (error?.message || error));
      }
    };

    window.eliminarLead = async function(id) {
      try {
        if (!(typeof canDeleteLead === 'function' && canDeleteLead())) {
          alert('No tienes permisos para eliminar leads');
          return;
        }
        const leadId = String(id || '').trim();
        if (!leadId) { alert('ID invÃ¡lido'); return; }
        if (!confirm('Â¿Seguro que deseas eliminar este lead? Esta acciÃ³n no se puede deshacer.')) return;

        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const headers = { 'Accept': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const res = await fetch(`/api/leads/${encodeURIComponent(leadId)}`, {
          method: 'DELETE',
          credentials: 'include',
          headers
        });
        if (!res.ok) {
          let t = '';
          try { t = await res.text(); } catch (_) {}
          throw new Error(`HTTP ${res.status}${t ? ` - ${t.slice(0,200)}` : ''}`);
        }

        // Remover fila
        try {
          const tr = document.querySelector(`tr[data-lead-id="${leadId}"]`);
          if (tr && tr.parentElement) tr.parentElement.removeChild(tr);
        } catch (_) {}

        // Remover de memoria si existe
        try {
          if (Array.isArray(window.ultimaListaLeads)) {
            window.ultimaListaLeads = window.ultimaListaLeads.filter(l => {
              try {
                const lid = (typeof getLeadId === 'function') ? getLeadId(l) : (l?._id?.$oid || l?._id || l?.id || '');
                return String(lid) !== leadId;
              } catch (_) {
                return true;
              }
            });
          }
        } catch (_) {}

        alert('Lead eliminado correctamente');
      } catch (e) {
        console.error('Error eliminando lead:', e);
        alert('No se pudo eliminar el lead: ' + (e?.message || e));
      }
    };

    async function addSystemComment(leadId, commentText) {
      if (!leadId || !commentText) return;
      try {
        const user = obtenerUsuarioActual();
        const nuevoComentario = {
          autor: user || 'Sistema',
          fecha: new Date().toISOString(),
          texto: commentText,
          isSystem: true
        };
        const cacheKey = `comments_cache_${leadId}`;
        const cachedComments = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        cachedComments.push(nuevoComentario);
        localStorage.setItem(cacheKey, JSON.stringify(cachedComments));
        const token = localStorage.getItem('token') || sessionStorage.getItem('token') || '';
        await fetch(`/api/leads/${encodeURIComponent(leadId)}/comentarios`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) },
          body: JSON.stringify(nuevoComentario)
        });
        if (document.getElementById('comentariosModal').style.display === 'block' && window.leadActual === leadId) {
          await cargarComentarios(leadId);
        }
      } catch (error) {
        console.error('Error al aÃ±adir comentario de sistema:', error);
      }
    }

    function sendDesktopNotification(title, body) {
      if (!('Notification' in window)) return;
      if (Notification.permission === 'granted') {
        new Notification(title, { body: body, icon: '/img/logo-slogan.png' });
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
          if (permission === 'granted') {
            new Notification(title, { body: body, icon: '/img/logo-slogan.png' });
          }
        }).catch(() => {});
      }
    }

    function abrirModalEdicion(lead, forcedId) {
      const modal = document.getElementById('editarModal');
      if (!modal) return;

      const leadId = (() => {
        try {
          const forced = String(forcedId || '').trim();
          if ((/^[a-fA-F0-9]{24}$/).test(forced)) return forced;
          // Importante: NO tomar cualquier 24-hex del JSON (puede ser agenteId/supervisorId).
          // Solo aceptar el _id real del lead.
          if (typeof extractLeadId === 'function') {
            const id = String(extractLeadId(lead) || '').trim();
            return (/^[a-fA-F0-9]{24}$/).test(id) ? id : '';
          }
          const candidates = [lead?._id?.$oid, lead?._id, lead?.id, lead?.leadId, lead?.leadID];
          for (const c of candidates) {
            const s = String((c && c.$oid) ? c.$oid : c || '').trim();
            if (/^[a-fA-F0-9]{24}$/.test(s)) return s;
          }
          return '';
        } catch (_) {
          return '';
        }
      })();

      const editIdEl = document.getElementById('edit-id');
      if (editIdEl) editIdEl.value = leadId;

      // Normalizar el lead en memoria para que siempre tenga un ID consistente
      try {
        if (leadId && lead && typeof lead === 'object') {
          lead.id = String(leadId);
          // Mantener _id compatible con extractLeadId (string o {$oid})
          if (typeof lead._id !== 'string') {
            lead._id = { $oid: String(leadId) };
          }
        }
      } catch (_) {}

      const idDisplayEl = document.getElementById('edit-lead-id-display');
      if (idDisplayEl) {
        try {
          idDisplayEl.textContent = leadId ? `#${formatLeadIdShort(leadId)}` : '#----';
        } catch (_) {
          idDisplayEl.textContent = leadId ? `#${String(leadId).slice(0, 6)}` : '#----';
        }
      }

      function getValue(...keys) {
        for (const k of keys) {
          if (!k) continue;
          const v = (lead && lead[k] !== undefined && lead[k] !== null) ? lead[k]
            : (lead && lead._raw && lead._raw[k] !== undefined && lead._raw[k] !== null) ? lead._raw[k]
            : undefined;
          if (v !== undefined && v !== null) return v;
        }
        return '';
      }

      function setVal(id, value) {
        const el = document.getElementById(id);
        if (!el) return false;
        el.value = (value === undefined || value === null) ? '' : value;
        return true;
      }

      try {
        const nombreCompleto = String(getValue('nombre_cliente', 'nombre', 'name', 'cliente') || '').trim();
        const nombresDirecto = String(getValue('nombres', 'firstName', 'firstname') || '').trim();
        const apellidosDirecto = String(getValue('apellidos', 'lastName', 'lastname') || '').trim();
        if (nombresDirecto || apellidosDirecto) {
          setVal('edit-nombres', nombresDirecto);
          setVal('edit-apellidos', apellidosDirecto);
        } else if (nombreCompleto) {
          const parts = nombreCompleto.split(/\s+/).filter(Boolean);
          setVal('edit-nombres', parts.shift() || '');
          setVal('edit-apellidos', parts.join(' '));
        }
      } catch (_) {}

      setVal('edit-zip-code', getValue('zip_code', 'zip', 'zipcode', 'postal', 'postal_code'));
      setVal('edit-mercado', getValue('mercado', 'market'));
      setVal('edit-motivo-llamada', getValue('motivo_llamada', 'motivo', 'call_reason', 'reason'));
      setVal('edit-comentario', getValue('comentario', 'comment', 'comentarios'));

      setVal('edit-telefono', getValue('telefono_principal', 'telefono', 'phone', 'tel'));
      setVal('edit-telefono-alt', getValue('telefono_alterno', 'telefono_secundario', 'phone2', 'tel2'));
      setVal('edit-numero-cuenta', getValue('numero_cuenta', 'account', 'cuenta', 'accountNumber'));
      setVal('edit-direccion', getValue('direccion', 'address', 'domicilio'));

      // Asignar Representante (Agente) y Supervisor con fallbacks
      setVal('edit-representante', getValue('agenteNombre', 'agente', 'agenteId', 'agent'));
      // Algunos builds usan edit-supervisor (no edit-sup)
      if (!setVal('edit-sup', getValue('supervisor', 'supervisorId', 'team'))) {
        setVal('edit-supervisor', getValue('supervisor', 'supervisorId', 'team'));
      }

      function setSelectValue(selectId, value) {
        const sel = document.getElementById(selectId);
        if (!sel) return;
        const raw = String(value ?? '').trim();
        if (!raw) return;

        const norm = (s) => String(s ?? '').toLowerCase().trim().replace(/[\s_-]+/g, '');
        let target = raw;

        if (selectId === 'edit-autopago') {
          const s = String(raw).toLowerCase().trim();
          target = (s === 'true' || s === '1' || s === 'si' || s === 'sÃ­' || s === 'yes' || s === 'y') ? 'SI'
            : (s === 'false' || s === '0' || s === 'no' || s === 'n') ? 'NO'
            : raw;
        }

        if (selectId === 'edit-riesgo') {
          const s = String(raw).toLowerCase().trim();
          target = (s.includes('low')) ? 'low'
            : (s.includes('medium') || s.includes('med')) ? 'medium'
            : (s.includes('high')) ? 'high'
            : (s === 'n/a' || s === 'na') ? 'na'
            : raw;
        }

        if (selectId === 'edit-status') {
          const s = String(raw).toLowerCase().trim();
          target = (s.includes('cancel') || s.includes('anulad') || s.includes('no instalado')) ? 'CANCELED'
            : (s.includes('active') || s.includes('complet') || s.includes('install') || s.includes('termin')) ? 'ACTIVE'
            : raw;
        }

        const want = norm(target);
        for (const opt of Array.from(sel.options)) {
          if (norm(opt.value) === want) { sel.value = opt.value; return; }
        }
        for (const opt of Array.from(sel.options)) {
          if (norm(opt.textContent) === want) { sel.value = opt.value; return; }
        }

        const newOpt = document.createElement('option');
        newOpt.value = raw;
        newOpt.textContent = raw;
        sel.appendChild(newOpt);
        sel.value = raw;
      }

      setSelectValue('edit-tipo-servicios', getValue('tipo_servicios', 'tipo_servicio', 'SERVICIO', 'producto'));
      setSelectValue('edit-servicios', getValue('servicios', 'servicios_texto', 'service'));
      setSelectValue('edit-autopago', getValue('autopago', 'autopay').toString());
      setSelectValue('edit-sistema', getValue('sistema', 'system'));
      setSelectValue('edit-riesgo', getValue('riesgo', 'risk').toString());
      setSelectValue('edit-status', getValue('status', 'estado').toString());
      setSelectValue('edit-puntaje', getValue('puntaje', 'puntos', 'score', 'puntaje_calculado').toString());

      const statusSelect = document.getElementById('edit-status');
      if (statusSelect) {
        statusSelect.onchange = async function(event) {
          const newStatus = String(event.target.value || '').toLowerCase();
          const triggerStatuses = ['cancel', 'hold', 'resched', 'repro', 'anulad', 'no instalado'];
          if (!triggerStatuses.some(s => newStatus.includes(s))) return;

          const clientName = (document.getElementById('edit-nombres').value + ' ' + document.getElementById('edit-apellidos').value).trim();
          const selected = event.target.value;
          const reason = prompt(`Â¿CuÃ¡l es el motivo del cambio de status de "${clientName}" a "${selected}"?`);
          if (reason && reason.trim()) {
            const commentText = `Status cambiado a ${selected}: ${reason}`;
            await addSystemComment(leadId, commentText);
            sendDesktopNotification(`Status de ${clientName} actualizado`, commentText);
          }
        };
      }

      function formatDateForInput(dateStr) {
        if (!dateStr) return '';
        try {
          const dt = new Date(dateStr);
          if (!isNaN(dt)) return dt.toISOString().slice(0, 10);
        } catch {}
        return String(dateStr).slice(0, 10);
      }

      const ventaEl = document.getElementById('edit-dia-venta');
      if (ventaEl) ventaEl.value = formatDateForInput(getValue('dia_venta', 'fecha_venta'));
      const instEl = document.getElementById('edit-dia-instalacion');
      if (instEl) instEl.value = formatDateForInput(getValue('dia_instalacion', 'fecha_instalacion'));

      try { window.__currentEditingLead = lead; } catch(_) {}

      try {
        const list = document.getElementById('edit-notes-list');
        if (list) {
          list.innerHTML = '';
          let notas = Array.isArray(lead?.notas) ? lead.notas : (Array.isArray(lead?.notes) ? lead.notes : []);
          notas = notas.slice().sort((a, b) => {
            const da = new Date(a?.at || a?.fecha || a?.createdAt || 0);
            const db = new Date(b?.at || b?.fecha || b?.createdAt || 0);
            return db - da;
          });
          if (notas.length && typeof createNoteCard === 'function') {
            notas.forEach((n, idx) => list.appendChild(createNoteCard(n, idx)));
          } else {
            list.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Sin notas</p>';
          }
        }
      } catch (_) {}

      try {
        const textarea = document.getElementById('edit-nueva-nota');
        if (textarea) textarea.value = '';
      } catch (_) {}
      modal.style.display = 'block';
    }

    (function initSocketIO() {
      // Cargar Socket.io cliente desde CDN si no está disponible localmente
      function loadSocketIO(src, fallback) {
        const script = document.createElement('script');
        script.src = src;
        script.onload = function() {
          console.log('[Socket.io] Cliente cargado desde:', src);
          initSocket();
        };
        script.onerror = function() {
          console.warn('[Socket.io] No se pudo cargar desde:', src);
          if (fallback) {
            loadSocketIO(fallback, null);
          } else {
            console.error('[Socket.io] No se pudo cargar el cliente');
          }
        };
        document.head.appendChild(script);
      }
      
      function initSocket() {
        try {
          const socket = io({
            transports: ['websocket', 'polling'],
            upgrade: true,
            rememberUpgrade: true
          });
          window.socket = socket;
          
          // Obtener datos del usuario actual
          const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const identifier = userData.odigo || userData.agenteId || userData._id || userData.username || userData.name;
          
          socket.on('connect', () => {
            console.log('[Socket.io] Conectado, ID:', socket.id);
            
            // Registrar usuario al conectar
            if (identifier) {
              socket.emit('register', {
                odigo: userData.odigo,
                agenteId: userData.agenteId || userData._id,
                username: userData.username || userData.name,
                role: userData.role
              });
              console.log('[Socket.io] Registrado como:', identifier);
            }
          });
          
          // Escuchar notificaciones de notas
          socket.on('note-added', (data) => {
            console.log('[Socket.io] NotificaciÃ³n recibida:', data);
            if (window.NotificationSystem && Notification.permission === 'granted') {
              window.NotificationSystem.show('ðŸ“ Nueva Nota', {
                body: `${data.author} agregÃ³ una nota a ${data.clientName}`,
                onClick: () => {
                  window.focus();
                  if (data.leadId && typeof editarLead === 'function') {
                    editarLead(data.leadId);
                  }
                }
              });
            }
          });
          
          socket.on('note-edited', (data) => {
            console.log('[Socket.io] Nota editada:', data);
            if (window.NotificationSystem && Notification.permission === 'granted') {
              window.NotificationSystem.show('âœï¸ Nota Editada', {
                body: `${data.author} editÃ³ una nota en ${data.clientName}`
              });
            }
          });
          
          socket.on('note-deleted', (data) => {
            console.log('[Socket.io] Nota eliminada:', data);
            if (window.NotificationSystem && Notification.permission === 'granted') {
              window.NotificationSystem.show('ðŸ—‘ï¸ Nota Eliminada', {
                body: `Se eliminÃ³ una nota de ${data.clientName}`
              });
            }
          });

          socket.on('disconnect', (reason) => {
            console.log('[Socket.io] Desconectado:', reason);
          });
          
          socket.on('connect_error', (error) => {
            console.error('[Socket.io] Error de conexiÃ³n:', error.message);
          });
        } catch (err) {
          console.error('[Socket.io] Error inicializando:', err);
        }
      }
      
      // Intentar cargar desde servidor local, si falla usar CDN
      loadSocketIO('/socket.io/socket.io.js', 'https://cdn.socket.io/4.7.2/socket.io.min.js');
    })();

    // ========== SISTEMA DE NOTIFICACIONES DE WINDOWS ==========
    window.NotificationSystem = {
      // Solicitar permiso para notificaciones
      requestPermission: async function() {
        if (!('Notification' in window)) {
          console.warn('[Notificaciones] Este navegador no soporta notificaciones');
          return false;
        }
        if (Notification.permission === 'granted') {
          return true;
        }
        if (Notification.permission !== 'denied') {
          const permission = await Notification.requestPermission();
          return permission === 'granted';
        }
        return false;
      },

      // Mostrar notificaciÃ³n
      show: function(title, options = {}) {
        if (!('Notification' in window)) return;
        if (Notification.permission !== 'granted') {
          this.requestPermission();
          return;
        }
        
        const defaultOptions = {
          icon: '/img/logo.png',
          badge: '/img/logo.png',
          vibrate: [200, 100, 200],
          tag: 'crm-notification',
          requireInteraction: false,
          silent: false
        };
        
        const notification = new Notification(title, { ...defaultOptions, ...options });
        
        // Auto-cerrar despuÃ©s de 2 segundos
        setTimeout(() => notification.close(), 2000);
        
        // Click en la notificaciÃ³n
        notification.onclick = function() {
          window.focus();
          notification.close();
          if (options.onClick) options.onClick();
        };
        
        return notification;
      },

      // NotificaciÃ³n de nota agregada
      notifyNoteAdded: function(clientName, author) {
        this.show('ðŸ“ Nueva Nota Agregada', {
          body: `${author} agregÃ³ una nota a ${clientName}`,
          tag: 'note-added'
        });
      },

      // NotificaciÃ³n de nota editada
      notifyNoteEdited: function(clientName, author) {
        this.show('âœï¸ Nota Editada', {
          body: `${author} editÃ³ una nota en ${clientName}`,
          tag: 'note-edited'
        });
      },

      // NotificaciÃ³n de nota eliminada
      notifyNoteDeleted: function(clientName) {
        this.show('ðŸ—‘ï¸ Nota Eliminada', {
          body: `Se eliminÃ³ una nota de ${clientName}`,
          tag: 'note-deleted'
        });
      }
    };

    // Configurar botÃ³n de notificaciones (esperar a DOM listo)
    function initNotificationButton() {
      const btn = document.getElementById('enable-notifications-btn');
      if (!btn) {
        console.warn('[Notificaciones] BotÃ³n no encontrado, reintentando en 500ms...');
        setTimeout(initNotificationButton, 500);
        return;
      }
      
      console.log('[Notificaciones] BotÃ³n encontrado, configurando...');
      
      // Actualizar estado visual del botÃ³n
      function updateButtonState() {
        if (!('Notification' in window)) {
          btn.style.background = '#9ca3af';
          btn.title = 'Notificaciones no soportadas';
          btn.disabled = true;
          console.warn('[Notificaciones] API no soportada en este navegador');
          return;
        }
        if (Notification.permission === 'granted') {
          btn.style.background = '#10b981';
          btn.innerHTML = '<i class="fas fa-bell"></i> âœ“';
          btn.title = 'Notificaciones activadas';
        } else if (Notification.permission === 'denied') {
          btn.style.background = '#ef4444';
          btn.innerHTML = '<i class="fas fa-bell-slash"></i>';
          btn.title = 'Notificaciones bloqueadas - ActÃ­valas en configuraciÃ³n del navegador';
        } else {
          btn.style.background = '#6366f1';
          btn.innerHTML = '<i class="fas fa-bell"></i>';
          btn.title = 'Click para activar notificaciones';
        }
      }
      
      // Click para solicitar permiso
      btn.addEventListener('click', async function() {
        console.log('[Notificaciones] Click en botÃ³n, permiso actual:', Notification.permission);
        
        if (Notification.permission === 'granted') {
          // Enviar notificaciÃ³n de prueba
          window.NotificationSystem.show('ðŸ”” Notificaciones Activas', {
            body: 'Las notificaciones están funcionando correctamente'
          });
          return;
        }
        
        try {
          const granted = await window.NotificationSystem.requestPermission();
          console.log('[Notificaciones] Resultado del permiso:', granted);
          updateButtonState();
          
          if (granted) {
            window.NotificationSystem.show('ðŸ”” Notificaciones Activadas', {
              body: 'RecibirÃ¡s alertas cuando se agreguen o editen notas'
            });
          } else {
            alert('Para activar notificaciones:\n1. Click en el icono del candado ðŸ”’ en la barra de direcciones\n2. Busca "Notificaciones"\n3. Cambia a "Permitir"');
          }
        } catch (err) {
          console.error('[Notificaciones] Error:', err);
          alert('Error al solicitar permiso: ' + err.message);
        }
      });
      
      // Estado inicial
      updateButtonState();
      console.log('[Notificaciones] Estado actual:', Notification.permission);
    }
    
    // Ejecutar cuando DOM estÃ© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initNotificationButton);
    } else {
      setTimeout(initNotificationButton, 100);
    }

    // Función helper para crear una tarjeta de nota con botones
    function createNoteCard(note, index) {
      const div = document.createElement('div');
      div.className = 'note-card';
      div.dataset.noteIndex = index;
      
      const noteText = note.text || note.comentario || (typeof note === 'string' ? note : '');
      const author = note.author || '';
      const date = note.at ? new Date(note.at).toLocaleString() : '';
      
      // Obtener usuario actual para verificar si es el autor
      const currentUser = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const currentUsername = (currentUser.username || currentUser.name || currentUser.nombre || '').toLowerCase().trim();
      const noteAuthor = (author || '').toLowerCase().trim();
      const isOwner = currentUsername && noteAuthor && (currentUsername === noteAuthor || noteAuthor.includes(currentUsername) || currentUsername.includes(noteAuthor));
      const __role0 = (currentUser.role || '').toLowerCase().trim();
      const __role = __role0.replace(/\s+/g,'_').replace(/-+/g,'_');
      const isAdmin = __role === 'administrador' || __role === 'backoffice' || __role === 'rol_icon' || __role === 'rol_bamo';
      const canEditDelete = isOwner || isAdmin;
      
      // Info de creaciÃ³n
      let metaInfo = '';
      if (author || date) {
        metaInfo = `<div style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed #e5e7eb; font-size: 11px; color: #6b7280;">`;
        metaInfo += `<i class="fas fa-user" style="margin-right: 4px;"></i> ${author || 'Usuario'}`;
        if (date) metaInfo += ` <span style="margin-left: 8px;"><i class="fas fa-clock" style="margin-right: 4px;"></i>${date}</span>`;
        metaInfo += `</div>`;
      }
      
      // Info de ediciÃ³n (si fue editada)
      let editInfo = '';
      if (note.editedAt) {
        const editDate = new Date(note.editedAt).toLocaleString();
        const editor = note.editedBy || 'Usuario';
        editInfo = `<div style="margin-top: 6px; font-size: 11px; color: #f59e0b;">`;
        editInfo += `<i class="fas fa-edit" style="margin-right: 4px;"></i> Editado por ${editor} (${editDate})`;
        editInfo += `</div>`;
      }
      
      // Mostrar archivos adjuntos (imÃ¡genes y audios con reproductor)
      let attachmentsHtml = '';
      if (note.attachments && note.attachments.length > 0) {
        attachmentsHtml = '<div class="note-attachments" style="margin-top: 12px; display: flex; flex-direction: column; gap: 10px;">';
        note.attachments.forEach((att, attIdx) => {
          const fileId = att.fileId || att.url?.split('/').pop() || '';
          if (att.type === 'image') {
            attachmentsHtml += `
              <div style="display: flex; align-items: flex-start; gap: 10px;">
                <div onclick="abrirImagenModal('${att.url}')" style="cursor: pointer;">
                  <img src="${att.url}" alt="Imagen adjunta" style="max-width: 280px; max-height: 200px; border-radius: 10px; border: 2px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" />
                </div>
                <a href="${att.url}/download" download style="background: #f1f5f9; color: #475569; border: none; padding: 8px 12px; border-radius: 8px; font-size: 12px; text-decoration: none; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);" title="Descargar imagen">
                  <i class="fas fa-download"></i>
                </a>
              </div>`;
          } else if (att.type === 'audio') {
            attachmentsHtml += `
              <div class="audio-player-container" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px; max-width: 350px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <button onclick="this.nextElementSibling.paused ? this.nextElementSibling.play() : this.nextElementSibling.pause(); this.innerHTML = this.nextElementSibling.paused ? '<i class=\\'fas fa-play\\'></i>' : '<i class=\\'fas fa-pause\\'></i>'" style="width: 36px; height: 36px; border-radius: 50%; border: none; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 6px rgba(59,130,246,0.4);">
                  <i class="fas fa-play"></i>
                </button>
                <audio src="${att.url}" preload="metadata" style="display: none;" onended="this.previousElementSibling.innerHTML='<i class=\\'fas fa-play\\'></i>'"></audio>
                <div style="flex: 1; display: flex; flex-direction: column; gap: 4px; min-width: 0;">
                  <div style="font-size: 11px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i class="fas fa-microphone" style="margin-right: 4px; color: #3b82f6;"></i>${att.name || 'Audio'}
                  </div>
                  <input type="range" min="0" max="100" value="0" class="audio-progress" style="width: 100%; height: 4px; border-radius: 2px; cursor: pointer; accent-color: #3b82f6;" />
                  <div style="display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8;">
                    <span class="audio-current">0:00</span>
                    <span class="audio-duration">--:--</span>
                  </div>
                </div>
                <a href="${att.url}/download" download style="width: 32px; height: 32px; border-radius: 8px; background: #e2e8f0; color: #475569; display: flex; align-items: center; justify-content: center; text-decoration: none; flex-shrink: 0;" title="Descargar audio">
                  <i class="fas fa-download" style="font-size: 12px;"></i>
                </a>
              </div>`;
          } else if (att.type === 'video') {
            attachmentsHtml += `
              <div style="max-width: 300px;">
                <video controls style="width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                  <source src="${att.url}" type="video/mp4">
                </video>
                <a href="${att.url}/download" download style="display: inline-flex; align-items: center; gap: 4px; margin-top: 6px; background: #f1f5f9; color: #475569; padding: 6px 12px; border-radius: 6px; font-size: 11px; text-decoration: none;">
                  <i class="fas fa-download"></i> Descargar video
                </a>
              </div>`;
          } else if (att.type === 'pdf') {
            attachmentsHtml += `
              <a href="${att.url}/download" download style="display: flex; align-items: center; gap: 8px; background: #fef2f2; color: #991b1b; padding: 10px 14px; border-radius: 8px; text-decoration: none; max-width: fit-content;">
                <i class="fas fa-file-pdf" style="font-size: 20px;"></i>
                <span style="font-size: 12px;">${att.name || 'Documento PDF'}</span>
                <i class="fas fa-download" style="margin-left: 8px;"></i>
              </a>`;
          }
        });
        attachmentsHtml += '</div>';
      }
      
      // Botones de editar/eliminar solo si es el autor o admin
      const actionsHtml = canEditDelete ? `
        <div class="note-actions">
          <button class="note-btn note-btn-edit" onclick="editarNota(${index})" title="Editar nota">
            <i class="fas fa-pen"></i>
          </button>
          <button class="note-btn note-btn-delete" onclick="eliminarNota(${index})" title="Eliminar nota">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      ` : '';
      
      div.innerHTML = `
        <span class="note-text">${noteText.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}</span>
        ${attachmentsHtml}
        ${metaInfo}
        ${editInfo}
        ${actionsHtml}
      `;
      // Inicializar controles de audio despuÃ©s de insertar en DOM
      setTimeout(() => initAudioPlayers(div), 100);
      return div;
    }
    
    // Inicializar reproductores de audio con barra de progreso
    function initAudioPlayers(container) {
      const players = container.querySelectorAll('.audio-player-container');
      players.forEach(player => {
        const audio = player.querySelector('audio');
        const progress = player.querySelector('.audio-progress');
        const currentTime = player.querySelector('.audio-current');
        const duration = player.querySelector('.audio-duration');
        
        if (!audio || !progress) return;
        
        // Formatear tiempo
        const formatTime = (secs) => {
          if (isNaN(secs)) return '--:--';
          const m = Math.floor(secs / 60);
          const s = Math.floor(secs % 60);
          return `${m}:${s.toString().padStart(2, '0')}`;
        };
        
        // Cuando se carga metadata
        audio.addEventListener('loadedmetadata', () => {
          if (duration) duration.textContent = formatTime(audio.duration);
          progress.max = Math.floor(audio.duration);
        });
        
        // Actualizar progreso mientras reproduce
        audio.addEventListener('timeupdate', () => {
          if (currentTime) currentTime.textContent = formatTime(audio.currentTime);
          progress.value = Math.floor(audio.currentTime);
        });
        
        // Permitir seek con la barra
        progress.addEventListener('input', (e) => {
          audio.currentTime = e.target.value;
        });
        
        // Si ya tiene duraciÃ³n, actualizar
        if (audio.duration) {
          if (duration) duration.textContent = formatTime(audio.duration);
          progress.max = Math.floor(audio.duration);
        }
      });
    }

    // Función para editar una nota (usa el textarea de agregar nota)
    window.__editingNoteIndex = null;
    
    window.editarNota = function(index) {
      const notas = window.__currentEditingLead?.notas || window.__currentEditingLead?.notes || [];
      if (!notas[index]) return alert('Nota no encontrada');
      
      const nota = notas[index];
      const textoOriginal = nota.text || nota.comentario || '';
      
      // Poner el texto en el textarea de agregar nota
      const textarea = document.getElementById('edit-nueva-nota');
      const btn = document.querySelector('[onclick="agregarNotaCliente()"]');
      
      if (textarea) {
        textarea.value = textoOriginal;
        textarea.focus();
        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      // Cambiar botÃ³n a "Guardar Edición"
      if (btn) {
        btn.innerHTML = '<i class="fas fa-save"></i> Guardar Edición';
        btn.setAttribute('onclick', 'guardarEdicionNota()');
        btn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
      }
      
      // Guardar Ã­ndice de la nota que se está editando
      window.__editingNoteIndex = index;
    };

    // Cancelar ediciÃ³n de nota (restaurar botÃ³n original)
    window.cancelarEdicionNota = function() {
      const textarea = document.getElementById('edit-nueva-nota');
      const btn = document.querySelector('[onclick="guardarEdicionNota()"]');
      
      if (textarea) textarea.value = '';
      if (btn) {
        btn.innerHTML = '<i class="fas fa-plus"></i> Agregar Nota';
        btn.setAttribute('onclick', 'agregarNotaCliente()');
        btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
      }
      window.__editingNoteIndex = null;
    };

    // Guardar ediciÃ³n de nota
    window.guardarEdicionNota = async function() {
      const index = window.__editingNoteIndex;
      if (index === null || index === undefined) return alert('No hay nota en ediciÃ³n');
      
      const notas = window.__currentEditingLead?.notas || window.__currentEditingLead?.notes || [];
      const textarea = document.getElementById('edit-nueva-nota');
      
      if (!textarea) return;
      const nuevoTexto = textarea.value.trim();
      if (!nuevoTexto) return alert('La nota no puede estar vacÃ­a');
      
      // Actualizar nota
      notas[index].text = nuevoTexto;
      notas[index].editedAt = new Date().toISOString();
      // Obtener nombre del usuario que edita (buscar en mÃºltiples propiedades)
      const u = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
      const editorName = u.username || u.name || u.nombre || u.fullName || u?.usuario?.name || u?.usuario?.nombre || u?.usuario?.username || 'Usuario';
      notas[index].editedBy = editorName;
      console.log('[NOTA EDIT] Editor detectado:', editorName, 'User object:', u);
      
      // Guardar en backend
      const leadId = (() => {
        const raw = String(document.getElementById('edit-id')?.value || '').trim();
        if (raw && raw !== '[object Object]' && /^[a-fA-F0-9]{24}$/.test(raw)) return raw;
        const cur = window.__currentEditingLead || {};
        const candidates = [cur?._id?.$oid, cur?._id, cur?.id, cur?.leadId, cur?.leadID];
        for (const c of candidates) {
          const s = String((c && c.$oid) ? c.$oid : c || '').trim();
          if (s && s !== '[object Object]' && /^[a-fA-F0-9]{24}$/.test(s)) return s;
        }
        return raw;
      })();
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      const hint = String(window.__currentEditingLead?._collectionName || '').trim();
      const hintQ = hint ? `?collection=${encodeURIComponent(hint)}` : '';
      
      try {
        const res = await fetch(`/api/leads/${encodeURIComponent(leadId)}${hintQ}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json', 'Authorization': token ? `Bearer ${token}` : '' },
          body: JSON.stringify({ notas })
        });
        
        if (res.ok) {
          // Actualizar UI
          const list = document.getElementById('edit-notes-list');
          if (list) {
            list.innerHTML = '';
            notas.forEach((n, idx) => list.appendChild(createNoteCard(n, idx)));
          }
          if (window.__currentEditingLead) window.__currentEditingLead.notas = notas;
          
          // Restaurar botÃ³n original
          textarea.value = '';
          const btn = document.querySelector('[onclick="guardarEdicionNota()"]');
          if (btn) {
            btn.innerHTML = '<i class="fas fa-plus"></i> Agregar Nota';
            btn.setAttribute('onclick', 'agregarNotaCliente()');
            btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
          }
          window.__editingNoteIndex = null;
          // NotificaciÃ³n de Windows
          const u = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const editor = u.username || u.name || u.nombre || 'Usuario';
          const clientName = window.__currentEditingLead?.nombre_cliente || window.__currentEditingLead?.nombre || 'Cliente';
          window.NotificationSystem?.notifyNoteEdited(clientName, editor);
        } else {
          alert('Error al guardar la nota editada');
        }
      } catch(e) {
        alert('Error: ' + e.message);
      }
    };

    // Función para eliminar una nota
    window.eliminarNota = async function(index) {
      if (!confirm('Â¿EstÃ¡s seguro de eliminar esta nota?')) return;
      
      const notas = window.__currentEditingLead?.notas || window.__currentEditingLead?.notes || [];
      if (!notas[index]) return alert('Nota no encontrada');
      
      // Eliminar nota del array
      notas.splice(index, 1);
      
      // Guardar en backend
      const leadId = (() => {
        const raw = String(document.getElementById('edit-id')?.value || '').trim();
        if (raw && raw !== '[object Object]' && /^[a-fA-F0-9]{24}$/.test(raw)) return raw;
        const cur = window.__currentEditingLead || {};
        const candidates = [cur?._id?.$oid, cur?._id, cur?.id, cur?.leadId, cur?.leadID];
        for (const c of candidates) {
          const s = String((c && c.$oid) ? c.$oid : c || '').trim();
          if (s && s !== '[object Object]' && /^[a-fA-F0-9]{24}$/.test(s)) return s;
        }
        return raw;
      })();
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      const hint = String(window.__currentEditingLead?._collectionName || '').trim();
      const hintQ = hint ? `?collection=${encodeURIComponent(hint)}` : '';
      
      try {
        const res = await fetch(`/api/leads/${encodeURIComponent(leadId)}${hintQ}`, {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json', 'Authorization': token ? `Bearer ${token}` : '' },
          body: JSON.stringify({ notas })
        });
        
        if (res.ok) {
          // Actualizar UI
          const list = document.getElementById('edit-notes-list');
          if (list) {
            list.innerHTML = '';
            notas.forEach((n, idx) => list.appendChild(createNoteCard(n, idx)));
          }
          if (window.__currentEditingLead) window.__currentEditingLead.notas = notas;
          // NotificaciÃ³n de Windows
          const clientName = window.__currentEditingLead?.nombre_cliente || window.__currentEditingLead?.nombre || 'Cliente';
          window.NotificationSystem?.notifyNoteDeleted(clientName);
        } else {
          alert('Error al eliminar la nota');
        }
      } catch(e) {
        alert('Error: ' + e.message);
      }
    };

    // ========== SISTEMA DE ARCHIVOS ADJUNTOS EN NOTAS (GridFS) ==========
    window.__noteAttachments = []; // Array para almacenar archivos adjuntos temporalmente
    
    // Vista previa de archivo adjunto (guarda File para subir a GridFS despuÃ©s)
    window.previewNoteAttachment = function(input, type) {
      const file = input.files[0];
      if (!file) return;
      
      // Validar tamaÃ±o (mÃ¡ximo 500MB para audios grandes)
      const maxSize = 500 * 1024 * 1024; // 500MB
      if (file.size > maxSize) {
        alert('El archivo es muy grande. MÃ¡ximo 500MB.');
        input.value = '';
        return;
      }
      
      // Crear URL temporal para vista previa
      const previewUrl = URL.createObjectURL(file);
      const attachment = {
        type: type,
        name: file.name,
        file: file,        // Guardar archivo para subir a GridFS
        previewUrl: previewUrl  // Para vista previa local
      };
      window.__noteAttachments.push(attachment);
      updateAttachmentsPreview();
      input.value = ''; // Reset input
    };
    
    // Subir archivos a GridFS y obtener URLs
    async function uploadAttachmentsToGridFS(leadId) {
      const uploadedFiles = [];
      const token = localStorage.getItem('token') || sessionStorage.getItem('token');
      
      for (const att of window.__noteAttachments) {
        try {
          const formData = new FormData();
          formData.append('file', att.file);
          formData.append('leadId', leadId || '');
          
          const res = await fetch('/api/files/upload', {
            method: 'POST',
            headers: token ? { 'Authorization': `Bearer ${token}` } : {},
            body: formData
          });
          
          if (res.ok) {
            const data = await res.json();
            if (data.success && data.data) {
              uploadedFiles.push({
                type: data.data.fileType,
                name: data.data.originalName,
                url: data.data.url,
                fileId: data.data.fileId
              });
              console.log('[GridFS] Archivo subido:', data.data.originalName);
            }
          } else {
            console.error('[GridFS] Error subiendo:', att.name);
          }
        } catch (e) {
          console.error('[GridFS] Error:', e);
        }
      }
      return uploadedFiles;
    }
    
    // Actualizar vista previa de archivos adjuntos
    function updateAttachmentsPreview() {
      const preview = document.getElementById('note-attachments-preview');
      const list = document.getElementById('note-attachments-list');
      if (!preview || !list) return;
      
      if (window.__noteAttachments.length === 0) {
        preview.style.display = 'none';
        return;
      }
      
      preview.style.display = 'block';
      list.innerHTML = '';
      
      window.__noteAttachments.forEach((att, idx) => {
        const item = document.createElement('div');
        item.style.cssText = 'position: relative; display: inline-block;';
        const imgSrc = att.previewUrl || att.url;
        
        if (att.type === 'image') {
          item.innerHTML = `
            <img src="${imgSrc}" style="max-width: 80px; max-height: 60px; border-radius: 4px; border: 1px solid #cbd5e1;" />
            <button onclick="removeNoteAttachment(${idx})" style="position: absolute; top: -6px; right: -6px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-times"></i>
            </button>
          `;
        } else if (att.type === 'audio') {
          item.innerHTML = `
            <div style="background: #e0e7ff; padding: 6px 10px; border-radius: 4px; display: flex; align-items: center; gap: 6px; font-size: 11px; color: #4338ca;">
              <i class="fas fa-volume-up"></i>
              <span style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${att.name}</span>
              <button onclick="removeNoteAttachment(${idx})" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin-left: 4px;">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
        }
        list.appendChild(item);
      });
    }
    
    // Eliminar archivo adjunto
    window.removeNoteAttachment = function(index) {
      window.__noteAttachments.splice(index, 1);
      updateAttachmentsPreview();
    };
    
    // Limpiar archivos adjuntos
    function clearNoteAttachments() {
      window.__noteAttachments = [];
      updateAttachmentsPreview();
    }

    // Agregar nota desde el modal
    window.agregarNotaCliente = async function() {
      try {
        const textarea = document.getElementById('edit-nueva-nota');
        const list = document.getElementById('edit-notes-list');
        const text = (textarea?.value || '').trim();
        const hasAttachments = window.__noteAttachments && window.__noteAttachments.length > 0;
        
        if (!text && !hasAttachments) return alert('Escribe una nota o adjunta un archivo');
        
        const leadId = (() => {
          const raw = String(document.getElementById('edit-id')?.value || '').trim();
          if (raw && raw !== '[object Object]' && /^[a-fA-F0-9]{24}$/.test(raw)) return raw;
          const cur = window.__currentEditingLead || {};
          const candidates = [cur?._id?.$oid, cur?._id, cur?.id, cur?.leadId, cur?.leadID];
          for (const c of candidates) {
            const s = String((c && c.$oid) ? c.$oid : c || '').trim();
            if (s && s !== '[object Object]' && /^[a-fA-F0-9]{24}$/.test(s)) return s;
          }
          return raw;
        })();
        console.log('[NOTA] Lead ID obtenido del formulario:', leadId, 'longitud:', leadId?.length);
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        console.log('[NOTA] Token presente:', !!token);
        
        // Obtener autor (buscar en mÃºltiples propiedades)
        const u = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const author = u.username || u.name || u.nombre || u.fullName || u?.usuario?.name || u?.usuario?.nombre || u?.usuario?.username || 'Usuario';
        console.log('[NOTA] Autor detectado:', author, 'User object:', u);
        
        // Subir archivos adjuntos a GridFS si hay
        let uploadedAttachments = [];
        if (hasAttachments) {
          console.log('[NOTA] Subiendo archivos a GridFS...');
          uploadedAttachments = await uploadAttachmentsToGridFS(leadId);
          console.log('[NOTA] Archivos subidos:', uploadedAttachments.length);
        }
        
        // Crear nota con archivos adjuntos (URLs de GridFS)
        const newNote = { 
          text: text || '(Archivo adjunto)', 
          author, 
          at: new Date().toISOString(),
          attachments: uploadedAttachments
        };

        // Obtener notas existentes y agregar la nueva al principio
        const current = (window.__currentEditingLead && (window.__currentEditingLead.notas || window.__currentEditingLead.notes)) || [];
        const notas = Array.isArray(current) ? [newNote, ...current] : [newNote];

        // Limpiar textarea
        if (textarea) textarea.value = '';

        // Guardar en backend usando PUT
        let ok = false; let lastTxt = '';
        if (leadId) {
          try {
            console.log('[NOTA] Guardando nota para lead:', leadId, 'notas:', notas);
            let putRes;
            try {
              const hint = String(window.__currentEditingLead?._collectionName || '').trim();
              const hintQ = hint ? `?collection=${encodeURIComponent(hint)}` : '';
              putRes = await timedFetch(`/api/leads/${encodeURIComponent(leadId)}${hintQ}`, {
                method: 'PUT',
                credentials: 'include',
                headers: { 
                  'Content-Type': 'application/json', 
                  'Authorization': token ? `Bearer ${token}` : '' 
                },
                body: JSON.stringify({ notas })
              }, 20000);
            } catch (e) {
              console.error('[NOTA] Error al guardar nota (fetch):', e);
              if (e && e.message === 'timeout') {
                alert('âŒ El servidor no respondiÃ³ a tiempo al guardar la nota (timeout). Intenta de nuevo.');
              } else {
                alert('âŒ No se pudo conectar al servidor al guardar la nota. Verifica que el servidor estÃ© levantado.');
              }
              return;
            }
            console.log('[NOTA] Respuesta:', putRes.status, putRes.statusText);
            if (putRes && putRes.ok) { 
              ok = true; 
              // Actualizar el objeto en memoria
              if (window.__currentEditingLead) {
                window.__currentEditingLead.notas = notas;
              }
              // Actualizar UI con todas las notas (para Ã­ndices correctos)
              if (list) {
                list.innerHTML = '';
                notas.forEach((n, idx) => list.appendChild(createNoteCard(n, idx)));
              }
              // Limpiar archivos adjuntos
              clearNoteAttachments();
              console.log('[NOTA] Nota guardada exitosamente');
              // NotificaciÃ³n de Windows
              const clientName = window.__currentEditingLead?.nombre_cliente || window.__currentEditingLead?.nombre || 'Cliente';
              window.NotificationSystem?.notifyNoteAdded(clientName, author);
            } else {
              try { lastTxt = await putRes.text(); } catch(_) {}
              console.error('[NOTA] Error al guardar:', lastTxt);
            }
          } catch(e) { 
            lastTxt = e?.message || String(e); 
            console.error('[NOTA] ExcepciÃ³n:', e);
          }
        }

        if (!ok && leadId) {
          console.error('[NOTA] No se pudo persistir la nota:', lastTxt);
          alert('No se pudo persistir la nota: ' + (lastTxt || 'Error desconocido'));
        }
      } catch (e) {
        console.error('Error en agregarNotaCliente:', e);
        alert('Error al agregar la nota: ' + (e?.message || e));
      }
    };

    // Función para refrescar notas desde el servidor
    window.refrescarNotasLead = async function() {
      try {
        const leadId = (() => {
          const raw = String(document.getElementById('edit-id')?.value || '').trim();
          if (raw && raw !== '[object Object]' && /^[a-fA-F0-9]{24}$/.test(raw)) return raw;
          const cur = window.__currentEditingLead || {};
          const candidates = [cur?._id?.$oid, cur?._id, cur?.id, cur?.leadId, cur?.leadID];
          for (const c of candidates) {
            const s = String((c && c.$oid) ? c.$oid : c || '').trim();
            if (s && s !== '[object Object]' && /^[a-fA-F0-9]{24}$/.test(s)) return s;
          }
          return raw;
        })();
        if (!leadId) {
          alert('No hay lead abierto');
          return;
        }
        
        console.log('[RefrescarNotas] Recargando notas para lead:', leadId);
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const res = await fetch(`/api/leads/${encodeURIComponent(leadId)}`, {
          credentials: 'include',
          headers: token ? { 'Authorization': `Bearer ${token}` } : {}
        });
        
        if (!res.ok) {
          throw new Error('Error al obtener datos: ' + res.status);
        }
        
        const data = await res.json();
        const freshLead = data.data || data.lead || data;
        
        // Actualizar notas en la UI
        const list = document.getElementById('edit-notes-list');
        if (list && freshLead) {
          list.innerHTML = '';
          let notas = Array.isArray(freshLead.notas) ? freshLead.notas
            : Array.isArray(freshLead.notes) ? freshLead.notes
            : [];
          
          // Ordenar por fecha descendente
          notas = notas.slice().sort((a, b) => {
            const dateA = new Date(a.at || a.fecha || a.createdAt || 0);
            const dateB = new Date(b.at || b.fecha || b.createdAt || 0);
            return dateB - dateA;
          });
          
          if (notas.length) {
            notas.forEach((n, idx) => {
              const div = createNoteCard(n, idx);
              list.appendChild(div);
            });
            console.log('[RefrescarNotas] Notas actualizadas:', notas.length);
          } else {
            list.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Sin notas</p>';
          }
          
          // Actualizar lead actual en memoria
          if (window.__currentEditingLead) {
            window.__currentEditingLead.notas = notas;
          }
        }
        
      } catch (e) {
        console.error('[RefrescarNotas] Error:', e);
      }
    };

    // Función para cerrar el modal de ediciÃ³n
    window.cerrarModalEdicion = function() {
      const modal = document.getElementById('editarModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // Función para abrir imagen en modal grande
    window.abrirImagenModal = function(imageUrl) {
      let modal = document.getElementById('imagenGrandeModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'imagenGrandeModal';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: pointer;';
        modal.innerHTML = `
          <div style="position: relative; max-width: 90%; max-height: 90%;">
            <img id="imagenGrandeImg" src="" style="max-width: 100%; max-height: 90vh; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);" />
            <button onclick="cerrarImagenModal()" style="position: absolute; top: -15px; right: -15px; width: 40px; height: 40px; border-radius: 50%; border: none; background: #ef4444; color: white; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
              <i class="fas fa-times"></i>
            </button>
            <a id="imagenGrandeDownload" href="" download style="position: absolute; bottom: -50px; left: 50%; transform: translateX(-50%); background: #3b82f6; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-download"></i> Descargar
            </a>
          </div>
        `;
        modal.addEventListener('click', function(e) {
          if (e.target === modal) cerrarImagenModal();
        });
        document.body.appendChild(modal);
      }

      const img = document.getElementById('imagenGrandeImg');
      const downloadBtn = document.getElementById('imagenGrandeDownload');
      if (img) img.src = imageUrl;
      if (downloadBtn) downloadBtn.href = imageUrl + '/download';
      modal.style.display = 'flex';
    };

    // Función para cerrar modal de imagen
    window.cerrarImagenModal = function() {
      const modal = document.getElementById('imagenGrandeModal');
      if (modal) modal.style.display = 'none';
    };

    // Función para guardar los cambios
    // Helper: fetch con timeout usando AbortController
    async function timedFetch(url, opts = {}, timeout = 10000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const merged = Object.assign({}, opts, { signal: controller.signal });
        const res = await fetch(url, merged);
        clearTimeout(id);
        return res;
      } catch (err) {
        clearTimeout(id);
        if (err && err.name === 'AbortError') throw new Error('timeout');
        throw err;
      }
    }

    // Comprueba rÃ¡pidamente si el servidor responde (intenta /api/health, luego /api/leads)
    async function checkServerAlive(timeout = 3000) {
      try {
        // Preferir endpoint de health si existe
        const health = await timedFetch('/api/health', { method: 'GET', credentials: 'include' }, timeout);
        if (health && health.ok) return true;
      } catch (e) {
        // ignorar
      }
      try {
        const r = await timedFetch('/api/leads?page=1&limit=1', { method: 'GET', credentials: 'include' }, timeout);
        if (r && r.ok) return true;
      } catch (e) {
        // ignorar
      }
      return false;
    }

    window.guardarCambiosLead = async function() {
      // Si el servidor no responde rÃ¡pido, informar y abortar para evitar duplicados
      try {
        const alive = await checkServerAlive(3000);
        if (!alive) {
          alert('âŒ El servidor no está disponible (conexiÃ³n rechazada o muy lenta). Intenta arrancar el servidor y reintenta.');
          try { window.__savingLead = false; } catch(_){}
          return;
        }
      } catch (e) {
        console.debug('[guardarCambiosLead] checkServerAlive fallÃ³:', e);
      }
      const leadIdRaw = document.getElementById('edit-id').value;

      const isFull = typeof canFullEdit==='function' ? canFullEdit() : false;
      // PrevenciÃ³n de doble envÃ­o: bandera global + deshabilitar botÃ³n de guardar
      if (window.__savingLead) {
        console.warn('[guardarCambiosLead] Guardado ya en progreso, ignorando segundo intento');
        return;
      }
      const modalEl = document.getElementById('editarModal');
      const saveBtnEl = modalEl ? (modalEl.querySelector('.edit-actions button:last-of-type') || null) : null;
      const setSaving = (v) => { try { window.__savingLead = !!v; if (saveBtnEl) saveBtnEl.disabled = !!v; } catch(e){} };
      setSaving(true);
      const curLead = window.__currentEditingLead || {};
      const leadId = (() => {
        const rawStr = String(leadIdRaw || '').trim();
        if (rawStr && rawStr !== '[object Object]') return rawStr;
        try {
          const extracted = (typeof extractLeadId === 'function') ? extractLeadId(curLead) : '';
          return String(extracted || '').trim();
        } catch (_) {
          return '';
        }
      })();

      // Si el id es invÃ¡lido, intentar guardar como nuevo lead (POST)
      const isValidId = leadId && /^[a-fA-F0-9]{24}$/.test(String(leadId).trim());
      if (!isValidId) {
        setSaving(false);
        alert('âŒ Error: el registro en ediciÃ³n no tiene un ID vÃ¡lido. Para evitar sobrescrituras/duplicados, no se guardarÃ¡. Reabre el modal desde la fila correcta.');
        return;
      }

      const getInput = (id) => {
        try {
          const el = document.getElementById(id);
          const v = el ? el.value : '';
          return (v == null) ? '' : String(v).trim();
        } catch (_) {
          return '';
        }
      };
      const getFromLead = (...keys) => {
        for (const k of keys) {
          const v = curLead && curLead[k];
          if (v !== undefined && v !== null) {
            const s = String(v).trim();
            if (s) return s;
          }
        }
        return '';
      };

      let datosActualizados = {};
      if (isFull) {
        const nombreCompleto = [
          getInput('edit-nombres'),
          getInput('edit-apellidos')
        ].filter(Boolean).join(' ');
        const tipoServiciosVal = (
          (document.getElementById('edit-tipo-servicios') && document.getElementById('edit-tipo-servicios').value)
          || (window.__currentEditingLead && (window.__currentEditingLead.tipo_servicios || window.__currentEditingLead.tipo_servicio))
          || ''
        ).toString().trim();
        const serviciosVal = (
          (document.getElementById('edit-servicios') && document.getElementById('edit-servicios').value)
          || (window.__currentEditingLead && (window.__currentEditingLead.servicios || window.__currentEditingLead.servicios_texto))
          || ''
        ).toString().trim();
        const telefonoPrincipal = getInput('edit-telefono') || getFromLead('telefono_principal', 'telefono', 'phone', 'tel');
        const direccion = getInput('edit-direccion') || getFromLead('direccion', 'address', 'domicilio');
        const nombreCliente = nombreCompleto || getFromLead('nombre_cliente', 'nombre', 'name', 'cliente');

        datosActualizados = {
          nombre_cliente: nombreCliente,
          telefono_principal: telefonoPrincipal,
          telefono_alterno: getInput('edit-telefono-alt') || getFromLead('telefono_alterno', 'telefono_secundario', 'phone2', 'tel2'),
          numero_cuenta: document.getElementById('edit-numero-cuenta').value,
          autopago: document.getElementById('edit-autopago').value,
          direccion: direccion,
          representante: document.getElementById('edit-representante').value,
          servicios: serviciosVal,
          servicios_texto: serviciosVal,
          tipo_servicio: tipoServiciosVal,
          tipo_servicios: tipoServiciosVal,
          sistema: document.getElementById('edit-sistema').value,
          riesgo: (document.getElementById('edit-riesgo').value||'').toString().toLowerCase(),
          dia_venta: document.getElementById('edit-dia-venta').value,
          dia_instalacion: document.getElementById('edit-dia-instalacion').value,
          status: document.getElementById('edit-status').value,
          mercado: document.getElementById('edit-mercado').value,
          supervisor: document.getElementById('edit-supervisor').value,
          comentario: document.getElementById('edit-comentario').value,
          motivo_llamada: document.getElementById('edit-motivo-llamada').value,
          zip_code: document.getElementById('edit-zip-code').value,
          zip: document.getElementById('edit-zip-code').value,
          puntaje: parseFloat(document.getElementById('edit-puntaje').value) || 0
        };
      } else {
        datosActualizados = {
          dia_venta: document.getElementById('edit-dia-venta').value,
          dia_instalacion: document.getElementById('edit-dia-instalacion').value,
          nombre_cliente: getFromLead('nombre_cliente', 'nombre', 'name', 'cliente'),
          telefono_principal: getFromLead('telefono_principal', 'telefono', 'phone', 'tel'),
          direccion: getFromLead('direccion', 'address', 'domicilio'),
          supervisor: getInput('edit-supervisor') || getFromLead('supervisor', 'SUPERVISOR', 'team', 'Team'),
          motivo_llamada: getInput('edit-motivo-llamada') || getFromLead('motivo_llamada', 'motivo', 'call_reason', 'reason'),
          comentario: getInput('edit-comentario') || getFromLead('comentario', 'comment', 'comentarios'),
          servicios: getFromLead('tipo_servicio', 'tipo_servicios', 'servicios', 'servicios_texto'),
          tipo_servicio: getFromLead('tipo_servicio', 'tipo_servicios', 'servicios', 'servicios_texto'),
          tipo_servicios: getFromLead('tipo_servicio', 'tipo_servicios', 'servicios', 'servicios_texto')
        };
      }

      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const uurl = `/api/leads/${encodeURIComponent(leadId)}`;
        console.debug('[guardarCambiosLead] Verificando existencia antes de PUT:', uurl, { datosActualizados });
        // Comprobar si el lead existe para evitar PUT que devuelvan 404
        let existCheck = null;
        let existCheckTimedOut = false;
        try {
          existCheck = await timedFetch(uurl, { method: 'GET', credentials: 'include', headers: (token ? { 'Authorization': `Bearer ${token}` } : {}) }, 15000);
        } catch (e) {
          if (e && e.message === 'timeout') {
            console.warn('[guardarCambiosLead] Existence check timed out, will try prolonged PUT');
            existCheckTimedOut = true;
          }
          existCheck = null;
        }

        let resp;
        if (existCheck && existCheck.ok) {
          console.debug('[guardarCambiosLead] Lead existe, realizando PUT:', uurl);
          console.debug('[guardarCambiosLead] Enviando PUT:', uurl, { datosActualizados });
          resp = await timedFetch(uurl, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) },
            credentials: 'include',
            body: JSON.stringify(datosActualizados)
          }, 15000);
        } else {
          // Si la comprobaciÃ³n de existencia expirÃ³, intentaremos un PUT prolongado (no asumimos inexistencia)
          if (existCheck === null) {
            existCheckTimedOut = true;
            console.warn('[guardarCambiosLead] Existence check no respondiÃ³ a tiempo, intentando PUT prolongado');
            try {
              resp = await timedFetch(uurl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) },
                credentials: 'include',
                body: JSON.stringify(datosActualizados)
              }, 30000);
            } catch (e) {
              console.error('[guardarCambiosLead] PUT prolongado fallÃ³:', e);
              if (e && e.message === 'timeout') {
                throw new Error('El servidor tardÃ³ demasiado intentando actualizar el lead. Reintenta.');
              }
              throw e;
            }
          } else {
            // Simular respuesta 404 para reutilizar la lÃ³gica de fallback sin hacer PUT
            resp = { ok: false, status: 404, statusText: 'Not Found', text: async () => JSON.stringify({ success: false, message: 'Lead no encontrado' }) };
          }
        }

        if (!resp.ok) {
          let lastErrTxt = '';
          try { lastErrTxt = await resp.text(); } catch(_) {}
          console.error('[guardarCambiosLead] PUT no OK', { url: uurl, status: resp.status, statusText: resp.statusText, body: lastErrTxt, payload: datosActualizados });

          // Si el lead no existe (404), intentar crear uno nuevo con POST
          if (resp.status === 404) {
            // Intentar encontrar un lead existente por campos clave para evitar duplicados
            try {
              const cur = window.__currentEditingLead || {};
              const digitsOnly = (s) => String(s||'').replace(/\D+/g, '').trim();
              const toISODate = (s) => {
                try {
                  if (!s) return '';
                  const d = (s instanceof Date) ? s : new Date(s);
                  if (isNaN(d)) return String(s).slice(0,10);
                  return d.toISOString().slice(0,10);
                } catch { return String(s).slice(0,10); }
              };

              const vals = {
                nombre_cliente: String(datosActualizados.nombre_cliente || cur.nombre_cliente || cur.nombre || cur.name || '').trim(),
                telefono_principal: String(datosActualizados.telefono_principal || datosActualizados.telefono || cur.telefono_principal || cur.telefono || cur.phone || '').trim(),
                telefono_digits: digitsOnly(datosActualizados.telefono_principal || datosActualizados.telefono || cur.telefono_principal || cur.telefono || cur.phone),
                direccion: String(datosActualizados.direccion || cur.direccion || cur.address || '').trim()
              };

              const fetchOptsBase = { method: 'GET', credentials: 'include', headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) } };
              const normalizeId = (v) => {
                if (!v) return '';
                if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
                const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
              };

              const tryQueries = [];
              // Solo campos permitidos: nombre_cliente, telefono_principal, direccion
              if (vals.telefono_digits && vals.nombre_cliente && vals.direccion) {
                tryQueries.push({ q: `telefono_principal=${encodeURIComponent(vals.telefono_digits)}&nombre_cliente=${encodeURIComponent(vals.nombre_cliente)}&direccion=${encodeURIComponent(vals.direccion)}`, reason: 'tel+nombre+direccion' });
              }
              if (vals.telefono_digits && vals.nombre_cliente) {
                tryQueries.push({ q: `telefono_principal=${encodeURIComponent(vals.telefono_digits)}&nombre_cliente=${encodeURIComponent(vals.nombre_cliente)}`, reason: 'tel+nombre' });
              }
              if (vals.telefono_digits && vals.direccion) {
                tryQueries.push({ q: `telefono_principal=${encodeURIComponent(vals.telefono_digits)}&direccion=${encodeURIComponent(vals.direccion)}`, reason: 'tel+direccion' });
              }
              if (vals.telefono_principal) {
                tryQueries.push({ q: `telefono_principal=${encodeURIComponent(vals.telefono_principal)}`, reason: 'telefono_raw' });
              }
              if (vals.nombre_cliente) {
                tryQueries.push({ q: `nombre_cliente=${encodeURIComponent(vals.nombre_cliente)}`, reason: 'nombre_only' });
              }
              if (vals.direccion) {
                tryQueries.push({ q: `direccion=${encodeURIComponent(vals.direccion)}`, reason: 'direccion_only' });
              }

              let found = null;
              for (const item of tryQueries) {
                try {
                  const url = `/api/leads?page=1&limit=10&${item.q}`;
                  console.debug('[guardarCambiosLead] intentando bÃºsqueda:', item.reason, url, { vals });
                  const r = await timedFetch(url, fetchOptsBase, 10000);
                  if (!r.ok) { console.debug('[guardarCambiosLead] bÃºsqueda HTTP no OK', r.status, url); continue; }
                  const text = await r.text();
                  let data;
                  try { data = JSON.parse(text); } catch(_) { data = text; }
                  const leads = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
                  console.debug('[guardarCambiosLead] resultados bÃºsqueda', item.reason, 'count=', (leads && leads.length) || 0, { rawResponse: data });
                  if (leads && leads.length) {
                    const candidateId = normalizeId(leads[0]._id) || normalizeId(leads[0].id) || normalizeId(leads[0].leadId) || '';
                    if (candidateId) { found = { id: candidateId, lead: leads[0], reason: item.reason }; break; }
                  }
                } catch (e) {
                  if (e && e.message === 'timeout') throw new Error('El servidor tardÃ³ demasiado realizando bÃºsquedas. Reintenta.');
                  console.debug('[guardarCambiosLead] error en bÃºsqueda:', e);
                }
              }

              if (found && found.id) {
                // Actualizar el lead encontrado
                try {
                  const originalId = String(leadId || '').trim();
                  const foundId = String(found.id || '').trim();
                  const strongReasons = ['tel+nombre+direccion'];
                  const isStrong = strongReasons.includes(String(found.reason || '').trim());
                  const idMismatch = originalId && foundId && originalId !== foundId;

                  // Si el fallback encuentra otro ID, NO permitir actualizar (evita sobrescritura)
                  if (idMismatch) {
                    alert(
                      `âŒ Seguridad: se detectÃ³ un ID diferente al del registro en ediciÃ³n.\n\n` +
                      `ID en ediciÃ³n: ${originalId || '(vacÃ­o)'}\n` +
                      `ID encontrado: ${foundId || '(vacÃ­o)'}\n\n` +
                      `No se actualizarÃ¡ para evitar sobrescritura.`
                    );
                    throw new Error('ID encontrado distinto al ID en ediciÃ³n. Abortando para evitar sobrescritura.');
                  }

                  // Si no es match fuerte, pedir confirmaciÃ³n explÃ­cita
                  if (!isStrong) {
                    const msg = [
                      'Se encontró un registro similar para actualizar.',
                      '',
                      `ID en ediciÃ³n: ${originalId || '(vacÃ­o)'}`,
                      `ID encontrado: ${foundId || '(vacÃ­o)'}`,
                      `Criterio: ${String(found.reason || '')}`,
                      '',
                      'Aceptar = actualizar el registro encontrado',
                      'Cancelar = NO actualizar (para evitar sobrescritura)'
                    ].join('\n');
                    const ok = confirm(msg);
                    if (!ok) {
                      throw new Error('Guardado cancelado para evitar sobrescribir otro lead.');
                    }
                  }
                } catch (e) {
                  // Si el usuario cancela o hay error, detener el flujo
                  throw e;
                }
                const putUrl = `/api/leads/${encodeURIComponent(found.id)}`;
                console.debug('[guardarCambiosLead] Actualizando lead encontrado via PUT:', putUrl, { datosActualizados, foundReason: found.reason });
                const putResp = await timedFetch(putUrl, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) },
                  credentials: 'include',
                  body: JSON.stringify(datosActualizados)
                }, 15000);
                if (!putResp.ok) {
                  let t = '';
                  try { t = await putResp.text(); } catch(_){ }
                  console.error('[guardarCambiosLead] PUT sobre found.id fallÃ³', { putUrl, status: putResp.status, body: t });
                  throw new Error('Error al actualizar lead encontrado: ' + (t || putResp.status));
                }
                alert('âœ… Registro actualizado exitosamente (coincidencia encontrada)');
                cerrarModalEdicion();
                location.reload();
                return;
              }

              // Antes de crear, hacer una Ãºltima bÃºsqueda combinada (telÃ©fono + cuenta + fecha)
              try {
                const combParams = [];
                if (vals.telefono_digits) combParams.push(`telefono_principal=${encodeURIComponent(vals.telefono_digits)}`);
                if (vals.nombre_cliente) combParams.push(`nombre_cliente=${encodeURIComponent(vals.nombre_cliente)}`);
                if (vals.direccion) combParams.push(`direccion=${encodeURIComponent(vals.direccion)}`);
                const combQuery = combParams.join('&');
                if (combQuery) {
                  const combUrl = `/api/leads?page=1&limit=10&${combQuery}`;
                  console.debug('[guardarCambiosLead] Ãºltima bÃºsqueda combinada antes de POST:', combUrl);
                  const combRes = await timedFetch(combUrl, fetchOptsBase, 10000);
                  if (combRes && combRes.ok) {
                    const combText = await combRes.text();
                    let combData; try { combData = JSON.parse(combText); } catch(_) { combData = combText; }
                    const combLeads = Array.isArray(combData) ? combData : (Array.isArray(combData?.data) ? combData.data : []);
                    if (combLeads && combLeads.length) {
                      // Mostrar confirmaciÃ³n al usuario con resumen de coincidencias
                      const summary = combLeads.slice(0,5).map(l => {
                        const n = (l.nombre_cliente || l.name || l.nombre || l.cliente) || '';
                        const p = (l.telefono_principal || l.telefono || l.phone) || '';
                        const a = (l.numero_cuenta || l.account || l.numeroCuenta) || '';
                        const d = (l.dia_venta || l.fecha || l.fecha_venta) || '';
                        return `ID:${normalizeId(l._id||l.id||l.leadId)} | ${n} | ${p} | ${a} | ${d}`;
                      }).join('\n');
                      const ok = confirm(`Se encontraron ${combLeads.length} registros similares:\n\n${summary}\n\nÂ¿Deseas actualizar la primera coincidencia en lugar de crear un nuevo lead? (Aceptar = actualizar)`);
                      if (ok) {
                        const target = combLeads[0];
                        const targetId = normalizeId(target._id) || normalizeId(target.id) || normalizeId(target.leadId) || '';
                        if (targetId) {
                          console.debug('[guardarCambiosLead] Usuario eligiÃ³ actualizar coincidencia:', targetId);
                          const putUrl2 = `/api/leads/${encodeURIComponent(targetId)}`;
                          const putResp2 = await timedFetch(putUrl2, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) },
                            credentials: 'include',
                            body: JSON.stringify(datosActualizados)
                          }, 15000);
                          let put2txt = '';
                          try { put2txt = await putResp2.text(); } catch(_){}
                          if (!putResp2.ok) {
                            console.error('[guardarCambiosLead] PUT sobre coincidencia fallÃ³', { putUrl2, status: putResp2.status, body: put2txt });
                            throw new Error('Error al actualizar la coincidencia: ' + (put2txt || putResp2.status));
                          }
                          alert('âœ… Registro actualizado exitosamente (coincidencia)');
                          cerrarModalEdicion();
                          location.reload();
                          return;
                        }
                      }
                    }
                  }
                }
              } catch (e) {
                if (e && e.message && e.message.toLowerCase().includes('timeout')) {
                  throw new Error('El servidor tardÃ³ demasiado en la bÃºsqueda final. Reintenta.');
                }
                console.debug('[guardarCambiosLead] error en bÃºsqueda combinada pre-POST:', e);
                // Si falla la bÃºsqueda combinada por otra razÃ³n, continuar al POST para no bloquear al usuario
              }

              // Si no se eligiÃ³ actualizar una coincidencia, proceder a crear
              console.debug('[guardarCambiosLead] Creando nuevo lead via POST /api/leads', { datosActualizados });
              const postResp = await timedFetch('/api/leads', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) },
                credentials: 'include',
                body: JSON.stringify(datosActualizados)
              }, 15000);
              let postTxt = '';
              try { postTxt = await postResp.text(); } catch(_) {}
              console.debug('[guardarCambiosLead] POST response', { status: postResp.status, body: postTxt });
              if (!postResp.ok) {
                throw new Error('Error al crear el registro: ' + (postTxt || postResp.status));
              }
              alert('âœ… Registro creado exitosamente');
              cerrarModalEdicion();
              location.reload();
              return;
            } catch (e) {
              let msg = 'Error tratando 404: ';
              if (e && e.message) msg += e.message; else msg += String(e);
              throw new Error(msg);
            }
          }

          let msg = 'Error al actualizar el registro';
          if (lastErrTxt) msg += ': ' + lastErrTxt;
          throw new Error(msg);
        }

        alert('âœ… Registro actualizado exitosamente');
        cerrarModalEdicion();

        location.reload();
        return;
      } catch (error) {
        console.error('Error al guardar cambios:', error);
        alert('âŒ Error al actualizar el registro: ' + error.message);
      } finally {
        setSaving(false);
      }
    };
  </script>
  
  <!-- Cargar primero el mÃ³dulo de datos de clientes -->
  <!-- <script src="js/data/costumer-mock-data.js"></script> -->
  <script>
    // Función para mostrar mensajes de depuraciÃ³n
    function debugLog(message, data) {
      if (data !== undefined) {
        console.log(`[DEBUG] ${message}`, data);
      } else {
        console.log(`[DEBUG] ${message}`);
      }
    }

    // Logs de diagnÂ¨Â®stico: conteo por TEAM y por agente (incluye "Sin asignar (TEAM IRANIA)")
    function logDiagnosticoAsignacion(leads) {
      try {
        const norm = (s) => {
          try {
            return String(s || '')
              .toLowerCase()
              .normalize('NFD')
              .replace(/\p{Diacritic}/gu, '')
              .trim();
          } catch { return ''; }
        };

        const getTeam = (l) => {
          const t = l?.supervisor || l?.team || l?.Team || l?.equipo || l?._raw?.supervisor || l?._raw?.team || l?._raw?.equipo || '';
          return t ? t.toString().trim() : '';
        };
        const getAgentSimple = (l) => {
          const cand = [
            l?.agenteNombre,
            l?.nombreAgente,
            l?.agente,
            l?.agent,
            l?._raw?.agenteNombre,
            l?._raw?.nombreAgente,
            l?._raw?.agente,
            l?._raw?.agent
          ];
          const v = cand.find(x => x && String(x).trim().length);
          return v ? String(v).trim() : '';
        };

        const perTeam = new Map(); // team -> Map(agentLabel -> count)
        for (const l of Array.isArray(leads) ? leads : []) {
          const team = getTeam(l);
          const teamKey = team || '(Sin TEAM)';
          const teamMap = perTeam.get(teamKey) || new Map();
          let agent = getAgentSimple(l);
          // Marcar sin asignar para TEAM IRANIA
          if (!agent) {
            const tnorm = norm(team);
            if (tnorm.includes('team irania')) agent = 'Sin asignar (TEAM IRANIA)';
            else agent = '(Sin agente)';
          }
          teamMap.set(agent, (teamMap.get(agent) || 0) + 1);
          perTeam.set(teamKey, teamMap);
        }

        // Log general
        const resumen = {};
        for (const [team, m] of perTeam.entries()) {
          resumen[team] = Object.fromEntries([...m.entries()].sort((a,b) => b[1]-a[1]));
        }
        console.log('[DIAGN?STICO ASIGNACI?N] Conteo por TEAM y agente:', resumen);

        // Log especÂ¨Âªfico TEAM IRANIA
        const keyIrania = [...perTeam.keys()].find(k => norm(k).includes('team irania'));
        if (keyIrania) {
          console.log(`[AGRUPACI?N TEAM IRANIA] Conteo por agente:`, Object.fromEntries(perTeam.get(keyIrania).entries()));
        }
      } catch (e) {
        console.warn('logDiagnosticoAsignacion: error al generar diagnÂ¨Â®stico', e);
      }
    }

    // Helpers para UI de comentarios
    function escapeHtml(s) {
      try {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      } catch { return ''; }
    }

    function normalizarTexto(s) {
      try {
        return String(s || '')
          .toLowerCase()
          .normalize('NFD')
          .replace(/\p{Diacritic}/gu, '')
          .trim();
      } catch { return ''; }
    }

    function obtenerIniciales(nombre) {
      const n = String(nombre || '').trim();
      if (!n) return '?';
      const parts = n.split(/\s+/);
      const first = parts[0]?.[0] || '';
      const last = parts.length > 1 ? parts[parts.length - 1]?.[0] : '';
      return (first + last).toUpperCase();
    }

    function obtenerUsuarioActual() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        return user.name || user.nombre || user.email || user.username || 'Yo';
      } catch {
        return 'Yo';
      }
    }

    // FunciÂ¨Â®n para inicializar la pÂ¨Â¢gina
    function initPage() {
      debugLog('Inicializando pÂ¨Â¢gina...');
      cargarInfoUsuario();
    }
    // FunciÂ¨Â®n para cargar la informaciÂ¨Â®n del usuario
    function cargarInfoUsuario() {
      debugLog('Iniciando cargarInfoUsuario');
      
      try {
        // Datos de usuario de ejemplo
        const userData = {
          name: 'Usuario Demo',
          role: 'admin',
          email: 'demo@example.com'
        };
        
        debugLog('Datos de usuario a mostrar:', userData);
        
        // Actualizar la interfaz con los datos del usuario
        if (userData.name) {
          const userNameElement = document.getElementById('sidebar-user-name');
          debugLog('Elemento de nombre de usuario encontrado:', !!userNameElement);
          if (userNameElement) {
            debugLog('Actualizando nombre de usuario a:', userData.name);
            userNameElement.textContent = userData.name;
            userNameElement.style.color = '#2d3748'; // Asegurar que el color sea visible
            debugLog('Nombre de usuario actualizado correctamente');
          } else {
            debugLog('No se encontrÂ¨Â® el elemento sidebar-user-name');
          }
        }
        
        if (userData.role) {
          const userRoleElement = document.getElementById('sidebar-user-role');
          debugLog('Elemento de rol de usuario encontrado:', !!userRoleElement);
          if (userRoleElement) {
            // Formatear el rol para mostrarlo mejor
            const roleNames = {
              'admin': 'Administrador',
              'supervisor': 'Supervisor',
              'agent': 'Agente'
            };
            const rolMostrado = roleNames[userData.role] || userData.role;
            debugLog('Actualizando rol de usuario a:', rolMostrado);
            userRoleElement.textContent = rolMostrado;
            userRoleElement.style.display = 'inline-block'; // Asegurar que sea visible
            debugLog('Rol de usuario actualizado correctamente');
          } else {
            debugLog('No se encontrÂ¨Â® el elemento sidebar-user-role');
          }
        }
      } catch (error) {
        console.error('Error en cargarInfoUsuario:', error);
      }
    }

    // Configurar botÃ³n de cerrar sesiÃ³n y cargar info del usuario
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('DOM completamente cargado, inicializando pÃ¡gina...');
      // Inicializar la pÃ¡gina
      initPage();
      
      // Función para habilitar debug del filtro (usar en consola: enableMonthFilterDebug())
      window.enableMonthFilterDebug = function() {
        window.__debugMonthFilter = true;
        console.log('[MonthFilter] Debug habilitado');
      };
      
      // Debug habilitado para diagnosticar problema de datos incompletos
      window.__debugMonthFilter = true;
      
      // Función para poblar filtros de Team y Agente
      window.populateTeamAndAgentFilters = async function(leads) {
        try {
          if (!Array.isArray(leads)) return;

          const authHeaders = () => {
            const h = { 'Accept': 'application/json' };
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (token) h['Authorization'] = `Bearer ${token}`;
            return h;
          };

          const normKey = (v) => {
            try {
              return String(v || '')
                .trim()
                .toLowerCase()
                .normalize('NFD')
                .replace(/\p{Diacritic}/gu, '')
                .replace(/[._-]+/g, ' ')
                .replace(/\s+/g, ' ');
            } catch (_) {
              return String(v || '').trim().toLowerCase().replace(/[._-]+/g, ' ').replace(/\s+/g, ' ');
            }
          };

          const toDisplayName = (raw) => {
            const s = String(raw || '').trim();
            if (!s) return '';
            const cleaned = s.replace(/[._-]+/g, ' ').replace(/\s+/g, ' ').trim();
            if (/\s/.test(cleaned)) return cleaned;
            return cleaned;
          };
          
          // IMPORTANTE: Filtrar leads por mes seleccionado ANTES de poblar los filtros
          let filteredLeads = leads;
          const monthFilter = document.getElementById('monthFilter');
          const selectedMonth = monthFilter ? monthFilter.value : '';
          
          if (selectedMonth) {
            filteredLeads = leads.filter(lead => {
              const iso = getDateFromLead(lead); // 'YYYY-MM-DD'
              if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return false;
              const ym = iso.slice(0,7); // 'YYYY-MM'
              return ym === selectedMonth;
            });
            console.log('[Filtros] Poblando con datos filtrados por mes:', selectedMonth, 'Total:', filteredLeads.length, 'de', leads.length);
            
            // Debug especÃ­fico para Evelin Garcia
            const evelinLeads = filteredLeads.filter(lead => {
              const allFields = [
                lead?.team, lead?.equipo, lead?.supervisor,
                lead?.agente, lead?.agenteNombre, lead?.nombreAgente, lead?.agent,
                lead?.nombre, lead?.name, lead?.cliente
              ].join(' ').toLowerCase();
              return allFields.includes('evelin');
            });
            console.log('[DEBUG EVELIN] Leads de Evelin en', selectedMonth + ':', evelinLeads.length);
            if (evelinLeads.length > 0) {
              console.log('[DEBUG EVELIN] Primeros 3 leads:', evelinLeads.slice(0, 3));
            }
          } else {
            console.log('[Filtros] Poblando con todos los datos:', leads.length);
          }
          
          // Extraer teams y agentes de los datos filtrados
          const teamsSet = new Set();
          const agentsMap = new Map(); // team -> Set(agents)
          const allAgentsSet = new Set();
          
          filteredLeads.forEach((lead, index) => {
            // Extraer team
            const team = lead?.team || lead?.equipo || lead?.supervisor || '';
            if (team && String(team).trim()) {
              const teamNorm = String(team).trim();
              teamsSet.add(teamNorm);
              
              if (!agentsMap.has(teamNorm)) {
                agentsMap.set(teamNorm, new Set());
              }
            }
            
            // Extraer agente
            const agent = lead?.agente || lead?.agenteNombre || lead?.nombreAgente || lead?.agent || '';
            if (agent && String(agent).trim()) {
              const agentNorm = String(agent).trim();
              allAgentsSet.add(agentNorm);
              
              // Asociar agente con team si existe
              if (team && String(team).trim()) {
                const teamNorm = String(team).trim();
                if (agentsMap.has(teamNorm)) {
                  agentsMap.get(teamNorm).add(agentNorm);
                }
              }
            }
            
            // Debug para los primeros 3 items para ver la estructura de datos
            if (index < 3 && window.__debugMonthFilter) {
              console.log('[Filtros Debug] Lead sample:', {
                index: index,
                team: lead?.team,
                equipo: lead?.equipo,
                supervisor: lead?.supervisor,
                agente: lead?.agente,
                agenteNombre: lead?.agenteNombre,
                nombreAgente: lead?.nombreAgente,
                agent: lead?.agent,
                dia_venta: lead?.dia_venta,
                fecha: lead?.fecha
              });
            }
          });
          
          // Poblar filtro de teams
          const teamFilter = document.getElementById('teamFilter');
          if (teamFilter) {
            // Limpiar opciones existentes excepto la primera
            while (teamFilter.children.length > 1) {
              teamFilter.removeChild(teamFilter.lastChild);
            }
            
            // Agregar teams ordenados
            const allTeams = Array.from(teamsSet).sort();
            // Asegurar que "Oficina" estÃ© presente y al principio
            if (!allTeams.includes('Oficina')) {
              allTeams.unshift('Oficina');
            } else {
              // Mover Oficina al principio
              const idx = allTeams.indexOf('Oficina');
              if (idx > 0) {
                allTeams.splice(idx, 1);
                allTeams.unshift('Oficina');
              }
            }
            allTeams.forEach(team => {
              const option = document.createElement('option');
              option.value = team;
              option.textContent = team;
              teamFilter.appendChild(option);
            });
          }
          
          // Poblar filtro de agentes (inicialmente todos)
          const agentFilter = document.getElementById('agentFilter');
          if (agentFilter) {
            // Limpiar opciones existentes excepto la primera
            while (agentFilter.children.length > 1) {
              agentFilter.removeChild(agentFilter.lastChild);
            }

            // Intentar mapear nombres desde /api/users/agents (si está disponible)
            let nameMap = null;
            try {
              if (!window.__usersAgentsNameMapPromise) {
                window.__usersAgentsNameMapPromise = (async () => {
                  try {
                    const resp = await fetch('/api/users/agents', { method: 'GET', credentials: 'include', headers: authHeaders() });
                    if (!resp || !resp.ok) return null;
                    const json = await resp.json();
                    const arr = Array.isArray(json?.agents) ? json.agents : (Array.isArray(json) ? json : []);
                    if (!Array.isArray(arr) || !arr.length) return null;
                    const map = new Map();
                    arr.forEach(u => {
                      const disp = String(u?.name || u?.nombre || u?.fullName || u?.username || '').trim();
                      const uname = String(u?.username || '').trim();
                      if (disp) map.set(normKey(disp), disp);
                      if (uname && disp) map.set(normKey(uname), disp);
                      if (uname) map.set(normKey(uname), disp || uname);
                    });
                    return map;
                  } catch (_) { return null; }
                })();
              }
            } catch (_) {}

            try {
              nameMap = await window.__usersAgentsNameMapPromise;
            } catch (_) {
              nameMap = null;
            }

            const sortedAgents = Array.from(allAgentsSet).sort((a, b) => String(a).localeCompare(String(b)));
            sortedAgents.forEach(agent => {
              const option = document.createElement('option');
              option.value = agent;
              let label = toDisplayName(agent);
              try {
                if (nameMap && nameMap instanceof Map) {
                  const mapped = nameMap.get(normKey(agent));
                  if (mapped) label = mapped;
                }
              } catch (_) {}
              option.textContent = label || agent;
              agentFilter.appendChild(option);
            });
          }
          
          // Guardar mapa para uso posterior
          window.__teamAgentsMap = agentsMap;
          window.__allAgents = allAgentsSet;
          
          console.log('[Filtros] Teams encontrados:', Array.from(teamsSet));
          console.log('[Filtros] Agentes encontrados:', Array.from(allAgentsSet));
          console.log('[Filtros] Mapa team->agentes:', Object.fromEntries(
            Array.from(agentsMap.entries()).map(([k, v]) => [k, Array.from(v)])
          ));
          
        } catch (e) {
          console.warn('[Filtros] Error poblando filtros:', e);
        }
      };
      
      // Función para limpiar todos los filtros
      window.clearAllFilters = function(forceReload = false) {
        try {
          const monthFilter = document.getElementById('monthFilter');
          const teamFilter = document.getElementById('teamFilter');
          const agentFilter = document.getElementById('agentFilter');
          const statusFilter = document.getElementById('statusFilter');
          const mercadoFilter = document.getElementById('mercadoFilter');
          
          const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
          const roleNorm = (function normalizeRole(r){
            if (!r) return '';
            if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
            if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
            if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
            if (['backoffice','back office','back_office','bo','b.o','b:o','b-o'].includes(r)) return 'backoffice';
            return r;
          })(roleRaw);
          const mercadoRestrict = (roleNorm === 'rol_icon' || roleNorm === 'icon' || roleNorm.includes('rol icon')) ? 'ICON'
            : ((roleNorm === 'rol_bamo' || roleNorm === 'bamo' || roleNorm.includes('rol bamo')) ? 'BAMO' : '');
          
          if (monthFilter) monthFilter.value = '';
          if (teamFilter) teamFilter.value = '';
          if (agentFilter) agentFilter.value = '';
          if (statusFilter) statusFilter.value = 'all';
          if (mercadoFilter) mercadoFilter.value = mercadoRestrict ? mercadoRestrict : '';
          
          // Limpiar filtros residuales de window
          window.supervisorAgentFilter = null;
          window.adminTeamFilter = null;
          window.__page = 1;
          
          // Restaurar todos los agentes cuando se limpia el filtro de team
          if (agentFilter && window.__allAgents) {
            while (agentFilter.children.length > 1) {
              agentFilter.removeChild(agentFilter.lastChild);
            }
            Array.from(window.__allAgents).sort().forEach(agent => {
              const option = document.createElement('option');
              option.value = agent;
              option.textContent = agent;
              agentFilter.appendChild(option);
            });
          }
          
          // Si forceReload, limpiar cachÃ© y recargar datos
          if (forceReload) {
            console.log('[Filtros] Forzando recarga completa...');
            localStorage.removeItem('costumer_cached_leads');
            localStorage.removeItem('costumer_cache_time');
            window.ultimaListaLeads = null;
            if (typeof fetchLeadsAgente === 'function') {
              fetchLeadsAgente(1);
            } else {
              location.reload();
            }
            return;
          }
          
          // Re-renderizar tabla
          if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
            const prevSuspend = window.__suspendRender;
            try {
              window.__suspendRender = false;
              window.renderCostumerTable(window.ultimaListaLeads);
            } finally {
              window.__suspendRender = prevSuspend;
            }
          }
          
          console.log('[Filtros] Todos los filtros limpiados');
        } catch (e) {
          console.warn('[Filtros] Error limpiando filtros:', e);
        }
      };
      
      // Función para forzar recarga completa de datos
      window.forceReloadData = function() {
        console.log('[ForceReload] Limpiando cachÃ© y recargando...');
        try {
          // Limpiar localStorage relacionado con datos
          localStorage.removeItem('costumer_cached_leads');
          localStorage.removeItem('costumer_cache_time');
          localStorage.removeItem('costumer_show_all_months');
          // Limpiar variables de estado
          window.ultimaListaLeads = null;
          window.supervisorAgentFilter = null;
          window.adminTeamFilter = null;
          window.__page = 1;
          // Recargar pÃ¡gina
          location.reload(true);
        } catch (e) {
          console.error('[ForceReload] Error:', e);
          location.reload(true);
        }
      };
      
      // Configurar filtro de mes
      const monthFilter = document.getElementById('monthFilter');
      if (monthFilter) {
        // Debounce para evitar renders mÃºltiples
        let filterTimeout;
        monthFilter.addEventListener('change', function() {
          console.log('[MONTH FILTER] Cambiando a mes:', this.value || 'Todos los meses');

          // Mantener el mes sincronizado en estado global
          try {
            const v = String(this.value || '').trim();
            window.__selectedMonth = (/^\d{4}-\d{2}$/.test(v)) ? v : '';
          } catch (_) {}
          
          // Cancelar timeout anterior si existe
          if (filterTimeout) {
            clearTimeout(filterTimeout);
          }
          
          // Mostrar indicador de carga
          const tbody = document.getElementById('costumer-tbody');
          // Aplicar filtro con delay mÃ­nimo para mejor UX
          filterTimeout = setTimeout(() => {
            // Mostrar indicador de carga
            const statusIndicator = document.querySelector('.filter-status');
            if (statusIndicator) {
              statusIndicator.textContent = 'Filtrando...';
              statusIndicator.style.display = 'inline';
            }
            
            // Cuando cambia el mes, siempre re-consultar al backend con el mes seleccionado
            // para evitar filtrar la cachÃ© local (puede contener sÃ³lo el mes anterior).
            try {
              if (typeof fetchLeadsAgente === 'function') {
                fetchLeadsAgente().catch(err => console.error('[MONTH FILTER] Error cargando datos:', err));
              } else {
                console.warn('[MONTH FILTER] fetchLeadsAgente no disponible, no se puede recargar datos');
              }
            } catch (e) {
              console.error('[MONTH FILTER] Error ejecutando fetchLeadsAgente:', e);
            }
          }, 100); // 100ms delay para mejor UX
        });
      }
      
      // Configurar filtro de team
      const teamFilter = document.getElementById('teamFilter');
      if (teamFilter) {
        teamFilter.addEventListener('change', function() {
          console.log('========== [TEAM FILTER] EVENTO CHANGE ==========');
          console.log('[TEAM FILTER] Valor seleccionado:', this.value || '(vacÃ­o = Todos)');

          // Conectar Team=Oficina con Status=Active Oficina
          try {
            const statusFilterEl = document.getElementById('statusFilter');
            const teamVal = String(this.value || '').trim().toLowerCase();
            if (statusFilterEl) {
              if (teamVal === 'oficina') {
                statusFilterEl.value = 'active_oficina';
              } else {
                // Si antes estaba forzado por Oficina, regresar a "Todos"
                if (String(statusFilterEl.value || '').toLowerCase() === 'active_oficina') {
                  statusFilterEl.value = 'all';
                }
              }
            }
          } catch (_) {}
          
          // IMPORTANTE: Limpiar SIDEBAR_FILTER_OVERRIDE cuando el usuario usa el dropdown directamente
          // PERO respetar si es una actualizaciÃ³n programÃ¡tica desde el sidebar
          if (window.__IS_SIDEBAR_UPDATING) {
             console.log('[TEAM FILTER] ActualizaciÃ³n desde sidebar detectada, manteniendo override');
             window.__IS_SIDEBAR_UPDATING = false; // Reset flag
          } else {
             window.SIDEBAR_FILTER_OVERRIDE = null;
             console.log('[TEAM FILTER] SIDEBAR_FILTER_OVERRIDE limpiado (acciÃ³n manual)');
          }

          console.log('[TEAM FILTER] ultimaListaLeads disponible:', !!window.ultimaListaLeads, '| cantidad:', window.ultimaListaLeads?.length || 0);

          // Actualizar filtro de agentes basado en el team seleccionado
          const agentFilter = document.getElementById('agentFilter');
          if (agentFilter && window.__teamAgentsMap) {
            // Limpiar opciones de agentes excepto la primera
            while (agentFilter.children.length > 1) {
              agentFilter.removeChild(agentFilter.lastChild);
            }
            
            // Reset del filtro de agente
            agentFilter.value = '';
            
            let agentsToShow = [];
            if (this.value === '') {
              // Si no hay team seleccionado, mostrar todos los agentes
              agentsToShow = Array.from(window.__allAgents || []);
            } else {
              // Mostrar solo agentes del team seleccionado
              const teamAgents = window.__teamAgentsMap.get(this.value);
              agentsToShow = teamAgents ? Array.from(teamAgents) : [];
            }
            
            // Poblar filtro de agentes
            agentsToShow.sort().forEach(agent => {
              const option = document.createElement('option');
              option.value = agent;
              option.textContent = agent;
              agentFilter.appendChild(option);
            });
            
            console.log('[TEAM FILTER] Agentes disponibles para team "' + this.value + '":', agentsToShow);
          }
          
          // Re-renderizar tabla
          if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
            const prevSuspend = window.__suspendRender;
            try {
              window.__suspendRender = false;
              window.renderCostumerTable(window.ultimaListaLeads);
            } finally {
              window.__suspendRender = prevSuspend;
            }
          }
        });
      }
      
      // Configurar filtro de agente
      const agentFilter = document.getElementById('agentFilter');
      if (agentFilter) {
        agentFilter.addEventListener('change', function() {
          console.log('[AGENT FILTER] Cambiando a agente:', this.value || 'Todos los agentes');
          
          // IMPORTANTE: Limpiar SIDEBAR_FILTER_OVERRIDE cuando el usuario usa el dropdown directamente
          // PERO respetar si es una actualizaciÃ³n programÃ¡tica desde el sidebar
          if (window.__IS_SIDEBAR_UPDATING) {
             console.log('[AGENT FILTER] ActualizaciÃ³n desde sidebar detectada, manteniendo override');
             window.__IS_SIDEBAR_UPDATING = false; // Reset flag
          } else if (window.SIDEBAR_FILTER_OVERRIDE) {
             console.log('[AGENT FILTER] Limpiando override previo:', window.SIDEBAR_FILTER_OVERRIDE);
             window.SIDEBAR_FILTER_OVERRIDE = null;
          }

          // Re-renderizar tabla
          if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
            const prevSuspend = window.__suspendRender;
            try {
              window.__suspendRender = false;
              window.renderCostumerTable(window.ultimaListaLeads);
            } finally {
              window.__suspendRender = prevSuspend;
            }
          }
        });
      }
      // Configurar filtro de status
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.addEventListener('change', function() {
          console.log('[STATUS FILTER] Cambiando a status:', this.value || 'all');

          // Conectar Status=Active Oficina con Team=Oficina
          try {
            const teamFilterEl = document.getElementById('teamFilter');
            const statusVal = String(this.value || '').trim().toLowerCase();
            if (teamFilterEl) {
              if (statusVal === 'active_oficina') {
                // Guardar valor previo para restaurarlo al salir de Active Oficina
                if (teamFilterEl.getAttribute('data-prev-manual') == null) {
                  teamFilterEl.setAttribute('data-prev-manual', String(teamFilterEl.value || ''));
                }
                teamFilterEl.value = 'Oficina';
              } else {
                // Si el team estaba forzado por Active Oficina, restaurar
                const prev = teamFilterEl.getAttribute('data-prev-manual');
                if (prev != null && String(teamFilterEl.value || '').trim().toLowerCase() === 'oficina') {
                  teamFilterEl.value = prev;
                }
                teamFilterEl.removeAttribute('data-prev-manual');
              }
            }
          } catch (_) {}
          
          // Re-renderizar tabla
          if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
            const prevSuspend = window.__suspendRender;
            try {
              window.__suspendRender = false;
              window.renderCostumerTable(window.ultimaListaLeads);
            } finally {
              window.__suspendRender = prevSuspend;
            }
          }
        });
      }

      // Configurar filtros de fecha
      const dateFrom = document.getElementById('dateFrom');
      const dateTo = document.getElementById('dateTo');
      const btnClearDates = document.getElementById('btnClearDates');
      
      if (dateFrom) {
        dateFrom.addEventListener('change', function() {
          console.log('[DATE FILTER] Fecha desde:', this.value);
          if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
            const prevSuspend = window.__suspendRender;
            try {
              window.__suspendRender = false;
              window.renderCostumerTable(window.ultimaListaLeads);
            } finally {
              window.__suspendRender = prevSuspend;
            }
          }
        });
      }
      
      if (dateTo) {
        dateTo.addEventListener('change', function() {
          console.log('[DATE FILTER] Fecha hasta:', this.value);
          if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
            const prevSuspend = window.__suspendRender;
            try {
              window.__suspendRender = false;
              window.renderCostumerTable(window.ultimaListaLeads);
            } finally {
              window.__suspendRender = prevSuspend;
            }
          }
        });
      }
      
      if (btnClearDates) {
        btnClearDates.addEventListener('click', function() {
          console.log('[DATE FILTER] Limpiando fechas');
          if (dateFrom) dateFrom.value = '';
          if (dateTo) dateTo.value = '';
          if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
            const prevSuspend = window.__suspendRender;
            try {
              window.__suspendRender = false;
              window.renderCostumerTable(window.ultimaListaLeads);
            } finally {
              window.__suspendRender = prevSuspend;
            }
          }
        });
      }

      // Configurar filtro de mercado
      const mercadoFilter = document.getElementById('mercadoFilter');
      if (mercadoFilter) {
        try {
          const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          const roleRaw = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
          const roleNorm = (function normalizeRole(r){
            if (!r) return '';
            if (['admin','administrator','administrador','administradora'].includes(r)) return 'admin';
            if (['supervisor','supervisora','supervisores'].includes(r)) return 'supervisor';
            if (['agente','agent','agents','agentes','usuario','user','seller','vendedor','sales'].includes(r)) return 'agente';
            if (['backoffice','back office','back_office','bo','b.o','b:o','b-o'].includes(r)) return 'backoffice';
            return r;
          })(roleRaw);

          const mercadoRestrict = (roleNorm === 'rol_icon' || roleNorm === 'icon' || roleNorm.includes('rol icon')) ? 'ICON'
            : ((roleNorm === 'rol_bamo' || roleNorm === 'bamo' || roleNorm.includes('rol bamo')) ? 'BAMO' : '');

          if (mercadoRestrict) {
            mercadoFilter.value = mercadoRestrict;
            mercadoFilter.disabled = true;
          }
        } catch (e) {
          console.warn('[MERCADO FILTER] Error determinando restricciÃ³n por rol:', e);
        }

        mercadoFilter.addEventListener('change', function() {
          console.log('[MERCADO FILTER] Cambiando a mercado:', this.value || 'Todos los mercados');
          
          // Re-renderizar tabla
          if (window.ultimaListaLeads && typeof window.renderCostumerTable === 'function') {
            const prevSuspend = window.__suspendRender;
            try {
              window.__suspendRender = false;
              window.renderCostumerTable(window.ultimaListaLeads);
            } finally {
              window.__suspendRender = prevSuspend;
            }
          }
        });
      }
      
      // Configurar botÃ³n de cerrar sesiÃ³n
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function(e) {
          // Redirigir a la pÂ¨Â¢gina de inicio de sesiÂ¨Â®n
          window.location.href = 'index.html';
        });
      }
    });
  </script>
  
  <!-- Script de cierre de sesiÃ³n unificado -->
  <script src="js/auth-logout.js"></script>
  <!-- <script src="js/monthly-cutoff.js"></script> -->
  
  <!-- Utilidades de fecha (IMPORTANTE: cargar primero para evitar bug UTC) -->
  <!-- <script src="js/date-utils.js?v=1"></script> -->
  
  <!-- Scripts de Costumer -->
  <!-- <script src="js/costumer-actions.js?v=5"></script> -->
  <!-- <script src="js/costumer-init.js?v=5"></script> -->
  <!-- <script src="js/costumer-calendar.js?v=5"></script> -->
  <script>
    // Popover tipo Excel para filtrar por valores Ãºnicos de fecha
    (function(){
      const popoverId = 'costumer-datefilter-popover';

      function closePopover() {
        const ex = document.getElementById(popoverId);
        if (ex) ex.remove();
        document.removeEventListener('click', onDocClick);
      }
      // only close when clicking outside the popover
      function onDocClick(e) {
        try {
          const ex = document.getElementById(popoverId);
          if (!ex) return;
          if (ex.contains(e.target)) return; // inside popover: ignore
          closePopover();
        } catch (err) { closePopover(); }
      }

      function formatDateLabel(d) {
        return String(d||'').slice(0,10);
      }

      window.openDateFilterPopup = function(opts) {
        // opts: { field, lsKey, trigger, label }
        try {
          closePopover();
          const { field, lsKey, trigger, label } = opts || {};
          const root = document.createElement('div');
          root.id = popoverId;
          root.style.position = 'absolute';
          root.style.zIndex = 99999;
          root.style.boxSizing = 'border-box';
          root.style.width = '260px';
          root.style.maxWidth = '90vw';
          // Allow taller popover so footer buttons stay visible on most screens
          root.style.maxHeight = '520px';
          root.style.overflow = 'hidden';
          root.style.boxShadow = '0 6px 18px rgba(15,23,42,0.18)';
          root.style.background = '#fff';
          root.style.border = '1px solid #e2e8f0';
          root.style.borderRadius = '8px';
          root.style.fontSize = '13px';
          root.style.padding = '8px 8px 6px 8px';

          // Header
          const h = document.createElement('div');
          h.style.display = 'flex';
          h.style.justifyContent = 'space-between';
          h.style.alignItems = 'center';
          h.style.marginBottom = '6px';
          const title = document.createElement('div'); title.textContent = label || 'Filtrar'; title.style.fontWeight = '600';
          const actions = document.createElement('div'); actions.style.fontSize = '12px';
          root.appendChild(h);
          h.appendChild(title); h.appendChild(actions);

          // Search
          const search = document.createElement('input');
          search.type = 'search'; search.placeholder = 'Buscar...';
          search.style.width = '100%'; search.style.padding = '6px 8px'; search.style.marginBottom = '8px'; search.style.border = '1px solid #e6edf3'; search.style.borderRadius = '6px';
          root.appendChild(search);

          // Select all / Clear
          const tools = document.createElement('div'); tools.style.display = 'flex'; tools.style.justifyContent = 'space-between'; tools.style.alignItems = 'center'; tools.style.marginBottom = '6px';
          const left = document.createElement('div'); left.style.fontSize = '12px';
          const selectAllLink = document.createElement('a'); selectAllLink.href = '#'; selectAllLink.textContent = 'Seleccionar todo'; selectAllLink.style.marginRight = '8px';
          const clearLink = document.createElement('a'); clearLink.href = '#'; clearLink.textContent = 'Borrar';
          left.appendChild(selectAllLink); left.appendChild(clearLink);
          tools.appendChild(left);
          root.appendChild(tools);

          // List container
          const listWrap = document.createElement('div');
          listWrap.style.overflowY = 'auto'; listWrap.style.overflowX = 'hidden'; listWrap.style.maxHeight = '380px'; listWrap.style.borderTop = '1px solid #f1f5f9'; listWrap.style.paddingTop = '6px';
          listWrap.style.boxSizing = 'border-box'; listWrap.style.paddingRight = '8px';
          root.appendChild(listWrap);

          // Footer buttonsq
          const footer = document.createElement('div'); footer.style.display = 'flex'; footer.style.justifyContent = 'flex-end'; footer.style.gap = '8px'; footer.style.marginTop = '8px'; footer.style.flexWrap = 'wrap';
          const btnCancel = document.createElement('button'); btnCancel.textContent = 'Cancelar'; btnCancel.className = 'action-btn'; btnCancel.style.padding = '6px 8px'; btnCancel.style.fontSize = '12px';
          const btnAccept = document.createElement('button'); btnAccept.textContent = 'Aceptar'; btnAccept.className = 'action-btn'; btnAccept.style.background = '#10b981'; btnAccept.style.color = '#fff'; btnAccept.style.padding = '6px 8px'; btnAccept.style.fontSize = '12px';
          footer.appendChild(btnCancel); footer.appendChild(btnAccept); root.appendChild(footer);

          // Position near trigger (try center under the trigger, clamp to viewport, flip above if not enough space)
          document.body.appendChild(root);
          const rect = trigger.getBoundingClientRect();   
          // prefer a reasonable width but keep within viewport  
          const preferredWidth = 260;
          root.style.width = preferredWidth + 'px';
          // initial position: centered under trigger
          let topCandidate = window.scrollY + rect.bottom + 6;
          let leftCandidate = window.scrollX + rect.left + (rect.width / 2) - (preferredWidth / 2);
          // clamp horizontally with small margin
          const margin = 8;
          leftCandidate = Math.max(window.scrollX + margin, Math.min(leftCandidate, window.scrollX + window.innerWidth - preferredWidth - margin));
          root.style.top = `${topCandidate}px`;
          root.style.left = `${leftCandidate}px`;

          // After rendering, compute available space and adjust list height so footer (Aceptar/Cancelar) stays visible.
          setTimeout(() => {
            try {
              const viewportTop = window.scrollY;
              const viewportBottom = window.scrollY + window.innerHeight;
              const b = root.getBoundingClientRect();

              // reserved space: header + search + tools + footer + paddings
              const reserved = (h.offsetHeight || 0) + (search.offsetHeight || 0) + (tools.offsetHeight || 0) + (footer.offsetHeight || 0) + 24;

              // space below trigger
              const spaceBelow = viewportBottom - (window.scrollY + rect.bottom) - 12;
              const spaceAbove = (window.scrollY + rect.top) - viewportTop - 12;

              // decide whether to flip above
              let placeAbove = false;
              if (spaceBelow < 120 && spaceAbove > spaceBelow) placeAbove = true;
              if (placeAbove) {
                let newTop = window.scrollY + rect.top - b.height - 6;
                if (newTop < window.scrollY + margin) newTop = window.scrollY + margin;
                root.style.top = `${newTop}px`;
                topCandidate = newTop;
              }

              // compute available (below or above) for list
              const available = placeAbove ? (spaceAbove - reserved) : (spaceBelow - reserved);
              const listMax = Math.max(80, Math.min(200, available || 120));
              try { listWrap.style.maxHeight = `${listMax}px`; } catch(_) {}
            } catch (e) { /* ignore */ }
          }, 10);

          // Build unique date list from window.ultimaListaLeads
          const all = Array.isArray(window.ultimaListaLeads) ? window.ultimaListaLeads : [];
          const set = new Set();
          all.forEach(l => { const v = String(l && l[field] ? String(l[field]).slice(0,10) : ''); if (v) set.add(v); });
          const items = Array.from(set).sort((a,b)=> (b||'').localeCompare(a||''));

          // current selection
          let currentSel = [];
          try { const raw = localStorage.getItem(lsKey); if (raw) { const p = JSON.parse(raw); if (Array.isArray(p)) currentSel = p.map(x=>String(x).slice(0,10)); else if (typeof p==='string') currentSel = [p.slice(0,10)]; } } catch(_) { }

          // Render items
          const ul = document.createElement('div'); ul.style.display='flex'; ul.style.flexDirection='column'; ul.style.gap='6px'; ul.style.margin = '0'; ul.style.padding = '0';
          items.forEach(it => {
            // Row layout: checkbox and date next to each other; avoid overflow
            const row = document.createElement('div');
            row.style.display = 'flex'; row.style.alignItems = 'center'; row.style.justifyContent = 'flex-start'; row.style.padding = '6px 4px'; row.style.cursor = 'pointer';
            row.style.boxSizing = 'border-box';

            const cbWrap = document.createElement('div'); cbWrap.style.flex = '0 0 auto'; cbWrap.style.display = 'flex'; cbWrap.style.alignItems = 'center'; cbWrap.style.marginRight = '8px';
            const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = it; cb.checked = currentSel.includes(it);
            cbWrap.appendChild(cb);

            const dateSpan = document.createElement('div'); dateSpan.textContent = it; dateSpan.style.fontSize = '13px'; dateSpan.style.whiteSpace = 'nowrap'; dateSpan.style.color = '#0f172a'; dateSpan.style.overflow = 'hidden'; dateSpan.style.textOverflow = 'ellipsis'; dateSpan.style.flex = '1 1 auto'; dateSpan.style.textAlign = 'left';

            // Toggle checkbox when clicking on row (except on the checkbox itself)
            row.addEventListener('click', function(e){ if (e.target !== cb) cb.checked = !cb.checked; });

            row.appendChild(cbWrap);
            row.appendChild(dateSpan);
            ul.appendChild(row);
          });
          listWrap.appendChild(ul);

          // Search filter
          search.addEventListener('input', function(){
            const q = String(this.value||'').toLowerCase().trim();
            Array.from(ul.children).forEach(r => {
              const txt = (r.textContent||'').toLowerCase();
              r.style.display = q ? (txt.includes(q) ? '' : 'none') : '';
            });
          });

          selectAllLink.addEventListener('click', function(e){ e.preventDefault(); Array.from(ul.querySelectorAll('input[type=checkbox]')).forEach(c=>c.checked=true); });
          clearLink.addEventListener('click', function(e){ e.preventDefault(); Array.from(ul.querySelectorAll('input[type=checkbox]')).forEach(c=>c.checked=false); });

          btnCancel.addEventListener('click', function(){ closePopover(); });
          btnAccept.addEventListener('click', function(){
            const chosen = Array.from(ul.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value).filter(Boolean);
            try { localStorage.setItem(lsKey, JSON.stringify(chosen)); } catch(_) { try { localStorage.setItem(lsKey, String(chosen[0]||'')); } catch(_) {} }
            // update trigger display (use textContent for buttons, value for inputs)
            try {
              const label = chosen.length === 0 ? '' : (chosen.length === 1 ? chosen[0] : `${chosen.length} seleccionadas`);
              if (trigger) {
                if ((trigger.tagName||'').toUpperCase() === 'INPUT') trigger.value = label;
                else trigger.textContent = label;
              }
            } catch(_) {}
            // repaint
            window.__page = 1;
            const prev = window.__suspendRender; window.__suspendRender = false; try { window.renderCostumerTable(window.ultimaListaLeads||[]); } finally { window.__suspendRender = prev; }
            closePopover();
          });

          // close on outside click
          setTimeout(()=>{ document.addEventListener('click', onDocClick); }, 50);
        } catch(e) { console.error('openDateFilterPopup error', e); }
      };
    })();
  </script>
  <script>
    // Delegated handler: asegurar que los botones .date-filter-btn siempre abran el popup
    document.addEventListener('click', function(e){
      try {
        const btn = e.target.closest && e.target.closest('.date-filter-btn');
        if (!btn) return;
        e.preventDefault(); e.stopPropagation();
        const field = btn.getAttribute('data-field');
        const lsKey = btn.getAttribute('data-lskey');
        if (typeof window.openDateFilterPopup === 'function') {
          window.openDateFilterPopup({ field: field, lsKey: lsKey, trigger: btn, label: btn.title || '' });
        } else {
          console.warn('openDateFilterPopup no está disponible todavía');
        }
      } catch(err) { console.error('date-filter delegated click error', err); }
    });
  </script>
  <!-- Modal para Motivo de Cambio de Status -->
  <style>
    #reasonModal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      font-family: 'Poppins', sans-serif;
    }
    .reason-modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 25px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      text-align: center;
    }
    #reason-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
    }
    #reason-modal-text {
      font-size: 0.9rem;
      margin-bottom: 20px;
    }
    #reason-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .reason-modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .reason-modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    #reason-accept-btn {
      background-color: #28a745;
      color: white;
    }
    #reason-cancel-btn {
      background-color: #f44336;
      color: white;
    }
  </style>
  <div id="reasonModal">
    <div class="reason-modal-content">
      <h2 id="reason-modal-title">Motivo del Cambio de Status</h2>
      <p id="reason-modal-text"></p>
      <input type="text" id="reason-input" placeholder="Escribe el motivo aquÃ­...">
      <div class="reason-modal-buttons">
        <button id="reason-cancel-btn">Cancelar</button>
        <button id="reason-accept-btn">Aceptar</button>
      </div>
    </div>
  </div>

  <script>
    // LÃ³gica para el modal de motivo personalizado
    function askForReason(title, text) {
      return new Promise((resolve, reject) => {
        const modal = document.getElementById('reasonModal');
        const modalTitle = document.getElementById('reason-modal-title');
        const modalText = document.getElementById('reason-modal-text');
        const reasonInput = document.getElementById('reason-input');
        const acceptBtn = document.getElementById('reason-accept-btn');
        const cancelBtn = document.getElementById('reason-cancel-btn');

        modalTitle.textContent = title;
        modalText.innerHTML = text; // Usar innerHTML para permitir etiquetas como <b>
        reasonInput.value = '';

        modal.style.display = 'block';
        reasonInput.focus();

        const close = (value) => {
          modal.style.display = 'none';
          // Limpiar handlers para evitar mÃºltiples ejecuciones
          acceptBtn.onclick = null;
          cancelBtn.onclick = null;
          document.onkeydown = null;
          if (value !== null) {
            resolve(value);
          } else {
            reject(new Error('User cancelled.'));
          }
        };

        acceptBtn.onclick = () => {
          close(reasonInput.value);
        };

        cancelBtn.onclick = () => {
          close(null);
        };

        // Manejar Enter y Escape
        document.onkeydown = function(evt) {
            evt = evt || window.event;
            if (evt.key === "Escape") {
                close(null);
            } else if (evt.key === "Enter") {
                evt.preventDefault();
                close(reasonInput.value);
            }
        };
      });
    }
  </script>
  <!-- INICIALIZADOR FINAL: Cargar datos cuando TODO está listo -->
  <script>
    (function initializePageData() {
      console.log('[PAGE INIT] Inicializando carga de datos...');
      
      // Esperar a que el DOM esté completamente listo
      const tryLoadData = () => {
        console.log('[PAGE INIT] Verificando si fetchLeadsAgente está disponible...');
        
        if (typeof fetchLeadsAgente === 'function') {
          console.log('[PAGE INIT] ✓ fetchLeadsAgente disponible, iniciando carga...');
          fetchLeadsAgente().catch(err => {
            console.error('[PAGE INIT] Error cargando datos:', err);
          });
          return true;
        } else {
          console.warn('[PAGE INIT] fetchLeadsAgente aún no disponible, reintentando...');
          return false;
        }
      };
      
      // Intentar inmediatamente
      if (tryLoadData()) return;
      
      // Si no está disponible, reintentar en 100ms
      setTimeout(() => {
        if (tryLoadData()) return;
        
        // Si aún no, esperar al DOMContentLoaded
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            console.log('[PAGE INIT] DOMContentLoaded, intentando cargar datos...');
            let attempts = 0;
            const interval = setInterval(() => {
              if (tryLoadData()) {
                clearInterval(interval);
              }
              attempts++;
              if (attempts > 50) {
                clearInterval(interval);
                console.error('[PAGE INIT] No se pudo cargar fetchLeadsAgente después de 50 intentos');
              }
            }, 100);
          });
        } else {
          // DOM ya está cargado, reintentar
          let attempts = 0;
          const interval = setInterval(() => {
            if (tryLoadData()) {
              clearInterval(interval);
            }
            attempts++;
            if (attempts > 50) {
              clearInterval(interval);
              console.error('[PAGE INIT] No se pudo cargar fetchLeadsAgente después de 50 intentos');
            }
          }, 100);
        }
      }, 100);
    })();
  </script>
  <script>
    // FIXUP: Override getDateFromLead to handle normalized leads better
    // After normalizeLead(), dia_venta is already in YYYY-MM-DD format
    // So we should check it FIRST before trying to parse raw values
    (function() {
      const originalGetDateFromLead = window.getDateFromLead;
      if (!originalGetDateFromLead) return;
      
      window.getDateFromLead = function(lead) {
        try {
          if (!lead) return '';
          
          // CACHE: Si ya se calculó antes, devolverlo
          if (lead.__isoDate !== undefined) return lead.__isoDate;
          
          // PRIMERO: Si dia_venta ya está en formato YYYY-MM-DD, devolver directamente
          if (lead.dia_venta && typeof lead.dia_venta === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(lead.dia_venta)) {
            lead.__isoDate = lead.dia_venta;
            return lead.dia_venta;
          }
          
          // Fallback: usar la implementación original
          const result = originalGetDateFromLead.call(this, lead);
          lead.__isoDate = result;
          return result;
        } catch (e) {
          console.warn('[getDateFromLead FIXUP] Error:', e);
          return '';
        }
      };
      
      console.log('[FIXUP] getDateFromLead override installed');
    })();
  </script>
</body>
</html>

