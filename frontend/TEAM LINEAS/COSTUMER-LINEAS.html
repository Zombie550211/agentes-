<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer - Team Líneas</title>
  <script>
    (function guard(){
      try{
        const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
        const role = String(user.role||'').toLowerCase();
        const team = String(user.team||'').toLowerCase();
        const uname = String(user.username || user.name || user.email || '').toLowerCase();
        // Permitir: Team Líneas, Supervisor Team Líneas, Administrador, Back Office, Rol_icon
        const isTeamLineas = role==='teamlineas' || role==='lineas-agentes' || role==='supervisor team lineas' || (role==='supervisor' && team.includes('lineas')) || team.includes('lineas') || uname.startsWith('lineas-');
        const isAdmin = role === 'admin' || role === 'administrador';
        const isBackoffice = role === 'backoffice' || role === 'back office' || role === 'back_office' || role === 'bo' || role === 'b.o' || role === 'b:o' || role === 'b-o';
        const isRolIcon = role === 'rol_icon' || role === 'rol-icon' || role === 'rolicon';
        const ok = isTeamLineas || isAdmin || isBackoffice || isRolIcon;
        if(!ok){ window.location.replace('/inicio.html'); }
      }catch(e){ window.location.replace('/inicio.html'); }
    })();
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/theme.css" />
  <link rel="stylesheet" href="/css/sidebar-shared.css?v=20251124f" />
  <link rel="stylesheet" href="/css/costumer-table-clean.css" />
  <link rel="stylesheet" href="/css/costumer-table-actions.css" />
  <link rel="stylesheet" href="/css/costumer-table-comments.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px -10px rgba(102, 126, 234, 0.2);
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }
    
    .status-completed {
      background: #DCFCE7;
      color: #166534;
      border: 1px solid #BBF7D0;
    }
    
    .status-pending {
      background: #FEF3C7;
      color: #92400E;
      border: 1px solid #FDE68A;
    }
    
    .status-active {
      background: #DBEAFE;
      color: #1E40AF;
      border: 1px solid #BFDBFE;
    }
    
    .search-bar {
      transition: all 0.3s ease;
    }
    
    .search-bar:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }
    
    .table-row {
      transition: all 0.2s ease;
      border-bottom: 1px solid #F1F5F9;
    }
    
    .table-row:hover {
      background: #F8FAFC;
      box-shadow: 0 2px 8px -2px rgba(102, 126, 234, 0.08);
    }
    
    /* Optimización de tabla - más padding y jerarquía */
    .costumer-table td {
      padding: 16px 12px !important;
      vertical-align: middle;
    }
    
    .costumer-table th {
      padding: 14px 12px !important;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #64748B;
      background: #F8FAFC;
      border-bottom: 2px solid #E2E8F0;
    }
    
    /* Jerarquía de texto en celdas */
    .client-name {
      font-weight: 600;
      font-size: 14px;
      color: #1E293B;
      margin-bottom: 2px;
    }
    
    .client-id {
      font-size: 12px;
      color: #94A3B8;
      font-weight: 400;
    }
    
    .metric-card {
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid #F1F5F9;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    }
    
    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, rgba(102, 126, 234, 0.06) 0%, transparent 70%);
      pointer-events: none;
    }
    
    .metric-card:hover {
      border-color: #E2E8F0;
      box-shadow: 0 4px 12px -2px rgba(102, 126, 234, 0.12);
    }
    
    .filters { 
      background:#fff; 
      border:1px solid #F1F5F9; 
      border-radius:16px; 
      padding:20px; 
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
    }
    .grid-2 { display:grid; grid-template-columns: repeat(2, minmax(220px, 360px)); gap:16px; justify-content:space-between; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    
    
    /* Tabla con header sticky - Enfoque simplificado */
    .table-wrapper {
      position: relative;
      height: calc(100vh - 450px);
      overflow: auto;
    }
    
    .table-container {
      position: relative;
    }
    
    .costumer-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .costumer-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .costumer-table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
      padding: 16px 24px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .costumer-table tbody {
      background: white;
    }
    
    .costumer-table tbody tr {
      border-bottom: 1px solid #e5e7eb;
    }
    
    
    /* Efecto 3D para gráficas */
    #statusChart {
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.15)) 
              drop-shadow(0 6px 6px rgba(0, 0, 0, 0.1));
    }
    
    #agentChart {
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
    }
    
    
  </style>
</head>
<body style="background: #F8FAFC;">
  <div class="layout">
    <nav class="sidebar sidebar-inicio" data-active="costumer"></nav>
    <main class="main-content">
      <!-- Header moderno con gradiente -->
      <header class="gradient-bg shadow-lg" style="margin: -16px -16px 0 -16px; padding: 0;">
        <div class="max-w-full px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <div class="bg-white p-2 rounded-lg">
                <i class="fas fa-users text-purple-600 text-2xl"></i>
              </div>
              <div>
                <h1 class="text-white text-2xl font-bold m-0">Gestión de Clientes</h1>
                <p class="text-purple-200 text-sm m-0">Panel de control y análisis - Team Líneas</p>
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-right">
                <p class="text-white text-sm font-semibold m-0" id="header-username">Usuario</p>
                <p class="text-purple-200 text-xs m-0">Último acceso: Hoy</p>
              </div>
              <div class="bg-white p-2 rounded-full w-10 h-10 flex items-center justify-center">
                <i class="fas fa-user text-purple-600"></i>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="max-w-full px-6 py-6">
        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <!-- Cantidad de Ventas -->
          <div class="bg-white p-6 card-hover metric-card" style="border-radius: 16px;">
            <div class="flex items-center justify-between mb-4">
              <div style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 12px;">
                <i class="fas fa-shopping-cart" style="color: #3B82F6; font-size: 24px;"></i>
              </div>
            </div>
            <h3 style="color: #64748B; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Cantidad de Ventas</h3>
            <p style="font-size: 32px; font-weight: 700; color: #1E293B; margin: 0;" id="kpi-cantidad-ventas">0</p>
            <p style="font-size: 13px; color: #94A3B8; margin-top: 8px;">Total de ventas realizadas</p>
          </div>

          <!-- Cantidad de Líneas -->
          <div class="bg-white p-6 card-hover metric-card" style="border-radius: 16px;">
            <div class="flex items-center justify-between mb-4">
              <div style="background: rgba(139, 92, 246, 0.1); padding: 12px; border-radius: 12px;">
                <i class="fas fa-layer-group" style="color: #8B5CF6; font-size: 24px;"></i>
              </div>
            </div>
            <h3 style="color: #64748B; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Cantidad de Líneas</h3>
            <p style="font-size: 32px; font-weight: 700; color: #1E293B; margin: 0;" id="kpi-cantidad-lineas">0</p>
            <p style="font-size: 13px; color: #94A3B8; margin-top: 8px;">Total de líneas vendidas</p>
          </div>

          <!-- Líneas Activas -->
          <div class="bg-white p-6 card-hover metric-card" style="border-radius: 16px;">
            <div class="flex items-center justify-between mb-4">
              <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 12px;">
                <i class="fas fa-check-circle" style="color: #22C55E; font-size: 24px;"></i>
              </div>
            </div>
            <h3 style="color: #64748B; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Líneas Activas</h3>
            <p style="font-size: 32px; font-weight: 700; color: #1E293B; margin: 0;" id="kpi-lineas-activas">0</p>
            <p style="font-size: 13px; color: #94A3B8; margin-top: 8px;">Líneas en operación</p>
          </div>

          <!-- Líneas Pendientes -->
          <div class="bg-white p-6 card-hover metric-card" style="border-radius: 16px;">
            <div class="flex items-center justify-between mb-4">
              <div style="background: rgba(6, 182, 212, 0.1); padding: 12px; border-radius: 12px;">
                <i class="fas fa-clock" style="color: #06B6D4; font-size: 24px;"></i>
              </div>
            </div>
            <h3 style="color: #64748B; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Líneas Pendientes</h3>
            <p style="font-size: 32px; font-weight: 700; color: #1E293B; margin: 0;" id="kpi-lineas-pendientes">0</p>
            <p style="font-size: 13px; color: #94A3B8; margin-top: 8px;">Líneas por activar</p>
          </div>
        </div>

        <!-- Gráficas de Distribución y Tendencia -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Gráfica de Distribución por Estado -->
          <div class="bg-white p-6" style="border-radius: 16px; border: 1px solid #F1F5F9; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);">
            <h3 style="font-size: 16px; font-weight: 600; color: #1E293B; margin-bottom: 20px; display: flex; align-items: center;">
              <i class="fas fa-chart-pie mr-2" style="color: #8B5CF6;"></i>
              Distribución por Estado
            </h3>
            <div id="statusChart" style="height: 300px;"></div>
          </div>

          <!-- Gráfica de Líneas vendidas por agente -->
          <div class="bg-white p-6" style="border-radius: 16px; border: 1px solid #F1F5F9; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);">
            <h3 style="font-size: 16px; font-weight: 600; color: #1E293B; margin-bottom: 20px; display: flex; align-items: center;">
              <i class="fas fa-chart-bar mr-2" style="color: #8B5CF6;"></i>
              Líneas vendidas por agente
            </h3>
            <div id="agentChart" style="height: 300px;"></div>
          </div>
        </div>

        <!-- Filtros modernos con Tailwind -->
        <div class="bg-white p-6 mb-6" style="border-radius: 16px; border: 1px solid #F1F5F9; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label style="display: block; font-size: 12px; font-weight: 600; color: #64748B; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-search mr-1"></i> Buscar
              </label>
              <input type="text" id="q" placeholder="Buscar cliente..." 
                     style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 10px; font-size: 14px; transition: all 0.2s;" class="search-bar" onfocus="this.style.borderColor='#8B5CF6'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'">
            </div>
            <div id="status-filter-container">
              <label style="display: block; font-size: 12px; font-weight: 600; color: #64748B; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-filter mr-1"></i> Estado
              </label>
              <select id="qs" style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 10px; font-size: 14px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#8B5CF6'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'">
                <option value="">Todos</option>
                <option value="pending">PENDING</option>
                <option value="repro">REPRO</option>
              </select>
            </div>
            <div id="agent-filter-container">
              <label style="display: block; font-size: 12px; font-weight: 600; color: #64748B; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-user-tie mr-1"></i> Agente
              </label>
              <select id="agentFilter" style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 10px; font-size: 14px; background: white; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='#8B5CF6'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'">
                <option value="">Todos</option>
              </select>
            </div>
            <div>
              <label style="display: block; font-size: 12px; font-weight: 600; color: #64748B; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-calendar mr-1"></i> Fecha Desde
              </label>
              <input type="date" id="dateFrom" style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 10px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#8B5CF6'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
            <div>
              <label style="display: block; font-size: 12px; font-weight: 600; color: #64748B; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-calendar mr-1"></i> Fecha Hasta
              </label>
              <input type="date" id="dateTo" style="width: 100%; padding: 10px 14px; border: 1px solid #E2E8F0; border-radius: 10px; font-size: 14px; transition: all 0.2s;" onfocus="this.style.borderColor='#8B5CF6'; this.style.boxShadow='0 0 0 3px rgba(139, 92, 246, 0.1)'" onblur="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'">
            </div>
            <div class="flex items-end">
              <button id="btnClearDates" style="width: 100%; background: #64748B; color: white; padding: 10px 16px; border-radius: 10px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#475569'" onmouseout="this.style.background='#64748B'">
                <i class="fas fa-eraser mr-2"></i>Limpiar Fechas
              </button>
            </div>
            <div class="flex items-end" id="admin-actions" style="display:none;">
              <button id="btn-seed-data" class="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
                <i class="fas fa-database mr-2"></i>Crear Datos de Prueba
              </button>
            </div>
          </div>
        </div>

        <!-- Tabla principal con diseño moderno -->
        <div class="bg-white" style="border-radius: 16px; border: 1px solid #F1F5F9; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);">
          <div class="p-6 flex items-center justify-between" style="border-bottom: 1px solid #F1F5F9;">
            <h2 style="font-size: 18px; font-weight: 600; color: #1E293B; margin: 0;">
              <i class="fas fa-table mr-2" style="color: #8B5CF6;"></i>
              Lista de Clientes
            </h2>
          </div>
          
          <div class="table-wrapper">
            <div class="table-container">
              <table class="w-full costumer-table">
              <thead>
                <tr id="costumer-thead">
                  <th class="text-left">Cliente</th>
                  <th class="text-left">Teléfono</th>
                  <th class="text-left">Cuenta</th>
                  <th class="text-left">Cant. líneas</th>
                  <th class="text-left">Líneas</th>
                  <th class="text-left">Estado</th>
                  <th class="text-left">Día venta</th>
                  <th class="text-left">Día instalación</th>
                  <th class="text-left">ID</th>
                  <th class="text-left">Mercado</th>
                  <th class="text-left">Supervisor</th>
                  <th class="text-left">Acciones</th>
                </tr>
              </thead>
              <tbody id="costumer-tbody" class="divide-y divide-gray-200"></tbody>
            </table>
            </div>
          </div>
          <div id="scrollbarMirror" class="scrollbar-mirror"><div id="scrollbarMirrorInner" style="height:1px;"></div></div>
        </div>
      </div>
    </main>
  </div>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-3d.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="/js/fetch-interceptor.js"></script>
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="/js/sidebar-loader.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      if (window.loadSidebar) window.loadSidebar();

      // Inicializar gráficas después de un pequeño delay para asegurar que Chart.js esté cargado
      setTimeout(initCharts, 100);

      // Lógica para el botón de seeding
      const userRole = getUserRole();
      if (userRole === 'admin' || userRole === 'administrador') {
        document.getElementById('admin-actions').style.display = 'block';
      }

      // Mostrar nombre de usuario en header
      try {
        const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
        const username = user.username || user.name || 'Usuario';
        document.getElementById('header-username').textContent = username;
      } catch (_) {}

      // Para agentes de Team Líneas: ocultar filtros avanzados (STATUS / AGENTE)
      if (!userRole.includes('supervisor')) {
        try {
          const statusContainer = document.getElementById('status-filter-container');
          const agentContainer = document.getElementById('agent-filter-container');
          if (statusContainer) statusContainer.style.display = 'none';
          if (agentContainer) agentContainer.style.display = 'none';
        } catch (_) {}
      }

      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      // Función global para mostrar notificaciones con diseño mejorado
      function showNotification(message, type = 'success') {
        // Remover notificación anterior si existe
        const existing = document.querySelector('.custom-notification');
        if (existing) existing.remove();
        
        const colors = {
          success: { bg: 'linear-gradient(135deg, #10b981 0%, #059669 100%)', border: '#059669' },
          error: { bg: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', border: '#dc2626' },
          warning: { bg: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', border: '#d97706' },
          info: { bg: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', border: '#2563eb' }
        };
        
        const currentColor = colors[type] || colors.success;
        
        const notification = document.createElement('div');
        notification.className = 'custom-notification';
        notification.style.cssText = `
          position: fixed;
          top: 24px;
          right: 24px;
          background: ${currentColor.bg};
          color: white;
          padding: 16px 24px;
          border-radius: 12px;
          border-left: 4px solid ${currentColor.border};
          box-shadow: 0 10px 25px rgba(0,0,0,0.15), 0 4px 10px rgba(0,0,0,0.1);
          z-index: 10001;
          font-size: 14px;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 12px;
          min-width: 300px;
          max-width: 500px;
          animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
          backdrop-filter: blur(10px);
        `;
        
        const icons = {
          success: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
          error: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
          warning: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
          info: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
        };
        
        const icon = icons[type] || icons.success;
        
        notification.innerHTML = `
          <div style="flex-shrink: 0;">${icon}</div>
          <div style="flex: 1; line-height: 1.5;">${message}</div>
          <button class="notification-close" style="background: transparent; border: none; color: white; cursor: pointer; padding: 4px; display: flex; align-items: center; opacity: 0.8; transition: opacity 0.2s;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        `;
        
        // Agregar animaciones CSS si no existen
        if (!document.querySelector('#notification-styles')) {
          const style = document.createElement('style');
          style.id = 'notification-styles';
          style.textContent = `
            @keyframes slideInBounce {
              0% {
                transform: translateX(120%) scale(0.9);
                opacity: 0;
              }
              60% {
                transform: translateX(-10px) scale(1.02);
                opacity: 1;
              }
              100% {
                transform: translateX(0) scale(1);
                opacity: 1;
              }
            }
            @keyframes slideOutFade {
              0% {
                transform: translateX(0) scale(1);
                opacity: 1;
              }
              100% {
                transform: translateX(120%) scale(0.9);
                opacity: 0;
              }
            }
            .notification-close:hover {
              opacity: 1 !important;
              transform: rotate(90deg);
              transition: all 0.3s ease;
            }
            @keyframes fadeIn {
              from {
                opacity: 0;
              }
              to {
                opacity: 1;
              }
            }
            @keyframes scaleIn {
              0% {
                transform: scale(0.9);
                opacity: 0;
              }
              100% {
                transform: scale(1);
                opacity: 1;
              }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.appendChild(notification);
        
        // Botón de cerrar
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
          notification.style.animation = 'slideOutFade 0.3s ease-in';
          setTimeout(() => notification.remove(), 300);
        });
        
        // Auto-remover después de 4 segundos
        setTimeout(() => {
          if (document.body.contains(notification)) {
            notification.style.animation = 'slideOutFade 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
          }
        }, 4000);
      }

      // Función para mostrar confirmación personalizada
      function showConfirm(title, message) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: fadeIn 0.2s ease-out;
            backdrop-filter: blur(4px);
          `;
          
          const modal = document.createElement('div');
          modal.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            overflow: hidden;
          `;
          
          modal.innerHTML = `
            <div style="padding: 24px 24px 20px; border-bottom: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg>
                </div>
                <h3 style="margin: 0; color: #0f172a; font-size: 18px; font-weight: 700;">${title}</h3>
              </div>
            </div>
            <div style="padding: 20px 24px;">
              <p style="margin: 0; color: #64748b; font-size: 14px; line-height: 1.6;">${message}</p>
            </div>
            <div style="display: flex; gap: 12px; padding: 20px 24px; background: #f8f9fa; border-top: 1px solid #e5e7eb;">
              <button class="confirm-cancel" style="flex: 1; background: white; color: #64748b; border: 1px solid #e5e7eb; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                Cancelar
              </button>
              <button class="confirm-accept" style="flex: 1; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);">
                Aceptar
              </button>
            </div>
          `;
          
          overlay.appendChild(modal);
          document.body.appendChild(overlay);
          
          // Agregar efectos hover
          const cancelBtn = modal.querySelector('.confirm-cancel');
          const acceptBtn = modal.querySelector('.confirm-accept');
          
          cancelBtn.addEventListener('mouseenter', () => {
            cancelBtn.style.background = '#f8f9fa';
            cancelBtn.style.borderColor = '#cbd5e1';
          });
          cancelBtn.addEventListener('mouseleave', () => {
            cancelBtn.style.background = 'white';
            cancelBtn.style.borderColor = '#e5e7eb';
          });
          
          acceptBtn.addEventListener('mouseenter', () => {
            acceptBtn.style.transform = 'translateY(-2px)';
            acceptBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.4)';
          });
          acceptBtn.addEventListener('mouseleave', () => {
            acceptBtn.style.transform = 'translateY(0)';
            acceptBtn.style.boxShadow = '0 2px 8px rgba(239, 68, 68, 0.3)';
          });
          
          // Event listeners
          cancelBtn.addEventListener('click', () => {
            overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
            setTimeout(() => {
              overlay.remove();
              resolve(false);
            }, 200);
          });
          
          acceptBtn.addEventListener('click', () => {
            overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
            setTimeout(() => {
              overlay.remove();
              resolve(true);
            }, 200);
          });
          
          // Cerrar al hacer clic fuera del modal
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
              setTimeout(() => {
                overlay.remove();
                resolve(false);
              }, 200);
            }
          });
        });
      }

      // Configuración de actualización de STATUS
      const STATUS_ENDPOINT = '/api/lineas-team/status'; // Ajustar si tu ruta es distinta
      const STATUS_METHOD = 'PUT';
      const STATUS_OPTIONS = [
        { val: 'pending', label: 'Pending' },
        { val: 'hold', label: 'Hold' },
        { val: 'cancelled', label: 'Cancelled' },
        { val: 'rescheduled', label: 'Rescheduled' },
        { val: 'completed', label: 'Completed' }
      ];
      function getUserRole(){
        try{ const u = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}'); return String(u.role||'').toLowerCase(); }catch{ return ''; }
      }
      function canEditStatus(){
        const r = getUserRole();
        return r.includes('admin') || r.includes('administrador') || r.includes('backoffice') || r.includes('rol_icon');
      }
      function canDelete(){
        const r = getUserRole();
        return r.includes('admin') || r.includes('administrador') || r.includes('backoffice') || r.includes('rol_icon');
      }

      function normalizeDigits(v){ return String(v||'').replace(/\D+/g,''); }

      async function fetchData(){
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const headers = {};
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const resp = await fetch(`/api/lineas-team?t=${Date.now()}`, { 
          credentials: 'include',
          headers: headers
        });
        const j = await resp.json();
        let data = Array.isArray(j?.data) ? j.data : [];
        
        // Filtrar datos según rol del usuario
        try {
          const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
          const role = String(user.role || '').toLowerCase();
          const username = String(user.username || '').toUpperCase();
          
          console.log('[fetchData] Rol del usuario:', role, 'Username:', username);
          console.log('[fetchData] Datos recibidos del backend:', data.length);
          
          // Admin, BackOffice y rol_icon ven TODO
          if (role === 'admin' || role === 'administrador' || role === 'backoffice' || role === 'back office' || role === 'back_office' || role === 'rol_icon' || role === 'rol-icon' || role === 'rolicon') {
            console.log('[fetchData] Usuario es admin/backoffice/rol_icon - retornando todos los datos');
            return data;
          }
          
          // Supervisores ven solo leads de sus agentes
          if (role === 'supervisor' || role === 'supervisor team lineas') {
            console.log('[fetchData] Usuario es supervisor - el backend ya filtró los datos');
            return data;
          }
          
          // Agentes solo ven sus propios leads
          console.log('[fetchData] Usuario es agente - filtrando por username');
          data = data.filter(item => {
            const agente = String(item.agenteAsignado || item.agenteNombre || item.agente || item._collectionName || '').toUpperCase();
            return agente.includes(username) || agente === username;
          });
          console.log('[fetchData] Datos después de filtrar para agente:', data.length);
          
        } catch (e) {
          console.error('Error al filtrar datos por rol:', e);
        }
        
        return data;
      }

      function buildHeaders(){
        const thead = document.getElementById('costumer-thead');
        if (!thead) return;
        thead.innerHTML = `
          <tr>
            <th>Cliente</th>
            <th>Teléfono</th>
            <th>Cuenta</th>
            <th>Cant. líneas</th>
            <th>Líneas</th>
            <th>STATUS</th>
            <th>Día venta</th>
            <th>Día instalación</th>
            <th>ID</th>
            <th>Mercado</th>
            <th>Supervisor</th>
            <th>ACCIÓN</th>
          </tr>`;
      }

      function applyFilters(items){
        const query = ($('#q')?.value || '').trim().toUpperCase();
        const qstatus = ($('#qs')?.value || '').trim().toLowerCase();
        const qagent = ($('#agentFilter')?.value || '').trim().toUpperCase();
        let dateFrom = ($('#dateFrom')?.value || '').trim();
        let dateTo = ($('#dateTo')?.value || '').trim();
        
        // Si no hay filtros de fecha establecidos, filtrar por mes actual por defecto
        if (!dateFrom && !dateTo) {
          const now = new Date();
          const year = now.getFullYear();
          const month = String(now.getMonth() + 1).padStart(2, '0');
          dateFrom = `${year}-${month}-01`;
          const lastDay = new Date(year, now.getMonth() + 1, 0).getDate();
          dateTo = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
        }
        
        const nombre = '';
        const tel = '';
        const cuenta = '';
        const autopay = '';
        const pin = '';
        const dir = '';
        const servs = [];
        let status = '';
        if (qstatus) status = qstatus;
        const dventa = '';
        const dinst = '';
        const cant = '';
        const idv = '';
        const mercado = [];
        let sup = '';
        if (!sup && defaultSupervisor) sup = defaultSupervisor;

        return items.filter(it=>{
          if (query) {
            const blob = [
              String(it.nombre_cliente||'').toUpperCase(),
              normalizeDigits(it.telefono_principal),
              String(it.numero_cuenta||'').toUpperCase(),
              String(it.direccion||'').toUpperCase(),
              String(it.id||'').toUpperCase()
            ].join(' | ');
            if (!blob.includes(query)) return false;
          }
          if (nombre && !(String(it.nombre_cliente||'').toUpperCase().includes(nombre))) return false;
          if (tel && !(normalizeDigits(it.telefono_principal).includes(tel))) return false;
          if (cuenta && !(String(it.numero_cuenta||'').includes(cuenta))) return false;
          if (autopay && String(it.autopay||'').toLowerCase()!==autopay) return false;
          if (pin && !(String(it.pin_seguridad||'').includes(pin))) return false;
          if (dir && !(String(it.direccion||'').toUpperCase().includes(dir))) return false;
          if (servs.length && !servs.some(s=> (it.servicios||[]).includes(s))) return false;
          if (status && String(it.status||'').toLowerCase()!==status) return false;
          if (dventa && String(it.dia_venta||'')!==dventa) return false;
          if (dinst && String(it.dia_instalacion||'')!==dinst) return false;
          if (cant && Number(it.cantidad_lineas||0)!== Number(cant)) return false;
          if (idv && !(String(it.id||'').includes(idv))) return false;
          if (mercado.length && !mercado.includes(String(it.mercado||''))) return false;
          if (sup && !String(it.supervisor||'').toUpperCase().includes(sup.toUpperCase())) return false;
          // Filtro por agente asignado
          if (qagent && !(String(it.agenteAsignado||'').toUpperCase().includes(qagent) || 
                          String(it.agenteNombre||'').toUpperCase().includes(qagent) ||
                          String(it.agente||'').toUpperCase().includes(qagent))) return false;
          
          // Filtro por rango de fechas (dia_venta) - ahora siempre aplica (mes actual por defecto)
          const diaVenta = it.dia_venta || '';
          if (dateFrom && diaVenta < dateFrom) return false;
          if (dateTo && diaVenta > dateTo) return false;
          
          return true;
        });
      }

      function renderTable(items){
        buildHeaders();
        const tb = document.getElementById('costumer-tbody');
        const editable = canEditStatus();
        tb.innerHTML = items.map((it, idx)=>{
          const servArr = Array.isArray(it.servicios) ? it.servicios : (typeof it.servicios_texto==='string' ? it.servicios_texto.split(/[,;]+/).map(s=>s.trim()).filter(Boolean) : []);
          const tels = Array.isArray(it.telefonos) ? it.telefonos : [];
          const lines = Array.isArray(it.lines) ? it.lines : [];
          const maxLen = Math.max(servArr.length, tels.length, lines.length);
          
          const pairs = Array.from({length: maxLen}).map((_,i)=>{
            const s = servArr[i] || '';
            const t = tels[i] || '';
            return (s||t) ? `${s}${s&&t?': ':''}${t}` : '';
          }).filter(Boolean);
          
          const cant = (it.cantidad_lineas!=null) ? it.cantidad_lineas : (Array.isArray(it.telefonos) ? it.telefonos.length : '');
          const hasMultipleLines = cant > 1;
          const statusLower = String(it.status||'').toLowerCase();
          const docId = it._id || it.id || '';
          const statusCell = editable
            ? `<select class="status-select" data-id="${docId}" data-prev="${statusLower}" style="min-width:140px;">
                 ${STATUS_OPTIONS.map(o=>`<option value="${o.val}" ${o.val===statusLower?'selected':''}>${o.label}</option>`).join('')}
               </select>`
            : String(it.status||'').toUpperCase();
          
          // Determinar color del badge de status
          let statusBadgeClass = 'status-badge ';
          if (statusLower === 'completed') statusBadgeClass += 'status-completed';
          else if (statusLower === 'pending') statusBadgeClass += 'status-pending';
          else if (statusLower === 'active') statusBadgeClass += 'status-active';
          else statusBadgeClass += 'bg-gray-200 text-gray-700';

          let mainRow = `<tr class="table-row ${hasMultipleLines ? 'expandable-row' : ''}" data-row-index="${idx}" style="${hasMultipleLines ? 'cursor:pointer;' : ''}">
            <td class="px-6 py-4">
              <div class="flex items-center">
                <div class="${statusLower === 'completed' ? 'bg-green-100' : 'bg-purple-100'} p-2 rounded-full mr-3">
                  <i class="fas fa-user ${statusLower === 'completed' ? 'text-green-600' : 'text-purple-600'}"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-gray-900 m-0">${it.nombre_cliente||''}${hasMultipleLines ? ' <span class="text-blue-500">▼</span>' : ''}</p>
                  <p class="text-xs text-gray-500 m-0">ID: ${it.ID||it.id||it._id||''}</p>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">${it.telefono_principal||''}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${it.numero_cuenta||''}</td>
            <td class="px-6 py-4">
              ${hasMultipleLines ? `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold">${cant} líneas</span>` : `<span class="text-sm text-gray-600">${cant}</span>`}
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">${pairs.length ? pairs.map(p=>`<div>${p}</div>`).join('') : ''}</td>
            <td class="px-6 py-4">
              ${editable ? statusCell : `<span class="${statusBadgeClass}"><i class="fas ${statusLower === 'completed' ? 'fa-check-circle' : statusLower === 'pending' ? 'fa-clock' : 'fa-circle'} mr-1"></i>${String(it.status||'').toUpperCase()}</span>`}
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">${it.dia_venta||''}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${it.dia_instalacion||''}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${it.ID||it.id||it._id||''}</td>
            <td class="px-6 py-4 text-sm text-gray-600">${it.mercado||''}</td>
            <td class="px-6 py-4">
              <div class="flex items-center">
                <i class="fas fa-user-tie text-gray-400 mr-2"></i>
                <span class="text-sm text-gray-600">${it.supervisor||''}</span>
              </div>
            </td>
            <td class="px-6 py-4">
              <div class="flex space-x-2">
                <button class="btn-edit-client bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition" data-id="${docId}" title="Editar cliente">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn-delete-client bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition" data-id="${docId}" title="Eliminar cliente" style="${canDelete() ? '' : 'display:none;'}">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>`;
          
          // Fila expandible con detalles de todas las líneas - Diseño moderno
          if (hasMultipleLines) {
            let detailsHTML = `<tr class="details-row" data-row-index="${idx}" style="display:none;">
              <td colspan="12" style="padding:0;">
                <div class="gradient-bg" style="padding:16px 20px; border-bottom:1px solid rgba(255,255,255,0.2);">
                  <h4 class="text-white text-lg font-bold m-0 flex items-center">
                    <i class="fas fa-phone-volume mr-3"></i>
                    Detalle de Líneas - ${it.nombre_cliente||''}
                  </h4>
                </div>
                <div style="padding:20px; background:#f8f9fa;">
                  <!-- Información General del Cliente con diseño moderno -->
                  <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <p class="text-sm text-gray-600 mb-1">Cliente</p>
                        <p class="font-semibold text-gray-800 m-0">${it.nombre_cliente||'N/A'}</p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-600 mb-1">Teléfono Principal</p>
                        <p class="font-semibold text-gray-800 m-0">${it.telefono_principal||'N/A'}</p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-600 mb-1">Fecha de Venta</p>
                        <p class="font-semibold text-gray-800 m-0">${it.dia_venta||'N/A'}</p>
                      </div>
                      <div>
                        <p class="text-sm text-gray-600 mb-1">Estado General</p>
                        <span class="${statusBadgeClass}">
                          <i class="fas ${statusLower === 'completed' ? 'fa-check-circle' : 'fa-clock'} mr-1"></i>
                          ${String(it.status||'').toUpperCase()}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Líneas Asociadas -->
                  <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-list-ul text-purple-600 mr-2"></i>
                    Líneas Asociadas
                  </h4>
                  <div style="display:grid; gap:16px;">`;
            
            // Mostrar cada línea con su información completa
            for (let i = 0; i < maxLen; i++) {
              const lineData = lines[i] || {};
              const telefono = tels[i] || lineData.telefono || '';
              const servicio = servArr[i] || lineData.servicio || '';
              
              // Leer notas desde lineas_notas en lugar de lines
              const lineasNotas = it.lineas_notas || {};
              const notas = lineasNotas[i] || [];
              
              console.log(`Cliente ${it.nombre_cliente}, Línea ${i}:`, {
                telefono: telefono,
                servicio: servicio,
                notas: notas,
                notasLength: notas.length
              });
              
              // Obtener status de esta línea específica
              const lineasStatus = it.lineas_status || {};
              const lineStatus = lineasStatus[i] || 'PENDING';
              
              // Determinar badge de status de línea
              let lineStatusBadge = '';
              if (lineStatus === 'ACTIVE') lineStatusBadge = '<span class="status-badge status-active">ACTIVE</span>';
              else if (lineStatus === 'PENDING') lineStatusBadge = '<span class="status-badge status-pending">PENDING</span>';
              else if (lineStatus === 'COMPLETED') lineStatusBadge = '<span class="status-badge status-completed">COMPLETED</span>';
              else lineStatusBadge = `<span class="status-badge bg-gray-200 text-gray-700">${lineStatus}</span>`;

              detailsHTML += `
                <div class="bg-white border-2 border-gray-200 rounded-lg p-5 hover:border-purple-300 transition">
                  <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center">
                      <div class="bg-blue-100 p-3 rounded-lg mr-3">
                        <i class="fas fa-phone-alt text-blue-600 text-lg"></i>
                      </div>
                      <div>
                        <h5 class="font-semibold text-gray-800 text-lg m-0">Línea ${i+1}</h5>
                        <p class="text-sm text-gray-500 m-0">${telefono || 'Sin teléfono'}</p>
                      </div>
                    </div>
                    ${lineStatusBadge}
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <p class="text-xs text-gray-500 mb-1">Servicio</p>
                      <p class="font-medium text-gray-700 m-0">${servicio || 'N/A'}</p>
                    </div>
                    <div>
                      <p class="text-xs text-gray-500 mb-1">Estado</p>
                      <select class="line-status-select w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-semibold focus:outline-none focus:border-purple-500" data-client-id="${docId}" data-line-index="${i}" ${getUserRole() === 'supervisor' ? 'disabled' : ''}>
                        <option value="PENDING" ${lineStatus === 'PENDING' ? 'selected' : ''}>PENDING</option>
                        <option value="ACTIVE" ${lineStatus === 'ACTIVE' ? 'selected' : ''}>ACTIVE</option>
                        <option value="COMPLETED" ${lineStatus === 'COMPLETED' ? 'selected' : ''}>COMPLETED</option>
                        <option value="REPRO" ${lineStatus === 'REPRO' ? 'selected' : ''}>REPRO</option>
                        <option value="CANCELLED" ${lineStatus === 'CANCELLED' ? 'selected' : ''}>CANCELLED</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- Sección de Notas -->
                  <div class="bg-gray-50 rounded-lg p-3 mt-4">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                      <span style="color:#64748b; font-size:12px; font-weight:600;">Notas:</span>
                      <button class="btn-add-note" data-client-id="${docId}" data-line-index="${i}" style="background:#10b981; color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                        <span style="font-size:14px;">+</span> Agregar Nota
                      </button>
                    </div>
                    
                    <!-- Formulario para agregar nota (inicialmente oculto) -->
                    <div class="note-form" data-line-index="${i}" style="display:none; background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:12px; margin-bottom:12px;">
                      <textarea class="note-textarea" placeholder="Agregar nueva nota..." style="width:100%; min-height:80px; padding:8px; border:1px solid #e5e7eb; border-radius:4px; font-size:13px; resize:vertical; font-family:inherit;"></textarea>
                      <div style="display:flex; gap:8px; margin-top:8px;">
                        <button class="btn-save-note" style="background:#10b981; color:#fff; border:none; padding:6px 16px; border-radius:6px; font-size:12px; cursor:pointer; font-weight:600;">
                          + Agregar Nota
                        </button>
                        <button class="btn-cancel-note" style="background:#64748b; color:#fff; border:none; padding:6px 16px; border-radius:6px; font-size:12px; cursor:pointer;">
                          Cancelar
                        </button>
                      </div>
                    </div>
                    
                    <!-- Lista de notas existentes -->
                    <div class="notes-list" data-line-index="${i}" style="display:flex; flex-direction:column; gap:8px;">
                      ${notas.length > 0 ? notas.map((nota, nIdx) => {
                        const textoNota = nota.texto || nota;
                        let fechaNota = '';
                        if (nota.fecha) {
                          const fecha = new Date(nota.fecha);
                          fechaNota = fecha.toLocaleString('es-ES', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                          });
                        }
                        const autor = nota.autor || '';
                        return `
                        <div class="note-item" data-note-index="${nIdx}" style="background:#fff; border:1px solid #e5e7eb; border-radius:4px; padding:8px; position:relative;">
                          <div style="display:flex; justify-content:space-between; align-items:start; gap:8px;">
                            <div style="flex:1;">
                              <div class="note-text" style="color:#0f172a; font-size:13px;">${textoNota}</div>
                              ${fechaNota ? `<div style="color:#94a3b8; font-size:11px; margin-top:4px;">${fechaNota}${autor ? ' - ' + autor : ''}</div>` : ''}
                            </div>
                            <div style="display:flex; gap:4px;">
                              <button class="btn-edit-note" data-client-id="${docId}" data-line-index="${i}" data-note-index="${nIdx}" style="background:#3b82f6; color:#fff; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:2px;" title="Editar nota">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                              </button>
                              <button class="btn-delete-note" data-client-id="${docId}" data-line-index="${i}" data-note-index="${nIdx}" style="background:#ef4444; color:#fff; border:none; padding:4px 8px; border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:2px; ${canDelete() ? '' : 'display:none;'}" title="Eliminar nota">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                  <polyline points="3 6 5 6 21 6"></polyline>
                                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                              </button>
                            </div>
                          </div>
                        </div>`;
                      }).join('') : '<div style="color:#94a3b8; font-size:12px; padding:8px 0;">No hay notas agregadas</div>'}
                    </div>
                  </div>
                </div>`;
            }
            
            detailsHTML += `
                  </div>
                </div>
              </td>
            </tr>`;
            
            mainRow += detailsHTML;
          }
          
          return mainRow;
        }).join('');
        
        // Agregar event listeners para expandir/colapsar
        document.querySelectorAll('.expandable-row').forEach(row => {
          row.addEventListener('click', function(e) {
            // No expandir si se hace clic en el select o botón
            if (e.target.closest('select') || e.target.closest('button')) return;
            
            const rowIndex = this.getAttribute('data-row-index');
            const detailsRow = document.querySelector(`.details-row[data-row-index="${rowIndex}"]`);
            const arrow = this.querySelector('span');
            
            if (detailsRow) {
              const isVisible = detailsRow.style.display !== 'none';
              detailsRow.style.display = isVisible ? 'none' : 'table-row';
              if (arrow) arrow.textContent = isVisible ? '▼' : '▲';
            }
          });
        });
        
        // Event listeners para botones de agregar nota
        document.querySelectorAll('.btn-add-note').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const lineIndex = this.getAttribute('data-line-index');
            const detailsRow = this.closest('.details-row');
            const noteForm = detailsRow.querySelector(`.note-form[data-line-index="${lineIndex}"]`);
            if (noteForm) {
              noteForm.style.display = noteForm.style.display === 'none' ? 'block' : 'none';
              if (noteForm.style.display === 'block') {
                const textarea = noteForm.querySelector('.note-textarea');
                if (textarea) textarea.focus();
              }
            }
          });
        });
        
        // Event listeners para agregar nota
        document.querySelectorAll('.btn-save-note').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const noteForm = this.closest('.note-form');
            const textarea = noteForm.querySelector('.note-textarea');
            const noteText = textarea.value.trim();
            
            if (!noteText) {
              showNotification('Por favor escribe una nota', 'error');
              return;
            }
            
            const lineIndex = parseInt(noteForm.getAttribute('data-line-index'));
            const detailsRow = noteForm.closest('.details-row');
            const rowIndex = detailsRow.getAttribute('data-row-index');
            const clientData = allItems[parseInt(rowIndex)];
            const clientId = clientData._id || clientData.id;
            
            // Guardar en el backend
            try {
              const token = localStorage.getItem('token') || sessionStorage.getItem('token');
              const response = await fetch('/api/lineas-team/notes', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  clientId: clientId,
                  lineIndex: lineIndex,
                  noteText: noteText
                })
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || 'Error al guardar la nota');
              }
              
              // Actualizar el objeto lineas_notas en allItems
              if (!clientData.lineas_notas) {
                clientData.lineas_notas = {};
              }
              if (!clientData.lineas_notas[lineIndex]) {
                clientData.lineas_notas[lineIndex] = [];
              }
              clientData.lineas_notas[lineIndex].push(result.data);
              
              // Agregar la nota visualmente
              const notesList = detailsRow.querySelector(`.notes-list[data-line-index="${lineIndex}"]`);
              const fecha = new Date(result.data.fecha).toLocaleString('es-ES', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
              });
              const autor = result.data.autor || '';
              
              // Remover mensaje "No hay notas"
              const noNotesMsg = notesList.querySelector('div[style*="No hay notas"]');
              if (noNotesMsg) noNotesMsg.remove();
              
              // Agregar nueva nota
              const newNote = document.createElement('div');
              newNote.style.cssText = 'background:#fff; border:1px solid #e5e7eb; border-radius:4px; padding:8px; font-size:13px;';
              newNote.innerHTML = `
                <div style="color:#0f172a;">${result.data.texto}</div>
                <div style="color:#94a3b8; font-size:11px; margin-top:4px;">${fecha}${autor ? ' - ' + autor : ''}</div>
              `;
              notesList.appendChild(newNote);
              
              // Limpiar y ocultar formulario
              textarea.value = '';
              noteForm.style.display = 'none';
              
              // Mostrar notificación de éxito
              showNotification('Nota guardada correctamente', 'success');
            } catch (error) {
              console.error('Error al guardar nota:', error);
              showNotification('Error al guardar la nota: ' + error.message, 'error');
            }
          });
        });
        
        // Event listeners para cancelar nota
        document.querySelectorAll('.btn-cancel-note').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const noteForm = this.closest('.note-form');
            const textarea = noteForm.querySelector('.note-textarea');
            textarea.value = '';
            noteForm.style.display = 'none';
          });
        });
        
        // Event listeners para editar nota
        document.querySelectorAll('.btn-edit-note').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const clientId = this.getAttribute('data-client-id');
            const lineIndex = parseInt(this.getAttribute('data-line-index'));
            const noteIndex = parseInt(this.getAttribute('data-note-index'));
            
            const noteItem = this.closest('.note-item');
            const noteTextDiv = noteItem.querySelector('.note-text');
            const currentText = noteTextDiv.textContent;
            
            // Crear textarea para editar
            const editArea = document.createElement('textarea');
            editArea.value = currentText;
            editArea.style.cssText = 'width:100%; min-height:60px; padding:6px; border:1px solid #e5e7eb; border-radius:4px; font-size:13px; font-family:inherit; resize:vertical;';
            
            // Crear botones de guardar/cancelar
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex; gap:6px; margin-top:6px;';
            btnContainer.innerHTML = `
              <button class="btn-save-edit" style="background:#10b981; color:#fff; border:none; padding:4px 12px; border-radius:4px; font-size:11px; cursor:pointer; font-weight:600;">Guardar</button>
              <button class="btn-cancel-edit" style="background:#64748b; color:#fff; border:none; padding:4px 12px; border-radius:4px; font-size:11px; cursor:pointer;">Cancelar</button>
            `;
            
            // Reemplazar contenido con textarea
            const originalContent = noteTextDiv.parentElement.innerHTML;
            noteTextDiv.parentElement.innerHTML = '';
            noteTextDiv.parentElement.appendChild(editArea);
            noteTextDiv.parentElement.appendChild(btnContainer);
            editArea.focus();
            
            // Cancelar edición
            btnContainer.querySelector('.btn-cancel-edit').addEventListener('click', function() {
              noteTextDiv.parentElement.innerHTML = originalContent;
              // Re-agregar event listeners
              renderTable(applyFilters(allItems));
            });
            
            // Guardar edición
            btnContainer.querySelector('.btn-save-edit').addEventListener('click', async function() {
              const newText = editArea.value.trim();
              if (!newText) {
                showNotification('La nota no puede estar vacía', 'error');
                return;
              }
              
              try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch('/api/lineas-team/notes/edit', {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify({
                    clientId: clientId,
                    lineIndex: lineIndex,
                    noteIndex: noteIndex,
                    noteText: newText
                  })
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                  throw new Error(result.message || 'Error al editar la nota');
                }
                
                // Actualizar en allItems
                const detailsRow = noteItem.closest('.details-row');
                const rowIndex = detailsRow.getAttribute('data-row-index');
                const clientData = allItems[parseInt(rowIndex)];
                if (clientData.lineas_notas && clientData.lineas_notas[lineIndex]) {
                  clientData.lineas_notas[lineIndex][noteIndex].texto = newText;
                  clientData.lineas_notas[lineIndex][noteIndex].editado = new Date().toISOString();
                }
                
                showNotification('Nota actualizada correctamente', 'success');
                
                // Re-renderizar la tabla
                renderTable(applyFilters(allItems));
              } catch (error) {
                console.error('Error al editar nota:', error);
                showNotification('Error al editar la nota: ' + error.message, 'error');
              }
            });
          });
        });
        
        // Event listeners para eliminar nota
        document.querySelectorAll('.btn-delete-note').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            
            const confirmed = await showConfirm(
              'Eliminar Nota',
              '¿Estás seguro de que deseas eliminar esta nota? Esta acción no se puede deshacer.'
            );
            
            if (!confirmed) return;
            
            const clientId = this.getAttribute('data-client-id');
            const lineIndex = parseInt(this.getAttribute('data-line-index'));
            const noteIndex = parseInt(this.getAttribute('data-note-index'));
            
            try {
              const token = localStorage.getItem('token') || sessionStorage.getItem('token');
              const response = await fetch('/api/lineas-team/notes/delete', {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  clientId: clientId,
                  lineIndex: lineIndex,
                  noteIndex: noteIndex
                })
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || 'Error al eliminar la nota');
              }
              
              // Actualizar en allItems
              const noteItem = this.closest('.note-item');
              const detailsRow = noteItem.closest('.details-row');
              const rowIndex = detailsRow.getAttribute('data-row-index');
              const clientData = allItems[parseInt(rowIndex)];
              
              if (clientData.lineas_notas && clientData.lineas_notas[lineIndex]) {
                clientData.lineas_notas[lineIndex].splice(noteIndex, 1);
              }
              
              showNotification('Nota eliminada correctamente', 'success');
              
              // Re-renderizar la tabla
              renderTable(applyFilters(allItems));
            } catch (error) {
              console.error('Error al eliminar nota:', error);
              showNotification('Error al eliminar la nota: ' + error.message, 'error');
            }
          });
        });
        
        // Event listeners para editar cliente
        document.querySelectorAll('.btn-edit-client').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const clientId = this.getAttribute('data-id');
            
            // Encontrar el cliente en allItems
            const clientData = allItems.find(item => (item._id || item.id) === clientId);
            if (!clientData) {
              showNotification('Cliente no encontrado', 'error');
              return;
            }
            
            // Crear modal de edición
            const modal = document.createElement('div');
            modal.style.cssText = `
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
              background: white;
              border-radius: 12px;
              padding: 24px;
              max-width: 600px;
              width: 90%;
              max-height: 80vh;
              overflow-y: auto;
            `;
            
            modalContent.innerHTML = `
              <h3 style="margin:0 0 20px; color:#0f172a; font-size:18px;">Editar Cliente</h3>
              <form id="edit-client-form">
                <div style="display:grid; gap:16px;">
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Nombre Cliente</label>
                    <input type="text" name="nombre_cliente" value="${clientData.nombre_cliente||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Teléfono Principal</label>
                    <input type="text" name="telefono_principal" value="${clientData.telefono_principal||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Número de Cuenta</label>
                    <input type="text" name="numero_cuenta" value="${clientData.numero_cuenta||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Cantidad de Líneas</label>
                    <input type="number" name="cantidad_lineas" value="${clientData.cantidad_lineas||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Status</label>
                    <select name="status" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                      ${STATUS_OPTIONS.map(o => `<option value="${o.val}" ${o.val === (clientData.status||'').toLowerCase() ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Día de Venta</label>
                    <input type="text" name="dia_venta" value="${clientData.dia_venta||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                  <div>
                    <label style="display:block; color:#64748b; font-size:12px; margin-bottom:4px; font-weight:600;">Día de Instalación</label>
                    <input type="text" name="dia_instalacion" value="${clientData.dia_instalacion||''}" style="width:100%; padding:8px; border:1px solid #e5e7eb; border-radius:6px; font-size:14px;">
                  </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:20px; justify-content:flex-end;">
                  <button type="button" class="btn-cancel-modal" style="background:#64748b; color:#fff; border:none; padding:8px 16px; border-radius:6px; font-size:13px; cursor:pointer;">
                    Cancelar
                  </button>
                  <button type="submit" style="background:#10b981; color:#fff; border:none; padding:8px 16px; border-radius:6px; font-size:13px; cursor:pointer; font-weight:600;">
                    Guardar Cambios
                  </button>
                </div>
              </form>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
              if (e.target === modal) {
                modal.remove();
              }
            });
            
            // Botón cancelar
            modalContent.querySelector('.btn-cancel-modal').addEventListener('click', function() {
              modal.remove();
            });
            
            // Guardar cambios
            modalContent.querySelector('#edit-client-form').addEventListener('submit', async function(e) {
              e.preventDefault();
              
              const formData = new FormData(e.target);
              // Normalizar clientId a string para evitar [object Object]
              const normalizedId = (() => {
                if (typeof clientId === 'string' && clientId && clientId !== '[object Object]') return clientId;
                try {
                  const cur = clientData || {};
                  // Intentar usar helper si existe (importado desde otro script)
                  if (typeof extractLeadId === 'function') {
                    const extracted = extractLeadId(cur);
                    if (extracted) return String(extracted).trim();
                  }
                  // Fallback manual a _id/id/$oid
                  const raw = cur._id || cur.id || cur.leadId || cur.$oid || cur.oid;
                  if (raw && typeof raw === 'object' && raw.$oid) return String(raw.$oid).trim();
                  if (raw && typeof raw === 'object' && raw._id) return String(raw._id).trim();
                  return String(raw || '').trim();
                } catch (_) {
                  return '';
                }
              })();

              const updateData = {
                id: normalizedId,
                nombre_cliente: formData.get('nombre_cliente'),
                telefono_principal: formData.get('telefono_principal'),
                numero_cuenta: formData.get('numero_cuenta'),
                cantidad_lineas: parseInt(formData.get('cantidad_lineas')) || 0,
                status: formData.get('status'),
                dia_venta: formData.get('dia_venta'),
                dia_instalacion: formData.get('dia_instalacion')
              };
              
              if (!normalizedId) {
                showNotification('ID de cliente no válido', 'error');
                return;
              }
              
              try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch('/api/lineas-team/update', {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                  throw new Error(result.message || 'Error al actualizar el cliente');
                }
                
                showNotification('Cliente actualizado correctamente', 'success');
                modal.remove();
                
                // Recargar datos
                await load();
              } catch (error) {
                console.error('Error al actualizar cliente:', error);
                showNotification('Error al actualizar el cliente: ' + error.message, 'error');
              }
            });
          });
        });
        
        // Event listeners para cambio de status de línea individual (solo si no es supervisor)
        document.querySelectorAll('.line-status-select:not([disabled])').forEach(select => {
          select.addEventListener('change', async function(e) {
            e.stopPropagation();
            
            const clientId = this.getAttribute('data-client-id');
            const lineIndex = parseInt(this.getAttribute('data-line-index'));
            const newStatus = this.value;
            
            // Obtener datos del cliente antes del try para usarlo en el catch
            const clientData = allItems.find(item => (item._id || item.id) === clientId);
            const previousStatus = clientData?.lineas_status?.[lineIndex] || 'PENDING';
            
            try {
              const token = localStorage.getItem('token') || sessionStorage.getItem('token');
              const response = await fetch('/api/lineas-team/line-status', {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                  clientId: clientId,
                  lineIndex: lineIndex,
                  status: newStatus
                })
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || 'Error al actualizar el status de la línea');
              }
              
              // Actualizar el objeto en allItems
              if (clientData) {
                if (!clientData.lineas_status) {
                  clientData.lineas_status = {};
                }
                clientData.lineas_status[lineIndex] = newStatus;
              }
              
              showNotification(`Status de línea ${lineIndex + 1} actualizado a ${newStatus}`, 'success');
              
              // Recargar datos para actualizar conteos
              await load();
            } catch (error) {
              console.error('Error al actualizar status de línea:', error);
              showNotification('Error al actualizar el status: ' + error.message, 'error');
              // Revertir el select al valor anterior
              this.value = previousStatus;
            }
          });
        });
        
        // Event listeners para eliminar cliente
        document.querySelectorAll('.btn-delete-client').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            
            const clientId = this.getAttribute('data-id');
            const clientData = allItems.find(item => (item._id || item.id) === clientId);
            const clientName = clientData?.nombre_cliente || 'este cliente';
            
            const confirmed = await showConfirm(
              'Eliminar Cliente',
              `¿Estás seguro de que deseas eliminar a <strong>${clientName}</strong>?<br><br>Esta acción no se puede deshacer y se perderán todos los datos asociados.`
            );
            
            if (!confirmed) return;
            
            try {
              const token = localStorage.getItem('token') || sessionStorage.getItem('token');
              const response = await fetch('/api/lineas-team/delete', {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id: clientId })
              });
              
              const result = await response.json();
              
              if (!response.ok || !result.success) {
                throw new Error(result.message || 'Error al eliminar el cliente');
              }
              
              showNotification('Cliente eliminado correctamente', 'success');
              
              // Recargar datos
              await load();
            } catch (error) {
              console.error('Error al eliminar cliente:', error);
              showNotification('Error al eliminar el cliente: ' + error.message, 'error');
            }
          });
        });
        
        // Ajustar espejo si existe util
        if (window.rebuildStickyHead) try{ window.rebuildStickyHead(); }catch{}
      }

      let allItems = [];
      
      // Variables para las gráficas
      let statusChart = null;
      let agentChart = null;
      
      function initCharts() {
        // Verificar que Highcharts esté disponible
        if (typeof Highcharts === 'undefined') {
          console.error('Highcharts no está cargado');
          setTimeout(initCharts, 100);
          return;
        }
        
        console.log('Inicializando gráficas Highcharts 3D...');
        
        // Gráfica 3D de distribución por estado (Pie Chart 3D)
        statusChart = Highcharts.chart('statusChart', {
          chart: {
            type: 'pie',
            options3d: {
              enabled: true,
              alpha: 75,
              beta: 0
            },
            backgroundColor: '#ffffff'
          },
          title: {
            text: null
          },
          tooltip: {
            pointFormat: '{series.name}: <b>{point.y}</b> ({point.percentage:.1f}%)'
          },
          accessibility: {
            point: {
              valueSuffix: '%'
            }
          },
          plotOptions: {
            pie: {
              allowPointSelect: true,
              cursor: 'pointer',
              depth: 60,
              innerSize: 0,
              dataLabels: {
                enabled: true,
                format: '<b>{point.name}</b>: {point.y}',
                style: {
                  color: '#000',
                  fontSize: '15px',
                  fontWeight: 'bold',
                  textOutline: 'none'
                },
                distance: 10
              },
              showInLegend: true,
              borderWidth: 0
            }
          },
          legend: {
            align: 'center',
            verticalAlign: 'bottom',
            layout: 'horizontal'
          },
          series: [{
            name: 'Cantidad',
            colorByPoint: true,
            data: [
              { name: 'Activas', y: 0, color: '#10b981' },
              { name: 'Pendientes', y: 0, color: '#3b82f6' }
            ]
          }]
        });
        console.log('Gráfica 3D de estado creada exitosamente');
        
        // Gráfica 3D de columnas por agente (Column Chart 3D)
        agentChart = Highcharts.chart('agentChart', {
          chart: {
            type: 'column',
            options3d: {
              enabled: true,
              alpha: 15,
              beta: 0,
              depth: 100,
              viewDistance: 35
            },
            backgroundColor: '#ffffff'
          },
          title: {
            text: null
          },
          xAxis: {
            categories: [],
            labels: {
              skew3d: false,
              style: {
                fontSize: '11px'
              }
            },
            gridLineWidth: 0
          },
          yAxis: {
            allowDecimals: false,
            min: 0,
            title: {
              text: null
            },
            labels: {
              enabled: false
            },
            gridLineWidth: 0
          },
          tooltip: {
            headerFormat: '<b>{point.key}</b><br>',
            pointFormat: 'Líneas: {point.y}'
          },
          plotOptions: {
            column: {
              depth: 70,
              dataLabels: {
                enabled: true,
                format: '{point.y}',
                style: {
                  color: '#000',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  textOutline: 'none'
                }
              },
              colorByPoint: false,
              color: {
                linearGradient: { x1: 0, x2: 0, y1: 0, y2: 1 },
                stops: [
                  [0, '#667eea'],
                  [0.5, '#6b7fd4'],
                  [1, '#764ba2']
                ]
              },
              borderWidth: 0,
              groupZPadding: 10
            }
          },
          legend: {
            enabled: false
          },
          series: [{
            name: 'Líneas',
            data: []
          }]
        });
        console.log('Gráfica 3D de agentes creada exitosamente');
      }
      
      function updateKPIs(items) {
        // Calcular KPIs según lógica de ESTADISTICAS-LINEAS
        // 1. Cantidad de Ventas = Total de leads/clientes
        const cantidadVentas = items.length;
        
        // 2. Contar líneas activas, pendientes y total de líneas
        let lineasActivas = 0;
        let lineasPendientes = 0;
        let cantidadLineas = 0;
        
        console.log('=== DEBUG KPIs ===');
        console.log('Total ventas (leads):', cantidadVentas);
        
        items.forEach((item, index) => {
          const cantLineas = item.cantidad_lineas || 1;
          cantidadLineas += cantLineas;
          
          // Debug: Ver estructura de datos del primer item
          if (index === 0) {
            console.log('Estructura del primer item:', {
              cantidad_lineas: item.cantidad_lineas,
              lineas_status: item.lineas_status,
              lineas_status_type: typeof item.lineas_status,
              lineas_status_isArray: Array.isArray(item.lineas_status)
            });
          }
          
          // Contar líneas por status individual
          for (let i = 0; i < cantLineas; i++) {
            let lineStatus = 'PENDING'; // Default
            
            if (item.lineas_status) {
              if (Array.isArray(item.lineas_status)) {
                lineStatus = item.lineas_status[i] || 'PENDING';
              } else if (typeof item.lineas_status === 'object') {
                lineStatus = item.lineas_status[i] || 'PENDING';
              }
            }
            
            const statusUpper = String(lineStatus).toUpperCase();
            if (statusUpper === 'ACTIVE') {
              lineasActivas++;
            } else if (statusUpper === 'PENDING') {
              lineasPendientes++;
            }
          }
        });
        
        console.log('Cantidad de Ventas:', cantidadVentas);
        console.log('Cantidad de Líneas:', cantidadLineas);
        console.log('Líneas Activas:', lineasActivas);
        console.log('Líneas Pendientes:', lineasPendientes);
        
        // Actualizar KPIs en el DOM
        document.getElementById('kpi-cantidad-ventas').textContent = cantidadVentas;
        document.getElementById('kpi-cantidad-lineas').textContent = cantidadLineas;
        document.getElementById('kpi-lineas-activas').textContent = lineasActivas;
        document.getElementById('kpi-lineas-pendientes').textContent = lineasPendientes;
        
        // Actualizar gráfica 3D de estados (Highcharts)
        if (statusChart) {
          statusChart.series[0].setData([
            { name: 'Activas', y: lineasActivas, color: '#10b981' },
            { name: 'Pendientes', y: lineasPendientes, color: '#3b82f6' }
          ]);
        }
        
        // Actualizar gráfica 3D de agentes (Highcharts)
        if (agentChart) {
          const agentStats = {};
          items.forEach(item => {
            const agente = item.agenteAsignado || item.agenteNombre || item.agente || item._collectionName || 'Sin asignar';
            const cantLineas = Number(item.cantidad_lineas || 0);
            agentStats[agente] = (agentStats[agente] || 0) + cantLineas;
          });
          
          // Ordenar y tomar top 10 agentes
          const sortedAgents = Object.entries(agentStats)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
          
          const agentLabels = sortedAgents.map(([name]) => name);
          const agentData = sortedAgents.map(([, value]) => value);
          
          agentChart.xAxis[0].setCategories(agentLabels);
          agentChart.series[0].setData(agentData);
        }
      }
      
      async function load(){
        allItems = await fetchData();
        const filteredItems = applyFilters(allItems);
        updateKPIs(filteredItems);
        renderTable(filteredItems);
      }

      const btnBuscar = document.getElementById('btnBuscar');
      if (btnBuscar) btnBuscar.addEventListener('click', ()=>{ 
        const filtered = applyFilters(allItems);
        updateKPIs(filtered);
        renderTable(filtered);
      });
      const btnReset = document.getElementById('btnReset');
      if (btnReset) btnReset.addEventListener('click', ()=>{
        if ($('#q')) $('#q').value = '';
        if ($('#qs')) $('#qs').value = '';
        const filtered = applyFilters(allItems);
        updateKPIs(filtered);
        renderTable(filtered);
      });

      // No hay campos de formulario adicionales

      // Live filtering from quick controls
      const q = $('#q');
      const qs = $('#qs');
      const agentFilter = $('#agentFilter');
      const dateFrom = $('#dateFrom');
      const dateTo = $('#dateTo');
      const btnClearDates = $('#btnClearDates');
      
      if (q) q.addEventListener('input', ()=> {
        const filtered = applyFilters(allItems);
        updateKPIs(filtered);
        renderTable(filtered);
      });
      if (qs) qs.addEventListener('change', ()=> {
        const filtered = applyFilters(allItems);
        updateKPIs(filtered);
        renderTable(filtered);
      });
      if (agentFilter) agentFilter.addEventListener('change', ()=> {
        const filtered = applyFilters(allItems);
        updateKPIs(filtered);
        renderTable(filtered);
      });
      if (dateFrom) dateFrom.addEventListener('change', ()=> {
        const filtered = applyFilters(allItems);
        updateKPIs(filtered);
        renderTable(filtered);
      });
      if (dateTo) dateTo.addEventListener('change', ()=> {
        const filtered = applyFilters(allItems);
        updateKPIs(filtered);
        renderTable(filtered);
      });
      if (btnClearDates) btnClearDates.addEventListener('click', ()=> {
        if (dateFrom) dateFrom.value = '';
        if (dateTo) dateTo.value = '';
        const filtered = applyFilters(allItems);
        updateKPIs(filtered);
        renderTable(filtered);
      });

      // Detect supervisor por usuario y marcar por defecto
      let defaultSupervisor = '';
      let agentsList = [];
      try {
        const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
        const name = String(user.supervisor||user.username||'').toUpperCase();
        const role = String(user.role||'').toLowerCase();
        
        if (name.includes('JONATHAN')) {
          defaultSupervisor = 'JONATHAN F';
          agentsList = ['VICTOR HURTADO','EDWARD RAMIREZ','CRISTIAN RIVERA','ANDREA ARDON','OSCAR RIVERA','JOCELYN REYES','NANCY LOPEZ','MELANIE HURTADO','ALEXIS RODRIGUEZ','DENNIS VASQUEZ','CESAR CLAROS','KARLA ORELLANA','KATHERINE LOPEZ','DIEGO FLORES'];
        } else if (name.includes('GUTIERREZ') || name.includes('LUIS')) {
          defaultSupervisor = 'LUIS G';
          agentsList = ['DANIEL DEL CID','FERNANDO BELTRAN','KARLA RODRIGUEZ','KARLA PONCE','JOCELYN REYES','JONATHAN GARCIA','NANCY LOPEZ','MELANIE HURTADO','ALEXIS RODRIGUEZ','JOSUE HERNANDEZ'];
        }
        
        // Poblar filtro de agentes si es supervisor
        if (role.includes('supervisor') && agentFilter && agentsList.length > 0) {
          agentFilter.innerHTML = '<option value="">AGENTE: Todos</option>' + 
            agentsList.map(a => `<option value="${a}">${a}</option>`).join('');
        }
      } catch {}
      // Prefiltro aplicado en applyFilters sin mostrar controles

      // Toggle filters panel
      // No hay panel de filtros
      buildHeaders();

      // Guardar cambios de STATUS (delegado)
      const tbody = document.getElementById('costumer-tbody');
      if (tbody) {
        tbody.addEventListener('change', async (e)=>{
          const sel = e.target.closest('select.status-select');
          if (!sel) return;
          if (!canEditStatus()) { alert('No tienes permisos para cambiar el STATUS.'); return; }
          const id = sel.getAttribute('data-id');
          const status = sel.value;
          const prev = sel.getAttribute('data-prev') || '';
          console.log('[STATUS UPDATE] Enviando:', { id, status, prev });
          if (!id) { alert('Error: ID del registro no encontrado'); return; }
          sel.disabled = true;
          try{
            const res = await fetch(STATUS_ENDPOINT, {
              method: STATUS_METHOD,
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id, status, statusUpper: String(status||'').toUpperCase() })
            });
            if (!res.ok) {
              const errData = await res.json().catch(()=>({}));
              console.error('[STATUS] Response error:', errData);
              throw new Error(errData.message || 'HTTP '+res.status);
            }
            sel.setAttribute('data-prev', status);
            // Refetch para asegurar persistencia real al recargar
            await load();
          }catch(err){
            console.error('[STATUS] error', err);
            alert('No se pudo actualizar el STATUS');
            if (prev) sel.value = prev;
          }finally{
            sel.disabled = false;
          }
        });
      }

      load();
    });
  </script>
</body>
</html>
