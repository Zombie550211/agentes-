<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comisiones - CRM</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="js/fetch-interceptor.js" defer></script>
    <script src="js/sidebar-loader.js" defer></script>
    <style>
        html, body { height: 100%; overflow-x: hidden; }
        .layout { min-height: 100vh; display: flex; }
        .main-content { flex: 1; margin-left: 260px; width: calc(100% - 260px); }
        @media (max-width: 600px) { .main-content { margin-left: 0; width: 100%; } }

        .agent-premium {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-light: #f8fafc;
            --bg-card: #ffffff;
            --text-dark: #1e293b;
            --text-gray: #64748b;
            --border: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 20px;
        }

        .agent-premium .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .agent-premium .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .agent-premium .header-content h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .agent-premium .header-content p {
            color: var(--text-gray);
            font-size: 1rem;
        }

        .agent-premium .badge-role {
            background: var(--primary);
            color: white;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 1px;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .agent-premium .grid-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 1024px) {
            .agent-premium .grid-main { grid-template-columns: 1fr; }
        }

        .agent-premium .card-commission {
            background: linear-gradient(135deg, #fff5e6 0%, #fffbf0 100%);
            border-radius: 24px;
            padding: 40px;
            border: 2px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        .agent-premium .card-commission::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .agent-premium .commission-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .agent-premium .commission-label {
            font-size: 0.95rem;
            color: var(--text-gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .agent-premium .commission-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            animation: agentPremiumFloat 3s ease-in-out infinite;
            position: relative;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes agentPremiumFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .agent-premium .wallet-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .agent-premium .wallet-base {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .agent-premium .wallet-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            background: linear-gradient(180deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 0 0 20px 20px;
            overflow: hidden;
            transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.3;
        }

        .agent-premium .wallet-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: agentPremiumWave 2s ease-in-out infinite;
        }

        @keyframes agentPremiumWave {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .agent-premium .wallet-emoji {
            position: relative;
            z-index: 2;
            font-size: 2.5rem;
        }

        .agent-premium .commission-amount {
            font-size: 3.5rem;
            font-weight: 900;
            color: var(--accent);
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .agent-premium .commission-sub {
            color: var(--text-gray);
            font-size: 0.95rem;
            margin-bottom: 24px;
        }

        .agent-premium .progress-container {
            width: 100%;
            margin-top: 30px;
        }

        .agent-premium .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .agent-premium .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .agent-premium .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, #fbbf24 100%);
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .agent-premium .card-stats {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .agent-premium .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .agent-premium .stat-item {
            border-bottom: 1px solid var(--border);
            padding-bottom: 30px;
        }

        .agent-premium .stat-item:nth-child(odd) {
            border-right: 1px solid var(--border);
            padding-right: 30px;
        }

        @media (max-width: 600px) {
            .agent-premium .stats-grid { grid-template-columns: 1fr; }
            .agent-premium .stat-item:nth-child(odd) { border-right: none; padding-right: 0; }
        }

        .agent-premium .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .agent-premium .stat-label {
            font-size: 0.9rem;
            color: var(--text-gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .agent-premium .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .agent-premium .stat-sub {
            font-size: 0.85rem;
            color: var(--text-gray);
        }

        .agent-premium .card-activity {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 40px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            grid-column: 1 / -1;
        }

        .agent-premium .activity-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 24px;
            color: var(--text-dark);
        }
    </style>
</head>
<body class="bg-gray-50 auto-hide-sidebar">
    <script>
        // Verificar acceso para administradores, agentes y vendedores
        (async function checkAccess() {
            try {
                const response = await fetch('/api/auth/me');
                const userData = await response.json();
                
                if (!userData.user || !userData.user.role) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const role = String(userData.user.role || '').toLowerCase();
                const isAllowed = role.includes('admin') || role.includes('administrador') || 
                                role.includes('backoffice') || role.includes('agente') || 
                                role.includes('vendedor') || role.includes('agent') || 
                                role.includes('seller');
                
                if (!isAllowed) {
                    document.body.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div style="text-align: center; color: white; padding: 40px;">
                                <div style="font-size: 60px; margin-bottom: 20px;">üîí</div>
                                <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">Acceso Denegado</h1>
                                <p style="font-size: 18px; opacity: 0.9; margin-bottom: 30px;">No tienes permisos para acceder a esta p√°gina</p>
                                <a href="/" style="display: inline-block; background: white; color: #667eea; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.3s;">
                                    Volver al Inicio
                                </a>
                            </div>
                        </div>
                    `;
                    return;
                }
            } catch (error) {
                console.error('Error verificando acceso:', error);
                window.location.href = '/login.html';
            }
        })();
    </script>

    <div class="layout">
        <nav class="sidebar sidebar-inicio" data-active="comisiones"></nav>
        <main class="main-content">
            <div id="root"></div>
        </main>
    </div>

    <script type="text/babel">
        const { useState } = React;

        const getMetaFromPoints = (points) => {
            const p = (typeof points === 'number' ? points : parseFloat(points || 0)) || 0;

            if (p >= 31) return 'META 4';
            if (p >= 26) return 'META 3';
            if (p >= 21) return 'META 2';
            if (p >= 17) return 'META 1';
            return 'SIN META';
        };

        const getProgressFromPoints = (points) => {
            const p = (typeof points === 'number' ? points : parseFloat(points || 0)) || 0;

            if (p >= 31) return 100;
            if (p >= 26) return Number((Math.min(100, Math.max(0, ((p - 26) / (31 - 26)) * 100))).toFixed(2));
            if (p >= 21) return Number((Math.min(100, Math.max(0, ((p - 21) / (26 - 21)) * 100))).toFixed(2));
            if (p >= 17) return Number((Math.min(100, Math.max(0, ((p - 17) / (21 - 17)) * 100))).toFixed(2));
            return Number((Math.min(100, Math.max(0, (p / 17) * 100))).toFixed(2));
        };

        const getCommissionFromPoints = (points) => {
            const p = (typeof points === 'number' ? points : parseFloat(points || 0)) || 0;
            const base = Math.floor(p);
            const frac = Number((p - base).toFixed(2));

            let rate = 0;
            if (base >= 31) rate = 18;
            else if (base >= 26) rate = 15;
            else if (base >= 21) rate = 12;
            else if (base >= 17) rate = 6;

            let bonus = 0;
            if (p >= 17.85) {
                if (frac >= 0.85) bonus = 4;
                else if (frac >= 0.80) bonus = 4;
                else if (frac >= 0.75) bonus = 3;
                else if (frac >= 0.50) bonus = 3;
                else if (frac >= 0.35) bonus = 2;
                else if (frac >= 0.25) bonus = 2;
            }

            return (base * rate) + bonus;
        };

        const formatUsd = (amount) => {
            const n = (typeof amount === 'number' ? amount : parseFloat(amount || 0)) || 0;
            return `$${n.toLocaleString('es-ES', { maximumFractionDigits: 0 })}`;
        };

        // Normalizar nombre: solo primer nombre + primer apellido
        const normalizeName = (fullName) => {
            if (!fullName) return '';
            const parts = String(fullName).trim().split(/\s+/).filter(Boolean);
            if (parts.length === 0) return '';
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
            // Primer nombre + primer apellido (asumiendo que el apellido es la √∫ltima palabra)
            const firstName = parts[0];
            const lastName = parts[parts.length - 1];
            const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
            return `${capitalize(firstName)} ${capitalize(lastName)}`;
        };

        // Obtener iniciales del nombre (m√°ximo 4 letras)
        const getInitials = (fullName) => {
            if (!fullName) return '??';
            const parts = String(fullName).trim().split(/\s+/).filter(Boolean);
            if (parts.length === 0) return '??';
            // Tomar solo las primeras 2 palabras para las iniciales
            return parts.slice(0, 2).map(n => n[0]?.toUpperCase() || '').join('');
        };

        // Comisi√≥n para Team Lineas (diferente f√≥rmula)
        const getCommissionLineas = (points) => {
            const p = (typeof points === 'number' ? points : parseFloat(points || 0)) || 0;
            const base = Math.floor(p);
            
            // Tabla de comisiones Team Lineas
            // META 1: 17 pts = $5/pto
            // META 2: 21 pts = $8/pto
            // META 3: 26 pts = $10/pto
            // META 4: 31 pts = $12/pto
            let rate = 0;
            if (base >= 31) rate = 12;
            else if (base >= 26) rate = 10;
            else if (base >= 21) rate = 8;
            else if (base >= 17) rate = 5;

            return base * rate;
        };

        const CommissionDashboard = () => {
            const [activeView, setActiveView] = useState('agent');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [agents, setAgents] = useState([]);
            const [agentsLineas, setAgentsLineas] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [currentAgent, setCurrentAgent] = useState(null);
            const [isAgentUser, setIsAgentUser] = useState(false);
            const [selectedAgent, setSelectedAgent] = useState(null);
            const [isAgentModalOpen, setIsAgentModalOpen] = useState(false);
            const longPressRef = React.useRef(null);
            const longPressTargetRef = React.useRef(null);
            const isAdminUser = (() => {
                const roleRaw = String(currentUser?.role || '').toLowerCase();
                return roleRaw.includes('admin') || roleRaw.includes('administrador');
            })();

            const loadAgentsFromDB = async () => {
                try {
                    console.log('Cargando agentes desde API...');
                    
                    // Cargar agentes regulares
                    const response = await fetch('/api/comisiones/agentes-mes');
                    console.log('Respuesta agentes-mes status:', response.status);
                    
                    // Cargar agentes de Team Lineas desde BD separada
                    const responseLineas = await fetch('/api/comisiones/agentes-lineas');
                    console.log('Respuesta agentes-lineas status:', responseLineas.status);
                    
                    if (!response.ok) {
                        console.error('Error en respuesta agentes-mes:', response.statusText);
                    }
                    
                    const data = await response.json();
                    const dataLineas = responseLineas.ok ? await responseLineas.json() : { data: [] };
                    
                    console.log('Datos agentes regulares:', data);
                    console.log('Datos Team Lineas:', dataLineas);
                    
                    // La API retorna agentes consolidados
                    const agentes = data.data || data.agentes || [];
                    
                    if (Array.isArray(agentes) && agentes.length > 0) {
                        console.log('Primer agente estructura:', agentes[0]);
                        
                        // Mapear los datos de la API a la estructura esperada
                        const agentesProcesados = agentes.map((agent, idx) => {
                            const agentName = String(agent.nombre || agent.name || '').toLowerCase();
                            let supervisor = '';
                            const pointsValue = parseFloat((agent.puntos || agent.points || 0).toFixed(2));
                            
                            // Asignar supervisor basado en el nombre del agente
                            if (agentName.includes('victor') || agentName.includes('edward') || agentName.includes('cristian') || 
                                agentName.includes('oscar') || agentName.includes('jocelyn') || agentName.includes('nancy') ||
                                agentName.includes('melanie') || agentName.includes('alexis') || agentName.includes('dennis')) {
                                supervisor = 'JONATHAN F';
                            } else if (agentName.includes('daniel') || agentName.includes('fernando') || agentName.includes('karla') || 
                                      agentName.includes('jonathan') || agentName.includes('luis') || agentName.includes('manuel') || agentName.includes('tatiana')) {
                                supervisor = 'LUIS G';
                            }
                            
                            const rawName = agent.nombre || agent.name || agent.agenteNombre || `Agente ${idx + 1}`;
                            const normalizedName = normalizeName(rawName);
                            
                            return {
                                id: String(agent.id || agent._id || idx),
                                name: normalizedName,
                                fullName: rawName,
                                sales: agent.ventas || agent.sales || 0,
                                points: pointsValue,
                                pendingSales: agent.pendientes || agent.pending || agent.pendingSales || 0,
                                commission: getCommissionFromPoints(pointsValue),
                                score: Math.round(pointsValue * 100),
                                meta: getMetaFromPoints(pointsValue),
                                progress: getProgressFromPoints(pointsValue),
                                email: agent.email || '',
                                phone: agent.phone || agent.telefono || '',
                                team: agent.team || agent.equipo || 'General',
                                supervisor: supervisor
                            };
                        });
                        
                        console.log('Agentes procesados:', agentesProcesados);
                        
                        // Todos los agentes regulares van a "otros" (sin Team Lineas)
                        setAgents(agentesProcesados.sort((a, b) => b.sales - a.sales));
                    } else {
                        console.warn('No hay agentes regulares en la respuesta');
                    }
                    
                    // Procesar agentes de Team Lineas desde el endpoint dedicado
                    const agentesLineas = dataLineas.data || [];
                    if (Array.isArray(agentesLineas) && agentesLineas.length > 0) {
                        console.log('Agentes Team Lineas desde BD:', agentesLineas);
                        
                        const lineasProcesados = agentesLineas.map((agent, idx) => {
                            const rawName = agent.nombre || agent.name || `Agente Lineas ${idx + 1}`;
                            const normalizedName = normalizeName(rawName);
                            const lineasWireless = Number(agent.lineasWireless || agent.wirelessLines || 0);
                            const lineasSinWireless = Number(agent.lineasSinWireless || agent.nonWirelessLines || 0);
                            const lineasTotal = Number(agent.lineasTotal || agent.totalLines || 0);
                            const comisionVal = (typeof agent.comision === 'number' ? agent.comision : parseFloat(agent.comision || agent.commission || 0)) || 0;
                            
                            return {
                                id: String(agent.id || agent._id || `lineas-${idx}`),
                                name: normalizedName,
                                fullName: rawName,
                                sales: agent.ventas || agent.sales || 0,
                                pendingSales: agent.pendientes || 0,
                                // Team L√≠neas no maneja comisi√≥n por puntos
                                points: 0,
                                commission: comisionVal,
                                score: 0,
                                meta: 'TEAM LINEAS',
                                progress: 0,
                                supervisor: agent.supervisor || '',
                                lineasWireless,
                                lineasSinWireless,
                                lineasTotal,
                                isLineas: true
                            };
                        }).sort((a, b) => b.sales - a.sales);
                        
                        console.log('Team Lineas procesados:', lineasProcesados.length, lineasProcesados);
                        setAgentsLineas(lineasProcesados);
                    } else {
                        console.warn('No hay agentes de Team Lineas en la respuesta');
                    }
                } catch (error) {
                    console.error('Error cargando agentes:', error);
                }
            };

            // Cargar agentes desde BD y obtener usuario actual
            React.useEffect(() => {
                loadAgentsFromDB();
                getCurrentUser();
            }, []);

            const closeAgentModal = () => {
                setIsAgentModalOpen(false);
                setSelectedAgent(null);
            };

            const startLongPress = (agent, source) => {
                if (!isAdminUser) return;
                try {
                    if (longPressRef.current) clearTimeout(longPressRef.current);
                } catch (_) {}
                longPressTargetRef.current = source || null;
                longPressRef.current = setTimeout(() => {
                    setSelectedAgent(agent);
                    setIsAgentModalOpen(true);
                }, 3000);
            };

            const cancelLongPress = (source) => {
                try {
                    if (source && longPressTargetRef.current && source !== longPressTargetRef.current) return;
                    if (longPressRef.current) clearTimeout(longPressRef.current);
                } catch (_) {}
                longPressRef.current = null;
                longPressTargetRef.current = null;
            };

            React.useEffect(() => {
                const onKeyDown = (e) => {
                    if (e && e.key === 'Escape') closeAgentModal();
                };
                window.addEventListener('keydown', onKeyDown);
                return () => window.removeEventListener('keydown', onKeyDown);
            }, []);

            const AgentDashboardView = ({ agentOverride, userOverride }) => {
                const agentData = agentOverride || currentAgent;
                const userData = userOverride || currentUser;

                if (!agentData) {
                    return (
                        <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                            <div className="text-center">
                                <p className="text-gray-600 text-lg">Cargando datos...</p>
                            </div>
                        </div>
                    );
                }

                const sales = agentData?.sales || 0;
                const points = (typeof agentData?.points === 'number' ? agentData.points : parseFloat(agentData?.points || 0)) || 0;
                const percent = getProgressFromPoints(points);
                const totalMoney = getCommissionFromPoints(points);
                const clamp01 = (n) => Math.min(1, Math.max(0, n));
                const getScaleBase = (p) => {
                    if (p >= 31) return 31;
                    if (p >= 26) return 26;
                    if (p >= 21) return 21;
                    if (p >= 17) return 17;
                    return 0;
                };
                const scaleBase = getScaleBase(points);
                const scaleLabel = scaleBase ? `Escala ${scaleBase}` : 'Sin escala';
                const scaleBars = [
                    { key: 's17', label: 'Escala 17-20', min: 17, max: 21 },
                    { key: 's21', label: 'Escala 21-25', min: 21, max: 26 },
                    { key: 's26', label: 'Escala 26-30', min: 26, max: 31 },
                    { key: 's31', label: 'Escala 31+', min: 31, max: Infinity },
                ].map(s => {
                    let pct = 0;
                    if (s.max === Infinity) pct = points >= s.min ? 100 : 0;
                    else pct = clamp01((points - s.min) / (s.max - s.min)) * 100;
                    return Object.assign({}, s, { pct: Number(pct.toFixed(2)) });
                });
                const roleLabelRaw = String(userData?.role || 'agente').toUpperCase();
                const roleLabel = `ROL: ${roleLabelRaw}`;
                const progressFillStyle = percent >= 100
                    ? { width: `${percent}%`, background: 'linear-gradient(90deg, var(--success) 0%, #34d399 100%)' }
                    : { width: `${percent}%` };

                const pending = agentData?.pendingSales || 0;

                return (
                    <div className="agent-premium">
                        <div className="container">
                            <header className="header">
                                <div className="header-content">
                                    <h1>¬°Hola, {agentData?.name}! üëã</h1>
                                    <p>Aqu√≠ est√° tu rendimiento actual y tus ganancias</p>
                                </div>
                                <div className="badge-role">{roleLabel}</div>
                            </header>

                            <div className="grid-main">
                                <div className="card-commission">
                                    <div className="commission-content">
                                        <div className="commission-label">Comisi√≥n Estimada</div>
                                        <div className="commission-icon">
                                            <div className="wallet-container">
                                                <div className="wallet-fill" style={{ height: `${percent}%` }} />
                                                <div className="wallet-base">
                                                    <span className="wallet-emoji">üí∞</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="commission-amount">{formatUsd(totalMoney)}</div>
                                        <div className="commission-sub">Basado en tu f√≥rmula de rendimiento</div>

                                        <div className="progress-container">
                                            <div className="progress-label">
                                                <span>Progreso de Meta</span>
                                                <span style={{ color: 'var(--accent)', fontWeight: 800 }}>{scaleLabel}</span>
                                            </div>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: 10, marginTop: 8 }}>
                                                {scaleBars.map(sb => (
                                                    <div key={sb.key}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 12, fontWeight: 700, color: '#1e293b', marginBottom: 6 }}>
                                                            <span>{sb.label}</span>
                                                            <span style={{ color: 'var(--accent)', fontWeight: 800 }}>{`${sb.pct.toFixed(2)}%`}</span>
                                                        </div>
                                                        <div className="progress-bar">
                                                            <div className="progress-fill" style={{ width: `${Math.min(100, sb.pct)}%` }} />
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="card-stats">
                                    <div className="stats-grid">
                                        <div className="stat-item">
                                            <div className="stat-icon">üìä</div>
                                            <div className="stat-label">Ventas Activas</div>
                                            <div className="stat-value">{sales}</div>
                                            <div className="stat-sub">Clientes este mes</div>
                                        </div>

                                        <div className="stat-item">
                                            <div className="stat-icon">‚≠ê</div>
                                            <div className="stat-label">Puntaje Activo</div>
                                            <div className="stat-value">{points.toFixed(2)}</div>
                                            <div className="stat-sub">Nivel: Avanzado</div>
                                        </div>

                                        <div className="stat-item">
                                            <div className="stat-icon">‚úÖ</div>
                                            <div className="stat-label">Pendientes</div>
                                            <div className="stat-value">{pending}</div>
                                            <div className="stat-sub">Ventas en pending</div>
                                        </div>

                                        <div className="stat-item">
                                            <div className="stat-icon">üöÄ</div>
                                            <div className="stat-label">Escala</div>
                                            <div className="stat-value">{scaleLabel}</div>
                                            <div className="stat-sub">Escala actual</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="card-activity">
                                <div className="activity-title">Ventas Mensuales</div>
                                <svg width="100%" height="300" viewBox="0 0 900 300" style={{ maxWidth: '100%', marginTop: 20 }}>
                                    <defs>
                                        <linearGradient id="arrowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style={{ stopColor: '#6366f1', stopOpacity: 0.3 }} />
                                            <stop offset="100%" style={{ stopColor: '#f59e0b', stopOpacity: 0.8 }} />
                                        </linearGradient>
                                    </defs>
                                    <line x1="60" y1="30" x2="60" y2="250" stroke="#e2e8f0" strokeWidth="2" />
                                    <line x1="60" y1="250" x2="850" y2="250" stroke="#e2e8f0" strokeWidth="2" />

                                    <text x="45" y="255" textAnchor="end" fontSize="12" fill="#64748b">0</text>
                                    <text x="45" y="195" textAnchor="end" fontSize="12" fill="#64748b">25</text>
                                    <text x="45" y="135" textAnchor="end" fontSize="12" fill="#64748b">50</text>
                                    <text x="45" y="75" textAnchor="end" fontSize="12" fill="#64748b">75</text>

                                    <g>
                                        <rect x="80" y="190" width="35" height="60" fill="#e0e7ff" rx="4" />
                                        <text x="97.5" y="270" textAnchor="middle" fontSize="12" fontWeight="600" fill="#1e293b">Ene</text>

                                        <rect x="125" y="170" width="35" height="80" fill="#e0e7ff" rx="4" />
                                        <text x="142.5" y="270" textAnchor="middle" fontSize="12" fontWeight="600" fill="#1e293b">Feb</text>
                                        <g transform="translate(160, 155)">
                                            <line x1="0" y1="15" x2="0" y2="0" stroke="#10b981" strokeWidth="2" strokeLinecap="round" />
                                            <path d="M -4 5 L 0 0 L 4 5" stroke="#10b981" strokeWidth="2" fill="none" strokeLinejoin="round" />
                                            <text x="0" y="25" textAnchor="middle" fontSize="11" fill="#10b981" fontWeight="700">+33%</text>
                                        </g>

                                        <rect x="170" y="140" width="35" height="110" fill="#e0e7ff" rx="4" />
                                        <text x="187.5" y="270" textAnchor="middle" fontSize="12" fontWeight="600" fill="#1e293b">Mar</text>
                                        <g transform="translate(205, 120)">
                                            <line x1="0" y1="15" x2="0" y2="0" stroke="#10b981" strokeWidth="2" strokeLinecap="round" />
                                            <path d="M -4 5 L 0 0 L 4 5" stroke="#10b981" strokeWidth="2" fill="none" strokeLinejoin="round" />
                                            <text x="0" y="25" textAnchor="middle" fontSize="11" fill="#10b981" fontWeight="700">+37%</text>
                                        </g>

                                        <rect x="215" y="155" width="35" height="95" fill="#e0e7ff" rx="4" />
                                        <text x="232.5" y="270" textAnchor="middle" fontSize="12" fontWeight="600" fill="#1e293b">Abr</text>
                                        <g transform="translate(250, 135)">
                                            <line x1="0" y1="0" x2="0" y2="15" stroke="#ef4444" strokeWidth="2" strokeLinecap="round" />
                                            <path d="M -4 10 L 0 15 L 4 10" stroke="#ef4444" strokeWidth="2" fill="none" strokeLinejoin="round" />
                                            <text x="0" y="-5" textAnchor="middle" fontSize="11" fill="#ef4444" fontWeight="700">-13%</text>
                                        </g>

                                        <rect x="260" y="100" width="35" height="150" fill="#e0e7ff" rx="4" />
                                        <text x="277.5" y="270" textAnchor="middle" fontSize="12" fontWeight="600" fill="#1e293b">May</text>
                                        <g transform="translate(295, 75)">
                                            <line x1="0" y1="15" x2="0" y2="0" stroke="#10b981" strokeWidth="2" strokeLinecap="round" />
                                            <path d="M -4 5 L 0 0 L 4 5" stroke="#10b981" strokeWidth="2" fill="none" strokeLinejoin="round" />
                                            <text x="0" y="25" textAnchor="middle" fontSize="11" fill="#10b981" fontWeight="700">+58%</text>
                                        </g>

                                        <rect x="305" y="70" width="35" height="180" fill="url(#arrowGradient)" rx="4" />
                                        <text x="322.5" y="270" textAnchor="middle" fontSize="12" fontWeight="600" fill="#1e293b">Jun</text>
                                        <g transform="translate(340, 40)">
                                            <line x1="0" y1="20" x2="0" y2="0" stroke="#f59e0b" strokeWidth="3" strokeLinecap="round" />
                                            <path d="M -5 8 L 0 0 L 5 8" stroke="#f59e0b" strokeWidth="3" fill="none" strokeLinejoin="round" />
                                            <text x="0" y="32" textAnchor="middle" fontSize="11" fill="#f59e0b" fontWeight="700">+20%</text>
                                        </g>

                                        <rect x="350" y="60" width="35" height="190" fill="#e0e7ff" rx="4" />
                                        <text x="367.5" y="270" textAnchor="middle" fontSize="12" fontWeight="600" fill="#1e293b">Jul</text>
                                    </g>

                                    <g transform="translate(600, 30)">
                                        <rect width="240" height="100" fill="#ffffff" stroke="#e2e8f0" strokeWidth="1" rx="8" />
                                        <text x="12" y="25" fontSize="13" fontWeight="700" fill="#1e293b">Tendencia Mensual</text>
                                        <circle cx="20" cy="50" r="4" fill="#10b981" />
                                        <text x="32" y="54" fontSize="12" fill="#64748b">Crecimiento</text>
                                        <circle cx="20" cy="75" r="4" fill="#ef4444" />
                                        <text x="32" y="79" fontSize="12" fill="#64748b">Decrecimiento</text>
                                    </g>
                                </svg>
                            </div>
                        </div>
                    </div>
                );
            };

            const AgentViewModal = ({ agent, open, onClose }) => {
                if (!open || !agent) return null;
                const forcedUser = Object.assign({}, currentUser || {}, { role: 'agente' });
                return (
                    <div className="fixed inset-0 z-[9999]" role="dialog" aria-modal="true">
                        <div className="absolute inset-0 bg-black/50" onClick={onClose} />
                        <div className="absolute inset-0 p-4 sm:p-6 overflow-auto">
                            <div className="relative mx-auto w-full max-w-6xl">
                                <button onClick={onClose} className="absolute -top-3 -right-3 w-10 h-10 rounded-xl bg-white shadow hover:bg-gray-100 text-gray-800 z-50">‚úï</button>
                                <div className="rounded-2xl overflow-hidden">
                                    <AgentDashboardView agentOverride={agent} userOverride={forcedUser} />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const getCurrentUser = async () => {
                try {
                    // 1) Intentar desde storage (mismo criterio que sidebar-loader.js)
                    try {
                        const raw = localStorage.getItem('user') || sessionStorage.getItem('user');
                        if (raw) {
                            const parsed = JSON.parse(raw);
                            if (parsed && (parsed.username || parsed.name || parsed.email)) {
                                const userFromStorage = Object.assign({}, parsed);
                                if (!userFromStorage.username) userFromStorage.username = userFromStorage.name || userFromStorage.email || 'Usuario';
                                console.log('Usuario actual (storage):', userFromStorage);
                                setCurrentUser(userFromStorage);

                                const role = String(userFromStorage?.role || '').toLowerCase();
                                const isAgent = role.includes('agente') || role.includes('agent') || role.includes('vendedor') || role.includes('seller');
                                setIsAgentUser(isAgent);
                                return;
                            }
                        }
                    } catch (e) {}

                    // 2) Intentar desde servidor con cookies
                    try {
                        const res = await fetch('/api/auth/verify-server', { method: 'GET', credentials: 'include' });
                        if (res.ok) {
                            const data = await res.json();
                            if (data && data.authenticated && data.user) {
                                console.log('Usuario actual (verify-server):', data);
                                setCurrentUser(data.user);

                                const role = String(data.user?.role || '').toLowerCase();
                                const isAgent = role.includes('agente') || role.includes('agent') || role.includes('vendedor') || role.includes('seller');
                                setIsAgentUser(isAgent);
                                return;
                            }
                        }
                    } catch (e) {}

                    // 3) Fallback legacy
                    const response = await fetch('/api/auth/me');
                    const userData = await response.json();
                    console.log('Usuario actual (auth/me):', userData);
                    setCurrentUser(userData.user);

                    const role = String(userData.user?.role || '').toLowerCase();
                    const isAgent = role.includes('agente') || role.includes('agent') || role.includes('vendedor') || role.includes('seller');
                    setIsAgentUser(isAgent);
                } catch (error) {
                    console.error('Error obteniendo usuario:', error);
                }
            };

            React.useEffect(() => {
                // Una vez que tenemos agentes y usuario, buscar el agente actual
                const allAgents = [...agentsLineas, ...agents];
                if (currentUser && allAgents.length > 0) {
                    const normalizeText = (v) => String(v || '')
                        .trim()
                        .toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^a-z0-9]+/g, ' ')
                        .replace(/\s+/g, ' ')
                        .trim();
                    const idToString = (v) => {
                        if (v == null) return '';
                        if (typeof v === 'string' || typeof v === 'number') return String(v);
                        if (typeof v === 'object') {
                            if (v.$oid) return String(v.$oid);
                            if (v.oid) return String(v.oid);
                            if (typeof v.toHexString === 'function') return String(v.toHexString());
                            if (typeof v.toString === 'function') return String(v.toString());
                        }
                        return String(v);
                    };
                    const isNameMatch = (agentName, candidateName) => {
                        const a = normalizeText(agentName);
                        const c = normalizeText(candidateName);
                        if (!a || !c) return false;
                        if (a === c) return true;
                        if (a.includes(c) || c.includes(a)) return true;
                        const aTokens = new Set(a.split(/\s+/).filter(t => t.length > 2));
                        const cTokens = c.split(/\s+/).filter(t => t.length > 2);
                        if (cTokens.length === 0) return false;
                        return cTokens.every(t => aTokens.has(t));
                    };
                    const roleNow = String(currentUser?.role || '').toLowerCase();
                    const isAgentNow = roleNow.includes('agente') || roleNow.includes('agent') || roleNow.includes('vendedor') || roleNow.includes('seller');
                    const userId = idToString(currentUser.id || currentUser._id);
                    const userEmail = currentUser.email;
                    const userNameCandidates = [
                        currentUser.username,
                        currentUser.name,
                        currentUser.nombre,
                        currentUser.fullName,
                    ].filter(Boolean).map(normalizeText);

                    const fallbackAgent = {
                        id: userId || 'me',
                        name: currentUser.name || currentUser.username || currentUser.email || 'Mi Usuario',
                        sales: 0,
                        points: 0,
                        pendingSales: 0,
                        commission: 0,
                        score: 0,
                        meta: getMetaFromPoints(0),
                        progress: getProgressFromPoints(0),
                        email: userEmail || '',
                        phone: '',
                        team: currentUser.team || 'General',
                        supervisor: ''
                    };

                    const agentFound = allAgents.find(a => {
                        if (!a) return false;
                        const agentId = idToString(a.id || a._id);
                        const agentEmail = a.email;
                        const agentName = a.name;

                        if (userId && agentId && agentId === userId) return true;
                        if (userEmail && agentEmail && normalizeText(agentEmail) === normalizeText(userEmail)) return true;
                        if (agentName && userNameCandidates.length > 0) return userNameCandidates.some(c => isNameMatch(agentName, c));
                        return false;
                    });

                    const agentFoundStrong = (() => {
                        const byId = allAgents.find(a => {
                            if (!a) return false;
                            const agentId = idToString(a.id || a._id);
                            return userId && agentId && agentId === userId;
                        });
                        if (byId) return byId;

                        const byEmail = allAgents.find(a => {
                            if (!a) return false;
                            return userEmail && a.email && normalizeText(a.email) === normalizeText(userEmail);
                        });
                        if (byEmail) return byEmail;

                        const byNameExact = allAgents.find(a => {
                            if (!a) return false;
                            const agentName = a.name;
                            if (!agentName || userNameCandidates.length === 0) return false;
                            const n = normalizeText(agentName);
                            return userNameCandidates.includes(n);
                        });
                        if (byNameExact) return byNameExact;

                        return null;
                    })();

                    const agentPicked = isAgentNow ? agentFoundStrong : (agentFoundStrong || agentFound);
                    if (isAgentNow) setCurrentAgent(agentPicked || fallbackAgent);
                    else setCurrentAgent(agentPicked || allAgents[0] || null);

                    try {
                        console.log('[Comisiones] match agente:', {
                            isAgentNow,
                            user: { id: userId, email: userEmail, names: userNameCandidates },
                            found: agentPicked ? { id: agentPicked.id, name: agentPicked.name, email: agentPicked.email, pendingSales: agentPicked.pendingSales } : null,
                            fallback: { id: fallbackAgent.id, name: fallbackAgent.name }
                        });
                    } catch (e) {}
                }
            }, [currentUser, agents, agentsLineas]);

            const AdminDashboard = () => (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white border-b sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
                                        <span className="text-white text-xl">üí∞</span>
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold text-gray-900">Comisiones</h1>
                                        <p className="text-sm text-gray-500">Panel de Administraci√≥n</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                                        <input 
                                            type="text" 
                                            placeholder="Buscar agente..."
                                            className="pl-10 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        />
                                    </div>
                                    <button className="p-2 hover:bg-gray-100 rounded-lg">
                                        <span className="text-xl">üîî</span>
                                    </button>
                                    <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
                                        + Agregar Agente
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Navigation Tabs */}
                    <div className="bg-white border-b">
                        <div className="max-w-7xl mx-auto px-6">
                            <div className="flex gap-8">
                                {[
                                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                                    { id: 'agents', label: 'Agentes', icon: 'üë•' },
                                    { id: 'reports', label: 'Reportes', icon: 'üìÑ' },
                                    { id: 'analytics', label: 'Analytics', icon: 'üìà' },
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`flex items-center gap-2 px-1 py-4 border-b-2 transition-colors ${
                                            activeTab === tab.id
                                                ? 'border-indigo-600 text-indigo-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700'
                                        }`}
                                    >
                                        <span className="text-lg">{tab.icon}</span>
                                        <span className="font-medium text-sm">{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="max-w-7xl mx-auto px-6 py-8">
                        {activeTab === 'dashboard' && (
                            <>
                                {/* Agent Cards */}
                                <div className="mb-8">
                                    <h2 className="text-lg font-bold text-gray-900 mb-4">Todos los Agentes ({agents.length})</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {agents.map(agent => (
                                            <div
                                                key={agent.id}
                                                className="bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-shadow relative"
                                                onMouseDown={() => startLongPress(agent, agent.id)}
                                                onMouseUp={() => cancelLongPress(agent.id)}
                                                onMouseLeave={() => cancelLongPress(agent.id)}
                                                onTouchStart={() => startLongPress(agent, agent.id)}
                                                onTouchEnd={() => cancelLongPress(agent.id)}
                                                onTouchCancel={() => cancelLongPress(agent.id)}
                                            >
                                                <button 
                                                    onClick={() => setAgents(agents.filter(a => a.id !== agent.id))}
                                                    onMouseDown={(e) => { try { e.stopPropagation(); } catch(_) {} cancelLongPress(agent.id); }}
                                                    onTouchStart={(e) => { try { e.stopPropagation(); } catch(_) {} cancelLongPress(agent.id); }}
                                                    className="absolute top-3 right-3 bg-red-100 text-red-600 p-1.5 rounded-lg hover:bg-red-200 transition-colors"
                                                    title="Eliminar agente"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                                <div className="flex items-start justify-between mb-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                                            <span className="font-bold text-indigo-600">{getInitials(agent.fullName || agent.name)}</span>
                                                        </div>
                                                        <div>
                                                            <h3 className="font-semibold text-gray-900">{agent.name}</h3>
                                                            <p className="text-sm text-gray-500">{agent.sales} ventas</p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="space-y-3 mb-4">
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Ventas</span>
                                                        <span className="font-semibold text-gray-900">{agent.sales}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Puntaje</span>
                                                        <span className="font-semibold text-gray-900">{agent.points.toFixed(2)}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Comisi√≥n</span>
                                                        <span className="font-semibold text-green-600">{formatUsd(agent.commission)}</span>
                                                    </div>
                                                </div>

                                                <div className="mb-4">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-sm text-gray-600">Progreso</span>
                                                        <span className="text-sm font-medium text-gray-900">{`${Math.min(100, agent.progress || 0).toFixed(2)}%`}</span>
                                                    </div>
                                                    <div className="bg-gray-200 rounded-full h-2">
                                                        <div 
                                                            className={`h-2 rounded-full ${agent.progress >= 90 ? 'bg-green-500' : agent.progress >= 70 ? 'bg-yellow-500' : 'bg-red-500'}`}
                                                            style={{ width: `${Math.min(100, agent.progress || 0)}%` }}
                                                        />
                                                    </div>
                                                </div>

                                                <div className="flex items-center justify-between pt-4 border-t">
                                                    <span className={`text-xs px-2 py-1 rounded-full ${
                                                        agent.progress >= 90 ? 'bg-green-100 text-green-700' :
                                                        agent.progress >= 70 ? 'bg-yellow-100 text-yellow-700' :
                                                        'bg-red-100 text-red-700'
                                                    }`}>
                                                        {agent.progress >= 90 ? '‚Üë 10%' : agent.progress >= 70 ? '‚Üì 12%' : '‚Üë 1%'}
                                                    </span>
                                                    <span className="text-xs text-gray-500">vs mes anterior</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}

                        <AgentViewModal agent={selectedAgent} open={isAgentModalOpen} onClose={closeAgentModal} />

                        {activeTab === 'agents' && (
                            <div>
                                <div className="flex items-center justify-between mb-6">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-900">Agentes - Team Lineas</h2>
                                        <p className="text-gray-600 mt-1">Administra los agentes de Lineas ({agentsLineas.length})</p>
                                    </div>
                                    <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 flex items-center gap-2">
                                        <span>‚ûï</span>
                                        Agregar Agente
                                    </button>
                                </div>

                                {agentsLineas.length === 0 ? (
                                    <div className="bg-white rounded-xl border border-gray-200 p-12 text-center">
                                        <p className="text-gray-600 text-lg">No hay agentes en Team Lineas</p>
                                    </div>
                                ) : (
                                    <div className="space-y-8">
                                        {/* Team Jonathan F */}
                                        <div>
                                            <h3 className="text-xl font-bold text-gray-900 mb-4">üìû TEAM JONATHAN F</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                                {agentsLineas
                                                    .filter(agent => agent.supervisor === 'JONATHAN F')
                                                    .map(agent => (
                                                        <div key={agent.id} className="bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                                                            <div className="flex items-start justify-between mb-4">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                                                        <span className="font-bold text-indigo-600">{getInitials(agent.fullName || agent.name)}</span>
                                                                    </div>
                                                                    <div>
                                                                        <h3 className="font-semibold text-gray-900">{agent.name}</h3>
                                                                        <p className="text-sm text-gray-500">{agent.sales} ventas</p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className="space-y-3 mb-4">
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">Ventas</span>
                                                                    <span className="font-semibold text-gray-900">{agent.sales}</span>
                                                                </div>
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">L√≠neas Wireless</span>
                                                                    <span className="font-semibold text-gray-900">{agent.lineasWireless || 0}</span>
                                                                </div>
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">L√≠neas sin Wireless</span>
                                                                    <span className="font-semibold text-gray-900">{agent.lineasSinWireless || 0}</span>
                                                                </div>
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">Comisi√≥n</span>
                                                                    <span className="font-semibold text-green-600">{formatUsd(agent.commission)}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                            </div>
                                        </div>

                                        {/* Team Luis G */}
                                        <div>
                                            <h3 className="text-xl font-bold text-gray-900 mb-4">üìû TEAM LUIS G</h3>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                                {agentsLineas
                                                    .filter(agent => agent.supervisor === 'LUIS G')
                                                    .map(agent => (
                                                        <div key={agent.id} className="bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                                                            <div className="flex items-start justify-between mb-4">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                                                        <span className="font-bold text-purple-600">{getInitials(agent.fullName || agent.name)}</span>
                                                                    </div>
                                                                    <div>
                                                                        <h3 className="font-semibold text-gray-900">{agent.name}</h3>
                                                                        <p className="text-sm text-gray-500">{agent.sales} ventas</p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className="space-y-3 mb-4">
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">Ventas</span>
                                                                    <span className="font-semibold text-gray-900">{agent.sales}</span>
                                                                </div>
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">L√≠neas Wireless</span>
                                                                    <span className="font-semibold text-gray-900">{agent.lineasWireless || 0}</span>
                                                                </div>
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">L√≠neas sin Wireless</span>
                                                                    <span className="font-semibold text-gray-900">{agent.lineasSinWireless || 0}</span>
                                                                </div>
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">Comisi√≥n</span>
                                                                    <span className="font-semibold text-green-600">{formatUsd(agent.commission)}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'reports' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 mb-6">Reportes de Comisiones</h2>

                                {(() => {
                                    const allAgents = [...agentsLineas, ...agents];
                                    return (
                                        <div className="grid grid-cols-4 gap-6 mb-6">
                                            <div className="bg-white p-6 rounded-xl border border-gray-200">
                                                <h3 className="text-sm text-gray-600 mb-2">Ventas Totales</h3>
                                                <p className="text-3xl font-bold text-gray-900">{allAgents.reduce((s, a) => s + (a.sales || 0), 0)}</p>
                                            </div>
                                            <div className="bg-white p-6 rounded-xl border border-gray-200">
                                                <h3 className="text-sm text-gray-600 mb-2">Puntaje Total</h3>
                                                <p className="text-3xl font-bold text-gray-900">{allAgents.reduce((s, a) => s + (parseFloat(a.points) || 0), 0).toFixed(0)}</p>
                                            </div>
                                            <div className="bg-white p-6 rounded-xl border border-gray-200">
                                                <h3 className="text-sm text-gray-600 mb-2">Comisi√≥n Total</h3>
                                                <p className="text-3xl font-bold text-green-600">{formatUsd(allAgents.reduce((s, a) => s + (parseFloat(a.commission) || 0), 0))}</p>
                                            </div>
                                            <div className="bg-white p-6 rounded-xl border border-gray-200">
                                                <h3 className="text-sm text-gray-600 mb-2">Agentes Activos</h3>
                                                <p className="text-3xl font-bold text-indigo-600">{allAgents.length}</p>
                                            </div>
                                        </div>
                                    );
                                })()}

                                <div className="bg-white rounded-xl border border-gray-200">
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agente</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ventas</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Puntaje</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Comisi√≥n</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">% del Total</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {agents.map((agent, index) => (
                                                    <tr key={agent.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 text-gray-900 font-medium">{index + 1}</td>
                                                        <td className="px-6 py-4 font-medium text-gray-900">{agent.name}</td>
                                                        <td className="px-6 py-4 text-indigo-600 font-semibold">{agent.sales}</td>
                                                        <td className="px-6 py-4 text-blue-600 font-semibold">{agent.points.toFixed(2)}</td>
                                                        <td className="px-6 py-4 text-green-600 font-semibold">{formatUsd(agent.commission)}</td>
                                                        <td className="px-6 py-4">
                                                            <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                                                {((agent.sales / agents.reduce((s, a) => s + a.sales, 0)) * 100).toFixed(1)}%
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 mb-6">Analytics</h2>

                                <div className="grid grid-cols-4 gap-6 mb-8">
                                    <div className="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-indigo-100 text-sm font-medium mb-4">Promedio Ventas</h3>
                                        <p className="text-3xl font-bold mb-1">{agents.length > 0 ? (agents.reduce((s, a) => s + (a.sales || 0), 0) / agents.length).toFixed(1) : '0'}</p>
                                        <p className="text-indigo-100 text-sm">Por Agente</p>
                                    </div>

                                    <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-green-100 text-sm font-medium mb-4">Puntaje Promedio</h3>
                                        <p className="text-3xl font-bold mb-1">{agents.length > 0 ? (agents.reduce((s, a) => s + (parseFloat(a.points) || 0), 0) / agents.length).toFixed(1) : '0'}</p>
                                        <p className="text-green-100 text-sm">Puntos Acumulados</p>
                                    </div>

                                    <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-purple-100 text-sm font-medium mb-4">Comisi√≥n Promedio</h3>
                                        <p className="text-3xl font-bold mb-1">{formatUsd(agents.length > 0 ? (agents.reduce((s, a) => s + (parseFloat(a.commission) || 0), 0) / agents.length) : 0)}</p>
                                        <p className="text-purple-100 text-sm">Por Agente</p>
                                    </div>

                                    <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-orange-100 text-sm font-medium mb-4">Score Promedio</h3>
                                        <p className="text-3xl font-bold mb-1">{agents.length > 0 ? (agents.reduce((s, a) => s + (a.score || 0), 0) / agents.length).toFixed(0) : '0'}%</p>
                                        <p className="text-orange-100 text-sm">Desempe√±o General</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-white rounded-xl border border-gray-200 p-6">
                                        <h3 className="font-semibold text-gray-900 mb-6">Top Agentes</h3>
                                        <div className="space-y-4">
                                            {[...agents].sort((a, b) => b.sales - a.sales).map((agent, index) => (
                                                <div key={agent.id} className="flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                                                        index === 0 ? 'bg-yellow-100 text-yellow-700' :
                                                        index === 1 ? 'bg-gray-100 text-gray-700' :
                                                        'bg-orange-100 text-orange-700'
                                                    }`}>
                                                        {index + 1}
                                                    </div>
                                                    <div className="flex-1">
                                                        <p className="font-medium text-gray-900">{agent.name}</p>
                                                        <p className="text-xs text-gray-500">{agent.sales} ventas ‚Ä¢ {agent.points.toFixed(2)} pts</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="font-semibold text-green-600">{formatUsd(agent.commission)}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl border border-gray-200 p-6">
                                        <h3 className="font-semibold text-gray-900 mb-6">Metas Alcanzadas</h3>
                                        <div className="space-y-4">
                                            {(() => {
                                                const allAgents = [...agentsLineas, ...agents];
                                                return [
                                                    { name: 'META 1', agents: allAgents.filter(a => a.meta === 'META 1').length, points: '17 pts', commission: '$6/pto' },
                                                    { name: 'META 2', agents: allAgents.filter(a => a.meta === 'META 2').length, points: '21 pts', commission: '$12/pto' },
                                                    { name: 'META 3', agents: allAgents.filter(a => a.meta === 'META 3').length, points: '26 pts', commission: '$15/pto' },
                                                    { name: 'META 4', agents: allAgents.filter(a => a.meta === 'META 4').length, points: '31 pts', commission: '$18/pto' },
                                                ].map((meta, index) => (
                                                <div key={index} className="border-b pb-4">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-3 h-3 rounded-full bg-${['indigo', 'green', 'purple', 'orange'][index]}-500`} />
                                                            <span className="font-medium text-gray-900">{meta.name}</span>
                                                            <span className="text-sm text-gray-600">{meta.points}</span>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="font-semibold text-gray-900">{meta.agents} agentes</p>
                                                            <p className="text-xs text-green-600">{meta.commission}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                ));
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            const AgentDashboard = () => <AgentDashboardView />;

            return (
                <div>
                    {currentUser && !isAgentUser && (
                        <div className="fixed bottom-6 right-6 z-50 bg-white shadow-lg rounded-lg p-2 border border-gray-200">
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setActiveView('admin')}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                        activeView === 'admin' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    Vista Admin
                                </button>
                                <button
                                    onClick={() => setActiveView('agent')}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                        activeView === 'agent' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    Mi Vista
                                </button>
                            </div>
                        </div>
                    )}

                    {isAgentUser ? <AgentDashboard /> : (activeView === 'admin' ? <AdminDashboard /> : <AgentDashboard />)}
                </div>
            );
        };

        ReactDOM.render(<CommissionDashboard />, document.getElementById('root'));
    </script>

    <script src="/js/user-info.js" defer></script>
    <script src="/js/logout-handler.js" defer></script>
</body>
</html>
