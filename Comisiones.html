<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comisiones - CRM</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="js/fetch-interceptor.js" defer></script>
    <script src="js/sidebar-loader.js" defer></script>
    <style>
        html, body { height: 100%; overflow-x: hidden; }
        .layout { min-height: 100vh; display: flex; }
        .main-content { flex: 1; margin-left: 260px; width: calc(100% - 260px); }
        @media (max-width: 600px) { .main-content { margin-left: 0; width: 100%; } }
    </style>
</head>
<body class="bg-gray-50 auto-hide-sidebar">
    <script>
        // Verificar acceso solo para administradores
        (async function checkAdminAccess() {
            try {
                const response = await fetch('/api/auth/me');
                const userData = await response.json();
                
                if (!userData.user || !userData.user.role) {
                    window.location.href = '/login.html';
                    return;
                }
                
                const role = String(userData.user.role || '').toLowerCase();
                const isAdmin = role.includes('admin') || role.includes('administrador') || role.includes('backoffice');
                
                if (!isAdmin) {
                    document.body.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div style="text-align: center; color: white; padding: 40px;">
                                <div style="font-size: 60px; margin-bottom: 20px;">üîí</div>
                                <h1 style="font-size: 32px; font-weight: bold; margin-bottom: 10px;">Acceso Denegado</h1>
                                <p style="font-size: 18px; opacity: 0.9; margin-bottom: 30px;">Esta p√°gina est√° reservada solo para administradores</p>
                                <a href="/" style="display: inline-block; background: white; color: #667eea; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; transition: all 0.3s;">
                                    Volver al Inicio
                                </a>
                            </div>
                        </div>
                    `;
                    return;
                }
            } catch (error) {
                console.error('Error verificando acceso:', error);
                window.location.href = '/login.html';
            }
        })();
    </script>

    <div class="layout">
        <nav class="sidebar sidebar-inicio" data-active="comisiones"></nav>
        <main class="main-content">
            <div id="root"></div>
        </main>
    </div>

    <script type="text/babel">
        const { useState } = React;

        const CommissionDashboard = () => {
            const [activeView, setActiveView] = useState('admin');
            const [activeTab, setActiveTab] = useState('dashboard');
            const [agents, setAgents] = useState([]);
            const [currentUser, setCurrentUser] = useState(null);
            const [currentAgent, setCurrentAgent] = useState(null);

            const loadAgentsFromDB = async () => {
                try {
                    console.log('Cargando agentes desde API...');
                    const response = await fetch('/api/comisiones/agentes-mes');
                    console.log('Respuesta status:', response.status);
                    
                    if (!response.ok) {
                        console.error('Error en respuesta:', response.statusText);
                        return;
                    }
                    
                    const data = await response.json();
                    console.log('Datos recibidos:', data);
                    
                    // La API retorna agentes consolidados
                    const agentes = data.data || data.agentes || [];
                    
                    if (Array.isArray(agentes) && agentes.length > 0) {
                        console.log('Primer agente estructura:', agentes[0]);
                        
                        // Mapear los datos de la API a la estructura esperada
                        const agentesProcesados = agentes.map((agent, idx) => ({
                            id: agent.id || agent._id || idx,
                            name: agent.nombre || agent.name || agent.agenteNombre || `Agente ${idx + 1}`,
                            sales: agent.ventas || agent.sales || 0,
                            points: parseFloat((agent.puntos || agent.points || 0).toFixed(2)),
                            commission: parseFloat(((agent.ventas || agent.sales || 0) * 0.1).toFixed(1)),
                            score: Math.round((agent.puntos || agent.points || 0) * 100),
                            meta: (agent.ventas || agent.sales || 0) >= 10 ? 'META CUMPLIDA' : 'META PENDIENTE',
                            progress: Math.min(100, (agent.ventas || agent.sales || 0) * 5),
                            email: agent.email || '',
                            phone: agent.phone || agent.telefono || '',
                            team: agent.team || agent.equipo || 'General'
                        }));
                        
                        console.log('Agentes procesados:', agentesProcesados);
                        setAgents(agentesProcesados);
                    } else {
                        console.warn('No hay agentes en la respuesta');
                    }
                } catch (error) {
                    console.error('Error cargando agentes:', error);
                }
            };

            // Cargar agentes desde BD y obtener usuario actual
            React.useEffect(() => {
                loadAgentsFromDB();
                getCurrentUser();
            }, []);

            const getCurrentUser = async () => {
                try {
                    const response = await fetch('/api/auth/me');
                    const userData = await response.json();
                    console.log('Usuario actual:', userData);
                    setCurrentUser(userData.user);
                } catch (error) {
                    console.error('Error obteniendo usuario:', error);
                }
            };

            React.useEffect(() => {
                // Una vez que tenemos agentes y usuario, buscar el agente actual
                if (currentUser && agents.length > 0) {
                    const username = currentUser.username || currentUser.name || '';
                    const agentFound = agents.find(a => 
                        a.name?.toLowerCase() === username.toLowerCase() ||
                        a.id === currentUser.id
                    );
                    setCurrentAgent(agentFound || agents[0]);
                }
            }, [currentUser, agents]);

            const AdminDashboard = () => (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white border-b sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center">
                                        <span className="text-white text-xl">üí∞</span>
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold text-gray-900">Comisiones</h1>
                                        <p className="text-sm text-gray-500">Panel de Administraci√≥n</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">üîç</span>
                                        <input 
                                            type="text" 
                                            placeholder="Buscar agente..."
                                            className="pl-10 pr-4 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        />
                                    </div>
                                    <button className="p-2 hover:bg-gray-100 rounded-lg">
                                        <span className="text-xl">üîî</span>
                                    </button>
                                    <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">
                                        + Agregar Agente
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Navigation Tabs */}
                    <div className="bg-white border-b">
                        <div className="max-w-7xl mx-auto px-6">
                            <div className="flex gap-8">
                                {[
                                    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                                    { id: 'agents', label: 'Agentes', icon: 'üë•' },
                                    { id: 'reports', label: 'Reportes', icon: 'üìÑ' },
                                    { id: 'analytics', label: 'Analytics', icon: 'üìà' },
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`flex items-center gap-2 px-1 py-4 border-b-2 transition-colors ${
                                            activeTab === tab.id
                                                ? 'border-indigo-600 text-indigo-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700'
                                        }`}
                                    >
                                        <span className="text-lg">{tab.icon}</span>
                                        <span className="font-medium text-sm">{tab.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="max-w-7xl mx-auto px-6 py-8">
                        {activeTab === 'dashboard' && (
                            <>
                                {/* KPIs */}
                                <div className="grid grid-cols-4 gap-6 mb-8">
                                    <div className="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-xl">üíµ</div>
                                            <span className="text-green-600 text-sm font-medium">‚Üë 12%</span>
                                        </div>
                                        <h3 className="text-gray-500 text-sm mb-1">Puntaje Total</h3>
                                        <p className="text-3xl font-bold text-gray-900">{agents.reduce((s, a) => s + (parseFloat(a.points) || 0), 0).toFixed(1)}</p>
                                    </div>

                                    <div className="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-xl">üìà</div>
                                            <span className="text-green-600 text-sm font-medium">‚Üë 8%</span>
                                        </div>
                                        <h3 className="text-gray-500 text-sm mb-1">Comisiones</h3>
                                        <p className="text-3xl font-bold text-gray-900">${(agents.reduce((s, a) => s + (parseFloat(a.commission) || 0), 0)).toFixed(1)}K</p>
                                    </div>

                                    <div className="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center text-xl">üèÜ</div>
                                            <span className="text-green-600 text-sm font-medium">‚Üë 5%</span>
                                        </div>
                                        <h3 className="text-gray-500 text-sm mb-1">Score Promedio</h3>
                                        <p className="text-3xl font-bold text-gray-900">{(agents.reduce((s, a) => s + a.score, 0) / agents.length).toFixed(0)}%</p>
                                    </div>

                                    <div className="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-xl">üéØ</div>
                                            <span className="text-green-600 text-sm font-medium">‚Üë 15%</span>
                                        </div>
                                        <h3 className="text-gray-500 text-sm mb-1">Ventas Totales</h3>
                                        <p className="text-3xl font-bold text-gray-900">{agents.reduce((s, a) => s + a.sales, 0)}</p>
                                    </div>
                                </div>

                                {/* Agent Cards */}
                                <div className="mb-8">
                                    <h2 className="text-lg font-bold text-gray-900 mb-4">Todos los Agentes ({agents.length})</h2>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                        {agents.map(agent => (
                                            <div key={agent.id} className="bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                                                <div className="flex items-start justify-between mb-4">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                                                            <span className="font-bold text-indigo-600">{agent.name.split(' ').map(n => n[0]).join('')}</span>
                                                        </div>
                                                        <div>
                                                            <h3 className="font-semibold text-gray-900">{agent.name}</h3>
                                                            <p className="text-sm text-gray-500">{agent.sales} ventas</p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="space-y-3 mb-4">
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Ventas</span>
                                                        <span className="font-semibold text-gray-900">{agent.sales}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Puntaje</span>
                                                        <span className="font-semibold text-gray-900">{agent.points.toFixed(2)}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Comisi√≥n</span>
                                                        <span className="font-semibold text-green-600">${agent.commission}K</span>
                                                    </div>
                                                </div>

                                                <div className="mb-4">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="text-sm text-gray-600">Progreso</span>
                                                        <span className="text-sm font-medium text-gray-900">{agent.progress}%</span>
                                                    </div>
                                                    <div className="bg-gray-200 rounded-full h-2">
                                                        <div 
                                                            className={`h-2 rounded-full ${agent.progress >= 90 ? 'bg-green-500' : agent.progress >= 70 ? 'bg-yellow-500' : 'bg-red-500'}`}
                                                            style={{ width: `${agent.progress}%` }}
                                                        />
                                                    </div>
                                                </div>

                                                <div className="flex items-center justify-between pt-4 border-t">
                                                    <span className={`text-xs px-2 py-1 rounded-full ${
                                                        agent.progress >= 90 ? 'bg-green-100 text-green-700' :
                                                        agent.progress >= 70 ? 'bg-yellow-100 text-yellow-700' :
                                                        'bg-red-100 text-red-700'
                                                    }`}>
                                                        {agent.progress >= 90 ? '‚Üë 10%' : agent.progress >= 70 ? '‚Üì 12%' : '‚Üë 1%'}
                                                    </span>
                                                    <span className="text-xs text-gray-500">vs mes anterior</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}

                        {activeTab === 'agents' && (
                            <div>
                                <div className="flex items-center justify-between mb-6">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-900">Gesti√≥n de Agentes</h2>
                                        <p className="text-gray-600 mt-1">Administra tu equipo de ventas</p>
                                    </div>
                                    <button className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 flex items-center gap-2">
                                        <span>‚ûï</span>
                                        Agregar Agente
                                    </button>
                                </div>

                                <div className="bg-white rounded-xl border border-gray-200">
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50 border-b">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agente</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Equipo</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ventas</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Puntaje</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Score</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Comisi√≥n</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {agents.map(agent => (
                                                    <tr key={agent.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                                                    <span className="font-semibold text-indigo-600 text-sm">{agent.name.split(' ').map(n => n[0]).join('')}</span>
                                                                </div>
                                                                <p className="font-medium text-gray-900">{agent.name}</p>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                                                {agent.team}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 text-gray-900 font-semibold">{agent.sales}</td>
                                                        <td className="px-6 py-4 text-gray-900 font-semibold">{agent.points.toFixed(2)}</td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex items-center gap-2">
                                                                <div className="flex-1 bg-gray-200 rounded-full h-2 w-16">
                                                                    <div 
                                                                        className={`h-2 rounded-full ${agent.score >= 90 ? 'bg-green-500' : agent.score >= 70 ? 'bg-yellow-500' : 'bg-red-500'}`}
                                                                        style={{ width: `${agent.score}%` }}
                                                                    />
                                                                </div>
                                                                <span className="text-sm font-medium text-gray-900">{agent.score}%</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <span className="text-green-600 font-semibold">${agent.commission}K</span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'reports' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 mb-6">Reportes de Comisiones</h2>

                                <div className="grid grid-cols-4 gap-6 mb-6">
                                    <div className="bg-white p-6 rounded-xl border border-gray-200">
                                        <h3 className="text-sm text-gray-600 mb-2">Ventas Totales</h3>
                                        <p className="text-3xl font-bold text-gray-900">{agents.reduce((s, a) => s + a.sales, 0)}</p>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-gray-200">
                                        <h3 className="text-sm text-gray-600 mb-2">Puntaje Total</h3>
                                        <p className="text-3xl font-bold text-gray-900">{agents.reduce((s, a) => s + (parseFloat(a.points) || 0), 0).toFixed(0)}</p>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-gray-200">
                                        <h3 className="text-sm text-gray-600 mb-2">Comisi√≥n Total</h3>
                                        <p className="text-3xl font-bold text-green-600">${agents.reduce((s, a) => s + (parseFloat(a.commission) || 0), 0).toFixed(1)}K</p>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border border-gray-200">
                                        <h3 className="text-sm text-gray-600 mb-2">Agentes Activos</h3>
                                        <p className="text-3xl font-bold text-indigo-600">{agents.length}</p>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl border border-gray-200">
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Agente</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ventas</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Puntaje</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Comisi√≥n</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">% del Total</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200">
                                                {agents.map((agent, index) => (
                                                    <tr key={agent.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 text-gray-900 font-medium">{index + 1}</td>
                                                        <td className="px-6 py-4 font-medium text-gray-900">{agent.name}</td>
                                                        <td className="px-6 py-4 text-indigo-600 font-semibold">{agent.sales}</td>
                                                        <td className="px-6 py-4 text-blue-600 font-semibold">{agent.points.toFixed(2)}</td>
                                                        <td className="px-6 py-4 text-green-600 font-semibold">${agent.commission}K</td>
                                                        <td className="px-6 py-4">
                                                            <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium">
                                                                {((agent.sales / agents.reduce((s, a) => s + a.sales, 0)) * 100).toFixed(1)}%
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'analytics' && (
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900 mb-6">Analytics</h2>

                                <div className="grid grid-cols-4 gap-6 mb-8">
                                    <div className="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-indigo-100 text-sm font-medium mb-4">Promedio Ventas</h3>
                                        <p className="text-3xl font-bold mb-1">{agents.length > 0 ? (agents.reduce((s, a) => s + (a.sales || 0), 0) / agents.length).toFixed(1) : '0'}</p>
                                        <p className="text-indigo-100 text-sm">Por Agente</p>
                                    </div>

                                    <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-green-100 text-sm font-medium mb-4">Puntaje Promedio</h3>
                                        <p className="text-3xl font-bold mb-1">{agents.length > 0 ? (agents.reduce((s, a) => s + (parseFloat(a.points) || 0), 0) / agents.length).toFixed(1) : '0'}</p>
                                        <p className="text-green-100 text-sm">Puntos Acumulados</p>
                                    </div>

                                    <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-purple-100 text-sm font-medium mb-4">Comisi√≥n Promedio</h3>
                                        <p className="text-3xl font-bold mb-1">${agents.length > 0 ? (agents.reduce((s, a) => s + (parseFloat(a.commission) || 0), 0) / agents.length).toFixed(1) : '0'}K</p>
                                        <p className="text-purple-100 text-sm">Por Agente</p>
                                    </div>

                                    <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
                                        <h3 className="text-orange-100 text-sm font-medium mb-4">Score Promedio</h3>
                                        <p className="text-3xl font-bold mb-1">{agents.length > 0 ? (agents.reduce((s, a) => s + (a.score || 0), 0) / agents.length).toFixed(0) : '0'}%</p>
                                        <p className="text-orange-100 text-sm">Desempe√±o General</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-6">
                                    <div className="bg-white rounded-xl border border-gray-200 p-6">
                                        <h3 className="font-semibold text-gray-900 mb-6">Top Agentes</h3>
                                        <div className="space-y-4">
                                            {[...agents].sort((a, b) => b.sales - a.sales).map((agent, index) => (
                                                <div key={agent.id} className="flex items-center gap-4 p-3 rounded-lg hover:bg-gray-50">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                                                        index === 0 ? 'bg-yellow-100 text-yellow-700' :
                                                        index === 1 ? 'bg-gray-100 text-gray-700' :
                                                        'bg-orange-100 text-orange-700'
                                                    }`}>
                                                        {index + 1}
                                                    </div>
                                                    <div className="flex-1">
                                                        <p className="font-medium text-gray-900">{agent.name}</p>
                                                        <p className="text-xs text-gray-500">{agent.sales} ventas ‚Ä¢ {agent.points.toFixed(2)} pts</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="font-semibold text-green-600">${agent.commission}K</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl border border-gray-200 p-6">
                                        <h3 className="font-semibold text-gray-900 mb-6">Metas Alcanzadas</h3>
                                        <div className="space-y-4">
                                            {[
                                                { name: 'META 1', agents: agents.filter(a => a.meta === 'META 1').length, points: '17 pts', commission: '3%' },
                                                { name: 'META 2', agents: 0, points: '21 pts', commission: '4%' },
                                                { name: 'META 3', agents: 0, points: '26 pts', commission: '5%' },
                                                { name: 'META 4', agents: 0, points: '31 pts', commission: '6%' },
                                            ].map((meta, index) => (
                                                <div key={index} className="border-b pb-4">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-3">
                                                            <div className={`w-3 h-3 rounded-full bg-${['indigo', 'green', 'purple', 'orange'][index]}-500`} />
                                                            <span className="font-medium text-gray-900">{meta.name}</span>
                                                            <span className="text-sm text-gray-600">{meta.points}</span>
                                                        </div>
                                                        <div className="text-right">
                                                            <p className="font-semibold text-gray-900">{meta.agents} agentes</p>
                                                            <p className="text-xs text-green-600">{meta.commission}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            const AgentDashboard = () => {
                if (!currentAgent) {
                    return (
                        <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                            <div className="text-center">
                                <p className="text-gray-600 text-lg">Cargando datos...</p>
                            </div>
                        </div>
                    );
                }
                
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div className="bg-white border-b">
                            <div className="max-w-6xl mx-auto px-6 py-6">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h1 className="text-2xl font-bold text-gray-900">¬°Hola, {currentAgent?.name}! üëã</h1>
                                        <p className="text-gray-600 mt-1">Aqu√≠ est√° tu rendimiento actual</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="max-w-6xl mx-auto px-6 py-8">
                            <h2 className="text-2xl font-bold text-gray-900 mb-6">Mi Desempe√±o</h2>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div className="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-6 rounded-2xl shadow-lg">
                                    <h3 className="text-indigo-100 text-sm font-medium mb-4">Mis Ventas</h3>
                                    <p className="text-4xl font-bold mb-2">{currentAgent?.sales || 0}</p>
                                </div>

                                <div className="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-lg">
                                    <h3 className="text-green-100 text-sm font-medium mb-4">Mis Comisiones</h3>
                                    <p className="text-4xl font-bold mb-2">${currentAgent?.commission || 0}K</p>
                                </div>

                                <div className="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-lg">
                                    <h3 className="text-purple-100 text-sm font-medium mb-4">Mi Score</h3>
                                    <p className="text-4xl font-bold mb-2">{currentAgent?.score || 0}%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div>
                    <div className="fixed bottom-6 right-6 z-50 bg-white shadow-lg rounded-lg p-2 border border-gray-200">
                        <div className="flex gap-2">
                            <button
                                onClick={() => setActiveView('admin')}
                                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                    activeView === 'admin' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                                }`}
                            >
                                Vista Admin
                            </button>
                            {currentUser && (
                                <button
                                    onClick={() => setActiveView('agent')}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                        activeView === 'agent' ? 'bg-indigo-600 text-white' : 'text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    Mi Vista
                                </button>
                            )}
                        </div>
                    </div>

                    {activeView === 'admin' ? <AdminDashboard /> : (currentUser ? <AgentDashboard /> : <AdminDashboard />)}
                </div>
            );
        };

        ReactDOM.render(<CommissionDashboard />, document.getElementById('root'));
    </script>

    <script src="/js/user-info.js" defer></script>
    <script src="/js/logout-handler.js" defer></script>
</body>
</html>
