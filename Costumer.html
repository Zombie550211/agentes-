<!DOCTYPE html>
<html lang="es">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>CRM Agente - Costumer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/costumer-table-clean.css">
  <link rel="stylesheet" href="css/costumer-table-actions.css">
  <link rel="stylesheet" href="css/costumer-table-comments.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/sidebar-inicio.css">
  <!-- Guard temporal ANTES de cargar scripts: bloquear redirecciones a inicio -->
  <script>
    // Renderizador con soporte Team Líneas
    (function(){
      function isTeamLineas(){
        try{
          const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
          const role = (user.role||user?.usuario?.role||'').toString().trim().toLowerCase();
          const username = (user.username||user?.usuario?.username||'').toString().trim().toLowerCase();
          
          // Debug: mostrar valores para diagnosticar
          console.log('[Team Líneas Debug] role:', role, 'username:', username, 'body.team-lineas:', document.body.classList.contains('team-lineas'));
          
          // Detectar Team Líneas por múltiples criterios
          const isTeam = document.body.classList.contains('team-lineas') || 
                        role==='teamlineas' || 
                        username.startsWith('lineas-') ||
                        username.includes('lineas') ||
                        role.includes('lineas');
          
          console.log('[Team Líneas Debug] Resultado:', isTeam);
          return isTeam;
        }catch(e){ 
          console.warn('[Team Líneas Debug] Error:', e);
          return false; 
        }
      }
      function maskPin(v){
        const s = String(v || '');
        return s ? '•'.repeat(Math.min(4, s.length)) : '';
      }
      function serviciosResumen(l){
        const arr = Array.isArray(l.telefonos)? l.telefonos:[];
        if(arr.length){ const m=new Map(); arr.forEach(t=>{ const k=(t?.servicio||t?.tipo||'').toString().trim()||'SERVICIO'; m.set(k,(m.get(k)||0)+1);}); return [...m.entries()].map(([k,v])=> v>1?`${k} x${v}`:k).join('; '); }
        return l.servicios_texto||l.tipo_servicios||l.servicios||l.producto||'';
      }
      function normDate(v){ try{ if(!v) return ''; const s=String(v); if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const d=new Date(s); if(isNaN(d)) return s; const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`;}catch{return String(v||'');}}
      function teamHeader(){ return ['NOMBRE CLIENTE','TELÉFONO PRINCIPAL','NÚMERO DE CUENTA','AUTOPAGO','PIN DE SEGURIDAD','DIRECCIÓN','DÍA DE VENTA','DÍA DE INSTALACIÓN','STATUS','CANTIDAD DE LÍNEAS','TELÉFONOS DE LAS LÍNEAS','ID','SUPERVISOR','MERCADO']; }
      function agentName(l){ return l.agenteNombre||l.nombreAgente||l.agente||l.agent||l.ownerName||l.vendedor||l.seller||''; }
      function applyHeader(){ const thead=document.querySelector('.costumer-table thead'); if(!thead) return; const hs=teamHeader(); thead.innerHTML=`<tr>${hs.map(h=>`<th>${h}</th>`).join('')}</tr>`; }
      function renderRows(list){ const tbody=document.getElementById('costumer-tbody'); if(!tbody) return; tbody.innerHTML=''; (list||[]).forEach(l=>{ const autop=(l.autopay??l.autopago); const autopTxt=typeof autop==='boolean'?(autop?'Sí':'No'):(String(autop||'').toUpperCase()==='SI'?'Sí':(String(autop||'').toUpperCase()==='NO'?'No':String(autop||''))); const cant=(l.cantidad_lineas!=null)?l.cantidad_lineas:(Array.isArray(l.telefonos)?l.telefonos.length:''); const cells=[ l.nombre_cliente||'', l.telefono_principal||'', l.numero_cuenta||'', autopTxt||'', maskPin(l.pin_seguridad)||'', l.direccion||'', normDate(l.dia_venta||l.fecha_contratacion||l.fecha||''), normDate(l.dia_instalacion||''), (l.status||'').toString().toUpperCase(), cant||'', serviciosResumen(l)||'', (l.id_cliente||l._id||l.id||''), l.supervisor||'', l.mercado||'' ]; const tr=document.createElement('tr'); tr.innerHTML=cells.map(v=>`<td>${v==null?'':v}</td>`).join(''); tbody.appendChild(tr); }); }
      // Guardar referencia al renderizador anterior
      const originalRenderer = window.renderCostumerTable;
      
      // Sobrescribir con nuestro renderizador Team Líneas
      window.renderCostumerTable = function(leads){ 
        console.log('[Team Líneas] Interceptando renderCostumerTable, leads:', leads?.length || 0);
        try{ 
          if(isTeamLineas()){ 
            console.log('[Team Líneas] Aplicando vista Team Líneas');
            applyHeader(); 
            const arr = Array.isArray(leads)?leads:(Array.isArray(leads?.leads)?leads.leads:[]); 
            renderRows(arr); 
            return; 
          } 
        }catch(e){ 
          console.warn('[Team Líneas render] error', e);
        } 
        
        // Si no es Team Líneas, usar renderizador original
        if(typeof originalRenderer==='function'){ 
          console.log('[Team Líneas] Usando renderizador original');
          return originalRenderer(leads);
        }
      };
    })();
  </script>
  <script>
    (function(){
      try {
        const blockMs = 12000; // ventana de protección ampliada
        const isInicio = (u) => {
          try {
            const s = (u||'').toString().toLowerCase();
            return s.includes('/inicio.html') || s.endsWith('inicio.html');
          } catch { return false; }
        };
        const origAssign = window.location.assign ? window.location.assign.bind(window.location) : null;
        const origReplace = window.location.replace ? window.location.replace.bind(window.location) : null;
        const origHrefDesc = Object.getOwnPropertyDescriptor(Location.prototype, 'href');
        if (origAssign) window.location.assign = function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirección a inicio'); return; } return origAssign(u); };
        if (origReplace) window.location.replace = function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirección a inicio'); return; } return origReplace(u); };
        if (origHrefDesc && origHrefDesc.set) {
          Object.defineProperty(window.location, 'href', {
            configurable: true,
            get: origHrefDesc.get ? origHrefDesc.get.bind(window.location) : function(){ return document.URL; },
            set: function(u){ if (isInicio(u)) { console.warn('[Costumer] Bloqueada redirección a inicio (href)'); return; } return origHrefDesc.set.call(window.location, u); }
          });
        }
        // Interceptar document.location y parent/top
        try { Object.defineProperty(document, 'location', { configurable: true, get: () => window.location, set: v => { if (!isInicio(v)) window.location.href = v; else console.warn('[Costumer] Bloqueada redirección via document.location'); } }); } catch {}
        try { if (window.top && window.top.location) { const t = window.top.location; const oa = t.assign?.bind(t); if (oa) t.assign = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] top.assign bloqueado'); oa(u); }; const orp = t.replace?.bind(t); if (orp) t.replace = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] top.replace bloqueado'); orp(u); }; } } catch {}
        try { if (window.parent && window.parent.location) { const p = window.parent.location; const pa = p.assign?.bind(p); if (pa) p.assign = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] parent.assign bloqueado'); pa(u); }; const pr = p.replace?.bind(p); if (pr) p.replace = (u)=>{ if (isInicio(u)) return console.warn('[Costumer] parent.replace bloqueado'); pr(u); }; } } catch {}
        // Interceptar history
        try {
          const hps = history.pushState.bind(history);
          history.pushState = function(state, title, url){ if (isInicio(url)) { console.warn('[Costumer] pushState a inicio bloqueado'); return; } return hps(state, title, url); };
          const hrs = history.replaceState.bind(history);
          history.replaceState = function(state, title, url){ if (isInicio(url)) { console.warn('[Costumer] replaceState a inicio bloqueado'); return; } return hrs(state, title, url); };
        } catch {}
        // Eliminar meta refresh a inicio si existiera
        try { document.querySelectorAll('meta[http-equiv="refresh"]').forEach(m=>{ const c=(m.getAttribute('content')||'').toLowerCase(); if (c.includes('inicio.html')) { m.parentNode.removeChild(m); console.warn('[Costumer] meta refresh eliminado'); } }); } catch{}
        setTimeout(function(){
          try { if (origAssign) window.location.assign = origAssign; } catch{}
          try { if (origReplace) window.location.replace = origReplace; } catch{}
          try { if (origHrefDesc) Object.defineProperty(window.location, 'href', origHrefDesc); } catch{}
        }, blockMs);
      } catch(e){ console.warn('[Costumer] Guard no pudo instalarse:', e); }
    })();
  </script>
  <!-- Protección de autenticación en frontend -->
  <script src="agentes/js/auth-check.js"></script>
  <script src="/js/logout-handler.js"></script>
  <script src="/js/user-info.js"></script>
  <script src="js/sidebar-loader.js"></script>
  <!-- Teams API: definición de equipos, supervisores y agentes -->
  <script src="utils/teams.js?v=20250904"></script>
  <style>
    /* Estilos del sidebar unificados en css/sidebar.css */
    /* Nota: Estilos del bloque de usuario del sidebar se definen en css/sidebar-inicio.css
       (clases: .sidebar.sidebar-inicio .user-info, .avatar, .user-name, .user-role). */

    /* Estilos generales */
    :root {
      --primary: #1976d2;
      --primary-dark: #1565c0;
      --accent: #ff9800;
      --text: #333;
      --text-light: #666;
      --border: #e0e0e0;
      --background: #f5f7fa;
      --card-bg: #ffffff;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      position: relative;
      top: 0;
    }

    /* Sidebar Styles: Usar reglas unificadas desde css/sidebar.css */
    /* Estilos para el contenido principal */
    .main-content {
      margin-left: 260px; /* Igual que el ancho del sidebar-inicio */
      padding: 30px;
      width: calc(100% - 260px);
      min-height: 100vh;
      background-color: #f8fafc;
      position: relative;
    }
    
    /* Estilos para el men¨² desplegable */
    .has-submenu {
      position: relative;
    }
    
    .submenu {
      display: none;
      padding-left: 20px;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      margin-top: 5px;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-in-out;
    }
    
    .submenu.active {
      display: block;
      max-height: 200px;
    }
    
    .submenu li {
      margin: 0;
    }
    
    .submenu a {
      padding: 10px 15px 10px 30px !important;
      font-size: 0.9em !important;
      opacity: 0.9;
    }
    
    .submenu a:hover {
      background: rgba(34, 179, 236, 0.2) !important;
      transform: none !important;
      padding-left: 35px !important;
    }
    
    .submenu-toggle {
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
    }
    
    .submenu-icon {
      transition: transform 0.3s ease;
      font-size: 0.8em;
      margin-left: 5px;
    }
    
    .has-submenu.active .submenu-icon {
      transform: rotate(180deg);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin: 0 0 0 260px;
      padding: 20px;
      background-color: var(--background);
      min-height: 100vh;
      position: relative;
      width: calc(100% - 260px);
    }

    /* Estilos para las tarjetas de resumen */
    .summary-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin: 0;
      padding: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .summary-card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }
    
    .summary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .card-content {
      padding: 20px;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      color: white;
      font-size: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #4a5568;
      margin: 0;
    }
    
    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 12px;
    }
    
    .card-footer {
      display: flex;
      align-items: center;
      font-size: 13px;
      color: #718096;
    }
    
    .card-footer i {
      margin-right: 6px;
    }
    
    /* Estilos espec¨ªficos para cada tarjeta */
    .sales-today .card-icon {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
    }
    
    .sales-month .card-icon {
      background: linear-gradient(135deg, #2196f3, #42a5f5);
    }
    
    .pending .card-icon {
      background: linear-gradient(135deg, #ff9800, #ffa726);
    }
    
    .cancelled .card-icon {
      background: linear-gradient(135deg, #f44336, #ef5350);
    }
    
    /* Estilos para la tabla de clientes */
    .costumer-table-container {
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(2, 8, 20, 0.06);
      overflow: hidden;
      margin-top: 24px;
      border: 1px solid #e6eef5;
      max-width: 100%;
      /* Fijar el ¨¢rea de tabla para que solo el listado haga scroll */
      display: flex;
      flex-direction: column;
      /* Ajusta el valor seg¨²n tu layout (altura visible menos tarjetas/m¨¢rgenes) */
      height: calc(100vh - 280px);
    }
    
    .table-responsive {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      /* Permitir scroll vertical SOLO dentro del listado */
      overflow-y: auto;
      flex: 1 1 auto;
      position: relative;
    }
    
    .costumer-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .costumer-table-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin: 0;
    }
    
    .costumer-table-actions {
      display: flex;
      gap: 12px;
    }
    
    .costumer-filter-input {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      width: 250px;
    }
    
    .costumer-filter-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .costumer-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;
      min-width: 2600px; /* Ancho mínimo para 21 columnas (21 × 120px = 2520px + margen) */
      background: #fff;
    }
    
    .costumer-table th,
    .costumer-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eef2f7;
      white-space: normal;
      word-wrap: break-word;
      min-width: 120px;
      max-width: 360px;
      vertical-align: middle;
      font-size: 14px;
      color: #334155;
    }
    
    .costumer-table th {
      background: linear-gradient(180deg, #f9fbff 0%, #f3f6fb 100%);
      font-weight: 600;
      color: #1f2937;
      position: sticky;
      top: 0;
      z-index: 10;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.04em;
      border-bottom: 1px solid #e6eef5;
      box-shadow: 0 2px 0 rgba(226, 232, 240, 0.5);
      backdrop-filter: saturate(120%) blur(2px);
    }
    
    .costumer-table tbody tr:hover {
      background-color: #f8fafc;
    }
    /* Separador mensual */
    .costumer-table tr.costumer-month-separator td {
      background-color: #e2e8f0 !important;
      color: #0f172a !important;
      font-weight: 700;
      padding: 12px 18px;
      border-top: 2px solid #cbd5e1;
      border-bottom: 1px solid #cbd5e1;
      border-left: 4px solid #1976d2;
      text-transform: none;
    }
    
    .costumer-table th {
      text-align: left;
      padding: 14px 18px;
      white-space: nowrap;
    }
    
    .costumer-table td {
      padding: 14px 18px;
      border-bottom: 1px solid #eef2f7;
      color: #334155;
      background-color: #fff;
    }

    /* Zebra striping */
    .costumer-table tbody tr:nth-child(even) td {
      background-color: #fbfdff;
    }

    /* Hover sin l¨ªneas laterales */
    .costumer-table tbody tr:hover td {
      background-color: #f6fafe;
      box-shadow: none;
    }
    
    .costumer-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .costumer-table tbody tr:hover {
      background-color: #f8fafc;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-success {
      background-color: #e6f7ed;
      color: #10b981;
    }
    
    .badge-warning {
      background-color: #fffbeb;
      color: #f59e0b;
    }
    
    .badge-danger {
      background-color: #fdecea;
      color: #e53935;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: #718096;
      cursor: pointer;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .action-btn:hover {
      background-color: #f1f5f9;
      color: var(--primary);
    }
    
    .action-btn i {
      font-size: 16px;
    }

    /* Toggle para modo compacto */
    .action-btn.toggle {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 6px 10px;
      color: #475569;
      background: #fff; 
    }
    .action-btn.toggle.active {
      background-color: #eff6ff;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    /* Modo compacto: reduce paddings y tama?o de fuente */
    body.compact .costumer-table th,
    body.compact .costumer-table td {
      padding: 8px 10px;
      font-size: 12px;
    }
    body.compact .costumer-filter-input {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .summary-cards-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      /* Reglas del sidebar unificadas en css/sidebar.css */
      
      .summary-cards-container {
        grid-template-columns: 1fr;
      }
    }
    /* Composer (comentarios) */
    .comment-composer { display:flex; gap:10px; align-items:flex-end; }
    .composer-avatar { width:40px; height:40px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; color:#6c757d; }
    .composer-input-wrap { position:relative; flex:1; display:flex; align-items:center; }
    .composer-textarea { width:100%; border:1px solid #ced4da; border-radius:22px; padding:10px 96px 10px 14px; min-height:40px; max-height:140px; resize:vertical; outline:none; transition:border-color .2s, box-shadow .2s; background:#fff; }
    .composer-textarea:focus { border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    .composer-actions { position:absolute; right:8px; bottom:8px; display:flex; gap:6px; align-items:center; }
    .emoji-btn { width:28px; height:28px; border-radius:14px; border:1px solid #e2e8f0; background:#fff; color:#111827; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 1px 2px rgba(0,0,0,.05); font-size:16px; }
    .emoji-btn:hover { background:#f8fafc; }
    .composer-send { border:none; background:transparent; color:#0d6efd; font-weight:600; cursor:pointer; padding:4px 8px; border-radius:8px; }
    .composer-send:hover { color:#0b5ed7; text-decoration: underline; }
    .emoji-picker { position:absolute; right:10px; bottom:48px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,.08); padding:8px; width:260px; z-index:10; }
    .emoji-picker .title { font-size:12px; color:#6b7280; margin:2px 4px 6px; }
    .emoji-grid { display:grid; grid-template-columns: repeat(8, 1fr); gap:6px; font-size:18px; }
    .emoji-item { border:none; background:none; cursor:pointer; line-height:1; padding:4px; border-radius:6px; }
    .emoji-item:hover { background:#f3f4f6; }
  </style>
<body>
  <div class="layout">
    <!-- SIDEBAR (cargado din¨¢micamente) -->
    <nav class="sidebar sidebar-inicio" data-active="costumer"></nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Tarjetas de Resumen -->
      <div class="summary-cards-container">
        <!-- Ventas Hoy -->
        <div class="summary-card sales-today">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <h3 class="card-title">Ventas Hoy</h3>
            </div>
            <div class="card-value" id="costumer-ventas-hoy">0</div>
            <div class="card-footer">
              <i class="fas fa-calendar-day"></i> Actualizado ahora
            </div>
          </div>
        </div>

        <!-- Ventas del Mes -->
        <div class="summary-card sales-month">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <h3 class="card-title">Ventas del Mes</h3>
            </div>
            <div class="card-value" id="costumer-ventas-mes">0</div>
            <div class="card-footer">
              <i class="fas fa-calendar-alt"></i> Mes actual
            </div>
          </div>
        </div>

        <!-- Pendientes -->
        <div class="summary-card pending">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-clock"></i>
              </div>
              <h3 class="card-title">Pendientes</h3>
            </div>
            <div class="card-value" id="costumer-pendientes">0</div>
            <div class="card-footer">
              <i class="fas fa-info-circle"></i> Por atender
            </div>
          </div>
        </div>

        <!-- Cancelados -->
        <div class="summary-card cancelled">
          <div class="card-content">
            <div class="card-header">
              <div class="card-icon">
                <i class="fas fa-times-circle"></i>
              </div>
              <h3 class="card-title">Cancelados</h3>
            </div>
            <div class="card-value" id="costumer-cancelados">0</div>
            <div class="card-footer">
              <i class="fas fa-exclamation-triangle"></i> Este mes
            </div>
          </div>
        </div>
      </div>

      <!-- Tabla de Clientes -->
      <div class="costumer-table-container">
        <div class="costumer-table-header">
          <h2 class="costumer-table-title">Lista de Clientes</h2>
          <div class="costumer-table-actions">
            <input type="text" class="costumer-filter-input" id="costumer-search" placeholder="Buscar cliente...">
            <button id="toggle-compact" class="action-btn toggle" title="Alternar modo compacto">
              <i class="fas fa-compress-alt"></i>
            </button>
            <button id="refresh-table" class="action-btn" title="Refrescar">
              <i class="fas fa-sync-alt"></i>
            </button>
            <!-- Bot¨®n para alternar ver todos/mis clientes (solo visible para admin/supervisor/backoffice) -->
            <button id="toggle-forceall" class="action-btn" title="Ver todos" style="display:none">
              <i class="fas fa-users"></i>
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="costumer-table">
            <thead>
              <tr>
                <th>Nombre cliente</th>
                <th>Telefono principal</th>
                <th>Telefono alterno</th>
                <th>Numero de cuenta</th>
                <th>Autopago</th>
                <th>Direccion</th>
                <th>Tipo de servicios</th>
                <th>Sistema</th>
                <th>Riesgo</th>
                <th>Dia de venta</th>
                <th>Dia de instalacion</th>
                <th>Status</th>
                <th>Servicios</th>
                <th>Mercado</th>
                <th>Supervisor</th>
                <th>Comentario</th>
                <th>Motivo llamada</th>
                <th>ZIP CODE</th>
                <th>Puntaje</th>
                <th>
                  <div style="display: flex; flex-direction: column; align-items: center;">
                    <div>Comentarios sobre la Venta</div>
                    <button onclick="abrirComentarios()" class="action-btn" style="margin-top: 5px; padding: 4px 8px; font-size: 12px;">
                      <i class="fas fa-comment"></i> Gestionar
                    </button>
                  </div>
                </th>
                <th>Acccion</th>
              </tr>
            </thead>
            <tbody id="costumer-tbody">
              <!-- Las filas se llenar¨¢n din¨¢micamente con JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Comentarios -->
  <div id="comentariosModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
    <div style="position: absolute; right: 0; top: 0; width: 500px; height: 100%; background-color: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.2); display: flex; flex-direction: column;">
      <!-- Encabezado del modal -->
      <div style="padding: 20px; border-bottom: 1px solid #eaeaea; display: flex; justify-content: space-between; align-items: center; background-color: #f8f9fa;">
        <div>
          <h3 style="margin: 0; color: #333; font-size: 18px;">Comentarios</h3>
          <p style="margin: 5px 0 0; color: #666; font-size: 14px;">Agrega comentarios sobre el cliente</p>
        </div>
        <button onclick="cerrarComentarios()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
      </div>
      
      <!-- Lista de comentarios -->
      <div id="comentariosContainer" style="flex: 1; overflow-y: auto; padding: 20px;">
        <!-- Los comentarios se cargar¨¢n aqu¨ª din¨¢micamente -->
      </div>
      
      <!-- ?rea para nuevo comentario -->
      <div style="padding: 15px; border-top: 1px solid #eaeaea; background-color: #f8f9fa;">
        <div class="comment-composer" style="margin-bottom:10px;">
          <div class="composer-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="composer-input-wrap">
            <textarea id="nuevoComentario" class="composer-textarea" placeholder="Escribe un comentario..."></textarea>
            <div class="composer-actions">
              <button id="emojiToggleBtn" class="emoji-btn" onclick="toggleEmojiPicker(event)" title="Emojis">?</button>
              <button class="composer-send" onclick="agregarComentario()">Enviar</button>
            </div>
            <!-- Picker compacto -->
            <div id="emojiPicker" class="emoji-picker" style="display:none;">
              <div class="title">Emojis</div>
              <div class="emoji-grid">
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('??')">??</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
                <button class="emoji-item" onclick="insertEmoji('?')">?</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Helper: obtener leads por agentId desde backend (fallback para vista Supervisor)
    // Cache global de leads por agente para evitar reconsultas
    if (!window.__agentLeadsCache) window.__agentLeadsCache = new Map();
    let __currentFetchController = null;
    async function fetchLeadsByAgentId(agentId) {
      try {
        if (!agentId) return [];
        // Cache inmediato
        if (window.__agentLeadsCache.has(agentId)) {
          const cached = window.__agentLeadsCache.get(agentId);
          console.debug('[fetchLeadsByAgentId] usando cache para', agentId, 'items=', cached.length);
          return cached.slice();
        }
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        // Solo las claves robustas que el backend soporta de forma directa
        const qParams = [
          ['agenteId', agentId],
          ['agentId', agentId]
        ];
        const normalizeId = (v) => {
          if (!v) return '';
          if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
          const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
        };
        // Abort de fetches previos si el usuario cambia de chip r¨¢pidamente
        if (__currentFetchController) { try { __currentFetchController.abort(); } catch(_) {} }
        __currentFetchController = new AbortController();
        const { signal } = __currentFetchController;
        // Intentar primero agenteId, si no hay datos probar agentId inmediatamente despu¨¦s
        const tryOnce = async ([key, val]) => {
          const url = `/api/customers?page=1&limit=200&${key}=${encodeURIComponent(val)}`;
          const res = await fetch(url, { headers, signal });
          if (!res.ok) { console.warn('[fetchLeadsByAgentId] HTTP', res.status, 'para', key); return []; }
          const data = await res.json();
          const leads = Array.isArray(data) ? data : (Array.isArray(data?.leads) ? data.leads : []);
          console.log(`[fetchLeadsByAgentId] ${key} -> recibidos=${leads.length}`);
          return leads;
        };
        let acc = await tryOnce(qParams[0]);
        if (!acc.length) acc = await tryOnce(qParams[1]);
        // Cachear
        window.__agentLeadsCache.set(agentId, acc.slice());
        console.log('[fetchLeadsByAgentId] total =', acc.length);
        return acc;
      } catch (e) {
        console.warn('fetchLeadsByAgentId error:', e);
        return [];
      }
    }
    // Helper: obtener leads por nombre de agente desde backend (varias claves)
    async function fetchLeadsByAgentName(agentName) {
      try {
        if (!agentName) return [];
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const strip = (s) => s.normalize('NFD').replace(/\p{Diacritic}/gu,'');
        const collapsed = strip(agentName).replace(/\s+/g,'');
        // Insertar un espacio entre nombre y apellido si viene colapsado tipo "EduardoRivas"
        const spaced = (/^[A-Za-z]+[A-Z][a-z]+$/.test(agentName))
          ? agentName.replace(/([a-z])([A-Z])/g, '$1 $2')
          : agentName;
        const nameVariants = Array.from(new Set([
          agentName,
          spaced,
          collapsed
        ].map(v => String(v).trim()).filter(Boolean)));
        const keys = ['agenteNombre','nombreAgente','agente','salesAgent','vendedor','atendioPor','asignadoA','asignadoPor'];
        const normalizeId = (v) => {
          if (!v) return '';
          if (typeof v === 'object') return String(v.$oid||v.id||v._id||v.value||'');
          const s = String(v); const m = s.match(/^ObjectId\('([a-fA-F0-9]{24})'\)$/); return m?m[1]:s;
        };
        const seen = new Set();
        const acc = [];
        for (const key of keys) {
          for (const val of nameVariants) {
            try {
              const url = `/api/customers?page=1&limit=200&${key}=${encodeURIComponent(val)}`;
              const res = await fetch(url, { headers });
              if (!res.ok) { console.warn('[fetchLeadsByAgentName] HTTP', res.status, 'para', key, 'val', val); continue; }
              const data = await res.json();
              const leads = Array.isArray(data) ? data : (Array.isArray(data?.leads) ? data.leads : []);
              for (const l of leads) {
                const id = normalizeId(l._id) || normalizeId(l.id) || normalizeId(l.leadId) || JSON.stringify(l).length;
                if (!seen.has(id)) { seen.add(id); acc.push(l); }
              }
              console.log(`[fetchLeadsByAgentName] ${key}=${val} -> recibidos=${leads.length} | acumulados=${acc.length}`);
            } catch (e) {
              console.warn('[fetchLeadsByAgentName] error con', key, 'val', val, e);
            }
          }
        }
        console.log('[fetchLeadsByAgentName] total combinados =', acc.length);
        return acc;
      } catch(e) {
        console.warn('fetchLeadsByAgentName error:', e);
        return [];
      }
    }
    // Manejador de errores global
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Error global detectado:', {
        message: message,
        source: source,
        lineno: lineno,
        colno: colno,
        error: error
      });
      return true; // Previene el manejador de errores por defecto
    };
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="utils/teams.js"></script>
  <script>
    // Función para verificar el rol del usuario y mostrar/ocultar elementos según corresponda
    function checkUserRole() {
      try {
        const teamMenuItem = document.getElementById('teamMenuItem');
        if (teamMenuItem) {
          teamMenuItem.style.display = 'none';
        }

        // Obtener y normalizar rol
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString();
        const role = roleRaw.toLowerCase().trim();

        // Roles permitidos para ver Team: admin, supervisor, backoffice (y variantes)
        const allowed = new Set(['admin','supervisor','backoffice','b:o','b.o','b-o','bo']);

        if (teamMenuItem && allowed.has(role)) {
          // li por defecto es list-item; usar block para asegurar visibilidad
          teamMenuItem.style.display = 'block';
        }
      } catch (error) {
        console.error('Error al verificar el rol del usuario:', error);
      }
    }

    // Helper GLOBAL: matcher para agente seleccionado (canónico y heurísticas)
    if (!window.matchSelectedAgent) {
      window.matchSelectedAgent = function(l, selectedCanon) {
        try {
          if (!selectedCanon) return true;
          const teamsApi = (window && window.Teams) ? window.Teams : null;
          const norm = s => (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim().toLowerCase().replace(/\s+/g,' ');
          const collapse = s => norm(s).replace(/[^a-z0-9]/g, '');
          const canonFrom = name => {
            try { return teamsApi && typeof teamsApi.canonicalFromName==='function' ? teamsApi.canonicalFromName(name) : norm(name); } catch { return norm(name); }
          };
          const selectedDisplay = (teamsApi && typeof teamsApi.getDisplayName==='function') ? teamsApi.getDisplayName(selectedCanon) : selectedCanon;
          const selCanonCollapsed = collapse(selectedCanon);
          const selDisplayCollapsed = collapse(selectedDisplay);
          // Intentar poblar __agentCanon usando el helper universal (usa mapa de IDs)
          try { if (typeof getAgentCanonUniversal === 'function') { const c0 = getAgentCanonUniversal(l); if (c0) l.__agentCanon = c0; } } catch(_) {}
          const c1 = (l && l.__agentCanon) ? l.__agentCanon : '';
          if (c1 && (c1 === selectedCanon || collapse(c1) === selCanonCollapsed)) return true;
          const candidates = [
            l?.agenteNombre, l?.nombreAgente, l?.agente, l?.Agente, l?.agent, l?.Agent,
            l?.vendedor, l?.seller, l?.usuario, l?.owner, l?.createdBy, l?.registeredBy,
            l?.asignadoA, l?.asignado_a, l?.assignedTo, l?.assigned_to,
            l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.Agente,
            l?._raw?.agent, l?._raw?.Agent, l?._raw?.vendedor, l?._raw?.seller,
            l?._raw?.usuario, l?._raw?.owner, l?._raw?.createdBy, l?._raw?.registeredBy,
            l?._raw?.asignadoA, l?._raw?.asignado_a, l?._raw?.assignedTo, l?._raw?.assigned_to
          ];
          for (const v of candidates) {
            if (!v) continue;
            const c = canonFrom(v);
            if (c && (c === selectedCanon || collapse(c) === selCanonCollapsed)) return true;
            const col = collapse(v);
            if (col && (col === selDisplayCollapsed || col === selCanonCollapsed)) return true;
          }
          const toks = selectedCanon.split(' ').filter(Boolean);
          const txt = norm(JSON.stringify(l||{}));
          if (toks.every(t => txt.includes(t))) return true;
          return false;
        } catch { return false; }
      };
    }

    // Inicializar cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
      checkUserRole();
    });
  </script>
  <script src="js/core/script.js"></script>
  <!-- Override DESPUÉS de script.js para Team Líneas -->
  <script>
    // Override para Team Líneas después de cargar script.js
    (function() {
      const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
      const role = (user.role||user?.usuario?.role||'').toString().trim().toLowerCase();
      const username = (user.username||user?.usuario?.username||'').toString().trim().toLowerCase();
      const isTeamLineas = role==='teamlineas' || username.startsWith('lineas-') || username.includes('lineas');

      if (isTeamLineas) {
        console.log('[Team Líneas OVERRIDE] Usuario Team Líneas detectado, sobrescribiendo renderCostumerTable');

        // Sobrescribir renderCostumerTable DESPUÉS de que script.js lo defina
        window.renderCostumerTable = function(leads) {
          console.log('[Team Líneas INTERCEPTOR] Renderizando con interceptor');

          // Aplicar encabezado Team Líneas
          const thead = document.querySelector('.costumer-table thead');
          if (thead) {
            const headers = ['NOMBRE CLIENTE','TELÉFONO PRINCIPAL','NÚMERO DE CUENTA','AUTOPAGO','PIN DE SEGURIDAD','DIRECCIÓN','DÍA DE VENTA','DÍA DE INSTALACIÓN','STATUS','CANTIDAD DE LÍNEAS','TELÉFONOS DE LAS LÍNEAS','ID','SUPERVISOR','MERCADO'];
            thead.innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
          }

          // Renderizar filas Team Líneas
          const tbody = document.getElementById('costumer-tbody');
          if (tbody) {
            tbody.innerHTML = '';
            const arr = Array.isArray(leads) ? leads : (Array.isArray(leads?.leads) ? leads.leads : []);

            arr.forEach(l => {
              const autop = (l.autopay ?? l.autopago);
              const autopTxt = typeof autop === 'boolean' ? (autop ? 'Sí' : 'No') :
                              (String(autop||'').toUpperCase() === 'SI' ? 'Sí' :
                              (String(autop||'').toUpperCase() === 'NO' ? 'No' : String(autop||'')));

              const cant = (l.cantidad_lineas != null) ? l.cantidad_lineas :
                          (Array.isArray(l.telefonos) ? l.telefonos.length : '');

              // Servicios resumen
              let servicios = '';
              const arr = Array.isArray(l.telefonos) ? l.telefonos : [];
              if (arr.length) {
                const m = new Map();
                arr.forEach(t => {
                  const k = (t?.servicio || t?.tipo || '').toString().trim() || 'SERVICIO';
                  m.set(k, (m.get(k) || 0) + 1);
                });
                servicios = [...m.entries()].map(([k,v]) => v > 1 ? `${k} x${v}` : k).join('; ');
              } else {
                servicios = l.servicios_texto || l.tipo_servicios || l.servicios || l.producto || '';
              }

              // PIN enmascarado
              const pin = l.pin_seguridad ? '•'.repeat(Math.min(4, String(l.pin_seguridad).length)) : '';

              // Fecha normalizada
              function normDate(v) {
                try {
                  if (!v) return '';
                  const s = String(v);
                  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
                  const d = new Date(s);
                  if (isNaN(d)) return s;
                  const y = d.getFullYear();
                  const m = String(d.getMonth()+1).padStart(2,'0');
                  const day = String(d.getDate()).padStart(2,'0');
                  return `${y}-${m}-${day}`;
                } catch {
                  return String(v||'');
                }
              }

              const cells = [
                l.nombre_cliente || '',
                l.telefono_principal || '',
                l.numero_cuenta || '',
                autopTxt || '',
                pin || '',
                l.direccion || '',
                normDate(l.dia_venta || l.fecha_contratacion || l.fecha || ''),
                normDate(l.dia_instalacion || ''),
                (l.status || '').toString().toUpperCase(),
                cant || '',
                servicios || '',
                (l.id_cliente || l._id || l.id || ''),
                l.supervisor || '',
                l.mercado || ''
              ];

              const tr = document.createElement('tr');
              tr.innerHTML = cells.map(v => `<td>${v == null ? '' : v}</td>`).join('');
              tbody.appendChild(tr);
            });
          }
        };

        // Asignar después de que script.js se cargue
        setTimeout(() => {
          console.log('[Team Líneas INTERCEPTOR] Asignando renderizador después de script.js');
          window.renderCostumerTable = window.teamLineasRenderFunction;
        }, 100);
      }
    })();
  </script>
  <script src="js/core/script.js"></script>
  <!-- Override final para Team Líneas después de cargar script.js -->
  <script>
    
    // Override final para Team Líneas que se ejecuta después de script.js
    document.addEventListener('DOMContentLoaded', function() {
      // Esperar a que script.js se cargue completamente
      setTimeout(() => {
        console.log('[Team Líneas FINAL] Iniciando override final');

        const isTeamLineasFinal = () => {
          try {
            const user = JSON.parse(localStorage.getItem('user')||sessionStorage.getItem('user')||'{}');
            const role = (user.role||user?.usuario?.role||'').toString().trim().toLowerCase();
            const username = (user.username||user?.usuario?.username||'').toString().trim().toLowerCase();

            const isTeam = document.body.classList.contains('team-lineas') ||
                          role === 'teamlineas' ||
                          username.startsWith('lineas-') ||
                          username.includes('lineas') ||
                          role.includes('lineas');

            console.log('[Team Líneas FINAL] Usuario detectado como Team Líneas:', isTeam);
            return isTeam;
          } catch (e) {
            console.warn('[Team Líneas FINAL] Error al detectar Team Líneas:', e);
            return false;
          }
        };

        const isTeam = isTeamLineasFinal();

        if (!isTeam) {
          console.log('[Team Líneas FINAL] Usuario NO es Team Líneas. Se mantiene renderizado estándar.');
          return;
        }

        console.log('[Team Líneas FINAL] Usuario Team Líneas. Aplicando override de tabla.');

        const teamLineasRenderer = function(leads) {
          console.log('[Team Líneas FINAL] Interceptando renderCostumerTable, leads:', leads?.length || 0);

          // Aplicar encabezado Team Líneas
          const thead = document.querySelector('.costumer-table thead');
          if (thead) {
            const headers = ['NOMBRE CLIENTE','TELÉFONO PRINCIPAL','NÚMERO DE CUENTA','AUTOPAGO','PIN DE SEGURIDAD','DIRECCIÓN','DÍA DE VENTA','DÍA DE INSTALACIÓN','STATUS','CANTIDAD DE LÍNEAS','TELÉFONOS DE LAS LÍNEAS','ID','SUPERVISOR','MERCADO'];
            thead.innerHTML = `<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`;
          }

          // Renderizar filas Team Líneas
          const tbody = document.getElementById('costumer-tbody');
          if (tbody) {
            tbody.innerHTML = '';
            const arr = Array.isArray(leads) ? leads : (Array.isArray(leads?.leads) ? leads.leads : []);

            arr.forEach(l => {
                const autop = (l.autopay ?? l.autopago);
                const autopTxt = typeof autop === 'boolean' ? (autop ? 'Sí' : 'No') : 
                                (String(autop||'').toUpperCase() === 'SI' ? 'Sí' : 
                                (String(autop||'').toUpperCase() === 'NO' ? 'No' : String(autop||'')));
                
                const cant = (l.cantidad_lineas != null) ? l.cantidad_lineas : 
                            (Array.isArray(l.telefonos) ? l.telefonos.length : '');
                
                // Servicios resumen
                let servicios = '';
                const arr = Array.isArray(l.telefonos) ? l.telefonos : [];
                if (arr.length) {
                  const m = new Map();
                  arr.forEach(t => {
                    const k = (t?.servicio || t?.tipo || '').toString().trim() || 'SERVICIO';
                    m.set(k, (m.get(k) || 0) + 1);
                  });
                  servicios = [...m.entries()].map(([k,v]) => v > 1 ? `${k} x${v}` : k).join('; ');
                } else {
                  servicios = l.servicios_texto || l.tipo_servicios || l.servicios || l.producto || '';
                }
                
                // PIN enmascarado
                const pin = l.pin_seguridad ? '•'.repeat(Math.min(4, String(l.pin_seguridad).length)) : '';
                
                // Fecha normalizada
                function normDate(v) {
                  try {
                    if (!v) return '';
                    const s = String(v);
                    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
                    const d = new Date(s);
                    if (isNaN(d)) return s;
                    const y = d.getFullYear();
                    const m = String(d.getMonth()+1).padStart(2,'0');
                    const day = String(d.getDate()).padStart(2,'0');
                    return `${y}-${m}-${day}`;
                  } catch {
                    return String(v||'');
                  }
                }
                
                const cells = [
                  l.nombre_cliente || '',
                  l.telefono_principal || '',
                  l.numero_cuenta || '',
                  autopTxt || '',
                  pin || '',
                  l.direccion || '',
                  normDate(l.dia_venta || l.fecha_contratacion || l.fecha || ''),
                  normDate(l.dia_instalacion || ''),
                  (l.status || '').toString().toUpperCase(),
                  cant || '',
                  servicios || '',
                  (l.id_cliente || l._id || l.id || ''),
                  l.supervisor || '',
                  l.mercado || ''
                ];
                
                const tr = document.createElement('tr');
                tr.innerHTML = cells.map(v => `<td>${v == null ? '' : v}</td>`).join('');
              tbody.appendChild(tr);
            });
          }
        };
        
        // Asignar renderizador Team Líneas
        if (window.renderCostumerTable) {
          console.log('[Team Líneas FINAL] Asignando renderizador Team Líneas');
          window.renderCostumerTable = teamLineasRenderer;
        } else {
          console.log('[Team Líneas FINAL] Definiendo renderizador Team Líneas por primera vez');
          window.renderCostumerTable = teamLineasRenderer;
        }
        
        // Si ya hay datos cargados, re-renderizar
        if (window.ultimaListaLeads && window.ultimaListaLeads.length > 0) {
          console.log('[Team Líneas FINAL] Re-renderizando con datos existentes');
          teamLineasRenderer(window.ultimaListaLeads);
        }
      }, 1000); // Esperar 1000ms para que script.js termine de cargar
      
      // Override adicional más fuerte después de más tiempo
      setTimeout(() => {
        if (isTeamLineasFinal && isTeamLineasFinal()) {
          console.log('[Team Líneas OVERRIDE] Aplicando override final');
          if (typeof teamLineasRenderer === 'function') {
            window.renderCostumerTable = teamLineasRenderer;
          }
        }
      }, 2000);
    });
  </script>
  <!-- Eliminada la referencia a costumer-comments.js que no existe -->
  <script>
    // Inicializaci¨®n de UI: toggle compacto y refrescar tabla
    document.addEventListener('DOMContentLoaded', function() {
      const toggleBtn = document.getElementById('toggle-compact');
      const refreshBtn = document.getElementById('refresh-table');
      const forceAllBtn = document.getElementById('toggle-forceall');

      if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
          document.body.classList.toggle('compact');
          toggleBtn.classList.toggle('active');
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', async function() {
          const icon = refreshBtn.querySelector('i');
          const prev = icon.className;
          icon.className = 'fas fa-spinner fa-spin';
          try {
            if (typeof cargarDatosDesdeServidor === 'function') {
              await cargarDatosDesdeServidor();
            } else if (typeof fetchLeadsAgente === 'function') {
              await fetchLeadsAgente();
            }
          }
          finally { icon.className = prev; }
        });
      }

      // Conmutador Ver todos / Mis clientes
      function getRole() {
        try {
          const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
          return (userData.role || userData?.usuario?.role || '').toString().toLowerCase().trim();
        } catch { return ''; }
      }
      

      
      function getForceAll() {
        const usp = new URLSearchParams(window.location.search);
        const v = (usp.get('forceAll') || '').toString().toLowerCase();
        return v === '1' || v === 'true' || v === 'yes';
      }
      function setForceAll(enabled) {
        const url = new URL(window.location.href);
        if (enabled) url.searchParams.set('forceAll', '1');
        else url.searchParams.delete('forceAll');
        window.location.href = url.toString();
      }
      // Mostrar bot¨®n solo para admin/supervisor/backoffice (no para agent)
      const role = getRole();
      // admin/backoffice/supervisor pueden ver el bot¨®n
      const allowed = new Set(['admin','supervisor','backoffice','b:o','b.o','b-o','bo']);
      if (forceAllBtn) {
        if (allowed.has(role)) {
          forceAllBtn.style.display = 'inline-flex';
          const isForceAll = getForceAll();
          forceAllBtn.title = isForceAll ? 'Mis clientes' : 'Ver todos';
          if (isForceAll) forceAllBtn.classList.add('active');
          forceAllBtn.addEventListener('click', function() {
            setForceAll(!getForceAll());
          });
        } else {
          // Agente: oculto y aseguramos que no quede activo por URL
          forceAllBtn.style.display = 'none';
        }
      }

      // Resetear filtros residuales antes de cargar datos (evita listas reducidas por estados previos)
      try { window.supervisorAgentFilter = null; } catch(_) {}
      try { window.adminTeamFilter = null; } catch(_) {}

    // Cargar datos iniciales usando la función unificada de script.js
    if (typeof cargarDatosDesdeServidor === 'function') {
      cargarDatosDesdeServidor();
    } else {
      console.warn('[Costumer] cargarDatosDesdeServidor no disponible');
      mostrarMensajeSinDatos();
    }
    });
  </script>
  <script>
    // Variables globales
    let leadActual = null;

    // Helper: detectar si el usuario actual es Irania Serrano
    function esIrania() {
      try {
        // 1) Intentar desde local/session storage
        const userRaw = localStorage.getItem('user') || sessionStorage.getItem('user');
        if (userRaw) {
          const u = JSON.parse(userRaw || '{}');
          const nombre = (u.name || u.fullName || u.username || u.email || u.usuario?.name || '').toString();
          if (normalizarTexto(nombre) === normalizarTexto('Irania Serrano')) return true;
        }
        // 2) Intentar desde token JWT
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (token && token.split('.').length === 3) {
          try {
            const payload = JSON.parse(atob(token.split('.')[1]) || '{}');
            const nombreTok = (payload.username || payload.name || payload.fullName || payload.email || '').toString();
            if (normalizarTexto(nombreTok) === normalizarTexto('Irania Serrano')) return true;
          } catch(_) {}
        }
      } catch(_) {}
      return false;
    }

    // Helper: quitar prefijo "team" del supervisor para mostrar limpio
    function limpiarSupervisor(displayName) {
      try {
        const s = (displayName || '').toString();
        return s.replace(/^\s*team\s+/i, '').trim();
      } catch { return displayName || ''; }
    }

    // Helper: detectar si el usuario es admin o backoffice
    function esAdminOBackoffice() {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString();
        const role = roleRaw.toLowerCase().trim();
        const allowed = new Set(['admin','supervisor','backoffice','b:o','b.o','b-o','bo']);
        // Solo admin o backoffice/variantes, no supervisor
        if (role === 'admin') return true;
        if (allowed.has(role) && role !== 'supervisor') return true;
        return false;
      } catch { return false; }
    }

    // Helper: detectar si el usuario es supervisor
    function esSupervisor() {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const roleRaw = (userData.role || userData?.usuario?.role || '').toString();
        const role = roleRaw.toLowerCase().trim();
        return role === 'supervisor';
      } catch { return false; }
    }
  
        // Funci¨®n para verificar si el usuario puede editar el estado de un lead
    function canEditStatus() {
      try {
        // Obtener datos del usuario desde localStorage o sessionStorage
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const userRole = (userData.role || '').toLowerCase();
        
        // Permitir edici¨®n a administradores y supervisores
        return ['admin', 'supervisor', 'backoffice'].includes(userRole);
      } catch (error) {
        console.error('Error al verificar permisos de edici¨®n:', error);
        return false; // Por defecto, no permitir edici¨®n si hay un error
      }
    }

    // Funciones para el manejo de comentarios
    function abrirComentarios(leadId) {
      leadActual = leadId;
      document.getElementById('comentariosModal').style.display = 'block';
      cargarComentarios(leadId);
    }

    function cerrarComentarios() {
      document.getElementById('comentariosModal').style.display = 'none';
      document.getElementById('nuevoComentario').value = '';
      const picker = document.getElementById('emojiPicker');
      if (picker) picker.style.display = 'none';
      leadActual = null;
    }

    async function cargarComentarios(leadId) {
      const container = document.getElementById('comentariosContainer');
      container.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
          <div style="text-align: center;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p style="margin-top: 10px; color: #666;">Cargando comentarios...</p>
          </div>
        </div>
      `;
      
      try {
        console.log('Solicitando comentarios para leadId:', leadId);
        
        let comments = [];
        
        // 1) Intentar obtener del backend si existe endpoint
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          const resp = await fetch(`/api/comments?leadId=${encodeURIComponent(leadId)}`, {
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            }
          });
          if (resp.ok) {
            const data = await resp.json();
            if (data && Array.isArray(data.comments)) {
              comments = data.comments;
            }
          }
        } catch (e) {
          console.warn('Fallo al obtener comentarios del backend, se usar¨¢ cache/local:', e);
        }

        // 2) Mezclar con comentarios locales en cache (optimista)
        const cacheKey = `comments_cache_${leadId}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        if (Array.isArray(cached) && cached.length) {
          comments = [...comments, ...cached];
        }

        // 3) Si vac¨ªo, intentar inferir ¨²ltimo comentario textual del lead para mostrar algo
        if ((!comments || comments.length === 0) && Array.isArray(window.ultimaListaLeads)) {
          const lead = window.ultimaListaLeads.find(l => (l._id || '') === leadId);
          if (lead && lead.comentarios_venta) {
            comments = [{
              autor: 'Sistema',
              fecha: new Date().toISOString(),
              texto: String(lead.comentarios_venta)
            }];
          }
        }

        // Normalizaci¨®n y render tipo chat
        const usuario = obtenerUsuarioActual();
        const mensajes = (comments || []).map(c => ({
          autor: c.autor || c.user || 'Desconocido',
          fecha: c.fecha || c.createdAt || new Date().toISOString(),
          texto: (c.texto ?? c.comment ?? '').toString()
        }));

        // ...
        let html = '';
        
        // Ordenar comentarios por fecha (m¨¢s antiguos primero para chat natural)
        const comentariosOrdenados = [...mensajes].sort((a, b) => 
          new Date(a.fecha) - new Date(b.fecha)
        );
        
        // Render de cada burbuja estilo chat
        comentariosOrdenados.forEach(comentario => {
          const fecha = new Date(comentario.fecha);
          const fechaFormateada = fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          const esAgente = normalizarTexto(comentario.autor) === normalizarTexto(usuario);
          const lado = esAgente ? 'me' : 'other';
          const iniciales = obtenerIniciales(comentario.autor);
          html += `
            <div class="chat-message ${lado}" style="display:flex; gap:10px; margin-bottom:12px; align-items:flex-end; ${lado==='me' ? 'justify-content:flex-end;' : ''}">
              ${lado==='other' ? `
                <div class="chat-avatar" title="${escapeHtml(comentario.autor)}" style="width:28px; height:28px; border-radius:50%; background:#e9ecef; display:flex; align-items:center; justify-content:center; font-size:12px; color:#6c757d; flex-shrink:0;">${escapeHtml(iniciales)}</div>
              ` : ''}
              <div class="chat-bubble ${lado}" style="max-width:70%; padding:10px 12px; border-radius:14px; ${lado==='me' ? 'background:#e3f2fd; color:#0d47a1; border-top-right-radius:4px;' : 'background:#f1f3f5; color:#333; border-top-left-radius:4px;'}">
                <div class="chat-author-time" style="font-size:11px; color:${lado==='me' ? '#1565c0' : '#6c757d'}; margin-bottom:4px;">
                  ${escapeHtml(comentario.autor)} ? ${fechaFormateada}
                </div>
                <div class="chat-text" style="white-space:pre-wrap; word-wrap:break-word;">${escapeHtml(comentario.texto)}</div>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html || `
          <div style="display:flex; align-items:center; justify-content:center; height:100%; color:#666;">
            <div>
              <i class="fas fa-comments" style="font-size:28px; opacity:0.6;"></i>
              <p style="margin-top:8px;">Sin comentarios a¨²n. ?S¨¦ el primero en comentar!</p>
            </div>
          </div>
        `;

        // Hacer scroll al final (¨²ltimo mensaje visible)
        setTimeout(() => {
          try { container.scrollTop = container.scrollHeight; } catch(_e) {}
        }, 50);
  
      } catch (error) {
        console.error('Error al cargar comentarios:', error);
        const comentariosContainer = document.getElementById('comentariosContainer');
      }
    }

    async function agregarComentario() {
      const comentario = document.getElementById('nuevoComentario').value.trim();
      if (!comentario) return;
      
      const btnEnviar = document.querySelector('#comentariosModal button[onclick="agregarComentario()"]');
      const btnOriginalText = btnEnviar.innerHTML;
      const comentarioInput = document.getElementById('nuevoComentario');
      
      btnEnviar.disabled = true;
      btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      
      try {
        console.log('Enviando comentario para leadId:', leadActual);
        const usuario = obtenerUsuarioActual();
        const nuevo = {
          autor: usuario || 'Yo',
          fecha: new Date().toISOString(),
          texto: comentario
        };

        // Optimista: agregar a cache local
        const cacheKey = `comments_cache_${leadActual}`;
        const cached = JSON.parse(localStorage.getItem(cacheKey) || '[]');
        cached.push(nuevo);
        localStorage.setItem(cacheKey, JSON.stringify(cached));

        // Intentar enviar al backend si existe endpoint REST
        try {
          const token = localStorage.getItem('token') || sessionStorage.getItem('token');
          const resp = await fetch(`/api/leads/${encodeURIComponent(leadActual)}/comentarios`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: JSON.stringify(nuevo)
          });
          if (!resp.ok) {
            console.warn('POST /api/leads/:id/comentarios no disponible. Se mantiene en cache local.');
          }
        } catch (e) {
          console.warn('Fallo al enviar comentario al backend, se mantiene en cache local:', e);
        }

        // Limpiar input y recargar lista
        comentarioInput.value = '';
        await cargarComentarios(leadActual);

        // Actualizar columna de "Comentarios sobre la Venta" en la tabla
        if (typeof actualizarUltimoComentarioEnTabla === 'function') {
          actualizarUltimoComentarioEnTabla(leadActual, nuevo.texto);
        }
      } catch(error) {
        console.error('Error al agregar comentario:', error);
        const comentariosContainer = document.getElementById('comentariosContainer');
      } finally {
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = btnOriginalText;
      }
    }

    // Soporte de Emoji Picker
    function toggleEmojiPicker(event) {
      try {
        event?.stopPropagation?.();
        const picker = document.getElementById('emojiPicker');
        if (!picker) return;
        const isOpen = picker.style.display === 'block';
        picker.style.display = isOpen ? 'none' : 'block';
      } catch (e) {
        console.warn('toggleEmojiPicker error:', e);
      }
    }

    function insertAtCursor(textarea, text) {
      try {
        const start = textarea.selectionStart ?? textarea.value.length;
        const end = textarea.selectionEnd ?? textarea.value.length;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        textarea.value = before + text + after;
        const newPos = start + text.length;
        textarea.selectionStart = textarea.selectionEnd = newPos;
      } catch (e) {
        // Fallback: append
        textarea.value = (textarea.value || '') + text;
      }
    }

    function insertEmoji(emoji) {
      const ta = document.getElementById('nuevoComentario');
      if (!ta) return;
      ta.focus();
      insertAtCursor(ta, emoji);
      // cerrar picker tras insertar
      const picker = document.getElementById('emojiPicker');
      if (picker) picker.style.display = 'none';
    }

    // Cerrar picker al hacer click fuera
    document.addEventListener('click', function(e) {
      const picker = document.getElementById('emojiPicker');
      const toggleBtn = document.getElementById('emojiToggleBtn');
      if (!picker || picker.style.display !== 'block') return;
      const clickedInsidePicker = picker.contains(e.target);
      const clickedToggle = toggleBtn && (e.target === toggleBtn || toggleBtn.contains(e.target));
      if (!clickedInsidePicker && !clickedToggle) {
        picker.style.display = 'none';
      }
    });

    // Funci¨®n para actualizar el ¨²ltimo comentario en la tabla
    function actualizarUltimoComentarioEnTabla(leadId, comentario) {
      // Encontrar la fila del lead
      const filas = document.querySelectorAll('#costumer-tbody tr');
      
      filas.forEach(fila => {
        const botonEditar = fila.querySelector('button[onclick^="editarLead"]');
        if (botonEditar) {
          const idEnFila = botonEditar.getAttribute('onclick').match(/'([^']+)'/)[1];
          if (idEnFila === leadId) {
            // Actualizar la celda de comentarios
            const celdaComentarios = fila.querySelector('td:nth-last-child(2)');
            if (celdaComentarios) {
              // Mostrar solo los primeros 50 caracteres del comentario
              const textoCorto = comentario.length > 50 ? comentario.substring(0, 50) + '...' : comentario;
              celdaComentarios.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                  <div style="display: flex; align-items: center; gap: 5px;">
                    <span class="new-comment-dot" style="display: inline-block; width: 8px; height: 8px; background-color: #3498db; border-radius: 50%;"></span>
                    <span>${textoCorto}</span>
                  </div>
                  <button onclick="event.stopPropagation(); abrirComentarios('${leadId}')" class="action-btn" style="margin-top: 5px; padding: 2px 6px; font-size: 11px;">
                    <i class="fas fa-comment"></i> Ver todo
                  </button>
                </div>
              `;
            }
          }
        }
      });
    }

    // Cerrar el modal al hacer clic fuera del contenido
    window.onclick = function(event) {
      const modal = document.getElementById('comentariosModal');
      if (event.target == modal) {
        cerrarComentarios();
      }
    }

    // Variable global para almacenar los leads
    window.ultimaListaLeads = [];
    
    // Normalizaci¨®n de leads desde el backend a la estructura usada en frontend
    function escapeAttr(s) {
      try {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      } catch { return ''; }
    }
    function toISODateString(d) {
      try {
        if (!d) return '';
        if (d instanceof Date) return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0)).toISOString().split('T')[0];
        if (typeof d === 'string') {
          // Intentar YYYY-MM-DD
          if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
          const dt = new Date(d);
          if (!isNaN(dt.getTime())) return dt.toISOString().split('T')[0];
        }
      } catch (e) {
        console.warn('toISODateString error:', e, d);
      }
      return '';
    }

    // Helpers de identificadores
    function extractLeadId(raw) {
      if (!raw) return '';
      // Casos: {_id: '...'} | {_id: {$oid: '...'}} | {id: '...'}
      const _id = raw._id;
      if (typeof _id === 'string') return _id;
      if (_id && typeof _id === 'object') {
        if (typeof _id.$oid === 'string') return _id.$oid;
        if (typeof _id.oid === 'string') return _id.oid;
      }
      if (typeof raw.id === 'string') return raw.id;
      return '';
    }

    // Helper global utilizado por atributos inline
    function getLeadId(lead) {
      try {
        if (!lead) return '';
        const id = extractLeadId(lead);
        return typeof id === 'string' ? id : '';
      } catch {
        return '';
      }
    }

    // Helper: obtener propiedad por nombre (case-insensitive) desde obj y su _raw
    function getPropCI(obj, propName) {
      try {
        if (!obj || !propName) return undefined;
        const p = String(propName);
        if (p in obj) return obj[p];
        const lower = p.toLowerCase();
        const keys = Object.keys(obj || {});
        const hit = keys.find(k => k.toLowerCase() === lower);
        if (hit) return obj[hit];
        return undefined;
      } catch { return undefined; }
    }
    // Helper: b¨²squeda profunda por clave (case-insensitive). Escanea objetos/arrays.
    function deepFindByKey(obj, candidates, opts = {}) {
      const MAX_DEPTH = typeof opts.maxDepth === 'number' ? opts.maxDepth : 4;
      const seen = new WeakSet();
      const candSet = new Set((candidates || []).map(c => String(c).toLowerCase()));
      function matchKey(k) {
        const kl = String(k).toLowerCase();
        if (candSet.has(kl)) return true;
        // Tambi¨¦n coincide si la variante upper/lower/cap es igual
        for (const c of candSet) {
          if (kl === c || kl === c.toUpperCase() || kl === c.toLowerCase()) return true;
        }
        return false;
      }
      function dfs(node, depth) {
        if (!node || depth > MAX_DEPTH) return undefined;
        if (typeof node !== 'object') return undefined;
        if (seen.has(node)) return undefined;
        seen.add(node);
        if (Array.isArray(node)) {
          for (const it of node) {
            const r = dfs(it, depth + 1);
            if (r != null && String(r).trim() !== '') return r;
          }
          return undefined;
        }
        // node es objeto
        for (const [k, v] of Object.entries(node)) {
          if (matchKey(k)) {
            if (v != null && String(v).trim() !== '') return v;
          }
        }
        for (const [, v] of Object.entries(node)) {
          const r = dfs(v, depth + 1);
          if (r != null && String(r).trim() !== '') return r;
        }
        return undefined;
      }
      return dfs(obj, 0);
    }
    function pickField(obj, candidates) {
      try {
        const tryList = [];
        (candidates || []).forEach(n => {
          tryList.push(n, String(n).toUpperCase(), String(n).toLowerCase(), n && (String(n).charAt(0).toUpperCase() + String(n).slice(1).toLowerCase()));
        });
        // Explorar objeto directo y su _raw si existe
        for (const name of tryList) {
          const v = getPropCI(obj, name);
          if (v != null && String(v).trim() !== '') return v;
        }
        if (obj && obj._raw) {
          for (const name of tryList) {
            const v = getPropCI(obj._raw, name);
            if (v != null && String(v).trim() !== '') return v;
          }
        }
        // B¨²squeda profunda como ¨²ltimo recurso (obj y _raw)
        const deep1 = deepFindByKey(obj, candidates);
        if (deep1 != null && String(deep1).trim() !== '') return deep1;
        if (obj && obj._raw) {
          const deep2 = deepFindByKey(obj._raw, candidates);
          if (deep2 != null && String(deep2).trim() !== '') return deep2;
        }
        return '';
      } catch { return ''; }
    }

    function normalizeLead(raw) {
      const lead = raw || {};
      // Mapear campos comunes provenientes del backend en MAY?SCULAS u otras variantes
      const fechaVenta = pickField(lead, ['dia_venta','FECHA','fecha_venta','fecha']);
      const fechaInst = pickField(lead, ['dia_instalacion','FECHA_INSTALACION','fecha_instalacion']);
      const puntaje = pickField(lead, ['puntaje','PUNTAJE','score']) || 0;
      const supervisor = pickField(lead, ['supervisor','SUPERVISOR','team','Team']);
      const tipoServicio = pickField(lead, ['tipo_servicios','tipo_servicio','SERVICIO','producto']);
      const id = extractLeadId(lead);
      // Intentar derivar "agente" desde varios posibles campos del backend
      const agente = (
        lead.agente ?? lead.AGENTE ?? lead.agent ?? lead.AGENT ??
        lead.vendedor ?? lead.VENDEDOR ?? lead.asesor ?? lead.ASESOR ??
        lead.owner ?? lead.OWNER ??
        ((lead.createdBy && (lead.createdBy.name || lead.createdBy.username)) ?? '')
      );

      return {
        // Campos de tabla esperados
        _id: id,
        nombre_cliente: lead.nombre_cliente || lead.NOMBRE || lead.cliente || lead.nombre || 'N/A',
        telefono_principal: lead.telefono_principal || lead.TELEFONO || lead.celular || lead.telefono || 'N/A',
        telefono_alterno: lead.telefono_alterno || lead.TELEFONO_ALTERNO || lead.telefono2 || '',
        numero_cuenta: lead.numero_cuenta || lead.CUENTA || lead.account || '',
        autopago: lead.autopago ?? lead.AUTOPAGO ?? '',
        direccion: lead.direccion || lead.DIRECCION || lead.address || '',
        tipo_servicios: (tipoServicio || ''),
        sistema: (pickField(lead, ['sistema','Sistema','SISTEMA','system','System']) || ''),
        riesgo: (pickField(lead, ['riesgo','Riesgo','RIESGO','risk','RISK']) || ''),
        dia_venta: fechaVenta ? toISODateString(fechaVenta) : '',
        dia_instalacion: fechaInst ? toISODateString(fechaInst) : '',
        status: lead.status || lead.STATUS || lead.estado || 'N/A',
        servicios: lead.servicios || lead.SERVICIOS || tipoServicio || '',
        mercado: (pickField(lead, ['mercado','Mercado','MERCADO','market','MARKET']) || ''),
        supervisor: supervisor || '',
        agente: agente || '',
        comentario: lead.comentario || lead.COMENTARIO || '',
        motivo_llamada: lead.motivo_llamada || lead.MOTIVO || '',
        zip_code: lead.zip_code || lead.ZIP || lead.cp || '',
        puntaje: Number(puntaje) || 0,
        comentarios_venta: lead.comentarios_venta || lead.COMENTARIOS || lead.comentarios || '',
        // Identificadores
        _id: id,
        id: id,
        // Preservar crudo para diagn¨®stico/agrupaci¨®n posterior
        _raw: lead,
        // Pasar posibles campos de IDs de agente y variantes (sin transformar) para facilitar detecci¨®n aguas abajo
        agenteId: lead.agenteId || lead.AGENTEID || lead.agente_id || lead.AGENTE_ID || lead.idAgente || lead.IDAGENTE || lead.agentId || lead.AGENTID || lead.creadoPor || lead.CREADO_POR || lead.creado_por || lead.createdBy || lead.ownerId || lead.assignedId || '',
        agente_id: lead.agente_id || lead.AGENTE_ID || '',
        idAgente: lead.idAgente || lead.IDAGENTE || '',
        agentId: lead.agentId || lead.AGENTID || '',
        creadoPor: lead.creadoPor || lead.CREADO_POR || lead.creado_por || '',
        createdBy: lead.createdBy || '',
        ownerId: lead.ownerId || '',
        assignedId: lead.assignedId || '',
        // Pasar posibles campos de nombre de agente y variantes
        agenteNombre: lead.agenteNombre || lead.AGENTE_NOMBRE || lead.nombreAgente || lead.NOMBRE_AGENTE || lead.agente || lead.Agente || lead.agent || lead.Agent || lead.vendedor || lead.seller || lead.nombre_agente || lead.agente_nombre || lead.agentName || lead.salesAgent || lead.asignadoA || lead.asignado_a || lead.assignedTo || lead.assigned_to || lead.usuario || lead.owner || lead.registeredBy || '',
      };
    }

    function normalizeLeads(arr) {
      if (!Array.isArray(arr)) return [];
      return arr.map(normalizeLead);
    }

    // Zona horaria de negocio (UTC-6). Ajusta si tu operaci¨®n usa otra TZ.
    const BUSINESS_TZ_OFFSET_MIN = -6 * 60; // Am¨¦rica Central (UTC-6)

    // Helper: YYYY-MM-DD en TZ objetivo (no UTC/local del navegador)
    function toISOInTZ(date, tzOffsetMinutes) {
      // convertir 'date' a UTC ms
      const utcMs = date.getTime() + (date.getTimezoneOffset() * 60000);
      // aplicar offset de la TZ objetivo
      const target = new Date(utcMs + tzOffsetMinutes * 60000);
      const y = target.getUTCFullYear();
      const m = String(target.getUTCMonth() + 1).padStart(2, '0');
      const d = String(target.getUTCDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // Wrapper: ISO YYYY-MM-DD usando la TZ de negocio definida (BUSINESS_TZ_OFFSET_MIN)
    function toLocalISO(date) {
      try {
        if (!date) return '';
        const d = date instanceof Date ? date : new Date(date);
        if (isNaN(d)) return '';
        return toISOInTZ(d, BUSINESS_TZ_OFFSET_MIN);
      } catch (_) {
        return '';
      }
    }

    // Helper: obtener fecha YYYY-MM-DD de un lead (usando TZ de negocio)
    function getDateFromLead(lead) {
      try {
        if (!lead) return '';
        const raw = lead.dia_venta || lead.FECHA || lead.fecha_venta || lead.fecha || null;
        if (!raw) return '';
        let d;
        if (raw instanceof Date) {
          d = new Date(raw.getTime());
        } else if (typeof raw === 'string') {
          // Si viene en formato YYYY-MM-DD, crear como fecha LOCAL y luego convertir a TZ negocio
          if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
            const [y, m, day] = raw.split('-').map(Number);
            d = new Date(y, m - 1, day);
          } else {
            d = new Date(raw);
          }
        } else {
          d = new Date(String(raw));
        }
        if (isNaN(d)) return '';
        return toISOInTZ(d, BUSINESS_TZ_OFFSET_MIN);
      } catch {
        return '';
      }
    }

    // Cargar leads del agente desde backend y actualizar UI
    async function fetchLeadsAgente() {
      try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        // Nota: /api/customers es público; si no hay token, no abortar, solo omitir el header
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};

        // Detectar si es usuario Team Líneas
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const role = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        const username = (userData.username || userData?.usuario?.username || '').toString().trim().toLowerCase();
        const isTeamLineasUser = role === 'teamlineas' || username.startsWith('lineas-') || username.includes('lineas');

        // Construir URL según el tipo de usuario
        let url = isTeamLineasUser ? '/api/lineas' : '/api/customers?page=1&limit=100';
        let alreadyFilteredByAgent = isTeamLineasUser; // Team Líneas ya filtra automáticamente por agente
        
        console.log(`[fetchLeadsAgente] Rol: ${role}, Username: ${username}, Team Líneas: ${isTeamLineasUser}`);
        console.log(`[fetchLeadsAgente] URL: ${url}`);

        // Obtener parámetros URL
        const urlParams = new URLSearchParams(window.location.search);
        const forceAll = urlParams.get('forceAll') === '1' || urlParams.get('forceAll') === 'true';

        // Para usuarios no Team Líneas, aplicar filtro por agente si es necesario
        if (!isTeamLineasUser) {
          if (role === 'agent' && !forceAll) {
            const idCandidates = [userData._id, userData.id, userData.userId, userData.uid, userData?.usuario?._id, userData?.usuario?.id].map(v => v && String(v).trim()).filter(Boolean);
            const nameCandidates = [userData.username, userData.name, userData.nombre, userData?.usuario?.username, userData?.usuario?.name, userData?.usuario?.nombre].map(v => v && String(v).trim()).filter(Boolean);
            if (idCandidates.length) {
              const agenteId = encodeURIComponent(idCandidates[0]);
              url += `&agenteId=${agenteId}`;
              alreadyFilteredByAgent = true;
              console.log('[fetchLeadsAgente] Rol=agent. Usando agenteId para URL:', idCandidates[0]);
            } else if (nameCandidates.length) {
              const agente = encodeURIComponent(nameCandidates[0]);
              url += `&agente=${agente}`;
              alreadyFilteredByAgent = true;
              console.log('[fetchLeadsAgente] Rol=agent. Usando agente(nombre) para URL:', nameCandidates[0]);
            }
          } else {
            console.log('[fetchLeadsAgente] Rol detectado:', role || '(vacío)');
          }
        }

        if (forceAll) console.warn('[fetchLeadsAgente] forceAll=1 activo: NO se aplica filtrado por agente (backend ni frontend)');
        console.log('[fetchLeadsAgente] URL solicitada:', url, 'alreadyFilteredByAgent=', alreadyFilteredByAgent, 'forceAll=', forceAll);
        const response = await fetch(url, { headers });
        console.log(`[fetchLeadsAgente] Response status: ${response.status}, headers:`, response.headers);
        
        if (!response.ok) {
          console.warn('[fetchLeadsAgente] Respuesta no OK del backend:', response.status);
          const errorText = await response.text();
          console.warn('[fetchLeadsAgente] Error response body:', errorText.substring(0, 200));
        }
        
        let data = null;
        try {
          const responseText = await response.text();
          console.log('[fetchLeadsAgente] Response text (first 200 chars):', responseText.substring(0, 200));
          data = JSON.parse(responseText);
        } catch (e) {
          console.warn('[fetchLeadsAgente] No se pudo parsear JSON de respuesta:', e?.message);
          console.warn('[fetchLeadsAgente] Response was not JSON, probably HTML error page');
        }
        console.log('[fetchLeadsAgente] Datos recibidos (resumen):', {
          tipo: Array.isArray(data) ? 'array' : typeof data,
          len: Array.isArray(data) ? data.length : (data && Array.isArray(data.leads) ? data.leads.length : (data && Array.isArray(data.data) ? data.data.length : 0))
        });
        
        // Extraer datos según el endpoint
        let leadsRaw = [];
        if (isTeamLineasUser) {
          // Para /api/lineas, los datos vienen en data.data
          leadsRaw = Array.isArray(data) ? data : (data && Array.isArray(data.data) ? data.data : []);
        } else {
          // Para /api/customers, los datos vienen directamente o en data.leads
          leadsRaw = Array.isArray(data) ? data : (data && Array.isArray(data.leads) ? data.leads : []);
        }

        // Paginación: si el backend reporta más páginas, descargarlas y combinarlas
        try {
          const totalPages = Number(data?.pages || data?.pagination?.totalPages || 1);
          const currentPage = Number(data?.page || data?.pagination?.page || 1);
          const limit = Number(data?.limit || data?.pagination?.limit || 100);
          if (totalPages > currentPage) {
            console.log(`[fetchLeadsAgente] Se detectaron ${totalPages} páginas. Descargando páginas restantes...`);
            const u = new URL(url, window.location.origin);
            const baseParams = new URLSearchParams(u.search);
            baseParams.set('limit', String(limit || 100));
            for (let p = currentPage + 1; p <= totalPages; p++) {
              baseParams.set('page', String(p));
              const pageUrl = `${u.pathname}?${baseParams.toString()}`;
              try {
                const r = await fetch(pageUrl, { headers });
                if (!r.ok) {
                  let errTxt = '';
                  try { errTxt = await r.text(); } catch (_) {}
                  console.warn(`[fetchLeadsAgente] Página ${p} no OK:`, r.status, errTxt);
                  continue;
                }
                const d = await r.json();
                const arr = Array.isArray(d)
                  ? d
                  : (Array.isArray(d.leads) ? d.leads
                    : (Array.isArray(d.customers) ? d.customers
                      : (Array.isArray(d.data) ? d.data : [])));
                console.log(`[fetchLeadsAgente] Página ${p} retornó ${arr.length} registros`);
                leadsRaw = leadsRaw.concat(arr);
              } catch (e) {
                console.warn(`[fetchLeadsAgente] Error descargando página ${p}:`, e?.message);
              }
            }
            console.log('[fetchLeadsAgente] Total acumulado tras paginación:', leadsRaw.length);
          }
        } catch (e) {
          console.warn('[fetchLeadsAgente] Error manejando paginación:', e?.message);
        }

        // Fallback a mocks si no hay datos o la solicitud fall¨®
        if ((!Array.isArray(leadsRaw) || leadsRaw.length === 0) && typeof fetchCustomersData === 'function') {
          try {
            console.warn('[fetchLeadsAgente] Sin datos desde API. Intentando fallback a datos de prueba...');
            const mock = await fetchCustomersData();
            if (mock && mock.success && Array.isArray(mock.leads) && mock.leads.length > 0) {
              leadsRaw = mock.leads;
              console.log('[fetchLeadsAgente] Fallback a datos de prueba exitoso. Cantidad:', leadsRaw.length);
            }
          } catch (e) {
            console.warn('[fetchLeadsAgente] Fallback a datos de prueba fall¨®:', e?.message);
          }
        }

        console.log('[fetchLeadsAgente] leadsRaw.length =', (leadsRaw && leadsRaw.length) || 0);
        let normalizedLeads = normalizeLeads(leadsRaw);
        console.log('[fetchLeadsAgente] normalizedLeads.length =', (normalizedLeads && normalizedLeads.length) || 0);

    // Filtrar por agente si el usuario es role 'agent' SOLO si no se filtr¨® ya en el backend
    if (!alreadyFilteredByAgent && !forceAll) {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const role = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        if (role === 'agent') {
          const norm = (s) => {
            try { return String(s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim(); } catch { return String(s || '').toLowerCase().trim(); }
          };
          const str = (v) => (v == null ? '' : String(v));
          // Candidatos de ID del usuario actual
          const myIds = [
            userData.id, userData._id, userData.userId, userData.uid,
            userData?.usuario?._id, userData?.usuario?.id,
            userData?.user?._id, userData?.user?.id,
            userData?.profile?._id, userData?.profile?.id
          ].map(str).filter(x => x.trim().length);

          // Candidatos de nombre del usuario actual
          const myNames = [
            userData.name, userData.nombre, userData.username, userData.email,
            userData?.usuario?.name, userData?.usuario?.nombre, userData?.usuario?.username
          ].map(str).filter(x => x.trim().length);

          const getId = (l) => {
            if (typeof getAgentId === 'function') return getAgentId(l);
            const raw = (
              l?.agenteId || l?._raw?.agenteId || l?.agente_id || l?._raw?.agente_id ||
              l?.idAgente || l?._raw?.idAgente || l?.agentId || l?._raw?.agentId ||
              l?.createdBy || l?.ownerId || l?.assignedId ||
              l?._raw?.createdBy || l?._raw?.ownerId || l?._raw?.assignedId || ''
            );
            try {
              if (raw && typeof raw === 'object') {
                const maybe = raw.$oid || raw.id || raw._id || raw.value || (raw.toString ? raw.toString() : '');
                return String(maybe || '').trim();
              }
              return String(raw || '').trim();
            } catch { return String(raw || '').trim(); }
          };
          const getName = (l) => {
            if (typeof getAgentName === 'function') return getAgentName(l);
            const cand = [
              l?.agenteNombre, l?.nombreAgente, l?.agente, l?.agent,
              l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.agent
            ];
            const v = cand.find(x => x && String(x).trim().length);
            return v ? String(v).trim() : '';
          };

          const myIdsNorm = new Set(myIds.map(x => norm(x)));
          const myNamesNorm = new Set(myNames.map(x => norm(x)));

          const beforeCount = normalizedLeads.length;
          normalizedLeads = normalizedLeads.filter(l => {
            const idMatch = (() => {
              const lid = norm(getId(l));
              if (!lid) return false;
              return myIdsNorm.has(lid);
            })();
            if (idMatch) return true;
            const nameMatch = (() => {
              const lname = norm(getName(l));
              if (!lname) return false;
              return myNamesNorm.has(lname);
            })();
            return nameMatch;
          });
          console.log(`[Filtro rol=agent] ${beforeCount} -> ${normalizedLeads.length} leads para el usuario actual (frontend)`);
        }
      } catch (e) {
        console.warn('No se pudo aplicar filtro por agente:', e?.message);
      }
    }

    // Filtrar por equipo si el usuario es 'supervisor' y NO est¨¢ activo forceAll
    if (!forceAll) {
      try {
        const userData = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        const role = (userData.role || userData?.usuario?.role || '').toString().trim().toLowerCase();
        if (role === 'supervisor' && window.Teams) {
          const supName = (userData.name || userData.nombre || userData.username || userData?.usuario?.name || userData?.usuario?.nombre || '').toString();
          const agents = (window.Teams.getAgentsBySupervisor && window.Teams.getAgentsBySupervisor(supName)) || [];
          const norm = window.Teams.norm || ((s)=>String(s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'').trim());
          const canonicalFromName = window.Teams.canonicalFromName || ((name)=> norm(name));
          if (Array.isArray(agents) && agents.length) {
            // Conjunto de agentes can¨®nicos del supervisor
            const teamAgentsCanon = new Set((agents || []).map(a => canonicalFromName(a)));
            const getName = (l) => {
              if (typeof getAgentName === 'function') return getAgentName(l);
              const cand = [
                l?.agenteNombre, l?.nombreAgente, l?.agente, l?.agent,
                l?._raw?.agenteNombre, l?._raw?.nombreAgente, l?._raw?.agente, l?._raw?.agent
              ];
              const v = cand.find(x => x && String(x).trim().length);
              return v ? String(v).trim() : '';
            };
            const before = normalizedLeads.length;
            normalizedLeads = normalizedLeads.filter(l => teamAgentsCanon.has(canonicalFromName(getName(l))));
            console.log(`[Filtro rol=supervisor] ${before} -> ${normalizedLeads.length} leads del equipo de`, supName);
          } else {
            console.warn('[Filtro rol=supervisor] No se encontraron agentes para el supervisor:', supName);
          }
        }
      } catch (e) {
        console.warn('[Filtro rol=supervisor] No se pudo aplicar filtro por equipo:', e?.message);
      }
    }

    window.ultimaListaLeads = normalizedLeads;
    try {
      const sample = (normalizedLeads || []).slice(0, 3).map(l => ({
        _id: l._id || l.id,
        agenteId: l.agenteId || l.agente_id || l.idAgente || l.agentId,
        agente: l.agente || l.agent || l.agenteNombre || l.nombreAgente,
        dia_venta: l.dia_venta || l.FECHA || l.fecha || l.fecha_venta
      }));
      console.log('[fetchLeadsAgente] Muestra post-filtrado:', sample);
    } catch {}

        // Actualizar la interfaz
        if (typeof window.renderCostumerTable === 'function') {
            window.renderCostumerTable(normalizedLeads);
        } else {
            console.error('La funci¨®n renderCostumerTable no est¨¢ disponible');
        }
        // Logs de diagn¨®stico de asignaci¨®n (por TEAM y agente)
        try { if (typeof logDiagnosticoAsignacion === 'function') logDiagnosticoAsignacion(normalizedLeads); } catch(_) {}
        updateSummaryCards(normalizedLeads);

        return normalizedLeads;
      } catch (error) {
        console.error('Error en fetchLeadsAgente:', error);
        mostrarMensajeSinDatos();
        return [];
      }
    }

    // Funci¨®n para manejar la ausencia de datos
    function mostrarMensajeSinDatos() {
      const tableBody = document.querySelector('#costumer-tbody');
      if (tableBody) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="13" style="text-align: center; padding: 20px;">
              <p>No se encontraron datos disponibles.</p>
              <p>Por favor, verifica tu conexi¨®n o contacta al administrador.</p>
            </td>
          </tr>
        `;
      }
      
      // Actualizar las tarjetas de resumen con valores en cero
      updateSummaryCards([]);
    }

    // Función para cargar datos iniciales
    function cargarDatosIniciales() {
      try {
        // Usar la función unificada de script.js para cargar datos
        if (typeof cargarDatosDesdeServidor === 'function') {
          cargarDatosDesdeServidor();
        } else {
          console.warn('[Costumer] cargarDatosDesdeServidor no disponible');
          mostrarMensajeSinDatos();
        }
      } catch (error) {
        console.error('Error al cargar datos iniciales:', error);
        mostrarMensajeSinDatos();
      } finally {
        // Ocultar indicador de carga si existe
        if (loadingIndicator) {
          loadingIndicator.style.display = 'none';
        }
      }
    }
    


    // Manejar b¨²squeda
    document.getElementById('costumer-search').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#costumer-tbody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });

    // Funci¨®n para formatear fechas con el formato 'd¨ªa_de_la_semana n¨²mero_del_d¨ªa' (ej: 'mi¨¦ 13')
    function formatearFechaSinDesfase(fechaStr) {
      try {
        // Si no es string, devolver valor por defecto
        if (typeof fechaStr !== 'string') {
          console.warn('Tipo de fecha no soportado:', typeof fechaStr, fechaStr);
          return 'N/A';
        }

        // Limpiar la cadena de espacios en blanco
        const fechaLimpia = fechaStr.trim();
        
        // Extraer d¨ªa, mes y a?o directamente del string
        let day, month, year;
        
        // Intentar con formato YYYY-MM-DD
        let match = fechaLimpia.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
          [_, year, month, day] = match;
        } 
        // Si no coincide, intentar con formato DD/MM/YYYY
        else if ((match = fechaLimpia.match(/^(\d{2})\/(\d{2})\/(\d{4})/))) {
          [_, day, month, year] = match;
        }
        // Si no coincide con ning¨²n formato conocido
        else {
          console.warn('Formato de fecha no reconocido (se espera YYYY-MM-DD o DD/MM/YYYY):', fechaLimpia);
          return 'N/A';
        }
        
        // Convertir a n¨²meros
        year = parseInt(year);
        month = parseInt(month) - 1; // Los meses en JavaScript van de 0 a 11
        day = parseInt(day);
        
        // Crear fecha sin conversi¨®n de zona horaria
        const fecha = new Date(Date.UTC(year, month, day, 12, 0, 0));
        
        // Verificar si la fecha es v¨¢lida
        if (isNaN(fecha.getTime())) {
          console.warn('Fecha inv¨¢lida (no v¨¢lida):', fechaLimpia);
          return 'N/A';
        }
        
        // D¨ªas de la semana en espa?ol
        const diasSemana = ['dom', 'lun', 'mar', 'mi¨¦', 'jue', 'vie', 's¨¢b'];
        
        // Obtener d¨ªa de la semana (0 = domingo, 1 = lunes, etc.)
        const diaSemana = diasSemana[fecha.getUTCDay()];
        
        // Obtener d¨ªa del mes
        const diaMes = fecha.getUTCDate();
        
        // Mostrar la fecha en la consola para depuraci¨®n
        console.log(`Formateando fecha: ${fechaLimpia} -> ${diaSemana} ${diaMes}`);
        
        return `${diaSemana} ${diaMes}`;
        
      } catch (error) {
        console.error('Error al formatear fecha:', error, 'Valor:', fechaStr);
        return 'Fecha inv¨¢lida';
      }
    }
    
    // Helper (local): obtener rol actual normalizado
    // NOTA: Renombrado a getUserRole_local para no sobreescribir la versi¨®n global de script.js
    function getUserRole_local() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user') || '{}');
        return (user.role || '').toString().trim().toLowerCase();
      } catch { return ''; }
    }

    // Helper (local): verificar si el usuario puede editar status (Administrador / B.O)
    // NOTA: Renombrado a canEditStatus_local para no sobreescribir la versi¨®n global de script.js
    function canEditStatus_local() {
      const r = getUserRole_local();
      // Aceptar variantes comunes desde frontend (referencial, no usada por la tabla)
      return ['admin','administrador','backoffice','b:o','b.o','b-o','bo'].includes(r);
    }

    // Helper: normalizar status hacia las 5 opciones y devolver etiqueta capitalizada
    function normalizeStatusLabel(s) {
      const allowed = ['pending','hold','cancelled','rescheduled','completed'];
      const v = (s || '').toString().trim();
      const lower = v.toLowerCase();
      const pick = allowed.includes(lower)
        ? lower
        : (v.toLowerCase().includes('pend') ? 'pending' : null) ||
          (v.toLowerCase().includes('hold') ? 'hold' : null) ||
          (v.toLowerCase().includes('cancel') ? 'cancelled' : null) ||
          (v.toLowerCase().includes('reprogram') || v.toLowerCase().includes('reagend') || v.toLowerCase().includes('resched') ? 'rescheduled' : null) ||
          (v.toLowerCase().includes('compl') || v.toLowerCase().includes('termin') ? 'completed' : null) ||
          'pending';
      return pick.charAt(0).toUpperCase() + pick.slice(1);
    }

    // Helper: clase de badge seg¨²n nuevo set de estados
    function statusToBadgeClass(label) {
      const lower = (label||'').toString().toLowerCase();
      if (lower === 'pending') return 'badge-warning';
      if (lower === 'hold') return 'badge-info';
      if (lower === 'cancelled') return 'badge-danger';
      if (lower === 'rescheduled') return 'badge-primary';
      if (lower === 'completed') return 'badge-success';
      return 'badge-info';
    }

    // Llamada al backend para actualizar el status (local)
    // NOTA: Renombrado a updateLeadStatusLocal para no sobreescribir la versi¨®n global de script.js
    async function updateLeadStatusLocal(selectEl, leadId) {
      try {
        // Validar ID antes de continuar
        if (!leadId) {
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
          alert('No se pudo determinar el ID del lead. Recarga la p¨¢gina e int¨¦ntalo nuevamente.');
          return;
        }
        // Sanitizar y normalizar ID
        const cleanId = String(leadId).trim();
        if (!cleanId) {
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
          alert('ID de lead vac¨ªo o inv¨¢lido.');
          return;
        }
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
          alert('No hay token de autenticaci¨®n. Inicia sesi¨®n nuevamente.');
          return;
        }
        const newVal = selectEl.value; // Etiqueta capitalizada
        // Deshabilitar durante la petici¨®n
        const prevDisabled = selectEl.disabled; selectEl.disabled = true;
        try {
          const url = `/api/leads/${encodeURIComponent(cleanId)}/status`;
          console.debug('[updateLeadStatus] PUT', { id: cleanId, url, status: newVal });
          const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ status: newVal })
          });
          let data = {};
          try { data = await res.json(); } catch { data = {}; }
          if (!res.ok || !data?.success) {
            // Manejo espec¨ªfico por c¨®digos comunes
            if (res.status === 401) throw new Error('No autorizado (401). Verifica el token de sesi¨®n.');
            if (res.status === 403) throw new Error('Permisos insuficientes (403). Solo admin/supervisor pueden actualizar.');
            if (res.status === 404) throw new Error(data?.message || 'Lead no encontrado (404). Verifica que el ID exista en la base de datos.');
            throw new Error(data?.message || `Error ${res.status || ''}: No se pudo actualizar el estado`);
          }
          // Actualizar badge visual si existe al lado del select
          const badge = selectEl.closest('td')?.querySelector('span.badge');
          if (badge) {
            badge.textContent = newVal;
            badge.className = `badge ${statusToBadgeClass(newVal)}`;
          }
        } catch(err) {
          console.error('Error al actualizar status:', err);
          alert(`Error: ${err.message}`);
          // Revertir valor si falla
          const old = selectEl.getAttribute('data-prev');
          if (old) selectEl.value = old;
        } finally {
          // Guardar nuevo previo
          selectEl.setAttribute('data-prev', selectEl.value);
          selectEl.disabled = prevDisabled;
        }
      } catch(e) {
        console.error(e);
      }
    }

    // Función deshabilitada - Usando la versión de script.js
    function renderCostumerTable_OLD(leads) {
      console.log('renderCostumerTable_OLD llamada con leads:', leads);
      // Esta función está deshabilitada, usar renderCostumerTable de script.js
    }
  </script>

  <!-- Script de cierre de sesi¨®n unificado -->
  <script src="js/auth-logout.js"></script>
</body>
</html>
</html>